<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PARTY BOX 100: ULTIMATE</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+1p:wght@800&family=Rowdies:wght@700&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #111; --neon-cyan: #0ff; --neon-pink: #f0f; --neon-yellow: #ff0; --ui-panel: rgba(255,255,255,0.1); }
        body { margin: 0; background: var(--bg); color: white; font-family: 'M PLUS 1p', sans-serif; overflow: hidden; height: 100vh; user-select: none; text-align: center; }

        /* å…±é€šã‚¹ã‚¯ãƒªãƒ¼ãƒ³ */
        .screen { position: fixed; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; background: radial-gradient(circle, #222 0%, #000 100%); transition: opacity 0.3s; z-index: 1; }
        .hidden { opacity: 0; pointer-events: none; z-index: -10; }

        /* ã‚¿ã‚¤ãƒã‚°ãƒ©ãƒ•ã‚£ */
        h1 { font-family: 'Rowdies', cursive; font-size: 4rem; color: var(--neon-cyan); text-shadow: 4px 4px 0 var(--neon-pink); margin: 10px; letter-spacing: 2px; }
        h2 { font-size: 2rem; color: white; margin: 10px; }
        p { color: #ccc; font-size: 1.2rem; }

        /* ãƒœã‚¿ãƒ³ */
        .btn { background: linear-gradient(45deg, #ff00cc, #3333ff); border: none; color: white; padding: 15px 40px; font-size: 1.5rem; border-radius: 50px; cursor: pointer; margin: 10px; box-shadow: 0 0 15px var(--neon-pink); font-family: inherit; transition: 0.1s; }
        .btn:active { transform: scale(0.95); filter: brightness(1.2); }
        .btn-cyan { background: linear-gradient(45deg, #00ccff, #00ffcc); box-shadow: 0 0 15px var(--neon-cyan); color: black; }

        /* ãƒ›ã‚¹ãƒˆ: ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆ */
        .wheel-container { position: relative; width: 400px; height: 400px; margin: 20px; }
        .wheel { width: 100%; height: 100%; border-radius: 50%; border: 10px solid white; background: conic-gradient(#f0f 0deg 90deg, #0ff 90deg 180deg, #ff0 180deg 270deg, #0f0 270deg 360deg); transition: transform 0.1s linear; }
        .arrow { position: absolute; top: -20px; left: 50%; transform: translateX(-50%); border-left: 20px solid transparent; border-right: 20px solid transparent; border-top: 40px solid white; z-index: 10; }

        /* ãƒ›ã‚¹ãƒˆ: ã‚²ãƒ¼ãƒ ç”»é¢ (ãƒ¢ãƒ¼ãƒ‰åˆ¥) */
        #scene-battle { background: #300; }
        .boss-img { font-size: 12rem; animation: float 2s infinite ease-in-out; filter: drop-shadow(0 0 30px red); }
        .hp-bar { width: 80%; height: 30px; background: #333; border: 2px solid white; margin-top: 20px; border-radius: 15px; overflow: hidden; }
        .hp-fill { width: 100%; height: 100%; background: linear-gradient(90deg, #f00, #ff0); transition: width 0.2s; }
        
        #scene-race { background: #002; justify-content: flex-start; padding-top: 50px; }
        .track-lane { width: 100%; height: 60px; border-bottom: 2px dashed #555; position: relative; display: flex; align-items: center; }
        .racer { position: absolute; left: 0; font-size: 3rem; transition: left 0.5s linear; }
        
        #scene-generic { background: #222; }
        .big-instruction { font-size: 5rem; font-weight: 900; color: var(--neon-yellow); margin: 20px; }

        /* ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ: ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ */
        .ctrl-area { width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #222; }
        .c-btn { width: 250px; height: 250px; border-radius: 50%; border: none; font-size: 2.5rem; color: white; font-weight: bold; box-shadow: 0 10px 0 rgba(0,0,0,0.5); display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .c-btn:active { transform: translateY(10px); box-shadow: none; }
        .bg-red { background: #ff4757; box-shadow: 0 10px 0 #c0392b; }
        .bg-blue { background: #3742fa; box-shadow: 0 10px 0 #2f3542; }
        .bg-stop { background: var(--neon-yellow); color: black; box-shadow: 0 10px 0 #d4a017; animation: pulse 0.5s infinite; }

        /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes float { 0%,100%{transform:translateY(0);} 50%{transform:translateY(-20px);} }
        @keyframes pulse { 0%{transform:scale(1);} 50%{transform:scale(1.05);} 100%{transform:scale(1);} }
        .shake { animation: shake 0.3s; }
        @keyframes shake { 0% { transform: translate(1px, 1px) rotate(0deg); } 100% { transform: translate(-1px, -2px) rotate(-1deg); } }

    </style>
</head>
<body>

    <div id="s-top" class="screen">
        <h1>PARTY BOX<br>100</h1>
        <p>100ç¨®é¡ã®ã‚²ãƒ¼ãƒ  Ã— å…¨å“¡å‚åŠ ãƒãƒˆãƒ«</p>
        <div style="margin-top:20px;">
            <button id="btn-host" class="btn">ğŸ’» ãƒ›ã‚¹ãƒˆã§ã¯ã˜ã‚ã‚‹</button>
            <button id="btn-client" class="btn btn-cyan">ğŸ“± ã‚¹ãƒãƒ›ã§å‚åŠ </button>
        </div>
    </div>

    <div id="s-lobby" class="screen hidden">
        <h2>ROOM ID</h2>
        <div id="disp-id" style="font-size:5rem; color:var(--neon-yellow); font-family:'Rowdies';">----</div>
        <div id="qrcode" style="background:white; padding:15px; border-radius:10px;"></div>
        <p>å‚åŠ äººæ•°: <span id="p-count" style="font-size:2rem; font-weight:bold; color:var(--neon-pink)">0</span> äºº</p>
        <div style="margin-top:20px;">
            <button onclick="startRoulette()" class="btn">é‹å‘½ã®ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆ</button>
            <button onclick="showGameList()" class="btn btn-cyan">ãƒªã‚¹ãƒˆã‹ã‚‰é¸ã¶</button>
        </div>
    </div>

    <div id="s-roulette" class="screen hidden">
        <h1>NEXT GAME IS...</h1>
        <div class="wheel-container">
            <div class="arrow"></div>
            <div id="wheel" class="wheel"></div>
        </div>
        <h2 id="stopper-msg" style="color:var(--neon-yellow); animation:pulse 1s infinite;">èª°ã‹ãŒæ­¢ã‚ã‚‹ã®ã‚’å¾…ã£ã¦ã„ã¾ã™...</h2>
    </div>

    <div id="scene-battle" class="screen hidden">
        <h2 id="battle-title">BOSS BATTLE</h2>
        <div id="boss-display" class="boss-img">ğŸ‘¾</div>
        <div class="hp-bar"><div id="boss-hp" class="hp-fill"></div></div>
        <div id="battle-timer" style="font-size:3rem; margin-top:20px;">15.0</div>
    </div>

    <div id="scene-race" class="screen hidden">
        <h2 id="race-title">RACE</h2>
        <div id="race-track-area" style="width:90%;"></div>
    </div>

    <div id="scene-generic" class="screen hidden">
        <h2 id="gen-title">GAME</h2>
        <div id="gen-instruction" class="big-instruction">READY?</div>
        <div id="gen-timer" style="font-size:3rem;"></div>
        <div id="gen-ranking" style="font-size:1.5rem; text-align:left; margin-top:30px; color:#aaa;"></div>
    </div>

    <div id="s-list" class="screen hidden" style="justify-content:flex-start; overflow-y:auto; padding:50px;">
        <h2>GAME LIST (1-100)</h2>
        <button onclick="show('s-lobby')" class="btn">æˆ»ã‚‹</button>
        <div id="game-list-container" style="display:flex; flex-wrap:wrap; justify-content:center; gap:10px;"></div>
    </div>

    <div id="s-result" class="screen hidden">
        <h1>WINNER</h1>
        <div id="winner-name" style="font-size:4rem; color:var(--neon-yellow); font-weight:bold;">???</div>
        <button onclick="location.reload()" class="btn">ã‚¿ã‚¤ãƒˆãƒ«ã¸</button>
    </div>

    <div id="s-c-login" class="screen hidden">
        <h2>ROOM ID</h2>
        <input id="inp-id" style="font-size:1.5rem; padding:10px; width:200px; text-align:center; text-transform:uppercase;" placeholder="ABCD">
        <br><br>
        <input id="inp-name" style="font-size:1.2rem; padding:10px; width:200px; text-align:center;" placeholder="åå‰">
        <br><br>
        <button id="btn-join" class="btn btn-cyan">å‚åŠ ã™ã‚‹</button>
    </div>

    <div id="s-c-play" class="screen hidden">
        <div id="c-msg" style="font-size:1.5rem; margin-bottom:20px; color:#ccc;">å¾…æ©Ÿä¸­...</div>
        <div id="c-area" class="ctrl-area"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, set, get, onValue, update, remove, onDisconnect, increment, child, runTransaction } 
               from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDbZzTMvUkG2LXIGY4ux0KBTmnAdqP236s",
            authDomain: "game-4f2d9.firebaseapp.com",
            databaseURL: "https://game-4f2d9-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "game-4f2d9",
            storageBucket: "game-4f2d9.firebasestorage.app",
            messagingSenderId: "574316347824",
            appId: "1:574316347824:web:cf686040628e25ad615675"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- 100ç¨®é¡ã®ã‚²ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ (ç°¡æ˜“ç”Ÿæˆ) ---
        // type: battle(å”åŠ›é€£æ‰“), race(å¯¾æˆ¦é€£æ‰“), shake(æŒ¯ã‚‹), luck(é‹), stop(ã‚¿ã‚¤ãƒŸãƒ³ã‚°)
        const GAME_DB = [];
        const ACTIONS = [
            {t:'battle', n:'ãƒ‰ãƒ©ã‚´ãƒ³è¨ä¼', d:'å…¨å“¡ã§é€£æ‰“ã—ã¦å€’ã›ï¼', i:'ğŸ‰'},
            {t:'battle', n:'éš•çŸ³ç ´å£Š', d:'åœ°çƒã‚’å®ˆã‚Œï¼é€£æ‰“ï¼', i:'â˜„ï¸'},
            {t:'battle', n:'å·¨å¤§ãƒ¡ã‚«æˆ¦', d:'ã‚·ã‚¹ãƒ†ãƒ ã‚’ç ´å£Šã—ã‚ï¼', i:'ğŸ¤–'},
            {t:'race', n:'F1ã‚°ãƒ©ãƒ³ãƒ—ãƒª', d:'æœ€é€Ÿã‚’ç›®æŒ‡ã›ï¼', i:'ğŸï¸'},
            {t:'race', n:'100mèµ°', d:'èª°ã‚ˆã‚Šã‚‚é€Ÿãï¼', i:'ğŸƒ'},
            {t:'race', n:'ç«¶æ³³ãƒãƒˆãƒ«', d:'æ°´ã‚’ã‹ã‘ã‚ã‘é€²ã‚ï¼', i:'ğŸŠ'},
            {t:'shake', n:'ãƒ—ãƒ­ãƒ†ã‚¤ãƒ³', d:'ãƒ€ãƒã«ãªã‚‹ãªï¼æŒ¯ã‚Œï¼', i:'ğŸ¥¤'},
            {t:'shake', n:'ç‚­é…¸ãƒ•ã‚¡ã‚¤ãƒˆ', d:'é™ç•Œã¾ã§æŒ¯ã‚Œï¼', i:'ğŸ¾'},
            {t:'shake', n:'æ¥µå¯’ã‚µãƒã‚¤ãƒãƒ«', d:'éœ‡ãˆã¦æš–ã‚’å–ã‚Œï¼', i:'ğŸ¥¶'},
            {t:'stop', n:'æ™‚é™çˆ†å¼¾', d:'5.00ç§’ã§æ­¢ã‚ã‚ï¼', i:'ğŸ’£'},
            {t:'stop', n:'ãƒ€ãƒ«ãƒã•ã‚“ãŒ', d:'åˆå›³ã§æ­¢ã¾ã‚Œï¼', i:'ğŸ—¿'},
            {t:'luck', n:'ãƒ­ã‚·ã‚¢ãƒ³', d:'å½“ãŸã‚Šã‚’å¼•ããªï¼', i:'ğŸ”«'},
            {t:'luck', n:'å®ç®±é¸ã³', d:'é‡‘è²¨ã‚’æ¢ã›ï¼', i:'ğŸ’'}
        ];
        
        // 100å€‹ã«æ°´å¢—ã—ç”Ÿæˆ
        for(let i=0; i<100; i++) {
            const base = ACTIONS[i % ACTIONS.length];
            GAME_DB.push({
                id: i,
                type: base.t,
                title: `${base.i} ${base.n} ${Math.floor(i/ACTIONS.length)+1}`,
                desc: base.d,
                icon: base.i
            });
        }

        // --- å¤‰æ•° ---
        let myId = "P" + Math.random().toString(36).substr(2, 5);
        let roomId = "";
        let players = {};
        let gameLoop = null;
        let sensorActive = false;

        const $ = id => document.getElementById(id);
        const show = id => {
            document.querySelectorAll('.screen').forEach(e => e.classList.add('hidden'));
            $(id).classList.remove('hidden');
        };

        // ================= HOST LOGIC =================
        $('btn-host').addEventListener('click', () => {
            roomId = Math.random().toString(36).substr(2, 4).toUpperCase();
            const rRef = ref(db, `rooms/${roomId}`);
            set(rRef, { status: 'lobby', host: myId });
            onDisconnect(rRef).remove();

            $('disp-id').innerText = roomId;
            $('qrcode').innerHTML = "";
            new QRCode($('qrcode'), { text: `${location.origin}${location.pathname}?room=${roomId}`, width: 128, height: 128 });
            show('s-lobby');

            onValue(ref(db, `rooms/${roomId}/players`), snap => {
                players = snap.val() || {};
                $('p-count').innerText = Object.keys(players).length;
            });
        });

        // ãƒªã‚¹ãƒˆè¡¨ç¤º
        window.showGameList = () => {
            show('s-list');
            const cont = $('game-list-container');
            cont.innerHTML = "";
            GAME_DB.forEach(g => {
                const b = document.createElement('button');
                b.className = "btn";
                b.style.fontSize = "0.8rem";
                b.style.width = "150px";
                b.innerHTML = `${g.icon}<br>${g.title}`;
                b.onclick = () => initGame(g);
                cont.appendChild(b);
            });
        };

        // ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆ
        window.startRoulette = () => {
            const pIds = Object.keys(players);
            if(pIds.length === 0) return alert("å‚åŠ è€…ãŒã„ã¾ã›ã‚“");
            
            show('s-roulette');
            const stopperId = pIds[Math.floor(Math.random() * pIds.length)];
            const stopperName = players[stopperId].name;
            
            update(ref(db, `rooms/${roomId}`), {
                status: 'roulette',
                stopper: stopperId,
                stopperName: stopperName,
                spin: true
            });

            // å›è»¢ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
            const wheel = $('wheel');
            let deg = 0;
            const anim = setInterval(() => {
                deg = (deg + 20) % 360;
                wheel.style.transform = `rotate(${deg}deg)`;
            }, 20);

            $('stopper-msg').innerText = `${stopperName} ã•ã‚“ãŒã‚¹ãƒˆãƒƒãƒ—ãƒœã‚¿ãƒ³ã‚’æŒã£ã¦ã„ã¾ã™ï¼`;

            // åœæ­¢ç›£è¦–
            const unsub = onValue(ref(db, `rooms/${roomId}/spin`), snap => {
                if(snap.val() === false) {
                    clearInterval(anim);
                    unsub();
                    const finalDeg = deg + 720 + Math.floor(Math.random()*360);
                    wheel.style.transition = "transform 3s ease-out";
                    wheel.style.transform = `rotate(${finalDeg}deg)`;
                    
                    setTimeout(() => {
                        const randomGame = GAME_DB[Math.floor(Math.random()*GAME_DB.length)];
                        initGame(randomGame);
                    }, 4000);
                }
            });
        };

        // ã‚²ãƒ¼ãƒ åˆæœŸåŒ–
        function initGame(game) {
            // ã‚¹ã‚³ã‚¢ãƒªã‚»ãƒƒãƒˆ
            const updates = {};
            Object.keys(players).forEach(pid => updates[`rooms/${roomId}/players/${pid}/score`] = 0);
            update(ref(db), updates);

            // ã‚²ãƒ¼ãƒ ã”ã¨ã®åˆæœŸå€¤è¨­å®š
            let maxScore = 0;
            if(game.type === 'battle') maxScore = Object.keys(players).length * 50; // HP
            
            update(ref(db, `rooms/${roomId}`), {
                status: 'game',
                gameData: game,
                gameVal: maxScore, // HPãªã©ã®å…±æœ‰å€¤
                state: 'play'
            });

            // ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
            if(game.type === 'battle') {
                show('scene-battle');
                $('battle-title').innerText = game.title;
                $('boss-display').innerText = game.icon;
                $('boss-hp').style.width = "100%";
                startBattleLoop(maxScore);
            } else if (game.type === 'race') {
                show('scene-race');
                $('race-title').innerText = game.title;
                setupRace();
                startRaceLoop();
            } else {
                show('scene-generic');
                $('gen-title').innerText = game.title;
                $('gen-instruction').innerText = game.desc;
                startGenericLoop(game.type);
            }
        }

        // --- BATTLE ---
        function startBattleLoop(maxHp) {
            let timer = 20.0;
            const tInt = setInterval(() => {
                timer -= 0.1;
                $('battle-timer').innerText = timer.toFixed(1);
                if(timer <= 0) { clearInterval(tInt); endGame('TIME UP'); }
            }, 100);

            onValue(ref(db, `rooms/${roomId}/gameVal`), snap => {
                const hp = snap.val();
                if(hp <= 0) { clearInterval(tInt); endGame('VICTORY!'); return; }
                const pct = (hp / maxHp) * 100;
                $('boss-hp').style.width = pct + "%";
                $('boss-display').classList.add('shake');
                setTimeout(()=>$('boss-display').classList.remove('shake'), 100);
            });
        }

        // --- RACE ---
        function setupRace() {
            const area = $('race-track-area');
            area.innerHTML = "";
            Object.keys(players).forEach((pid, i) => {
                const div = document.createElement('div');
                div.className = 'track-lane';
                div.innerHTML = `<span style="font-size:0.8rem; position:absolute; top:-10px;">${players[pid].name}</span><div id="car-${pid}" class="racer">ğŸï¸</div>`;
                area.appendChild(div);
            });
        }
        function startRaceLoop() {
            onValue(ref(db, `rooms/${roomId}/players`), snap => {
                const d = snap.val();
                let winner = null;
                Object.keys(d).forEach(pid => {
                    const s = d[pid].score || 0;
                    const car = document.getElementById(`car-${pid}`);
                    if(car) {
                        const pct = Math.min(90, s * 2);
                        car.style.left = pct + "%";
                        if(pct >= 90) winner = d[pid].name;
                    }
                });
                if(winner) endGame(`${winner} WINS!`);
            });
        }

        // --- GENERIC (SHAKE / STOP) ---
        function startGenericLoop(type) {
            let timer = 15.0;
            const tInt = setInterval(() => {
                timer -= 0.1;
                $('gen-timer').innerText = timer.toFixed(1);
                if(timer <= 0) { clearInterval(tInt); endGame('FINISH!'); }
            }, 100);

            onValue(ref(db, `rooms/${roomId}/players`), snap => {
                const list = [];
                snap.forEach(p => list.push({n:p.val().name, s:p.val().score||0}));
                list.sort((a,b)=>b.s-a.s);
                $('gen-ranking').innerHTML = list.slice(0,3).map((p,i)=>`#${i+1} ${p.n}: ${p.s}`).join('<br>');
            });
        }

        function endGame(msg) {
            update(ref(db, `rooms/${roomId}`), { status: 'result' });
            show('s-result');
            $('winner-name').innerText = msg;
            confetti({ particleCount: 200, spread: 100 });
        }

        // ================= CLIENT =================
        const params = new URLSearchParams(location.search);
        if(params.get('room')) { $('inp-id').value = params.get('room'); show('s-c-login'); }
        $('btn-client').addEventListener('click', () => show('s-c-login'));

        $('btn-join').addEventListener('click', async () => {
            const rid = $('inp-id').value.toUpperCase().trim();
            const name = $('inp-name').value || "NoName";
            if(!rid) return;
            try {
                const snap = await get(child(ref(db), `rooms/${rid}`));
                if(!snap.exists()) return alert("éƒ¨å±‹ãŒã‚ã‚Šã¾ã›ã‚“");
                roomId = rid;
                const pRef = ref(db, `rooms/${roomId}/players/${myId}`);
                set(pRef, { name: name, score: 0 });
                onDisconnect(pRef).remove();
                show('s-c-play');
                initController();
                requestSensor();
            } catch(e) { alert("æ¥ç¶šã‚¨ãƒ©ãƒ¼"); }
        });

        function initController() {
            onValue(ref(db, `rooms/${roomId}`), snap => {
                const data = snap.val();
                if(!data) return location.reload();
                
                const area = $('c-area');
                area.innerHTML = "";
                $('c-msg').innerText = "";

                if(data.status === 'roulette') {
                    if(data.stopper === myId && data.spin) {
                        const btn = document.createElement('button');
                        btn.className = "c-btn bg-stop";
                        btn.innerText = "STOP!";
                        btn.onclick = () => update(ref(db, `rooms/${roomId}`), { spin: false });
                        area.appendChild(btn);
                        navigator.vibrate(200);
                    } else {
                        $('c-msg').innerText = `${data.stopperName}ã•ã‚“ãŒãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆä¸­...`;
                    }
                } 
                else if (data.status === 'game' && data.state === 'play') {
                    const g = data.gameData;
                    $('c-msg').innerText = g.desc;

                    if(g.type === 'battle' || g.type === 'race') {
                        const btn = document.createElement('button');
                        btn.className = g.type === 'battle' ? "c-btn bg-red" : "c-btn bg-blue";
                        btn.innerHTML = g.type === 'battle' ? "ATTACK<br>ğŸ‘Š" : "GAS<br>ğŸ’¨";
                        btn.addEventListener('pointerdown', (e) => {
                            e.preventDefault();
                            btn.style.transform = "scale(0.9)";
                            navigator.vibrate(20);
                            if(g.type === 'battle') runTransaction(ref(db, `rooms/${roomId}/gameVal`), h=>(h||0)-1);
                            else runTransaction(ref(db, `rooms/${roomId}/players/${myId}/score`), s=>(s||0)+1);
                        });
                        btn.addEventListener('pointerup', ()=>btn.style.transform = "scale(1)");
                        area.appendChild(btn);
                    }
                    else if (g.type === 'shake') {
                        area.innerHTML = `<div style="font-size:5rem; animation:shake 0.5s infinite">ğŸ“±</div>`;
                        startSensor();
                    }
                    else if (g.type === 'stop') {
                        const btn = document.createElement('button');
                        btn.className = "c-btn bg-stop";
                        btn.innerText = "STOP";
                        btn.onclick = () => {
                            btn.disabled = true;
                            // æœ¬æ¥ã¯ã‚µãƒ¼ãƒãƒ¼æ™‚é–“ã¨ã®å·®åˆ†è¨ˆç®—ãŒå¿…è¦ã ãŒç°¡æ˜“å®Ÿè£…
                            runTransaction(ref(db, `rooms/${roomId}/players/${myId}/score`), s=>(s||0)+10); 
                        };
                        area.appendChild(btn);
                    }
                }
            });
        }

        function requestSensor() {
            if(typeof DeviceMotionEvent!=='undefined' && typeof DeviceMotionEvent.requestPermission==='function'){
                document.body.addEventListener('click', ()=>DeviceMotionEvent.requestPermission(), {once:true});
            }
        }
        function startSensor() {
            if(sensorActive) return;
            sensorActive = true;
            let last = {x:0,y:0,z:0};
            window.addEventListener('devicemotion', function h(e){
                if(!sensorActive) window.removeEventListener('devicemotion', h);
                const acc = e.accelerationIncludingGravity;
                if(!acc) return;
                const d = Math.abs(acc.x+acc.y+acc.z - last.x-last.y-last.z);
                if(d > 20) {
                    runTransaction(ref(db, `rooms/${roomId}/players/${myId}/score`), s=>(s||0)+1);
                    if(navigator.vibrate) navigator.vibrate(30);
                }
                last = {x:acc.x, y:acc.y, z:acc.z};
            });
        }
    </script>
</body>
</html>
