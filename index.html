<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIäººç‹¼ ARENA V12 - å®‰å®šç‰ˆ</title>
    <style>
        body {
            font-family: "Helvetica Neue", Arial, sans-serif;
            background-color: #0d0d0f; color: white; margin: 0;
            display: flex; flex-direction: column; align-items: center; min-height: 100vh;
        }
        .container { width: 95%; max-width: 650px; padding: 20px; box-sizing: border-box; }
        .hidden { display: none !important; }
        h1 { color: #ff3e3e; text-align: center; border-bottom: 2px solid #ff3e3e; padding-bottom: 10px; }

        /* ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¡¨ç¤º */
        .player-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(110px, 1fr)); gap: 10px; margin-bottom: 15px; }
        .p-card { background: #1a1a20; border: 2px solid #333; border-radius: 12px; padding: 10px; text-align: center; font-size: 14px; }
        .p-card.dead { opacity: 0.3; background: #000; filter: grayscale(1); }
        .p-card.me { border-color: #00ffcc; }
        .role-tag { font-size: 11px; background: #444; padding: 2px 6px; border-radius: 4px; display: inline-block; margin-top: 5px; }

        /* ãƒ­ã‚°ãƒ»å­—å¹• */
        #log-area { background: #000; height: 160px; overflow-y: auto; border: 1px solid #333; padding: 10px; font-size: 14px; margin-bottom: 10px; border-radius: 8px; line-height: 1.6; }
        .name-lbl { font-weight: bold; margin-right: 5px; color: #ffcc00; }

        /* æ“ä½œãƒ‘ãƒãƒ« */
        .panel { background: #1e1e24; padding: 20px; border-radius: 20px; text-align: center; border: 1px solid #444; }
        .privacy-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 1000; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        
        button {
            background: #ff3e3e; color: white; border: none; padding: 15px 30px;
            font-size: 18px; border-radius: 50px; cursor: pointer; font-weight: bold;
            margin: 10px 0; width: 100%; max-width: 320px;
        }
        button:disabled { background: #444; cursor: not-allowed; }
        .btn-sub { background: #3d8bff; }
        .btn-mic { background: #333; border: 1px solid #555; }
        .btn-mic.active { background: #ff3e3e; animation: pulse 1s infinite; }

        input, select { width: 100%; padding: 15px; margin-bottom: 15px; border-radius: 10px; border: none; box-sizing: border-box; font-size: 16px; background: #000; color: white; }
        label { display: block; text-align: left; font-size: 13px; color: #aaa; margin-bottom: 5px; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }
    </style>
</head>
<body>

    <div class="container">
        <h1>AIäººç‹¼ ARENA V12</h1>

        <!-- 1. è¨­å®š -->
        <div id="setup-screen">
            <div class="panel">
                <label>ãƒ—ãƒ¬ã‚¤ç·äººæ•° (5ã€œ10å)</label>
                <input type="number" id="total-players" value="5" min="5" max="10">
                <label>äººé–“ã®å‚åŠ äººæ•°</label>
                <input type="number" id="human-count" value="1" min="1" max="10">
                <button onclick="generateNameInputs()">æ¬¡ã¸é€²ã‚€</button>
            </div>
        </div>

        <!-- 2. åå‰å…¥åŠ› -->
        <div id="name-input-screen" class="hidden">
            <div class="panel">
                <h3>åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</h3>
                <div id="name-fields"></div>
                <button onclick="startGame()">ã‚²ãƒ¼ãƒ é–‹å§‹</button>
            </div>
        </div>

        <!-- 3. ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ä¿è­· (ãƒ‘ã‚¹ï¼†ãƒ—ãƒ¬ã‚¤) -->
        <div id="privacy-screen" class="privacy-overlay hidden">
            <h2 id="turn-player-name" style="color:#00ffcc;">---</h2>
            <p>ã•ã‚“ã®ç•ªã§ã™ã€‚<br>ä»–ã®æ–¹ã¯ç”»é¢ã‚’è¦‹ãªã„ã§ãã ã•ã„ã€‚</p>
            <button onclick="showSecret()">ç”»é¢ã‚’è¡¨ç¤ºã—ã¦ç¢ºèª</button>
        </div>

        <!-- 4. ãƒ¡ã‚¤ãƒ³ã‚²ãƒ¼ãƒ  -->
        <div id="game-screen" class="hidden">
            <h3 id="phase-label" style="color:#ffcc00; text-align:center; margin-bottom:10px;"></h3>
            <div id="timer-display" style="font-size: 40px; text-align:center; font-weight:bold;" class="hidden">01:00</div>
            
            <div class="player-grid" id="player-grid"></div>
            <div id="log-area"></div>
            
            <!-- è­°è«–ãƒ•ã‚§ãƒ¼ã‚ºã®ã¿è¡¨ç¤º -->
            <button id="mic-toggle" class="btn-mic hidden" onclick="toggleMic()">ğŸ¤ ãƒã‚¤ã‚¯ã§è©±ã™ (ãƒ­ã‚°ã«è¨˜éŒ²)</button>

            <div id="control-panel" class="panel" style="margin-top:10px;">
                <p id="guide-msg" style="color: #aaa; font-size: 14px; margin-bottom: 10px;"></p>
                
                <!-- å€‹åˆ¥ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ç”¨ -->
                <div id="action-ui" class="hidden">
                    <div id="role-display" style="font-size:20px; font-weight:bold; color:#ffcc00; margin-bottom:10px;"></div>
                    <label id="action-hint"></label>
                    <select id="target-select"></select>
                    <button id="submit-btn" onclick="onActionClick()">æ±ºå®š</button>
                </div>

                <!-- é€²è¡Œç”¨ãƒœã‚¿ãƒ³ -->
                <button id="finish-turn-btn" class="hidden btn-sub" onclick="finishCurrentTurn()">å®Œäº†ï¼ˆæ¬¡ã®äººã¸ï¼‰</button>
                <button id="next-phase-btn" class="hidden" onclick="advanceToNextPhase()">æœã«é€²ã‚€</button>
            </div>
        </div>
    </div>

    <script>
        // --- ãƒ‡ãƒ¼ã‚¿å®šç¾© ---
        const ROLE = { WOLF: 'äººç‹¼', SEER: 'å ã„å¸«', VILLAGER: 'æ‘äºº' };
        let players = [];
        let day = 1;
        let phase = 'NIGHT';
        let killedThisMorning = null;
        let timerId = null;

        // --- éŸ³å£°åˆæˆ ---
        function speak(text, speaker = "ã‚·ã‚¹ãƒ†ãƒ ") {
            if (window.speechSynthesis) {
                window.speechSynthesis.cancel();
                const uttr = new SpeechSynthesisUtterance(text);
                uttr.lang = "ja-JP";
                uttr.rate = 1.2;
                window.speechSynthesis.speak(uttr);
            }
            addLog(text, speaker);
        }

        function addLog(msg, name = "ã‚·ã‚¹ãƒ†ãƒ ") {
            const log = document.getElementById('log-area');
            const d = document.createElement('div');
            d.innerHTML = `<span class="name-lbl">${name}:</span><span>${msg}</span>`;
            log.appendChild(d);
            log.scrollTop = log.scrollHeight;
        }

        // --- éŸ³å£°èªè­˜ (Mic) ---
        let recognition;
        let isMicOn = false;
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRec = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRec();
            recognition.lang = 'ja-JP';
            recognition.continuous = true;
            recognition.onresult = (e) => {
                const res = e.results[e.results.length - 1][0].transcript;
                addLog(res, "ã‚ãªãŸã®ç™ºè¨€");
            };
        }

        function toggleMic() {
            if (!recognition) return alert("ãƒã‚¤ã‚¯ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“");
            if (isMicOn) {
                recognition.stop();
                document.getElementById('mic-toggle').classList.remove('active');
            } else {
                recognition.start();
                document.getElementById('mic-toggle').classList.add('active');
            }
            isMicOn = !isMicOn;
        }

        // --- åˆæœŸè¨­å®š ---
        function generateNameInputs() {
            const count = document.getElementById('human-count').value;
            document.getElementById('setup-screen').classList.add('hidden');
            document.getElementById('name-input-screen').classList.remove('hidden');
            const area = document.getElementById('name-fields');
            area.innerHTML = "";
            for (let i = 1; i <= count; i++) {
                area.innerHTML += `<input type="text" class="h-name" value="ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${i}">`;
            }
        }

        function startGame() {
            const total = parseInt(document.getElementById('total-players').value);
            const hNames = document.querySelectorAll('.h-name');
            players = [];
            hNames.forEach(input => {
                players.push({ name: input.value, isAI: false, role: '', alive: true, done: false, willDie: false });
            });
            const aiNames = ["ã‚¿ãƒŠã‚«", "ã‚µãƒˆã‚¦", "ã‚¹ã‚ºã‚­", "ã‚¤ãƒˆã‚¦", "ãƒ¤ãƒãƒ€", "ã‚«ãƒˆã‚¦"];
            while (players.length < total) {
                players.push({ name: aiNames[players.length % aiNames.length], isAI: true, role: '', alive: true, done: false, willDie: false });
            }
            let roles = [ROLE.WOLF, ROLE.SEER];
            if (total >= 8) roles.push(ROLE.WOLF);
            while (roles.length < total) roles.push(ROLE.VILLAGER);
            roles.sort(() => Math.random() - 0.5);
            players.forEach((p, i) => p.role = roles[i]);

            document.getElementById('name-input-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('hidden');
            startNightPhase();
        }

        // --- å¤œãƒ•ã‚§ãƒ¼ã‚º ---
        function startNightPhase() {
            phase = 'NIGHT';
            players.forEach(p => p.done = false);
            document.getElementById('phase-label').innerText = `${day}æ—¥ç›®ï¼šå¤œ`;
            document.getElementById('next-phase-btn').classList.add('hidden');
            document.getElementById('mic-toggle').classList.add('hidden');
            document.getElementById('timer-display').classList.add('hidden');
            if (isMicOn) toggleMic();
            
            updateStep();
        }

        function updateStep() {
            const currentHuman = players.find(p => !p.isAI && p.alive && !p.done);
            
            if (currentHuman) {
                // äººé–“ã®ç•ª
                document.getElementById('privacy-overlay').classList.add('hidden'); // å®‰å…¨ã®ãŸã‚ä¸€åº¦éš ã™
                document.getElementById('privacy-screen').classList.remove('hidden');
                document.getElementById('turn-player-name').innerText = currentHuman.name;
                document.getElementById('guide-msg').innerText = "é †ç•ªã«å½¹è·ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚";
                updateGrid(true);
            } else {
                // AIã®å‡¦ç†
                players.forEach(p => {
                    if (p.isAI && p.alive && p.role === ROLE.WOLF) {
                        const targets = players.filter(t => t.alive && t.role !== ROLE.WOLF);
                        if(targets.length > 0) targets[Math.floor(Math.random()*targets.length)].willDie = true;
                    }
                });
                // å…¨å“¡çµ‚äº†
                document.getElementById('privacy-screen').classList.add('hidden');
                document.getElementById('action-ui').classList.add('hidden');
                document.getElementById('finish-turn-btn').classList.add('hidden');
                document.getElementById('next-phase-btn').classList.remove('hidden');
                document.getElementById('next-phase-btn').innerText = "æœã«ã™ã‚‹";
                document.getElementById('guide-msg').innerText = "å…¨å“¡ã®å¤œã®è¡Œå‹•ãŒçµ‚ã‚ã‚Šã¾ã—ãŸã€‚";
                updateGrid(false);
            }
        }

        function showSecret() {
            document.getElementById('privacy-screen').classList.add('hidden');
            document.getElementById('action-ui').classList.remove('hidden');
            const p = players.find(p => !p.isAI && p.alive && !p.done);
            
            document.getElementById('role-display').innerText = `ã‚ãªãŸã¯ã€${p.role}ã€‘ã§ã™`;
            const sel = document.getElementById('target-select');
            sel.innerHTML = "";
            
            if (phase === 'NIGHT') {
                if (p.role === ROLE.WOLF) {
                    document.getElementById('action-hint').innerText = "è¥²æ’ƒã™ã‚‹ç›¸æ‰‹ã‚’é¸ã‚“ã§ãã ã•ã„ï¼š";
                    players.filter(t => t.alive && t.name !== p.name).forEach((t, i) => sel.add(new Option(t.name, players.indexOf(t))));
                } else if (p.role === ROLE.SEER) {
                    document.getElementById('action-hint').innerText = "å ã†ç›¸æ‰‹ã‚’é¸ã‚“ã§ãã ã•ã„ï¼š";
                    players.filter(t => t.alive && t.name !== p.name).forEach((t, i) => sel.add(new Option(t.name, players.indexOf(t))));
                } else {
                    document.getElementById('action-hint').innerText = "æ‘äººã¯å¤œã®è¡Œå‹•ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚";
                    document.getElementById('target-select').classList.add('hidden');
                    document.getElementById('submit-btn').innerText = "ç¢ºèªã—ã¾ã—ãŸ";
                }
            } else if (phase === 'VOTE') {
                document.getElementById('action-hint').innerText = "è¿½æ”¾ã—ãŸã„ç›¸æ‰‹ã«æŠ•ç¥¨ã—ã¦ãã ã•ã„ï¼š";
                document.getElementById('target-select').classList.remove('hidden');
                document.getElementById('submit-btn').innerText = "æŠ•ç¥¨ã™ã‚‹";
                players.filter(t => t.alive && t.name !== p.name).forEach((t, i) => sel.add(new Option(t.name, players.indexOf(t))));
            }
        }

        function onActionClick() {
            const p = players.find(p => !p.isAI && p.alive && !p.done);
            const targetIdx = document.getElementById('target-select').value;
            
            if (phase === 'NIGHT') {
                if (p.role === ROLE.WOLF) players[targetIdx].willDie = true;
                if (p.role === ROLE.SEER) alert(`${players[targetIdx].name}ã•ã‚“ã¯ã€${players[targetIdx].role === ROLE.WOLF ? 'äººç‹¼' : 'äººé–“'}ã€‘ã§ã—ãŸï¼`);
            } else {
                p.voteTo = players[targetIdx].name;
            }

            p.done = true;
            document.getElementById('action-ui').classList.add('hidden');
            document.getElementById('finish-turn-btn').classList.remove('hidden');
            document.getElementById('guide-msg').innerText = "è¡Œå‹•ã‚’è¨˜éŒ²ã—ã¾ã—ãŸã€‚æ¬¡ã®äººã«æ¸¡ã—ã¦ãã ã•ã„ã€‚";
        }

        function finishCurrentTurn() {
            document.getElementById('finish-turn-btn').classList.add('hidden');
            document.getElementById('target-select').classList.remove('hidden');
            document.getElementById('submit-btn').innerText = "æ±ºå®š";
            
            if (phase === 'NIGHT') updateStep();
            else updateVoteStep();
        }

        // --- ãƒ•ã‚§ãƒ¼ã‚ºé€²è¡Œ ---
        function advanceToNextPhase() {
            document.getElementById('next-phase-btn').classList.add('hidden');
            
            if (phase === 'NIGHT') {
                // æœ
                phase = 'MORNING';
                document.getElementById('phase-label').innerText = "æœ";
                killedThisMorning = null;
                players.forEach(p => { if(p.willDie){ p.alive = false; killedThisMorning = p; p.willDie = false; } });
                const msg = killedThisMorning ? `çŠ ç‰²è€…ã¯ ${killedThisMorning.name} ã•ã‚“ã§ã™ã€‚` : "çŠ ç‰²è€…ã¯ã„ã¾ã›ã‚“ã§ã—ãŸã€‚";
                speak(msg);
                updateGrid(false);
                if (!checkGameOver()) {
                    document.getElementById('next-phase-btn').classList.remove('hidden');
                    document.getElementById('next-phase-btn').innerText = "è­°è«–ã‚’å§‹ã‚ã‚‹";
                }
            } else if (phase === 'MORNING') {
                // è­°è«–
                phase = 'DISCUSS';
                document.getElementById('phase-label').innerText = "è­°è«–";
                document.getElementById('timer-display').classList.remove('hidden');
                document.getElementById('mic-toggle').classList.remove('hidden');
                startDiscussTimer();
            } else if (phase === 'DISCUSS') {
                // æŠ•ç¥¨
                phase = 'VOTE';
                document.getElementById('phase-label').innerText = "æŠ•ç¥¨";
                players.forEach(p => p.done = false);
                updateVoteStep();
            } else if (phase === 'VOTE') {
                // å¤œã¸
                day++;
                startNightPhase();
            }
        }

        function startDiscussTimer() {
            let sec = 60;
            timerId = setInterval(() => {
                sec--;
                document.getElementById('timer-display').innerText = `0:${sec < 10 ? '0'+sec : sec}`;
                if (sec % 20 === 0 && sec > 0) {
                    const ais = players.filter(p => p.isAI && p.alive);
                    const spk = ais[Math.floor(Math.random()*ais.length)];
                    speak("èª°ãŒäººç‹¼ã§ã—ã‚‡ã†ã‹ï¼Ÿæ€ªã—ã„äººã‚’è©±ã—åˆã„ã¾ã—ã‚‡ã†ã€‚", spk.name);
                }
                if (sec <= 0) {
                    clearInterval(timerId);
                    document.getElementById('timer-display').classList.add('hidden');
                    document.getElementById('next-phase-btn').classList.remove('hidden');
                    document.getElementById('next-phase-btn').innerText = "æŠ•ç¥¨ã«é€²ã‚€";
                    speak("è©±ã—åˆã„çµ‚äº†ã§ã™ã€‚æŠ•ç¥¨ã«ç§»ã£ã¦ãã ã•ã„ã€‚");
                }
            }, 1000);
        }

        function updateVoteStep() {
            const currentHuman = players.find(p => !p.isAI && p.alive && !p.done);
            if (currentHuman) {
                document.getElementById('privacy-screen').classList.remove('hidden');
                document.getElementById('turn-player-name').innerText = currentHuman.name;
            } else {
                // æŠ•ç¥¨çµæœ
                const votes = {};
                const alives = players.filter(p => p.alive);
                alives.forEach(p => {
                    const v = p.voteTo || alives.filter(t => t !== p)[Math.floor(Math.random()*(alives.length-1))].name;
                    votes[v] = (votes[v] || 0) + 1;
                });
                let max = -1; let res = "";
                for (let n in votes) { if(votes[n] > max){ max = votes[n]; res = n; } }
                const target = players.find(p => p.name === res);
                target.alive = false;
                speak(`${res} ã•ã‚“ãŒè¿½æ”¾ã•ã‚Œã¾ã—ãŸã€‚`);
                updateGrid(false);
                if (!checkGameOver()) {
                    document.getElementById('next-phase-btn').classList.remove('hidden');
                    document.getElementById('next-phase-btn').innerText = "æ¬¡ã®å¤œã¸";
                }
            }
        }

        function checkGameOver() {
            const w = players.filter(p => p.alive && p.role === ROLE.WOLF).length;
            const v = players.filter(p => p.alive && p.role !== ROLE.WOLF).length;
            if (w === 0) { alert("æ‘äººã®å‹åˆ©ã§ã™ï¼"); location.reload(); return true; }
            if (w >= v) { alert("äººç‹¼ã®å‹åˆ©ã§ã™ï¼"); location.reload(); return true; }
            return false;
        }

        function updateGrid(hide) {
            const grid = document.getElementById('player-grid');
            grid.innerHTML = '';
            players.forEach(p => {
                const card = document.createElement('div');
                card.className = `p-card ${p.alive ? '' : 'dead'}`;
                card.innerHTML = `<div>${p.name}</div><div class="role-tag">${(!hide || !p.alive) ? p.role : '???'}</div>`;
                grid.appendChild(card);
            });
        }
    </script>
</body>
</html>
