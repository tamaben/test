<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ARCADE PARTY CONTROLLER</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Black+Ops+One&display=swap" rel="stylesheet">
    
    <style>
        :root { --bg: #1a1a1a; --neon-blue: #0ff; --neon-pink: #f0f; --neon-green: #0f0; --ui-dark: rgba(0,0,0,0.8); }
        body { margin: 0; background: var(--bg); color: white; font-family: 'Press Start 2P', monospace; overflow: hidden; height: 100vh; user-select: none; text-align: center; }

        /* ÂÖ±ÈÄö„Çπ„ÇØ„É™„Éº„É≥Ë®≠ÂÆö */
        .screen { position: fixed; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; background: radial-gradient(circle, #2b2b2b 0%, #000 100%); transition: 0.3s; z-index: 10; }
        .hidden { opacity: 0; pointer-events: none; z-index: -10; }

        /* „Éõ„Çπ„ÉàUI */
        h1 { font-family: 'Black Ops One', cursive; font-size: 4rem; color: var(--neon-blue); text-shadow: 0 0 10px var(--neon-blue); margin: 10px; }
        .btn { background: var(--ui-dark); border: 2px solid var(--neon-green); color: var(--neon-green); padding: 20px 40px; font-size: 1.2rem; cursor: pointer; font-family: inherit; margin: 10px; transition: 0.1s; }
        .btn:hover { background: var(--neon-green); color: black; }
        .btn:active { transform: scale(0.95); }

        /* „Ç≤„Éº„É†ÈÅ∏Êäû„É°„Éã„É•„Éº */
        .mode-select { display: flex; gap: 20px; margin-top: 30px; }
        .game-card { width: 200px; padding: 20px; border: 2px solid white; cursor: pointer; transition: 0.2s; }
        .game-card:hover { border-color: var(--neon-pink); transform: translateY(-10px); background: rgba(255,0,255,0.1); }

        /* „Ç≤„Éº„É†1: BOSS BATTLEÁîªÈù¢ */
        #scene-battle { background: url('https://images.unsplash.com/photo-1518546305927-5a555bb7020d?auto=format&fit=crop&w=1920&q=80') center/cover; }
        .boss-container { position: relative; margin-bottom: 50px; }
        .boss { font-size: 10rem; filter: drop-shadow(0 0 20px red); animation: float 3s ease-in-out infinite; }
        .hp-bar-frame { width: 600px; height: 40px; border: 4px solid white; background: #333; position: relative; }
        .hp-bar-fill { width: 100%; height: 100%; background: linear-gradient(90deg, #f00, #ff0); transition: width 0.2s; }
        .damage-effect { position: absolute; color: red; font-size: 3rem; font-weight: bold; pointer-events: none; animation: popUp 0.5s forwards; text-shadow: 2px 2px 0 white; }

        /* „Ç≤„Éº„É†2: RACEÁîªÈù¢ */
        #scene-race { background: #222; align-items: stretch; padding: 20px; justify-content: flex-start; }
        .track { position: relative; height: 80px; border-bottom: 2px dashed #555; display: flex; align-items: center; }
        .racer { position: absolute; left: 0; font-size: 3rem; transition: left 0.2s linear; }
        .goal-line { position: absolute; right: 50px; top:0; bottom:0; width: 10px; background: repeating-linear-gradient(45deg, white, white 10px, black 10px, black 20px); z-index: 0; }

        /* „É´„Éº„É¨„ÉÉ„ÉàÁîªÈù¢ */
        #wheel { width: 400px; height: 400px; border-radius: 50%; border: 10px solid white; background: conic-gradient(red 0deg 120deg, blue 120deg 240deg, green 240deg 360deg); transition: transform 4s cubic-bezier(0.1, 0.9, 0.2, 1); margin: 20px; }
        .arrow { width: 0; height: 0; border-left: 20px solid transparent; border-right: 20px solid transparent; border-top: 40px solid white; position: relative; top: 10px; z-index: 20; }

        /* „Çπ„Éû„Éõ„Ç≥„É≥„Éà„É≠„Éº„É©„Éº */
        .ctrl-pad { display: flex; flex-direction: column; width: 100%; height: 100%; align-items: center; justify-content: center; background: #222; }
        .btn-round { width: 200px; height: 200px; border-radius: 50%; border: none; font-size: 2rem; font-family: inherit; color: white; box-shadow: 0 10px 0 #000; active:translateY(10px); }
        .btn-attack { background: #e74c3c; box-shadow: 0 10px 0 #c0392b; }
        .btn-nitro { background: #3498db; box-shadow: 0 10px 0 #2980b9; }
        .btn-shake { background: #f1c40f; color: black; box-shadow: 0 10px 0 #f39c12; }

        /* „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
        @keyframes float { 0%,100%{transform:translateY(0);} 50%{transform:translateY(-20px);} }
        @keyframes popUp { 0%{opacity:1; transform:translateY(0);} 100%{opacity:0; transform:translateY(-50px);} }
        .shake { animation: shake 0.3s; }
        @keyframes shake { 0% { transform: translate(1px, 1px) rotate(0deg); } 100% { transform: translate(-1px, -2px) rotate(-1deg); } }

    </style>
</head>
<body>

    <div id="s-top" class="screen">
        <h1>ARCADE<br>CONTROLLER</h1>
        <p>SMARTPHONE PARTY GAME SYSTEM</p>
        <button id="btn-host" class="btn">START CONSOLE (PC)</button>
        <button id="btn-client" class="btn" style="border-color:var(--neon-pink); color:var(--neon-pink);">JOIN GAME (PHONE)</button>
    </div>

    <div id="s-lobby" class="screen hidden">
        <h2>SCAN TO JOIN</h2>
        <div id="qrcode" style="background:white; padding:15px; border-radius:10px;"></div>
        <p>ID: <span id="disp-id" style="color:var(--neon-blue); font-size:2rem;">----</span></p>
        <p>PLAYERS: <span id="p-count">0</span></p>
        <button id="btn-goto-menu" class="btn">GAME SELECT</button>
    </div>

    <div id="s-menu" class="screen hidden">
        <h2>SELECT MODE</h2>
        <div class="mode-select">
            <div class="game-card" onclick="startRoulette()">
                <div style="font-size:3rem">üé≤</div>
                <p>ROULETTE</p>
            </div>
            <div class="game-card" onclick="initGame('battle')">
                <div style="font-size:3rem">üêâ</div>
                <p>BOSS BATTLE</p>
            </div>
            <div class="game-card" onclick="initGame('race')">
                <div style="font-size:3rem">üèéÔ∏è</div>
                <p>DRAG RACE</p>
            </div>
        </div>
    </div>

    <div id="s-roulette" class="screen hidden">
        <div class="arrow"></div>
        <div id="wheel"></div>
        <h2 id="roulette-result" style="margin-top:20px;">SPINNING...</h2>
    </div>

    <div id="scene-battle" class="screen hidden">
        <div class="boss-container">
            <div id="boss-display" class="boss">üëæ</div>
            <div id="dmg-area"></div>
        </div>
        <div class="hp-bar-frame"><div id="boss-hp" class="hp-bar-fill"></div></div>
        <h2 style="color:red; background:rgba(0,0,0,0.7); padding:10px;">MASH THE BUTTON!</h2>
    </div>

    <div id="scene-race" class="screen hidden">
        <h1>DRAG RACE</h1>
        <div class="goal-line"></div>
        <div id="race-tracks" style="width:100%;"></div>
    </div>

    <div id="s-result" class="screen hidden">
        <h1>WINNER</h1>
        <div id="winner-disp" style="font-size:3rem; color:var(--neon-green);">PLAYER</div>
        <button onclick="location.reload()" class="btn">BACK TO TITLE</button>
    </div>


    <div id="s-c-login" class="screen hidden">
        <h2>ENTER ROOM ID</h2>
        <input id="inp-id" style="font-size:1.5rem; text-align:center; padding:10px; width:80%; text-transform:uppercase;" placeholder="ABCD">
        <br><br>
        <input id="inp-name" style="font-size:1.2rem; text-align:center; padding:10px; width:80%;" placeholder="NAME">
        <br><br>
        <button id="btn-join" class="btn">CONNECT</button>
    </div>

    <div id="s-c-pad" class="screen hidden">
        <div id="pad-area" class="ctrl-pad">
            <p>WAITING FOR HOST...</p>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, set, get, onValue, update, remove, onDisconnect, increment, child, runTransaction } 
               from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        // ‚ñº Firebase config (Ëá™ÂàÜ„ÅÆ„ÇÇ„ÅÆ„Å´Êõ∏„ÅçÊèõ„Åà„Å¶„Åè„Å†„Åï„ÅÑ)
        const firebaseConfig = {
            apiKey: "AIzaSyDbZzTMvUkG2LXIGY4ux0KBTmnAdqP236s",
            authDomain: "game-4f2d9.firebaseapp.com",
            databaseURL: "https://game-4f2d9-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "game-4f2d9",
            storageBucket: "game-4f2d9.firebasestorage.app",
            messagingSenderId: "574316347824",
            appId: "1:574316347824:web:cf686040628e25ad615675"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- Â§âÊï∞ ---
        let myId = "P" + Math.random().toString(36).substr(2, 5);
        let roomId = "";
        let players = {};
        let gameLoop = null;

        const $ = id => document.getElementById(id);
        const show = id => {
            document.querySelectorAll('.screen').forEach(e => e.classList.add('hidden'));
            $(id).classList.remove('hidden');
        };

        // ================= HOST LOGIC =================
        $('btn-host').addEventListener('click', () => {
            roomId = Math.random().toString(36).substr(2, 4).toUpperCase();
            const rRef = ref(db, `rooms/${roomId}`);
            set(rRef, { status: 'lobby', host: myId });
            onDisconnect(rRef).remove();

            $('disp-id').innerText = roomId;
            $('qrcode').innerHTML = "";
            new QRCode($('qrcode'), { text: roomId, width: 150, height: 150 });
            show('s-lobby');

            onValue(ref(db, `rooms/${roomId}/players`), snap => {
                players = snap.val() || {};
                $('p-count').innerText = Object.keys(players).length;
            });
        });

        $('btn-goto-menu').addEventListener('click', () => show('s-menu'));

        // --- „É´„Éº„É¨„ÉÉ„ÉàÊ©üËÉΩ ---
        window.startRoulette = () => {
            show('s-roulette');
            const wheel = $('wheel');
            const games = ['battle', 'race', 'battle']; // Á¢∫ÁéáË™øÊï¥
            let deg = 0;
            
            // ÂõûËª¢„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
            const timer = setInterval(() => { deg += 20; wheel.style.transform = `rotate(${deg}deg)`; }, 50);

            // 3ÁßíÂæå„Å´ÂÅúÊ≠¢
            setTimeout(() => {
                clearInterval(timer);
                const selected = games[Math.floor(Math.random() * games.length)];
                const stopDeg = deg + 720 + Math.floor(Math.random() * 360);
                wheel.style.transform = `rotate(${stopDeg}deg)`;
                
                $('roulette-result').innerText = selected.toUpperCase() + "!";
                setTimeout(() => window.initGame(selected), 3000);
            }, 3000);
        };

        // --- „Ç≤„Éº„É†ÂàùÊúüÂåñ ---
        window.initGame = (type) => {
            // „Çπ„Ç≥„Ç¢„É™„Çª„ÉÉ„Éà
            const updates = {};
            Object.keys(players).forEach(pid => updates[`rooms/${roomId}/players/${pid}/score`] = 0);
            update(ref(db), updates);

            if(type === 'battle') {
                const maxHp = Object.keys(players).length * 50; 
                update(ref(db, `rooms/${roomId}`), { status: 'playing', gameType: 'battle', bossHp: maxHp, maxHp: maxHp });
                show('scene-battle');
                startBattleLoop();
            } else if (type === 'race') {
                update(ref(db, `rooms/${roomId}`), { status: 'playing', gameType: 'race', maxScore: 50 });
                show('scene-race');
                setupRaceTrack();
                startRaceLoop();
            }
        };

        // --- BATTLE MODE ---
        function startBattleLoop() {
            onValue(ref(db, `rooms/${roomId}/bossHp`), snap => {
                const hp = snap.val();
                const max = Number($('boss-hp').dataset.max || 100);
                // ÂàùÂõû„É≠„Éº„ÉâÁî®
                if(!$('boss-hp').dataset.max) $('boss-hp').dataset.max = snap.val();

                const pct = (hp / $('boss-hp').dataset.max) * 100;
                $('boss-hp').style.width = pct + "%";
                
                // „ÉÄ„É°„Éº„Ç∏ÊºîÂá∫
                const boss = $('boss-display');
                boss.classList.add('shake');
                setTimeout(() => boss.classList.remove('shake'), 200);

                if(hp <= 0) endGame('PLAYERS WIN!');
            });
        }

        // --- RACE MODE ---
        function setupRaceTrack() {
            const container = $('race-tracks');
            container.innerHTML = "";
            Object.keys(players).forEach((pid, i) => {
                const p = players[pid];
                const row = document.createElement('div');
                row.className = "track";
                row.innerHTML = `
                    <div style="position:absolute; left:10px; top:-20px; color:#aaa; font-size:0.8rem;">${p.name}</div>
                    <div id="car-${pid}" class="racer" style="color:hsl(${i*50}, 100%, 50%)">üèéÔ∏è</div>
                `;
                container.appendChild(row);
            });
        }

        function startRaceLoop() {
            onValue(ref(db, `rooms/${roomId}/players`), snap => {
                const data = snap.val();
                if(!data) return;
                let winner = null;
                
                Object.keys(data).forEach(pid => {
                    const score = data[pid].score || 0;
                    const car = document.getElementById(`car-${pid}`);
                    if(car) {
                        // ÁîªÈù¢ÂπÖ90%„Çí„Ç¥„Éº„É´„Å®„Åô„Çã
                        const pct = Math.min(90, score * 2); 
                        car.style.left = pct + "%";
                        if(pct >= 90) winner = data[pid].name;
                    }
                });

                if(winner) endGame(winner + " WINS!");
            });
        }

        function endGame(msg) {
            update(ref(db, `rooms/${roomId}`), { status: 'result' });
            show('s-result');
            $('winner-disp').innerText = msg;
            confetti({ particleCount: 200, spread: 100 });
        }

        // ================= CLIENT LOGIC =================
        $('btn-client').addEventListener('click', () => show('s-c-login'));
        
        $('btn-join').addEventListener('click', async () => {
            const rid = $('inp-id').value.toUpperCase().trim();
            const name = $('inp-name').value || "NoName";
            
            try {
                const snap = await get(child(ref(db), `rooms/${rid}`));
                if(!snap.exists()) return alert("Room not found");
                
                roomId = rid;
                const pRef = ref(db, `rooms/${roomId}/players/${myId}`);
                set(pRef, { name: name, score: 0 });
                onDisconnect(pRef).remove();
                
                show('s-c-pad');
                initController();
            } catch(e) { alert("Error connecting"); }
        });

        function initController() {
            onValue(ref(db, `rooms/${roomId}`), snap => {
                const data = snap.val();
                if(!data) return location.reload();

                const pad = $('pad-area');
                pad.innerHTML = "";

                if(data.status === 'playing') {
                    // --- „Ç≥„É≥„Éà„É≠„Éº„É©„Éº UI ÁîüÊàê ---
                    if(data.gameType === 'battle') {
                        const btn = document.createElement('button');
                        btn.className = "btn-round btn-attack";
                        btn.innerHTML = "ATTACK<br>üëä";
                        btn.onpointerdown = (e) => {
                            e.preventDefault();
                            btn.style.transform = "scale(0.9)";
                            // „Éú„ÇπHP„ÇíÊ∏õ„Çâ„Åô
                            runTransaction(ref(db, `rooms/${roomId}/bossHp`), (hp) => (hp||0) - 1);
                            if(navigator.vibrate) navigator.vibrate(20);
                        };
                        btn.onpointerup = () => btn.style.transform = "scale(1)";
                        pad.appendChild(btn);
                    } 
                    else if (data.gameType === 'race') {
                        const btn = document.createElement('button');
                        btn.className = "btn-round btn-nitro";
                        btn.innerHTML = "GAS<br>üí®";
                        btn.onpointerdown = (e) => {
                            e.preventDefault();
                            btn.style.transform = "scale(0.9)";
                            // Ëá™ÂàÜ„ÅÆ„Çπ„Ç≥„Ç¢„ÇíÂä†ÁÆó
                            runTransaction(ref(db, `rooms/${roomId}/players/${myId}/score`), (s) => (s||0) + 1);
                            if(navigator.vibrate) navigator.vibrate(10);
                        };
                        btn.onpointerup = () => btn.style.transform = "scale(1)";
                        pad.appendChild(btn);
                    }
                } else if (data.status === 'result') {
                    pad.innerHTML = "<h2>FINISH!</h2>";
                } else {
                    pad.innerHTML = "<p>WAITING FOR GAME...</p>";
                }
            });
        }

    </script>
</body>
</html>
