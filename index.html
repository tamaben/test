<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PARTY BOX: SENSOR FIX</title>
    
    <!-- ãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <!-- ãƒ‡ã‚¶ã‚¤ãƒ³ -->
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@600&family=M+PLUS+Rounded+1c:wght@800&display=swap" rel="stylesheet">
    
    <style>
        :root { --bg: #121212; --primary: #00ff88; --accent: #ff0055; --ui: #ffffff; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            margin: 0; background: var(--bg); color: var(--ui);
            font-family: 'M PLUS Rounded 1c', sans-serif;
            overflow: hidden; height: 100vh; text-align: center;
            user-select: none; touch-action: manipulation;
        }

        /* ç”»é¢åˆ‡ã‚Šæ›¿ãˆ */
        .screen {
            position: fixed; inset: 0;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: radial-gradient(circle at center, #2a2a2a 0%, #000 100%);
            transition: opacity 0.3s; z-index: 1; padding: 20px;
        }
        .hidden { opacity: 0; pointer-events: none; z-index: -10; }

        /* UIãƒ‘ãƒ¼ãƒ„ */
        h1 { font-family: 'Fredoka', sans-serif; font-size: 3.5rem; color: var(--primary); margin: 0; letter-spacing: 2px; text-shadow: 4px 4px 0 rgba(0,0,0,0.5); }
        h2 { margin: 10px; font-size: 1.8rem; }
        p { color: #aaa; font-size: 1rem; margin: 5px; }

        .btn {
            background: linear-gradient(135deg, var(--primary), #00ccff);
            border: none; color: #000; padding: 15px 40px;
            font-size: 1.4rem; border-radius: 50px; cursor: pointer;
            margin: 15px; font-weight: bold;
            box-shadow: 0 5px 15px rgba(0, 255, 136, 0.3);
            transition: transform 0.1s;
        }
        .btn:active { transform: scale(0.95); }
        .btn-red { background: linear-gradient(135deg, #ff0055, #ff5500); color: white; box-shadow: 0 5px 15px rgba(255, 0, 85, 0.3); }

        /* ã‚¤ãƒ³ãƒ—ãƒƒãƒˆ */
        input {
            font-size: 1.5rem; padding: 15px; width: 250px; text-align: center;
            border-radius: 15px; border: 2px solid #555; background: #222; color: white;
            margin-bottom: 15px; outline: none;
        }
        input:focus { border-color: var(--primary); }

        /* ã‚²ãƒ¼ãƒ ç”»é¢ï¼ˆãƒ›ã‚¹ãƒˆï¼‰ */
        .big-timer { font-size: 6rem; font-family: 'Fredoka'; color: var(--ui); margin: 20px; }
        .leaderboard { width: 100%; max-width: 500px; background: rgba(255,255,255,0.1); border-radius: 15px; padding: 10px; }
        .rank-row { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 1.2rem; }

        /* ã‚²ãƒ¼ãƒ ç”»é¢ï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼‰ */
        .game-area { width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; }
        
        /* ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ */
        .act-btn {
            width: 160px; height: 160px; border-radius: 50%;
            border: 8px solid rgba(255,255,255,0.1);
            background: #333; color: white;
            font-size: 2rem; font-weight: 900;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            box-shadow: 0 10px 0 rgba(0,0,0,0.3);
            transition: transform 0.05s; cursor: pointer;
            -webkit-user-select: none;
        }
        .act-btn:active { transform: translateY(10px); box-shadow: none; }
        .act-btn.huge { width: 260px; height: 260px; font-size: 3rem; background: var(--accent); border-color: #ff88aa; }
        
        /* ã‚»ãƒ³ã‚µãƒ¼ãƒ‡ãƒãƒƒã‚°ç”¨ */
        #sensor-debug { position: absolute; bottom: 10px; left: 10px; font-size: 0.8rem; color: #555; text-align: left; pointer-events: none; }
    </style>
</head>
<body>

    <!-- ================= HOST SCREENS ================= -->
    <div id="h-top" class="screen">
        <h1>PARTY BOX</h1>
        <p>20 MINI GAMES BATTLE</p>
        <div style="margin-top:30px;">
            <button id="btn-start-host" class="btn">ğŸ’» ãƒ›ã‚¹ãƒˆã§ã¯ã˜ã‚ã‚‹</button>
            <button id="btn-goto-client" class="btn btn-red">ğŸ“± ã‚¹ãƒãƒ›ã§å‚åŠ </button>
        </div>
    </div>

    <div id="h-lobby" class="screen hidden">
        <h2>ROOM ID</h2>
        <div id="disp-id" style="font-size:5rem; font-family:'Fredoka'; color:var(--primary);">----</div>
        <div id="qrcode" style="background:white; padding:15px; border-radius:15px; margin:20px;"></div>
        <p>å‚åŠ äººæ•°: <span id="p-count" style="color:var(--primary); font-weight:bold; font-size:1.5rem;">0</span> äºº</p>
        <button id="btn-game-start" class="btn">ã‚²ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆï¼</button>
    </div>

    <div id="h-game" class="screen hidden">
        <h2 id="g-round" style="color:var(--primary);">ROUND 1</h2>
        <h1 id="g-title" style="font-size:3rem;">GAME TITLE</h1>
        <p id="g-desc">Description</p>
        <div id="g-timer" class="big-timer">READY</div>
        <div id="g-info" style="font-size:1.5rem; color:#aaa;"></div>
    </div>

    <div id="h-result" class="screen hidden">
        <h1>RESULT</h1>
        <div id="ranking-container" class="leaderboard"></div>
        <button id="btn-next-round" class="btn">æ¬¡ã®ãƒ©ã‚¦ãƒ³ãƒ‰ã¸</button>
    </div>

    <!-- ================= CLIENT SCREENS ================= -->
    <div id="c-login" class="screen hidden">
        <h2>ROOM ID</h2>
        <input id="inp-rid" type="text" maxlength="4" placeholder="ABCD" style="text-transform:uppercase;">
        <input id="inp-name" type="text" maxlength="8" placeholder="ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ">
        <br>
        <p style="font-size:0.9rem; color:#f88;">â€»å‚åŠ ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨<br>ã‚»ãƒ³ã‚µãƒ¼è¨±å¯ã®ç¢ºèªãŒå‡ºã¾ã™</p>
        <button id="btn-join" class="btn btn-red">å‚åŠ ã™ã‚‹</button>
    </div>

    <div id="c-play" class="screen hidden">
        <div id="c-status" style="position:absolute; top:20px; font-size:1.2rem; color:#888;">å¾…æ©Ÿä¸­...</div>
        <div id="c-area" class="game-area"></div>
        <div id="sensor-debug">Sensor: OFF</div>
    </div>

    <!-- ================= SCRIPT ================= -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, set, get, onValue, update, remove, onDisconnect, runTransaction, child } 
               from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        // Firebaseè¨­å®š
        const firebaseConfig = {
            apiKey: "AIzaSyDbZzTMvUkG2LXIGY4ux0KBTmnAdqP236s",
            authDomain: "game-4f2d9.firebaseapp.com",
            databaseURL: "https://game-4f2d9-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "game-4f2d9",
            storageBucket: "game-4f2d9.firebasestorage.app",
            messagingSenderId: "574316347824",
            appId: "1:574316347824:web:cf686040628e25ad615675"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // UIãƒ˜ãƒ«ãƒ‘ãƒ¼
        const $ = id => document.getElementById(id);
        const show = id => {
            document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
            $(id).classList.remove('hidden');
        };

        // å¤‰æ•°
        let myId = "P" + Math.random().toString(36).substr(2, 5);
        let roomId = "";
        let currentRound = 1;
        const TOTAL_ROUNDS = 5;
        let sensorActive = false;

        // ã‚²ãƒ¼ãƒ å®šç¾©
        const GAMES = [
            {id:'tap', n:'é€£æ‰“ãƒãƒˆãƒ«', d:'ç”»é¢ã‚’å£Šã‚Œã‚‹ã»ã©é€£æ‰“ã—ã‚ï¼', t:'tap'},
            {id:'shake', n:'ã‚·ã‚§ã‚¤ã‚¯ï¼', d:'ã‚¹ãƒãƒ›ã‚’å…¨åŠ›ã§æŒ¯ã‚Œï¼', t:'shake'},
            {id:'stop', n:'5ç§’æ­¢ã‚', d:'5.00ç§’ãƒ”ãƒƒã‚¿ãƒªã§æ­¢ã‚ã‚ï¼', t:'stop'},
            {id:'charge', n:'ãƒ‘ãƒ¯ãƒ¼å……å¡«', d:'é•·æŠ¼ã—ã—ã¦100%ã‚’ç›®æŒ‡ã›ï¼', t:'charge'},
            {id:'math', n:'è¨ˆç®—ã‚¯ã‚¤ã‚º', d:'æ­£ã—ã„ç­”ãˆã‚’é¸ã¹ï¼', t:'quiz_math'},
            {id:'color', n:'è‰²å½©æ„Ÿè¦š', d:'æ–‡å­—ã®ã€Œè‰²ã€ã‚’é¸ã¹ï¼', t:'quiz_color'},
            {id:'count', n:'10å›æŠ¼ã›', d:'æ­£ç¢ºã«10å›ã ã‘æŠ¼ã—ã¦æ±ºå®šï¼', t:'count'},
            {id:'dont', n:'æŠ¼ã™ãªï¼', d:'çµ¶å¯¾ã«ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ãªï¼', t:'dont'},
            {id:'luck', n:'é‹è©¦ã—', d:'å½“ãŸã‚Šã‚’å¼•ã‘ï¼', t:'luck'}
        ];

        // ---------------- HOST LOGIC ----------------
        $('btn-start-host').addEventListener('click', () => {
            roomId = Math.random().toString(36).substr(2, 4).toUpperCase();
            const rRef = ref(db, `rooms/${roomId}`);
            set(rRef, { status: 'lobby', round: 1 });
            onDisconnect(rRef).remove();
            
            $('disp-id').innerText = roomId;
            $('qrcode').innerHTML = "";
            new QRCode($('qrcode'), { text: `${location.origin}${location.pathname}?room=${roomId}`, width: 128, height: 128 });
            
            show('h-lobby');
            
            onValue(ref(db, `rooms/${roomId}/players`), snap => {
                $('p-count').innerText = snap.exists() ? Object.keys(snap.val()).length : 0;
            });
        });

        $('btn-game-start').addEventListener('click', () => {
            currentRound = 1;
            // ã‚¹ã‚³ã‚¢ãƒªã‚»ãƒƒãƒˆ
            get(ref(db, `rooms/${roomId}/players`)).then(snap => {
                if(!snap.exists()) return alert("ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒã„ã¾ã›ã‚“");
                const u = {};
                snap.forEach(p => u[`rooms/${roomId}/players/${p.key}/total`] = 0);
                update(ref(db), u).then(startRound);
            });
        });

        $('btn-next-round').addEventListener('click', () => {
            currentRound++;
            if(currentRound > TOTAL_ROUNDS) location.reload(); // çµ‚äº†
            else startRound();
        });

        function startRound() {
            const game = GAMES[Math.floor(Math.random() * GAMES.length)];
            const u = {};
            // ãƒ©ã‚¦ãƒ³ãƒ‰ã‚¹ã‚³ã‚¢ãƒªã‚»ãƒƒãƒˆ & ã‚²ãƒ¼ãƒ è¨­å®š
            get(ref(db, `rooms/${roomId}/players`)).then(snap => {
                snap.forEach(p => u[`rooms/${roomId}/players/${p.key}/score`] = 0);
                u[`rooms/${roomId}/status`] = 'game';
                u[`rooms/${roomId}/game`] = game;
                u[`rooms/${roomId}/round`] = currentRound;
                update(ref(db), u);
                
                show('h-game');
                $('g-round').innerText = `ROUND ${currentRound}/${TOTAL_ROUNDS}`;
                $('g-title').innerText = game.n;
                $('g-desc').innerText = game.d;
                $('g-timer').innerText = "READY";
                $('g-info').innerText = "";

                // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³
                setTimeout(() => {
                    $('g-timer').innerText = "GO!";
                    let t = 15.0;
                    const timer = setInterval(() => {
                        t -= 0.1;
                        $('g-timer').innerText = t.toFixed(1);
                        if(t <= 0) {
                            clearInterval(timer);
                            endRound();
                        }
                    }, 100);
                }, 3000);
            });
        }

        function endRound() {
            get(ref(db, `rooms/${roomId}/players`)).then(snap => {
                const list = [];
                const u = {};
                snap.forEach(p => {
                    const d = p.val();
                    const s = d.score || 0;
                    const total = (d.total || 0) + s;
                    u[`rooms/${roomId}/players/${p.key}/total`] = total;
                    list.push({n:d.name, s:s, t:total});
                });
                update(ref(db), u);
                
                update(ref(db, `rooms/${roomId}/status`), 'result');
                show('h-result');
                
                list.sort((a,b) => b.s - a.s);
                $('ranking-container').innerHTML = list.map((p,i) => `
                    <div class="rank-row">
                        <span>#${i+1} ${p.n}</span>
                        <span>+${p.s} (è¨ˆ${p.t})</span>
                    </div>
                `).join('');
                confetti();
            });
        }

        // ---------------- CLIENT LOGIC ----------------
        const params = new URLSearchParams(location.search);
        if(params.get('room')) { $('inp-rid').value = params.get('room'); show('c-login'); }

        $('btn-goto-client').addEventListener('click', () => show('c-login'));

        $('btn-join').addEventListener('click', async () => {
            const rid = $('inp-rid').value.toUpperCase();
            const name = $('inp-name').value || "åç„¡ã—";
            if(!rid) return alert("éƒ¨å±‹IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

            // â˜…é‡è¦: iOSç”¨ã‚»ãƒ³ã‚µãƒ¼è¨±å¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
            if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
                try {
                    const permissionState = await DeviceMotionEvent.requestPermission();
                    if (permissionState === 'granted') {
                        sensorActive = true;
                        $('sensor-debug').innerText = "Sensor: OK (iOS)";
                    } else {
                        alert("ã‚»ãƒ³ã‚µãƒ¼è¨±å¯ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚ã‚²ãƒ¼ãƒ ã®ä¸€éƒ¨ãŒéŠã¹ã¾ã›ã‚“ã€‚");
                    }
                } catch (e) {
                    console.error(e);
                    // PCãªã©ã§ã¯ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ãŒç„¡è¦–ã—ã¦é€²ã‚€
                }
            } else {
                sensorActive = true;
                $('sensor-debug').innerText = "Sensor: OK (Android/PC)";
            }

            // Firebaseæ¥ç¶š
            const rSnap = await get(child(ref(db), `rooms/${rid}`));
            if(!rSnap.exists()) return alert("éƒ¨å±‹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");

            roomId = rid;
            const pRef = ref(db, `rooms/${roomId}/players/${myId}`);
            set(pRef, { name: name, score: 0, total: 0 });
            onDisconnect(pRef).remove();

            show('c-play');
            listenRoom();
        });

        function listenRoom() {
            onValue(ref(db, `rooms/${roomId}`), snap => {
                const data = snap.val();
                if(!data) return;

                if(data.status === 'lobby') {
                    $('c-status').innerText = "ãƒ›ã‚¹ãƒˆã®é–‹å§‹å¾…ã¡...";
                    $('c-area').innerHTML = "<div style='font-size:3rem;'>â³</div>";
                }
                else if (data.status === 'result') {
                    $('c-status').innerText = "çµæœç™ºè¡¨";
                    $('c-area').innerHTML = "<div style='font-size:3rem;'>ğŸ†</div>";
                }
                else if (data.status === 'game') {
                    $('c-status').innerText = `R${data.round}: ${data.game.n}`;
                    // ã‚²ãƒ¼ãƒ ãŒå¤‰ã‚ã£ãŸæ™‚ã ã‘å†æç”»ã™ã‚‹ãŸã‚ã®ç°¡æ˜“ãƒã‚§ãƒƒã‚¯
                    if($('c-area').getAttribute('data-gid') !== data.game.id) {
                        $('c-area').setAttribute('data-gid', data.game.id);
                        $('c-area').innerHTML = `<div style="font-size:2rem;">READY...</div>`;
                        setTimeout(() => renderGameUI(data.game), 3000);
                    }
                }
            });
        }

        function renderGameUI(game) {
            const area = $('c-area');
            area.innerHTML = "";
            let score = 0;

            // ã‚¹ã‚³ã‚¢é€ä¿¡é–¢æ•°
            const sendScore = (val) => {
                score = val;
                runTransaction(ref(db, `rooms/${roomId}/players/${myId}/score`), _ => score);
            };
            const addScore = (val=1) => {
                score += val;
                runTransaction(ref(db, `rooms/${roomId}/players/${myId}/score`), c => (c||0)+val);
                if(navigator.vibrate) navigator.vibrate(30);
            };

            // ã‚²ãƒ¼ãƒ åˆ¥UIç”Ÿæˆ
            if(game.t === 'tap') {
                const b = document.createElement('button');
                b.className = "act-btn huge";
                b.innerText = "PUSH!";
                // ãƒã‚¤ãƒ³ã‚¿ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆã§é«˜é€Ÿåå¿œ
                b.onpointerdown = (e) => {
                    e.preventDefault();
                    addScore(1);
                    b.style.transform = "scale(0.9)";
                };
                b.onpointerup = () => b.style.transform = "scale(1)";
                area.appendChild(b);
            }
            else if(game.t === 'shake') {
                area.innerHTML = `<div style="font-size:5rem;">ğŸ“±</div><p>æŒ¯ã‚Œï¼</p>`;
                if(sensorActive) {
                    let last = {x:0,y:0,z:0};
                    const h = (e) => {
                        const a = e.accelerationIncludingGravity;
                        if(!a) return;
                        const d = Math.abs(a.x+a.y+a.z - last.x-last.y-last.z);
                        if(d > 25) addScore(1);
                        last = {x:a.x, y:a.y, z:a.z};
                    };
                    window.addEventListener('devicemotion', h, {once:false});
                    setTimeout(()=>window.removeEventListener('devicemotion', h), 15000);
                } else {
                    area.innerHTML += `<p style="color:red">ã‚»ãƒ³ã‚µãƒ¼OFFã®ãŸã‚<br>ç”»é¢ã‚¿ãƒƒãƒ—ã§ä»£ç”¨</p>`;
                    area.onclick = () => addScore(1);
                }
            }
            else if(game.t === 'stop') {
                const start = Date.now();
                const b = document.createElement('button');
                b.className = "act-btn";
                b.innerText = "STOP";
                b.onclick = () => {
                    const diff = Math.abs(5000 - (Date.now() - start));
                    const pt = Math.max(0, 1000 - diff);
                    sendScore(Math.floor(pt));
                    b.disabled = true;
                    b.innerText = (diff/1000).toFixed(2);
                };
                area.appendChild(b);
            }
            else if(game.t === 'charge') {
                const bar = document.createElement('div');
                bar.style.cssText = "width:200px; height:20px; background:#333; margin-bottom:20px; border:2px solid white;";
                const fill = document.createElement('div');
                fill.style.cssText = "width:0%; height:100%; background:var(--primary);";
                bar.appendChild(fill);
                
                const b = document.createElement('button');
                b.className = "act-btn huge";
                b.innerText = "HOLD";
                
                let p = 0, iv;
                b.onpointerdown = (e) => {
                    e.preventDefault();
                    p = 0;
                    iv = setInterval(()=>{ p+=2; fill.style.width=Math.min(100,p)+"%"; }, 30);
                };
                b.onpointerup = () => {
                    clearInterval(iv);
                    if(p >= 90 && p <= 100) sendScore(500);
                    else if(p > 100) sendScore(0); // ãƒãƒ¼ã‚¹ãƒˆ
                    else sendScore(p);
                    p=0; fill.style.width="0%";
                };
                area.appendChild(bar);
                area.appendChild(b);
            }
            else if(game.t === 'quiz_math') {
                const n1 = Math.floor(Math.random()*9)+1;
                const n2 = Math.floor(Math.random()*9)+1;
                const ans = n1+n2;
                const fake = ans + (Math.random()>.5?1:-1);
                area.innerHTML = `<div style="font-size:3rem; margin-bottom:20px;">${n1} + ${n2} = ?</div>`;
                
                const mkBtn = (val) => {
                    const b = document.createElement('button');
                    b.className = "btn";
                    b.innerText = val;
                    b.onclick = () => {
                        if(val === ans) { addScore(50); b.style.background="lime"; }
                        else { addScore(-20); b.style.background="red"; }
                        setTimeout(()=>renderGameUI(game), 500);
                    };
                    return b;
                };
                area.appendChild(mkBtn(Math.random()>.5 ? ans : fake));
                area.appendChild(mkBtn(Math.random()>.5 ? fake : ans)); // ç°¡æ˜“å®Ÿè£…
            }
            else {
                // ãã®ä»–ã®ã‚²ãƒ¼ãƒ ç”¨æ±ç”¨UI
                const b = document.createElement('button');
                b.className = "act-btn huge";
                b.innerText = "ACTION";
                b.onpointerdown = (e) => { e.preventDefault(); addScore(1); b.style.transform="scale(0.9)"; };
                b.onpointerup = () => b.style.transform="scale(1)";
                area.appendChild(b);
            }
        }
    </script>
</body>
</html>
