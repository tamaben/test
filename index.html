<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NEON SHAKE BATTLE</title>
    <!-- QR„Ç≥„Éº„ÉâÁîüÊàê„É©„Ç§„Éñ„É©„É™ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <!-- „Éï„Ç©„É≥„Éà -->
    <link href="https://fonts.googleapis.com/css2?family=Black+Ops+One&family=M+PLUS+Rounded+1c:wght@700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #00ffcc;
            --secondary: #ff00ff;
            --bg: #050505;
            --panel: rgba(255, 255, 255, 0.05);
        }

        body {
            font-family: 'M PLUS Rounded 1c', sans-serif;
            margin: 0;
            background: var(--bg);
            color: white;
            overflow: hidden;
            touch-action: none;
            user-select: none;
        }

        /* „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£ */
        .hidden { display: none !important; }
        .full-screen {
            position: absolute; top: 0; left: 0;
            width: 100vw; height: 100vh;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
        }
        .btn {
            background: linear-gradient(45deg, var(--secondary), #ff4444);
            border: none; color: white;
            padding: 15px 40px; font-size: 1.5rem;
            border-radius: 50px; cursor: pointer;
            font-family: 'Black Ops One', cursive;
            text-transform: uppercase;
            box-shadow: 0 0 15px var(--secondary);
            transition: transform 0.1s;
        }
        .btn:active { transform: scale(0.95); }

        /* --- HOST (PCÁîªÈù¢) „Éá„Ç∂„Ç§„É≥ --- */
        #host-view {
            background: radial-gradient(circle at center, #1a1a1a, #000);
        }
        .header {
            position: absolute; top: 20px; left: 0; width: 100%;
            text-align: center; pointer-events: none;
        }
        h1 {
            font-family: 'Black Ops One', cursive;
            font-size: 4rem; margin: 0;
            background: linear-gradient(to right, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 20px rgba(0, 255, 204, 0.5);
        }
        #timer {
            font-size: 8rem; font-family: 'Black Ops One';
            color: #fff; text-shadow: 0 0 30px #fff;
            margin-top: 10px;
        }
        
        /* „Éó„É¨„Ç§„É§„Éº„É°„Éº„Çø„Éº */
        #arena {
            display: flex; align-items: flex-end; justify-content: center;
            width: 90%; height: 50vh; gap: 20px;
            border-bottom: 4px solid #333;
            padding-bottom: 10px; margin-top: 50px;
        }
        .player-col {
            width: 100px; height: 100%;
            display: flex; flex-direction: column;
            align-items: center; justify-content: flex-end;
            position: relative;
            transition: all 0.3s ease;
        }
        .bar-container {
            width: 100%; height: 100%;
            background: rgba(255,255,255,0.05);
            border-radius: 10px 10px 0 0;
            position: relative; overflow: hidden;
        }
        .bar-fill {
            width: 100%; height: 0%;
            background: linear-gradient(to top, var(--primary), #00aa88);
            position: absolute; bottom: 0;
            transition: height 0.1s linear;
            box-shadow: 0 0 20px var(--primary);
        }
        .p-score {
            font-family: 'Black Ops One'; font-size: 2rem;
            position: absolute; width: 100%; text-align: center;
            top: -40px; z-index: 2;
        }
        .p-name {
            margin-top: 15px; font-weight: bold; font-size: 1.2rem;
            text-align: center; width: 120px;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            text-shadow: 0 0 5px black;
        }
        .winner-crown {
            position: absolute; top: -80px; font-size: 3rem;
            animation: bounce 1s infinite; display: none;
        }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

        /* „É≠„Éì„ÉºÁîªÈù¢ */
        #lobby-info {
            background: rgba(0,0,0,0.8);
            padding: 30px; border-radius: 20px;
            border: 2px solid #333;
            text-align: center;
            backdrop-filter: blur(10px);
        }
        #room-qr { background: white; padding: 10px; border-radius: 10px; display: inline-block; }

        /* --- CLIENT („Çπ„Éû„Éõ) „Éá„Ç∂„Ç§„É≥ --- */
        #client-view {
            background: linear-gradient(135deg, #111 0%, #222 100%);
        }
        .input-group { margin-bottom: 20px; text-align: center; }
        input[type="text"] {
            background: transparent; border: none;
            border-bottom: 2px solid var(--primary);
            color: white; font-size: 2rem; text-align: center;
            width: 80%; padding: 10px; outline: none;
            font-family: 'M PLUS Rounded 1c', sans-serif;
        }
        
        /* „Ç∑„Çß„Ç§„ÇØ„Éú„Çø„É≥ */
        #shake-circle {
            width: 280px; height: 280px;
            border-radius: 50%;
            background: radial-gradient(circle, #ff4444, #990000);
            border: 10px solid rgba(255,255,255,0.2);
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            box-shadow: 0 0 30px #ff0000;
            transition: transform 0.1s;
        }
        .shake-active { transform: scale(0.95); filter: brightness(1.2); }
        #my-score { font-size: 5rem; font-family: 'Black Ops One'; margin: 0; line-height: 1; }
        .shake-text { font-size: 1.5rem; font-weight: bold; opacity: 0.8; }
        
        .status-msg {
            font-size: 1.5rem; margin-bottom: 20px; color: #aaa;
            text-align: center; padding: 0 20px;
        }
    </style>
</head>
<body>

    <!-- ================= HOST VIEW (PC) ================= -->
    <div id="host-view" class="full-screen hidden">
        <div class="header">
            <h1>NEON SHAKE</h1>
            <div id="timer">10</div>
        </div>

        <div id="arena">
            <!-- „Éó„É¨„Ç§„É§„Éº„Åå„Åì„Åì„Å´ËøΩÂä†„Åï„Çå„Åæ„Åô -->
            <div style="color: #666; font-size: 1.5rem; align-self: center;">
                ÂèÇÂä†ËÄÖ„ÇíÂæÖ„Å£„Å¶„ÅÑ„Åæ„Åô...
            </div>
        </div>

        <div id="lobby-info">
            <div id="room-qr"></div>
            <p id="room-id-txt" style="font-size: 1.2rem; color:#aaa; margin: 10px 0;">Room ID: ---</p>
            <button class="btn" onclick="hostStartGame()">BATTLE START</button>
            <p style="font-size:0.9rem; color:#666; margin-top:10px;">„Çπ„Éû„Éõ„ÅßQR„ÇíË™≠„ÅøËæº„Çì„ÅßÂèÇÂä†</p>
        </div>
    </div>

    <!-- ================= CLIENT VIEW (Smartphone) ================= -->
    <div id="client-view" class="full-screen hidden">
        
        <!-- 1. ÂêçÂâçÂÖ•ÂäõÁîªÈù¢ -->
        <div id="step-name" class="full-screen">
            <h2 style="color: var(--primary);">ENTER NAME</h2>
            <div class="input-group">
                <input type="text" id="username-input" placeholder="ÂêçÂâç„ÇíÂÖ•Âäõ" maxlength="6">
            </div>
            <button class="btn" onclick="submitName()">JOIN GAME</button>
        </div>

        <!-- 2. ÂæÖÊ©ü„Éª„Ç≤„Éº„É†ÁîªÈù¢ -->
        <div id="step-game" class="full-screen hidden">
            <div id="client-status" class="status-msg">„Éõ„Çπ„Éà„ÅÆÈñãÂßãÂæÖ„Å°...</div>
            
            <!-- „Ç∑„Çß„Ç§„ÇØ„Ç®„É™„Ç¢ -->
            <div id="shake-circle">
                <div id="my-score">0</div>
                <div class="shake-text">SHAKE!</div>
            </div>
            
            <p style="color:#666; margin-top: 30px; font-size: 0.8rem;">„Çπ„Éû„Éõ„Çí„Åó„Å£„Åã„ÇäÊè°„Å£„Å¶ÊåØ„ÇåÔºÅ</p>
        </div>

        <!-- „Çª„É≥„Çµ„ÉºË®±ÂèØË¶ÅÊ±Ç (iOSÁî®) -->
        <div id="step-perm" class="full-screen hidden" style="background:rgba(0,0,0,0.9); z-index:999;">
            <p class="status-msg">„Ç≤„Éº„É†„ÇíÂßã„ÇÅ„Çã„Å´„ÅØ<br>„Çª„É≥„Çµ„Éº„ÅÆË®±ÂèØ„ÅåÂøÖË¶Å„Åß„Åô</p>
            <button class="btn" onclick="requestSensor()">OK</button>
        </div>
    </div>

    <!-- Firebase Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
        import { getDatabase, ref, set, onValue, update, remove, onDisconnect } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

        // „ÅÇ„Å™„Åü„ÅÆFirebaseË®≠ÂÆö (API„Ç≠„ÉºÁ≠â„ÅØ„Åù„ÅÆ„Åæ„ÅæÂà©Áî®)
        const firebaseConfig = {
            apiKey: "AIzaSyDbZzTMvUkG2LXIGY4ux0KBTmnAdqP236s",
            authDomain: "game-4f2d9.firebaseapp.com",
            databaseURL: "https://game-4f2d9-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "game-4f2d9",
            storageBucket: "game-4f2d9.firebasestorage.app",
            messagingSenderId: "574316347824",
            appId: "1:574316347824:web:cf686040628e25ad615675",
            measurementId: "G-T0ZKQCC9L3"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // URL„Éë„É©„É°„Éº„ÇøÂá¶ÁêÜ
        const params = new URLSearchParams(window.location.search);
        let role = params.get('role');
        let roomId = params.get('room');

        // Ëâ≤ÂÆöÁæ© („Éó„É¨„Ç§„É§„Éº„Åî„Å®„ÅÆËâ≤)
        const COLORS = ['#FF0055', '#00FFCC', '#CCFF00', '#0099FF', '#FFAA00', '#AA00FF'];
        const getPlayerColor = (index) => COLORS[index % COLORS.length];

        // ==========================================
        // HOST LOGIC (PC)
        // ==========================================
        if (!role || role === 'host') {
            // RoomID„Åå„Å™„Åë„Çå„Å∞ÁîüÊàê„Åó„Å¶„É™„É≠„Éº„Éâ
            if (!roomId) {
                roomId = Math.random().toString(36).substring(2, 6).toUpperCase();
                window.location.replace(`?role=host&room=${roomId}`);
            }

            document.getElementById('host-view').classList.remove('hidden');
            document.getElementById('room-id-txt').innerText = `Room ID: ${roomId}`;
            
            // QR„Ç≥„Éº„ÉâÁîüÊàê
            const joinUrl = `${window.location.origin}${window.location.pathname}?role=player&room=${roomId}`;
            new QRCode(document.getElementById("room-qr"), { text: joinUrl, width: 128, height: 128 });

            const roomRef = ref(db, `shake/${roomId}`);
            let gameState = 'lobby'; 

            // „Éó„É¨„Ç§„É§„ÉºÁõ£Ë¶ñ
            onValue(roomRef, (snapshot) => {
                const data = snapshot.val() || {};
                const players = data.players || {};
                renderHostArena(players);
            });

            // „É°„Éº„Çø„ÉºÊèèÁîªÈñ¢Êï∞
            function renderHostArena(players) {
                const arena = document.getElementById('arena');
                // ÂæÖÊ©ü„É°„ÉÉ„Çª„Éº„Ç∏„ÅÆÂà∂Âæ°
                if (Object.keys(players).length > 0) {
                    if(arena.innerText.includes('ÂæÖÊ©ü‰∏≠')) arena.innerHTML = '';
                } else {
                    arena.innerHTML = '<div style="color: #666; font-size: 1.5rem; align-self: center;">ÂèÇÂä†ËÄÖ„ÇíÂæÖ„Å£„Å¶„ÅÑ„Åæ„Åô...</div>';
                    return;
                }

                // Êó¢Â≠ò„ÅÆË¶ÅÁ¥†„ÇíÁ¢∫Ë™ç„ÉªÂâäÈô§
                const existingIds = Array.from(arena.children).map(el => el.id.replace('p-', ''));
                const currentIds = Object.keys(players);

                // „ÅÑ„Å™„Åè„Å™„Å£„Åü‰∫∫„ÇíÂâäÈô§
                existingIds.forEach(id => {
                    if (!currentIds.includes(id)) document.getElementById(`p-${id}`).remove();
                });

                // „Éó„É¨„Ç§„É§„ÉºÊèèÁîªÊõ¥Êñ∞
                let index = 0;
                currentIds.forEach(id => {
                    const p = players[id];
                    let el = document.getElementById(`p-${id}`);
                    const color = getPlayerColor(index);
                    
                    if (!el) {
                        el = document.createElement('div');
                        el.id = `p-${id}`;
                        el.className = 'player-col';
                        el.innerHTML = `
                            <div class="winner-crown">üëë</div>
                            <div class="p-score" style="color:${color}">0</div>
                            <div class="bar-container">
                                <div class="bar-fill" style="background:${color}; box-shadow: 0 0 15px ${color}"></div>
                            </div>
                            <div class="p-name" style="color:${color}">${p.name}</div>
                        `;
                        arena.appendChild(el);
                    }

                    // ÂÄ§„ÅÆÂèçÊò†
                    const score = p.count || 0;
                    // ÊúÄÂ§ßÂÄ§„Çí100ÂõûÁ®ãÂ∫¶„Å®‰ªÆÂÆö„Åó„Å¶È´ò„Åï„ÇíË®àÁÆó(„Ç≤„Éº„É†„Éê„É©„É≥„ÇπË™øÊï¥)
                    const height = Math.min(score * 1.5, 100); 

                    el.querySelector('.p-score').innerText = score;
                    el.querySelector('.bar-fill').style.height = `${height}%`;
                    
                    // ÂãùËÄÖË°®Á§∫
                    if (p.isWinner) el.querySelector('.winner-crown').style.display = 'block';
                    else el.querySelector('.winner-crown').style.display = 'none';

                    index++;
                });
            }

            // „Ç≤„Éº„É†ÈñãÂßã„Éú„Çø„É≥
            window.hostStartGame = () => {
                const arena = document.getElementById('arena');
                if (arena.children.length === 0 || arena.innerText.includes('ÂæÖÊ©ü‰∏≠')) {
                    return alert("„Éó„É¨„Ç§„É§„Éº„Åå„ÅÑ„Åæ„Åõ„Çì");
                }

                // „É≠„Éì„ÉºUI„ÇíÈö†„Åô
                document.getElementById('lobby-info').classList.add('hidden');
                
                // Áä∂ÊÖã„É™„Çª„ÉÉ„Éà
                update(roomRef, { 
                    'state/status': 'ready',
                    'state/startTime': Date.now() 
                });
                
                // „Çπ„Ç≥„Ç¢„É™„Çª„ÉÉ„Éà
                getDatabase(app); // Re-ref just in case
                onValue(ref(db, `shake/${roomId}/players`), (snap) => {
                    const players = snap.val();
                    if(players) {
                        const updates = {};
                        Object.keys(players).forEach(pid => {
                            updates[`players/${pid}/count`] = 0;
                            updates[`players/${pid}/isWinner`] = false;
                        });
                        update(roomRef, updates);
                    }
                }, { onlyOnce: true });

                // „Ç´„Ç¶„É≥„Éà„ÉÄ„Ç¶„É≥ 3Áßí
                let cd = 3;
                const timerEl = document.getElementById('timer');
                timerEl.innerText = "READY";
                
                const cdInterval = setInterval(() => {
                    timerEl.innerText = cd;
                    if (cd === 0) {
                        clearInterval(cdInterval);
                        timerEl.innerText = "GO!!";
                        runGameLoop();
                    }
                    cd--;
                }, 1000);
            };

            // „Ç≤„Éº„É†„É´„Éº„Éó (10ÁßíÈñì)
            function runGameLoop() {
                update(roomRef, { 'state/status': 'running' });
                
                let timeLeft = 10;
                const timerEl = document.getElementById('timer');
                
                const gameInterval = setInterval(() => {
                    timeLeft--;
                    timerEl.innerText = timeLeft;

                    if (timeLeft <= 0) {
                        clearInterval(gameInterval);
                        finishGame();
                    }
                }, 1000);
            }

            // ÁµêÊûúÁô∫Ë°®
            function finishGame() {
                update(roomRef, { 'state/status': 'finished' });
                document.getElementById('timer').innerText = "FINISH";

                // ÂãùËÄÖÂà§ÂÆö
                onValue(ref(db, `shake/${roomId}/players`), (snap) => {
                    const players = snap.val();
                    if (!players) return;

                    let maxScore = -1;
                    let winnerId = null;

                    Object.keys(players).forEach(id => {
                        if (players[id].count > maxScore) {
                            maxScore = players[id].count;
                            winnerId = id;
                        }
                    });

                    if (winnerId) {
                        update(ref(db, `shake/${roomId}/players/${winnerId}`), { isWinner: true });
                    }

                    // 5ÁßíÂæå„Å´„É≠„Éì„Éº„Éú„Çø„É≥ÂÜçË°®Á§∫
                    setTimeout(() => {
                        document.getElementById('lobby-info').classList.remove('hidden');
                    }, 5000);

                }, { onlyOnce: true });
            }
        }

        // ==========================================
        // PLAYER LOGIC (Mobile)
        // ==========================================
        else if (role === 'player') {
            document.getElementById('client-view').classList.remove('hidden');
            const myId = Math.random().toString(36).substr(2, 8);
            let myName = "";
            let myCount = 0;
            let canShake = false;

            const playerRef = ref(db, `shake/${roomId}/players/${myId}`);
            const stateRef = ref(db, `shake/${roomId}/state`);

            // ÂêçÂâçÈÄÅ‰ø°
            window.submitName = () => {
                const input = document.getElementById('username-input');
                if (!input.value) return alert("ÂêçÂâç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ");
                
                myName = input.value;
                document.getElementById('step-name').classList.add('hidden');
                
                // iOSÁî®„Çª„É≥„Çµ„ÉºË®±ÂèØ„Éï„É≠„Éº„Å∏
                if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
                    document.getElementById('step-perm').classList.remove('hidden');
                } else {
                    // AndroidÁ≠â„ÅØ„Åù„ÅÆ„Åæ„Åæ
                    joinRoom();
                }
            };

            // „Çª„É≥„Çµ„ÉºË®±ÂèØ (iOS)
            window.requestSensor = async () => {
                try {
                    const res = await DeviceMotionEvent.requestPermission();
                    if (res === 'granted') {
                        document.getElementById('step-perm').classList.add('hidden');
                        joinRoom();
                    } else {
                        alert("„Çª„É≥„Çµ„ÉºÊ®©Èôê„ÅåÂøÖË¶Å„Åß„Åô");
                    }
                } catch (e) {
                    console.error(e);
                    // PC„Éá„Éê„ÉÉ„Ç∞Á≠â„ÅÆ„Åü„ÇÅ„ÅÆ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
                    document.getElementById('step-perm').classList.add('hidden');
                    joinRoom();
                }
            };

            function joinRoom() {
                document.getElementById('step-game').classList.remove('hidden');
                
                // Êé•Á∂öÊôÇ„Å´Firebase„Å∏ÁôªÈå≤
                set(playerRef, { name: myName, count: 0 });
                onDisconnect(playerRef).remove();

                // Áä∂ÊÖãÁõ£Ë¶ñ
                onValue(stateRef, (snap) => {
                    const state = snap.val();
                    if (!state) return;
                    
                    const statusEl = document.getElementById('client-status');
                    const scoreEl = document.getElementById('my-score');
                    const circle = document.getElementById('shake-circle');

                    if (state.status === 'ready') {
                        statusEl.innerText = "„Åæ„ÇÇ„Å™„ÅèÈñãÂßãÔºÅ";
                        statusEl.style.color = "#ffeb3b";
                        myCount = 0;
                        scoreEl.innerText = "0";
                        canShake = false;
                    } 
                    else if (state.status === 'running') {
                        statusEl.innerText = "ÊåØ„Çå„Åá„Åá„ÅáÔºÅÔºÅÔºÅ";
                        statusEl.style.color = "#ff4444";
                        canShake = true;
                        // „Éê„Ç§„Éñ„É¨„Éº„Ç∑„Éß„É≥ÈñãÂßãÂêàÂõ≥
                        if(navigator.vibrate) navigator.vibrate(200);
                    } 
                    else if (state.status === 'finished') {
                        statusEl.innerText = "ÁµÇ‰∫ÜÔºÅÁîªÈù¢„ÇíË¶ã„Çç";
                        statusEl.style.color = "#fff";
                        canShake = false;
                        if(navigator.vibrate) navigator.vibrate([100, 50, 100]);
                    } 
                    else {
                        statusEl.innerText = "„Éõ„Çπ„Éà„ÅÆÈñãÂßãÂæÖ„Å°...";
                        statusEl.style.color = "#aaa";
                        canShake = false;
                    }
                });

                startSensor();
            }

            function startSensor() {
                let lastX=0, lastY=0, lastZ=0;
                let lastUpdate = 0;
                const THRESHOLD = 15; // ÊÑüÂ∫¶Ë™øÊï¥

                window.addEventListener('devicemotion', (e) => {
                    if (!canShake) return;

                    const acc = e.accelerationIncludingGravity || e.acceleration;
                    if (!acc) return;

                    const delta = Math.abs(acc.x - lastX) + Math.abs(acc.y - lastY) + Math.abs(acc.z - lastZ);

                    if (delta > THRESHOLD) {
                        myCount++;
                        document.getElementById('my-score').innerText = myCount;
                        
                        // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
                        const circle = document.getElementById('shake-circle');
                        circle.classList.add('shake-active');
                        setTimeout(() => circle.classList.remove('shake-active'), 50);

                        // ÈÄö‰ø°È†ªÂ∫¶Âà∂Èôê (100ms„Å´1ÂõûÈÄÅ‰ø°)
                        const now = Date.now();
                        if (now - lastUpdate > 100) {
                            update(playerRef, { count: myCount });
                            lastUpdate = now;
                        }
                    }

                    lastX = acc.x; lastY = acc.y; lastZ = acc.z;
                });
            }
        }
    </script>
</body>
</html>
