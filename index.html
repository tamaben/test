<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>止まらないサーバー（Firebase HA構成）</title>
    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 600px; margin: 0 auto; }
        .status-box { padding: 10px; border-radius: 5px; margin-bottom: 20px; font-weight: bold; }
        .online { background-color: #d4edda; color: #155724; }
        .offline { background-color: #f8d7da; color: #721c24; }
        input, button { padding: 10px; font-size: 16px; }
        ul { list-style-type: none; padding: 0; }
        li { background: #f9f9f9; border-bottom: 1px solid #ddd; padding: 10px; }
    </style>
</head>
<body>

    <h1>Firebase 高可用性デモ</h1>

    <div id="status" class="status-box online">接続状態: 初期化中...</div>

    <div>
        <input type="text" id="messageInput" placeholder="メッセージを入力">
        <button id="sendBtn">送信（保存）</button>
    </div>

    <h3>メッセージリスト (リアルタイム同期)</h3>
    <ul id="messageList"></ul>

    <script type="module">
        // 必要な機能をインポート
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            onSnapshot, 
            enableIndexedDbPersistence,
            serverTimestamp 
        } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // ▼▼▼ ここにご自身のFirebase設定を貼り付けてください ▼▼▼
        const firebaseConfig = {
            apiKey: "AIzaSy...",
            authDomain: "your-project.firebaseapp.com",
            projectId: "your-project",
            storageBucket: "your-project.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abcdef"
        };
        // ▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲

        // アプリとデータベースの初期化
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // 【最重要】オフラインでも止まらないようにする設定
        enableIndexedDbPersistence(db)
            .catch((err) => {
                if (err.code == 'failed-precondition') {
                    console.error('複数のタブで開かれています。オフラインモードは1つのタブでのみ有効です。');
                } else if (err.code == 'unimplemented') {
                    console.error('このブラウザはオフラインモードをサポートしていません。');
                }
            });

        // HTML要素の取得
        const statusDiv = document.getElementById('status');
        const input = document.getElementById('messageInput');
        const btn = document.getElementById('sendBtn');
        const list = document.getElementById('messageList');

        // データの送信処理
        btn.addEventListener('click', async () => {
            if(input.value === "") return;
            try {
                // Firestoreにデータを追加
                await addDoc(collection(db, "messages"), {
                    text: input.value,
                    timestamp: serverTimestamp() // サーバー時間を記録
                });
                input.value = ""; // 入力欄をクリア
            } catch (e) {
                console.error("エラーが発生しました: ", e);
                alert("送信エラー（コンソールを確認してください）");
            }
        });

        // データのリアルタイム受信（ここが切断検知も兼ねる）
        onSnapshot(collection(db, "messages"), (snapshot) => {
            // 接続状態の判定
            const source = snapshot.metadata.fromCache ? "ローカルキャッシュ" : "サーバー";
            
            if (snapshot.metadata.fromCache) {
                statusDiv.textContent = "⚠ オフライン (キャッシュで動作中・送信データは復帰時に同期されます)";
                statusDiv.className = "status-box offline";
            } else {
                statusDiv.textContent = "● オンライン (サーバーと同期中)";
                statusDiv.className = "status-box online";
            }

            // リストの描画更新
            list.innerHTML = "";
            snapshot.forEach((doc) => {
                const li = document.createElement("li");
                li.textContent = `${doc.data().text} (${source})`;
                list.appendChild(li);
            });
        });
    </script>
</body>
</html>
