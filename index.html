<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>50 GAMES BATTLE</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Black+Ops+One&family=Kosugi+Maru&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #111;
            --main: #00ffcc; /* Cyan */
            --sub: #ff0099;  /* Pink */
            --warn: #ffcc00; /* Yellow */
            --txt: #fff;
        }
        * { box-sizing: border-box; touch-action: none; user-select: none; -webkit-user-select: none; }
        body { margin: 0; background: var(--bg); color: var(--txt); font-family: 'Kosugi Maru', sans-serif; overflow: hidden; height: 100vh; }

        /* SCREENS */
        .screen { position: fixed; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; background: var(--bg); transition: 0.3s; z-index: 10; }
        .hidden { opacity: 0; pointer-events: none; z-index: -1; transform: scale(0.9); }

        /* TYPOGRAPHY */
        h1 { font-family: 'Black Ops One', cursive; color: var(--main); font-size: 3rem; margin: 0; text-shadow: 0 0 10px var(--main); text-align: center; }
        h2 { color: var(--sub); font-size: 1.5rem; margin: 10px; }
        .big-txt { font-size: 4rem; font-weight: bold; font-family: 'Black Ops One'; }
        
        /* UI ELEMENTS */
        .btn {
            background: rgba(255,255,255,0.1); border: 2px solid var(--main); color: var(--main);
            padding: 15px 30px; font-size: 1.2rem; border-radius: 30px; margin: 10px; cursor: pointer;
            transition: 0.1s; width: 80%; max-width: 300px; font-weight: bold;
        }
        .btn:active { background: var(--main); color: #000; transform: scale(0.95); }
        .btn-p { border-color: var(--sub); color: var(--sub); }
        .btn-p:active { background: var(--sub); }

        /* GAME LIST (GRID) */
        #list-container {
            width: 95%; height: 60vh; overflow-y: scroll; display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 8px; padding: 10px;
            background: #222; border-radius: 10px; border: 1px solid #444;
        }
        .g-card {
            background: #333; padding: 10px; border-radius: 5px; cursor: pointer; border: 1px solid #555;
            display: flex; flex-direction: column; align-items: center; text-align: center;
        }
        .g-card:active { background: var(--main); color: #000; }
        .g-icon { font-size: 2rem; margin-bottom: 5px; }
        .g-name { font-size: 0.8rem; font-weight: bold; line-height: 1.2; }
        .g-type { font-size: 0.6rem; color: #aaa; margin-top: 2px; }

        /* GAME UI */
        .bar-wrap { position: fixed; top: 0; left: 0; width: 100%; height: 10px; background: #333; }
        .bar-fill { height: 100%; background: var(--warn); width: 100%; transition: width 0.1s linear; }
        
        /* CONTROLLER */
        .c-area { width: 100%; height: 100%; display: flex; flex-direction: column; }
        .c-btn { flex: 1; border: none; font-size: 2rem; font-weight: bold; color: white; display: flex; align-items: center; justify-content: center; margin: 2px; border-radius: 10px; }
        .bg-r { background: #ff4757; } .bg-b { background: #1e90ff; } .bg-g { background: #2ed573; } .bg-y { background: #ffa502; }
        
        input { font-size: 1.5rem; text-align: center; padding: 10px; margin: 10px; width: 70%; background: #333; color: white; border: none; border-radius: 5px; }
    </style>
</head>
<body>

<div id="s-title" class="screen">
    <h1>50 GAMES<br>BATTLE</h1>
    <p>È†≠ËÑ≥„Å®‰ΩìÂäõ„ÅÆÈôêÁïå„Å´Êåë„ÇÅ</p>
    <button class="btn" onclick="App.host()">üëë ÈÉ®Â±ã„Çí‰Ωú„Çã (HOST)</button>
    <button class="btn btn-p" onclick="App.client()">üì± ÂèÇÂä†„Åô„Çã (PLAYER)</button>
</div>

<div id="s-h-lobby" class="screen hidden">
    <h2>ROOM ID</h2>
    <h1 id="dsp-id" style="font-size: 5rem; letter-spacing: 5px;">----</h1>
    <div id="qrcode" style="background: white; padding: 10px; border-radius: 10px; margin: 10px;"></div>
    <p>ÂèÇÂä†‰∫∫Êï∞: <span id="p-count" style="font-size: 2rem; color: var(--main)">0</span></p>
    <button class="btn" onclick="Host.menu()">„Ç≤„Éº„É†ÈÅ∏Êäû„Å∏</button>
</div>

<div id="s-h-menu" class="screen hidden">
    <h2>SELECT GAME</h2>
    <div id="list-container"></div>
</div>

<div id="s-h-play" class="screen hidden">
    <div class="bar-wrap"><div id="bar" class="bar-fill"></div></div>
    <div style="margin-top: 40px; color: #888;">CURRENT GAME</div>
    <h2 id="g-title" style="font-size: 2.5rem; color: white;">TITLE</h2>
    <div id="g-timer" class="big-txt" style="color: var(--warn)">READY</div>
    <div id="g-rank" style="width: 90%; text-align: center; font-size: 1.5rem; margin-top: 20px;"></div>
</div>

<div id="s-h-res" class="screen hidden">
    <h1 style="color: var(--warn)">WINNER</h1>
    <div id="res-name" class="big-txt" style="margin: 20px 0;">???</div>
    <div id="res-score" style="font-size: 2rem;">0 PTS</div>
    <button class="btn" onclick="Host.menu()">„É°„Éã„É•„Éº„Å∏</button>
</div>

<div id="s-c-login" class="screen hidden">
    <h2>ENTER ID</h2>
    <input type="text" id="inp-id" placeholder="ROOM ID" maxlength="4" style="text-transform: uppercase;">
    <input type="text" id="inp-name" placeholder="NAME" maxlength="8">
    <button class="btn btn-p" onclick="Client.join()">JOIN</button>
</div>

<div id="s-c-perm" class="screen hidden">
    <h2>SENSOR SETUP</h2>
    <p>„Çπ„Éû„Éõ„ÅÆ„Çª„É≥„Çµ„Éº„Çí‰Ωø„ÅÑ„Åæ„Åô</p>
    <div style="font-size: 3rem;">üì±üîÑ</div>
    <button class="btn" onclick="Client.perm()">Ë®±ÂèØ„Åó„Å¶„Çπ„Çø„Éº„Éà</button>
</div>

<div id="s-c-wait" class="screen hidden">
    <h2 class="big-txt" style="animation: pulse 1s infinite">WAITING</h2>
    <p>„Éõ„Çπ„Éà„Åå„Ç≤„Éº„É†„ÇíÈÅ∏„Çì„Åß„ÅÑ„Åæ„Åô</p>
</div>

<div id="s-c-ctrl" class="screen hidden">
    <div id="c-board" class="c-area"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getDatabase, ref, set, onValue, update, onDisconnect, remove } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

const firebaseConfig = {
    apiKey: "AIzaSyDbZzTMvUkG2LXIGY4ux0KBTmnAdqP236s",
    authDomain: "game-4f2d9.firebaseapp.com",
    databaseURL: "https://game-4f2d9-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "game-4f2d9",
    storageBucket: "game-4f2d9.firebasestorage.app",
    messagingSenderId: "574316347824",
    appId: "1:574316347824:web:cf686040628e25ad615675",
    measurementId: "G-T0ZKQCC9L3"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// --- 50 GAMES DATA ---
// Types: tap(ÈÄ£Êâì), shake(ÊåØ„Çã), squat(„Çπ„ÇØ„ÉØ„ÉÉ„Éà), balance(„Éê„É©„É≥„Çπ), quiz(„ÇØ„Ç§„Ç∫/ËÑ≥„Éà„É¨), spin(ÂõûËª¢)
const GAMES = [
    // --- BASIC TAP (1-8) ---
    { i:1, n:"ÈÄ£Êâì„Çπ„Éó„É™„É≥„Éà", t:"tap", time:5, desc:"5ÁßíÈñì„ÅßÈôêÁïå„Åæ„ÅßÈÄ£Êâì„Åõ„ÇàÔºÅ", icon:"üî•" },
    { i:2, n:"ÈÄ£Êâì„Éû„É©„ÇΩ„É≥", t:"tap", time:20, desc:"20ÁßíÈñì„Éö„Éº„Çπ„ÇíÁ∂≠ÊåÅ„Åó„ÇçÔºÅ", icon:"üèÉ" },
    { i:3, n:"Ë∂ÖÈ´òÈÄü3Áßí", t:"tap", time:3, desc:"‰∏ÄÁû¨„ÅÆÁàÜÁô∫ÂäõÂãùË≤†ÔºÅ", icon:"‚ö°" },
    { i:4, n:"„Çµ„Éê„Ç§„Éê„É´ÈÄ£Êâì", t:"tap", time:15, desc:"Êåá„ÅåÂ£ä„Çå„Çã„Åæ„ÅßÂè©„ÅëÔºÅ", icon:"‚ò†Ô∏è" },
    { i:5, n:"„É™„Ç∫„É†„Çø„ÉÉ„Éó", t:"tap", time:10, desc:"‰∏ÄÂÆö„ÅÆ„É™„Ç∫„É†„ÅßÂè©„Åë(ËÑ≥ÂÜÖ)", icon:"ü•Å" },
    { i:6, n:"ÁâáÊâãÈÄ£ÊâìÁéã", t:"tap", time:10, desc:"ÁâáÊâã„Å†„Åë„ÅßÈÄ£Êâì„Åó„ÇçÔºÅ", icon:"‚úã" },
    { i:7, n:"‰∏°Êâã‰π±Ëàû", t:"tap", time:8, desc:"‰∏°Êåá„Çí‰Ωø„Å£„Å¶ÈÄ£ÊâìÔºÅ", icon:"üëê" },
    { i:8, n:"„É©„Çπ„Éà„Çπ„Éë„Éº„Éà", t:"tap", time:12, desc:"ÂæåÂçä„Å´Êú¨Ê∞ó„ÇíÂá∫„ÅõÔºÅ", icon:"üèÅ" },

    // --- BODY SHAKE (9-16) ---
    { i:9, n:"„Éó„É≠„ÉÜ„Ç§„É≥„Ç∑„Çß„Ç§„ÇØ", t:"shake", time:10, desc:"„Éê„Éº„ÉÜ„É≥„ÉÄ„Éº„ÅÆ„Çà„ÅÜ„Å´ÊåØ„ÇåÔºÅ", icon:"üç∏" },
    { i:10, n:"ÂÖ®Âäõ„Éï„É™„Éï„É™", t:"shake", time:5, desc:"„Çπ„Éû„Éõ„ÅåÈ£õ„Å∂Âã¢„ÅÑ„ÅßÊåØ„ÇåÔºÅ", icon:"üëã" },
    { i:11, n:"Ê®™ÊåØ„Çä„ÉÄ„É≥„Çπ", t:"shake", time:10, desc:"Ê®™ÊñπÂêë„Å´ÊåØ„Çä„Åæ„Åè„ÇåÔºÅ", icon:"üíÉ" },
    { i:12, n:"Á∏¶ÊåØ„Çä„Éè„É≥„Éû„Éº", t:"shake", time:10, desc:"Á∏¶ÊñπÂêë„Å´Âè©„Åç„Å§„Åë„ÇçÔºÅ", icon:"üî®" },
    { i:13, n:"ËÄê‰πÖ„Ç∑„Çß„Ç§„ÇØ", t:"shake", time:20, desc:"20ÁßíÈñìÊåØ„ÇäÁ∂ö„Åë„Çâ„Çå„Çã„ÅãÔºü", icon:"ü•µ" },
    { i:14, n:"ÂÑ™„Åó„Åè„Ç∑„Çß„Ç§„ÇØ", t:"shake", time:10, desc:"Â£ä„Åï„Å™„ÅÑ„Çà„ÅÜ„Å´ÈÄü„ÅèÊåØ„Çå", icon:"üçº" },
    { i:15, n:"Â∑¶Êâã„Ç∑„Çß„Ç§„ÇØ", t:"shake", time:8, desc:"Â∑¶Êâã„Å†„Åë„ÅßÊåØ„ÇåÔºÅ", icon:"üëà" },
    { i:16, n:"Âè≥Êâã„Ç∑„Çß„Ç§„ÇØ", t:"shake", time:8, desc:"Âè≥Êâã„Å†„Åë„ÅßÊåØ„ÇåÔºÅ", icon:"üëâ" },

    // --- BODY MOVEMENT (17-24) ---
    { i:17, n:"„Çπ„ÇØ„ÉØ„ÉÉ„ÉàÁéã", t:"squat", time:15, desc:"„Çπ„Éû„Éõ„ÇíÊåÅ„Å£„Å¶„Åó„ÇÉ„Åå„Çì„ÅßÁ´ã„Å¶ÔºÅ", icon:"üèãÔ∏è" },
    { i:18, n:"È´òÈÄü„Çπ„ÇØ„ÉØ„ÉÉ„Éà", t:"squat", time:10, desc:"ÊµÖ„ÅèÈÄü„Åè„Çπ„ÇØ„ÉØ„ÉÉ„ÉàÔºÅ", icon:"ü¶µ" },
    { i:19, n:"Âú∞ÁçÑ„ÅÆËÑö„Éà„É¨", t:"squat", time:20, desc:"Â§™„ÇÇ„ÇÇ„Çí„ÅÑ„Åò„ÇÅÊäú„ÅëÔºÅ", icon:"üë∫" },
    { i:20, n:"„Çπ„Éî„É≥„Éª„Éû„Çπ„Çø„Éº", t:"spin", time:15, desc:"„Åù„ÅÆÂ†¥„ÅßÂõûËª¢„Åó„ÇçÔºÅ(Âë®„ÇäÊ≥®ÊÑè)", icon:"üå™Ô∏è" },
    { i:21, n:"Â∑¶Âõû„Çä„Çπ„Éî„É≥", t:"spin", time:10, desc:"ÂèçÊôÇË®àÂõû„Çä„Å´Âõû„ÇåÔºÅ", icon:"üîÑ" },
    { i:22, n:"„Éê„É©„É≥„ÇπÁ¶Ö", t:"balance", time:15, desc:"„Çπ„Éû„Éõ„ÇíÊ∞¥Âπ≥„Å´‰øù„Å¶ÔºÅÂãï„Åè„Å™ÔºÅ", icon:"üßò" },
    { i:23, n:"„Éê„É©„É≥„Çπ„Éª„Éá„Çπ", t:"balance", time:30, desc:"30ÁßíÈñì„ÄÅÁµ∂ÂØæ„Å´ÂÇæ„Åë„Çã„Å™ÔºÅ", icon:"‚ö∞Ô∏è" },
    { i:24, n:"„Ç∏„É£„É≥„Éó(ÊåØÂãï)", t:"shake", time:10, desc:"„Éù„Ç±„ÉÉ„Éà„Å´ÂÖ•„Çå„Å¶„Ç∏„É£„É≥„ÉóÔºÅ", icon:"üêá" },

    // --- BRAIN QUIZ (25-35) ---
    { i:25, n:"ÊöóÁÆó„Éê„Éà„É´", t:"math", time:20, desc:"Ë®àÁÆóÂºè„ÅÆÁ≠î„Åà„ÇíÈÅ∏„ÅπÔºÅ", icon:"üßÆ" },
    { i:26, n:"ÊöóÁÆó„Çπ„Éî„Éº„Éâ", t:"math", time:10, desc:"Á∞°Âçò„Å™Ë®àÁÆó„ÇíÈ´òÈÄü„ÅßÔºÅ", icon:"üöÄ" },
    { i:27, n:"ÂèçÂ∞Ñ„Ç´„É©„Éº", t:"color", time:15, desc:"ÊñáÂ≠ó„ÅÆËâ≤„Å®Âêå„Åò„Éú„Çø„É≥„ÇíÊäº„ÅõÔºÅ", icon:"üé®" },
    { i:28, n:"ÈÄÜÂèçÂ∞Ñ„Ç´„É©„Éº", t:"color", time:15, desc:"ÊñáÂ≠ó„ÅÆÊÑèÂë≥„Å®Âêå„Åò„Éú„Çø„É≥„ÇíÊäº„ÅõÔºÅ", icon:"üß†" },
    { i:29, n:"ÊúÄÂ§ßÊï∞ÈÅ∏„Å≥", t:"num", time:15, desc:"‰∏ÄÁï™Â§ß„Åç„ÅÑÊï∞Â≠ó„ÇíÈÅ∏„ÅπÔºÅ", icon:"üî¢" },
    { i:30, n:"ÊúÄÂ∞èÊï∞ÈÅ∏„Å≥", t:"num", time:15, desc:"‰∏ÄÁï™Â∞è„Åï„ÅÑÊï∞Â≠ó„ÇíÈÅ∏„ÅπÔºÅ", icon:"üêú" },
    { i:31, n:"Â•áÊï∞„Å†„ÅëÊäº„Åõ", t:"odd", time:15, desc:"Â•áÊï∞(1,3,5..)„Å™„ÇâÊäº„ÅõÔºÅ", icon:"1Ô∏è‚É£" },
    { i:32, n:"ÂÅ∂Êï∞„Å†„ÅëÊäº„Åõ", t:"even", time:15, desc:"ÂÅ∂Êï∞(2,4,6..)„Å™„ÇâÊäº„ÅõÔºÅ", icon:"2Ô∏è‚É£" },
    { i:33, n:"ÈÅã„Ç≤„ÉºAorB", t:"luck", time:10, desc:"Ê≠£Ëß£„ÅØ„É©„É≥„ÉÄ„É†„ÄÇÂãò„ÅßÊäº„ÅõÔºÅ", icon:"üé∞" },
    { i:34, n:"4ÊäûÈÅãË©¶„Åó", t:"luck4", time:10, desc:"4„Å§„ÅÆ‰∏≠„Åã„Çâ„Ç¢„Çø„É™„ÇíÂºï„ÅëÔºÅ", icon:"üçÄ" },
    { i:35, n:"Êó©Êäº„ÅóÂèçÂ∞Ñ", t:"react", time:10, desc:"„ÄåGO„Äç„ÅåÂá∫„Åü„Çâ„Åô„ÅêÊäº„ÅõÔºÅ", icon:"üî´" },

    // --- VARIETY & MIX (36-50) ---
    { i:36, n:"ÈÄ£ÊâìLv.MAX", t:"tap", time:30, desc:"30ÁßíÈñì„ÅÆÂú∞ÁçÑÈÄ£Êâì", icon:"üëø" },
    { i:37, n:"„Ç∑„Çß„Ç§„ÇØLv.MAX", t:"shake", time:30, desc:"ËÖï„ÅåÂçÉÂàá„Çå„Çã„Åæ„ÅßÊåØ„Çå", icon:"ü¶æ" },
    { i:38, n:"„Çπ„ÇØ„ÉØ„ÉÉ„ÉàLv.MAX", t:"squat", time:30, desc:"ÊòéÊó•„ÅØÁ≠ãËÇâÁóõÁ¢∫ÂÆö", icon:"üöë" },
    { i:39, n:"„Éà„É™„ÉÉ„Ç≠„ÉºË®àÁÆó", t:"math", time:25, desc:"3„Å§„ÅÆÊï∞Â≠ó„ÅÆË®àÁÆó", icon:"üéì" },
    { i:40, n:"Ëâ≤„Å®ÊñáÂ≠ó„ÅÆÁΩ†", t:"color", time:20, desc:"È®ô„Åï„Çå„Åö„Å´Ê≠£Ëß£„ÇíÈÅ∏„Åπ", icon:"üåà" },
    { i:41, n:"„Çπ„É≠„ÉºÈÄ£Êâì", t:"tap", time:10, desc:"„ÇÜ„Å£„Åè„ÇäÁ¢∫ÂÆü„Å´Êäº„Åõ", icon:"üê¢" },
    { i:42, n:"Ë∂Ö„ÉªÈÅãË©¶„Åó", t:"luck", time:5, desc:"‰∏ÄÁô∫ÂãùË≤†ÔºÅ", icon:"üé≤" },
    { i:43, n:"„Åê„Çã„Åê„Çã„Éê„ÉÉ„Éà", t:"spin", time:20, desc:"ÁõÆ„ÅåÂõû„Çã„Åæ„ÅßÂõû„Çå", icon:"üòµ" },
    { i:44, n:"ÂæÆÂãï„Å†„Å´„Åô„Çã„Å™", t:"balance", time:10, desc:"Â∞ë„Åó„Åß„ÇÇÊè∫„Çå„Åü„ÇâÊ∏õÁÇπ", icon:"üóø" },
    { i:45, n:"„ÇØ„É¨„Ç§„Ç∏„Éº„Ç∑„Çß„Ç§„ÇØ", t:"shake", time:12, desc:"‰∏ä‰∏ãÂ∑¶Âè≥„É©„É≥„ÉÄ„É†„Å´ÊåØ„Çå", icon:"ü§™" },
    { i:46, n:"„Éú„Çø„É≥Êé¢„Åó", t:"react", time:15, desc:"ÂÖâ„Å£„Åü„Éú„Çø„É≥„ÇíÊäº„Åõ", icon:"üí°" },
    { i:47, n:"Ë®òÊÜ∂„Çø„ÉÉ„Éó", t:"mem", time:15, desc:"ÊåáÂÆö„Åï„Çå„ÅüËâ≤„ÇíË¶ö„Åà„ÇçÔºà‰ªÆÔºâ", icon:"üíæ" }, // Á∞°ÊòìÁâà
    { i:48, n:"Ëµ§ÈÄ£Êâì", t:"color_mash", time:10, desc:"Ëµ§„ÅÑ„Éú„Çø„É≥„Å†„ÅëÈÄ£Êâì„Åó„Çç", icon:"üî¥" },
    { i:49, n:"ÈùíÈÄ£Êâì", t:"color_mash", time:10, desc:"Èùí„ÅÑ„Éú„Çø„É≥„Å†„ÅëÈÄ£Êâì„Åó„Çç", icon:"üîµ" },
    { i:50, n:"„Éï„Ç°„Ç§„Éä„É´„Éê„Éà„É´", t:"mix", time:20, desc:"ÈÄ£Êâì„Å®ÈÅã„ÅÆËûçÂêà", icon:"üëë" }
];

// --- APP STATE ---
let myId = Math.random().toString(36).substr(2, 6);
let roomId = "";
let isHost = false;
let players = {};
let gameLoop = null;

// --- UTILS ---
const $ = id => document.getElementById(id);
const show = id => {
    document.querySelectorAll('.screen').forEach(e => e.classList.add('hidden'));
    $(id).classList.remove('hidden');
};
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
const beep = (freq=440, dur=0.1) => {
    if(audioCtx.state === 'suspended') audioCtx.resume();
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.connect(g); g.connect(audioCtx.destination);
    o.frequency.value = freq;
    g.gain.setValueAtTime(0.1, audioCtx.currentTime);
    g.gain.linearRampToValueAtTime(0, audioCtx.currentTime + dur);
    o.start(); o.stop(audioCtx.currentTime + dur);
};

// --- GLOBAL APP ---
window.App = {
    host: () => {
        isHost = true;
        Host.init();
    },
    client: () => {
        isHost = false;
        const p = new URLSearchParams(location.search);
        if(p.get('room')) $('inp-id').value = p.get('room');
        show('s-c-login');
    }
};

// --- HOST LOGIC ---
window.Host = {
    init: () => {
        roomId = Math.random().toString(36).substr(2, 4).toUpperCase();
        const r = ref(db, `rooms/${roomId}`);
        set(r, { status: 'lobby' });
        onDisconnect(r).remove();

        $('dsp-id').innerText = roomId;
        new QRCode($('qrcode'), { text: `${location.href.split('?')[0]}?room=${roomId}`, width:128, height:128 });
        show('s-h-lobby');

        onValue(ref(db, `rooms/${roomId}/players`), s => {
            players = s.val() || {};
            $('p-count').innerText = Object.keys(players).length;
        });
    },
    menu: () => {
        update(ref(db, `rooms/${roomId}`), { status: 'menu' });
        show('s-h-menu');
        const list = $('list-container');
        list.innerHTML = GAMES.map(g => `
            <div class="g-card" onclick="Host.start(${g.i})">
                <div class="g-icon">${g.icon}</div>
                <div class="g-name">${g.i}. ${g.n}</div>
                <div class="g-type">${g.time}Áßí</div>
            </div>
        `).join('');
    },
    start: (idx) => {
        const game = GAMES.find(g => g.i === idx);
        // Reset Scores
        Object.keys(players).forEach(p => set(ref(db, `rooms/${roomId}/players/${p}/score`), 0));
        
        update(ref(db, `rooms/${roomId}`), { 
            status: 'playing', 
            game: game,
            startTime: Date.now() + 3000 // 3sec delay
        });

        show('s-h-play');
        $('g-title').innerText = game.n;
        $('g-timer').innerText = "READY";
        
        setTimeout(() => {
            $('g-timer').innerText = "GO!";
            beep(880, 0.5);
            Host.timer(game.time);
        }, 3000);
    },
    timer: (sec) => {
        let left = sec;
        $('bar').style.width = "100%";
        
        gameLoop = setInterval(() => {
            left -= 0.1;
            $('bar').style.width = (left / sec * 100) + "%";
            
            // Live Ranking (Top 1)
            const sorted = Object.values(players).sort((a,b)=>(b.score||0)-(a.score||0));
            if(sorted[0]) $('g-rank').innerText = `TOP: ${sorted[0].name} (${sorted[0].score})`;

            if(left <= 0) {
                clearInterval(gameLoop);
                Host.end();
            }
        }, 100);
    },
    end: () => {
        update(ref(db, `rooms/${roomId}`), { status: 'result' });
        show('s-h-res');
        const sorted = Object.values(players).sort((a,b)=>(b.score||0)-(a.score||0));
        const win = sorted[0];
        $('res-name').innerText = win ? win.name : "NO WINNER";
        $('res-score').innerText = win ? win.score + " PTS" : "";
        beep(1200, 0.2); beep(1200, 0.2);
    }
};

// --- CLIENT LOGIC ---
window.Client = {
    score: 0,
    currGame: null,
    
    join: () => {
        roomId = $('inp-id').value.toUpperCase();
        const name = $('inp-name').value || "NO NAME";
        if(roomId.length !== 4) return alert("ID„ÅØ4ÊñáÂ≠ó„Åß„Åô");
        
        const r = ref(db, `rooms/${roomId}/players/${myId}`);
        set(r, { name: name, score: 0 })
        .then(() => {
            onDisconnect(r).remove();
            if(typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
                show('s-c-perm'); // iOS Check
            } else {
                Client.wait();
            }
        })
        .catch(() => alert("ÈÉ®Â±ã„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì"));
    },
    perm: () => {
        DeviceMotionEvent.requestPermission().then(r => {
            if(r==='granted') Client.wait();
            else alert("Ë®±ÂèØ„ÅåÂøÖË¶Å„Åß„Åô");
        });
    },
    wait: () => {
        show('s-c-wait');
        Client.initSensors();
        onValue(ref(db, `rooms/${roomId}`), s => {
            const d = s.val();
            if(!d) return;
            if(d.status === 'playing' && d.game) {
                if(d.startTime > Date.now()) {
                    setTimeout(() => Client.start(d.game), d.startTime - Date.now());
                } else {
                    Client.start(d.game);
                }
            } else {
                show('s-c-wait');
            }
        });
    },
    start: (game) => {
        Client.currGame = game;
        Client.score = 0;
        show('s-c-ctrl');
        const b = $('c-board');
        b.innerHTML = '';
        
        // Controller Generator based on TYPE
        if(game.t === 'tap' || game.t === 'mix') {
             b.innerHTML = `<button class="c-btn bg-r" ontouchstart="Client.act(1)">PUSH!</button>`;
        } 
        else if (game.t === 'shake' || game.t === 'squat' || game.t === 'spin') {
            b.innerHTML = `<div class="big-txt" style="text-align:center;">${game.icon}<br>MOVE!</div>`;
        }
        else if (game.t === 'math' || game.t === 'num') {
            Client.genMath();
        }
        else if (game.t === 'color') {
            Client.genColor();
        }
        else if (game.t === 'luck' || game.t === 'luck4') {
            const opts = game.t === 'luck' ? 2 : 4;
            for(let i=0; i<opts; i++) {
                const btn = document.createElement('button');
                btn.className = `c-btn ${['bg-r','bg-b','bg-g','bg-y'][i]}`;
                btn.innerText = "?";
                btn.onclick = () => { 
                    btn.innerText = Math.random()>0.5 ? "ÂΩì„Åü„Çä" : "„Éè„Ç∫„É¨";
                    if(btn.innerText==="ÂΩì„Åü„Çä") { Client.act(10); beep(800,0.1); } else { Client.act(-5); }
                    setTimeout(() => Client.start(game), 1000); // Re-render
                };
                b.appendChild(btn);
            }
        }
        else if (game.t === 'balance') {
             b.innerHTML = `<div class="big-txt">KEEP<br>LEVEL</div>`;
        }
    },
    // LOGIC GENERATORS
    genMath: () => {
        const b = $('c-board'); b.innerHTML = '';
        const n1 = Math.floor(Math.random()*10)+1;
        const n2 = Math.floor(Math.random()*10)+1;
        const ans = n1 + n2;
        const wrong = ans + Math.floor(Math.random()*5)+1;
        const qDiv = document.createElement('div');
        qDiv.innerHTML = `<div style="font-size:3rem;text-align:center;width:100%">${n1} + ${n2} = ?</div>`;
        qDiv.style.cssText = "width:100%; color:white;";
        b.appendChild(qDiv);
        
        const row = document.createElement('div');
        row.style.cssText = "display:flex; width:100%; height:100%;";
        [ans, wrong].sort(()=>Math.random()-0.5).forEach(val => {
            const btn = document.createElement('button');
            btn.className = 'c-btn bg-b';
            btn.innerText = val;
            btn.onclick = () => {
                if(val === ans) { Client.act(1); beep(600,0.1); } else { Client.act(-1); }
                Client.genMath();
            };
            row.appendChild(btn);
        });
        b.appendChild(row);
    },
    genColor: () => {
        const b = $('c-board'); b.innerHTML = '';
        const colors = [{n:'Ëµ§',c:'red'}, {n:'Èùí',c:'blue'}, {n:'Á∑ë',c:'green'}, {n:'ÈªÑ',c:'gold'}];
        const target = colors[Math.floor(Math.random()*4)]; // Text
        const ink = colors[Math.floor(Math.random()*4)]; // Color of text
        
        const qDiv = document.createElement('div');
        qDiv.innerHTML = `<div style="font-size:4rem;text-align:center;width:100%;color:${ink.c};font-weight:bold;">${target.n}</div>`;
        b.appendChild(qDiv);

        const grid = document.createElement('div');
        grid.style.cssText = "display:grid; grid-template-columns:1fr 1fr; width:100%; height:100%;";
        
        colors.forEach(opt => {
            const btn = document.createElement('button');
            btn.className = 'c-btn';
            btn.style.background = opt.c;
            btn.onclick = () => {
                // Game 27: Match Color of Ink, Game 28: Match Meaning
                const isMatch = (Client.currGame.n.includes("ÈÄÜ")) ? (opt.n === target.n) : (opt.c === ink.c);
                if(isMatch) Client.act(1); else Client.act(-1);
                Client.genColor();
            };
            grid.appendChild(btn);
        });
        b.appendChild(grid);
    },
    act: (v) => {
        Client.score += v;
        set(ref(db, `rooms/${roomId}/players/${myId}/score`), Client.score);
        if(navigator.vibrate) navigator.vibrate(30);
    },
    initSensors: () => {
        let lastX=0, lastY=0, lastZ=0;
        let squatState = 'up';
        
        window.addEventListener('devicemotion', e => {
            if(!Client.currGame) return;
            const type = Client.currGame.t;
            const acc = e.accelerationIncludingGravity;
            if(!acc) return;

            // SHAKE logic
            if(type === 'shake') {
                const d = Math.abs(acc.x+acc.y+acc.z - lastX-lastY-lastZ);
                if(d > 20) Client.act(1);
                lastX=acc.x; lastY=acc.y; lastZ=acc.z;
            }
            // SQUAT logic (Gravity Y)
            if(type === 'squat') {
                if(squatState==='up' && acc.y < 4) squatState='down';
                if(squatState==='down' && acc.y > 8) { squatState='up'; Client.act(1); beep(400,0.05); }
            }
        });

        window.addEventListener('deviceorientation', e => {
            if(!Client.currGame) return;
            const type = Client.currGame.t;
            
            // SPIN logic (alpha 0-360)
            if(type === 'spin') {
                 if(!Client.lastAlpha) Client.lastAlpha = e.alpha;
                 let d = Math.abs(e.alpha - Client.lastAlpha);
                 if(d > 300) d = 360 - d; // Boundary fix
                 if(d > 10) { Client.act(1); Client.lastAlpha = e.alpha; }
            }
            // BALANCE logic
            if(type === 'balance') {
                // Tilt > 15 degrees = Penalty
                if(Math.abs(e.beta) > 15 || Math.abs(e.gamma) > 15) {
                    if(Math.random()>0.8) { Client.act(-1); if(navigator.vibrate) navigator.vibrate(200); }
                } else {
                    if(Math.random()>0.9) Client.act(1); // Bonus for staying still
                }
            }
        });
    }
};
</script>
</body>
</html>
