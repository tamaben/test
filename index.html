<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é€£å¸¯ãƒ»å¤§ç¸„ã‚¢ãƒªãƒ¼ãƒŠ V9 - è·äººé­‚</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@700&family=Zen+Maru+Gothic:wght@700;900&display=swap');

        :root {
            --primary: #00f2ff;
            --secondary: #ff0055;
            --accent: #ffee00;
            --dark: #0a0b10;
        }

        body { 
            font-family: 'Zen Maru Gothic', sans-serif; 
            margin: 0; background: var(--dark); color: white; 
            overflow: hidden; touch-action: none;
        }

        .full-screen { position: absolute; top:0; left:0; width: 100vw; height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .hidden { display: none !important; }

        /* --- ãƒ›ã‚¹ãƒˆç”»é¢ --- */
        #top-ui {
            position: absolute; top: 0; width: 100%; height: 80px;
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 50px; box-sizing: border-box; background: rgba(0,0,0,0.9); border-bottom: 2px solid var(--accent); z-index: 100;
        }

        .combo-area { text-align: center; margin-top: 50px; z-index: 10; }
        .combo-num { font-family: 'Rajdhani'; font-size: 130px; line-height: 1; color: #fff; text-shadow: 0 0 40px var(--accent); }

        #arena {
            display: flex; align-items: flex-end; justify-content: center;
            height: 45vh; width: 95%; gap: 15px; border-bottom: 5px solid #333;
            position: relative; perspective: 1200px;
        }

        /* å·¦å³ã®ãƒ‘ãƒ¯ãƒ¼ãƒ¡ãƒ¼ã‚¿ãƒ¼ */
        .power-meter { position: absolute; bottom: 100px; width: 120px; height: 10px; background: #222; border-radius: 5px; overflow: hidden; }
        .power-fill { width: 0%; height: 100%; transition: width 0.1s; }
        #left-meter { left: 50px; border: 1px solid var(--secondary); }
        #right-meter { right: 50px; border: 1px solid var(--secondary); }

        #rope-visual {
            position: absolute; width: 100%; height: 150%;
            border: 12px solid var(--accent); border-radius: 50%;
            top: -75%; left: 0; transform-origin: center;
            display: none; pointer-events: none; opacity: 0.8;
            box-shadow: 0 0 50px var(--accent);
            transform: rotateX(0deg);
        }

        .player-unit { display: flex; flex-direction: column; align-items: center; width: 80px; z-index: 5; }
        .p-char { width: 40px; height: 60px; background: #fff; border-radius: 6px; transition: transform 0.1s; border: 3px solid #555; }
        .role-badge { font-size: 11px; padding: 2px 6px; border-radius: 4px; margin-bottom: 6px; font-weight: 900; }
        .badge-left { background: var(--secondary); color: white; }
        .badge-right { background: #ff9900; color: white; }
        .badge-jumper { background: var(--primary); color: #000; }

        .btn-ready { background: var(--secondary); border: none; color: white; padding: 18px 50px; font-size: 28px; cursor: pointer; border-radius: 50px; font-weight: 900; box-shadow: 0 0 30px var(--secondary); }
        .btn-ready:disabled { opacity: 0.3; }

        /* --- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ --- */
        #ctrl-pad {
            width: 280px; height: 280px; border-radius: 50%; border: 12px solid var(--primary);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: rgba(255,255,255,0.05); transition: 0.1s;
        }
    </style>
</head>
<body>
    <div class="full-screen" style="background: radial-gradient(circle, #1a1e2a 0%, #000 100%); z-index: -1;"></div>

    <!-- ãƒ›ã‚¹ãƒˆç”»é¢ -->
    <div id="host-view" class="full-screen hidden">
        <div id="top-ui">
            <div style="font-size: 20px; color: var(--accent);">æœ€é«˜ï¼š <span id="max-combo-val">0</span> å›</div>
            <div id="game-timer" style="font-family: 'Rajdhani'; font-size: 45px;">00:00</div>
            <div style="color: var(--primary); font-weight: 900;">å¤§ç¸„å”åŠ›æˆ¦ V9</div>
        </div>

        <div class="combo-area">
            <div style="letter-spacing: 10px; color: var(--accent); font-weight: 900; font-size: 20px;">TEAM COMBO</div>
            <div id="combo-num" class="combo-num">0</div>
        </div>

        <div id="lobby-ui" style="background: rgba(0,0,0,0.85); padding: 30px; border-radius: 20px; text-align: center; border: 2px solid var(--primary); z-index: 200;">
            <h1 style="margin: 0 0 10px 0;">ã‚·ãƒ³ã‚¯ãƒ­å¤§ç¸„è·³ã³</h1>
            <p>ã€å·¦ã¾ã‚ã—ã€‘ã€å³ã¾ã‚ã—ã€‘ãŒæ¯ã‚’åˆã‚ã›ã¦ç¸„ã‚’å›ã›ï¼</p>
            <div id="qrcode" style="background:white; padding:10px; display:inline-block; margin:20px; border-radius:10px;"></div>
            <div><button id="start-btn" class="btn-ready" onclick="hostStart()" disabled>è©¦åˆé–‹å§‹</button></div>
            <p id="p-count-msg" style="margin-top:20px; color:var(--primary); font-weight:bold;">é¸æ‰‹ã®å…¥å ´ã‚’å¾…ã£ã¦ã„ã¾ã™...</p>
        </div>

        <div id="arena" class="hidden">
            <div id="rope-visual"></div>
            <div id="left-meter" class="power-meter"><div id="left-fill" class="power-fill" style="background: var(--secondary);"></div></div>
            <div id="right-meter" class="power-meter"><div id="right-fill" class="power-fill" style="background: #ff9900;"></div></div>
            <div style="position:absolute; bottom:115px; left:50px; font-size:12px; color:var(--secondary);">LEFT TURNER</div>
            <div style="position:absolute; bottom:115px; right:50px; font-size:12px; color:#ff9900;">RIGHT TURNER</div>
        </div>
        <div id="overlay-msg" style="position:absolute; font-size:15vw; font-weight:900; opacity:0; transition:0.2s; z-index:300; text-shadow: 0 0 50px #000; text-align:center;"></div>
    </div>

    <!-- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ç”»é¢ -->
    <div id="ctrl-view" class="full-screen hidden">
        <div id="ctrl-login" style="background: rgba(0,0,0,0.85); padding: 30px; border-radius: 20px; text-align: center; border: 2px solid var(--primary); width:85%;">
            <h2>é¸æ‰‹å…¥å ´</h2>
            <input type="text" id="user-name" placeholder="åå‰" maxlength="8" style="padding:15px; width:80%; font-size:20px; text-align:center; border-radius:10px; border:none; margin:20px 0; background:#222; color:white;">
            <button class="btn-ready" onclick="ctrlJoin()">å…¥å ´</button>
        </div>

        <div id="ctrl-game" class="hidden" style="text-align:center;">
            <div id="my-role-badge" class="role-badge" style="display:inline-block; font-size:20px; margin-bottom:15px;">å½¹å‰²åˆ¤å®šä¸­</div>
            <div id="ctrl-pad">
                <div id="role-icon" style="font-size:70px;">â³</div>
                <div id="role-hint" style="font-size:18px; font-weight:bold; margin-top:15px; color:var(--accent);">æº–å‚™ã—ã¦ãã ã•ã„</div>
            </div>
            <div id="player-status" style="font-size:24px; font-weight:900; margin-top:25px; color:var(--primary);">READY</div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
        import { getDatabase, ref, set, onValue, update, onDisconnect, runTransaction } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDbZzTMvUkG2LXIGY4ux0KBTmnAdqP236s",
            authDomain: "game-4f2d9.firebaseapp.com",
            databaseURL: "https://game-4f2d9-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "game-4f2d9",
            storageBucket: "game-4f2d9.firebasestorage.app",
            messagingSenderId: "574316347824",
            appId: "1:574316347824:web:cf686040628e25ad615675"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const audio = new (window.AudioContext || window.webkitAudioContext)();
        function playSfx(f, t, d, v=0.1) {
            const o = audio.createOscillator(); const g = audio.createGain();
            o.type = t; o.frequency.value = f; g.gain.setValueAtTime(v, audio.currentTime);
            g.gain.exponentialRampToValueAtTime(0.01, audio.currentTime+d);
            o.connect(g); g.connect(audio.destination); o.start(); o.stop(audio.currentTime+d);
        }

        const params = new URLSearchParams(window.location.search);
        const role = params.get('role') || 'host';
        const roomId = params.get('room');
        const myId = Math.random().toString(36).substr(2, 6).toUpperCase();

        if (role === 'host') {
            if (!roomId) window.location.replace(`?role=host&room=${Math.random().toString(36).substr(2,4).toUpperCase()}`);
            document.getElementById('host-view').classList.remove('hidden');
            new QRCode(document.getElementById("qrcode"), { text: `${window.location.origin}${window.location.pathname}?role=ctrl&room=${roomId}`, width: 140, height: 140 });

            const playersRef = ref(db, `v9/${roomId}/players`);
            const stateRef = ref(db, `v9/${roomId}/state`);
            const teamRef = ref(db, `v9/${roomId}/team`);

            let ropeAngle = 0;
            let ropeSpeed = 0;
            let isRunning = false;
            let lastCheckAngle = 0;

            onValue(playersRef, snap => {
                const players = snap.val() || {};
                document.getElementById('p-count-msg').innerText = `ç¾åœ¨ ${Object.keys(players).length} åãŒå…¥å ´ä¸­`;
                document.getElementById('start-btn').disabled = Object.keys(players).length < 3; // ã¾ã‚ã—2äºº+ã‚¸ãƒ£ãƒ³ãƒ‘ãƒ¼1äººä»¥ä¸Š
                renderArena(players);
            });

            onValue(teamRef, snap => {
                const d = snap.val() || { combo: 0, maxCombo: 0 };
                document.getElementById('combo-num').innerText = d.combo;
                document.getElementById('max-combo-val').innerText = d.maxCombo;
            });

            function renderArena(players) {
                const arena = document.getElementById('arena');
                let leftPower = 0;
                let rightPower = 0;

                Object.keys(players).forEach(id => {
                    let el = document.getElementById(`p-${id}`);
                    if (!el) {
                        el = document.createElement('div'); el.id = `p-${id}`; el.className = 'player-unit';
                        el.innerHTML = `<div class="role-badge">---</div><div class="p-char"></div><div style="font-size:10px; margin-top:5px;">${players[id].name}</div>`;
                        arena.appendChild(el);
                    }
                    const p = players[id];
                    const char = el.querySelector('.p-char');
                    const badge = el.querySelector('.role-badge');

                    if (p.role === 'turner_l') {
                        badge.innerText = "å·¦ã¾ã‚ã—"; badge.className = "role-badge badge-left";
                        char.style.background = "var(--secondary)";
                        leftPower = p.power || 0;
                    } else if (p.role === 'turner_r') {
                        badge.innerText = "å³ã¾ã‚ã—"; badge.className = "role-badge badge-right";
                        char.style.background = "#ff9900";
                        rightPower = p.power || 0;
                    } else if (p.role === 'jumper') {
                        badge.innerText = "ã‚¸ãƒ£ãƒ³ãƒ‘ãƒ¼"; badge.className = "role-badge badge-jumper";
                        char.style.background = "#fff";
                        if (p.state === 'jump') { char.style.transform = 'translateY(-50px)'; setTimeout(() => char.style.transform = 'translateY(0)', 150); }
                    }
                });
                
                if (isRunning) {
                    document.getElementById('left-fill').style.width = (leftPower * 10) + '%';
                    document.getElementById('right-fill').style.width = (rightPower * 10) + '%';
                    
                    // å·¦å³ã®ãƒ‘ãƒ¯ãƒ¼ã®ç›¸ä¹—åŠ¹æœã§ç¸„ã‚’å›ã™ï¼ˆç‰©ç†ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é¢¨ï¼‰
                    // ç‰‡æ–¹ãŒ0ãªã‚‰ã»ã¨ã‚“ã©å›ã‚‰ãªã„ã‚ˆã†ã«è¨­å®š
                    const combinedPower = (leftPower + rightPower) * (Math.min(leftPower, rightPower) > 0.5 ? 1 : 0.2);
                    ropeSpeed = (combinedPower * 0.15) + (ropeSpeed * 0.94); // 0.94ã¯ç©ºæ°—æŠµæŠ—/æ‘©æ“¦
                    if (ropeSpeed < 0.1) ropeSpeed = 0;
                }
            }

            function animate() {
                if (!isRunning) return;
                const rope = document.getElementById('rope-visual');
                ropeAngle += ropeSpeed;
                rope.style.transform = `rotateX(${ropeAngle}deg)`;

                const normAngle = ropeAngle % 360;
                if (lastCheckAngle < 90 && normAngle >= 90) processHit();
                lastCheckAngle = normAngle;
                requestAnimationFrame(animate);
            }

            function processHit() {
                playSfx(150, 'triangle', 0.1, 0.05);
                onValue(playersRef, snap => {
                    const players = snap.val() || {};
                    const jumpers = Object.values(players).filter(p => p.role === 'jumper');
                    if (jumpers.length === 0) return;
                    const allSuccess = jumpers.every(p => p.state === 'jump');
                    if (allSuccess) {
                        playSfx(600, 'sine', 0.1, 0.2);
                        runTransaction(teamRef, c => { if(c){ c.combo++; if(c.combo > c.maxCombo) c.maxCombo = c.combo; } return c; });
                    } else {
                        update(teamRef, { combo: 0 });
                        playSfx(100, 'sawtooth', 0.2, 0.1);
                    }
                }, {onlyOnce: true});
            }

            window.hostStart = () => {
                document.getElementById('lobby-ui').classList.add('hidden');
                document.getElementById('arena').classList.remove('hidden');
                document.getElementById('rope-visual').style.display = 'block';
                
                onValue(playersRef, snap => {
                    const ids = Object.keys(snap.val() || {});
                    const updates = {};
                    const shuffled = ids.sort(() => Math.random() - 0.5);
                    shuffled.forEach((id, idx) => {
                        let r = 'jumper';
                        if (idx === 0) r = 'turner_l';
                        if (idx === 1) r = 'turner_r';
                        updates[id + '/role'] = r;
                        updates[id + '/power'] = 0;
                        updates[id + '/state'] = 'idle';
                    });
                    update(playersRef, updates);
                }, {onlyOnce: true});
                set(teamRef, { combo: 0, maxCombo: 0 });
                ropeAngle = 0; ropeSpeed = 0; // é–‹å§‹æ™‚ã«ç¸„ã‚’é™æ­¢

                let count = 3;
                const ov = document.getElementById('overlay-msg'); ov.style.opacity = 1;
                const cd = setInterval(() => {
                    if (count > 0) { playSfx(800, 'sine', 0.1); ov.innerText = count; }
                    else {
                        clearInterval(cd); playSfx(400, 'square', 0.4); ov.innerText = "ã‚¹ã‚¿ãƒ¼ãƒˆï¼";
                        setTimeout(() => ov.style.opacity = 0, 1000);
                        isRunning = true;
                        update(stateRef, { status: 'running' });
                        animate();
                        startTimer();
                    }
                    count--;
                }, 1000);
            };

            function startTimer() {
                let time = 30;
                const timer = setInterval(() => {
                    time--;
                    document.getElementById('game-timer').innerText = `00:${time < 10 ? '0'+time : time}`;
                    if (time <= 0) {
                        clearInterval(timer); isRunning = false;
                        update(stateRef, { status: 'finished' });
                        document.getElementById('overlay-msg').innerText = "çµ‚äº†ï¼";
                        document.getElementById('overlay-msg').style.opacity = 1;
                        setTimeout(() => location.reload(), 10000);
                    }
                }, 1000);
            }
        }

        // --- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ ---
        else {
            document.getElementById('ctrl-view').classList.remove('hidden');
            let status = 'lobby', myRole = '';

            window.ctrlJoin = () => {
                const n = document.getElementById('user-name').value;
                if(!n) return alert("åå‰ã‚’å…¥åŠ›ï¼");
                if(typeof DeviceMotionEvent.requestPermission === 'function') {
                    DeviceMotionEvent.requestPermission().then(r => { if(r==='granted') init(n); });
                } else init(n);
            };

            function init(name) {
                document.getElementById('ctrl-login').classList.add('hidden');
                document.getElementById('ctrl-game').classList.remove('hidden');
                const pRef = ref(db, `v9/${roomId}/players/${myId}`);
                set(pRef, { name: name, role: 'waiting', power: 0, state: 'idle' });
                onDisconnect(pRef).remove();

                onValue(ref(db, `v9/${roomId}/state`), s => { status = (s.val() || {}).status; });
                onValue(pRef, snap => {
                    const d = snap.val(); if(!d) return;
                    myRole = d.role;
                    const badge = document.getElementById('my-role-badge');
                    const icon = document.getElementById('role-icon');
                    const hint = document.getElementById('role-hint');

                    if (myRole === 'turner_l') {
                        badge.innerText = "ã‚ãªãŸã¯ã€å·¦ã¾ã‚ã—æ‰‹ã€‘"; badge.className = "role-badge badge-left";
                        icon.innerText = "â¬…ï¸ğŸŒ€"; hint.innerText = "ã‚¹ãƒãƒ›ã‚’å›ã—ã¦ç¸„ã«åŠ›ã‚’é€ã‚Œï¼";
                    } else if (myRole === 'turner_r') {
                        badge.innerText = "ã‚ãªãŸã¯ã€å³ã¾ã‚ã—æ‰‹ã€‘"; badge.className = "role-badge badge-right";
                        icon.innerText = "ğŸŒ€â¡ï¸"; hint.innerText = "ã‚¹ãƒãƒ›ã‚’å›ã—ã¦ç¸„ã«åŠ›ã‚’é€ã‚Œï¼";
                    } else if (myRole === 'jumper') {
                        badge.innerText = "ã‚ãªãŸã¯ã€ã‚¸ãƒ£ãƒ³ãƒ‘ãƒ¼ã€‘"; badge.className = "role-badge badge-jumper";
                        icon.innerText = "ğŸ‘–"; hint.innerText = "ã‚¹ãƒãƒ›ã‚’ãƒã‚±ãƒƒãƒˆã«å…¥ã‚Œã¦è·³ã¹ï¼";
                    }
                });

                let lastX=0, lastY=0, lastJumpTime = 0;
                window.addEventListener('devicemotion', e => {
                    if (status !== 'running') return;
                    const acc = e.accelerationIncludingGravity;
                    const now = Date.now();

                    if (myRole.startsWith('turner')) {
                        const power = Math.min(10, (Math.abs(acc.x - lastX) + Math.abs(acc.y - lastY)));
                        update(pRef, { power: power });
                        document.getElementById('player-status').innerText = "å…¨åŠ›ã¾ã‚ã—ä¸­ï¼";
                        lastX = acc.x; lastY = acc.y;
                    } else if (myRole === 'jumper') {
                        if (acc.y > 16 && now - lastJumpTime > 500) {
                            lastJumpTime = now;
                            update(pRef, { state: 'jump' });
                            document.getElementById('player-status').innerText = "JUMP!!";
                            setTimeout(() => { update(pRef, { state: 'idle' }); document.getElementById('player-status').innerText = "å¾…æ©Ÿä¸­"; }, 400);
                        }
                    }
                });
            }
        }
    </script>
</body>
</html>
