<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AIäººç‹¼ãƒ»ãƒœã‚¤ã‚¹ã‚¢ãƒªãƒ¼ãƒŠ V11</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@700;900&display=swap');

        :root {
            --bg: #0a0a0c;
            --panel: #1a1a1f;
            --accent: #ff3333;
            --seer: #bb33ff;
            --village: #33aaff;
            --gold: #ffcc00;
        }

        body { font-family: 'Zen Maru Gothic', sans-serif; background: var(--bg); color: white; margin: 0; overflow: hidden; }
        .hidden { display: none !important; }
        .full-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; padding: 20px; box-sizing: border-box; }

        /* --- ãƒ›ã‚¹ãƒˆï¼ˆãƒ¡ã‚¤ãƒ³ç”»é¢ï¼‰ --- */
        #host-view { background: radial-gradient(circle at center, #222, #000); }
        .timer-val { font-size: 120px; font-weight: 900; color: var(--gold); text-shadow: 0 0 30px var(--gold); line-height: 1; }
        .player-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px; width: 100%; max-width: 900px; margin: 30px 0; }
        .p-card { background: var(--panel); padding: 20px; border-radius: 15px; border: 2px solid #333; text-align: center; position: relative; transition: 0.3s; }
        .p-card.dead { opacity: 0.3; filter: grayscale(1); border-color: #000; }
        .p-card.ai::before { content: "AI"; position: absolute; top: 8px; right: 8px; font-size: 10px; color: #888; border: 1px solid #444; padding: 1px 4px; border-radius: 3px; }
        
        #ai-caption {
            width: 100%; max-width: 700px; min-height: 80px; background: rgba(0,0,0,0.7);
            border-left: 5px solid var(--accent); padding: 15px; font-size: 20px;
            color: #fff; margin-top: 20px; border-radius: 0 10px 10px 0;
            box-shadow: 0 0 20px rgba(255,51,51,0.2);
        }

        /* --- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼ˆã‚¹ãƒãƒ›ï¼‰ --- */
        .btn-action { background: var(--accent); color: white; border: none; padding: 15px 30px; font-size: 20px; border-radius: 50px; font-weight: 900; width: 100%; margin-top: 20px; cursor: pointer; }
        .role-secret-card { background: #111; border: 3px solid var(--gold); padding: 20px; border-radius: 20px; margin: 20px 0; }
        select { width: 100%; padding: 15px; font-size: 18px; border-radius: 10px; background: #222; color: white; border: 1px solid #444; }

        .qr-wrap { background: white; padding: 15px; border-radius: 15px; margin-bottom: 10px; }
    </style>
</head>
<body>

    <!-- ãƒ›ã‚¹ãƒˆç”»é¢ (å¤§ç”»é¢ç”¨) -->
    <div id="host-view" class="full-screen hidden">
        <h1 style="color: var(--accent); letter-spacing: 5px; margin: 0;">AI WEREWOLF ARENA</h1>
        
        <div id="host-lobby" style="text-align: center;">
            <div class="qr-wrap" id="qrcode" style="margin: 20px auto; display: inline-block;"></div>
            <p style="font-size: 18px; color: #aaa;">ã‚¹ãƒãƒ›ã‚’æ¥ç¶šã—ã¦ãã ã•ã„</p>
            <div style="background: rgba(255,255,255,0.05); padding: 25px; border-radius: 20px; margin-top: 10px;">
                å‚åŠ äººæ•°è¨­å®šï¼š<input type="number" id="cfg-total" value="5" min="3" max="10" style="font-size: 20px; width: 60px; background: #000; color: #fff; border: 1px solid #555; text-align: center;">
                <br><br>
                è­°è«–æ™‚é–“(ç§’)ï¼š<input type="number" id="cfg-time" value="120" style="font-size: 20px; width: 80px; background: #000; color: #fff; border: 1px solid #555; text-align: center;">
                <br><br>
                <button class="btn-action" style="background: var(--gold); color: #000;" onclick="hostStart()">ã‚²ãƒ¼ãƒ é–‹å§‹ï¼ˆAIè£œå……ï¼‰</button>
            </div>
            <div id="host-p-count" style="margin-top: 15px; font-weight: bold; color: var(--village);">æ¥ç¶šä¸­ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼: 0 å</div>
        </div>

        <div id="host-game" class="hidden" style="width: 100%; max-width: 1000px; text-align: center;">
            <h2 id="phase-title" style="margin: 0; color: var(--village);">å¤œã®è¡Œå‹•ä¸­</h2>
            <div id="host-timer" class="timer-val hidden">00:00</div>
            <div class="player-grid" id="host-p-grid"></div>
            
            <div id="ai-caption" class="hidden">
                <div style="font-size: 12px; color: var(--gold); margin-bottom: 5px;" id="ai-speaker-name">AIç™ºè¨€</div>
                <div id="ai-text">......</div>
            </div>
        </div>
    </div>

    <!-- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ç”»é¢ (ã‚¹ãƒãƒ›ç”¨) -->
    <div id="player-view" class="full-screen hidden">
        <h2 id="p-my-name">é¸æ‰‹</h2>
        
        <div id="p-wait" style="text-align: center;">
            <div style="font-size: 40px; margin-bottom: 10px;">ğŸ“±</div>
            <p id="p-wait-msg">ãƒ›ã‚¹ãƒˆã®é–‹å§‹ã‚’å¾…ã£ã¦ã„ã¾ã™...</p>
        </div>

        <div id="p-action" class="hidden" style="width: 100%;">
            <div class="role-secret-card">
                <div style="font-size: 14px; color: var(--gold);">ã‚ãªãŸã®æ­£ä½“</div>
                <div id="p-role-name" style="font-size: 32px; font-weight: 900; margin: 10px 0;">---</div>
            </div>
            <div id="p-input-ui">
                <p id="p-instr">å¯¾è±¡ã‚’é¸ã‚“ã§ãã ã•ã„</p>
                <select id="p-target"></select>
                <button class="btn-action" onclick="pSubmit()">æ±ºå®š</button>
            </div>
            <div id="p-result" style="margin-top: 15px; color: var(--gold); font-weight: bold;"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
        import { getDatabase, ref, set, onValue, update, runTransaction, onDisconnect } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

        // Firebase Config (åˆ©ç”¨è€…ã®ç’°å¢ƒã«åˆã‚ã›ã¦é©å®œå¤‰æ›´)
        const firebaseConfig = {
            apiKey: "AIzaSyDbZzTMvUkG2LXIGY4ux0KBTmnAdqP236s",
            authDomain: "game-4f2d9.firebaseapp.com",
            databaseURL: "https://game-4f2d9-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "game-4f2d9",
            storageBucket: "game-4f2d9.firebasestorage.app",
            messagingSenderId: "574316347824",
            appId: "1:574316347824:web:cf686040628e25ad615675"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- éŸ³å£°åˆæˆã‚¨ãƒ³ã‚¸ãƒ³ (Web Speech API) ---
        function speakAI(text) {
            const uttr = new SpeechSynthesisUtterance(text);
            uttr.lang = "ja-JP";
            uttr.rate = 1.1; // å°‘ã—é€Ÿã‚ã«
            uttr.pitch = 1.0;
            window.speechSynthesis.speak(uttr);
            document.getElementById('ai-text').innerText = text;
        }

        const params = new URLSearchParams(window.location.search);
        let role = params.get('role') || 'host';
        let roomId = params.get('room');
        const myId = "UID_" + Math.random().toString(36).substr(2, 5).toUpperCase();

        // --- HOST LOGIC ---
        if (role === 'host') {
            if (!roomId) {
                roomId = Math.random().toString(36).substr(2, 4).toUpperCase();
                window.location.replace(`?role=host&room=${roomId}`);
            }
            document.getElementById('host-view').classList.remove('hidden');
            new QRCode(document.getElementById("qrcode"), { text: `${window.location.origin}${window.location.pathname}?role=player&room=${roomId}`, width: 160, height: 160 });

            const roomRef = ref(db, `jinro_v11/${roomId}`);
            
            onValue(ref(db, `jinro_v11/${roomId}/players`), snap => {
                const ps = snap.val() || {};
                document.getElementById('host-p-count').innerText = `æ¥ç¶šä¸­ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼: ${Object.keys(ps).length} å`;
                updateHostUI(ps);
            });

            window.hostStart = async () => {
                const snap = await onValue(ref(db, `jinro_v11/${roomId}/players`), s => {}, {onlyOnce: true});
                let players = snap.val() || {};
                const total = parseInt(document.getElementById('cfg-total').value);
                const time = parseInt(document.getElementById('cfg-time').value);

                const aiNames = ["ã‚¿ãƒŠã‚«", "ã‚µãƒˆã‚¦", "ã‚¹ã‚ºã‚­", "ã‚¤ãƒˆã‚¦", "ãƒ¤ãƒãƒ€", "ã‚«ãƒˆã‚¦", "ãƒ¨ã‚·ãƒ€"];
                let count = Object.keys(players).length;
                while (count < total) {
                    const aiId = "AI_" + Math.random().toString(36).substr(2, 4).toUpperCase();
                    players[aiId] = { name: aiNames[count % aiNames.length], isAI: true, alive: true, role: "" };
                    count++;
                }

                const ids = Object.keys(players);
                let roles = ["äººç‹¼", "å ã„å¸«"];
                while (roles.length < ids.length) roles.push("æ‘äºº");
                roles = roles.sort(() => Math.random() - 0.5);
                ids.forEach((id, i) => players[id].role = roles[i]);

                await set(roomRef, {
                    players: players,
                    state: { phase: 'NIGHT', day: 1, timer: time, victim: "" },
                    aiChat: { speaker: "", text: "" }
                });
                
                document.getElementById('host-lobby').classList.add('hidden');
                document.getElementById('host-game').classList.remove('hidden');
                initGameObserver();
            };

            function initGameObserver() {
                onValue(roomRef, snap => {
                    const data = snap.val();
                    if (!data) return;
                    const s = data.state;
                    document.getElementById('phase-title').innerText = `${s.day}æ—¥ç›®ï¼š${getPhaseJP(s.phase)}`;
                    
                    if (s.phase === 'DISCUSSION') {
                        document.getElementById('host-timer').classList.remove('hidden');
                        document.getElementById('ai-caption').classList.remove('hidden');
                        startTimer(s.timer);
                    } else {
                        document.getElementById('host-timer').classList.add('hidden');
                        document.getElementById('ai-caption').classList.add('hidden');
                    }
                });

                // AIã®ç™ºè¨€ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–ã—ã¦èª­ã¿ä¸Šã’
                onValue(ref(db, `jinro_v11/${roomId}/aiChat`), snap => {
                    const chat = snap.val();
                    if (chat && chat.text) {
                        document.getElementById('ai-speaker-name').innerText = chat.speaker + " ã®ç™ºè¨€";
                        speakAI(chat.text);
                    }
                });
            }

            let timerId = null;
            function startTimer(sec) {
                if (timerId) return;
                let left = sec;
                timerId = setInterval(() => {
                    left--;
                    const m = Math.floor(left / 60); const s = left % 60;
                    document.getElementById('host-timer').innerText = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
                    
                    // 15ç§’ãŠãã«AIãŒçŠ¶æ³ã‚’åˆ¤æ–­ã—ã¦å–‹ã‚‹
                    if (left % 15 === 0 && left > 0) aiLogicSpeak();

                    if (left <= 0) {
                        clearInterval(timerId); timerId = null;
                        // ãƒ•ã‚§ãƒ¼ã‚ºé€²è¡Œãƒ­ã‚¸ãƒƒã‚¯ã¸
                    }
                }, 1000);
            }

            async function aiLogicSpeak() {
                // AIå…¨å“¡ã®ä¸­ã‹ã‚‰ç”Ÿãã¦ã„ã‚‹AIã‚’ä¸€äººé¸ã‚“ã§å–‹ã‚‰ã›ã‚‹
                const snap = await onValue(roomRef, s => {}, {onlyOnce: true});
                const data = snap.val();
                const aliveAIs = Object.entries(data.players).filter(([id, p]) => p.isAI && p.alive);
                if (aliveAIs.length === 0) return;

                const [aiId, aiData] = aliveAIs[Math.floor(Math.random() * aliveAIs.length)];
                let msg = "";
                const livingNames = Object.values(data.players).filter(p => p.alive).map(p => p.name);
                const randomTarget = livingNames[Math.floor(Math.random() * livingNames.length)];

                // ç°¡å˜ãªçŠ¶æ³åˆ¤æ–­ãƒ­ã‚¸ãƒƒã‚¯
                if (aiData.role === 'äººç‹¼') {
                    msg = `ç§ã¯æ‘äººã§ã™ã€‚${randomTarget}ã•ã‚“ã®è¨€å‹•ãŒå°‘ã—ä¸è‡ªç„¶ã«æ„Ÿã˜ã¾ã™ã­ã€‚`;
                } else if (aiData.role === 'å ã„å¸«') {
                    msg = `å ã„å¸«ã®ç§ã‹ã‚‰è¨€ã‚ã›ã¦ã‚‚ã‚‰ã†ã¨ã€ã¾ã äººç‹¼ã¯æ½œã‚“ã§ã„ã¾ã™ã€‚${randomTarget}ã•ã‚“ã¯ã©ã†æ€ã„ã¾ã™ã‹ï¼Ÿ`;
                } else {
                    if (data.state.victim) {
                        msg = `${data.state.victim}ã•ã‚“ãŒæ®ºã•ã‚Œã‚‹ãªã‚“ã¦ã‚·ãƒ§ãƒƒã‚¯ã§ã™ã€‚äººç‹¼ã¯èª°ãªã‚“ã§ã—ã‚‡ã†ã‹ã€‚`;
                    } else {
                        msg = `ã¾ã æ‰‹ãŒã‹ã‚ŠãŒå°‘ãªã„ã§ã™ã­ã€‚ã¿ã‚“ãªã§è©±ã—åˆã£ã¦æ€ªã—ã„äººã‚’è¦‹ã¤ã‘ã¾ã—ã‚‡ã†ã€‚`;
                    }
                }

                update(ref(db, `jinro_v11/${roomId}/aiChat`), { speaker: aiData.name, text: msg });
            }
        }

        // --- PLAYER LOGIC ---
        else {
            document.getElementById('player-view').classList.remove('hidden');
            const name = prompt("åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„") || "åç„¡ã—";
            document.getElementById('p-my-name').innerText = name;
            
            const pRef = ref(db, `jinro_v11/${roomId}/players/${myId}`);
            set(pRef, { name: name, isAI: false, alive: true, role: "" });
            onDisconnect(pRef).remove();

            onValue(ref(db, `jinro_v11/${roomId}`), snap => {
                const room = snap.val();
                if (!room || !room.state || !room.players[myId]) return;
                const s = room.state;
                const me = room.players[myId];

                if (s.phase === 'NIGHT' && me.alive) {
                    showActionUI(room, me);
                } else {
                    document.getElementById('p-action').classList.add('hidden');
                    document.getElementById('p-wait').classList.remove('hidden');
                    document.getElementById('p-wait-msg').innerText = `${getPhaseJP(s.phase)}ä¸­ã§ã™ã€‚ãƒ¡ã‚¤ãƒ³ç”»é¢ã‚’è¦‹ã¦ãã ã•ã„ã€‚`;
                }
            });
        }

        // --- HELPERS ---
        function getPhaseJP(p) {
            return { NIGHT: 'å¤œ', DISCUSSION: 'è­°è«–', VOTE: 'æŠ•ç¥¨', MORNING: 'æœ' }[p] || p;
        }

        function updateHostUI(ps) {
            const grid = document.getElementById('host-p-grid');
            if(!grid) return;
            grid.innerHTML = '';
            Object.entries(ps).forEach(([id, p]) => {
                grid.innerHTML += `<div class="p-card ${p.alive ? '' : 'dead'} ${p.isAI ? 'ai' : ''}">
                    <div style="font-size: 20px; font-weight: 900;">${p.name}</div>
                    <div style="font-size: 12px; color: #888;">${p.alive ? 'ç”Ÿå­˜' : 'è¿½æ”¾æ¸ˆã¿'}</div>
                </div>`;
            });
        }

        function showActionUI(room, me) {
            document.getElementById('p-wait').classList.add('hidden');
            document.getElementById('p-action').classList.remove('hidden');
            document.getElementById('p-role-name').innerText = me.role;
            const sel = document.getElementById('p-target');
            sel.innerHTML = '';
            
            if (me.role === 'äººç‹¼') {
                document.getElementById('p-instr').innerText = "è¥²æ’ƒå…ˆã‚’é¸æŠã—ã¦ãã ã•ã„";
                Object.entries(room.players).forEach(([id, p]) => { if(p.alive && p.role !== 'äººç‹¼') sel.add(new Option(p.name, id)); });
            } else if (me.role === 'å ã„å¸«') {
                document.getElementById('p-instr').innerText = "å ã†ç›¸æ‰‹ã‚’é¸æŠã—ã¦ãã ã•ã„";
                Object.entries(room.players).forEach(([id, p]) => { if(p.alive && id !== myId) sel.add(new Option(p.name, id)); });
            } else {
                document.getElementById('p-input-ui').classList.add('hidden');
                document.getElementById('p-instr').innerText = "ã‚ãªãŸã¯æ‘äººã§ã™ã€‚é™ã‹ã«å¤œã‚’éã”ã—ã¦ãã ã•ã„ã€‚";
            }
        }
    </script>
</body>
</html>
