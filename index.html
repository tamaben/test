<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SHAKE PARTY - NEON BATTLE</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Black+Ops+One&family=Roboto:wght@700&display=swap');

        :root {
            --primary: #00ffcc;
            --secondary: #ff00ff;
            --bg: #0a0a0a;
        }

        body { font-family: 'Roboto', sans-serif; margin: 0; background: var(--bg); color: white; overflow: hidden; touch-action: none; }
        .hidden { display: none !important; }
        .full-screen { position: absolute; top:0; left:0; width: 100vw; height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        
        /* --- HOST DESIGN --- */
        #host-view { background: radial-gradient(circle at center, #1a1a1a, #000); }
        h1 { font-family: 'Black Ops One', cursive; font-size: 50px; color: var(--primary); text-shadow: 0 0 20px var(--primary); margin: 10px 0; }
        
        #meter-container { display: flex; align-items: flex-end; justify-content: center; width: 90%; height: 50vh; margin-top: 20px; gap: 15px; border-bottom: 3px solid #333; padding-bottom: 5px; }
        .player-column { display: flex; flex-direction: column; align-items: center; justify-content: flex-end; width: 90px; height: 100%; transition: all 0.3s; position: relative; }
        .bar { width: 100%; border-radius: 8px 8px 0 0; transition: height 0.1s linear; position: relative; box-shadow: 0 0 15px rgba(0, 255, 204, 0.3); }
        .p-name { margin-top: 15px; font-weight: bold; font-size: 14px; text-align: center; color: #fff; width: 100%; overflow: hidden; text-overflow: ellipsis; }
        .p-score { font-family: 'Black Ops One'; font-size: 24px; position: absolute; top: -35px; color: var(--primary); }
        .winner-crown { position: absolute; top: -80px; font-size: 40px; display: none; animation: bounce 0.5s infinite alternate; }
        @keyframes bounce { from { transform: translateY(0); } to { transform: translateY(-10px); } }

        #timer { font-size: 100px; font-family: 'Black Ops One'; position: absolute; top: 20px; right: 40px; color: #fff; text-shadow: 0 0 20px var(--secondary); }
        #game-msg { font-size: 60px; font-family: 'Black Ops One'; position: absolute; top: 40%; width: 100%; text-align: center; pointer-events: none; z-index: 10; color: var(--secondary); }

        .btn { padding: 15px 40px; font-size: 24px; background: var(--secondary); border: none; color: white; cursor: pointer; border-radius: 50px; font-weight: bold; font-family: 'Black Ops One'; box-shadow: 0 0 20px var(--secondary); transition: 0.2s; }
        .btn:hover { transform: scale(1.1); filter: brightness(1.2); }
        .btn:disabled { background: #444; box-shadow: none; opacity: 0.5; }

        /* --- CONTROLLER DESIGN --- */
        #ctrl-view { background: #111; }
        #shake-circle { width: 250px; height: 250px; border-radius: 50%; background: radial-gradient(circle, #ff00ff, #880088); border: 10px solid rgba(255,255,255,0.1); display: flex; flex-direction: column; align-items: center; justify-content: center; box-shadow: 0 0 50px var(--secondary); margin-bottom: 30px; }
        #ctrl-score { font-size: 80px; font-family: 'Black Ops One'; }
        .shake-active { transform: scale(0.9); }
        
        input[type="text"] { background: #222; border: 2px solid var(--primary); color: white; padding: 15px; font-size: 20px; border-radius: 10px; text-align: center; margin-bottom: 20px; width: 80%; outline: none; }
    </style>
</head>
<body>

    <!-- „Éõ„Çπ„ÉàË°®Á§∫ (PC) -->
    <div id="host-view" class="full-screen hidden">
        <h1>NEON SHAKE BATTLE</h1>
        <div id="timer">10</div>
        <div id="game-msg"></div>

        <div id="meter-container">
            <div id="waiting-msg" style="color: #444; font-size: 24px;">ÂèÇÂä†ËÄÖ„ÇíÂæÖÊ©ü‰∏≠...</div>
        </div>

        <div id="lobby-ui" style="text-align: center; margin-top:30px;">
            <div id="qrcode" style="background: white; padding: 10px; display: inline-block; border-radius: 10px;"></div>
            <p id="room-id-display" style="margin: 10px; color: var(--primary); font-family: 'Black Ops One';"></p>
            <button id="start-btn" class="btn" onclick="window.hostStartGame()" disabled>BATTLE START</button>
        </div>
    </div>

    <!-- „Ç≥„É≥„Éà„É≠„Éº„É©„ÉºË°®Á§∫ („Çπ„Éû„Éõ) -->
    <div id="ctrl-view" class="full-screen hidden">
        <!-- ÂêçÂâçÂÖ•ÂäõÁîªÈù¢ -->
        <div id="name-step" class="full-screen">
            <h2 style="color: var(--primary)">ENTER NAME</h2>
            <input type="text" id="user-name" placeholder="„Éã„ÉÉ„ÇØ„Éç„Éº„É†" maxlength="8">
            <button class="btn" onclick="window.submitName()">JOIN GAME</button>
        </div>

        <!-- „Çª„É≥„Çµ„ÉºË®±ÂèØÁîªÈù¢ -->
        <div id="perm-step" class="full-screen hidden">
            <h2 style="color: var(--secondary)">„Çª„É≥„Çµ„Éº„ÅÆË®±ÂèØ</h2>
            <p style="text-align:center; padding:20px;">„Çπ„Éû„Éõ„ÇíÊåØ„ÇãÂãï‰Ωú„ÇíÊ§úÁü•„Åô„Çã„Åü„ÇÅ„Å´<br>„Çª„É≥„Çµ„Éº„ÅÆË®±ÂèØ„ÅåÂøÖË¶Å„Åß„Åô„ÄÇ</p>
            <button class="btn" onclick="window.requestPermission()">OK</button>
        </div>

        <!-- „Éó„É¨„Ç§ÁîªÈù¢ -->
        <div id="game-step" class="full-screen hidden">
            <div id="ctrl-msg" style="margin-bottom:20px; font-size: 20px; color: #aaa;">ÂæÖÊ©ü‰∏≠...</div>
            <div id="shake-circle">
                <div id="ctrl-score">0</div>
                <div style="font-weight:bold;">SHAKES</div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
        import { getDatabase, ref, set, onValue, update, onDisconnect } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyDbZzTMvUkG2LXIGY4ux0KBTmnAdqP236s",
            authDomain: "game-4f2d9.firebaseapp.com",
            databaseURL: "https://game-4f2d9-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "game-4f2d9",
            storageBucket: "game-4f2d9.firebasestorage.app",
            messagingSenderId: "574316347824",
            appId: "1:574316347824:web:cf686040628e25ad615675"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const params = new URLSearchParams(window.location.search);
        let role = params.get('role') || 'host';
        let roomId = params.get('room');
        const myId = Math.random().toString(36).substr(2, 5).toUpperCase();

        const COLORS = ['#00ffcc', '#ff00ff', '#ffff00', '#0077ff', '#ff3300', '#00ff00'];

        // ============================================
        // HOST LOGIC
        // ============================================
        if (role === 'host') {
            if (!roomId) {
                roomId = Math.random().toString(36).substring(2, 6).toUpperCase();
                window.location.replace(`?role=host&room=${roomId}`);
            }

            document.getElementById('host-view').classList.remove('hidden');
            document.getElementById('room-id-display').innerText = `ROOM ID: ${roomId}`;
            
            new QRCode(document.getElementById("qrcode"), {
                text: `${window.location.origin}${window.location.pathname}?role=ctrl&room=${roomId}`,
                width: 128, height: 128
            });

            const roomRef = ref(db, `shake/${roomId}`);
            
            // ÂèÇÂä†ËÄÖ„ÅÆ„É™„Ç¢„É´„Çø„Ç§„É†Áõ£Ë¶ñ
            onValue(ref(db, `shake/${roomId}/players`), (snap) => {
                const players = snap.val() || {};
                renderArena(players);
                
                // 1‰∫∫‰ª•‰∏ä„ÅÑ„Çå„Å∞„Éú„Çø„É≥„ÇíÊúâÂäπÂåñ
                document.getElementById('start-btn').disabled = (Object.keys(players).length === 0);
            });

            function renderArena(players) {
                const container = document.getElementById('meter-container');
                const pIds = Object.keys(players);

                if (pIds.length > 0) {
                    const msg = document.getElementById('waiting-msg');
                    if (msg) msg.remove();
                } else {
                    if (!document.getElementById('waiting-msg')) {
                        container.innerHTML = '<div id="waiting-msg" style="color: #444; font-size: 24px;">ÂèÇÂä†ËÄÖ„ÇíÂæÖÊ©ü‰∏≠...</div>';
                    }
                    return;
                }

                pIds.forEach((id, index) => {
                    const p = players[id];
                    let el = document.getElementById(`p-${id}`);
                    const color = COLORS[index % COLORS.length];

                    if (!el) {
                        el = document.createElement('div');
                        el.id = `p-${id}`;
                        el.className = 'player-column';
                        el.innerHTML = `
                            <div class="winner-crown">üëë</div>
                            <div class="p-score">0</div>
                            <div class="bar"></div>
                            <div class="p-name">${p.name}</div>
                        `;
                        container.appendChild(el);
                    }

                    const scoreEl = el.querySelector('.p-score');
                    const barEl = el.querySelector('.bar');
                    const crownEl = el.querySelector('.winner-crown');
                    
                    const score = p.count || 0;
                    scoreEl.innerText = score;
                    barEl.style.height = `${Math.min(score * 2, 100)}%`;
                    barEl.style.backgroundColor = color;
                    barEl.style.boxShadow = `0 0 20px ${color}`;
                    el.querySelector('.p-name').style.color = color;
                    crownEl.style.display = p.isWinner ? 'block' : 'none';
                });

                // ÈÄÄÂá∫„Åó„Åü„Éó„É¨„Ç§„É§„Éº„ÇíÂâäÈô§
                Array.from(container.children).forEach(child => {
                    if (child.id.startsWith('p-') && !players[child.id.replace('p-', '')]) {
                        child.remove();
                    }
                });
            }

            window.hostStartGame = () => {
                const stateRef = ref(db, `shake/${roomId}/state`);
                update(roomRef, { 'state/status': 'ready' });
                document.getElementById('lobby-ui').classList.add('hidden');
                
                // „Çπ„Ç≥„Ç¢„É™„Çª„ÉÉ„Éà
                onValue(ref(db, `shake/${roomId}/players`), (snap) => {
                    const players = snap.val();
                    const updates = {};
                    Object.keys(players).forEach(id => {
                        updates[`players/${id}/count`] = 0;
                        updates[`players/${id}/isWinner`] = false;
                    });
                    update(roomRef, updates);
                }, { onlyOnce: true });

                let count = 3;
                const msgEl = document.getElementById('game-msg');
                const cd = setInterval(() => {
                    msgEl.innerText = count > 0 ? count : "GO!";
                    if (count === 0) {
                        clearInterval(cd);
                        setTimeout(() => msgEl.innerText = "", 1000);
                        startTimer();
                    }
                    count--;
                }, 1000);
            };

            function startTimer() {
                update(ref(db, `shake/${roomId}/state`), { status: 'running' });
                let timeLeft = 10;
                const timerEl = document.getElementById('timer');
                
                const timer = setInterval(() => {
                    timeLeft--;
                    timerEl.innerText = timeLeft;
                    if (timeLeft <= 0) {
                        clearInterval(timer);
                        finishGame();
                    }
                }, 1000);
            }

            function finishGame() {
                update(ref(db, `shake/${roomId}/state`), { status: 'finished' });
                document.getElementById('game-msg').innerText = "FINISH!";
                
                // ÂãùËÄÖÂà§ÂÆö
                onValue(ref(db, `shake/${roomId}/players`), (snap) => {
                    const players = snap.val();
                    let winnerId = null;
                    let top = -1;
                    Object.keys(players).forEach(id => {
                        if (players[id].count > top) {
                            top = players[id].count;
                            winnerId = id;
                        }
                    });
                    if (winnerId) {
                        update(ref(db, `shake/${roomId}/players/${winnerId}`), { isWinner: true });
                    }
                    
                    setTimeout(() => {
                        document.getElementById('lobby-ui').classList.remove('hidden');
                        document.getElementById('game-msg').innerText = "";
                        document.getElementById('timer').innerText = "10";
                    }, 5000);
                }, { onlyOnce: true });
            }
        }

        // ============================================
        // CONTROLLER LOGIC
        // ============================================
        else {
            document.getElementById('ctrl-view').classList.remove('hidden');
            let myName = "";
            let myCount = 0;
            let currentStatus = 'lobby';

            window.submitName = () => {
                const input = document.getElementById('user-name');
                if (!input.value) return alert("ÂêçÂâç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ");
                myName = input.value;
                document.getElementById('name-step').classList.add('hidden');
                
                // iOS„Çª„É≥„Çµ„ÉºË®±ÂèØ„ÅÆÁ¢∫Ë™ç
                if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
                    document.getElementById('perm-step').classList.remove('hidden');
                } else {
                    joinGame();
                }
            };

            window.requestPermission = async () => {
                const res = await DeviceMotionEvent.requestPermission();
                if (res === 'granted') {
                    document.getElementById('perm-step').classList.add('hidden');
                    joinGame();
                }
            };

            function joinGame() {
                document.getElementById('game-step').classList.remove('hidden');
                const pRef = ref(db, `shake/${roomId}/players/${myId}`);
                set(pRef, { name: myName, count: 0 });
                onDisconnect(pRef).remove();

                // „Ç≤„Éº„É†Áä∂ÊÖã„ÅÆÂêåÊúü
                onValue(ref(db, `shake/${roomId}/state`), (snap) => {
                    const s = snap.val() || {};
                    currentStatus = s.status;
                    const msgEl = document.getElementById('ctrl-msg');

                    if (currentStatus === 'ready') {
                        myCount = 0;
                        document.getElementById('ctrl-score').innerText = "0";
                        msgEl.innerText = "READY...";
                    } else if (currentStatus === 'running') {
                        msgEl.innerText = "SHAKE IT!!";
                    } else if (currentStatus === 'finished') {
                        msgEl.innerText = "FINISH!";
                    } else {
                        msgEl.innerText = "„Éõ„Çπ„Éà„ÅÆÈñãÂßãÂæÖ„Å°...";
                    }
                });

                startSensor();
            }

            function startSensor() {
                let lastX=0, lastY=0, lastZ=0;
                let lastSend = 0;

                window.addEventListener('devicemotion', (e) => {
                    if (currentStatus !== 'running') return;

                    const acc = e.accelerationIncludingGravity || e.acceleration;
                    if (!acc) return;

                    const delta = Math.abs(acc.x - lastX) + Math.abs(acc.y - lastY) + Math.abs(acc.z - lastZ);
                    
                    if (delta > 20) {
                        myCount++;
                        document.getElementById('ctrl-score').innerText = myCount;
                        const circle = document.getElementById('shake-circle');
                        circle.classList.add('shake-active');
                        setTimeout(() => circle.classList.remove('shake-active'), 50);

                        const now = Date.now();
                        if (now - lastSend > 100) {
                            update(ref(db, `shake/${roomId}/players/${myId}`), { count: myCount });
                            lastSend = now;
                        }
                    }
                    lastX = acc.x; lastY = acc.y; lastZ = acc.z;
                });
            }
        }
    </script>
</body>
</html>
