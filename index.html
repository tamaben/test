<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Party Box 9</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    
    <style>
        /* === ãƒ‡ã‚¶ã‚¤ãƒ³ã‚·ã‚¹ãƒ†ãƒ  === */
        :root {
            --bg: #121212;
            --surface: #1e1e1e;
            --primary: #70a1ff;
            --accent: #ff4757;
            --text: #ffffff;
            --subtext: #a4b0be;
            --success: #2ed573;
        }

        * { box-sizing: border-box; touch-action: manipulation; }
        
        body {
            margin: 0; padding: 0;
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Inter', sans-serif;
            overflow: hidden; /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å®Œå…¨ç¦æ­¢ */
            user-select: none;
            -webkit-user-select: none;
        }

        /* ç”»é¢å…±é€š */
        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 20px; transition: opacity 0.5s;
        }
        .hidden { display: none !important; opacity: 0; pointer-events: none; }

        h1 { font-weight: 900; font-size: 3rem; margin: 0; letter-spacing: -2px; background: linear-gradient(45deg, var(--primary), #a29bfe); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        h2 { font-size: 2rem; margin-bottom: 10px; }
        p { color: var(--subtext); font-size: 1.1rem; max-width: 600px; line-height: 1.6; }

        /* ãƒœã‚¿ãƒ³ */
        .btn {
            background: var(--surface); color: var(--text); border: 1px solid rgba(255,255,255,0.1);
            padding: 15px 40px; font-size: 1.2rem; border-radius: 50px; cursor: pointer;
            margin: 10px; transition: all 0.2s; font-weight: bold;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        .btn:active { transform: scale(0.95); }
        .btn-primary { background: var(--primary); color: #000; border: none; }
        .btn-big { font-size: 2rem; padding: 30px 60px; }
        .btn-full { width: 100%; height: 100%; font-size: 3rem; border-radius: 20px; background: var(--accent); }

        /* --- ãƒ›ã‚¹ãƒˆç”»é¢ --- */
        #host-lobby .qr-container { background: white; padding: 15px; border-radius: 10px; margin: 20px; }
        .player-grid { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; margin-top: 20px; }
        .player-badge { background: var(--surface); padding: 8px 16px; border-radius: 20px; border: 1px solid var(--primary); animation: pop 0.3s; }

        /* ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆ */
        #roulette-wheel {
            font-size: 4rem; font-weight: 900; color: var(--accent);
            height: 150px; display: flex; align-items: center; justify-content: center;
            text-shadow: 0 0 20px rgba(255,71,87,0.5);
        }

        /* ã‚²ãƒ¼ãƒ ç”»é¢ */
        .game-info { position: absolute; top: 20px; width: 100%; text-align: center; }
        .timer-bar { width: 0%; height: 10px; background: var(--primary); position: absolute; top: 0; left: 0; transition: width 0.1s linear; }
        
        .score-board { font-size: 3rem; font-weight: bold; }
        
        /* ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆãƒ«ãƒ¼ãƒ«èª¬æ˜ï¼‰ */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 100;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .modal-content { background: var(--surface); padding: 40px; border-radius: 20px; max-width: 80%; text-align: center; }
        .rule-icon { font-size: 4rem; margin-bottom: 20px; }

        /* --- ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆç”»é¢ --- */
        .input-area { width: 100%; max-width: 400px; }
        input[type="text"] {
            width: 100%; padding: 15px; border-radius: 10px; border: none;
            background: #333; color: white; font-size: 1.2rem; margin-bottom: 20px; text-align: center;
        }

        /* ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼UI */
        #ctrl-tap { background: var(--accent); }
        #ctrl-shake { background: var(--success); display: flex; align-items: center; justify-content: center; flex-direction: column; }
        #ctrl-gyro { background: var(--primary); position: relative; }
        .bubble-level { 
            width: 50px; height: 50px; background: white; border-radius: 50%;
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            transition: all 0.1s;
        }
        #ctrl-werewolf { display: flex; flex-direction: column; gap: 10px; }
        .role-card { padding: 30px; background: #333; border-radius: 10px; margin-bottom: 20px; font-size: 2rem; }

        @keyframes pop { 0% { transform: scale(0); } 100% { transform: scale(1); } }
        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }
    </style>
</head>
<body>

    <div id="host-view" class="hidden">
        <div id="host-lobby" class="screen">
            <h1>PARTY BOX 9</h1>
            <p>ã‚¹ãƒãƒ›ã§QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã£ã¦å‚åŠ ã—ã‚ˆã†</p>
            <div class="qr-container" id="qrcode"></div>
            <div class="player-grid" id="player-list"></div>
            <button class="btn btn-primary btn-big" onclick="Host.startRoulette()" id="btn-start-game" disabled>å‚åŠ è€…ã‚’å¾…æ©Ÿä¸­...</button>
        </div>

        <div id="host-pregame" class="screen hidden">
            <h2>NEXT GAME</h2>
            <div id="roulette-wheel">???</div>
        </div>

        <div id="rule-modal" class="modal hidden">
            <div class="modal-content">
                <div class="rule-icon" id="rule-icon">ğŸ®</div>
                <h2 id="rule-title">ã‚¿ã‚¤ãƒˆãƒ«</h2>
                <p id="rule-desc">èª¬æ˜æ–‡</p>
                <button class="btn btn-primary" onclick="Host.launchGame()">START!</button>
            </div>
        </div>

        <div id="host-game" class="screen hidden">
            <div class="timer-bar" id="game-timer"></div>
            <div class="game-info">
                <h2 id="game-title-display">TITLE</h2>
                <div id="game-status"></div>
            </div>
            <div id="game-stage" style="width: 100%; height: 60%; display: flex; justify-content: center; align-items: center;">
                <div class="score-board" id="score-board"></div>
            </div>
        </div>

        <div id="host-result" class="screen hidden">
            <h1>RESULT</h1>
            <div id="winner-display" style="font-size: 4rem; margin: 40px 0; color: var(--primary);"></div>
            <button class="btn" onclick="Host.backToLobby()">ãƒ­ãƒ“ãƒ¼ã«æˆ»ã‚‹</button>
        </div>
    </div>

    <div id="client-view" class="hidden">
        <div id="client-login" class="screen">
            <h1>JOIN</h1>
            <div class="input-area">
                <input type="text" id="username" placeholder="ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ " maxlength="8">
                <button class="btn btn-primary btn-full" style="height: auto; font-size: 1.5rem;" onclick="Client.join()">å‚åŠ </button>
            </div>
        </div>

        <div id="client-permission" class="screen hidden">
            <h2>ã‚»ãƒ³ã‚µãƒ¼è¨±å¯</h2>
            <p>ã‚²ãƒ¼ãƒ ã§ã‚¹ãƒãƒ›ã‚’æŒ¯ã£ãŸã‚Šå‚¾ã‘ãŸã‚Šã™ã‚‹ãŸã‚ã«ã€ã‚»ãƒ³ã‚µãƒ¼ã®ä½¿ç”¨ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚</p>
            <button class="btn btn-primary" onclick="Client.requestPermission()">è¨±å¯ã—ã¦é€²ã‚€</button>
        </div>

        <div id="client-waiting" class="screen hidden">
            <h2>WAITING...</h2>
            <p>è¦ªæ©Ÿã®ç”»é¢ã‚’è¦‹ã¦ã­</p>
        </div>

        <div id="ctrl-tap" class="screen hidden">
            <div style="pointer-events: none; font-size: 3rem; color: rgba(255,255,255,0.5);">TAP!</div>
        </div>

        <div id="ctrl-shake" class="screen hidden">
            <div style="font-size: 4rem;">ğŸ‘‹</div>
            <p>æŒ¯ã‚Œï¼ï¼</p>
        </div>

        <div id="ctrl-gyro" class="screen hidden">
            <div class="bubble-level" id="gyro-bubble"></div>
        </div>

        <div id="ctrl-werewolf" class="screen hidden">
            <h2>ã‚ãªãŸã®å½¹è·</h2>
            <div class="role-card" id="my-role">?</div>
            <p>æ€ªã—ã„äººã‚’ã‚¿ãƒƒãƒ—ã—ã¦æŠ•ç¥¨</p>
            <div id="vote-list" style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;"></div>
        </div>
    </div>

<script>
    // ================= ã‚²ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ =================
    const GAMES = [
        { id: 'tap_race', name: 'é€£æ‰“ãƒ¬ãƒ¼ã‚¹', type: 'tap', desc: 'ç”»é¢ã‚’ã²ãŸã™ã‚‰é€£æ‰“ã—ã‚ï¼ä¸€ç•ªå¤šãå©ã„ãŸäººã®å‹ã¡ï¼', icon: 'ğŸ‘†' },
        { id: 'shake_battle', name: 'ã‚·ã‚§ã‚¤ã‚¯ãƒãƒˆãƒ«', type: 'shake', desc: 'ã‚¹ãƒãƒ›ã‚’å…¨åŠ›ã§æŒ¯ã‚Œï¼å›æ•°ãŒä¸€ç•ªå¤šã„äººãŒå„ªå‹ï¼(é£›ã°ã•ãªã„ã§ã­)', icon: 'ğŸ‘‹' },
        { id: 'balance', name: 'ãƒãƒ©ãƒ³ã‚¹ç‹', type: 'gyro', desc: 'ã‚¹ãƒãƒ›ã‚’åœ°é¢ã¨æ°´å¹³ã«ä¿ã¦ï¼ä¸€ç•ªå®‰å®šã—ã¦ã„ãŸäººãŒå‹ã¡ã€‚', icon: 'âš–ï¸' },
        { id: 'reflex', name: 'æ—©æŠ¼ã—åå¿œ', type: 'tap', desc: 'è¦ªæ©Ÿã®ç”»é¢ã®è‰²ãŒå¤‰ã‚ã£ãŸç¬é–“ã«ã‚¿ãƒƒãƒ—ï¼ãŠæ‰‹ã¤ãå³ç¦ã€‚', icon: 'âš¡' },
        { id: 'bomb', name: 'çˆ†å¼¾å›ã—', type: 'shake', desc: 'æŒ¯ã£ã¦çˆ†å¼¾ã‚’éš£ã®äººã¸ãƒ‘ã‚¹ï¼çˆ†ç™ºã—ãŸæ™‚ã«æŒã£ã¦ã„ãŸäººã®è² ã‘ã€‚', icon: 'ğŸ’£' },
        { id: 'timer_stop', name: '10ç§’ã‚¸ãƒ£ã‚¹ãƒˆ', type: 'tap', desc: 'ä½“å†…æ™‚è¨ˆã§10ç§’ãƒ”ãƒƒã‚¿ãƒªã§æ­¢ã‚ã‚ï¼', icon: 'â±ï¸' },
        { id: 'tug_war', name: 'ãƒãƒ¼ãƒ ç¶±å¼•ã', type: 'tap', desc: 'èµ¤ãƒãƒ¼ãƒ vsé’ãƒãƒ¼ãƒ ï¼åˆè¨ˆé€£æ‰“æ•°ã§å‹è² ï¼', icon: 'ğŸš©' },
        { id: 'survival', name: 'å‚¾ãã‚µãƒã‚¤ãƒãƒ«', type: 'gyro', desc: 'æŒ‡å®šã•ã‚ŒãŸæ–¹å‘ã«å‚¾ã‘ç¶šã‘ã‚ï¼è„±è½ã—ãŸã‚‰è² ã‘ã€‚', icon: 'ğŸ§­' },
        { id: 'werewolf', name: 'ãƒ¯ãƒ³ãƒŠã‚¤ãƒˆäººç‹¼', type: 'werewolf', desc: 'èª°ãŒäººç‹¼ã‹è©±ã—åˆãˆï¼æœ€å¾Œã«æŠ•ç¥¨ã§è¿½æ”¾è€…ã‚’æ±ºã‚ã‚‹ã€‚', icon: 'ğŸº' }
    ];

    // ================= å…±é€šå‡¦ç† =================
    const Utils = {
        // IDç”Ÿæˆ
        generateId: () => Math.random().toString(36).substr(2, 5).toUpperCase(),
        // é…åˆ—ã‚·ãƒ£ãƒƒãƒ•ãƒ«
        shuffle: (array) => array.sort(() => Math.random() - 0.5),
        // éŸ³å†ç”Ÿ(ç°¡æ˜“ã‚·ãƒ³ã‚»)
        playTone: (freq, type, dur) => {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.frequency.value = freq;
            osc.type = type;
            osc.connect(gain);
            gain.connect(ctx.destination);
            osc.start();
            gain.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + dur);
            osc.stop(ctx.currentTime + dur);
        }
    };

    // ã‚¹ãƒãƒ›ã®ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—æ‹¡å¤§ãªã©ã®é˜²æ­¢
    document.addEventListener('dblclick', function(event) { event.preventDefault(); }, { passive: false });
    document.addEventListener('gesturestart', function(e) { e.preventDefault(); });

    // ================= HOST (è¦ªæ©Ÿ) =================
    const Host = {
        peer: null,
        id: null,
        conns: {},
        players: {}, // { id: { name, score, ... } }
        currentGame: null,
        gameLoop: null,
        state: 'lobby',

        init: () => {
            document.getElementById('host-view').classList.remove('hidden');
            Host.peer = new Peer(Utils.generateId());
            
            Host.peer.on('open', (id) => {
                Host.id = id;
                const url = `${location.protocol}//${location.host}${location.pathname}?host=${id}`;
                new QRCode(document.getElementById("qrcode"), { text: url, width: 150, height: 150 });
                console.log('Host initialized:', id);
            });

            Host.peer.on('connection', (conn) => {
                conn.on('open', () => {
                    Host.conns[conn.peer] = conn;
                    conn.on('data', (data) => Host.handleData(conn.peer, data));
                    conn.on('close', () => {
                        delete Host.conns[conn.peer];
                        delete Host.players[conn.peer];
                        Host.updateLobby();
                    });
                });
            });
        },

        handleData: (pid, data) => {
            // å‚åŠ å‡¦ç†
            if (data.act === 'join') {
                Host.players[pid] = { name: data.name, id: pid, score: 0, role: null };
                Host.updateLobby();
                Utils.playTone(800, 'sine', 0.1);
            }
            // ã‚²ãƒ¼ãƒ å…¥åŠ›å‡¦ç†
            if (Host.state === 'gaming' && Host.currentGame) {
                Host.processGameInput(pid, data);
            }
        },

        updateLobby: () => {
            const list = document.getElementById('player-list');
            list.innerHTML = '';
            const count = Object.keys(Host.players).length;
            
            Object.values(Host.players).forEach(p => {
                const el = document.createElement('div');
                el.className = 'player-badge';
                el.innerText = p.name;
                list.appendChild(el);
            });

            const btn = document.getElementById('btn-start-game');
            if (count > 0) {
                btn.disabled = false;
                btn.innerText = `ã‚²ãƒ¼ãƒ é–‹å§‹ (${count}äºº)`;
            } else {
                btn.disabled = true;
                btn.innerText = "å‚åŠ è€…ã‚’å¾…æ©Ÿä¸­...";
            }
        },

        // --- ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆ & æº–å‚™ ---
        startRoulette: () => {
            Host.state = 'roulette';
            document.getElementById('host-lobby').classList.add('hidden');
            document.getElementById('host-result').classList.add('hidden');
            document.getElementById('host-pregame').classList.remove('hidden');

            const wheel = document.getElementById('roulette-wheel');
            let counter = 0;
            const interval = setInterval(() => {
                const randomGame = GAMES[Math.floor(Math.random() * GAMES.length)];
                wheel.innerText = randomGame.name;
                wheel.style.color = counter % 2 === 0 ? '#ff4757' : '#70a1ff';
                Utils.playTone(400, 'square', 0.05);
                counter++;
                if (counter > 20) {
                    clearInterval(interval);
                    Host.showRule(GAMES[Math.floor(Math.random() * GAMES.length)]); // æœ€çµ‚æ±ºå®š
                }
            }, 100);
        },

        showRule: (gameObj) => {
            Host.currentGame = gameObj;
            document.getElementById('rule-modal').classList.remove('hidden');
            document.getElementById('rule-icon').innerText = gameObj.icon;
            document.getElementById('rule-title').innerText = gameObj.name;
            document.getElementById('rule-desc').innerText = gameObj.desc;
        },

        // --- ã‚²ãƒ¼ãƒ é–‹å§‹ ---
        launchGame: () => {
            document.getElementById('rule-modal').classList.add('hidden');
            document.getElementById('host-pregame').classList.add('hidden');
            document.getElementById('host-game').classList.remove('hidden');
            Host.state = 'gaming';

            // å…¨å“¡ã®çŠ¶æ…‹ãƒªã‚»ãƒƒãƒˆ
            Object.values(Host.players).forEach(p => { p.score = 0; p.vote = null; });
            document.getElementById('score-board').innerText = '';
            
            // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
            Host.broadcast({ act: 'start', mode: Host.currentGame.type, gameId: Host.currentGame.id });

            // ã‚²ãƒ¼ãƒ ã”ã¨ã®åˆæœŸåŒ–
            document.getElementById('game-title-display').innerText = Host.currentGame.name;
            Host.startGameLogic();
        },

        startGameLogic: () => {
            const game = Host.currentGame;
            
            // äººç‹¼ã®å ´åˆ
            if (game.id === 'werewolf') {
                Host.setupWerewolf();
                return;
            }

            // é€šå¸¸ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚²ãƒ¼ãƒ ï¼ˆã‚¿ã‚¤ãƒãƒ¼åˆ¶ï¼‰
            let time = 10; 
            if (game.id === 'timer_stop') time = 15;
            
            const timerBar = document.getElementById('game-timer');
            timerBar.style.width = '100%';
            
            // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³
            let timeLeft = time;
            Host.gameLoop = setInterval(() => {
                timeLeft -= 0.1;
                timerBar.style.width = (timeLeft / time * 100) + '%';
                
                // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚¹ã‚³ã‚¢è¡¨ç¤ºï¼ˆé€£æ‰“ç³»ã®ã¿ï¼‰
                if (game.type === 'tap' || game.type === 'shake') {
                    Host.updateRealtimeScore();
                }

                if (timeLeft <= 0) {
                    clearInterval(Host.gameLoop);
                    Host.finishGame();
                }
            }, 100);
        },

        processGameInput: (pid, data) => {
            const p = Host.players[pid];
            const g = Host.currentGame;

            if (g.type === 'tap' && data.act === 'tap') {
                p.score++;
            }
            if (g.type === 'shake' && data.act === 'shake') {
                p.score += data.val; // å¼·ã•ã«å¿œã˜ã¦
            }
            if (g.type === 'gyro' && data.act === 'gyro') {
                // ãƒãƒ©ãƒ³ã‚¹: 0ã«è¿‘ã„ã»ã©é«˜å¾—ç‚¹ï¼ˆã“ã“ã§ã¯çµ¶å¯¾å€¤ã‚’ç´¯ç©ã—ã€ä½ã„ã»ã†ãŒå‹ã¡ï¼‰
                const tilt = Math.abs(data.beta) + Math.abs(data.gamma);
                p.score += tilt; 
            }
            if (g.id === 'werewolf' && data.act === 'vote') {
                p.vote = data.target;
                Host.checkWerewolfEnd();
            }
        },

        updateRealtimeScore: () => {
            // ä¸Šä½3åã‚’è¡¨ç¤º
            const sorted = Object.values(Host.players).sort((a,b) => b.score - a.score).slice(0,3);
            const board = document.getElementById('score-board');
            board.innerHTML = sorted.map((p, i) => 
                `<div style="font-size:${3-i}rem">${i+1}. ${p.name}: ${Math.floor(p.score)}</div>`
            ).join('');
        },

        // --- äººç‹¼ãƒ­ã‚¸ãƒƒã‚¯ ---
        setupWerewolf: () => {
            const pIds = Object.keys(Host.players);
            if(pIds.length < 3) {
                alert("äººç‹¼ã¯3äººä»¥ä¸Šå¿…è¦ã§ã™ã€‚å‹ã¡åˆ¤å®šã«ã—ã¾ã™ã€‚");
                Host.finishGame(); 
                return;
            }
            
            // å½¹è·å‰²ã‚Šå½“ã¦ (äººç‹¼1ã€ä»–å¸‚æ°‘)
            const wolfIndex = Math.floor(Math.random() * pIds.length);
            const wolfId = pIds[wolfIndex];
            
            pIds.forEach(pid => {
                const role = (pid === wolfId) ? 'äººç‹¼' : 'å¸‚æ°‘';
                Host.players[pid].role = role;
                // å€‹åˆ¥ã«å½¹è·é€šçŸ¥
                if (Host.conns[pid]) {
                    Host.conns[pid].send({ act: 'role_assign', role: role, players: Host.players });
                }
            });

            document.getElementById('score-board').innerHTML = "<div style='font-size:2rem'>è©±ã—åˆã„ã‚¿ã‚¤ãƒ : 30ç§’<br>èª°ãŒäººç‹¼ã‹æ¢ã›ï¼</div>";
            
            setTimeout(() => {
                Host.broadcast({ act: 'start_vote' });
                document.getElementById('score-board').innerText = "æŠ•ç¥¨ä¸­...";
            }, 30000);
        },

        checkWerewolfEnd: () => {
            const allVoted = Object.values(Host.players).every(p => p.vote);
            if (allVoted) Host.finishGame();
        },

        // --- ã‚²ãƒ¼ãƒ çµ‚äº†ãƒ»çµæœ ---
        finishGame: () => {
            clearInterval(Host.gameLoop);
            Host.state = 'result';
            document.getElementById('host-game').classList.add('hidden');
            document.getElementById('host-result').classList.remove('hidden');
            
            Host.broadcast({ act: 'end' });
            Utils.playTone(600, 'square', 0.5);

            const display = document.getElementById('winner-display');
            const g = Host.currentGame;
            let winnerText = "";

            if (g.id === 'werewolf') {
                // æœ€å¤šå¾—ç¥¨è€…ã‚’è¨ˆç®—
                const votes = {};
                Object.values(Host.players).forEach(p => {
                    votes[p.vote] = (votes[p.vote] || 0) + 1;
                });
                const executedId = Object.keys(votes).reduce((a, b) => votes[a] > votes[b] ? a : b);
                const wolf = Object.values(Host.players).find(p => p.role === 'äººç‹¼');
                
                if (executedId === wolf.id) {
                    winnerText = `å¸‚æ°‘ã®å‹ã¡ï¼\n(äººç‹¼ã¯ ${wolf.name} ã§ã—ãŸ)`;
                    display.style.color = "#2ed573";
                } else {
                    winnerText = `äººç‹¼ã®å‹ã¡ï¼\n(äººç‹¼ã¯ ${wolf.name} ã§ã—ãŸ)`;
                    display.style.color = "#ff4757";
                }

            } else if (g.type === 'gyro' && g.id === 'balance') {
                // ã‚¹ã‚³ã‚¢ãŒä½ã„ï¼ˆå‚¾ããŒå°‘ãªã„ï¼‰äººãŒå‹ã¡
                const sorted = Object.values(Host.players).sort((a,b) => a.score - b.score);
                winnerText = `WINNER: ${sorted[0].name}`;
            } else {
                // ã‚¹ã‚³ã‚¢ãŒé«˜ã„äººãŒå‹ã¡
                const sorted = Object.values(Host.players).sort((a,b) => b.score - a.score);
                winnerText = `WINNER: ${sorted[0].name}`;
            }

            display.innerText = winnerText;
        },

        backToLobby: () => {
            Host.state = 'lobby';
            document.getElementById('host-result').classList.add('hidden');
            document.getElementById('host-lobby').classList.remove('hidden');
        },

        broadcast: (data) => {
            Object.values(Host.conns).forEach(c => c.send(data));
        }
    };

    // ================= CLIENT (å­æ©Ÿ) =================
    const Client = {
        peer: null,
        conn: null,
        myId: null,

        init: () => {
            const params = new URLSearchParams(window.location.search);
            const hostId = params.get('host');
            
            if (hostId) {
                // QRã‹ã‚‰æ¥ãŸå ´åˆ
                document.getElementById('client-view').classList.remove('hidden');
                Client.peer = new Peer(); // IDè‡ªå‹•ç”Ÿæˆ
                Client.peer.on('open', (id) => {
                    Client.myId = id;
                    Client.conn = Client.peer.connect(hostId);
                    Client.setupConnection();
                });
            } else {
                // ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãªã—ã¯è¦ªæ©Ÿãƒ¢ãƒ¼ãƒ‰ã¸
                Host.init();
            }
        },

        setupConnection: () => {
            Client.conn.on('open', () => {
                console.log("Connected to Host");
            });
            Client.conn.on('data', (data) => Client.handleHostData(data));
            Client.conn.on('close', () => alert("è¦ªæ©Ÿã¨ã®æ¥ç¶šãŒåˆ‡ã‚Œã¾ã—ãŸ"));
        },

        join: () => {
            const name = document.getElementById('username').value || "Guest";
            // iOSç­‰ã§ã‚»ãƒ³ã‚µãƒ¼è¨±å¯ãŒå¿…è¦ã‹ãƒã‚§ãƒƒã‚¯
            if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
                document.getElementById('client-login').classList.add('hidden');
                document.getElementById('client-permission').classList.remove('hidden');
            } else {
                Client.finalizeJoin(name);
            }
        },

        requestPermission: () => {
            // iOS 13+ ã‚¸ãƒ£ã‚¤ãƒ­è¨±å¯
            DeviceMotionEvent.requestPermission()
                .then(response => {
                    if (response == 'granted') {
                        Client.finalizeJoin(document.getElementById('username').value);
                    } else {
                        alert("è¨±å¯ã•ã‚Œãªã„ã¨éŠã¹ãªã„ã‚²ãƒ¼ãƒ ãŒã‚ã‚Šã¾ã™");
                    }
                })
                .catch(console.error);
        },

        finalizeJoin: (name) => {
            Client.conn.send({ act: 'join', name: name });
            document.getElementById('client-login').classList.add('hidden');
            document.getElementById('client-permission').classList.add('hidden');
            document.getElementById('client-waiting').classList.remove('hidden');
            Client.initSensors();
        },

        handleHostData: (data) => {
            if (data.act === 'start') {
                Client.showController(data.mode);
            } else if (data.act === 'end') {
                Client.resetScreens();
            } else if (data.act === 'role_assign') {
                // äººç‹¼ç”¨
                Client.showWerewolfCtrl(data.role, data.players);
            } else if (data.act === 'start_vote') {
                alert("æŠ•ç¥¨ã—ã¦ãã ã•ã„ï¼");
            }
        },

        showController: (mode) => {
            document.getElementById('client-waiting').classList.add('hidden');
            document.querySelectorAll('.screen').forEach(el => {
                if(el.id.startsWith('ctrl-')) el.classList.add('hidden');
            });

            if (mode === 'tap') {
                const el = document.getElementById('ctrl-tap');
                el.classList.remove('hidden');
                el.onclick = () => {
                    Client.conn.send({ act: 'tap' });
                    Utils.playTone(300, 'triangle', 0.05);
                    navigator.vibrate(50);
                };
            }
            if (mode === 'shake') document.getElementById('ctrl-shake').classList.remove('hidden');
            if (mode === 'gyro') document.getElementById('ctrl-gyro').classList.remove('hidden');
            if (mode === 'werewolf') document.getElementById('ctrl-werewolf').classList.remove('hidden');
        },

        showWerewolfCtrl: (role, players) => {
            document.getElementById('client-waiting').classList.add('hidden');
            const el = document.getElementById('ctrl-werewolf');
            el.classList.remove('hidden');
            
            const roleCard = document.getElementById('my-role');
            roleCard.innerText = role;
            roleCard.style.color = (role === 'äººç‹¼') ? '#ff4757' : '#2ed573';

            const list = document.getElementById('vote-list');
            list.innerHTML = '';
            Object.values(players).forEach(p => {
                if (p.id === Client.myId) return; // è‡ªåˆ†ã«ã¯æŠ•ç¥¨ä¸å¯
                const btn = document.createElement('button');
                btn.className = 'btn';
                btn.innerText = p.name;
                btn.onclick = () => {
                    if(confirm(`${p.name} ã«æŠ•ç¥¨ã—ã¾ã™ã‹ï¼Ÿ`)) {
                        Client.conn.send({ act: 'vote', target: p.id });
                        list.innerHTML = "<p>æŠ•ç¥¨å®Œäº†ã€‚çµæœã‚’å¾…ã¦ã€‚</p>";
                    }
                };
                list.appendChild(btn);
            });
        },

        resetScreens: () => {
            document.querySelectorAll('.screen').forEach(el => {
                if(el.id.startsWith('ctrl-')) el.classList.add('hidden');
            });
            document.getElementById('client-waiting').classList.remove('hidden');
        },

        initSensors: () => {
            // ã‚·ã‚§ã‚¤ã‚¯æ¤œçŸ¥ (åŠ é€Ÿåº¦)
            let lastX = 0, lastY = 0, lastZ = 0;
            window.addEventListener('devicemotion', (e) => {
                const acc = e.accelerationIncludingGravity;
                if (!acc) return;
                const delta = Math.abs(acc.x + acc.y + acc.z - lastX - lastY - lastZ);
                if (delta > 20) { // ã‚·ã‚§ã‚¤ã‚¯é–¾å€¤
                    Client.conn.send({ act: 'shake', val: 1 });
                    navigator.vibrate(50);
                }
                lastX = acc.x; lastY = acc.y; lastZ = acc.z;
            });

            // ã‚¸ãƒ£ã‚¤ãƒ­æ¤œçŸ¥ (å‚¾ã)
            window.addEventListener('deviceorientation', (e) => {
                if (document.getElementById('ctrl-gyro').classList.contains('hidden')) return;
                
                // ç”»é¢ä¸Šã®ãƒœãƒ¼ãƒ«ã‚’å‹•ã‹ã™
                const bubble = document.getElementById('gyro-bubble');
                const x = Math.min(Math.max(e.gamma, -45), 45); // å·¦å³
                const y = Math.min(Math.max(e.beta, -45), 45);  // å‰å¾Œ
                
                bubble.style.transform = `translate(calc(-50% + ${x*3}px), calc(-50% + ${y*3}px))`;
                
                // ãƒ‡ãƒ¼ã‚¿é€ä¿¡ (é »åº¦åˆ¶é™æ¨å¥¨ã ãŒç°¡æ˜“çš„ã«é€ã‚‹)
                Client.conn.send({ act: 'gyro', beta: e.beta, gamma: e.gamma });
            });
        }
    };

    // èµ·å‹•
    window.onload = Client.init;

</script>
</body>
</html>
