<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PARTY BOX: ULTRA</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Russo+One&family=M+PLUS+Rounded+1c:wght@500;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #050510;
            --primary: #00f0ff; /* Cyber Blue */
            --secondary: #ff0055; /* Cyber Pink */
            --accent: #ffee00; /* Cyber Yellow */
            --text: #fff;
            --font-head: 'Russo One', sans-serif;
            --font-body: 'M PLUS Rounded 1c', sans-serif;
        }

        * { box-sizing: border-box; touch-action: none; user-select: none; -webkit-user-select: none; }
        body {
            margin: 0; padding: 0; background: var(--bg); color: var(--text);
            font-family: var(--font-body); overflow: hidden; height: 100vh; width: 100vw;
        }

        /* UI Utilities */
        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: radial-gradient(circle at center, #1a1b2e 0%, #000 100%);
            transition: opacity 0.4s, transform 0.4s; opacity: 1; z-index: 10;
        }
        .hidden { opacity: 0; pointer-events: none; z-index: -1; transform: scale(0.9); }

        h1 { font-family: var(--font-head); font-size: 3.5rem; text-align: center; margin: 0; text-shadow: 0 0 20px var(--primary); line-height: 1; }
        h2 { font-family: var(--font-head); color: var(--secondary); font-size: 2rem; margin: 10px; text-transform: uppercase; }
        p { font-size: 1.2rem; color: #aaa; text-align: center; margin: 10px; max-width: 90%; }

        .btn {
            background: rgba(255,255,255,0.05); border: 2px solid var(--primary); color: var(--primary);
            padding: 20px 40px; font-size: 1.5rem; font-family: var(--font-head);
            cursor: pointer; margin: 15px; border-radius: 50px; transition: 0.2s;
            box-shadow: 0 0 15px rgba(0, 240, 255, 0.2); width: 80%; max-width: 400px;
        }
        .btn:active { transform: scale(0.95); background: var(--primary); color: #000; }
        .btn-pink { border-color: var(--secondary); color: var(--secondary); }
        .btn-pink:active { background: var(--secondary); }

        /* HOST SPECIFIC */
        .game-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px;
            width: 90%; max-width: 1000px; padding: 20px; overflow-y: auto; max-height: 60vh;
        }
        .game-card {
            background: #222; border: 1px solid #444; border-radius: 10px; padding: 15px;
            text-align: center; cursor: pointer; transition: 0.3s;
        }
        .game-card:hover { border-color: var(--accent); background: #333; transform: translateY(-5px); }
        .g-icon { font-size: 2.5rem; display: block; margin-bottom: 5px; }
        .g-name { font-size: 0.8rem; font-weight: bold; }

        .timer-bar { width: 100%; height: 15px; background: #222; position: fixed; top: 0; }
        .timer-fill { height: 100%; background: var(--primary); width: 100%; transition: width linear 0.1s; }
        .main-vis { font-size: 5rem; font-weight: bold; font-family: var(--font-head); text-shadow: 0 0 30px var(--primary); }
        
        /* CLIENT CONTROLS */
        #ctrl-area { width: 100%; height: 100%; display: flex; flex-direction: column; }
        .big-btn { 
            flex: 1; width: 100%; border: none; font-size: 3rem; font-weight: bold; 
            color: white; display: flex; align-items: center; justify-content: center;
        }
        .bg-red { background: #ff4757; } .bg-blue { background: #2e86de; } 
        .bg-green { background: #2ed573; } .bg-yellow { background: #ffa502; color: black; }
        
        /* Motion Indicators */
        .motion-instruction { font-size: 2rem; padding: 20px; text-align: center; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 0.7; } 50% { opacity: 1; transform: scale(1.05); } 100% { opacity: 0.7; } }
    </style>
</head>
<body>

<div id="screen-landing" class="screen">
    <h1>PARTY BOX<br><span style="color:var(--secondary)">ULTRA</span></h1>
    <p>ç©¶æ¥µã®ã‚¹ãƒãƒ›ãƒ»ãƒ‘ãƒ¼ãƒ†ã‚£ã‚²ãƒ¼ãƒ </p>
    <div id="landing-buttons">
        <button class="btn" onclick="App.modeHost()">ğŸ‘‘ éƒ¨å±‹ã‚’ä½œã‚‹ (HOST)</button>
        <button class="btn btn-pink" onclick="App.modeClient()">ğŸ“± éƒ¨å±‹ã«å…¥ã‚‹ (JOIN)</button>
    </div>
    <div id="client-connect-ui" class="hidden" style="width:100%; text-align:center;">
        <input type="text" id="room-id-input" placeholder="ROOM ID" style="padding:15px; font-size:1.5rem; text-align:center; width:60%; border-radius:10px; border:none;">
        <br>
        <button class="btn" onclick="Client.manualJoin()">æ¥ç¶š</button>
        <p id="conn-status">æ¥ç¶šå¾…æ©Ÿä¸­...</p>
        <div id="fallback-host" class="hidden">
            <p style="color:var(--secondary)">éƒ¨å±‹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚<br>ã‚ãªãŸãŒãƒ›ã‚¹ãƒˆã«ãªã‚Šã¾ã™ã‹ï¼Ÿ</p>
            <button class="btn" onclick="App.modeHost()">ğŸ‘‘ ä»Šã™ãéƒ¨å±‹ã‚’ä½œã‚‹</button>
        </div>
    </div>
</div>

<div id="host-app" class="hidden">
    <div id="h-lobby" class="screen">
        <h2>ROOM ID</h2>
        <h1 id="host-id-disp" style="color:var(--accent); font-size:5rem; letter-spacing:5px;">...</h1>
        <div style="background:white; padding:10px; border-radius:10px; margin:20px;">
            <div id="qrcode"></div>
        </div>
        <p>å‚åŠ è€…: <span id="p-count" style="color:var(--primary); font-size:2rem; font-weight:bold;">0</span> äºº</p>
        <button class="btn" onclick="Host.toMenu()">ã‚²ãƒ¼ãƒ é¸æŠã¸</button>
    </div>

    <div id="h-menu" class="screen hidden">
        <h2>SELECT GAME</h2>
        <div class="game-grid" id="game-list"></div>
        <button class="btn btn-pink" onclick="Host.startRandom()">ğŸ² ãƒ©ãƒ³ãƒ€ãƒ ãƒ»ãƒ„ã‚¢ãƒ¼</button>
    </div>

    <div id="h-stage" class="screen hidden">
        <div class="timer-bar"><div id="timer-fill" class="timer-fill"></div></div>
        <div id="stage-title" style="color:#aaa; position:absolute; top:30px;">TITLE</div>
        <div id="stage-visual" class="main-vis">READY</div>
        <div id="stage-sub" style="font-size:2rem; color:var(--accent); text-align:center; white-space:pre;"></div>
    </div>

    <div id="h-result" class="screen hidden">
        <h1 style="color:var(--primary)">WINNER</h1>
        <div id="winner-name" style="font-size:4rem; margin:30px 0;">???</div>
        <button class="btn" onclick="Host.toMenu()">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</button>
    </div>
</div>

<div id="client-app" class="hidden">
    <div id="c-name" class="screen">
        <h2>PLAYER NAME</h2>
        <input type="text" id="username" maxlength="8" placeholder="åå‰ã‚’å…¥åŠ›" style="padding:15px; font-size:1.5rem; text-align:center; width:80%;">
        <br>
        <p style="font-size:0.9rem; color:#ff4757;">â€»iPhoneã®æ–¹ã¯æ¬¡ã®ç”»é¢ã§<br>ã€Œã‚»ãƒ³ã‚µãƒ¼è¨±å¯ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„</p>
        <button class="btn" onclick="Client.submitName()">OK</button>
    </div>

    <div id="c-perm" class="screen hidden">
        <h2>ã‚»ãƒ³ã‚µãƒ¼æº–å‚™</h2>
        <p>ä½“ã‚’å‹•ã‹ã™ã‚²ãƒ¼ãƒ ã®ãŸã‚ã«<br>ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³ã‚»ãƒ³ã‚µãƒ¼ã‚’ä½¿ã„ã¾ã™ã€‚</p>
        <button class="btn btn-pink" onclick="Client.reqPerm()">è¨±å¯ã—ã¦ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
    </div>

    <div id="c-wait" class="screen hidden">
        <h2 style="animation:pulse 1s infinite">WAITING...</h2>
        <p>ãƒ›ã‚¹ãƒˆã®ç”»é¢ã‚’è¦‹ã¦ãã ã•ã„</p>
    </div>

    <div id="c-ctrl" class="screen hidden" style="background:#000;">
        <div id="ctrl-area"></div>
    </div>
</div>

<script>
/* ==================== GAME DATA ==================== */
const GAMES = [
    // --- Body / Sensor Games ---
    { id: 'squat', name: 'ã‚¹ã‚¯ãƒ¯ãƒƒãƒˆãƒ»ãƒãƒˆãƒ«', icon: 'ğŸ‹ï¸', type: 'motion', mode:'squat', desc: 'ã‚¹ãƒãƒ›ã‚’æŒã£ã¦ã—ã‚ƒãŒã‚“ã§ç«‹ã¦ï¼' },
    { id: 'run', name: 'ãã®å ´ãƒ€ãƒƒã‚·ãƒ¥', icon: 'ğŸƒ', type: 'motion', mode:'shake_hard', desc: 'ãã®å ´ã§çŒ›çƒˆã«è¶³è¸ã¿ã—ã‚ï¼' },
    { id: 'spin', name: 'ã‚¹ãƒ”ãƒ³ãƒ»ãƒã‚¹ã‚¿ãƒ¼', icon: 'ğŸŒªï¸', type: 'gyro', mode:'spin', desc: 'ãã®å ´ã§ãã‚‹ãã‚‹å›è»¢ã—ã‚ï¼(ç›®ã¯å›ã™ãª)' },
    { id: 'ninja', name: 'å¿è€…ã‚¦ã‚©ãƒ¼ã‚¯', icon: 'ğŸ¥·', type: 'gyro', mode:'balance', desc: 'ã‚¹ãƒãƒ›ã‚’æºã‚‰ã•ãšã«æ­©ãç¶šã‘ã‚ï¼' },
    { id: 'zen', name: 'ç¦…ãƒãƒ©ãƒ³ã‚¹', icon: 'ğŸ™', type: 'gyro', mode:'flat', desc: 'ã‚¹ãƒãƒ›ã‚’æ‰‹ã®ã²ã‚‰ã§æ°´å¹³ã«ä¿ã¦ï¼' },
    { id: 'jump', name: 'ã‚¿ã‚¤ãƒŸãƒ³ã‚°ãƒ»ã‚¸ãƒ£ãƒ³ãƒ—', icon: 'ğŸ¦˜', type: 'motion', mode:'jump', desc: 'ã€ŒJUMP!ã€ã®åˆå›³ã§ã‚¹ãƒãƒ›ã”ã¨è·³ã¹ï¼' },
    
    // --- Touch / Mind Games ---
    { id: 'mash', name: 'ãƒã‚¤ãƒ‘ãƒ¼é€£æ‰“', icon: 'ğŸ”¥', type: 'tap', desc: 'ç”»é¢ãŒå£Šã‚Œãªã„ç¨‹åº¦ã«é€£æ‰“ã›ã‚ˆï¼' },
    { id: 'color', name: 'ã‚«ãƒ©ãƒ¼ãƒ»ãƒãƒ³ãƒˆ', icon: 'ğŸ¨', type: 'color', desc: 'æŒ‡å®šã•ã‚ŒãŸè‰²ã¨åŒã˜ãƒœã‚¿ãƒ³ã‚’æŠ¼ã›ï¼' },
    { id: 'bomb', name: 'ã‚·ã‚§ã‚¤ã‚¯ãƒ»ãƒœãƒ ', icon: 'ğŸ’£', type: 'pass', desc: 'æŒ¯ã£ã¦ãƒ‘ã‚¹ï¼çˆ†ç™ºã—ãŸã‚‰è² ã‘' },
    { id: 'quiz', name: 'ã‚µãƒã‚¤ãƒãƒ«ãƒ»ã‚¯ã‚¤ã‚º', icon: 'ğŸ§ ', type: 'quiz', desc: 'æ—©æŠ¼ã—ã‚¯ã‚¤ã‚ºãƒãƒˆãƒ«ï¼' },
    { id: 'werewolf', name: 'ãƒ¯ãƒ³ãƒŠã‚¤ãƒˆäººç‹¼', icon: 'ğŸº', type: 'werewolf', desc: 'å˜˜ã¤ãã‚’è¦‹ã¤ã‘å‡ºã›' }
];

/* ==================== SOUND & UTIL ==================== */
const AudioSys = {
    ctx: new (window.AudioContext || window.webkitAudioContext)(),
    play: (type) => {
        if(AudioSys.ctx.state === 'suspended') AudioSys.ctx.resume();
        const osc = AudioSys.ctx.createOscillator();
        const gain = AudioSys.ctx.createGain();
        const t = AudioSys.ctx.currentTime;
        osc.connect(gain); gain.connect(AudioSys.ctx.destination);

        if(type==='tap') {
            osc.frequency.setValueAtTime(400, t); osc.type='triangle';
            gain.gain.setValueAtTime(0.1, t); gain.gain.linearRampToValueAtTime(0, t+0.1);
            osc.start(); osc.stop(t+0.1);
        } else if(type==='win') {
            [523, 659, 783, 1046].forEach((f,i) => {
                const o=AudioSys.ctx.createOscillator(); const g=AudioSys.ctx.createGain();
                o.connect(g); g.connect(AudioSys.ctx.destination);
                o.type='square'; o.frequency.value=f;
                g.gain.setValueAtTime(0.1, t+i*0.1); g.gain.exponentialRampToValueAtTime(0.001, t+i*0.1+0.4);
                o.start(t+i*0.1); o.stop(t+i*0.1+0.4);
            });
        } else if(type==='alert') {
            osc.frequency.setValueAtTime(150, t); osc.type='sawtooth';
            gain.gain.setValueAtTime(0.2, t); gain.gain.linearRampToValueAtTime(0, t+0.3);
            osc.start(); osc.stop(t+0.3);
        }
    }
};
const Utils = { id: () => Math.random().toString(36).substr(2, 4).toUpperCase() };

/* ==================== APP ROUTING ==================== */
const App = {
    init: () => {
        const params = new URLSearchParams(location.search);
        const roomId = params.get('room');
        if(roomId) {
            document.getElementById('landing-buttons').classList.add('hidden');
            document.getElementById('client-connect-ui').classList.remove('hidden');
            document.getElementById('room-id-input').value = roomId;
            Client.init(roomId);
        }
    },
    modeHost: () => {
        document.getElementById('screen-landing').classList.add('hidden');
        Host.init();
    },
    modeClient: () => {
        document.getElementById('landing-buttons').classList.add('hidden');
        document.getElementById('client-connect-ui').classList.remove('hidden');
    }
};

/* ==================== HOST LOGIC ==================== */
const Host = {
    peer: null, connMap: {}, players: {}, game: null, loop: null,
    
    init: () => {
        document.getElementById('host-app').classList.remove('hidden');
        const myId = Utils.id();
        document.getElementById('host-id-disp').innerText = myId;
        
        Host.peer = new Peer(myId);
        Host.peer.on('open', id => {
            const url = `${location.href.split('?')[0]}?room=${id}`;
            new QRCode(document.getElementById("qrcode"), { text: url, width: 150, height: 150 });
        });
        Host.peer.on('connection', conn => {
            conn.on('open', () => {
                Host.connMap[conn.peer] = conn;
                conn.on('data', data => Host.handleData(conn.peer, data));
                conn.on('close', () => { delete Host.players[conn.peer]; Host.updateLobby(); });
            });
        });
        Host.renderMenu();
    },

    updateLobby: () => {
        document.getElementById('p-count').innerText = Object.keys(Host.players).length;
    },

    handleData: (pid, data) => {
        if(data.act === 'join') {
            Host.players[pid] = { name: data.name, score: 0, id: pid };
            Host.updateLobby();
            AudioSys.play('tap');
        } else if (Host.game) {
            Host.gameInput(pid, data);
        }
    },

    renderMenu: () => {
        const list = document.getElementById('game-list');
        list.innerHTML = GAMES.map(g => `
            <div class="game-card" onclick="Host.startGame('${g.id}')">
                <span class="g-icon">${g.icon}</span>
                <span class="g-name">${g.name}</span>
            </div>
        `).join('');
    },

    toMenu: () => {
        Host.switchScreen('h-menu');
        Host.broadcast({act: 'reset'});
    },

    startRandom: () => {
        const g = GAMES[Math.floor(Math.random() * GAMES.length)];
        Host.startGame(g.id);
    },

    startGame: (gameId) => {
        const g = GAMES.find(x => x.id === gameId);
        Host.game = g;
        Host.switchScreen('h-stage');
        
        // Reset Scores
        Object.values(Host.players).forEach(p => p.score = 0);
        
        document.getElementById('stage-title').innerText = g.name;
        document.getElementById('stage-visual').innerText = "READY";
        document.getElementById('stage-sub').innerText = g.desc;

        // Init Client Controllers
        Host.broadcast({ act: 'init_game', type: g.type, mode: g.mode });

        setTimeout(() => {
            document.getElementById('stage-visual').innerText = "GO!";
            AudioSys.play('win');
            Host.runGameLoop();
        }, 3000);
    },

    runGameLoop: () => {
        let time = 15;
        const g = Host.game;
        if(g.id === 'ninja' || g.id === 'zen') time = 20;
        
        const maxTime = time;
        const vis = document.getElementById('stage-visual');
        const sub = document.getElementById('stage-sub');

        Host.loop = setInterval(() => {
            time -= 0.1;
            document.getElementById('timer-fill').style.width = (time/maxTime*100) + "%";

            // Live Updates
            if(g.id === 'squat' || g.id === 'run' || g.id === 'mash' || g.id === 'spin') {
                // Show top scorer
                const top = Object.values(Host.players).sort((a,b)=>b.score-a.score)[0];
                if(top) vis.innerText = `${top.name}: ${Math.floor(top.score)}`;
            }
            if(g.id === 'ninja' || g.id === 'zen') {
                // Show survivor count
                const survivors = Object.values(Host.players).filter(p => p.score >= 0).length;
                vis.innerText = `ç”Ÿå­˜: ${survivors}`;
                if(survivors === 0) time = 0;
            }

            if(time <= 0) {
                clearInterval(Host.loop);
                Host.endGame();
            }
        }, 100);
    },

    gameInput: (pid, d) => {
        const p = Host.players[pid];
        const g = Host.game;
        
        // --- Logic for each game type ---
        if(g.id === 'mash' && d.act === 'tap') p.score++;
        if(g.id === 'squat' && d.act === 'squat') p.score++; // Client detects squat
        if(g.id === 'run' && d.act === 'shake') p.score++;
        if(g.id === 'spin' && d.act === 'spin') p.score += d.val; // Add degrees
        if(g.id === 'jump' && d.act === 'jump') p.score++;
        
        // Ninja/Zen: Score is 0 initially. If they fail, score becomes -1 (dead)
        if((g.id === 'ninja' || g.id === 'zen') && d.act === 'fail') {
            p.score = -1;
            Host.connMap[pid].send({act:'vib', pattern:[200,100,200]}); // Dead vibe
        }
        
        if(g.id === 'color' && d.act === 'tap') {
            // Server should ideally set color, simplified here:
            p.score++;
        }
        if(g.id === 'quiz' && d.act === 'ans') {
            p.score++; // Simplified: First answer logic would go here
        }
    },

    endGame: () => {
        Host.switchScreen('h-result');
        const sorted = Object.values(Host.players).sort((a,b) => b.score - a.score);
        const winner = sorted[0];
        
        if(Host.game.id === 'ninja' || Host.game.id === 'zen') {
            const survivors = Object.values(Host.players).filter(p => p.score >= 0);
            if(survivors.length > 0) document.getElementById('winner-name').innerText = survivors.map(p=>p.name).join('\n');
            else document.getElementById('winner-name').innerText = "å…¨æ»…...";
        } else {
             document.getElementById('winner-name').innerText = winner ? winner.name : "NO WINNER";
        }
        
        AudioSys.play('win');
        Host.broadcast({act: 'end'});
    },

    broadcast: (d) => Object.values(Host.connMap).forEach(c => c.send(d)),
    switchScreen: (id) => {
        document.querySelectorAll('#host-app .screen').forEach(s => s.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
    }
};

/* ==================== CLIENT LOGIC ==================== */
const Client = {
    peer: null, conn: null, myId: null, 
    roomId: null, sensorActive: false,
    
    init: (id) => {
        Client.roomId = id;
        Client.manualJoin();
    },

    manualJoin: () => {
        const rid = document.getElementById('room-id-input').value || Client.roomId;
        if(!rid) return;
        
        document.getElementById('conn-status').innerText = "æ¥ç¶šä¸­...";
        
        Client.peer = new Peer();
        Client.peer.on('error', err => {
            console.log(err);
            Client.handleConnectError();
        });
        
        // 5ç§’çµŒã£ã¦ã‚‚ç¹‹ãŒã‚‰ãªã‘ã‚Œã°ã‚¨ãƒ©ãƒ¼æ‰±ã„
        const timeout = setTimeout(() => {
            if(!Client.conn || !Client.conn.open) Client.handleConnectError();
        }, 5000);

        Client.peer.on('open', id => {
            Client.conn = Client.peer.connect(rid);
            Client.conn.on('open', () => {
                clearTimeout(timeout);
                document.getElementById('client-app').classList.remove('hidden');
                document.getElementById('screen-landing').classList.add('hidden');
                Client.conn.on('data', Client.handleData);
            });
            Client.conn.on('error', Client.handleConnectError);
        });
    },

    handleConnectError: () => {
        document.getElementById('conn-status').innerText = "æ¥ç¶šå¤±æ•—";
        document.getElementById('conn-status').style.color = "#ff4757";
        document.getElementById('fallback-host').classList.remove('hidden');
        AudioSys.play('alert');
    },

    submitName: () => {
        const name = document.getElementById('username').value || "GUEST";
        // iOS Check
        if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
            Client.switchScreen('c-perm');
        } else {
            Client.finishJoin(name);
        }
    },

    reqPerm: () => {
        DeviceMotionEvent.requestPermission().then(res => {
            if(res === 'granted') Client.finishJoin(document.getElementById('username').value);
        }).catch(e => alert(e));
    },

    finishJoin: (name) => {
        Client.conn.send({act: 'join', name: name});
        Client.switchScreen('c-wait');
        Client.initSensors();
    },

    handleData: (d) => {
        if(d.act === 'init_game') Client.setupController(d);
        if(d.act === 'end' || d.act === 'reset') Client.switchScreen('c-wait');
        if(d.act === 'vib' && navigator.vibrate) navigator.vibrate(d.pattern);
    },

    setupController: (d) => {
        Client.switchScreen('c-ctrl');
        const area = document.getElementById('ctrl-area');
        area.innerHTML = '';
        Client.gameMode = d.mode; // Set current sensor mode

        if(d.type === 'tap') {
            area.innerHTML = `<button class="big-btn bg-red" ontouchstart="Client.send('tap'); navigator.vibrate(20);">é€£æ‰“!!</button>`;
        } else if (d.type === 'motion' || d.type === 'gyro') {
            area.innerHTML = `<div class="motion-instruction">${d.mode === 'squat' ? 'ã‚¹ãƒãƒ›ã‚’æŒã£ã¦<br>ã‚¹ã‚¯ãƒ¯ãƒƒãƒˆï¼' : 'ä½“ã‚’å‹•ã‹ã›ï¼'}</div>`;
        } else if (d.type === 'color') {
            area.innerHTML = `
                <div style="display:grid; grid-template-columns:1fr 1fr; height:100%;">
                    <div class="bg-red" onclick="Client.send('tap')"></div>
                    <div class="bg-blue" onclick="Client.send('tap')"></div>
                    <div class="bg-green" onclick="Client.send('tap')"></div>
                    <div class="bg-yellow" onclick="Client.send('tap')"></div>
                </div>`;
        } else if (d.type === 'quiz') {
            area.innerHTML = `
                <div style="display:grid; grid-template-columns:1fr 1fr; height:100%;">
                    <button class="big-btn bg-red" onclick="Client.send('ans')">A</button>
                    <button class="big-btn bg-blue" onclick="Client.send('ans')">B</button>
                    <button class="big-btn bg-green" onclick="Client.send('ans')">C</button>
                    <button class="big-btn bg-yellow" onclick="Client.send('ans')">D</button>
                </div>`;
        }
    },

    send: (act, val) => Client.conn.send({act:act, val:val}),

    // --- SENSOR LOGIC ---
    initSensors: () => {
        let lastY = 0, lastX = 0, lastZ = 0;
        let squatState = 'up'; // up -> down -> up = 1 squat
        let lastAlpha = 0;

        // Acceleration (Squat, Run, Jump)
        window.addEventListener('devicemotion', e => {
            if(document.getElementById('c-ctrl').classList.contains('hidden')) return;

            const acc = e.accelerationIncludingGravity;
            const lin = e.acceleration;
            if(!acc) return;

            // SQUAT (Y-axis gravity change)
            if(Client.gameMode === 'squat') {
                // Standing ~9.8, Squatting (going down) < 8, Bottom ~10, Going up > 12
                if(squatState === 'up' && lin.y < -3) { squatState = 'down'; }
                if(squatState === 'down' && lin.y > 2) { 
                    squatState = 'up'; 
                    Client.send('squat'); 
                    navigator.vibrate(50);
                }
            }
            
            // RUN (Shake hard)
            if(Client.gameMode === 'shake_hard') {
                const delta = Math.abs(acc.x+acc.y+acc.z - lastX-lastY-lastZ);
                if(delta > 30) { Client.send('shake'); }
                lastX=acc.x; lastY=acc.y; lastZ=acc.z;
            }

            // JUMP (Sharp vertical spike)
            if(Client.gameMode === 'jump') {
                if(lin.y > 8 || lin.y < -8) { // Sharp movement
                     Client.send('jump');
                     navigator.vibrate(20);
                }
            }
        });

        // Gyro (Ninja, Zen, Spin)
        window.addEventListener('deviceorientation', e => {
            if(document.getElementById('c-ctrl').classList.contains('hidden')) return;
            
            // NINJA / ZEN (Stability)
            if(Client.gameMode === 'balance' || Client.gameMode === 'flat') {
                const limit = Client.gameMode === 'flat' ? 10 : 20; // Flat is harder
                if(Math.abs(e.beta) > limit || Math.abs(e.gamma) > limit) {
                    // Send fail rarely to avoid spam
                    if(Math.random() > 0.9) Client.send('fail'); 
                }
            }

            // SPIN (Compass rotation)
            if(Client.gameMode === 'spin') {
                if(lastAlpha !== 0) {
                    let d = e.alpha - lastAlpha;
                    if(d > 180) d -= 360;
                    if(d < -180) d += 360;
                    // Send rotation amount
                    if(Math.abs(d) > 2) Client.send('spin', {val: Math.abs(d)/360});
                }
                lastAlpha = e.alpha;
            }
        });
    },

    switchScreen: (id) => {
        document.querySelectorAll('#client-app .screen').forEach(s => s.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
    }
};

window.onload = App.init;
</script>
</body>
</html>
