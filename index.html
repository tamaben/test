<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NEON SHAKE PARTY</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Black+Ops+One&family=M+PLUS+Rounded+1c:wght@700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #00ffcc; --secondary: #ff00ff; --bg: #0a0a0a; }
        body {
            font-family: 'M PLUS Rounded 1c', sans-serif;
            margin: 0; background: var(--bg); color: white;
            overflow: hidden; touch-action: none;
        }
        .hidden { display: none !important; }
        .full-screen {
            position: absolute; top: 0; left: 0; width: 100vw; height: 100vh;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .btn {
            background: linear-gradient(45deg, var(--secondary), #ff4444);
            border: none; color: white; padding: 15px 40px; font-size: 1.5rem;
            border-radius: 50px; cursor: pointer; font-family: 'Black Ops One';
            box-shadow: 0 0 15px var(--secondary); margin-top: 20px;
        }
        
        /* HOST */
        #host-view { background: radial-gradient(circle, #222, #000); }
        h1 { font-family: 'Black Ops One'; font-size: 3.5rem; margin: 0; color: var(--primary); text-shadow: 0 0 15px var(--primary); }
        #timer { font-size: 6rem; font-family: 'Black Ops One'; color: #fff; margin-bottom: 20px; }
        #arena {
            display: flex; align-items: flex-end; justify-content: center;
            width: 90%; height: 45vh; gap: 15px; border-bottom: 3px solid #444;
        }
        .player-col { width: 70px; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: flex-end; position: relative; }
        .bar { width: 100%; border-radius: 5px 5px 0 0; transition: height 0.1s linear; }
        .p-name { font-size: 0.8rem; margin-top: 10px; width: 100%; text-align: center; white-space: nowrap; overflow: hidden; }
        .p-score { position: absolute; top: -30px; font-family: 'Black Ops One'; font-size: 1.2rem; }

        /* CLIENT */
        #client-view { background: #111; }
        #shake-circle {
            width: 220px; height: 220px; border-radius: 50%;
            background: radial-gradient(circle, #ff4444, #990000);
            border: 8px solid rgba(255,255,255,0.2);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            box-shadow: 0 0 30px #ff0000;
        }
        .active { transform: scale(0.9); }
        #my-score { font-size: 4rem; font-family: 'Black Ops One'; }
        input { background: #222; border: 2px solid var(--primary); color: white; padding: 10px; font-size: 1.5rem; border-radius: 10px; text-align: center; }
    </style>
</head>
<body>

    <!-- „Éõ„Çπ„ÉàÁîªÈù¢ -->
    <div id="host-view" class="full-screen hidden">
        <h1>SHAKE PARTY</h1>
        <div id="timer">10</div>
        <div id="arena"></div>
        <div id="lobby-ui" style="margin-top:20px; text-align:center;">
            <div id="qrcode" style="background:white; padding:10px; display:inline-block; border-radius:10px;"></div>
            <p id="room-txt" style="color:#aaa;">Room ID: ----</p>
            <button class="btn" onclick="window.startGame()">BATTLE START!</button>
        </div>
    </div>

    <!-- „Éó„É¨„Ç§„É§„ÉºÁîªÈù¢ -->
    <div id="client-view" class="full-screen hidden">
        <div id="step-name">
            <h2 style="color:var(--primary)">YOUR NAME</h2>
            <input type="text" id="username" placeholder="„Éã„ÉÉ„ÇØ„Éç„Éº„É†" maxlength="8"><br>
            <button class="btn" onclick="window.joinGame()">JOIN ROOM</button>
        </div>

        <div id="step-shake" class="full-screen hidden">
            <div id="status-msg" style="margin-bottom:20px; font-size:1.2rem; color:#aaa;">ÂæÖÊ©ü‰∏≠...</div>
            <div id="shake-circle">
                <div id="my-score">0</div>
                <div style="font-weight:bold;">SHAKE!</div>
            </div>
        </div>

        <div id="step-perm" class="full-screen hidden" style="background:rgba(0,0,0,0.9);">
            <p>„Çª„É≥„Çµ„Éº„ÅÆË®±ÂèØ„ÅåÂøÖË¶Å„Åß„Åô</p>
            <button class="btn" onclick="window.requestSensor()">OK</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
        import { getDatabase, ref, set, onValue, update, onDisconnect } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

        // ==========================================
        // 1. FIREBASE CONFIG („Åì„Åì„ÇíËá™ÂàÜ„ÅÆ„ÇÇ„ÅÆ„Å´Êõ∏„ÅçÊèõ„Åà„Å¶ÔºÅ)
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyDbZzTMvUkG2LXIGY4ux0KBTmnAdqP236s",
            authDomain: "game-4f2d9.firebaseapp.com",
            databaseURL: "https://game-4f2d9-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "game-4f2d9",
            storageBucket: "game-4f2d9.firebasestorage.app",
            messagingSenderId: "574316347824",
            appId: "1:574316347824:web:cf686040628e25ad615675"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const params = new URLSearchParams(window.location.search);
        let role = params.get('role');
        let roomId = params.get('room');
        const myId = Math.random().toString(36).substring(2, 7);

        // ==========================================
        // 2. Ëµ∑ÂãïÂàÜÂ≤ê„É≠„Ç∏„ÉÉ„ÇØ
        // ==========================================
        if (!role) {
            // ÂàùÂõû„Ç¢„ÇØ„Çª„ÇπÊôÇÔºö„Éõ„Çπ„Éà„Å®„Åó„Å¶ÈÉ®Â±ã‰ΩúÊàê
            const newRoom = Math.random().toString(36).substring(2, 6).toUpperCase();
            window.location.replace(`?role=host&room=${newRoom}`);
        } else if (role === 'host') {
            setupHost();
        } else {
            setupPlayer();
        }

        // ==========================================
        // 3. HOST LOGIC
        // ==========================================
        function setupHost() {
            const hostView = document.getElementById('host-view');
            hostView.classList.remove('hidden');
            document.getElementById('room-txt').innerText = `Room ID: ${roomId}`;

            // QR„Ç≥„Éº„Éâ‰ΩúÊàê
            const joinUrl = `${window.location.origin}${window.location.pathname}?role=player&room=${roomId}`;
            new QRCode(document.getElementById("qrcode"), { text: joinUrl, width: 120, height: 120 });

            const roomRef = ref(db, `shake/${roomId}`);
            
            // ÂèÇÂä†ËÄÖÁõ£Ë¶ñ
            onValue(ref(db, `shake/${roomId}/players`), (snap) => {
                const players = snap.val() || {};
                const arena = document.getElementById('arena');
                arena.innerHTML = ''; // ÂÜçÊèèÁîª

                Object.keys(players).forEach((id, idx) => {
                    const p = players[id];
                    const color = `hsl(${idx * 60}, 80%, 60%)`;
                    const score = p.count || 0;
                    const h = Math.min(score * 2, 100);

                    const col = document.createElement('div');
                    col.className = 'player-col';
                    col.innerHTML = `
                        <div class="p-score" style="color:${color}">${p.isWinner ? 'üëë' : ''}${score}</div>
                        <div class="bar" style="height:${h}%; background:${color}; box-shadow: 0 0 15px ${color}"></div>
                        <div class="p-name" style="color:${color}">${p.name}</div>
                    `;
                    arena.appendChild(col);
                });
            });

            // „Ç≤„Éº„É†ÈñãÂßã„Éú„Çø„É≥ (Global)
            window.startGame = () => {
                update(roomRef, { 'state/status': 'ready' });
                document.getElementById('lobby-ui').classList.add('hidden');
                
                // ÂÖ®„Éó„É¨„Ç§„É§„Éº„ÅÆ„Çπ„Ç≥„Ç¢„É™„Çª„ÉÉ„Éà
                onValue(ref(db, `shake/${roomId}/players`), (snap) => {
                    const players = snap.val();
                    if(players) {
                        const upds = {};
                        Object.keys(players).forEach(id => {
                            upds[`players/${id}/count`] = 0;
                            upds[`players/${id}/isWinner`] = false;
                        });
                        update(roomRef, upds);
                    }
                }, { onlyOnce: true });

                // „Ç´„Ç¶„É≥„Éà„ÉÄ„Ç¶„É≥
                let count = 3;
                const timerEl = document.getElementById('timer');
                const cd = setInterval(() => {
                    timerEl.innerText = count > 0 ? count : "GO!";
                    if (count === 0) {
                        clearInterval(cd);
                        startBattle();
                    }
                    count--;
                }, 1000);
            };

            function startBattle() {
                update(roomRef, { 'state/status': 'running' });
                let time = 10;
                const timerEl = document.getElementById('timer');
                const battle = setInterval(() => {
                    time--;
                    timerEl.innerText = time;
                    if (time <= 0) {
                        clearInterval(battle);
                        finishBattle();
                    }
                }, 1000);
            }

            function finishBattle() {
                update(roomRef, { 'state/status': 'finished' });
                document.getElementById('timer').innerText = "FINISH!";
                
                // ÂãùËÄÖÂà§ÂÆö
                onValue(ref(db, `shake/${roomId}/players`), (snap) => {
                    const ps = snap.val();
                    let top = -1, winner = null;
                    Object.keys(ps).forEach(id => {
                        if (ps[id].count > top) { top = ps[id].count; winner = id; }
                    });
                    if (winner) update(ref(db, `shake/${roomId}/players/${winner}`), { isWinner: true });
                    
                    setTimeout(() => {
                        document.getElementById('lobby-ui').classList.remove('hidden');
                    }, 5000);
                }, { onlyOnce: true });
            }
        }

        // ==========================================
        // 4. PLAYER LOGIC
        // ==========================================
        function setupPlayer() {
            document.getElementById('client-view').classList.remove('hidden');
            let myCount = 0;
            let canShake = false;

            const pRef = ref(db, `shake/${roomId}/players/${myId}`);
            const sRef = ref(db, `shake/${roomId}/state`);

            window.joinGame = () => {
                const name = document.getElementById('username').value || "NO NAME";
                document.getElementById('step-name').classList.add('hidden');

                // iOS„Å™„ÇâË®±ÂèØÁîªÈù¢„ÄÅ„Åù„ÅÜ„Åß„Å™„Åë„Çå„Å∞Âç≥ÈñãÂßã
                if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
                    document.getElementById('step-perm').classList.remove('hidden');
                } else {
                    enterRoom(name);
                }
            };

            window.requestSensor = async () => {
                const res = await DeviceMotionEvent.requestPermission();
                if (res === 'granted') {
                    document.getElementById('step-perm').classList.add('hidden');
                    enterRoom(document.getElementById('username').value || "PLAYER");
                }
            };

            function enterRoom(name) {
                document.getElementById('step-shake').classList.remove('hidden');
                set(pRef, { name: name, count: 0 });
                onDisconnect(pRef).remove();

                // „Çµ„Éº„Éê„ÉºÁä∂ÊÖã„ÇíÁõ£Ë¶ñ
                onValue(sRef, (snap) => {
                    const state = snap.val() || {};
                    const msg = document.getElementById('status-msg');
                    
                    if (state.status === 'ready') {
                        msg.innerText = "Ê∫ñÂÇô„Åó„Å¶..."; myCount = 0;
                        document.getElementById('my-score').innerText = "0";
                        canShake = false;
                    } else if (state.status === 'running') {
                        msg.innerText = "ÊåØ„ÇåÔºÅÊåØ„ÇåÔºÅÊåØ„ÇåÔºÅ";
                        canShake = true;
                    } else if (state.status === 'finished') {
                        msg.innerText = "ÁµÇ‰∫ÜÔºÅ„Éõ„Çπ„ÉàÁîªÈù¢„ÇíË¶ã„Å¶„Å≠";
                        canShake = false;
                    }
                });

                // ÊåØÂãïÊ§úÁü•
                let lastX=0, lastY=0, lastZ=0, lastSend=0;
                window.addEventListener('devicemotion', (e) => {
                    if (!canShake) return;
                    const a = e.accelerationIncludingGravity;
                    const diff = Math.abs(a.x - lastX) + Math.abs(a.y - lastY) + Math.abs(a.z - lastZ);
                    
                    if (diff > 20) {
                        myCount++;
                        document.getElementById('my-score').innerText = myCount;
                        const circle = document.getElementById('shake-circle');
                        circle.classList.add('active');
                        setTimeout(() => circle.classList.remove('active'), 50);

                        // ÈÄö‰ø°„ÇíÈñìÂºï„Åè (100ms„Å´1Âõû)
                        const now = Date.now();
                        if (now - lastSend > 100) {
                            update(pRef, { count: myCount });
                            lastSend = now;
                        }
                    }
                    lastX = a.x; lastY = a.y; lastZ = a.z;
                });
            }
        }
    </script>
</body>
</html>
