<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HYBRID PARTY 50</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Audiowide&family=Zen+Maru+Gothic:wght@500;900&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #0f0f1a; --main: #00ff88; --sub: #ff0055; --text: #fff; --panel: #1a1a2e; }
        * { box-sizing: border-box; touch-action: none; user-select: none; -webkit-user-select: none; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: 'Zen Maru Gothic', sans-serif; overflow: hidden; height: 100vh; width: 100vw; }

        /* SCENE MANAGEMENT */
        .screen { position: fixed; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; background: var(--bg); transition: opacity 0.3s; z-index: 10; }
        .hidden { opacity: 0; pointer-events: none; z-index: -1; transform: scale(0.95); }

        /* UI COMPONENTS */
        h1 { font-family: 'Audiowide'; font-size: 3.5rem; color: var(--main); margin: 0; text-shadow: 0 0 15px rgba(0,255,136,0.4); line-height: 1; text-align: center; }
        h2 { color: var(--sub); font-size: 1.2rem; margin: 10px; letter-spacing: 2px; text-transform: uppercase; }
        p { color: #889; font-size: 0.9rem; margin: 5px; }

        .btn {
            background: linear-gradient(135deg, rgba(0,255,136,0.1), rgba(0,255,136,0));
            border: 2px solid var(--main); color: var(--main);
            padding: 15px 40px; font-size: 1.2rem; font-weight: bold; border-radius: 50px;
            margin: 10px; cursor: pointer; width: 85%; max-width: 320px; transition: 0.2s;
            box-shadow: 0 0 10px rgba(0,255,136,0.1);
        }
        .btn:active { background: var(--main); color: #000; transform: scale(0.96); }
        .btn-red { border-color: var(--sub); color: var(--sub); background: linear-gradient(135deg, rgba(255,0,85,0.1), rgba(255,0,85,0)); }
        .btn-red:active { background: var(--sub); color: #fff; }

        /* STATUS BADGE */
        .badge { padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; margin-bottom: 10px; display: inline-block; }
        .b-p2p { background: #00b894; color: white; border: 1px solid #55efc4; } /* P2P OK */
        .b-db { background: #e17055; color: white; border: 1px solid #fab1a0; } /* Firebase Mode */
        .b-wait { background: #636e72; color: #dfe6e9; }

        /* GAME LIST */
        #game-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; width: 95%; height: 60vh; overflow-y: auto; padding: 10px; padding-bottom: 50px; }
        .g-card { background: var(--panel); border: 1px solid #333; padding: 15px; border-radius: 12px; text-align: center; cursor: pointer; transition: 0.2s; }
        .g-card:active { background: var(--main); border-color: var(--main); transform: scale(0.98); }
        .g-icon { font-size: 2rem; margin-bottom: 5px; }
        .g-name { font-weight: 900; font-size: 0.9rem; }

        /* PLAY AREA */
        .bar-bg { width: 100%; height: 8px; background: #333; position: fixed; top: 0; }
        .bar-fill { height: 100%; background: var(--main); width: 100%; transition: width 0.1s linear; }
        .rank-list { width: 90%; margin-top: 20px; }
        .rank-item { display: flex; justify-content: space-between; background: rgba(255,255,255,0.05); padding: 10px; margin-bottom: 5px; border-radius: 5px; }
        
        /* CONTROLLER */
        .c-grid { width: 100%; height: 100%; display: grid; place-items: center; padding: 10px; }
        .c-btn { width: 100%; height: 100%; border: none; border-radius: 20px; font-size: 3rem; font-weight: bold; color: white; box-shadow: 0 8px 0 rgba(0,0,0,0.3); transition: 0.05s; }
        .c-btn:active { transform: translateY(8px); box-shadow: none; }
        .bg-tap { background: var(--sub); }
        .bg-blue { background: #0984e3; }
        .bg-green { background: #00b894; }

        input { font-size: 1.5rem; text-align: center; background: #222; border: 2px solid #444; color: white; padding: 12px; border-radius: 10px; width: 80%; margin: 10px; text-transform: uppercase; letter-spacing: 2px; }
    </style>
</head>
<body>

<div id="s-title" class="screen">
    <h1>HYBRID<br>PARTY</h1>
    <p>50 Games / Auto-Switching</p>
    <div style="margin:20px 0; color:#666; font-size:0.8rem;">P2P(WebRTC) + DB(Firebase)</div>
    <button class="btn" onclick="App.host()">üëë ÈÉ®Â±ã„Çí‰Ωú„Çã (HOST)</button>
    <button class="btn btn-red" onclick="App.client()">üì± ÂèÇÂä†„Åô„Çã (JOIN)</button>
</div>

<div id="s-h-lobby" class="screen hidden">
    <div id="h-status" class="badge b-wait">ÈÄö‰ø°ÂàùÊúüÂåñ‰∏≠...</div>
    <h2>ROOM ID</h2>
    <div id="room-disp" style="font-size: 4rem; font-family: 'Audiowide'; letter-spacing: 5px; color:var(--main);">...</div>
    <div id="qrcode" style="background:white; padding:10px; border-radius:10px; margin:15px;"></div>
    <p>ÂèÇÂä†‰∫∫Êï∞: <span id="p-count" style="color:var(--main); font-size:1.5rem; font-weight:bold;">0</span></p>
    <button class="btn" onclick="Host.menu()">„Ç≤„Éº„É†ÈÅ∏Êäû„Å∏</button>
</div>

<div id="s-h-menu" class="screen hidden">
    <h2>SELECT GAME</h2>
    <div id="game-grid"></div>
</div>

<div id="s-h-game" class="screen hidden">
    <div class="bar-bg"><div id="t-bar" class="bar-fill"></div></div>
    <h2 id="g-name" style="margin-top:50px; color:white;">GAME NAME</h2>
    <div id="g-main" style="font-size:5rem; font-family:'Audiowide';">READY</div>
    <div id="ranking" class="rank-list"></div>
</div>

<div id="s-h-res" class="screen hidden">
    <h1 style="color:var(--sub)">WINNER</h1>
    <div id="res-name" style="font-size:3rem; margin:20px; font-weight:bold;">???</div>
    <div id="res-score" style="font-size:2rem; color:var(--main);">0 PTS</div>
    <button class="btn" onclick="Host.menu()">„É°„Éã„É•„Éº„Å∏Êàª„Çã</button>
</div>

<div id="s-c-login" class="screen hidden">
    <h2>ENTER ROOM ID</h2>
    <input type="text" id="inp-room" placeholder="ID (4ÊñáÂ≠ó)" maxlength="4">
    <input type="text" id="inp-name" placeholder="NICKNAME" maxlength="8">
    <button class="btn btn-red" onclick="Client.join()">ÂèÇÂä†„Åô„Çã</button>
    <div id="c-msg" style="color:var(--main); margin-top:10px; font-size:0.9rem;"></div>
</div>

<div id="s-c-perm" class="screen hidden">
    <h2>„Çª„É≥„Çµ„ÉºË®±ÂèØ</h2>
    <p>„Ç≤„Éº„É†„Å´ÂøÖË¶Å„Åß„Åô</p>
    <div style="font-size:3rem;">üì±üîì</div>
    <button class="btn" onclick="Client.perm()">Ë®±ÂèØ„Åó„Å¶ÂÆå‰∫Ü</button>
</div>

<div id="s-c-wait" class="screen hidden">
    <div id="c-status" class="badge b-wait">CONNECTING...</div>
    <h2 style="animation:pulse 1s infinite">WAITING</h2>
    <p>„Éõ„Çπ„Éà„Åå„Ç≤„Éº„É†„ÇíÈÅ∏„Çì„Åß„ÅÑ„Åæ„Åô</p>
</div>

<div id="s-c-ctrl" class="screen hidden">
    <div id="ctrl-area" class="c-grid"></div>
</div>

<script type="module">
// --- FIREBASE SETUP ---
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getDatabase, ref, set, get, onValue, update, onDisconnect, push, onChildAdded, remove } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

const firebaseConfig = {
    apiKey: "AIzaSyDbZzTMvUkG2LXIGY4ux0KBTmnAdqP236s",
    authDomain: "game-4f2d9.firebaseapp.com",
    databaseURL: "https://game-4f2d9-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "game-4f2d9",
    storageBucket: "game-4f2d9.firebasestorage.app",
    messagingSenderId: "574316347824",
    appId: "1:574316347824:web:cf686040628e25ad615675",
    measurementId: "G-T0ZKQCC9L3"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// --- UTILS ---
const $ = id => document.getElementById(id);
const show = id => { document.querySelectorAll('.screen').forEach(e => e.classList.add('hidden')); $(id).classList.remove('hidden'); };
const genId = () => Math.random().toString(36).substr(2, 4).toUpperCase();
const myId = Math.random().toString(36).substr(2, 6);

// --- 50 GAMES DATA ---
const GAMES = [];
// 1-10: Tap Basics
for(let i=1; i<=10; i++) GAMES.push({id:i, t:'tap', n:`ÈÄ£Êâì Lv.${i}`, tm:5+i, d:'ÁîªÈù¢„ÇíÈÄ£Êâì„Åó„ÇçÔºÅ', icon:'üî•'});
// 11-20: Shake Basics
for(let i=11; i<=20; i++) GAMES.push({id:i, t:'shake', n:`„Ç∑„Çß„Ç§„ÇØ Lv.${i-10}`, tm:5+(i%5)*2, d:'„Çπ„Éû„Éõ„ÇíÊåØ„ÇåÔºÅ', icon:'üëã'});
// 21-30: Squat
for(let i=21; i<=30; i++) GAMES.push({id:i, t:'squat', n:`„Çπ„ÇØ„ÉØ„ÉÉ„Éà No.${i}`, tm:15, d:'„Åó„ÇÉ„Åå„Çì„ÅßÁ´ã„Å¶ÔºÅ', icon:'ü¶µ'});
// 31-40: Math
for(let i=31; i<=40; i++) GAMES.push({id:i, t:'math', n:`ÊöóÁÆó„Éê„Éà„É´ ${i}`, tm:20, d:'Ë®àÁÆó„Åó„Å¶Á≠î„Åà„Çç', icon:'üßÆ'});
// 41-50: Variety
GAMES.push({id:41, t:'luck', n:'ÈÅã„Ç≤„Éº', tm:5, d:'ÂΩì„Åü„Çä„ÇíÂºï„Åë', icon:'üé∞'});
GAMES.push({id:42, t:'tap', n:'3ÁßíÈÄ£Êâì', tm:3, d:'Ë∂ÖÈ´òÈÄü„Çø„ÉÉ„ÉóÔºÅ', icon:'‚ö°'});
GAMES.push({id:43, t:'shake', n:'ËÄê‰πÖ„Ç∑„Çß„Ç§„ÇØ', tm:30, d:'30ÁßíÈñìÊåØ„Çå', icon:'ü•µ'});
GAMES.push({id:44, t:'quiz', n:'4Êäû„ÇØ„Ç§„Ç∫', tm:15, d:'Áõ¥ÊÑü„ÅßÈÅ∏„Åπ', icon:'‚ùì'});
GAMES.push({id:45, t:'balance', n:'„Éê„É©„É≥„Çπ', tm:15, d:'Ê∞¥Âπ≥„Çí‰øù„Å¶', icon:'‚öñÔ∏è'});
for(let i=46; i<=50; i++) GAMES.push({id:i, t:'mix', n:`„Éï„Ç°„Ç§„Éä„É´ ${i}`, tm:20, d:'ÂÖ®Âäõ„ÅßÊåë„ÇÅ', icon:'üëë'});

// --- GLOBAL STATE ---
let roomId = null;
let peer = null;
let p2pConn = null;
let isP2pAvailable = false;
let hostConnections = {};

// ==========================================
//               APP CONTROLLER
// ==========================================
window.App = {
    host: () => Host.init(),
    client: () => {
        const p = new URLSearchParams(location.search);
        if(p.get('room')) $('inp-room').value = p.get('room');
        show('s-c-login');
    }
};

// ==========================================
//               HOST LOGIC
// ==========================================
window.Host = {
    players: {}, // { id: { name, score } }

    init: async () => {
        show('s-h-lobby');
        roomId = genId();
        $('room-disp').innerText = roomId;
        new QRCode($('qrcode'), { text: `${location.href.split('?')[0]}?room=${roomId}`, width: 128, height: 128 });

        // 1. Firebase Room Create (Base)
        const roomRef = ref(db, `rooms/${roomId}`);
        await set(roomRef, { status: 'lobby', created: Date.now() });
        onDisconnect(roomRef).remove();

        // 2. Try PeerJS
        try {
            peer = new Peer();
            
            // Error Handler: If P2P fails, we just rely on Firebase
            peer.on('error', (err) => {
                console.warn("PeerJS Error (Fallback to DB):", err);
                $('h-status').innerText = "DB„É¢„Éº„Éâ (ÂÆâÂÆöÁâà)";
                $('h-status').className = "badge b-db";
                // Update room to say P2P is dead
                update(roomRef, { p2pId: null });
            });

            peer.on('open', (id) => {
                console.log("PeerJS ID:", id);
                $('h-status').innerText = "P2P„Éè„Ç§„Éñ„É™„ÉÉ„Éâ (È´òÈÄü)";
                $('h-status').className = "badge b-p2p";
                update(roomRef, { p2pId: id });
            });

            peer.on('connection', (conn) => {
                hostConnections[conn.peer] = conn;
                conn.on('data', (d) => Host.handleInput(d.pid, d.val, d.name));
            });

        } catch (e) {
            console.log("PeerJS Init Failed");
        }

        // 3. Listen to Firebase Inputs (FALLBACK CHANNEL)
        // „ÇØ„É©„Ç§„Ç¢„É≥„Éà„ÅåP2P„ÅßÁπã„Åå„Çâ„Å™„ÅÑÂ†¥Âêà„ÄÅFirebase„Å´Êõ∏„ÅçËæº„ÇÄ„ÅÆ„Åß„Åù„Çå„ÇÇÁõ£Ë¶ñ„Åô„Çã
        onChildAdded(ref(db, `rooms/${roomId}/actions`), (snap) => {
            const val = snap.val();
            Host.handleInput(val.pid, val.val, val.name);
            // Processed, remove to save space? No, let's keep for simplicity, auto-deleted on room removal
            remove(snap.ref); 
        });

        // 4. Listen for Player Joins (via Firebase Presence)
        onValue(ref(db, `rooms/${roomId}/players`), (snap) => {
            const val = snap.val() || {};
            // Merge logic if needed, but here we just trust the list
            Object.keys(val).forEach(pid => {
                if(!Host.players[pid]) Host.players[pid] = { name: val[pid].name, score: 0 };
            });
            $('p-count').innerText = Object.keys(Host.players).length;
        });
    },

    handleInput: (pid, val, name) => {
        // Player Join Signal
        if (!Host.players[pid]) {
            Host.players[pid] = { name: name || "Guest", score: 0 };
            // Sync back to Firebase for persistence
            update(ref(db, `rooms/${roomId}/players/${pid}`), { name: name || "Guest" });
            $('p-count').innerText = Object.keys(Host.players).length;
        }

        // Game Action Signal (only if playing)
        if ($('s-h-game').classList.contains('hidden')) return;

        if (val) {
            Host.players[pid].score += val;
        }
    },

    menu: () => {
        show('s-h-menu');
        $('game-grid').innerHTML = GAMES.map(g => `
            <div class="g-card" onclick="Host.start(${g.id})">
                <div class="g-icon">${g.icon}</div>
                <div class="g-name">${g.id}. ${g.n}</div>
            </div>
        `).join('');
        update(ref(db, `rooms/${roomId}`), { status: 'menu' });
    },

    start: (gid) => {
        const game = GAMES.find(g => g.id === gid);
        show('s-h-game');
        $('g-name').innerText = game.n;
        $('g-main').innerText = "READY";
        $('ranking').innerHTML = "";
        
        // Reset Scores
        Object.keys(Host.players).forEach(k => Host.players[k].score = 0);

        // Notify Clients (Firebase update handles everyone)
        update(ref(db, `rooms/${roomId}`), { 
            status: 'playing', 
            game: game,
            ts: Date.now() // timestamp to force update
        });

        // Countdown
        let cd = 3;
        const t = setInterval(() => {
            if(cd>0) $('g-main').innerText = cd--;
            else {
                clearInterval(t);
                $('g-main').innerText = "GO!";
                Host.loop(game.tm);
            }
        }, 1000);
    },

    loop: (sec) => {
        let left = sec;
        const max = sec;
        const timer = setInterval(() => {
            left -= 0.1;
            $('t-bar').style.width = (left/max*100) + "%";

            // Update Rankings
            const sorted = Object.values(Host.players).sort((a,b)=>b.score-a.score).slice(0,3);
            $('ranking').innerHTML = sorted.map((p,i) => `
                <div class="rank-item">
                    <span>#${i+1} ${p.name}</span>
                    <span style="font-weight:bold; color:var(--main)">${Math.floor(p.score)}</span>
                </div>
            `).join('');

            if(left <= 0) {
                clearInterval(timer);
                Host.end(sorted[0]);
            }
        }, 100);
    },

    end: (winner) => {
        update(ref(db, `rooms/${roomId}`), { status: 'result' });
        show('s-h-res');
        $('res-name').innerText = winner ? winner.name : "NO WINNER";
        $('res-score').innerText = winner ? Math.floor(winner.score) + " PTS" : "";
    }
};

// ==========================================
//               CLIENT LOGIC
// ==========================================
window.Client = {
    name: "Guest",
    game: null,
    
    join: async () => {
        const rid = $('inp-room').value.toUpperCase();
        Client.name = $('inp-name').value || "Guest";
        
        if (rid.length !== 4) {
            $('c-msg').innerText = "ID„ÅØ4ÊñáÂ≠ó„Åß„Åô";
            return;
        }
        
        $('c-msg').innerText = "ÈÉ®Â±ã„ÇíÊé¢„Åó„Å¶„ÅÑ„Åæ„Åô...";
        
        // 1. Check Room Existence
        const snap = await get(ref(db, `rooms/${rid}`));
        if (!snap.exists()) {
            $('c-msg').innerText = "ÈÉ®Â±ã„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì";
            return;
        }
        
        roomId = rid;
        const rData = snap.val();
        
        // 2. Register Presence
        await set(ref(db, `rooms/${rid}/players/${myId}`), { name: Client.name });
        onDisconnect(ref(db, `rooms/${rid}/players/${myId}`)).remove();

        // 3. Try P2P Connection (if host has ID)
        if (rData.p2pId) {
            Client.connectP2P(rData.p2pId);
        } else {
            Client.useDBMode();
        }

        // 4. Start Listeners
        Client.listen();

        // 5. Sensor Check
        if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
            show('s-c-perm');
        } else {
            show('s-c-wait');
        }
    },

    connectP2P: (hostPeerId) => {
        $('c-status').innerText = "P2PÊé•Á∂öË©¶Ë°å‰∏≠...";
        try {
            peer = new Peer();
            peer.on('open', (id) => {
                p2pConn = peer.connect(hostPeerId);
                p2pConn.on('open', () => {
                    isP2pAvailable = true;
                    $('c-status').innerText = "P2P CONNECTED (È´òÈÄü)";
                    $('c-status').className = "badge b-p2p";
                    Client.send(0); // Join signal
                });
                p2pConn.on('error', () => Client.useDBMode());
                p2pConn.on('close', () => Client.useDBMode());
            });
            peer.on('error', () => Client.useDBMode());
        } catch (e) {
            Client.useDBMode();
        }
    },

    useDBMode: () => {
        isP2pAvailable = false;
        $('c-status').innerText = "DB CONNECTION (ÂÆâÂÆö)";
        $('c-status').className = "badge b-db";
        // Send initial join signal via DB
        Client.send(0);
    },

    listen: () => {
        onValue(ref(db, `rooms/${roomId}`), (snap) => {
            const d = snap.val();
            if (!d) return; // Room closed

            if (d.status === 'playing' && d.game) {
                // Prevent restart if already playing same game
                if (Client.game && Client.game.id === d.game.id) return;
                Client.startGame(d.game);
            } else if (d.status === 'menu' || d.status === 'result' || d.status === 'lobby') {
                Client.game = null;
                show('s-c-wait');
                if(navigator.vibrate) navigator.vibrate(0);
            }
        });
    },

    perm: () => {
        DeviceMotionEvent.requestPermission().then(r => {
            if(r==='granted') show('s-c-wait');
            else alert("Ë®±ÂèØ„Åå„Å™„ÅÑ„Å®ÈÅä„Åπ„Å™„ÅÑ„Ç≤„Éº„É†„Åå„ÅÇ„Çä„Åæ„Åô");
        }).catch(e=>show('s-c-wait'));
    },

    startGame: (game) => {
        Client.game = game;
        show('s-c-ctrl');
        const area = $('ctrl-area');
        area.innerHTML = "";

        // UI Generator
        if (game.t === 'tap' || game.t === 'mix') {
            area.innerHTML = `<button class="c-btn bg-tap" ontouchstart="Client.send(1)">PUSH!</button>`;
        } else if (game.t === 'math') {
            Client.genMath();
        } else if (game.t === 'quiz') {
            area.innerHTML = `
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; width:100%; height:100%;">
                    <button class="c-btn bg-tap" onclick="Client.send(1)">A</button>
                    <button class="c-btn bg-blue" onclick="Client.send(1)">B</button>
                    <button class="c-btn bg-green" onclick="Client.send(1)">C</button>
                    <button class="c-btn" style="background:#e17055" onclick="Client.send(1)">D</button>
                </div>`;
        } else {
            area.innerHTML = `<div style="text-align:center; color:white;">
                <div style="font-size:4rem; margin-bottom:20px;">${game.icon}</div>
                <div style="font-size:1.5rem;">${game.d}</div>
            </div>`;
        }

        // Init Sensors
        Client.initSensors();
    },

    genMath: () => {
        const n1 = Math.floor(Math.random()*9)+1;
        const n2 = Math.floor(Math.random()*9)+1;
        const ans = n1+n2;
        const area = $('ctrl-area');
        area.innerHTML = `
            <div style="width:100%; height:100%; display:flex; flex-direction:column;">
                <div style="flex:1; display:flex; align-items:center; justify-content:center; font-size:4rem; font-weight:bold;">${n1} + ${n2} = ?</div>
                <div style="flex:1; display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                    <button class="c-btn bg-blue" onclick="Client.ans(${ans},${ans})">${ans}</button>
                    <button class="c-btn bg-tap" onclick="Client.ans(${ans+1},${ans})">${ans+1}</button>
                </div>
            </div>`;
    },

    ans: (v, cor) => {
        if(v===cor) Client.send(1);
        else Client.send(-1);
        Client.genMath();
    },

    // --- SEND DATA (HYBRID) ---
    send: (val) => {
        const payload = { pid: myId, val: val, name: Client.name };

        if (isP2pAvailable && p2pConn && p2pConn.open) {
            // Plan A: Send via PeerJS
            p2pConn.send(payload);
        } else {
            // Plan B: Send via Firebase
            push(ref(db, `rooms/${roomId}/actions`), payload);
        }
        
        if (val > 0 && navigator.vibrate) navigator.vibrate(30);
    },

    initSensors: () => {
        let lx=0, ly=0, lz=0;
        let squatState = 'up';

        const handler = (e) => {
            if(!Client.game || $('s-c-ctrl').classList.contains('hidden')) return;
            const t = Client.game.t;
            const acc = e.accelerationIncludingGravity;
            if(!acc) return;

            if (t === 'shake' || t === 'mix') {
                const d = Math.abs(acc.x+acc.y+acc.z - lx-ly-lz);
                if(d > 20) Client.send(1);
                lx=acc.x; ly=acc.y; lz=acc.z;
            } else if (t === 'squat') {
                if(squatState==='up' && acc.y < 3) squatState='down';
                if(squatState==='down' && acc.y > 7) { squatState='up'; Client.send(1); }
            }
        };

        window.ondevicemotion = handler;
        
        window.ondeviceorientation = (e) => {
            if(!Client.game || $('s-c-ctrl').classList.contains('hidden')) return;
            if (Client.game.t === 'balance') {
                if(Math.abs(e.beta)<10 && Math.abs(e.gamma)<10) {
                    if(Math.random()>0.92) Client.send(1);
                } else {
                    if(Math.random()>0.9) Client.send(-1);
                }
            }
        };
    }
};
</script>
</body>
</html>
