<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>100 GAMES PARTY</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Teko:wght@400;700&family=Zen+Kaku+Gothic+New:wght@500;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #121212;
            --primary: #00ff88;
            --accent: #ff0055;
            --text: #ffffff;
            --panel: #1e1e1e;
        }
        * { box-sizing: border-box; touch-action: manipulation; user-select: none; -webkit-user-select: none; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: 'Zen Kaku Gothic New', sans-serif; overflow: hidden; height: 100vh; width: 100vw; }

        /* ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ç®¡ç† */
        .screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: var(--bg); transition: opacity 0.3s; z-index: 10;
        }
        .hidden { opacity: 0; pointer-events: none; z-index: -1; }

        /* ãƒ‡ã‚¶ã‚¤ãƒ³è¦ç´  */
        h1, h2 { font-family: 'Teko', sans-serif; text-transform: uppercase; margin: 0; line-height: 1; }
        h1 { font-size: 4rem; color: var(--primary); text-shadow: 0 0 20px rgba(0,255,136,0.5); }
        .btn {
            background: transparent; border: 2px solid var(--primary); color: var(--primary);
            padding: 15px 40px; font-size: 1.5rem; font-family: 'Teko', sans-serif;
            margin: 10px; cursor: pointer; border-radius: 50px; transition: 0.2s; text-transform: uppercase;
            min-width: 200px;
        }
        .btn:active { background: var(--primary); color: #000; transform: scale(0.95); }
        .btn-red { border-color: var(--accent); color: var(--accent); }
        .btn-red:active { background: var(--accent); color: white; }

        /* ãƒ›ã‚¹ãƒˆç”»é¢ */
        #game-list {
            display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;
            width: 95%; max-width: 800px; height: 60vh; overflow-y: auto;
            padding: 10px; background: rgba(255,255,255,0.05); border-radius: 10px;
        }
        .game-card {
            background: #2a2a2a; border: 1px solid #444; padding: 15px; border-radius: 8px;
            cursor: pointer; text-align: left; transition: 0.2s; display: flex; align-items: center;
        }
        .game-card:hover { border-color: var(--primary); background: #333; }
        .gc-num { font-size: 1.5rem; font-family: 'Teko'; color: #666; margin-right: 10px; width: 40px; }
        .gc-name { font-weight: bold; font-size: 1rem; }
        
        /* ã‚²ãƒ¼ãƒ ä¸­ç”»é¢ */
        .timer-bar { position: fixed; top: 0; left: 0; height: 10px; background: var(--accent); width: 100%; transition: width 0.1s linear; }
        .big-text { font-size: 5rem; font-family: 'Teko'; text-shadow: 0 0 20px white; }
        .sub-text { font-size: 1.2rem; color: #aaa; text-align: center; max-width: 80%; }

        /* ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆæ“ä½œç”»é¢ */
        .ctrl-grid { width: 100%; height: 100%; display: grid; place-items: center; }
        .tap-btn {
            width: 90%; height: 70%; background: var(--accent); border: none; border-radius: 20px;
            font-size: 3rem; color: white; font-weight: bold; box-shadow: 0 10px 0 #900;
        }
        .tap-btn:active { transform: translateY(10px); box-shadow: 0 0 0 #900; }
        
        .quiz-grid { display: grid; grid-template-columns: 1fr 1fr; width: 100%; height: 100%; }
        .q-btn { width: 100%; height: 100%; border: none; font-size: 3rem; font-weight: bold; color: white; }
        .c-red { background: #ff4757; } .c-blue { background: #2e86de; }
        .c-green { background: #2ed573; } .c-yellow { background: #ffa502; }

        input { font-size: 2rem; text-align: center; background: #333; color: white; border: none; padding: 10px; width: 80%; border-radius: 10px; margin-bottom: 20px; }
    </style>
</head>
<body>

<div id="s-top" class="screen">
    <h1>100 GAMES</h1>
    <p>ç©¶æ¥µã®ãƒ‘ãƒ¼ãƒ†ã‚£ã‚²ãƒ¼ãƒ é›†</p>
    <button class="btn" onclick="App.startHost()">ğŸ‘‘ ãƒ›ã‚¹ãƒˆ (éƒ¨å±‹ä½œæˆ)</button>
    <button class="btn btn-red" onclick="App.startClient()">ğŸ“± ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ (å‚åŠ )</button>
</div>

<div id="s-h-lobby" class="screen hidden">
    <h2>ROOM ID</h2>
    <h1 id="disp-id" style="letter-spacing: 5px;">...</h1>
    <div id="qrcode" style="background:white; padding:10px; border-radius:10px; margin:20px;"></div>
    <p>å‚åŠ äººæ•°: <span id="p-count" style="font-size:2rem; color:var(--primary)">0</span> äºº</p>
    <button class="btn" onclick="Host.showMenu()">ã‚²ãƒ¼ãƒ é¸æŠã¸</button>
</div>

<div id="s-h-menu" class="screen hidden">
    <h2>SELECT GAME</h2>
    <div id="game-list"></div>
</div>

<div id="s-h-play" class="screen hidden">
    <div class="timer-bar" id="timer-bar"></div>
    <h2 id="g-name" style="margin-top:50px;">GAME NAME</h2>
    <div id="g-main" class="big-text">READY</div>
    <div id="g-sub" class="sub-text">èª¬æ˜æ–‡</div>
    <div id="live-rank" style="margin-top:20px; font-size:1.5rem;"></div>
</div>

<div id="s-h-result" class="screen hidden">
    <h1 style="color:var(--accent)">WINNER</h1>
    <div id="res-name" class="big-text">???</div>
    <div id="res-score" style="font-size:2rem; color:var(--primary)">0 PTS</div>
    <button class="btn" onclick="Host.showMenu()">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</button>
</div>

<div id="s-c-login" class="screen hidden">
    <h2>ENTER ROOM ID</h2>
    <input type="text" id="inp-room" placeholder="ID (4æ–‡å­—)" maxlength="4" style="text-transform:uppercase;">
    <input type="text" id="inp-name" placeholder="ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ " maxlength="8">
    <button class="btn btn-red" onclick="Client.join()">å‚åŠ ã™ã‚‹</button>
</div>

<div id="s-c-perm" class="screen hidden">
    <h2>ã‚»ãƒ³ã‚µãƒ¼æº–å‚™</h2>
    <p>ã‚²ãƒ¼ãƒ ã‚’æ¥½ã—ã‚€ãŸã‚ã«<br>è¨±å¯ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„</p>
    <button class="btn" onclick="Client.requestPerm()">è¨±å¯ã—ã¦å¾…æ©Ÿ</button>
</div>

<div id="s-c-wait" class="screen hidden">
    <h1 style="font-size:2rem; animation:pulse 1s infinite">WAITING...</h1>
    <p>ãƒ›ã‚¹ãƒˆãŒã‚²ãƒ¼ãƒ ã‚’é¸ã‚“ã§ã„ã¾ã™</p>
</div>

<div id="s-c-ctrl" class="screen hidden">
    <div id="ctrl-area" style="width:100%; height:100%;"></div>
</div>

<script type="module">
    // ==========================================
    // FIREBASE SETUP
    // ==========================================
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
    import { getDatabase, ref, set, onValue, update, onDisconnect, remove, push, child } 
           from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDbZzTMvUkG2LXIGY4ux0KBTmnAdqP236s",
        authDomain: "game-4f2d9.firebaseapp.com",
        databaseURL: "https://game-4f2d9-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "game-4f2d9",
        storageBucket: "game-4f2d9.firebasestorage.app",
        messagingSenderId: "574316347824",
        appId: "1:574316347824:web:cf686040628e25ad615675",
        measurementId: "G-T0ZKQCC9L3"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // ==========================================
    // GAME DATABASE (100 GAMES GENERATOR)
    // ==========================================
    const GAMES = [];
    
    // Core Archetypes
    const ARCHETYPES = {
        tap:   { name: "é€£æ‰“", type: "tap", icon: "ğŸ”¥", desc: "ç”»é¢ã‚’é€£æ‰“ã—ã‚ï¼" },
        shake: { name: "ãƒ•ãƒªãƒ•ãƒª", type: "shake", icon: "ğŸ‘‹", desc: "ã‚¹ãƒãƒ›ã‚’æŒ¯ã‚Œï¼" },
        quiz:  { name: "4æŠã‚¯ã‚¤ã‚º", type: "quiz", icon: "â“", desc: "æ­£ã—ã„è‰²ã‚’æŠ¼ã›ï¼" },
        luck:  { name: "é‹è©¦ã—", type: "luck", icon: "ğŸ²", desc: "é‹ã‚’å¤©ã«ä»»ã›ã‚" },
        just:  { name: "ä½“å†…æ™‚è¨ˆ", type: "tap", icon: "â±ï¸", desc: "æŒ‡å®šç§’æ•°ã§æ­¢ã‚ã‚" }
    };

    // 1-10: Unique Classics
    GAMES.push({ id: 1, ...ARCHETYPES.tap, name: "é€£æ‰“ç‹æ±ºå®šæˆ¦", time: 10 });
    GAMES.push({ id: 2, ...ARCHETYPES.shake, name: "ã‚·ã‚§ã‚¤ã‚¯ãƒ»ãƒãƒˆãƒ«", time: 10 });
    GAMES.push({ id: 3, ...ARCHETYPES.quiz, name: "æ—©æŠ¼ã—ã‚«ãƒ©ãƒ¼", time: 15 });
    GAMES.push({ id: 4, ...ARCHETYPES.luck, name: "ãƒ­ã‚·ã‚¢ãƒ³ãƒ»ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆ", time: 5 });
    GAMES.push({ id: 5, ...ARCHETYPES.tap, name: "100å›ã‚¿ãƒƒãƒ—è€ä¹…", time: 30, goal: 100 });
    GAMES.push({ id: 6, ...ARCHETYPES.shake, name: "ãƒ—ãƒ­ãƒ†ã‚¤ãƒ³ã‚·ã‚§ã‚¤ã‚¯", time: 5, mod: "hard" });
    GAMES.push({ id: 7, ...ARCHETYPES.just, name: "5ç§’ã‚¸ãƒ£ã‚¹ãƒˆ", time: 10, target: 5.0 });
    GAMES.push({ id: 8, ...ARCHETYPES.tap, name: "è¶…é«˜é€Ÿ3ç§’ãƒãƒˆãƒ«", time: 3 });
    GAMES.push({ id: 9, ...ARCHETYPES.quiz, name: "ç›´æ„Ÿã‚µãƒã‚¤ãƒãƒ«", time: 10 });
    GAMES.push({ id: 10, ...ARCHETYPES.luck, name: "ä»Šæ—¥ã®é‹å‹¢", time: 5 });

    // 11-50: Tap Variations (Different times and difficulties)
    for(let i=11; i<=50; i++) {
        let t = 5 + (i % 10) * 2; 
        GAMES.push({ id: i, type: "tap", name: `é€£æ‰“Lv.${i-10} (${t}ç§’)`, desc: `${t}ç§’é–“é€£æ‰“ã—ç¶šã‘ã‚ï¼`, time: t, icon: "ğŸ‘†" });
    }

    // 51-80: Shake Variations
    for(let i=51; i<=80; i++) {
        let t = 5 + (i % 5) * 3;
        GAMES.push({ id: i, type: "shake", name: `ã‚·ã‚§ã‚¤ã‚¯Lv.${i-50} (${t}ç§’)`, desc: `å…¨åŠ›ã§${t}ç§’é–“è§¦ã‚Œï¼`, time: t, icon: "ğŸ“±" });
    }

    // 81-100: Mixed Luck & Quiz
    for(let i=81; i<=100; i++) {
        if(i % 2 === 0) {
            GAMES.push({ id: i, type: "luck", name: `é‹è©¦ã— No.${i}`, desc: "ç¥ˆã‚Œã€‚", time: 3, icon: "ğŸ°" });
        } else {
            GAMES.push({ id: i, type: "quiz", name: `åå°„ç¥çµŒ No.${i}`, desc: "ãƒ›ã‚¹ãƒˆãŒè¨€ã£ãŸè‰²ã‚’æŠ¼ã›ï¼", time: 5, icon: "âš¡" });
        }
    }

    // ==========================================
    // APP STATE
    // ==========================================
    const Utils = {
        show: (id) => {
            document.querySelectorAll('.screen').forEach(el => el.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        },
        genId: () => Math.random().toString(36).substr(2, 4).toUpperCase()
    };

    let myId = Utils.genId();
    let roomId = null;
    let players = {};
    let isHost = false;

    // ==========================================
    // GLOBAL APP CONTROLLER
    // ==========================================
    window.App = {
        startHost: () => {
            isHost = true;
            Host.init();
        },
        startClient: () => {
            isHost = false;
            // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒã‚§ãƒƒã‚¯
            const params = new URLSearchParams(window.location.search);
            if(params.get('room')) document.getElementById('inp-room').value = params.get('room');
            Utils.show('s-c-login');
        }
    };

    // ==========================================
    // HOST LOGIC
    // ==========================================
    window.Host = {
        timer: null,

        init: async () => {
            roomId = Utils.genId();
            
            // éƒ¨å±‹ä½œæˆ
            const roomRef = ref(db, `rooms/${roomId}`);
            await set(roomRef, { status: 'lobby', created: Date.now() });
            onDisconnect(roomRef).remove(); // åˆ‡æ–­æ™‚ã«éƒ¨å±‹å‰Šé™¤

            // UIæ›´æ–°
            document.getElementById('disp-id').innerText = roomId;
            new QRCode(document.getElementById('qrcode'), {
                text: `${location.href.split('?')[0]}?room=${roomId}`,
                width: 150, height: 150
            });
            Utils.show('s-h-lobby');

            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ç›£è¦–
            onValue(ref(db, `rooms/${roomId}/players`), (snap) => {
                players = snap.val() || {};
                document.getElementById('p-count').innerText = Object.keys(players).length;
            });
        },

        showMenu: () => {
            Utils.show('s-h-menu');
            const list = document.getElementById('game-list');
            list.innerHTML = "";
            
            GAMES.forEach(g => {
                const el = document.createElement('div');
                el.className = "game-card";
                el.innerHTML = `<span class="gc-num">${g.id}</span><div class="gc-info"><div class="gc-name">${g.icon} ${g.name}</div></div>`;
                el.onclick = () => Host.startGame(g.id);
                list.appendChild(el);
            });
            
            // éƒ¨å±‹ã®çŠ¶æ…‹ã‚’æ›´æ–°
            update(ref(db, `rooms/${roomId}`), { status: 'menu' });
        },

        startGame: (gid) => {
            const game = GAMES.find(g => g.id === gid);
            Utils.show('s-h-play');
            
            // UIåˆæœŸåŒ–
            document.getElementById('g-name').innerText = game.name;
            document.getElementById('g-main').innerText = "READY";
            document.getElementById('g-sub').innerText = game.desc;
            document.getElementById('timer-bar').style.width = "100%";
            document.getElementById('live-rank').innerText = "";

            // ã‚¹ã‚³ã‚¢ãƒªã‚»ãƒƒãƒˆ
            if(players) {
                Object.keys(players).forEach(pid => {
                    set(ref(db, `rooms/${roomId}/players/${pid}/score`), 0);
                });
            }

            // ã‚²ãƒ¼ãƒ é–‹å§‹ä¿¡å·é€ä¿¡
            update(ref(db, `rooms/${roomId}`), {
                status: 'playing',
                game: game
            });

            // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³
            let count = 3;
            const cdTimer = setInterval(() => {
                count--;
                if(count > 0) {
                    document.getElementById('g-main').innerText = count;
                } else {
                    clearInterval(cdTimer);
                    document.getElementById('g-main').innerText = "GO!";
                    Host.runTimer(game);
                }
            }, 1000);
        },

        runTimer: (game) => {
            let time = game.time;
            const maxTime = game.time;
            
            Host.timer = setInterval(() => {
                time -= 0.1;
                const pct = (time / maxTime) * 100;
                document.getElementById('timer-bar').style.width = `${pct}%`;

                // é€”ä¸­çµŒéï¼ˆä¸Šä½1åï¼‰è¡¨ç¤º
                const sorted = Object.values(players).sort((a,b) => (b.score||0) - (a.score||0));
                if(sorted.length > 0) {
                    document.getElementById('live-rank').innerText = `TOP: ${sorted[0].name} (${Math.floor(sorted[0].score)})`;
                }

                if(time <= 0) {
                    clearInterval(Host.timer);
                    Host.finishGame();
                }
            }, 100);
        },

        finishGame: () => {
            update(ref(db, `rooms/${roomId}`), { status: 'result' });
            Utils.show('s-h-result');
            
            const sorted = Object.values(players).sort((a,b) => (b.score||0) - (a.score||0));
            const winner = sorted[0];
            
            document.getElementById('res-name').innerText = winner ? winner.name : "NO WINNER";
            document.getElementById('res-score').innerText = winner ? `${Math.floor(winner.score)} PTS` : "";
        }
    };

    // ==========================================
    // CLIENT LOGIC
    // ==========================================
    window.Client = {
        localScore: 0,
        gameType: null,
        
        join: async () => {
            const rid = document.getElementById('inp-room').value.toUpperCase();
            const name = document.getElementById('inp-name').value || "Guest";
            
            if(rid.length !== 4) return alert("IDã‚’ç¢ºèªã—ã¦ãã ã•ã„");
            roomId = rid;

            const myRef = ref(db, `rooms/${roomId}/players/${myId}`);
            
            try {
                await set(myRef, { name: name, score: 0 });
                onDisconnect(myRef).remove();
                
                // ã‚»ãƒ³ã‚µãƒ¼è¨±å¯ãŒå¿…è¦ã‹ãƒã‚§ãƒƒã‚¯
                if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
                    Utils.show('s-c-perm');
                } else {
                    Client.wait();
                }
            } catch(e) {
                alert("æ¥ç¶šã‚¨ãƒ©ãƒ¼: IDãŒé–“é•ã£ã¦ã„ã‚‹ã‹ã€éƒ¨å±‹ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
            }
        },

        requestPerm: () => {
            DeviceMotionEvent.requestPermission()
                .then(res => {
                    if (res === 'granted') Client.wait();
                    else alert("è¨±å¯ãŒãªã„ã¨ä¸€éƒ¨ã®ã‚²ãƒ¼ãƒ ã§éŠã¹ã¾ã›ã‚“");
                })
                .catch(e => console.error(e));
        },

        wait: () => {
            Utils.show('s-c-wait');
            Client.initSensors();

            // éƒ¨å±‹ã®çŠ¶æ…‹ç›£è¦–
            onValue(ref(db, `rooms/${roomId}`), (snap) => {
                const data = snap.val();
                if(!data) return; // éƒ¨å±‹è§£æ•£

                if(data.status === 'playing' && data.game) {
                    Client.setupController(data.game);
                } else if (data.status === 'result' || data.status === 'menu' || data.status === 'lobby') {
                    Utils.show('s-c-wait');
                    // ãƒã‚¤ãƒ–åœæ­¢ãªã©
                }
            });
        },

        setupController: (game) => {
            Utils.show('s-c-ctrl');
            const area = document.getElementById('ctrl-area');
            area.innerHTML = "";
            Client.localScore = 0;
            Client.gameType = game.type;

            // ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ç”Ÿæˆ
            if (game.type === 'tap') {
                area.innerHTML = `<button id="btn-tap" class="tap-btn">PUSH!</button>`;
                document.getElementById('btn-tap').onpointerdown = (e) => {
                    e.preventDefault();
                    Client.addScore(1);
                    Client.vib(30);
                };
            } else if (game.type === 'quiz') {
                area.innerHTML = `
                <div class="quiz-grid">
                    <button class="q-btn c-red" onclick="Client.addScore(1)">A</button>
                    <button class="q-btn c-blue" onclick="Client.addScore(1)">B</button>
                    <button class="q-btn c-green" onclick="Client.addScore(1)">C</button>
                    <button class="q-btn c-yellow" onclick="Client.addScore(1)">D</button>
                </div>`;
            } else if (game.type === 'shake') {
                area.innerHTML = `<div style="color:white; font-size:2rem; text-align:center;">ã‚¹ãƒãƒ›ã‚’æŒ¯ã‚Œï¼ï¼<br>ğŸ‘‹ğŸ“±ğŸ‘‹</div>`;
            } else if (game.type === 'luck') {
                area.innerHTML = `<button class="tap-btn" style="background:#888" onclick="Client.addScore(Math.floor(Math.random()*10)); this.disabled=true;">é‹è©¦ã—</button>`;
            }
        },

        addScore: (val) => {
            Client.localScore += val;
            // é€šä¿¡é‡å‰Šæ¸›ã®ãŸã‚ã€ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä½¿ã‚ãšç›´æ¥ã‚»ãƒƒãƒˆï¼ˆç°¡æ˜“å®Ÿè£…ï¼‰
            set(ref(db, `rooms/${roomId}/players/${myId}/score`), Client.localScore);
        },

        vib: (ms) => {
            if(navigator.vibrate) navigator.vibrate(ms);
        },

        initSensors: () => {
            let lastX = 0, lastY = 0, lastZ = 0;
            let lastUpdate = 0;

            window.addEventListener('devicemotion', (e) => {
                if(Client.gameType !== 'shake') return;
                
                const now = Date.now();
                if(now - lastUpdate < 100) return; // 0.1ç§’é–“éš”ã§åˆ¤å®š

                const acc = e.accelerationIncludingGravity;
                if(!acc) return;

                const delta = Math.abs(acc.x + acc.y + acc.z - lastX - lastY - lastZ);
                if(delta > 15) { // é–¾å€¤
                    Client.addScore(1);
                    Client.vib(50);
                }

                lastX = acc.x; lastY = acc.y; lastZ = acc.z;
                lastUpdate = now;
            });
        }
    };
</script>
</body>
</html>
