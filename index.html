<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>200ã‚²ãƒ¼ãƒ  & ã‚»ãƒ³ã‚µãƒ¼ãƒãƒˆãƒ«</title>
    <style>
        body { font-family: 'Helvetica Neue', sans-serif; text-align: center; background: #222; color: #fff; padding: 20px; touch-action: manipulation; }
        h1 { font-size: 24px; color: #ffcc00; margin-bottom: 5px; }
        .sub-title { font-size: 14px; color: #aaa; margin-bottom: 20px; }
        .card { background: #333; border-radius: 15px; padding: 20px; margin: 0 auto 20px auto; max-width: 400px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); min-height: 200px; display: flex; flex-direction: column; justify-content: center; align-items: center; position: relative; }
        .game-title { font-size: 26px; font-weight: bold; margin-bottom: 10px; color: #00d2ff; }
        .game-desc { font-size: 16px; line-height: 1.5; color: #ddd; }
        .category-badge { position: absolute; top: 10px; right: 10px; background: #555; padding: 5px 10px; border-radius: 10px; font-size: 12px; }
        .btn { background: #ff4081; color: white; border: none; padding: 15px 30px; font-size: 18px; border-radius: 50px; cursor: pointer; margin-top: 10px; width: 100%; max-width: 300px; box-shadow: 0 4px 0 #c60055; transition: transform 0.1s; }
        .btn:active { transform: translateY(4px); box-shadow: none; }
        .btn-sensor { background: #00e676; box-shadow: 0 4px 0 #00a854; margin-top: 20px; display: none; }
        .status { font-size: 12px; color: #888; margin-top: 20px; border-top: 1px solid #444; padding-top: 10px; }
        #shakeCount { font-size: 60px; color: #ffcc00; font-weight: bold; margin-top: 10px; display: none; }
    </style>
</head>
<body>

    <h1>ğŸ”¥ ç„¡é™ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆ 200</h1>
    <div class="sub-title">ã‚¹ãƒãƒ›ï¼†ä½“ã‚’ä½¿ã†ã‚²ãƒ¼ãƒ é›†</div>
    
    <div class="card">
        <div id="gameContent">
            <div class="game-title">Ready?</div>
            <div class="game-desc">ä¸‹ã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã‚²ãƒ¼ãƒ ã‚’ã‚¹ã‚¿ãƒ¼ãƒˆï¼<br>ï¼ˆåˆå›ã®ã¿ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆã«æ•°ç§’ã‹ã‹ã‚Šã¾ã™ï¼‰</div>
        </div>
        <div id="shakeCount">0</div>
    </div>

    <button id="nextBtn" class="btn">ğŸ² æ¬¡ã®ã‚²ãƒ¼ãƒ ã‚’å¼•ã</button>
    
    <button id="sensorBtn" class="btn btn-sensor">ğŸ“± ã‚»ãƒ³ã‚µãƒ¼è¨±å¯ (ä½“ã‚’ä½¿ã†ã‚²ãƒ¼ãƒ ç”¨)</button>

    <div id="status" class="status">æ¥ç¶š: åˆæœŸåŒ–ä¸­...</div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { 
            initializeFirestore, 
            persistentLocalCache, 
            persistentMultipleTabManager,
            collection, 
            getDocs, 
            doc, 
            writeBatch, 
            onSnapshot
        } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // â–¼ ã‚ãªãŸã®è¨­å®šï¼ˆã“ã‚Œã‚’ä½¿ã„ã¾ã™ï¼‰ â–¼
        const firebaseConfig = {
            apiKey: "AIzaSyDbZzTMvUkG2LXIGY4ux0KBTmnAdqP236s",
            authDomain: "game-4f2d9.firebaseapp.com",
            projectId: "game-4f2d9",
            storageBucket: "game-4f2d9.firebasestorage.app",
            messagingSenderId: "574316347824",
            appId: "1:574316347824:web:cf686040628e25ad615675",
            measurementId: "G-T0ZKQCC9L3"
        };

        const app = initializeApp(firebaseConfig);
        
        // ã€ä¿®æ­£ç‚¹ã€‘è­¦å‘Šã‚’æ¶ˆã™ãŸã‚ã®æœ€æ–°ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥è¨­å®š
        const db = initializeFirestore(app, {
            localCache: persistentLocalCache({
                tabManager: persistentMultipleTabManager()
            })
        });

        const statusDiv = document.getElementById('status');
        const gameContent = document.getElementById('gameContent');
        const nextBtn = document.getElementById('nextBtn');
        const sensorBtn = document.getElementById('sensorBtn');
        const shakeCountDiv = document.getElementById('shakeCount');

        let allGames = [];
        let isSensorGame = false;
        let shakeScore = 0;

        // ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ & åˆå›ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ
        async function loadGames() {
            try {
                statusDiv.textContent = "ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«æ¥ç¶šä¸­...";
                const querySnapshot = await getDocs(collection(db, "games200"));
                
                if (querySnapshot.empty) {
                    statusDiv.textContent = "åˆå›ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—: 200å€‹ã®ã‚²ãƒ¼ãƒ ã‚’ç”Ÿæˆä¸­... (æ•°ç§’ãŠå¾…ã¡ãã ã•ã„)";
                    await generate200Games();
                    loadGames(); // å†èª­ã¿è¾¼ã¿
                } else {
                    allGames = [];
                    querySnapshot.forEach((doc) => {
                        allGames.push(doc.data());
                    });
                    
                    // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ¥ç¶šçŠ¶æ…‹ç›£è¦–
                    onSnapshot(collection(db, "games200"), (snap) => {
                        const source = snap.metadata.fromCache ? "ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰ (é€šä¿¡ãªã—ã§å‹•ä½œä¸­)" : "ã‚ªãƒ³ãƒ©ã‚¤ãƒ³";
                        statusDiv.textContent = `çŠ¶æ…‹: ${source} / ã‚²ãƒ¼ãƒ æ•°: ${allGames.length}å€‹`;
                    });
                }
            } catch (e) {
                console.error(e);
                statusDiv.textContent = "ã‚¨ãƒ©ãƒ¼: " + e.message + " (Firestoreã®ãƒ«ãƒ¼ãƒ«è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„)";
            }
        }

        // ã‚²ãƒ¼ãƒ ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«è¡¨ç¤º
        nextBtn.addEventListener('click', () => {
            if (allGames.length === 0) return;
            
            // ã‚»ãƒ³ã‚µãƒ¼ã‚²ãƒ¼ãƒ ã®ãƒªã‚»ãƒƒãƒˆ
            stopSensorGame();

            const randomGame = allGames[Math.floor(Math.random() * allGames.length)];
            
            // HTMLè¡¨ç¤ºæ›´æ–°
            gameContent.innerHTML = `
                <div class="category-badge">${randomGame.category}</div>
                <div class="game-title">${randomGame.title}</div>
                <div class="game-desc">${randomGame.desc}</div>
            `;

            // ä½“ã‚’ä½¿ã†ã‚»ãƒ³ã‚µãƒ¼ã‚²ãƒ¼ãƒ ã®å ´åˆã®å‡¦ç†
            if (randomGame.category === "ã‚»ãƒ³ã‚µãƒ¼") {
                isSensorGame = true;
                shakeScore = 0;
                shakeCountDiv.textContent = "0";
                shakeCountDiv.style.display = "block";
                
                // iOSç”¨ã®è¨±å¯ãƒœã‚¿ãƒ³è¡¨ç¤ºåˆ¤å®š
                if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
                    sensorBtn.style.display = "inline-block";
                    gameContent.innerHTML += `<p style="color:#ff4081; font-weight:bold; margin-top:10px;">ğŸ‘‡ ä¸‹ã®ç·‘ãƒœã‚¿ãƒ³ã§ã‚»ãƒ³ã‚µãƒ¼ã‚’ONã«ï¼</p>`;
                } else {
                    startSensor();
                }
            }
        });

        // --- ã‚»ãƒ³ã‚µãƒ¼(åŠ é€Ÿåº¦)å‡¦ç† ---
        sensorBtn.addEventListener('click', () => {
            DeviceMotionEvent.requestPermission()
                .then(response => {
                    if (response === 'granted') {
                        sensorBtn.style.display = 'none';
                        startSensor();
                    } else {
                        alert('è¨±å¯ãŒãªã„ã¨ã“ã®ã‚²ãƒ¼ãƒ ã¯éŠã¹ã¾ã›ã‚“');
                    }
                })
                .catch(console.error);
        });

        function startSensor() {
            window.addEventListener('devicemotion', handleMotion);
        }

        function stopSensorGame() {
            isSensorGame = false;
            shakeCountDiv.style.display = "none";
            sensorBtn.style.display = "none";
            window.removeEventListener('devicemotion', handleMotion);
        }

        let lastX = 0, lastY = 0, lastZ = 0;
        function handleMotion(event) {
            if (!isSensorGame) return;
            
            const acc = event.accelerationIncludingGravity;
            if(!acc) return;

            // ã‚·ã‚§ã‚¤ã‚¯åˆ¤å®š
            const deltaX = Math.abs(lastX - acc.x);
            const deltaY = Math.abs(lastY - acc.y);
            const deltaZ = Math.abs(lastZ - acc.z);

            if (deltaX + deltaY + deltaZ > 20) { // æ„Ÿåº¦
                shakeScore++;
                shakeCountDiv.textContent = shakeScore;
            }

            lastX = acc.x;
            lastY = acc.y;
            lastZ = acc.z;
        }

        // --- 200å€‹ã®ã‚²ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ ---
        async function generate200Games() {
            const batch = writeBatch(db);
            
            const templates = [
                {t: "é«˜é€Ÿé€£æ‰“", d: "10ç§’é–“ã§ç”»é¢ã‚’ä½•å›ã‚¿ãƒƒãƒ—ã§ãã‚‹ï¼Ÿ", c: "ã‚¢ã‚¯ã‚·ãƒ§ãƒ³"},
                {t: "ã‚¹ãƒãƒ›ã‚·ã‚§ã‚¤ã‚¯", d: "30ç§’é–“å…¨åŠ›ã§ã‚¹ãƒãƒ›ã‚’æŒ¯ã‚Œï¼", c: "ã‚»ãƒ³ã‚µãƒ¼"},
                {t: "ç„¡éŸ³ã‚¹ã‚¯ãƒ¯ãƒƒãƒˆ", d: "éŸ³ã‚’ç«‹ã¦ãšã«ã‚¹ã‚¯ãƒ¯ãƒƒãƒˆ10å›", c: "ã‚»ãƒ³ã‚µãƒ¼"},
                {t: "çœŸé¡”ãƒãƒ£ãƒ¬ãƒ³ã‚¸", d: "å…¨å“¡ãŠäº’ã„ã‚’è¦‹ã¤ã‚ã‚‹ã€‚ç¬‘ã£ãŸã‚‰è² ã‘ã€‚", c: "å¯¾æˆ¦"},
                {t: "å¤ä»Šæ±è¥¿", d: "ãŠé¡Œï¼šå›½åã€‚ãƒªã‚ºãƒ ã‚ˆãç­”ãˆã‚ˆã†ã€‚", c: "é ­è„³"},
                {t: "ç‰‡è¶³ãƒãƒ©ãƒ³ã‚¹", d: "ç›®ã‚’é–‰ã˜ã¦ç‰‡è¶³ç«‹ã¡ã€‚èª°ãŒä¸€ç•ªé•·ã„ï¼Ÿ", c: "ä½“"},
                {t: "æ—©å£è¨€è‘‰", d: "ã€Œèµ¤å·»ç´™é’å·»ç´™é»„å·»ç´™ã€3å›è¨€ãˆã‚‹ï¼Ÿ", c: "é ­è„³"},
                {t: "äººé–“çŸ¥æµã®è¼ª", d: "æ‰‹ã‚’ã¤ãªã„ã§çµ¡ã¾ã‚‹ã€‚ã»ã©ã‘ã‚‹ã‹ï¼Ÿ", c: "ä½“"},
                {t: "ã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼", d: "å£°ã‚’å‡ºã•ãšã«ã€Œã‚´ãƒªãƒ©ã€ã‚’è¡¨ç¾ã›ã‚ˆ", c: "å¯¾æˆ¦"},
                {t: "ä½“å†…æ™‚è¨ˆ", d: "ç›®ã‚’é–‰ã˜ã¦ã€Œ10ç§’ã€çµŒã£ãŸã¨æ€ã£ãŸã‚‰æŒ™æ‰‹", c: "é ­è„³"}
            ];

            // 200å€‹ç”Ÿæˆ
            for (let i = 0; i < 200; i++) {
                const ref = doc(collection(db, "games200"));
                const tmpl = templates[i % templates.length];
                
                batch.set(ref, {
                    title: `${tmpl.t} LV.${Math.floor(i/10)+1}`,
                    desc: tmpl.d,
                    category: tmpl.c,
                    id: i
                });
            }
            await batch.commit();
        }

        loadGames();
    </script>
</body>
</html>
