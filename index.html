<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SHAKE BATTLE ARENA</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Black+Ops+One&family=Kosugi+Maru&display=swap');

        body { font-family: 'Kosugi Maru', sans-serif; margin: 0; background: #050505; color: white; overflow: hidden; touch-action: none; }
        .hidden { display: none !important; }
        .full-screen { position: absolute; top:0; left:0; width: 100vw; height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; }

        /* --- UI: „Éõ„Çπ„ÉàÁîªÈù¢ (PC) --- */
        #host-view { background: radial-gradient(circle, #1a1a1a 0%, #000 100%); }
        h1 { font-family: 'Black Ops One', cursive; font-size: 50px; color: #00d4ff; text-shadow: 0 0 15px #00d4ff; margin: 0 0 20px 0; letter-spacing: 2px; }

        /* „É¢„Éº„ÉâÈÅ∏Êäû */
        #lobby-ui { text-align: center; z-index: 10; }
        .mode-container { display: flex; gap: 20px; margin-top: 30px; justify-content: center; }
        .mode-card { width: 200px; padding: 20px; background: rgba(255,255,255,0.05); border: 1px solid #444; border-radius: 10px; cursor: pointer; transition: 0.3s; }
        .mode-card:hover { background: rgba(0, 212, 255, 0.2); border-color: #00d4ff; transform: scale(1.05); }
        .mode-title { font-family: 'Black Ops One'; font-size: 24px; margin-bottom: 10px; color: #fff; }
        .mode-desc { font-size: 14px; color: #aaa; }

        /* „Ç≤„Éº„É†ÁîªÈù¢ÂÖ±ÈÄö */
        #game-area { width: 90%; height: 60vh; position: relative; display: flex; align-items: flex-end; justify-content: center; margin-top: 20px; }
        #timer { font-family: 'Black Ops One'; font-size: 80px; position: absolute; top: 10px; right: 30px; color: #fff; }
        #game-message { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 60px; font-weight: bold; text-shadow: 0 0 20px black; width: 100%; text-align: center; z-index: 100; pointer-events: none; }

        /* „É¢„Éº„Éâ1: „Éê„Éà„É´„É≠„Ç§„É§„É´ */
        .player-bar { width: 60px; margin: 0 5px; background: linear-gradient(to top, #ff9800, #ffeb3b); border-radius: 5px 5px 0 0; position: relative; transition: height 0.1s; display: flex; flex-direction: column; justify-content: flex-end; align-items: center; }
        .player-name { position: absolute; bottom: -25px; font-size: 12px; width: 100px; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .player-score { font-weight: bold; margin-bottom: 5px; text-shadow: 0 0 5px black; font-size: 18px; }

        /* „É¢„Éº„Éâ2: „Éú„Çπ„Éê„Éà„É´ */
        #boss-container { width: 300px; height: 300px; background: #333; border-radius: 50%; position: relative; display: flex; align-items: center; justify-content: center; border: 5px solid #ff0000; box-shadow: 0 0 50px #ff0000; transition: transform 0.1s; }
        #boss-face { font-size: 150px; }
        #boss-hp-bar { position: absolute; bottom: -40px; width: 120%; height: 20px; background: #555; border-radius: 10px; overflow: hidden; }
        #boss-hp-fill { width: 100%; height: 100%; background: #ff0000; transition: width 0.2s; }
        .damage-text { position: absolute; color: #ffeb3b; font-weight: bold; font-size: 24px; animation: popUp 0.5s forwards; pointer-events: none; }
        @keyframes popUp { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-50px); } }

        /* „É¢„Éº„Éâ3: „ÉÅ„Éº„É†Êà¶ */
        #team-battle-area { width: 100%; height: 100px; background: #333; border-radius: 50px; position: relative; overflow: hidden; display: flex; margin-top: 100px; }
        #team-red-zone { height: 100%; background: #ff4444; width: 50%; transition: width 0.2s; display: flex; align-items: center; justify-content: flex-start; padding-left: 20px; box-sizing: border-box; font-size: 30px; font-weight: bold; white-space: nowrap; }
        #team-blue-zone { height: 100%; background: #4444ff; width: 50%; transition: width 0.2s; display: flex; align-items: center; justify-content: flex-end; padding-right: 20px; box-sizing: border-box; font-size: 30px; font-weight: bold; white-space: nowrap; }
        .vs-icon { position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); font-size: 50px; background: #000; border-radius: 50%; padding: 10px; z-index: 5; border: 2px solid white; }

        /* --- UI: „Ç≥„É≥„Éà„É≠„Éº„É©„Éº („Çπ„Éû„Éõ) --- */
        #ctrl-view { background: #222; text-align: center; }
        #shake-btn { width: 220px; height: 220px; border-radius: 50%; background: #444; border: 8px solid #666; display: flex; align-items: center; justify-content: center; font-size: 30px; font-weight: bold; color: #888; margin: 0 auto; user-select: none; transition: 0.1s; box-shadow: 0 10px 20px rgba(0,0,0,0.5); }
        #shake-btn.active { background: #ff5722; color: white; border-color: #fff; transform: scale(0.95); box-shadow: 0 0 30px #ff5722; }
        
        .team-red-bg { background: #5a1a1a !important; }
        .team-blue-bg { background: #1a1a5a !important; }
        #ctrl-info { font-size: 20px; margin-top: 20px; color: #ccc; }
        #permission-ui { background: rgba(0,0,0,0.95); z-index: 999; }
    </style>
</head>
<body>

    <!-- HOST (PC) -->
    <div id="host-view" class="full-screen hidden">
        <h1>SHAKE BATTLE</h1>
        <div id="game-message"></div>
        <div id="timer"></div>

        <!-- „É≠„Éì„ÉºÁîªÈù¢ -->
        <div id="lobby-ui">
            <div id="qrcode" style="background: white; padding: 10px; display: inline-block; border-radius: 10px;"></div>
            <p id="room-id-display" style="color: #aaa; margin-top: 10px;"></p>
            <p style="color: yellow; font-size: 14px;">‚Äª„Çπ„Éû„Éõ„ÅØÁ∏¶ÁîªÈù¢„Åß„É≠„ÉÉ„ÇØ„ÇíËß£Èô§„Åó„Å¶„Éó„É¨„Ç§„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>

            <div class="mode-container">
                <div class="mode-card" onclick="startGame('royal')">
                    <div class="mode-title">‚öîÔ∏è BATTLE</div>
                    <div class="mode-desc">ÂÄã‰∫∫Êà¶<br>ÂõûÊï∞ÂãùË≤†ÔºÅ</div>
                </div>
                <div class="mode-card" onclick="startGame('boss')">
                    <div class="mode-title">üëπ BOSS</div>
                    <div class="mode-desc">ÂçîÂäõÊà¶<br>ÂÖ®Âì°„ÅßÂÄí„ÅõÔºÅ</div>
                </div>
                <div class="mode-card" onclick="startGame('team')">
                    <div class="mode-title">üî¥ TEAM üîµ</div>
                    <div class="mode-desc">ÂØæÊäóÊà¶<br>Á∂±Âºï„Åç„Éê„Éà„É´</div>
                </div>
            </div>
            <div id="player-count" style="margin-top:20px; font-size: 18px;">ÂèÇÂä†ËÄÖ: 0‰∫∫</div>
        </div>

        <!-- „Ç≤„Éº„É†„Ç®„É™„Ç¢ -->
        <div id="game-area" class="hidden"></div>
    </div>

    <!-- CONTROLLER (Smartphone) -->
    <div id="ctrl-view" class="full-screen hidden">
        <h2 id="ctrl-mode-title">WAITING...</h2>
        <div id="shake-btn">SHAKE!</div>
        <div id="ctrl-info">Ready?</div>
    </div>

    <!-- „Çª„É≥„Çµ„ÉºË®±ÂèØ -->
    <div id="permission-ui" class="full-screen hidden">
        <h2>‚ö†Ô∏è „Çª„É≥„Çµ„ÉºË®±ÂèØ ‚ö†Ô∏è</h2>
        <p>„Çπ„Éû„Éõ„ÇíÊåØ„Å£„Å¶ÈÅä„Å∂„Ç≤„Éº„É†„Åß„Åô</p>
        <button onclick="requestSensor()" style="padding: 15px 40px; font-size: 20px; background: #00d4ff; border: none; border-radius: 30px; margin-top:20px;">OK</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
        import { getDatabase, ref, set, onValue, update, remove, onDisconnect } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

        // FirebaseË®≠ÂÆö
        const firebaseConfig = {
            apiKey: "AIzaSyDbZzTMvUkG2LXIGY4ux0KBTmnAdqP236s",
            authDomain: "game-4f2d9.firebaseapp.com",
            databaseURL: "https://game-4f2d9-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "game-4f2d9",
            storageBucket: "game-4f2d9.firebasestorage.app",
            messagingSenderId: "574316347824",
            appId: "1:574316347824:web:cf686040628e25ad615675",
            measurementId: "G-T0ZKQCC9L3"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const params = new URLSearchParams(window.location.search);
        let role = params.get('role') || 'host';
        let roomId = params.get('room');
        const myId = Math.random().toString(36).substr(2, 5).toUpperCase();

        // --- HOST LOGIC ---
        if (role === 'host') {
            if (!roomId) {
                roomId = Math.random().toString(36).substring(2, 6).toUpperCase();
                window.location.replace(`?role=host&room=${roomId}`);
            }

            document.getElementById('host-view').classList.remove('hidden');
            document.getElementById('room-id-display').innerText = `ROOM ID: ${roomId}`;
            
            new QRCode(document.getElementById("qrcode"), {
                text: `${window.location.origin}${window.location.pathname}?role=ctrl&room=${roomId}`,
                width: 150, height: 150
            });

            // State
            let players = {};
            let gameState = 'lobby';
            let bossHP = 1000;
            let maxBossHP = 1000;
            let timer = 0;
            let loopId = null;

            const roomRef = ref(db, `shakebattle/${roomId}`);
            
            // „Éó„É¨„Ç§„É§„ÉºÁÆ°ÁêÜ
            onValue(ref(db, `shakebattle/${roomId}/players`), (snap) => {
                players = snap.val() || {};
                document.getElementById('player-count').innerText = `ÂèÇÂä†ËÄÖ: ${Object.keys(players).length}‰∫∫`;
                if(gameState !== 'lobby') updateGameVisuals();
            });

            // „Ç≤„Éº„É†ÈñãÂßã
            window.startGame = (mode) => {
                const pKeys = Object.keys(players);
                if (pKeys.length === 0) return alert("„Éó„É¨„Ç§„É§„Éº„Åå„ÅÑ„Åæ„Åõ„ÇìÔºÅ");
                
                gameState = mode;
                document.getElementById('lobby-ui').classList.add('hidden');
                document.getElementById('game-area').classList.remove('hidden');
                
                // „É¢„Éº„ÉâÂàùÊúüÂåñ
                const updates = {};
                updates[`shakebattle/${roomId}/state`] = { status: 'running', mode: mode };
                
                if (mode === 'royal') {
                    pKeys.forEach(id => updates[`shakebattle/${roomId}/players/${id}/score`] = 0);
                    setupRoyalUI();
                    timer = 20;
                } else if (mode === 'boss') {
                    maxBossHP = pKeys.length * 150; // ‰∫∫Êï∞„ÅßÈõ£ÊòìÂ∫¶Ë™øÊï¥
                    bossHP = maxBossHP;
                    pKeys.forEach(id => updates[`shakebattle/${roomId}/players/${id}/score`] = 0);
                    setupBossUI();
                    timer = 30;
                } else if (mode === 'team') {
                    // „ÉÅ„Éº„É†ÂàÜ„Åë (‰∫§‰∫í)
                    pKeys.forEach((id, i) => {
                        updates[`shakebattle/${roomId}/players/${id}/score`] = 0;
                        updates[`shakebattle/${roomId}/players/${id}/team`] = (i % 2 === 0) ? 'red' : 'blue';
                    });
                    setupTeamUI();
                    timer = 20;
                }
                
                update(ref(db), updates);
                startLoop(mode);
            };

            function setupRoyalUI() {
                const area = document.getElementById('game-area');
                area.innerHTML = '';
                Object.keys(players).forEach(id => {
                    const div = document.createElement('div');
                    div.id = `p-${id}`;
                    div.className = 'player-bar';
                    div.innerHTML = `<span class="player-score">0</span><span class="player-name">${id}</span>`;
                    area.appendChild(div);
                });
            }

            function setupBossUI() {
                const area = document.getElementById('game-area');
                area.innerHTML = `
                    <div id="boss-container">
                        <div id="boss-face">üëπ</div>
                        <div id="boss-hp-bar"><div id="boss-hp-fill"></div></div>
                    </div>
                `;
            }

            function setupTeamUI() {
                const area = document.getElementById('game-area');
                area.innerHTML = `
                    <div id="team-battle-area">
                        <div id="team-red-zone">RED 0</div>
                        <div class="vs-icon">VS</div>
                        <div id="team-blue-zone">0 BLUE</div>
                    </div>
                `;
            }

            function startLoop(mode) {
                document.getElementById('game-message').innerText = "GO!";
                setTimeout(() => document.getElementById('game-message').innerText = "", 1000);

                let lastScores = {}; // „ÉÄ„É°„Éº„Ç∏Ë®àÁÆóÁî®

                loopId = setInterval(() => {
                    timer -= 0.1;
                    if(timer < 0) timer = 0;
                    document.getElementById('timer').innerText = timer.toFixed(1);

                    // Boss„É≠„Ç∏„ÉÉ„ÇØ: Ââç„Éï„É¨„Éº„É†„Åã„Çâ„ÅÆÂ∑ÆÂàÜ„Çí„ÉÄ„É°„Éº„Ç∏„Å´„Åô„Çã
                    if (mode === 'boss') {
                        let totalDamage = 0;
                        Object.keys(players).forEach(id => {
                            const current = players[id].score || 0;
                            const last = lastScores[id] || 0;
                            if (current > last) {
                                totalDamage += (current - last);
                                // „Ç®„Éï„Çß„ÇØ„Éà
                                showDamage(current - last);
                            }
                            lastScores[id] = current;
                        });
                        bossHP -= totalDamage;
                        if(bossHP <= 0) { bossHP = 0; endGame(true); }
                    }

                    if (timer === 0 && mode !== 'boss') endGame(false);
                    if (timer === 0 && mode === 'boss' && bossHP > 0) endGame(false); // Timeover

                    updateGameVisuals();
                }, 100);
            }

            function showDamage(val) {
                const boss = document.getElementById('boss-container');
                if(!boss) return;
                // Êè∫„Çâ„Åô
                boss.style.transform = `translate(${Math.random()*10-5}px, ${Math.random()*10-5}px)`;
                setTimeout(() => boss.style.transform = 'none', 50);

                // Êï∞Â≠ó
                const txt = document.createElement('div');
                txt.className = 'damage-text';
                txt.innerText = val * 10;
                txt.style.left = (Math.random() * 200 + 50) + 'px';
                txt.style.top = (Math.random() * 200) + 'px';
                boss.appendChild(txt);
                setTimeout(() => txt.remove(), 500);
            }

            function updateGameVisuals() {
                if (gameState === 'royal') {
                    let maxScore = 50; // Âü∫Ê∫ñ
                    Object.keys(players).forEach(id => {
                         if(players[id].score > maxScore) maxScore = players[id].score;
                    });
                    
                    Object.keys(players).forEach(id => {
                        const el = document.getElementById(`p-${id}`);
                        if(el) {
                            const score = players[id].score || 0;
                            el.style.height = `${(score / maxScore) * 100}%`;
                            el.querySelector('.player-score').innerText = score;
                        }
                    });
                } else if (gameState === 'boss') {
                    const fill = document.getElementById('boss-hp-fill');
                    if(fill) {
                        const pct = (bossHP / maxBossHP) * 100;
                        fill.style.width = `${pct}%`;
                    }
                } else if (gameState === 'team') {
                    let redScore = 0, blueScore = 0;
                    Object.values(players).forEach(p => {
                        if (p.team === 'red') redScore += (p.score || 0);
                        else blueScore += (p.score || 0);
                    });
                    const total = redScore + blueScore + 1; // 0Èô§ÁÆóÈò≤Ê≠¢
                    const redPct = (redScore / total) * 100;
                    
                    // 50%„Çí‰∏≠ÂøÉ„Å´Á∂±Âºï„Åç
                    // „Ç∑„É≥„Éó„É´„Å´Ââ≤Âêà„ÅßÂπÖ„ÇíÂ§â„Åà„Çã
                    const rZone = document.getElementById('team-red-zone');
                    const bZone = document.getElementById('team-blue-zone');
                    if(rZone && bZone) {
                        // ÊúÄÂ∞èÂπÖ10%Á¢∫‰øù
                        let rW = Math.max(10, Math.min(90, (redScore / (redScore+blueScore)) * 100));
                        if(redScore+blueScore === 0) rW = 50;

                        rZone.style.width = `${rW}%`;
                        bZone.style.width = `${100 - rW}%`;
                        rZone.innerText = `RED ${redScore}`;
                        bZone.innerText = `${blueScore} BLUE`;
                    }
                }
            }

            function endGame(bossDefeated) {
                clearInterval(loopId);
                const msg = document.getElementById('game-message');
                if (gameState === 'boss') {
                    msg.innerText = bossDefeated ? "BOSS DEFEATED!!" : "FAILED...";
                } else if (gameState === 'royal') {
                    // ÂãùËÄÖÁâπÂÆö
                    let winner = "", max = -1;
                    Object.keys(players).forEach(id => {
                        if(players[id].score > max) { max = players[id].score; winner = id; }
                    });
                    msg.innerText = `WINNER: ${winner}`;
                } else if (gameState === 'team') {
                     // „ÉÅ„Éº„É†ÂãùÊïó
                    let r=0, b=0;
                    Object.values(players).forEach(p => p.team === 'red' ? r+=p.score : b+=p.score);
                    msg.innerText = r > b ? "RED WINS!" : (b > r ? "BLUE WINS!" : "DRAW");
                }
                
                update(ref(db, `shakebattle/${roomId}/state`), { status: 'finished' });

                setTimeout(() => {
                    document.getElementById('lobby-ui').classList.remove('hidden');
                    document.getElementById('game-area').classList.add('hidden');
                    document.getElementById('game-area').innerHTML = '';
                    msg.innerText = "";
                    gameState = 'lobby';
                }, 6000);
            }
        }

        // --- CONTROLLER LOGIC ---
        else {
            document.getElementById('permission-ui').classList.remove('hidden');
            
            const myRef = ref(db, `shakebattle/${roomId}/players/${myId}`);
            const stateRef = ref(db, `shakebattle/${roomId}/state`);
            
            // ÂàáÊñ≠ÊôÇÂâäÈô§
            onDisconnect(myRef).remove();
            set(myRef, { score: 0, team: 'none' });

            let myScore = 0;
            let currentStatus = 'lobby';
            let myTeam = 'none';

            window.requestSensor = async () => {
                if (typeof DeviceMotionEvent.requestPermission === 'function') {
                    const res = await DeviceMotionEvent.requestPermission();
                    if(res !== 'granted') return alert("Ë®±ÂèØ„Åó„Å¶„Åè„Å†„Åï„ÅÑ");
                }
                document.getElementById('permission-ui').classList.add('hidden');
                document.getElementById('ctrl-view').classList.remove('hidden');
                startSensing();
            };

            // „Ç≤„Éº„É†Áä∂ÊÖãÁõ£Ë¶ñ
            onValue(stateRef, (snap) => {
                const s = snap.val() || { status: 'lobby' };
                currentStatus = s.status;
                const title = document.getElementById('ctrl-mode-title');
                const info = document.getElementById('ctrl-info');
                const btn = document.getElementById('shake-btn');

                if (s.status === 'running') {
                    title.innerText = "SHAKE IT!!";
                    info.innerText = s.mode === 'boss' ? "„Åø„Çì„Å™„ÅßÂÄí„ÅõÔºÅ" : (s.mode === 'team' ? "„ÉÅ„Éº„É†„ÅÆ„Åü„ÇÅ„Å´ÊåØ„ÇåÔºÅ" : "‰∏ÄÁï™„ÇíÁõÆÊåá„ÅõÔºÅ");
                    myScore = 0; // Reset local
                    update(myRef, { score: 0 }); // Reset DB (Backup)
                    
                    // „ÉÅ„Éº„É†Á¢∫Ë™ç
                    onValue(ref(db, `shakebattle/${roomId}/players/${myId}/team`), (tsnap) => {
                        myTeam = tsnap.val();
                        if(s.mode === 'team') {
                            document.body.className = myTeam === 'red' ? 'team-red-bg' : 'team-blue-bg';
                            btn.style.borderColor = myTeam === 'red' ? '#ffaaaa' : '#aaaaff';
                        } else {
                            document.body.className = '';
                            btn.style.borderColor = '#666';
                        }
                    }, { onlyOnce: true });

                } else if (s.status === 'finished') {
                    title.innerText = "FINISH!";
                    info.innerText = "PCÁîªÈù¢„Çí„ÉÅ„Çß„ÉÉ„ÇØ";
                } else {
                    title.innerText = "WAITING...";
                    info.innerText = "„Éõ„Çπ„Éà„ÅÆÊìç‰ΩúÂæÖ„Å°";
                    document.body.className = '';
                }
            });

            function startSensing() {
                let lastX=0, lastY=0, lastZ=0;
                let lastSend = 0;
                const THRESHOLD = 15;

                window.addEventListener('devicemotion', (e) => {
                    if (currentStatus !== 'running') return;

                    const acc = e.accelerationIncludingGravity || e.acceleration;
                    if(!acc) return;

                    const diff = Math.abs(acc.x - lastX) + Math.abs(acc.y - lastY) + Math.abs(acc.z - lastZ);
                    
                    if (diff > THRESHOLD) {
                        myScore++;
                        document.getElementById('shake-btn').classList.add('active');
                        setTimeout(() => document.getElementById('shake-btn').classList.remove('active'), 100);

                        // ÈÄÅ‰ø° (50msÈñìÈöî)
                        const now = Date.now();
                        if (now - lastSend > 50) {
                            update(myRef, { score: myScore });
                            lastSend = now;
                        }
                    }
                    lastX = acc.x; lastY = acc.y; lastZ = acc.z;
                });
            }
        }
    </script>
</body>
</html>
