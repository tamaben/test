<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SHAKE PARTY - ãƒ•ãƒªãƒ•ãƒªãƒãƒˆãƒ«</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Black+Ops+One&family=Roboto:wght@700&display=swap');

        body { font-family: 'Roboto', sans-serif; margin: 0; background: #111; color: white; overflow: hidden; touch-action: none; }
        .hidden { display: none !important; }
        .full-screen { position: absolute; top:0; left:0; width: 100vw; height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        
        /* --- HOST DESIGN --- */
        #host-view { background: radial-gradient(circle at center, #222, #000); }
        h1 { font-family: 'Black Ops One', cursive; font-size: 60px; color: #ffeb3b; text-shadow: 0 0 20px #ff9800; margin: 0; letter-spacing: 5px; }
        
        /* ãƒ¡ãƒ¼ã‚¿ãƒ¼ã‚¨ãƒªã‚¢ */
        #meter-container { display: flex; align-items: flex-end; justify-content: center; width: 90%; height: 50vh; margin-top: 30px; gap: 10px; border-bottom: 5px solid #555; padding-bottom: 5px; }
        .player-column { display: flex; flex-direction: column; align-items: center; justify-content: flex-end; width: 80px; height: 100%; transition: all 0.3s; position: relative; }
        .bar { width: 100%; background: linear-gradient(to top, #ff0000, #ff8800); border-radius: 5px 5px 0 0; transition: height 0.1s linear; position: relative; box-shadow: 0 0 15px rgba(255, 87, 34, 0.5); }
        .p-name { margin-top: 10px; font-weight: bold; font-size: 14px; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%; }
        .p-score { font-size: 24px; font-weight: bold; position: absolute; top: -35px; color: #fff; text-shadow: 0 0 5px #000; }
        .rank-crown { position: absolute; top: -70px; font-size: 30px; display: none; }

        /* ãƒ¢ãƒ¼ãƒ‰é¸æŠãƒœã‚¿ãƒ³ */
        #mode-select { display: flex; gap: 20px; margin-top: 40px; }
        .mode-btn { padding: 20px 40px; font-size: 20px; background: rgba(255,255,255,0.1); border: 2px solid #fff; color: white; cursor: pointer; border-radius: 10px; transition: 0.2s; font-weight: bold; }
        .mode-btn:hover { background: #fff; color: #000; transform: scale(1.1); box-shadow: 0 0 20px white; }

        #timer { font-size: 80px; font-family: 'Black Ops One'; position: absolute; top: 20px; right: 40px; color: #00e676; text-shadow: 0 0 20px #00e676; }
        #game-msg { font-size: 40px; position: absolute; top: 40%; width: 100%; text-align: center; text-shadow: 0 0 20px black; pointer-events: none; }

        /* --- CONTROLLER DESIGN --- */
        #ctrl-view { background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); text-align: center; }
        #shake-btn { width: 250px; height: 250px; border-radius: 50%; border: 10px solid rgba(255,255,255,0.2); background: #ff5722; color: white; font-size: 40px; font-family: 'Black Ops One'; display: flex; flex-direction: column; align-items: center; justify-content: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5); margin: 0 auto; user-select: none; }
        .ripple { animation: ripple 1s infinite; }
        @keyframes ripple {
            0% { box-shadow: 0 0 0 0 rgba(255, 87, 34, 0.7); }
            70% { box-shadow: 0 0 0 30px rgba(255, 87, 34, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 87, 34, 0); }
        }
        #ctrl-score { font-size: 80px; font-weight: bold; margin-bottom: 20px; text-shadow: 2px 2px 10px rgba(0,0,0,0.5); }
        #ctrl-msg { font-size: 20px; margin-top: 20px; color: #ccc; }
        
        #permission-ui { z-index: 999; background: rgba(0,0,0,0.9); }
        .big-btn { padding: 20px 50px; font-size: 24px; border-radius: 50px; background: #00e676; color: white; border: none; font-weight: bold; }
    </style>
</head>
<body>

    <!-- HOST (PC) -->
    <div id="host-view" class="full-screen hidden">
        <h1>SHAKE PARTY</h1>
        <div id="timer"></div>
        <div id="game-msg"></div>

        <!-- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ¡ãƒ¼ã‚¿ãƒ¼è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div id="meter-container">
            <!-- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒå‚åŠ ã™ã‚‹ã¨ã“ã“ã«è¿½åŠ ã•ã‚Œã¾ã™ -->
            <div style="color: #666; font-size: 20px;">QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿è¾¼ã‚“ã§å‚åŠ å¾…æ©Ÿä¸­...</div>
        </div>

        <!-- ãƒ­ãƒ“ãƒ¼ï¼†QR -->
        <div id="lobby-ui" style="text-align: center; margin-top:20px;">
            <div id="qrcode" style="background: white; padding: 10px; display: inline-block; border-radius: 10px;"></div>
            <p id="room-id-display" style="margin: 10px; color: #aaa;"></p>
            
            <div id="mode-select">
                <button class="mode-btn" onclick="startGame('speed')">âš¡ SPEED RUSH<br><span style="font-size:12px">10ç§’é€£æ‰“ãƒãƒˆãƒ«</span></button>
                <button class="mode-btn" onclick="startGame('survival')">ğŸ”‹ SURVIVAL<br><span style="font-size:12px">æ­¢ã¾ã‚‹ã¨æ­»ã¬</span></button>
                <button class="mode-btn" onclick="startGame('just')">ğŸ¯ JUST 50<br><span style="font-size:12px">50å›ã§å¯¸æ­¢ã‚</span></button>
            </div>
        </div>
    </div>

    <!-- CONTROLLER (Smartphone) -->
    <div id="ctrl-view" class="full-screen hidden">
        <div id="ctrl-game" class="hidden">
            <div id="ctrl-score">0</div>
            <div id="shake-btn" class="ripple">SHAKE!</div>
            <div id="ctrl-msg">ã‚¹ãƒãƒ›ã‚’ã—ã£ã‹ã‚ŠæŒ¯ã‚Œï¼</div>
        </div>
    </div>

    <!-- ã‚»ãƒ³ã‚µãƒ¼è¨±å¯ç”»é¢ -->
    <div id="permission-ui" class="full-screen hidden">
        <h2 style="color: white; margin-bottom: 30px;">æº–å‚™ã¯ã„ã„ã‹ï¼Ÿ</h2>
        <p style="color: #aaa; margin-bottom: 30px; padding: 0 20px; text-align: center;">ã‚¹ãƒãƒ›ã‚’æŒ¯ã£ã¦éŠã¶ã‚²ãƒ¼ãƒ ã§ã™ã€‚<br>å‘¨ã‚Šã«æ³¨æ„ã—ã¦ã—ã£ã‹ã‚Šæ¡ã£ã¦ãã ã•ã„ã€‚</p>
        <button id="perm-btn" class="big-btn">OK</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
        import { getDatabase, ref, set, onValue, update, remove, onDisconnect } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyDbZzTMvUkG2LXIGY4ux0KBTmnAdqP236s",
            authDomain: "game-4f2d9.firebaseapp.com",
            databaseURL: "https://game-4f2d9-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "game-4f2d9",
            storageBucket: "game-4f2d9.firebasestorage.app",
            messagingSenderId: "574316347824",
            appId: "1:574316347824:web:cf686040628e25ad615675",
            measurementId: "G-T0ZKQCC9L3"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // Params
        const params = new URLSearchParams(window.location.search);
        let role = params.get('role') || 'host';
        let roomId = params.get('room');
        const myId = Math.random().toString(36).substr(2, 5).toUpperCase();

        // Colors
        const COLORS = ['#F44336', '#E91E63', '#9C27B0', '#673AB7', '#3F51B5', '#2196F3', '#03A9F4', '#00BCD4', '#009688', '#4CAF50', '#8BC34A', '#FFC107', '#FF9800', '#FF5722'];
        function getColor(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
            return COLORS[Math.abs(hash) % COLORS.length];
        }

        // ============================================
        // HOST LOGIC
        // ============================================
        if (role === 'host') {
            if (!roomId) {
                roomId = Math.random().toString(36).substring(2, 6).toUpperCase();
                window.location.replace(`?role=host&room=${roomId}`);
            }

            document.getElementById('host-view').classList.remove('hidden');
            document.getElementById('room-id-display').innerText = `Room: ${roomId}`;
            
            // QR Code
            new QRCode(document.getElementById("qrcode"), {
                text: `${window.location.origin}${window.location.pathname}?role=ctrl&room=${roomId}`,
                width: 128, height: 128
            });

            // Game State
            let players = {};
            let gameMode = 'lobby'; // lobby, running, result
            let timeLeft = 0;
            let gameLoopId;

            const roomRef = ref(db, `shake/${roomId}`);
            
            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ç›£è¦–
            onValue(roomRef, (snap) => {
                const data = snap.val() || {};
                const pData = data.players || {};
                
                // æ–°è¦ãƒ»æ›´æ–°ãƒ»å‰Šé™¤ã®åæ˜ 
                renderMeters(pData);
                players = pData; // Update local state
            });

            // ãƒ¡ãƒ¼ã‚¿ãƒ¼æç”»
            function renderMeters(pData) {
                const container = document.getElementById('meter-container');
                const existingIds = Array.from(container.children).map(el => el.id).filter(id => id.startsWith('p-'));
                const newIds = Object.keys(pData);

                // å¾…æ©Ÿãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ¶ˆå»
                if(newIds.length > 0 && container.innerText.includes('å¾…æ©Ÿä¸­')) container.innerHTML = '';
                if(newIds.length === 0) container.innerHTML = '<div style="color:#666; font-size:20px;">QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿è¾¼ã‚“ã§å‚åŠ å¾…æ©Ÿä¸­...</div>';

                // å‰Šé™¤ã•ã‚ŒãŸãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’æ¶ˆã™
                existingIds.forEach(id => {
                    if (!newIds.includes(id.replace('p-', ''))) document.getElementById(id).remove();
                });

                // æç”»ãƒ»æ›´æ–°
                newIds.forEach(id => {
                    const p = pData[id];
                    let el = document.getElementById(`p-${id}`);
                    const color = getColor(id);

                    if (!el) {
                        el = document.createElement('div');
                        el.id = `p-${id}`;
                        el.className = 'player-column';
                        el.innerHTML = `
                            <div class="rank-crown">ğŸ‘‘</div>
                            <div class="p-score">0</div>
                            <div class="bar"></div>
                            <div class="p-name" style="color:${color}">P-${id}</div>
                        `;
                        container.appendChild(el);
                    }

                    // å€¤ã®æ›´æ–°
                    const scoreEl = el.querySelector('.p-score');
                    const barEl = el.querySelector('.bar');
                    const crownEl = el.querySelector('.rank-crown');
                    
                    // ãƒ¢ãƒ¼ãƒ‰ã”ã¨ã®è¡¨ç¤ºãƒ­ã‚¸ãƒƒã‚¯
                    let displayScore = p.count || 0;
                    let barHeight = 0;

                    if (gameMode === 'speed') {
                        // 100å›ã‚’100%ã¨ã™ã‚‹åŸºæº–
                        barHeight = Math.min((p.count / 100) * 100, 100);
                    } else if (gameMode === 'survival') {
                        // HPã‚’è¡¨ç¤º (æœ€å¤§100)
                        displayScore = Math.floor(p.hp || 0);
                        barHeight = p.hp;
                        if(p.hp <= 0) barEl.style.filter = 'grayscale(100%)';
                        else barEl.style.filter = 'none';
                    } else if (gameMode === 'just') {
                        // å¯¸æ­¢ã‚: ã‚²ãƒ¼ãƒ ä¸­ã¯éš ã™(?ãŒè¡¨ç¤ºã•ã‚Œã‚‹)
                        if (gameMode === 'result') {
                            displayScore = p.count;
                            barHeight = Math.min((p.count / 60) * 100, 100);
                        } else {
                            displayScore = '?';
                            barHeight = (p.count > 0) ? 20 : 0; // æŒ¯ã£ã¦ã‚‹ã“ã¨ã ã‘ã‚ã‹ã‚‹
                        }
                    } else {
                        // ãƒ­ãƒ“ãƒ¼
                        barHeight = Math.min(p.count, 100);
                    }

                    scoreEl.innerText = displayScore;
                    barEl.style.height = `${barHeight}%`;
                    barEl.style.backgroundColor = color;
                    barEl.style.boxShadow = `0 0 20px ${color}`;

                    // å‹è€…åˆ¤å®šï¼ˆçµæœç™ºè¡¨æ™‚ï¼‰
                    crownEl.style.display = (p.isWinner) ? 'block' : 'none';
                });
            }

            // ã‚²ãƒ¼ãƒ é–‹å§‹ãƒ­ã‚¸ãƒƒã‚¯
            window.startGame = (mode) => {
                if (Object.keys(players).length === 0) return alert("ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒã„ã¾ã›ã‚“");
                
                gameMode = mode;
                document.getElementById('lobby-ui').classList.add('hidden');
                document.getElementById('game-msg').innerText = "READY...";
                
                // Reset Players
                const updates = {};
                Object.keys(players).forEach(id => {
                    updates[`players/${id}/count`] = 0;
                    updates[`players/${id}/hp`] = 100; // Survivalç”¨
                    updates[`players/${id}/isWinner`] = false;
                });
                updates['state/status'] = 'ready';
                updates['state/mode'] = mode;
                update(roomRef, updates);

                // Countdown
                let count = 3;
                const cdInt = setInterval(() => {
                    document.getElementById('game-msg').innerText = count > 0 ? count : "GO!!!";
                    if (count === 0) {
                        clearInterval(cdInt);
                        runGameLoop(mode);
                    }
                    count--;
                }, 1000);
            };

            function runGameLoop(mode) {
                document.getElementById('game-msg').innerText = "";
                update(roomRef, { 'state/status': 'running' });
                
                if (mode === 'speed') {
                    timeLeft = 10;
                } else if (mode === 'survival') {
                    timeLeft = 999;
                } else if (mode === 'just') {
                    timeLeft = 20; // åˆ¶é™æ™‚é–“
                }

                gameLoopId = setInterval(() => {
                    timeLeft -= 0.1;
                    if(mode !== 'survival') document.getElementById('timer').innerText = Math.ceil(timeLeft);
                    else document.getElementById('timer').innerText = "SURVIVE!";

                    // --- SURVIVAL LOGIC ---
                    if (mode === 'survival') {
                        // å…¨å“¡ã®HPã‚’æ¸›ã‚‰ã™
                        Object.keys(players).forEach(id => {
                            let p = players[id];
                            if (p.hp > 0) {
                                // æŒ¯ã£ã¦ã„ãªã„ã¨æ—©ãæ¸›ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ã¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§ã‚«ã‚¦ãƒ³ãƒˆã‚¢ãƒƒãƒ—ã•ã›ã‚‹ãŒã€
                                // ã“ã“ã§ã¯ã‚·ãƒ³ãƒ—ãƒ«ã«ã€Œç¾åœ¨ã®ã‚«ã‚¦ãƒ³ãƒˆã€ãŒå¢—ãˆã¦ã„ãªã„ã¨HPã‚’æ¸›ã‚‰ã™å‡¦ç†ãŒå¿…è¦ã ãŒã€
                                // ç°¡æ˜“åŒ–ã®ãŸã‚ã€Œã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰é€ã‚‰ã‚Œã¦ãã‚‹HPã€ã‚’è¡¨ç¤ºã™ã‚‹è¨­è¨ˆã«ã™ã‚‹ã‹ã€
                                // ã‚ã‚‹ã„ã¯ã€Œã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¯ã‚«ã‚¦ãƒ³ãƒˆã ã‘é€ã‚Šã€ã‚µãƒ¼ãƒãƒ¼(Host)ãŒHPã‚’è¨ˆç®—ã™ã‚‹ã€ã®ãŒæ­£ã—ã„ã€‚
                                // ä»Šå›ã¯ã‚·ãƒ³ãƒ—ãƒ«åŒ–: ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒæŒ¯ã‚‹ã¨HPå›å¾©ã€ãƒ›ã‚¹ãƒˆãŒæ¯ãƒ•ãƒ¬ãƒ¼ãƒ HPæ¸›å°‘ã•ã›ã‚‹
                                let drain = 1.0; 
                                let newHp = (p.hp || 100) - drain;
                                if(newHp < 0) newHp = 0;
                                update(ref(db, `shake/${roomId}/players/${id}`), { hp: newHp });
                            }
                        });
                        
                        // æ®‹ã‚Š1äººã«ãªã£ãŸã‚‰çµ‚äº†
                        const survivors = Object.keys(players).filter(id => players[id].hp > 0);
                        if (survivors.length <= 1 && Object.keys(players).length > 1) {
                            finishGame(mode);
                        }
                    }

                    // --- TIME UP ---
                    if (timeLeft <= 0) {
                        finishGame(mode);
                    }
                }, 100);
            }

            function finishGame(mode) {
                clearInterval(gameLoopId);
                document.getElementById('game-msg').innerText = "FINISH!!";
                document.getElementById('timer').innerText = "";
                update(roomRef, { 'state/status': 'finished' });
                gameMode = 'result'; // ãƒ¡ãƒ¼ã‚¿ãƒ¼è¡¨ç¤ºç”¨

                // å‹è€…åˆ¤å®š
                let winnerId = null;
                let bestScore = -1;
                let minDiff = 999;

                Object.keys(players).forEach(id => {
                    const p = players[id];
                    if (mode === 'speed') {
                        if (p.count > bestScore) { bestScore = p.count; winnerId = id; }
                    } else if (mode === 'survival') {
                        if (p.hp > 0) winnerId = id; // ç”Ÿãæ®‹ã‚Š
                    } else if (mode === 'just') {
                        // 50ã«è¿‘ã„äºº
                        const diff = Math.abs(50 - p.count);
                        if (diff < minDiff) { minDiff = diff; winnerId = id; }
                    }
                });

                if (winnerId) {
                    update(ref(db, `shake/${roomId}/players/${winnerId}`), { isWinner: true });
                    document.getElementById('game-msg').innerText = `WINNER: P-${winnerId}`;
                }

                // 5ç§’å¾Œã«ãƒ­ãƒ“ãƒ¼ã¸
                setTimeout(() => {
                    document.getElementById('lobby-ui').classList.remove('hidden');
                    document.getElementById('game-msg').innerText = "";
                    gameMode = 'lobby';
                }, 8000);
            }
        }

        // ============================================
        // CONTROLLER LOGIC
        // ============================================
        else {
            document.getElementById('permission-ui').classList.remove('hidden');
            const pRef = ref(db, `shake/${roomId}/players/${myId}`);
            const stateRef = ref(db, `shake/${roomId}/state`);
            
            // Disconnectã§å‰Šé™¤
            onDisconnect(pRef).remove();

            // åˆæœŸåŒ–
            set(pRef, { count: 0, hp: 100 });

            let myCount = 0;
            let myHp = 100;
            let currentStatus = 'lobby'; // lobby, ready, running
            let currentMode = '';

            // çŠ¶æ…‹ç›£è¦–
            onValue(stateRef, (snap) => {
                const s = snap.val();
                if(!s) return;
                currentStatus = s.status;
                currentMode = s.mode;

                const msgEl = document.getElementById('ctrl-msg');
                const scoreEl = document.getElementById('ctrl-score');
                const btn = document.getElementById('shake-btn');

                if (s.status === 'ready') {
                    scoreEl.innerText = "READY";
                    myCount = 0; 
                    myHp = 100;
                } else if (s.status === 'running') {
                    msgEl.innerText = (currentMode === 'just') ? "50å›æŒ¯ã£ã¦æ­¢ã‚ã‚ï¼" : "SHAKE IT FAST!";
                    if(currentMode === 'just') scoreEl.innerText = "?";
                    else scoreEl.innerText = myCount;
                    btn.classList.add('ripple');
                    if(navigator.vibrate) navigator.vibrate(200);
                } else if (s.status === 'finished') {
                    msgEl.innerText = "çµæœç™ºè¡¨...";
                    scoreEl.innerText = myCount;
                    btn.classList.remove('ripple');
                    if(navigator.vibrate) navigator.vibrate([100,50,100]);
                }
            });

            // è¨±å¯ãƒœã‚¿ãƒ³
            document.getElementById('perm-btn').addEventListener('click', async () => {
                if (typeof DeviceMotionEvent.requestPermission === 'function') {
                    const res = await DeviceMotionEvent.requestPermission();
                    if (res !== 'granted') return alert("ã‚»ãƒ³ã‚µãƒ¼è¨±å¯ãŒå¿…è¦ã§ã™");
                }
                document.getElementById('permission-ui').classList.add('hidden');
                document.getElementById('ctrl-view').classList.remove('hidden');
                document.getElementById('ctrl-game').classList.remove('hidden');
                
                startSensor();
            });

            function startSensor() {
                let lastX=0, lastY=0, lastZ=0;
                let lastSend = 0;
                const THRESHOLD = 20; // æ„Ÿåº¦

                window.addEventListener('devicemotion', (e) => {
                    if (currentStatus !== 'running' && currentStatus !== 'lobby') return;

                    const acc = e.accelerationIncludingGravity || e.acceleration;
                    if (!acc) return;

                    const delta = Math.abs(acc.x - lastX) + Math.abs(acc.y - lastY) + Math.abs(acc.z - lastZ);
                    
                    if (delta > THRESHOLD) {
                        // æŒ¯ã£ãŸåˆ¤å®š
                        myCount++;
                        
                        // ã‚µãƒã‚¤ãƒãƒ«ãƒ¢ãƒ¼ãƒ‰ãªã‚‰HPå›å¾©
                        if (currentMode === 'survival') {
                            myHp = Math.min(myHp + 2, 100); 
                        }

                        // UIæ›´æ–° (JUSTãƒ¢ãƒ¼ãƒ‰ã¯éš ã™)
                        if (currentMode !== 'just') {
                            document.getElementById('ctrl-score').innerText = myCount;
                        }

                        // é€ä¿¡åˆ¶é™ (50msã”ã¨)
                        const now = Date.now();
                        if (now - lastSend > 50) {
                            const payload = { count: myCount };
                            if (currentMode === 'survival') payload.hp = myHp;
                            update(pRef, payload);
                            lastSend = now;
                        }
                    }

                    lastX = acc.x; lastY = acc.y; lastZ = acc.z;
                });
            }
        }
    </script>
</body>
</html>
