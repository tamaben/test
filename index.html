<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ã‚³ãƒˆãƒãƒˆåºƒå ´</title>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #0f172a;
            --card-bg: rgba(30, 41, 59, 0.85);
            --primary: #6366f1;
            --accent: #3b82f6;
            --text: #f8fafc;
            --text-sub: #94a3b8;
            --nav-h: 65px;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            background: radial-gradient(circle at top right, #1e1b4b, #0f172a);
            color: var(--text);
            font-family: 'M PLUS Rounded 1c', sans-serif;
            margin: 0; overflow: hidden; height: 100vh;
        }

        /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }
        
        .screen { display: none; width: 100%; height: 100%; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        .screen.active { display: flex; animation: fadeIn 0.4s ease-out; }

        .app-shell { width: 100%; height: 100%; display: flex; flex-direction: column; max-width: 800px; margin: 0 auto; background: rgba(15,23,42,0.5); backdrop-filter: blur(5px); }

        /* ã‚«ãƒ¼ãƒ‰ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .card {
            background: var(--card-bg); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 20px; padding: 25px; width: 100%; max-width: 400px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.4); text-align: center;
        }
        
        h1 { margin: 0 0 15px; background: linear-gradient(90deg, #818cf8, #38bdf8); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 800; letter-spacing: 1px; }
        
        input {
            width: 100%; padding: 15px; margin: 8px 0; border-radius: 12px; border: 1px solid #475569;
            background: rgba(2,6,23,0.6); color: #fff; font-size: 16px; outline: none; transition: 0.3s;
        }
        input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.25); }

        .btn {
            width: 100%; padding: 15px; margin-top: 15px; border: none; border-radius: 12px;
            font-weight: bold; font-size: 16px; cursor: pointer; color: white;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4); transition: 0.2s;
        }
        .btn:active { transform: scale(0.98); }
        .btn-link { background: none; color: var(--text-sub); margin-top: 15px; box-shadow: none; font-size: 0.9rem; }
        .btn-link:hover { color: var(--text); text-decoration: underline; }

        /* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ */
        .header { padding: 15px 20px; background: rgba(30,41,59,0.9); display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .content { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 90px; }
        
        /* ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
        .nav {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 500px; height: 65px;
            background: rgba(30, 41, 59, 0.95); backdrop-filter: blur(10px);
            border-radius: 35px; border: 1px solid rgba(255,255,255,0.1);
            display: flex; justify-content: space-around; align-items: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); z-index: 100;
        }
        .nav-item { color: var(--text-sub); font-size: 0.7rem; text-align: center; cursor: pointer; transition: 0.3s; width: 60px; }
        .nav-item .icon { font-size: 1.5rem; display: block; margin-bottom: 2px; }
        .nav-item.active { color: var(--primary); transform: translateY(-2px); }

        /* ãƒãƒ£ãƒƒãƒˆãƒ»ãƒªã‚¹ãƒˆ */
        .msg-box { display: flex; flex-direction: column; gap: 10px; }
        .msg { padding: 10px 15px; border-radius: 15px; max-width: 85%; font-size: 0.9rem; position: relative; }
        .msg.me { align-self: flex-end; background: var(--primary); border-bottom-right-radius: 4px; }
        .msg.other { align-self: flex-start; background: #334155; border-bottom-left-radius: 4px; }
        .sender { font-size: 0.7rem; opacity: 0.8; margin-bottom: 2px; display: block; }

        .list-item { background: rgba(30,41,59,0.6); border: 1px solid rgba(255,255,255,0.1); padding: 15px; border-radius: 12px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }

        #toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #10b981; color: white; padding: 12px 24px; border-radius: 30px; font-weight: bold; display: none; z-index: 9999; box-shadow: 0 5px 20px rgba(0,0,0,0.3); }
        
        .resource-panel { display: flex; justify-content: space-around; background: rgba(15,23,42,0.8); padding: 15px; border-radius: 15px; margin-bottom: 20px; font-weight: bold; border: 1px solid rgba(255,255,255,0.1); }
    </style>
</head>
<body>

    <div id="toast">âœ… å‡¦ç†å®Œäº†</div>

    <!-- 1. ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ -->
    <div id="screen-login" class="screen active">
        <div class="card">
            <h1>ã‚³ãƒˆãƒãƒˆåºƒå ´</h1>
            <p style="color:var(--text-sub); margin-bottom:20px;">ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã¸ã‚ˆã†ã“ã</p>
            
            <input type="text" id="login-user" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼å" autocomplete="off">
            <input type="password" id="login-pass" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
            
            <button class="btn" onclick="doLogin()">ãƒ­ã‚°ã‚¤ãƒ³</button>
            <button class="btn btn-link" onclick="switchScreen('register')">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆã¯ã“ã¡ã‚‰</button>
            
            <div id="conn-status" style="margin-top:15px; font-size:0.8rem; color: #fbbf24;">ã‚µãƒ¼ãƒãƒ¼æ¥ç¶šå¾…æ©Ÿä¸­...</div>
        </div>
    </div>

    <!-- 2. ç™»éŒ²ç”»é¢ -->
    <div id="screen-register" class="screen">
        <div class="card">
            <h1>æ–°è¦ç™»éŒ²</h1>
            <input type="text" id="reg-user" placeholder="å¸Œæœ›ãƒ¦ãƒ¼ã‚¶ãƒ¼å (åŠè§’è‹±æ•°)">
            <input type="password" id="reg-pass" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
            <input type="text" id="reg-name" placeholder="ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ">
            
            <button class="btn" style="background: linear-gradient(135deg, #10b981, #059669);" onclick="doRegister()">ç™»éŒ²ã—ã¦ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
            <button class="btn btn-link" onclick="switchScreen('login')">ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã¸æˆ»ã‚‹</button>
        </div>
    </div>

    <!-- 3. ãƒ¡ã‚¤ãƒ³ç”»é¢ -->
    <div id="screen-main" class="screen" style="padding:0;">
        <div class="app-shell">
            <div class="header">
                <div style="font-weight:800; font-size:1.1rem; cursor:pointer;" id="app-title">Cotobato Plaza</div>
                <div id="header-name" style="font-size:0.8rem; color:var(--text-sub);">Guest</div>
            </div>

            <div class="content">
                
                <!-- ãƒ›ãƒ¼ãƒ  -->
                <div id="tab-home">
                    <div class="resource-panel">
                        <span>ğŸª™ <span id="val-coins">0</span></span>
                        <span>ğŸ’ <span id="val-dia">0</span></span>
                        <span>Lv. <span id="val-lv">1</span></span>
                    </div>

                    <div class="card" style="width:100%; max-width:none; margin-bottom:20px; text-align:left;">
                        <h3 style="margin:0 0 10px;">â˜ï¸ ãƒ‡ãƒ¼ã‚¿åŒæœŸ</h3>
                        <p style="font-size:0.85rem; color:var(--text-sub); margin-bottom:15px;">ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒ©ã‚¦ãƒ‰ã«ä¿å­˜ã—ã¾ã™ã€‚</p>
                        <button class="btn" style="margin:0; padding:12px;" onclick="saveCloud()">ä¿å­˜ã™ã‚‹</button>
                        <button class="btn" style="margin-top:10px; padding:12px; background:#334155;" onclick="loadCloud()">å¾©å…ƒã™ã‚‹</button>
                    </div>

                    <h3 style="margin-bottom:10px;">ãŠçŸ¥ã‚‰ã›</h3>
                    <div id="news-list" style="font-size:0.9rem; color:var(--text-sub);">èª­ã¿è¾¼ã¿ä¸­...</div>
                </div>

                <!-- ãƒãƒ£ãƒƒãƒˆ -->
                <div id="tab-chat" style="display:none;">
                    <div id="chat-list" class="msg-box" style="padding-bottom:20px;"></div>
                    <div style="display:flex; gap:10px; position:sticky; bottom:0; background:rgba(15,23,42,0.9); padding:10px 0;">
                        <input type="text" id="chat-in" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸..." style="margin:0;">
                        <button class="btn" style="width:70px; margin:0; padding:0;" onclick="sendChat()">é€ä¿¡</button>
                    </div>
                </div>

                <!-- äº¤æ› -->
                <div id="tab-trade" style="display:none;">
                    <div class="card" style="width:100%; max-width:none; margin-bottom:20px;">
                        <h3>å‡ºå“ã™ã‚‹</h3>
                        <div style="display:flex; gap:5px; margin-bottom:5px;">
                            <select id="tr-give-t" style="background:#0f172a; color:#fff; border:1px solid #334155; padding:10px; border-radius:8px;"><option value="coins">ã‚³ã‚¤ãƒ³</option><option value="diamonds">ãƒ€ã‚¤ãƒ¤</option></select>
                            <input type="number" id="tr-give-v" placeholder="é‡" style="margin:0;">
                        </div>
                        <div style="text-align:center; font-size:0.8rem; margin:5px 0;">â†“</div>
                        <div style="display:flex; gap:5px;">
                            <select id="tr-want-t" style="background:#0f172a; color:#fff; border:1px solid #334155; padding:10px; border-radius:8px;"><option value="coins">ã‚³ã‚¤ãƒ³</option><option value="diamonds">ãƒ€ã‚¤ãƒ¤</option></select>
                            <input type="number" id="tr-want-v" placeholder="æ±‚" style="margin:0;">
                        </div>
                        <button class="btn" style="margin-top:15px;" onclick="createTrade()">å‡ºå“</button>
                    </div>
                    <div id="trade-list"></div>
                </div>

                <!-- è¨­å®š -->
                <div id="tab-conf" style="display:none;">
                    <div class="card" style="width:100%; max-width:none;">
                        <h3>ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¨­å®š</h3>
                        <p id="conf-id" style="color:var(--text-sub); margin-bottom:15px;"></p>
                        <button class="btn" style="background:#ef4444;" onclick="location.reload()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
                    </div>
                    <div id="admin-panel" style="display:none; margin-top:20px;" class="card">
                        <h3 style="color:#fbbf24;">é‹å–¶ãƒ‘ãƒãƒ«</h3>
                        <input type="text" id="adm-news" placeholder="ãŠçŸ¥ã‚‰ã›é…ä¿¡">
                        <button class="btn" onclick="sendNews()">é…ä¿¡</button>
                    </div>
                </div>

            </div>

            <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
            <div class="nav">
                <div class="nav-item active" onclick="switchTab('home', this)"><span class="icon">ğŸ </span>ãƒ›ãƒ¼ãƒ </div>
                <div class="nav-item" onclick="switchTab('chat', this)"><span class="icon">ğŸ’¬</span>ãƒãƒ£ãƒƒãƒˆ</div>
                <div class="nav-item" onclick="switchTab('trade', this)"><span class="icon">âš–ï¸</span>äº¤æ›</div>
                <div class="nav-item" onclick="switchTab('conf', this)"><span class="icon">âš™ï¸</span>è¨­å®š</div>
            </div>
        </div>
    </div>

    <!-- é–¢ä¿‚è€…è©¦é¨“ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="quiz-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:9999; align-items:center; justify-content:center; padding:20px;">
        <div class="card">
            <h2 style="color:#fbbf24;">é–¢ä¿‚è€…ç¢ºèª</h2>
            <p id="quiz-text"></p>
            <input type="text" id="quiz-ans">
            <button class="btn" onclick="answerQuiz()">å›ç­”</button>
            <button class="btn btn-link" onclick="document.getElementById('quiz-modal').style.display='none'">é–‰ã˜ã‚‹</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, addDoc, onSnapshot, serverTimestamp, query, limit, where, deleteDoc } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";

        // â˜…è¨­å®šâ˜…
        const firebaseConfig = {
            apiKey: "AIzaSyDguL7I5v4GxKf5FahdoFEtU5lNMYgxcNo",
            authDomain: "cotobato-c121f.firebaseapp.com",
            databaseURL: "https://cotobato-c121f-default-rtdb.firebaseio.com",
            projectId: "cotobato-c121f",
            storageBucket: "cotobato-c121f.firebasestorage.app",
            messagingSenderId: "699569737682",
            appId: "1:699569737682:web:350b90c25c300a0548020b",
            measurementId: "G-FQ1VZDXZ6J"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let currentUser = null;
        let isReady = false;
        let localData = { coins: 0, diamonds: 0, playerLevel: 1 };

        // 1. åŒ¿åèªè¨¼ï¼ˆå¿…é ˆï¼‰
        signInAnonymously(auth).catch(e => {
            document.getElementById('conn-status').innerText = "ã‚¨ãƒ©ãƒ¼: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½œæˆã—ã¦ãã ã•ã„";
            document.getElementById('conn-status').style.color = "#ef4444";
        });

        onAuthStateChanged(auth, (u) => {
            if (u) {
                isReady = true;
                document.getElementById('conn-status').innerText = "â— ã‚µãƒ¼ãƒãƒ¼æ¥ç¶šå®Œäº†";
                document.getElementById('conn-status').style.color = "#10b981";
            }
        });

        // ç”»é¢é·ç§»
        window.switchScreen = (id) => {
            document.querySelectorAll('.screen').forEach(e => e.classList.remove('active'));
            document.getElementById('screen-'+id).classList.add('active');
        };

        window.switchTab = (id, el) => {
            ['home','chat','trade','conf'].forEach(t => document.getElementById('tab-'+t).style.display='none');
            document.getElementById('tab-'+id).style.display='block';
            document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
            el.classList.add('active');
        };

        // ç™»éŒ²ï¼ˆIDé‡è¤‡ãƒã‚§ãƒƒã‚¯ï¼‰
        window.doRegister = async () => {
            if(!isReady) return alert("æ¥ç¶šä¸­...");
            const u = document.getElementById('reg-user').value.trim();
            const p = document.getElementById('reg-pass').value.trim();
            const n = document.getElementById('reg-name').value.trim() || u;

            if(!u || !p) return alert("å…¥åŠ›ã—ã¦ãã ã•ã„");

            try {
                const ref = doc(db, "users", u);
                const snap = await getDoc(ref);
                if(snap.exists()) return alert("ãã®IDã¯ä½¿ã‚ã‚Œã¦ã„ã¾ã™");

                const data = { username: u, password: p, name: n, isAdmin: false, createdAt: serverTimestamp() };
                await setDoc(ref, data);
                
                currentUser = data;
                startApp();
                showToast("ç™»éŒ²å®Œäº†ï¼");
            } catch(e) { 
                console.error(e); 
                if(e.code === 'unavailable') alert("ã‚¨ãƒ©ãƒ¼: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½œæˆã—ã¦ãã ã•ã„");
                else alert("ç™»éŒ²ã‚¨ãƒ©ãƒ¼: "+e.message); 
            }
        };

        // ãƒ­ã‚°ã‚¤ãƒ³
        window.doLogin = async () => {
            if(!isReady) return alert("æ¥ç¶šä¸­...");
            const u = document.getElementById('login-user').value.trim();
            const p = document.getElementById('login-pass').value.trim();

            try {
                const ref = doc(db, "users", u);
                const snap = await getDoc(ref);
                if(snap.exists() && snap.data().password === p) {
                    currentUser = snap.data();
                    startApp();
                    showToast("ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ");
                } else {
                    alert("IDã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™");
                }
            } catch(e) { alert("ã‚¨ãƒ©ãƒ¼: "+e.message); }
        };

        function startApp() {
            window.switchScreen('main');
            document.getElementById('header-name').innerText = currentUser.name;
            document.getElementById('conf-id').innerText = "ID: " + currentUser.username;
            
            // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
            const raw = localStorage.getItem('kb_save_v36');
            if(raw) {
                localData = JSON.parse(raw);
                updateHeader();
            }

            // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒªã‚¹ãƒŠãƒ¼é–‹å§‹ï¼ˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä¸è¦ç‰ˆï¼‰
            startListeners();
            if(currentUser.isAdmin) document.getElementById('admin-panel').style.display='block';
        }

        function updateHeader() {
            document.getElementById('val-coins').innerText = localData.coins || 0;
            document.getElementById('val-dia').innerText = localData.diamonds || 0;
            document.getElementById('val-lv').innerText = localData.playerLevel || 1;
        }

        // ãƒªã‚¹ãƒŠãƒ¼ï¼ˆã‚½ãƒ¼ãƒˆã¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§è¡Œã†ï¼‰
        function startListeners() {
            // ãŠçŸ¥ã‚‰ã› (limitã®ã¿)
            onSnapshot(query(collection(db, "announcements"), limit(10)), (snap) => {
                const div = document.getElementById('news-list');
                div.innerHTML = "";
                const list = [];
                snap.forEach(d => list.push(d.data()));
                // æ—¥ä»˜ã§ã‚½ãƒ¼ãƒˆ(æ–°ã—ã„é †)
                list.sort((a,b) => (b.createdAt?.seconds||0) - (a.createdAt?.seconds||0));
                
                list.forEach(d => {
                    const date = d.createdAt ? new Date(d.createdAt.seconds*1000).toLocaleDateString() : "";
                    div.innerHTML += `<div class="list-item" style="display:block;"><small style="color:#94a3b8">${date}</small><div style="margin-top:3px;">${d.text}</div></div>`;
                });
            });

            // ãƒãƒ£ãƒƒãƒˆ (limitã®ã¿)
            onSnapshot(query(collection(db, "chat"), limit(30)), (snap) => {
                const div = document.getElementById('chat-list');
                div.innerHTML = "";
                const list = [];
                snap.forEach(d => list.push(d.data()));
                // æ—¥ä»˜ã§ã‚½ãƒ¼ãƒˆ(å¤ã„é †)
                list.sort((a,b) => (a.createdAt?.seconds||0) - (b.createdAt?.seconds||0));

                list.forEach(d => {
                    const isMe = d.username === currentUser.username;
                    div.innerHTML += `<div class="msg ${isMe?'me':'other'}"><span class="sender">${d.sender}</span>${d.text}</div>`;
                });
                div.parentElement.scrollTop = div.parentElement.scrollHeight;
            });

            // äº¤æ› (whereã®ã¿)
            onSnapshot(query(collection(db, "trades"), where("status", "==", "open")), (snap) => {
                const div = document.getElementById('trade-list');
                div.innerHTML = "";
                const list = [];
                snap.forEach(doc => list.push({id: doc.id, ...doc.data()}));
                // æ–°ã—ã„é †
                list.sort((a,b) => (b.createdAt?.seconds||0) - (a.createdAt?.seconds||0));

                list.forEach(t => {
                    const isMe = t.maker === currentUser.username;
                    div.innerHTML += `<div class="list-item"><div><b>${t.makerName}</b><br>${t.giveV}${t.giveT} â‡„ ${t.wantV}${t.wantT}</div>${isMe ? `<button class="btn" style="width:auto; padding:5px 10px; background:#ef4444;" onclick="cancelTrade('${t.id}')">å–æ¶ˆ</button>` : `<button class="btn" style="width:auto; padding:5px 10px;" onclick="acceptTrade('${t.id}')">äº¤æ›</button>`}</div>`;
                });
            });
        }

        // æ©Ÿèƒ½ç¾¤
        window.sendChat = async () => {
            const t = document.getElementById('chat-in').value.trim();
            if(!t) return;
            await addDoc(collection(db, "chat"), { text: t, sender: currentUser.name, username: currentUser.username, createdAt: serverTimestamp() });
            document.getElementById('chat-in').value = "";
        };

        window.saveCloud = async () => {
            const raw = localStorage.getItem('kb_save_v36');
            if(!raw) return alert("ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“");
            await updateDoc(doc(db, "users", currentUser.username), { backupData: raw });
            showToast("ä¿å­˜ã—ã¾ã—ãŸ");
        };

        window.loadCloud = async () => {
            const s = await getDoc(doc(db, "users", currentUser.username));
            if(s.data().backupData) {
                localStorage.setItem('kb_save_v36', s.data().backupData);
                alert("å¾©å…ƒã—ã¾ã—ãŸã€‚å†èª­ã¿è¾¼ã¿ã—ã¾ã™");
                location.reload();
            } else alert("ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“");
        };

        window.createTrade = async () => {
            const gt=document.getElementById('tr-give-t').value, gv=parseInt(document.getElementById('tr-give-v').value);
            const wt=document.getElementById('tr-want-t').value, wv=parseInt(document.getElementById('tr-want-v').value);
            if(!gv || !wv) return;
            if(localData[gt] < gv) return alert("ä¸è¶³ã—ã¦ã„ã¾ã™");
            
            localData[gt] -= gv; localStorage.setItem('kb_save_v36', JSON.stringify(localData)); updateHeader();
            await addDoc(collection(db, "trades"), { maker: currentUser.username, makerName: currentUser.name, giveT: gt, giveV: gv, wantT: wt, wantV: wv, status: 'open', createdAt: serverTimestamp() });
            showToast("å‡ºå“ã—ã¾ã—ãŸ");
        };

        window.cancelTrade = async (id) => {
            const s = await getDoc(doc(db, "trades", id));
            const t = s.data();
            localData[t.giveT] += t.giveV; localStorage.setItem('kb_save_v36', JSON.stringify(localData)); updateHeader();
            await deleteDoc(doc(db, "trades", id));
            sho
