<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PARTY BOX 100 + JINRO</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kosugi+Maru&family=Russo+One&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #101015; --main: #00ffcc; --accent: #ff0055; --warn: #ffcc00; }
        body { margin: 0; background: var(--bg); color: white; font-family: 'Kosugi Maru', sans-serif; overflow: hidden; height: 100vh; touch-action: manipulation; user-select: none; }
        
        /* å…±é€šãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
        .screen { position: fixed; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; background: radial-gradient(circle, #2a2a2a 0%, #000 100%); transition: opacity 0.3s; z-index: 10; text-align: center; }
        .hidden { opacity: 0; pointer-events: none; z-index: -1; }
        
        /* ãƒ†ã‚­ã‚¹ãƒˆ & ãƒœã‚¿ãƒ³ */
        h1 { font-family: 'Russo One', sans-serif; font-size: 3rem; color: var(--main); text-shadow: 0 0 15px var(--main); margin: 0; }
        .desc { color: #aaa; margin-bottom: 30px; }
        .btn { background: rgba(255,255,255,0.1); border: 2px solid var(--main); color: var(--main); padding: 15px 40px; font-size: 1.2rem; font-weight: bold; border-radius: 50px; cursor: pointer; margin: 10px; transition: 0.1s; min-width: 200px; }
        .btn:active { background: var(--main); color: black; transform: scale(0.95); }
        .btn-red { border-color: var(--accent); color: var(--accent); } .btn-red:active { background: var(--accent); color: white; }
        
        /* ãƒ•ã‚©ãƒ¼ãƒ  */
        input { font-size: 1.5rem; padding: 10px; text-align: center; border-radius: 10px; border: 2px solid #555; background: #222; color: white; width: 70%; text-transform: uppercase; margin: 10px; }

        /* ãƒ›ã‚¹ãƒˆç”»é¢ */
        #timer-bar { position: fixed; top: 0; left: 0; height: 10px; background: var(--main); width: 100%; transition: width 0.1s linear; }
        .rule-modal { position: absolute; inset: 0; background: rgba(0,0,0,0.9); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 20; }
        .role-card { font-size: 3rem; font-weight: bold; padding: 20px; border: 3px solid white; border-radius: 10px; margin: 20px; }

        /* ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆæ“ä½œã‚¨ãƒªã‚¢ */
        #ctrl-area { width: 100%; height: 70%; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 15px; }
        .big-btn { width: 150px; height: 150px; border-radius: 50%; border: none; font-size: 2rem; font-weight: bold; color: white; box-shadow: 0 10px 0 rgba(0,0,0,0.5); transition: 0.05s; }
        .big-btn:active { transform: translateY(10px); box-shadow: none; }
        .bg-red { background: #ff4757; } .bg-blue { background: #3742fa; } .bg-green { background: #2ed573; } .bg-yellow { background: #ffa502; color: black; }

        /* äººç‹¼ç”¨ */
        .vote-btn { width: 90%; padding: 15px; background: #333; border: 1px solid #666; color: white; margin: 5px; border-radius: 5px; font-size: 1.2rem; }
        .vote-btn:active { background: var(--accent); }

        /* ã‚¨ãƒ©ãƒ¼è¡¨ç¤º */
        #err-msg { color: var(--accent); font-weight: bold; min-height: 1.5em; }
    </style>
</head>
<body>

    <div id="s-top" class="screen">
        <h1>PARTY BOX<br>100 + JINRO</h1>
        <p class="desc">100ç¨®é¡ã®ãƒŸãƒ‹ã‚²ãƒ¼ãƒ  & äººç‹¼</p>
        <button id="btn-host" class="btn">ğŸ’» ãƒ›ã‚¹ãƒˆ (PC)</button>
        <button id="btn-client" class="btn btn-red">ğŸ“± å‚åŠ  (ã‚¹ãƒãƒ›)</button>
    </div>

    <div id="s-h-lobby" class="screen hidden">
        <h2>ROOM ID</h2>
        <h1 id="disp-id" style="font-size: 4rem; letter-spacing: 5px; color:white;">...</h1>
        <div id="qrcode" style="background:white; padding:10px; border-radius:10px; margin:20px;"></div>
        <p>å‚åŠ è€…: <span id="p-count" style="font-size:2rem; font-weight:bold; color:var(--main)">0</span> äºº</p>
        <div style="display:flex;">
            <button id="btn-start-random" class="btn">ğŸ² ãƒ©ãƒ³ãƒ€ãƒ ã‚²ãƒ¼ãƒ </button>
            <button id="btn-start-jinro" class="btn btn-red">ğŸº äººç‹¼ã‚²ãƒ¼ãƒ </button>
        </div>
    </div>

    <div id="s-h-game" class="screen hidden">
        <div id="timer-bar"></div>
        
        <div id="rule-modal" class="rule-modal hidden">
            <h2 style="color:var(--main)">NEXT GAME</h2>
            <h1 id="rule-title" style="font-size:3rem; margin:10px;">TITLE</h1>
            <p id="rule-desc" style="font-size:1.5rem;">ãƒ«ãƒ¼ãƒ«èª¬æ˜</p>
            <div id="rule-count" style="font-size:4rem; margin-top:20px; font-weight:bold;">3</div>
        </div>

        <h2 id="g-header">GAME</h2>
        <h1 id="g-main-text" style="font-size:4rem; margin:20px;">READY</h1>
        <div id="g-sub-text" style="font-size:2rem; color:var(--warn);"></div>
        <div id="ranking" style="text-align:left; font-size:1.2rem; margin-top:20px;"></div>
    </div>

    <div id="s-c-login" class="screen hidden">
        <h2>ROOM IDã‚’å…¥åŠ›</h2>
        <input type="text" id="inp-id" placeholder="ID (ä¾‹: ABCD)">
        <input type="text" id="inp-name" placeholder="ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ">
        <div id="err-msg"></div>
        <button id="btn-join" class="btn btn-red">éƒ¨å±‹ã«å…¥ã‚‹</button>
    </div>

    <div id="s-c-play" class="screen hidden">
        <div id="c-status" style="font-size:1.5rem; margin-bottom:20px; font-weight:bold;">å¾…æ©Ÿä¸­...</div>
        <div id="ctrl-area"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, set, get, onValue, update, remove, onDisconnect, increment, child } 
               from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        // â–¼ Firebaseè¨­å®š (ã”è‡ªèº«ã®ã‚‚ã®ã«æ›¸ãæ›ãˆã¦ãã ã•ã„)
        const firebaseConfig = {
            apiKey: "AIzaSyDbZzTMvUkG2LXIGY4ux0KBTmnAdqP236s",
            authDomain: "game-4f2d9.firebaseapp.com",
            databaseURL: "https://game-4f2d9-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "game-4f2d9",
            storageBucket: "game-4f2d9.firebasestorage.app",
            messagingSenderId: "574316347824",
            appId: "1:574316347824:web:cf686040628e25ad615675"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- å¤‰æ•° ---
        let myId = "P" + Math.floor(Math.random()*100000);
        let roomId = "";
        let players = {}; // ãƒ›ã‚¹ãƒˆç”¨
        let gameLoopTimer = null;
        let sensorActive = false;

        // --- éŸ³æº (Web Audio API) ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const playTone = (freq, type, dur) => {
            if(audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.frequency.value = freq; osc.type = type;
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + dur);
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.start(); osc.stop(audioCtx.currentTime + dur);
        };
        const sfx = {
            tap: () => playTone(400, 'triangle', 0.1),
            win: () => { playTone(600, 'square', 0.1); setTimeout(()=>playTone(800,'square',0.4), 100); },
            alert: () => playTone(150, 'sawtooth', 0.5)
        };

        // --- DOM ---
        const $ = id => document.getElementById(id);
        const show = id => {
            document.querySelectorAll('.screen').forEach(e => e.classList.add('hidden'));
            $(id).classList.remove('hidden');
        };

        // ==========================================
        //  ã‚²ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ (10ãƒ‘ã‚¿ãƒ¼ãƒ³ x NãŠé¡Œ = 100ç¨®)
        // ==========================================
        const GAME_PATTERNS = {
            mash:   { type: 'tap',    dur: 10, name: 'é€£æ‰“',    desc: 'ç”»é¢ã‚’é€£æ‰“ã—ã‚ï¼' },
            shake:  { type: 'sensor', dur: 10, name: 'SHAKE',   desc: 'ã‚¹ãƒãƒ›ã‚’æŒ¯ã‚Œï¼', mode: 'shake' },
            squat:  { type: 'sensor', dur: 15, name: 'SQUAT',   desc: 'ã‚¹ãƒãƒ›ã‚’æŒã£ã¦å±ˆä¼¸ã›ã‚ˆï¼', mode: 'squat' },
            balance:{ type: 'sensor', dur: 15, name: 'BALANCE', desc: 'ã‚¹ãƒãƒ›ã‚’æ°´å¹³ã«ä¿ã¦ï¼', mode: 'balance' },
            math:   { type: 'quiz',   dur: 15, name: 'è¨ˆç®—',    desc: 'æ­£ã—ã„ç­”ãˆã‚’é¸ã¹ï¼' },
            reflex: { type: 'tap',    dur: 10, name: 'åå°„ç¥çµŒ', desc: 'ã€ŒGO!ã€ãŒå‡ºãŸã‚‰æŠ¼ã›ï¼' },
            stop:   { type: 'tap',    dur: 15, name: 'JUST 5',  desc: '5.00ç§’ãƒ”ãƒƒã‚¿ãƒªã§æ­¢ã‚ã‚ï¼' },
            luck:   { type: 'tap',    dur: 5,  name: 'é‹ã‚²ãƒ¼',  desc: 'å½“ãŸã‚Šã‚’å¼•ã‘ï¼' },
            quiz:   { type: 'quiz',   dur: 15, name: 'ã‚¯ã‚¤ã‚º',  desc: 'æ­£è§£ã‚’é¸ã¹ï¼' },
            jinro:  { type: 'jinro',  dur: 99, name: 'äººç‹¼',    desc: 'äººç‹¼ã‚’è¦‹ã¤ã‘å‡ºã›ï¼' } // ç‰¹æ®Š
        };

        // ãŠé¡Œãƒªã‚¹ãƒˆ (ã“ã‚Œã‚’çµ„ã¿åˆã‚ã›ã¦ç„¡é™ã«ä½œã‚‹)
        const THEMES = [
            { p: 'mash', t: 'ã‚¾ãƒ³ãƒ“ã‹ã‚‰é€ƒã’ã‚', d: 'è¶³ãŒåƒåˆ‡ã‚Œã‚‹ã»ã©é€£æ‰“ï¼' },
            { p: 'mash', t: 'å£ã‚’ã¶ã¡ç ´ã‚Œ', d: 'æ°—åˆã§é€£æ‰“ï¼' },
            { p: 'shake', t: 'ãƒ—ãƒ­ãƒ†ã‚¤ãƒ³ä½œæˆ', d: 'ãƒ€ãƒã«ãªã‚‰ãªã„ã‚ˆã†ã«æŒ¯ã‚Œï¼' },
            { p: 'shake', t: 'æ¥µå¯’ã®åœ°', d: 'éœ‡ãˆã¦æš–ã‚’å–ã‚Œï¼' },
            { p: 'squat', t: 'ç­‹ãƒˆãƒ¬ã®æ™‚é–“', d: 'ã‚¹ã‚¯ãƒ¯ãƒƒãƒˆã§ãƒ‘ãƒ¯ãƒ¼ã‚’æºœã‚ã‚ï¼' },
            { p: 'balance', t: 'ãƒ‹ãƒˆãƒ­é‹æ¬', d: 'çµ¶å¯¾ã«æºã‚‰ã™ãªï¼' },
            { p: 'math', t: 'ä¼šè¨ˆãƒ‘ãƒ‹ãƒƒã‚¯', d: 'è¨ˆç®—ã‚’é–“é•ãˆã‚‹ãªï¼' },
            { p: 'reflex', t: 'å±…åˆæ–¬ã‚Š', d: 'åˆå›³ã¨ã¨ã‚‚ã«æ–¬ã‚Œ(æŠ¼ã›)ï¼' },
            { p: 'stop', t: 'æ™‚é™çˆ†å¼¾', d: '5.00ç§’ã§è§£é™¤ã‚³ãƒ¼ãƒ‰ã‚’é€ã‚Œï¼' },
            { p: 'luck', t: 'ãƒ­ã‚·ã‚¢ãƒ³ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆ', d: 'é‹ã‚’å¤©ã«ä»»ã›ã‚' }
        ];

        // ãƒ©ãƒ³ãƒ€ãƒ ã‚²ãƒ¼ãƒ ç”Ÿæˆ
        function getRandomGame() {
            // ãŠé¡Œãƒªã‚¹ãƒˆã‹ã‚‰é¸ã¶ã‹ã€ãƒ©ãƒ³ãƒ€ãƒ ç”Ÿæˆã™ã‚‹ã‹
            const theme = THEMES[Math.floor(Math.random() * THEMES.length)];
            const base = GAME_PATTERNS[theme.p];
            // ã‚¯ã‚¤ã‚º/è¨ˆç®—ã®ä¸­èº«ã¯å‹•çš„ç”Ÿæˆ
            let payload = {};
            if (theme.p === 'math') {
                const a = Math.floor(Math.random()*9)+1;
                const b = Math.floor(Math.random()*9)+1;
                payload = { q: `${a} + ${b} = ?`, opts: [a+b, a+b+1, a+b-1, a+b+2].sort(()=>Math.random()-0.5), ans: a+b };
            }
            return { ...base, title: theme.t, text: theme.d, payload };
        }

        // ==========================================
        //  HOST LOGIC
        // ==========================================
        $('btn-host').addEventListener('click', () => {
            roomId = Math.random().toString(36).substr(2, 4).toUpperCase();
            const rRef = ref(db, `rooms/${roomId}`);
            set(rRef, { status: 'lobby', host: myId });
            onDisconnect(rRef).remove();

            $('disp-id').innerText = roomId;
            $('qrcode').innerHTML = "";
            new QRCode($('qrcode'), { text: `${location.origin}${location.pathname}?room=${roomId}`, width: 128, height: 128 });
            show('s-h-lobby');

            onValue(ref(db, `rooms/${roomId}/players`), snap => {
                players = snap.val() || {};
                $('p-count').innerText = Object.keys(players).length;
            });
        });

        // --- ãƒŸãƒ‹ã‚²ãƒ¼ãƒ é–‹å§‹ ---
        $('btn-start-random').addEventListener('click', () => {
            const game = getRandomGame();
            startGameSequence(game);
        });

        // --- äººç‹¼é–‹å§‹ ---
        $('btn-start-jinro').addEventListener('click', () => {
            const pIds = Object.keys(players);
            if (pIds.length < 3) return alert("äººç‹¼ã«ã¯æœ€ä½3äººå¿…è¦ã§ã™");
            const game = { ...GAME_PATTERNS.jinro, title: "ãƒ¯ãƒ³ãƒŠã‚¤ãƒˆäººç‹¼", text: "å½¹è·ã‚’ç¢ºèªã›ã‚ˆ" };
            
            // å½¹è·å‰²ã‚Šå½“ã¦
            const wolf = pIds[Math.floor(Math.random() * pIds.length)];
            const roles = {};
            pIds.forEach(pid => roles[pid] = (pid === wolf) ? 'WOLF' : 'VILLAGER');
            game.roles = roles; // DBã«ä¿å­˜ã—ã¦ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«é€šçŸ¥
            
            startGameSequence(game);
        });

        function startGameSequence(game) {
            // 1. ã‚¹ã‚³ã‚¢ãƒªã‚»ãƒƒãƒˆ
            const updates = {};
            Object.keys(players).forEach(pid => updates[`rooms/${roomId}/players/${pid}/score`] = 0);
            update(ref(db), updates);

            // 2. DBæ›´æ–° (ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¸é€šçŸ¥)
            update(ref(db, `rooms/${roomId}`), {
                status: 'playing',
                game: game,
                step: 'rule'
            });

            // 3. ãƒ«ãƒ¼ãƒ«èª¬æ˜ç”»é¢
            show('s-h-game');
            $('rule-modal').classList.remove('hidden');
            $('rule-title').innerText = game.title;
            $('rule-desc').innerText = game.text;
            
            let count = 3;
            $('rule-count').innerText = count;
            const cd = setInterval(() => {
                count--;
                $('rule-count').innerText = count;
                if(count <= 0) {
                    clearInterval(cd);
                    $('rule-modal').classList.add('hidden');
                    runGame(game);
                }
            }, 1000);
        }

        function runGame(game) {
            update(ref(db, `rooms/${roomId}`), { step: 'play' });
            $('g-header').innerText = game.title;
            $('g-main-text').innerText = "GO!";
            $('ranking').innerHTML = "";

            if (game.type === 'jinro') {
                runJinro(game);
                return;
            }

            // --- é€šå¸¸ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ— ---
            let timeLeft = game.dur;
            gameLoopTimer = setInterval(() => {
                timeLeft -= 0.1;
                $('timer-bar').style.width = (timeLeft / game.dur * 100) + "%";

                // ãƒ©ãƒ³ã‚­ãƒ³ã‚°æ›´æ–°
                onValue(ref(db, `rooms/${roomId}/players`), snap => {
                    const list = [];
                    snap.forEach(p => list.push({ name: p.val().name, score: p.val().score || 0 }));
                    list.sort((a,b) => b.score - a.score);
                    // ãƒˆãƒƒãƒ—è¡¨ç¤º
                    if(list[0]) $('g-sub-text').innerHTML = `TOP: ${list[0].name} <span style="color:white">${list[0].score}</span>`;
                }, { onlyOnce: true });

                if (timeLeft <= 0) {
                    clearInterval(gameLoopTimer);
                    finishGame();
                }
            }, 100);
        }

        // --- äººç‹¼ãƒ­ã‚¸ãƒƒã‚¯ ---
        function runJinro(game) {
            // è­°è«–ã‚¿ã‚¤ãƒãƒ¼ (60ç§’)
            let timeLeft = 60;
            $('g-main-text').innerText = "è­°è«–ã‚¿ã‚¤ãƒ ";
            
            gameLoopTimer = setInterval(() => {
                timeLeft--;
                $('g-sub-text').innerText = `æ®‹ã‚Š ${timeLeft} ç§’`;
                $('timer-bar').style.width = (timeLeft / 60 * 100) + "%";
                
                if (timeLeft <= 0) {
                    clearInterval(gameLoopTimer);
                    // æŠ•ç¥¨ãƒ•ã‚§ãƒ¼ã‚ºã¸
                    update(ref(db, `rooms/${roomId}`), { step: 'vote' });
                    $('g-main-text').innerText = "æŠ•ç¥¨ã‚¿ã‚¤ãƒ ";
                    $('g-sub-text').innerText = "æ€ªã—ã„äººã‚’ã‚¿ãƒƒãƒ—";
                    checkVotes(Object.keys(players).length, game);
                }
            }, 1000);
        }

        function checkVotes(playerCount, game) {
            // å…¨å“¡ã®æŠ•ç¥¨ã‚’ç›£è¦–
            onValue(ref(db, `rooms/${roomId}/players`), snap => {
                let voteCount = 0;
                const votes = {};
                snap.forEach(p => {
                    if (p.val().vote) {
                        voteCount++;
                        votes[p.val().vote] = (votes[p.val().vote] || 0) + 1;
                    }
                });

                if (voteCount >= playerCount) {
                    // é›†è¨ˆå®Œäº†
                    const sorted = Object.keys(votes).sort((a,b) => votes[b] - votes[a]);
                    const executedId = sorted[0]; // æœ€å¤šå¾—ç¥¨
                    const executedName = players[executedId].name;
                    const isWolf = game.roles[executedId] === 'WOLF';
                    
                    update(ref(db, `rooms/${roomId}`), { step: 'result' });
                    
                    $('g-main-text').innerText = isWolf ? "æ‘äººã®å‹åˆ©ï¼" : "äººç‹¼ã®å‹åˆ©...";
                    $('g-sub-text').innerHTML = `å‡¦åˆ‘: ${executedName}<br>(æ­£ä½“: ${isWolf ? 'ğŸº äººç‹¼' : 'æ‘æ°‘'})`;
                    sfx.win();
                }
            });
        }

        function finishGame() {
            update(ref(db, `rooms/${roomId}`), { step: 'result' });
            $('g-main-text').innerText = "FINISH!";
            sfx.win();
            setTimeout(() => {
                show('s-h-lobby');
            }, 5000);
        }

        // ==========================================
        //  CLIENT LOGIC
        // ==========================================
        // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å‡¦ç†
        const params = new URLSearchParams(location.search);
        if(params.get('room')) {
            $('inp-id').value = params.get('room');
            show('s-c-login');
        }

        $('btn-client').addEventListener('click', () => show('s-c-login'));

        $('btn-join').addEventListener('click', async () => {
            const rid = $('inp-id').value.toUpperCase().trim();
            const name = $('inp-name').value || "NO NAME";
            if (!rid) return $('err-msg').innerText = "IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„";

            // éƒ¨å±‹å­˜åœ¨ãƒã‚§ãƒƒã‚¯
            try {
                const snap = await get(child(ref(db), `rooms/${rid}`));
                if (!snap.exists()) return $('err-msg').innerText = "éƒ¨å±‹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“";
            } catch (e) {
                return $('err-msg').innerText = "é€šä¿¡ã‚¨ãƒ©ãƒ¼: è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„";
            }

            roomId = rid;
            const pRef = ref(db, `rooms/${roomId}/players/${myId}`);
            set(pRef, { name: name, score: 0 }).then(() => {
                onDisconnect(pRef).remove();
                show('s-c-play');
                initClientListener();
                
                // ã‚»ãƒ³ã‚µãƒ¼è¨±å¯ (iOS)
                if(typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function'){
                    DeviceMotionEvent.requestPermission().catch(e=>console.log(e));
                }
            });
        });

        function initClientListener() {
            onValue(ref(db, `rooms/${roomId}`), snap => {
                const data = snap.val();
                if (!data) return location.reload();

                const game = data.game;
                const step = data.step; // rule, play, vote, result

                if (step === 'rule') {
                    $('c-status').innerText = `æ¬¡ã¯... ${game.title}`;
                    $('ctrl-area').innerHTML = `<div style="font-size:5rem">${getIcon(game.type)}</div>`;
                    stopSensor();
                } 
                else if (step === 'play') {
                    $('c-status').innerText = game.text;
                    setupController(game);
                } 
                else if (step === 'vote') {
                    $('c-status').innerText = "è¿½æ”¾ã™ã‚‹äººã‚’é¸ã‚“ã§ãã ã•ã„";
                    setupVoteUI();
                }
                else if (step === 'result') {
                    $('c-status').innerText = "çµæœç™ºè¡¨ï¼";
                    $('ctrl-area').innerHTML = "";
                    stopSensor();
                }
                else {
                    $('c-status').innerText = "ãƒ›ã‚¹ãƒˆã®æ“ä½œå¾…ã¡...";
                    $('ctrl-area').innerHTML = "";
                }
            });
        }

        function getIcon(type) {
            if(type==='tap') return 'ğŸ”¥';
            if(type==='sensor') return 'ğŸ“±';
            if(type==='quiz') return 'â“';
            if(type==='jinro') return 'ğŸº';
            return 'ğŸ®';
        }

        function setupController(game) {
            const area = $('ctrl-area');
            area.innerHTML = "";

            // --- äººç‹¼ (å½¹è·è¡¨ç¤º) ---
            if (game.type === 'jinro') {
                // è‡ªåˆ†ã®å½¹è·ã‚’å–å¾—
                // â€»æœ¬æ¥ã¯ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ãŸã‚ã‚µãƒ¼ãƒãƒ¼å´ã§éš ã™ã¹ãã§ã™ãŒç°¡æ˜“å®Ÿè£…
                const myRole = game.roles[myId];
                const color = myRole === 'WOLF' ? '#ff4757' : '#2ed573';
                area.innerHTML = `
                    <div class="role-card" style="border-color:${color}; color:${color}">
                        ${myRole === 'WOLF' ? 'ğŸº äººç‹¼' : 'æ‘æ°‘'}
                    </div>
                    <p>è­°è«–ã«å‚åŠ ã—ã¦ãã ã•ã„</p>
                `;
            }
            // --- é€£æ‰“ / åå°„ / ã‚¸ãƒ£ã‚¹ãƒˆã‚¹ãƒˆãƒƒãƒ— ---
            else if (game.type === 'tap') {
                const btn = document.createElement('button');
                btn.className = "big-btn bg-red";
                btn.innerText = "PUSH!";
                
                if (game.name === 'åå°„ç¥çµŒ') {
                    btn.innerText = "å¾…ã¦...";
                    btn.disabled = true;
                    btn.style.background = "#555";
                    // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®GOåˆå›³ã‚’å¾…ã¤å®Ÿè£…ãŒå¿…è¦ã ãŒã€ç°¡æ˜“çš„ã«ãƒ©ãƒ³ãƒ€ãƒ å¾…æ©Ÿ
                    setTimeout(() => {
                         btn.innerText = "PUSH!";
                         btn.disabled = false;
                         btn.style.background = "#ff4757";
                    }, 2000 + Math.random()*2000);
                }

                btn.addEventListener('pointerdown', (e) => {
                    e.preventDefault();
                    btn.style.transform = "scale(0.9)";
                    
                    if (game.name === 'JUST 5') {
                        // ã‚¹ãƒˆãƒƒãƒ—ã‚¦ã‚©ãƒƒãƒãƒ­ã‚¸ãƒƒã‚¯ï¼ˆçœç•¥ï¼šå˜ç´”åŠ ç®—ã«ã™ã‚‹ï¼‰
                        addScore(1);
                        btn.disabled = true;
                        btn.innerText = "STOP";
                    } else {
                        addScore(1);
                    }
                    if(navigator.vibrate) navigator.vibrate(10);
                });
                btn.addEventListener('pointerup', () => btn.style.transform = "scale(1)");
                area.appendChild(btn);
            }
            // --- ã‚»ãƒ³ã‚µãƒ¼ç³» ---
            else if (game.type === 'sensor') {
                area.innerHTML = `<div style="font-size:2rem; animation:pulse 1s infinite">ä½“ã‚’å‹•ã‹ã›ï¼</div>`;
                startSensor(game.mode);
            }
            // --- ã‚¯ã‚¤ã‚º / è¨ˆç®— ---
            else if (game.type === 'quiz') {
                $('c-status').innerText = game.payload.q || game.desc;
                const opts = game.payload.opts || ['A', 'B', 'C', 'D'];
                opts.forEach(opt => {
                    const btn = document.createElement('button');
                    btn.className = "big-btn bg-blue";
                    btn.style.width = "120px"; btn.style.height = "120px";
                    btn.innerText = opt;
                    btn.onclick = () => {
                        if (opt === game.payload.ans) {
                            addScore(10); area.innerHTML = "â­• æ­£è§£";
                        } else {
                            addScore(-5); area.innerHTML = "âŒ";
                        }
                    };
                    area.appendChild(btn);
                });
            }
        }

        // äººç‹¼æŠ•ç¥¨UI
        function setupVoteUI() {
            const area = $('ctrl-area');
            area.innerHTML = "";
            
            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒªã‚¹ãƒˆå–å¾—
            get(ref(db, `rooms/${roomId}/players`)).then(snap => {
                snap.forEach(p => {
                    if (p.key !== myId) { // è‡ªåˆ†ä»¥å¤–
                        const btn = document.createElement('button');
                        btn.className = "vote-btn";
                        btn.innerText = p.val().name;
                        btn.onclick = () => {
                            update(ref(db, `rooms/${roomId}/players/${myId}`), { vote: p.key });
                            area.innerHTML = "æŠ•ç¥¨ã—ã¾ã—ãŸ";
                        };
                        area.appendChild(btn);
                    }
                });
            });
        }

        // --- ã‚¹ã‚³ã‚¢é€ä¿¡ ---
        function addScore(amount) {
            update(ref(db, `rooms/${roomId}/players/${myId}`), { score: increment(amount) });
        }

        // --- ã‚»ãƒ³ã‚µãƒ¼å‡¦ç† ---
        function startSensor(mode) {
            if(sensorActive) return;
            sensorActive = true;
            let lastY = 0;
            
            window.addEventListener('devicemotion', function onMove(e) {
                if(!sensorActive) { window.removeEventListener('devicemotion', onMove); return; }
                const acc = e.accelerationIncludingGravity;
                if(!acc) return;

                if (mode === 'shake') {
                    if (Math.abs(acc.x+acc.y+acc.z - 30) > 20) {
                        addScore(1); if(navigator.vibrate) navigator.vibrate(20);
                    }
                } else if (mode === 'squat') {
                    if (acc.y < -3 && lastY > -3) { // ç°¡æ˜“ã‚¹ã‚¯ãƒ¯ãƒƒãƒˆåˆ¤å®š
                        addScore(1); if(navigator.vibrate) navigator.vibrate(40);
                    }
                    lastY = acc.y;
                }
            });
            
            if (mode === 'balance') {
                 window.addEventListener('deviceorientation', function onTilt(e) {
                    if(!sensorActive) { window.removeEventListener('deviceorientation', onTilt); return; }
                    // æ°´å¹³ã«è¿‘ã„(beta, gamma < 10)ãªã‚‰åŠ ç®—
                    if (Math.abs(e.beta) < 10 && Math.abs(e.gamma) < 10) {
                        if(Math.random() > 0.8) addScore(1); // é€šä¿¡é‡å‰Šæ¸›ã®ãŸã‚é–“å¼•ã
                    }
                 });
            }
        }

        function stopSensor() { sensorActive = false; }

    </script>
</body>
</html>
