<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PARTY BOX: REALTIME</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Black+Ops+One&family=Zen+Kaku+Gothic+New:wght@500;900&display=swap" rel="stylesheet">
    
    <style>
        :root { --bg: #0f0f1a; --neon: #00f2ff; --pink: #ff0055; --yellow: #ffcc00; }
        body { margin: 0; background: var(--bg); color: white; font-family: 'Zen Kaku Gothic New', sans-serif; overflow: hidden; height: 100vh; touch-action: manipulation; user-select: none; -webkit-user-select: none; }
        
        /* ç”»é¢ç®¡ç† */
        .screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; background: radial-gradient(circle, #222 0%, #000 100%); transition: opacity 0.3s; z-index: 10; }
        .hidden { opacity: 0; pointer-events: none; z-index: -1; }
        
        /* ã‚¿ã‚¤ãƒã‚°ãƒ©ãƒ•ã‚£ */
        h1 { font-family: 'Black Ops One', cursive; font-size: 2.5rem; color: var(--neon); text-shadow: 0 0 15px var(--neon); margin: 0; text-align: center; }
        h2 { color: var(--pink); margin-bottom: 10px; }
        
        /* ãƒœã‚¿ãƒ³å…±é€š */
        .btn { background: rgba(255,255,255,0.1); border: 2px solid var(--neon); color: var(--neon); padding: 15px 30px; font-size: 1.2rem; font-weight: bold; margin: 10px; cursor: pointer; border-radius: 50px; text-transform: uppercase; transition: 0.1s; min-width: 200px; }
        .btn:active { transform: scale(0.95); background: var(--neon); color: black; }
        .btn-pink { border-color: var(--pink); color: var(--pink); } 
        .btn-pink:active { background: var(--pink); color: white; }

        /* ã‚²ãƒ¼ãƒ ã‚«ãƒ¼ãƒ‰ */
        .game-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 90%; max-width: 600px; }
        .game-card { background: #333; padding: 20px; border-radius: 10px; text-align: center; cursor: pointer; border: 1px solid #555; }
        .game-card:active { border-color: var(--neon); background: #444; }

        /* ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ï¼ˆé€£æ‰“ãƒœã‚¿ãƒ³ï¼‰ */
        .tap-btn { 
            width: 80vw; height: 80vw; max-width: 300px; max-height: 300px;
            border-radius: 50%; border: none; font-size: 2rem; font-weight: 900; color: white;
            background: linear-gradient(145deg, #ff4757, #ff6b81);
            box-shadow: 0 10px 0 #c41e3a, 0 10px 20px rgba(0,0,0,0.5);
            transition: transform 0.05s, box-shadow 0.05s;
            display: flex; align-items: center; justify-content: center;
        }
        .tap-btn:active { 
            transform: translateY(10px); 
            box-shadow: 0 0 0 #c41e3a, inset 0 5px 10px rgba(0,0,0,0.5); 
        }

        /* ã‚»ãƒ³ã‚µãƒ¼ç”¨è¡¨ç¤º */
        .sensor-box {
            width: 80%; height: 60%; background: #3742fa; border-radius: 20px;
            display: flex; align-items: center; justify-content: center;
            font-size: 2rem; font-weight: bold; text-align: center;
            box-shadow: 0 0 20px rgba(55, 66, 250, 0.5);
            animation: pulse 1s infinite;
        }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }
        
        #qrcode { background: white; padding: 10px; border-radius: 10px; margin: 20px; }
        input { font-size: 1.5rem; padding: 10px; text-align: center; border-radius: 8px; border: none; margin: 10px; width: 70%; background: #333; color: white; }
    </style>
</head>
<body>

    <div id="s-top" class="screen">
        <h1>PARTY BOX<br><span style="font-size:1.5rem; color:var(--pink)">ONLINE</span></h1>
        <p>ã‚¹ãƒãƒ›ã¨PCã§éŠã¶ã‚²ãƒ¼ãƒ </p>
        <button id="btn-create-host" class="btn">ğŸ’» ãƒ›ã‚¹ãƒˆ (PC)</button>
        <button id="btn-join-client" class="btn btn-pink">ğŸ“± å‚åŠ ã™ã‚‹ (ã‚¹ãƒãƒ›)</button>
    </div>

    <div id="s-host-lobby" class="screen hidden">
        <h2>ROOM ID</h2>
        <div id="host-room-id" style="font-size: 4rem; font-weight:900;">----</div>
        <div id="qrcode"></div>
        <p>å‚åŠ äººæ•°: <span id="host-player-count" style="color:var(--yellow); font-size:2rem">0</span> äºº</p>
        <button id="btn-host-start" class="btn">ã‚²ãƒ¼ãƒ ã‚’é¸ã¶</button>
    </div>

    <div id="s-host-menu" class="screen hidden">
        <h2>SELECT GAME</h2>
        <div class="game-grid">
            <div class="game-card" id="g-tap">
                <div style="font-size:3rem">ğŸ”¥</div>
                <h3>é€£æ‰“ãƒãƒˆãƒ«</h3>
                <p>10ç§’ã§ä½•å›æŠ¼ã›ã‚‹ï¼Ÿ</p>
            </div>
            <div class="game-card" id="g-shake">
                <div style="font-size:3rem">ğŸ“±</div>
                <h3>ã‚·ã‚§ã‚¤ã‚¯ç‹</h3>
                <p>ã‚¹ãƒãƒ›ã‚’æŒ¯ã‚Šã¾ãã‚Œï¼</p>
            </div>
            <div class="game-card" id="g-luck">
                <div style="font-size:3rem">ğŸ¤</div>
                <h3>é‹ã‚²ãƒ¼</h3>
                <p>ä¸€ç™ºå‹è² ï¼</p>
            </div>
        </div>
    </div>

    <div id="s-host-game" class="screen hidden">
        <div style="position:fixed; top:0; width:100%; height:10px; background:#333;">
            <div id="timer-bar" style="width:100%; height:100%; background:var(--neon);"></div>
        </div>
        <h1 id="game-title-disp" style="margin-top:50px;">GAME</h1>
        <div id="game-status-disp" style="font-size:5rem; font-weight:900; margin:20px;">READY</div>
        <div id="game-ranking" style="font-size:1.5rem; color:var(--yellow);"></div>
    </div>

    <div id="s-client-login" class="screen hidden">
        <h2>ENTER ROOM</h2>
        <input type="text" id="inp-room-id" placeholder="ID (4æ–‡å­—)" style="text-transform:uppercase;">
        <input type="text" id="inp-name" placeholder="åå‰">
        <button id="btn-client-connect" class="btn btn-pink">GO!</button>
    </div>

    <div id="s-client-wait" class="screen hidden">
        <h2>WAITING...</h2>
        <p>ãƒ›ã‚¹ãƒˆã®ç”»é¢ã‚’è¦‹ã¦ãã ã•ã„</p>
        <div id="my-score" style="margin-top:20px; font-size:1.5rem; color:var(--yellow);">Score: 0</div>
    </div>

    <div id="s-client-play" class="screen hidden">
        <div id="ctrl-area" style="width:100%; height:100%; display:flex; align-items:center; justify-content:center;">
            </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, set, onValue, update, remove, onDisconnect, increment } 
               from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        // â–¼ è¨­å®š â–¼
        const firebaseConfig = {
            apiKey: "AIzaSyDbZzTMvUkG2LXIGY4ux0KBTmnAdqP236s",
            authDomain: "game-4f2d9.firebaseapp.com",
            databaseURL: "https://game-4f2d9-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "game-4f2d9",
            storageBucket: "game-4f2d9.firebasestorage.app",
            messagingSenderId: "574316347824",
            appId: "1:574316347824:web:cf686040628e25ad615675",
            measurementId: "G-T0ZKQCC9L3"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- å¤‰æ•° ---
        let myId = "P_" + Math.random().toString(36).substr(2, 5);
        let roomId = "";
        let isHost = false;
        let gameLoopTimer = null;
        let sensorActive = false;

        // --- DOM ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ ---
        const $ = (id) => document.getElementById(id);
        const show = (id) => {
            document.querySelectorAll('.screen').forEach(el => el.classList.add('hidden'));
            $(id).classList.remove('hidden');
        };

        // ==========================================
        //  HOST (PCå´) ã®å‡¦ç†
        // ==========================================
        
        $('btn-create-host').addEventListener('click', () => {
            isHost = true;
            roomId = Math.random().toString(36).substr(2, 4).toUpperCase();
            
            // éƒ¨å±‹ä½œæˆ
            const roomRef = ref(db, `rooms/${roomId}`);
            set(roomRef, {
                status: 'lobby',
                host: myId,
                timestamp: Date.now()
            });
            
            // åˆ‡æ–­æ™‚ã«éƒ¨å±‹ã‚’å‰Šé™¤
            onDisconnect(roomRef).remove();

            // ç”»é¢è¡¨ç¤º
            $('host-room-id').innerText = roomId;
            $('qrcode').innerHTML = "";
            new QRCode($('qrcode'), { text: `${location.origin}${location.pathname}?room=${roomId}`, width: 128, height: 128 });
            show('s-host-lobby');

            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ç›£è¦–
            onValue(ref(db, `rooms/${roomId}/players`), (snap) => {
                const players = snap.val() || {};
                $('host-player-count').innerText = Object.keys(players).length;
            });
        });

        $('btn-host-start').addEventListener('click', () => {
            show('s-host-menu');
        });

        // ã‚²ãƒ¼ãƒ é¸æŠã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
        ['tap', 'shake', 'luck'].forEach(type => {
            $(`g-${type}`).addEventListener('click', () => startGameHost(type));
        });

        function startGameHost(gameType) {
            show('s-host-game');
            
            // å…¨å“¡ã®ã‚¹ã‚³ã‚¢ãƒªã‚»ãƒƒãƒˆ & ã‚²ãƒ¼ãƒ çŠ¶æ…‹æ›´æ–°
            const updates = {};
            updates[`rooms/${roomId}/status`] = 'playing';
            updates[`rooms/${roomId}/game`] = { type: gameType, state: 'ready' };
            
            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚¹ã‚³ã‚¢ã‚’0ã«ãƒªã‚»ãƒƒãƒˆï¼ˆä¸€åº¦ãƒªã‚¹ãƒˆã‚’å–å¾—ã—ã¦ã‹ã‚‰æ›´æ–°ï¼‰
            onValue(ref(db, `rooms/${roomId}/players`), (snap) => {
                const players = snap.val() || {};
                Object.keys(players).forEach(pid => {
                    updates[`rooms/${roomId}/players/${pid}/score`] = 0;
                });
                update(ref(db), updates); // ä¸€æ‹¬æ›´æ–°
            }, { onlyOnce: true });

            $('game-title-disp').innerText = gameType.toUpperCase();
            $('game-status-disp').innerText = "READY";
            $('game-ranking').innerText = "";
            $('timer-bar').style.width = "100%";

            // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³é–‹å§‹
            setTimeout(() => {
                $('game-status-disp').innerText = "GO!";
                update(ref(db, `rooms/${roomId}/game`), { state: 'go' }); // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«é–‹å§‹åˆå›³

                // ã‚¿ã‚¤ãƒãƒ¼å‡¦ç†
                let timeLeft = 10;
                gameLoopTimer = setInterval(() => {
                    timeLeft -= 0.1;
                    $('timer-bar').style.width = (timeLeft / 10 * 100) + "%";
                    
                    if (timeLeft <= 0) {
                        clearInterval(gameLoopTimer);
                        finishGameHost();
                    }
                }, 100);

                // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤º
                onValue(ref(db, `rooms/${roomId}/players`), (snap) => {
                    if($('s-host-game').classList.contains('hidden')) return;
                    
                    const players = snap.val() || {};
                    const sorted = Object.values(players).sort((a, b) => (b.score || 0) - (a.score || 0));
                    
                    if (sorted.length > 0) {
                        const top = sorted[0];
                        $('game-ranking').innerHTML = `ğŸ‘‘ 1ä½: ${top.name} <span style="font-size:2rem; color:white">${top.score}</span>`;
                    }
                });

            }, 3000);
        }

        function finishGameHost() {
            update(ref(db, `rooms/${roomId}`), { status: 'result' });
            $('game-status-disp').innerText = "FINISH!";
            setTimeout(() => {
                show('s-host-menu'); // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹
            }, 5000);
        }


        // ==========================================
        //  CLIENT (ã‚¹ãƒãƒ›å´) ã®å‡¦ç†
        // ==========================================

        // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å‡¦ç†
        const params = new URLSearchParams(location.search);
        if (params.get('room')) {
            $('inp-room-id').value = params.get('room');
            show('s-client-login');
        }

        $('btn-join-client').addEventListener('click', () => show('s-client-login'));

        $('btn-client-connect').addEventListener('click', () => {
            const inputId = $('inp-room-id').value.toUpperCase();
            const name = $('inp-name').value || "åç„¡ã—";
            
            if (!inputId) return alert("IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
            roomId = inputId;

            // å‚åŠ å‡¦ç†
            const playerRef = ref(db, `rooms/${roomId}/players/${myId}`);
            set(playerRef, { name: name, score: 0 })
            .then(() => {
                onDisconnect(playerRef).remove(); // åˆ‡æ–­æ™‚å‰Šé™¤
                show('s-client-wait');
                initClientListener(); // ç›£è¦–é–‹å§‹
                requestSensorPermission(); // ã‚»ãƒ³ã‚µãƒ¼è¨±å¯è¦æ±‚ï¼ˆiOSç”¨ï¼‰
            })
            .catch(() => alert("éƒ¨å±‹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"));
        });

        function initClientListener() {
            onValue(ref(db, `rooms/${roomId}`), (snap) => {
                const data = snap.val();
                if (!data) return; // éƒ¨å±‹å‰Šé™¤æ¸ˆã¿

                // è‡ªåˆ†ã®ã‚¹ã‚³ã‚¢è¡¨ç¤º
                if (data.players && data.players[myId]) {
                    $('my-score').innerText = "Score: " + (data.players[myId].score || 0);
                }

                // çŠ¶æ…‹é·ç§»
                if (data.status === 'playing' && data.game) {
                    if (data.game.state === 'ready') {
                        show('s-client-wait');
                        $('my-score').innerText = "READY...";
                    } else if (data.game.state === 'go') {
                        startClientGame(data.game.type);
                    }
                } else if (data.status === 'result') {
                    show('s-client-wait');
                    $('my-score').innerText = "çµæœç™ºè¡¨ä¸­...";
                    stopSensor();
                } else {
                    show('s-client-wait');
                }
            });
        }

        function startClientGame(type) {
            show('s-client-play');
            const area = $('ctrl-area');
            area.innerHTML = ""; // ã‚¯ãƒªã‚¢

            if (type === 'tap' || type === 'luck') {
                stopSensor();
                // é€£æ‰“ãƒœã‚¿ãƒ³ç”Ÿæˆ
                const btn = document.createElement('button');
                btn.className = "tap-btn";
                btn.innerText = "PUSH!";
                
                // ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ (ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å†…ãªã®ã§ JSã§ç™»éŒ²)
                btn.addEventListener('pointerdown', (e) => {
                    e.preventDefault(); // ã‚ºãƒ¼ãƒ é˜²æ­¢
                    sendScore();
                    // ãƒã‚¤ãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
                    if (navigator.vibrate) navigator.vibrate(15);
                    // è¦–è¦šåŠ¹æœ
                    btn.style.transform = "scale(0.95)";
                });
                btn.addEventListener('pointerup', () => {
                    btn.style.transform = "scale(1)";
                });
                
                area.appendChild(btn);

            } else if (type === 'shake') {
                // ã‚»ãƒ³ã‚µãƒ¼ç”»é¢
                area.innerHTML = `<div class="sensor-box">æŒ¯ã‚Œï¼<br>SHAKE!</div>`;
                startSensor();
            }
        }

        // ã‚¹ã‚³ã‚¢é€ä¿¡é–¢æ•° (Atomic Increment)
        function sendScore() {
            const scoreRef = ref(db, `rooms/${roomId}/players/${myId}/score`);
            // runTransactionã‚’ä½¿ã‚ãšã¨ã‚‚ã€incrementã§å®‰å…¨ã«åŠ ç®—å¯èƒ½
            update(ref(db, `rooms/${roomId}/players/${myId}`), {
                score: increment(1)
            });
        }


        // ==========================================
        //  ã‚»ãƒ³ã‚µãƒ¼ãƒ­ã‚¸ãƒƒã‚¯ (åŠ é€Ÿåº¦)
        // ==========================================
        function requestSensorPermission() {
            // iOS 13+ ã®è¨±å¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
            if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
                DeviceMotionEvent.requestPermission()
                    .then(response => {
                        if (response === 'granted') {
                            console.log("Sensor granted");
                        }
                    })
                    .catch(console.error);
            }
        }

        function startSensor() {
            if (sensorActive) return;
            sensorActive = true;
            
            let lastX = 0, lastY = 0, lastZ = 0;
            const threshold = 25; // æ„Ÿåº¦

            window.addEventListener('devicemotion', function handleMotion(e) {
                if (!sensorActive) {
                    window.removeEventListener('devicemotion', handleMotion);
                    return;
                }

                const acc = e.accelerationIncludingGravity;
                if (!acc) return;

                const delta = Math.abs(acc.x + acc.y + acc.z - lastX - lastY - lastZ);
                
                if (delta > threshold) {
                    sendScore(); // æŒ¯ã£ãŸã‚‰åŠ ç®—
                    if (navigator.vibrate) navigator.vibrate(40);
                }

                lastX = acc.x;
                lastY = acc.y;
                lastZ = acc.z;
            });
        }

        function stopSensor() {
            sensorActive = false;
        }

    </script>
</body>
</html>
