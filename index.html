<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SHAKE PARTY - START</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Black+Ops+One&family=M+PLUS+Rounded+1c:wght@700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #00ffcc; --secondary: #ff00ff; --bg: #0a0a0a; }
        body { font-family: 'M PLUS Rounded 1c', sans-serif; margin: 0; background: var(--bg); color: white; overflow: hidden; touch-action: none; }
        .hidden { display: none !important; }
        .full-screen { position: absolute; top: 0; left: 0; width: 100vw; height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        
        /* ボタンデザイン */
        .btn { 
            background: linear-gradient(45deg, var(--secondary), #ff4444); 
            border: none; color: white; padding: 20px 60px; font-size: 2rem; 
            border-radius: 60px; cursor: pointer; font-family: 'Black Ops One'; 
            box-shadow: 0 0 20px var(--secondary); transition: 0.3s;
        }
        .btn:hover { transform: scale(1.05); filter: brightness(1.2); }
        .btn:disabled { background: #444; box-shadow: none; cursor: not-allowed; opacity: 0.5; }

        /* ホスト画面 */
        #arena { display: flex; align-items: flex-end; justify-content: center; width: 90%; height: 40vh; gap: 15px; border-bottom: 3px solid #333; margin-bottom: 20px; }
        .player-col { width: 80px; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: flex-end; position: relative; }
        .bar { width: 100%; border-radius: 8px 8px 0 0; transition: height 0.1s linear; }
        .p-name { font-size: 0.9rem; margin-top: 10px; color: #fff; }
        .p-score { position: absolute; top: -35px; font-family: 'Black Ops One'; font-size: 1.5rem; }

        /* プレイヤー画面 */
        input { background: #1a1a1a; border: 2px solid var(--primary); color: white; padding: 15px; font-size: 1.5rem; border-radius: 15px; text-align: center; width: 80%; outline: none; }
        #shake-circle { width: 220px; height: 220px; border-radius: 50%; background: radial-gradient(circle, #ff4444, #880000); border: 10px solid rgba(255,255,255,0.2); display: flex; flex-direction: column; align-items: center; justify-content: center; box-shadow: 0 0 40px #ff0000; }
        .active { transform: scale(0.92); }
    </style>
</head>
<body>

    <!-- HOST VIEW -->
    <div id="host-view" class="full-screen hidden">
        <h1 style="font-family:'Black Ops One'; font-size:3rem; color:var(--primary); margin:0;">SHAKE PARTY</h1>
        <div id="timer" style="font-size:7rem; font-family:'Black Ops One'; margin:10px 0;">10</div>
        
        <div id="arena"></div>

        <div id="lobby-controls" style="text-align:center;">
            <div id="qrcode" style="background:white; padding:10px; display:inline-block; border-radius:10px; margin-bottom:10px;"></div>
            <p id="room-id-display" style="color:var(--primary); margin-bottom:20px;">Room ID: ----</p>
            <!-- 参加者がいないと押せないボタン -->
            <button id="start-btn" class="btn" onclick="window.gameStart()" disabled>WAITING PLAYERS...</button>
        </div>
    </div>

    <!-- PLAYER VIEW -->
    <div id="client-view" class="full-screen hidden">
        <div id="step-name">
            <h2 style="color:var(--primary)">ENTER NAME</h2>
            <input type="text" id="username" placeholder="名前" maxlength="6"><br>
            <button class="btn" onclick="window.playerJoin()" style="margin-top:20px; font-size:1.5rem;">JOIN!</button>
        </div>

        <div id="step-game" class="full-screen hidden">
            <div id="msg" style="font-size:1.5rem; margin-bottom:20px; color:#aaa;">待機中</div>
            <div id="shake-circle">
                <div id="score" style="font-size:5rem; font-family:'Black Ops One';">0</div>
                <div style="font-weight:bold;">SHAKES</div>
            </div>
        </div>

        <div id="step-perm" class="full-screen hidden">
            <button class="btn" onclick="window.askSensor()">START SENSOR</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
        import { getDatabase, ref, set, onValue, update, onDisconnect } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

        // ==========================================
        // 1. FIREBASE CONFIG (ここを自分の設定に！)
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyDbZzTMvUkG2LXIGY4ux0KBTmnAdqP236s",
            authDomain: "game-4f2d9.firebaseapp.com",
            databaseURL: "https://game-4f2d9-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "game-4f2d9",
            storageBucket: "game-4f2d9.firebasestorage.app",
            messagingSenderId: "574316347824",
            appId: "1:574316347824:web:cf686040628e25ad615675"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const urlParams = new URLSearchParams(window.location.search);
        let role = urlParams.get('role');
        let roomId = urlParams.get('room');

        if (!role) {
            roomId = Math.random().toString(36).substring(2, 6).toUpperCase();
            window.location.replace(`?role=host&room=${roomId}`);
        } else if (role === 'host') {
            document.getElementById('host-view').classList.remove('hidden');
            initHost();
        } else {
            document.getElementById('client-view').classList.remove('hidden');
            initPlayer();
        }

        // ==========================================
        // HOST logic
        // ==========================================
        function initHost() {
            document.getElementById('room-id-display').innerText = `Room ID: ${roomId}`;
            const qrUrl = `${window.location.origin}${window.location.pathname}?role=player&room=${roomId}`;
            new QRCode(document.getElementById("qrcode"), { text: qrUrl, width: 120, height: 120 });

            const playersRef = ref(db, `shake/${roomId}/players`);
            const stateRef = ref(db, `shake/${roomId}/state`);

            // プレイヤー参加監視
            onValue(playersRef, (snap) => {
                const arena = document.getElementById('arena');
                const startBtn = document.getElementById('start-btn');
                arena.innerHTML = '';
                const players = snap.val() || {};
                const pIds = Object.keys(players);

                // 参加者が1人以上いればボタンを有効化
                if (pIds.length > 0) {
                    startBtn.disabled = false;
                    startBtn.innerText = "BATTLE START!";
                } else {
                    startBtn.disabled = true;
                    startBtn.innerText = "WAITING PLAYERS...";
                }

                pIds.forEach((id, idx) => {
                    const p = players[id];
                    const h = Math.min((p.count || 0) * 2.5, 100);
                    const color = `hsl(${idx * 60}, 80%, 50%)`;
                    const col = document.createElement('div');
                    col.className = 'player-col';
                    col.innerHTML = `
                        <div class="p-score" style="color:${color}">${p.count || 0}</div>
                        <div class="bar" style="height:${h}%; background:${color}; box-shadow:0 0 15px ${color}"></div>
                        <div class="p-name">${p.name}</div>
                    `;
                    arena.appendChild(col);
                });
            });

            // 開始処理
            window.gameStart = () => {
                update(stateRef, { status: 'ready' });
                document.getElementById('lobby-controls').classList.add('hidden');
                
                // スコアリセット
                onValue(playersRef, (snap) => {
                    const data = snap.val(); if(!data) return;
                    const updates = {};
                    Object.keys(data).forEach(id => updates[`players/${id}/count`] = 0);
                    update(ref(db, `shake/${roomId}`), updates);
                }, { onlyOnce: true });

                let cd = 3;
                const tm = document.getElementById('timer');
                const cdItv = setInterval(() => {
                    tm.innerText = cd > 0 ? cd : "GO!";
                    if (cd === 0) {
                        clearInterval(cdItv);
                        runBattle();
                    }
                    cd--;
                }, 1000);
            };

            function runBattle() {
                update(stateRef, { status: 'running' });
                let time = 10;
                const tm = document.getElementById('timer');
                const itv = setInterval(() => {
                    time--;
                    tm.innerText = time;
                    if (time <= 0) {
                        clearInterval(itv);
                        update(stateRef, { status: 'finished' });
                        tm.innerText = "FINISH!";
                        setTimeout(() => document.getElementById('lobby-controls').classList.remove('hidden'), 5000);
                    }
                }, 1000);
            }
        }

        // ==========================================
        // PLAYER logic
        // ==========================================
        function initPlayer() {
            let myId = Math.random().toString(36).substring(2, 7);
            let count = 0;
            let canShake = false;

            window.playerJoin = () => {
                const name = document.getElementById('username').value || "Guest";
                if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
                    document.getElementById('step-name').classList.add('hidden');
                    document.getElementById('step-perm').classList.remove('hidden');
                } else {
                    connect(name);
                }
            };

            window.askSensor = async () => {
                const res = await DeviceMotionEvent.requestPermission();
                if (res === 'granted') {
                    document.getElementById('step-perm').classList.add('hidden');
                    connect(document.getElementById('username').value || "Guest");
                }
            };

            function connect(name) {
                document.getElementById('step-name').classList.add('hidden');
                document.getElementById('step-game').classList.remove('hidden');

                const myRef = ref(db, `shake/${roomId}/players/${myId}`);
                set(myRef, { name: name, count: 0 });
                onDisconnect(myRef).remove();

                onValue(ref(db, `shake/${roomId}/state`), (snap) => {
                    const s = snap.val() || {};
                    const m = document.getElementById('msg');
                    if (s.status === 'ready') {
                        count = 0; document.getElementById('score').innerText = 0;
                        m.innerText = "READY..."; canShake = false;
                    } else if (s.status === 'running') {
                        m.innerText = "SHAKE IT!!"; canShake = true;
                    } else if (s.status === 'finished') {
                        m.innerText = "FINISHED"; canShake = false;
                    }
                });

                let lastA = {x:0, y:0, z:0};
                window.addEventListener('devicemotion', (e) => {
                    if (!canShake) return;
                    const a = e.accelerationIncludingGravity;
                    const d = Math.abs(a.x - lastA.x) + Math.abs(a.y - lastA.y) + Math.abs(a.z - lastA.z);
                    if (d > 25) {
                        count++;
                        document.getElementById('score').innerText = count;
                        document.getElementById('shake-circle').classList.add('active');
                        setTimeout(() => document.getElementById('shake-circle').classList.remove('active'), 50);
                        if (count % 2 === 0) update(myRef, { count: count });
                    }
                    lastA = {x:a.x, y:a.y, z:a.z};
                });
            }
        }
    </script>
</body>
</html>
