<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SHAKE PARTY - 同期強化版</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Black+Ops+One&family=M+PLUS+Rounded+1c:wght@700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #00ffcc; --secondary: #ff00ff; --bg: #0a0a0a; }
        body { font-family: 'M PLUS Rounded 1c', sans-serif; margin: 0; background: var(--bg); color: white; overflow: hidden; touch-action: none; }
        .hidden { display: none !important; }
        .full-screen { position: absolute; top: 0; left: 0; width: 100vw; height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .btn { background: linear-gradient(45deg, var(--secondary), #ff4444); border: none; color: white; padding: 15px 40px; font-size: 1.5rem; border-radius: 50px; cursor: pointer; font-family: 'Black Ops One'; box-shadow: 0 0 15px var(--secondary); margin-top: 20px; }
        
        /* HOST */
        #arena { display: flex; align-items: flex-end; justify-content: center; width: 90%; height: 45vh; gap: 10px; border-bottom: 3px solid #444; }
        .player-col { width: 60px; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: flex-end; position: relative; }
        .bar { width: 100%; transition: height 0.1s linear; }
        .p-name { font-size: 0.7rem; margin-top: 10px; width: 100%; text-align: center; white-space: nowrap; overflow: hidden; }
        .p-score { position: absolute; top: -30px; font-family: 'Black Ops One'; }

        /* CLIENT */
        #shake-circle { width: 200px; height: 200px; border-radius: 50%; background: radial-gradient(circle, #ff4444, #990000); border: 8px solid rgba(255,255,255,0.2); display: flex; flex-direction: column; align-items: center; justify-content: center; box-shadow: 0 0 30px #ff0000; }
        input { background: #222; border: 2px solid var(--primary); color: white; padding: 10px; font-size: 1.5rem; border-radius: 10px; text-align: center; }
    </style>
</head>
<body>

    <!-- ホスト画面 -->
    <div id="host-view" class="full-screen hidden">
        <h1 style="font-family:'Black Ops One'; color:var(--primary);">SHAKE PARTY</h1>
        <div id="timer" style="font-size:5rem; font-family:'Black Ops One';">10</div>
        <div id="arena"></div>
        <div id="lobby-ui" style="text-align:center; margin-top:20px;">
            <div id="qrcode" style="background:white; padding:10px; display:inline-block; border-radius:10px;"></div>
            <p id="room-id-display" style="color:#666;"></p>
            <button class="btn" onclick="window.gameStart()">BATTLE START</button>
        </div>
    </div>

    <!-- プレイヤー画面 -->
    <div id="client-view" class="full-screen hidden">
        <div id="step-name">
            <h2>名前を入力</h2>
            <input type="text" id="username" placeholder="ニックネーム" maxlength="6"><br>
            <button class="btn" onclick="window.playerJoin()">参加する</button>
        </div>
        <div id="step-shake" class="full-screen hidden">
            <div id="msg" style="margin-bottom:20px;">待機中...</div>
            <div id="shake-circle"><div id="score" style="font-size:4rem; font-family:'Black Ops One';">0</div></div>
        </div>
        <div id="step-perm" class="full-screen hidden"><button class="btn" onclick="window.askSensor()">センサーを許可</button></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
        import { getDatabase, ref, set, onValue, update, onDisconnect, push } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

        // ==========================================
        // 自分のFirebase設定をここに貼り付けてください
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyDbZzTMvUkG2LXIGY4ux0KBTmnAdqP236s",
            authDomain: "game-4f2d9.firebaseapp.com",
            databaseURL: "https://game-4f2d9-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "game-4f2d9",
            storageBucket: "game-4f2d9.firebasestorage.app",
            messagingSenderId: "574316347824",
            appId: "1:574316347824:web:cf686040628e25ad615675"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const urlParams = new URLSearchParams(window.location.search);
        let role = urlParams.get('role');
        let roomId = urlParams.get('room');

        // 起動時：Host or Player 分岐
        if (!role) {
            roomId = Math.random().toString(36).substring(2, 6).toUpperCase();
            window.location.replace(`?role=host&room=${roomId}`);
        } else if (role === 'host') {
            document.getElementById('host-view').classList.remove('hidden');
            setupHost();
        } else {
            document.getElementById('client-view').classList.remove('hidden');
            setupPlayer();
        }

        // ==========================================
        // HOST 処理
        // ==========================================
        function setupHost() {
            document.getElementById('room-id-display').innerText = `ROOM ID: ${roomId}`;
            const qrUrl = `${window.location.origin}${window.location.pathname}?role=player&room=${roomId}`;
            new QRCode(document.getElementById("qrcode"), { text: qrUrl, width: 120, height: 120 });

            // プレイヤー一覧の同期監視
            onValue(ref(db, `shake/${roomId}/players`), (snap) => {
                const arena = document.getElementById('arena');
                arena.innerHTML = '';
                const players = snap.val() || {};
                
                Object.keys(players).forEach((id, index) => {
                    const p = players[id];
                    const h = Math.min((p.count || 0) * 2, 100);
                    const color = `hsl(${index * 70}, 80%, 50%)`;
                    const col = document.createElement('div');
                    col.className = 'player-col';
                    col.innerHTML = `
                        <div class="p-score">${p.count || 0}</div>
                        <div class="bar" style="height:${h}%; background:${color}; box-shadow:0 0 10px ${color}"></div>
                        <div class="p-name">${p.name}</div>
                    `;
                    arena.appendChild(col);
                });
            });

            window.gameStart = () => {
                update(ref(db, `shake/${roomId}`), { "state/status": "ready" });
                // スコアリセット
                onValue(ref(db, `shake/${roomId}/players`), (snap) => {
                    const data = snap.val(); if(!data) return;
                    const updates = {};
                    Object.keys(data).forEach(id => { updates[`players/${id}/count`] = 0; });
                    update(ref(db, `shake/${roomId}`), updates);
                }, { onlyOnce: true });

                let count = 3;
                const itv = setInterval(() => {
                    document.getElementById('timer').innerText = count > 0 ? count : "GO!";
                    if (count === 0) {
                        clearInterval(itv);
                        battleRunning();
                    }
                    count--;
                }, 1000);
            };

            function battleRunning() {
                update(ref(db, `shake/${roomId}`), { "state/status": "running" });
                let time = 10;
                const itv = setInterval(() => {
                    time--;
                    document.getElementById('timer').innerText = time;
                    if (time <= 0) {
                        clearInterval(itv);
                        update(ref(db, `shake/${roomId}`), { "state/status": "finished" });
                        document.getElementById('timer').innerText = "FINISH!";
                    }
                }, 1000);
            }
        }

        // ==========================================
        // PLAYER 処理
        // ==========================================
        function setupPlayer() {
            let myId = localStorage.getItem('myShakeId') || Math.random().toString(36).substring(2, 7);
            localStorage.setItem('myShakeId', myId);
            let myCount = 0;
            let canShake = false;

            window.playerJoin = () => {
                const name = document.getElementById('username').value || "ゲスト";
                if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
                    document.getElementById('step-name').classList.add('hidden');
                    document.getElementById('step-perm').classList.remove('hidden');
                } else {
                    connectRoom(name);
                }
            };

            window.askSensor = async () => {
                const res = await DeviceMotionEvent.requestPermission();
                if (res === 'granted') {
                    document.getElementById('step-perm').classList.add('hidden');
                    connectRoom(document.getElementById('username').value || "ゲスト");
                }
            };

            function connectRoom(name) {
                document.getElementById('step-name').classList.add('hidden');
                document.getElementById('step-shake').classList.remove('hidden');

                const myRef = ref(db, `shake/${roomId}/players/${myId}`);
                set(myRef, { name: name, count: 0 });
                onDisconnect(myRef).remove();

                // ゲーム状態の監視
                onValue(ref(db, `shake/${roomId}/state`), (snap) => {
                    const state = snap.val() || {};
                    const msg = document.getElementById('msg');
                    if (state.status === 'ready') {
                        myCount = 0; document.getElementById('score').innerText = "0";
                        msg.innerText = "準備して..."; canShake = false;
                    } else if (state.status === 'running') {
                        msg.innerText = "振れええ！！"; canShake = true;
                    } else if (state.status === 'finished') {
                        msg.innerText = "終了！"; canShake = false;
                    }
                });

                // シェイク検知
                let lastA = {x:0, y:0, z:0};
                window.addEventListener('devicemotion', (e) => {
                    if (!canShake) return;
                    const a = e.accelerationIncludingGravity;
                    const diff = Math.abs(a.x - lastA.x) + Math.abs(a.y - lastA.y) + Math.abs(a.z - lastA.z);
                    if (diff > 25) { // 感度
                        myCo
