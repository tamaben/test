<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PARTY BOX: OMEGA</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Black+Ops+One&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0a0a0a;
            --glass: rgba(255, 255, 255, 0.05);
            --neon-blue: #00f3ff;
            --neon-pink: #ff0099;
            --neon-green: #00ff66;
            --neon-yellow: #ffee00;
            --text: #fff;
        }
        * { box-sizing: border-box; touch-action: none; user-select: none; -webkit-user-select: none; }
        body {
            margin: 0; background: var(--bg); color: var(--text);
            font-family: 'Roboto', sans-serif; overflow: hidden;
        }

        /* --- ÂÖ±ÈÄöUI --- */
        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: radial-gradient(circle at center, #1a1a1a 0%, #000 100%);
            transition: opacity 0.3s;
        }
        .hidden { display: none !important; }
        
        h1, h2 { font-family: 'Black Ops One', cursive; text-transform: uppercase; margin: 0; letter-spacing: 2px; }
        h1 { font-size: 4rem; text-shadow: 0 0 20px var(--neon-blue); background: linear-gradient(to right, var(--neon-blue), var(--neon-pink)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        .btn {
            background: var(--glass); border: 1px solid var(--neon-blue); color: var(--neon-blue);
            padding: 15px 40px; font-size: 1.2rem; margin: 10px; cursor: pointer;
            font-family: 'Black Ops One', cursive; transition: 0.2s; text-transform: uppercase;
            box-shadow: 0 0 10px rgba(0, 243, 255, 0.2);
        }
        .btn:active { transform: scale(0.95); background: var(--neon-blue); color: #000; }
        .btn-pink { border-color: var(--neon-pink); color: var(--neon-pink); }
        .btn-green { border-color: var(--neon-green); color: var(--neon-green); }

        /* --- HOST UI --- */
        .menu-grid {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;
            max-width: 800px; padding: 20px;
        }
        .game-card {
            background: #222; border: 1px solid #444; padding: 20px; text-align: center;
            cursor: pointer; transition: 0.3s; border-radius: 10px;
        }
        .game-card:hover { border-color: var(--neon-yellow); transform: translateY(-5px); box-shadow: 0 0 15px var(--neon-yellow); }
        .icon { font-size: 3rem; margin-bottom: 10px; display: block; }
        
        #host-stage { justify-content: flex-start; padding-top: 40px; }
        .stage-visual { font-size: 5rem; font-weight: bold; margin: 20px 0; text-align: center; width: 80%; }
        .timer-bar { width: 100%; height: 10px; background: #333; position: fixed; top: 0; }
        .timer-fill { height: 100%; background: var(--neon-green); width: 100%; transition: width linear 0.1s; }

        /* „ÇØ„Ç§„Ç∫‰ΩúÊàê„É¢„Éº„ÉÄ„É´ */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .input-box { background: #333; border: none; color: white; padding: 10px; width: 300px; margin: 5px; font-size: 1.2rem; }

        /* --- CLIENT UI --- */
        #client-area { width: 100%; height: 100%; }
        .ctrl-btn { width: 100%; height: 100%; border: none; font-size: 2rem; font-weight: bold; color: white; }
        .c-red { background: #ff4757; } .c-blue { background: #2e86de; } 
        .c-green { background: #2ed573; } .c-yellow { background: #ffa502; color: #000; }
        
        /* „Ç®„Éï„Çß„ÇØ„Éà */
        @keyframes flash { 0% { background: white; } 100% { background: var(--bg); } }
        .flash-effect { animation: flash 0.2s; }
        @keyframes shake { 0% { transform: translate(2px, 2px); } 100% { transform: translate(-2px, -2px); } }
        .shake-screen { animation: shake 0.1s infinite; }
    </style>
</head>
<body>

<div id="host-view" class="hidden">
    <div id="h-lobby" class="screen">
        <h1>PARTY BOX: OMEGA</h1>
        <div style="background: white; padding: 10px; margin: 20px;">
            <div id="qrcode"></div>
        </div>
        <p>„Çπ„Éû„Éõ„ÅßÂèÇÂä†„Åõ„Çà / Players: <span id="p-count" style="color:var(--neon-green); font-size:1.5rem">0</span></p>
        <button class="btn" onclick="Host.toMenu()">START SYSTEM</button>
    </div>

    <div id="h-menu" class="screen hidden">
        <h2>SELECT MODULE</h2>
        <div class="menu-grid" id="game-list"></div>
        <div style="margin-top: 20px;">
            <button class="btn btn-green" onclick="Host.startRandom()">üé≤ RANDOM (‚àû MODE)</button>
        </div>
    </div>

    <div id="h-quiz-setup" class="modal hidden">
        <h2>QUIZ SETUP</h2>
        <button class="btn btn-green" onclick="Host.startQuiz('random')">üìö „É©„É≥„ÉÄ„É†Âá∫È°å (DB)</button>
        <div style="margin: 20px 0; border-top: 1px solid #555; width: 50%;"></div>
        <h3>üìù „Ç™„É™„Ç∏„Éä„É´ÂïèÈ°å‰ΩúÊàê</h3>
        <input type="text" id="q-text" class="input-box" placeholder="ÂïèÈ°åÊñá (‰æã: ÁßÅ„ÅÆÂ•Ω„Åç„Å™È£ü„ÅπÁâ©„ÅØÔºü)">
        <input type="text" id="q-ans-correct" class="input-box" placeholder="Ê≠£Ëß£ (‰æã: „Ç´„É¨„Éº)" style="border-bottom: 2px solid var(--neon-green)">
        <input type="text" id="q-ans-2" class="input-box" placeholder="‰∏çÊ≠£Ëß£1">
        <input type="text" id="q-ans-3" class="input-box" placeholder="‰∏çÊ≠£Ëß£2">
        <input type="text" id="q-ans-4" class="input-box" placeholder="‰∏çÊ≠£Ëß£3">
        <button class="btn btn-pink" onclick="Host.startQuiz('custom')">„Åì„ÅÆÂïèÈ°å„ÅßÂá∫È°å</button>
        <button class="btn" onclick="Host.toMenu()">Êàª„Çã</button>
    </div>

    <div id="h-stage" class="screen hidden">
        <div class="timer-bar"><div id="timer-fill" class="timer-fill"></div></div>
        <div id="stage-title" style="color: #888; margin-bottom: 10px;">TITLE</div>
        <div id="stage-main" class="stage-visual">READY</div>
        <div id="stage-sub" style="font-size: 1.5rem; color: var(--neon-yellow);"></div>
    </div>

    <div id="h-result" class="screen hidden">
        <h1 style="color: var(--neon-green)">WINNER</h1>
        <div id="res-winner" style="font-size: 4rem; margin: 30px 0;">PLAYER</div>
        <button class="btn" onclick="Host.toMenu()">MENU</button>
    </div>
</div>

<div id="client-view" class="hidden">
    <div id="c-login" class="screen">
        <h2>CONNECT</h2>
        <input type="text" id="username" placeholder="NAME" style="padding: 15px; font-size: 1.2rem; text-align: center; width: 80%;">
        <button class="btn" onclick="Client.join()">ENTER</button>
        <p style="font-size: 0.8rem; color: #666;">‚ÄªiPhone„ÅØ„Éû„Éä„Éº„É¢„Éº„Éâ„ÇíËß£Èô§„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
    </div>

    <div id="c-wait" class="screen hidden">
        <h2 style="animation: pulse 1s infinite">WAITING...</h2>
    </div>

    <div id="c-ctrl" class="screen hidden" style="background: black;">
        </div>
</div>

<script>
/* ==================== 1. „ÇØ„Ç§„Ç∫„Éá„Éº„Çø„Éô„Éº„Çπ (Êã°ÂºµÂèØËÉΩ) ==================== */
// „Åì„Åì„Å´ÂïèÈ°å„Çí„Ç´„É≥„ÉûÂå∫Âàá„Çä„ÅßÂ¢ó„ÇÑ„Åõ„Å∞ÁÑ°Èôê„Å´ËøΩÂä†ÂèØËÉΩ„Åß„Åô„ÄÇ
// { q: "ÂïèÈ°åÊñá", a: ["Ê≠£Ëß£", "Ë™§Á≠î1", "Ë™§Á≠î2", "Ë™§Á≠î3"] }
const QUIZ_DB = [
    {q:"„ÄåÊó•Êú¨‰∏ÄÈ´ò„ÅÑÂ±±„Äç„ÅØÔºü", a:["ÂØåÂ£´Â±±","ÂåóÂ≤≥","ÈòøËòáÂ±±","È´òÂ∞æÂ±±"]},
    {q:"ÂÖÉÁ¥†Ë®òÂè∑„ÄåO„Äç„ÅØ‰Ωï„ÇíË°®„ÅôÔºü", a:["ÈÖ∏Á¥†","Èáë","ÈäÄ","ÈâÑ"]},
    {q:"1000ÂÜÜÊú≠„ÅÆËÇñÂÉèÁîª„ÅØÔºü(2024)", a:["ÂåóÈáåÊü¥‰∏âÈÉé","ÈáéÂè£Ëã±‰∏ñ","Á¶èÊ≤¢Ë´≠Âêâ","Ê∏ãÊ≤¢Ê†Ñ‰∏Ä"]},
    {q:"„Äå„Éë„É≥„Äç„ÅØÂÖÉ„ÄÖ„Å©„Åì„ÅÆÂõΩ„ÅÆË®ÄËëâÔºü", a:["„Éù„É´„Éà„Ç¨„É´","„Éï„É©„É≥„Çπ","Ëã±Ë™û","„Éâ„Ç§„ÉÑ"]},
    {q:"„Ç§„É≥„Çø„Éº„Éç„ÉÉ„Éà‰∏ä„ÅÆ‰ΩèÊâÄ„Å´„ÅÇ„Åü„Çã„ÇÇ„ÅÆ„ÅØÔºü", a:["IP„Ç¢„Éâ„É¨„Çπ","MAC„Ç¢„Éâ„É¨„Çπ","ÈÉµ‰æøÁï™Âè∑","DNS"]},
    {q:"„ÄåÁæ©ÂãôÊïôËÇ≤„Äç„ÅØ‰∏≠Â≠¶Ê†°„Åæ„Åß„ÄÇ‚óã„Åã√ó„ÅãÔºü", a:["‚óã","√ó","‚ñ≥","Ôºü"]},
    {q:"Âæ≥Â∑ùÂÆ∂Â∫∑„ÅåÂπïÂ∫ú„ÇíÈñã„ÅÑ„ÅüÂ†¥ÊâÄ„ÅØÔºü", a:["Ê±üÊà∏","‰∫¨ÈÉΩ","Â§ßÈò™","ÈéåÂÄâ"]},
    {q:"Ê¨°„ÅÆ‰∏≠„Åß„ÄåÊûúÁâ©„Äç„Åß„ÅØ„Å™„Åè„ÄåÈáéËèú„Äç„Å™„ÅÆ„ÅØÔºü", a:["„Ç§„ÉÅ„Ç¥","„É™„É≥„Ç¥","„Éü„Ç´„É≥","„Éñ„Éâ„Ç¶"]},
    {q:"QR„Ç≥„Éº„Éâ„ÅÆ„ÄåQR„Äç„ÅÆÊÑèÂë≥„ÅØÔºü", a:["Quick Response","Quiz Rally","Quality Rank","Queen Road"]},
    {q:"‰∫îÂçÉÂÜÜÊú≠„ÅÆËÇñÂÉèÁîª„ÅØÔºü(2024)", a:["Ê¥•Áî∞Ê¢ÖÂ≠ê","Ê®ãÂè£‰∏ÄËëâ","Á¥´ÂºèÈÉ®","Ê∏ÖÂ∞ëÁ¥çË®Ä"]},
    // ...„Åì„Åì„Å´150ÂïèÂàÜËøΩÂä†„Åó„Å¶„Åè„Å†„Åï„ÅÑ...
    {q:"Ê∞¥„ÅÆÂåñÂ≠¶Âºè„ÅØÔºü", a:["H2O","CO2","O2","HO"]},
    {q:"„Çµ„ÉÉ„Ç´„Éº„ÅÆ1„ÉÅ„Éº„É†„ÅÆ‰∫∫Êï∞„ÅØÔºü", a:["11‰∫∫","9‰∫∫","10‰∫∫","12‰∫∫"]},
    {q:"ÁèæÂú®(2026)„ÅÆÊó•Êú¨„ÅÆÂÖÉÂè∑„ÅØÔºü", a:["‰ª§Âíå","Âπ≥Êàê","Êò≠Âíå","Â§ßÊ≠£"]},
    {q:"„Éë„ÇΩ„Ç≥„É≥„ÅÆ„Äå„Éû„Ç¶„Çπ„Äç„ÇíÂãï„Åã„Åô„Å®Âãï„ÅèÁü¢Âç∞„ÅÆÂêçÂâç„ÅØÔºü", a:["„Ç´„Éº„ÇΩ„É´","„Éù„Ç§„É≥„Çø„Éº","„Ç¢„É≥„Ç´„Éº","„Ç¢„Ç§„Ç≥„É≥"]},
    {q:"„Äå‰∫∫Èñì„ÅØËÄÉ„Åà„Çã‚óØ‚óØ„Åß„ÅÇ„Çã„Äç", a:["Ëë¶(„ÅÇ„Åó)","Ë∂≥","Áü≥","Áâõ"]},
    {q:"Êó•Êú¨„Åß‰∏ÄÁï™Â∫É„ÅÑÈÉΩÈÅìÂ∫úÁúå„ÅØÔºü", a:["ÂåóÊµ∑ÈÅì","Â≤©ÊâãÁúå","Á¶èÂ≥∂Áúå","Èï∑ÈáéÁúå"]},
    {q:"ÔºëÊó•„ÅØ‰ΩïÁßíÔºü", a:["86400Áßí","3600Áßí","60000Áßí","100000Áßí"]},
    {q:"„Éâ„É©„Åà„ÇÇ„Çì„ÅÆË™ïÁîüÊó•„ÅØÔºü", a:["2112Âπ¥9Êúà3Êó•","2012Âπ¥9Êúà3Êó•","1990Âπ¥9Êúà3Êó•","2200Âπ¥1Êúà1Êó•"]},
    {q:"Âπ≤ÊîØ„ÅÆÊúÄÂàù„ÅØÔºü", a:["Â≠ê(„Å≠)","‰∏ë(„ÅÜ„Åó)","ÂØÖ(„Å®„Çâ)","Áî≥(„Åï„Çã)"]},
    {q:"‰∏ñÁïå„Åß‰∏ÄÁï™‰∫∫Âè£„ÅåÂ§ö„ÅÑÂõΩ„ÅØÔºü(2024Êé®Ë®à)", a:["„Ç§„É≥„Éâ","‰∏≠ÂõΩ","„Ç¢„É°„É™„Ç´","„Ç§„É≥„Éâ„Éç„Ç∑„Ç¢"]}
];

/* ==================== 2. „Ç≤„Éº„É†„É™„Çπ„Éà ==================== */
const GAMES = [
    { id: 'quiz', name: '„ÇØ„Ç§„Ç∫„Éê„Éà„É´', icon: 'üéì', type: 'quiz' },
    { id: 'mash', name: 'ÈÄ£Êâì„Éá„Çπ„Éû„ÉÉ„ÉÅ', icon: 'üî•', type: 'tap' },
    { id: 'shake', name: '„Ç∑„Çß„Ç§„ÇØ„Éª„Ç§„ÉÉ„Éà', icon: 'üì±', type: 'shake' },
    { id: 'timer', name: '10Áßí„Ç∏„É£„Çπ„Éà', icon: '‚è±Ô∏è', type: 'tap' },
    { id: 'bomb', name: 'ÁàÜÂºæÂõû„Åó„Ç≤„Éº„É†', icon: 'üí£', type: 'pass' },
    { id: 'reflex', name: 'ÂèçÂ∞ÑÁ•ûÁµå„ÉÜ„Çπ„Éà', icon: '‚ö°', type: 'tap' },
    { id: 'gyro', name: '„Éê„É©„É≥„ÇπÁéã', icon: '‚öñÔ∏è', type: 'gyro' },
    { id: 'swipe', name: '„Çµ„É†„É©„Ç§„Éª„Éï„É™„ÉÉ„ÇØ', icon: '‚öîÔ∏è', type: 'swipe' },
    { id: 'survivor', name: 'Ëµ§„ÇíÊäº„Åô„Å™ÔºÅ', icon: 'üö´', type: 'tap' }, // ÊåáÁ§∫„Å®ÈÅï„ÅÜËâ≤„ÇíÊäº„Åô„Å®ËÑ±ËêΩ
    { id: 'color', name: 'Ëâ≤Êé¢„Åó', icon: 'üé®', type: 'camera' }, // (Êì¨‰ºº) ÊåáÂÆö„Åï„Çå„ÅüËâ≤„Å®Âêå„Åò„Éú„Çø„É≥„ÇíÊäº„Åõ
    { id: 'werewolf', name: '„ÉØ„É≥„Éä„Ç§„Éà‰∫∫Áãº', icon: 'üê∫', type: 'werewolf' },
    { id: 'poll', name: 'Â§öÊï∞Ê±∫„Ç¢„É≥„Ç±„Éº„Éà', icon: 'üìä', type: 'poll' }
];

/* ==================== 3. „Çµ„Ç¶„É≥„Éâ„Ç®„É≥„Ç∏„É≥ („Ç∑„É≥„Çª„Çµ„Ç§„Ç∂„Éº) ==================== */
const AudioSys = {
    ctx: new (window.AudioContext || window.webkitAudioContext)(),
    play: (type) => {
        if(AudioSys.ctx.state === 'suspended') AudioSys.ctx.resume();
        const osc = AudioSys.ctx.createOscillator();
        const gain = AudioSys.ctx.createGain();
        const t = AudioSys.ctx.currentTime;
        osc.connect(gain); gain.connect(AudioSys.ctx.destination);

        if(type === 'bgm_start') { // „Éâ„É©„É†„É≠„Éº„É´È¢®
            osc.type = 'square'; osc.frequency.setValueAtTime(100, t);
            osc.frequency.linearRampToValueAtTime(800, t+2);
            gain.gain.setValueAtTime(0.1, t); gain.gain.linearRampToValueAtTime(0, t+2);
            osc.start(); osc.stop(t+2);
        } else if (type === 'win') { // „Éï„Ç°„É≥„Éï„Ç°„Éº„É¨
            [440, 554, 659, 880].forEach((f, i) => {
                const o = AudioSys.ctx.createOscillator();
                const g = AudioSys.ctx.createGain();
                o.type = 'triangle'; o.frequency.value = f;
                o.connect(g); g.connect(AudioSys.ctx.destination);
                g.gain.setValueAtTime(0.1, t + i*0.1);
                g.gain.exponentialRampToValueAtTime(0.001, t + i*0.1 + 0.5);
                o.start(t + i*0.1); o.stop(t + i*0.1 + 0.5);
            });
        } else if (type === 'lose') { // „Éñ„Ç∂„Éº
            osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, t);
            osc.frequency.linearRampToValueAtTime(100, t+0.5);
            gain.gain.setValueAtTime(0.2, t); gain.gain.linearRampToValueAtTime(0, t+0.5);
            osc.start(); osc.stop(t+0.5);
        } else if (type === 'bomb') { // ÁàÜÁô∫
            const bufferSize = AudioSys.ctx.sampleRate * 1; 
            const buffer = AudioSys.ctx.createBuffer(1, bufferSize, AudioSys.ctx.sampleRate);
            const data = buffer.getChannelData(0);
            for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;
            const noise = AudioSys.ctx.createBufferSource();
            noise.buffer = buffer;
            noise.connect(gain);
            gain.gain.setValueAtTime(0.5, t); gain.gain.exponentialRampToValueAtTime(0.001, t+1);
            noise.start();
        }
    }
};

/* ==================== 4. HOST LOGIC ==================== */
const Host = {
    peer: null, conns: {}, players: {}, 
    game: null, loop: null, 
    
    init: () => {
        document.getElementById('host-view').classList.remove('hidden');
        Host.peer = new Peer(Utils.id());
        Host.peer.on('open', id => {
            const url = `${location.href.split('?')[0]}?host=${id}`;
            new QRCode(document.getElementById("qrcode"), { text: url, width: 128, height: 128 });
        });
        Host.peer.on('connection', c => {
            c.on('open', () => {
                Host.conns[c.peer] = c;
                c.on('data', d => Host.handleData(c.peer, d));
                c.on('close', () => { delete Host.players[c.peer]; Host.updateCount(); });
            });
        });
        Host.renderMenu();
    },

    updateCount: () => document.getElementById('p-count').innerText = Object.keys(Host.players).length,

    renderMenu: () => {
        const grid = document.getElementById('game-list');
        grid.innerHTML = GAMES.map(g => 
            `<div class="game-card" onclick="Host.preGame('${g.id}')">
                <span class="icon">${g.icon}</span>${g.name}
            </div>`
        ).join('');
    },

    handleData: (id, d) => {
        if(d.act === 'join') {
            Host.players[id] = { name: d.name, score: 0, alive: true };
            Host.updateCount();
            AudioSys.play('win'); // Join sound
        }
        else if(Host.game) Host.gameInput(id, d);
    },

    toMenu: () => {
        Host.show('h-menu');
        Host.broadcast({act:'reset'});
    },

    preGame: (id) => {
        if(id === 'quiz') {
            Host.show('h-quiz-setup');
        } else {
            const g = GAMES.find(x => x.id === id);
            Host.launch(g);
        }
    },

    startQuiz: (mode) => {
        const g = GAMES.find(x => x.id === 'quiz');
        if(mode === 'random') {
            const q = QUIZ_DB[Math.floor(Math.random() * QUIZ_DB.length)];
            g.data = q;
        } else {
            g.data = {
                q: document.getElementById('q-text').value || "„ÉÜ„Çπ„ÉàÂïèÈ°å",
                a: [
                    document.getElementById('q-ans-correct').value || "Ê≠£Ëß£",
                    document.getElementById('q-ans-2').value || "„ÉÄ„Éü„Éº1",
                    document.getElementById('q-ans-3').value || "„ÉÄ„Éü„Éº2",
                    document.getElementById('q-ans-4').value || "„ÉÄ„Éü„Éº3"
                ]
            };
        }
        Host.launch(g);
    },

    startRandom: () => {
        const g = GAMES[Math.floor(Math.random() * GAMES.length)];
        if(g.id === 'quiz') Host.startQuiz('random');
        else Host.launch(g);
    },

    launch: (gameObj) => {
        Host.game = gameObj;
        Host.show('h-stage');
        document.getElementById('stage-title').innerText = gameObj.name;
        document.getElementById('stage-main').innerText = "READY?";
        document.getElementById('stage-sub').innerText = "";
        document.getElementById('h-quiz-setup').classList.add('hidden');
        
        // ÂÖ®Âì°„É™„Çª„ÉÉ„Éà
        Object.values(Host.players).forEach(p => { p.score=0; p.alive=true; });

        // „Ç≥„É≥„Éà„É≠„Éº„É©„ÉºÈÖçÂ∏É
        let payload = { act: 'init', type: gameObj.type };
        if(gameObj.type === 'quiz') {
            // „Ç∑„É£„ÉÉ„Éï„É´
            const choices = [...gameObj.data.a].sort(() => Math.random() - 0.5);
            payload.choices = choices;
            Host.quizAns = gameObj.data.a[0]; // Ê≠£Ëß£„Çí‰øùÊåÅ
        }
        Host.broadcast(payload);

        AudioSys.play('bgm_start');
        setTimeout(() => Host.runGame(), 2000);
    },

    runGame: () => {
        const g = Host.game;
        const main = document.getElementById('stage-main');
        const sub = document.getElementById('stage-sub');
        main.innerText = "START!";
        
        let time = 10;
        if(g.id === 'quiz') {
            main.innerHTML = `<div style="font-size:2rem; text-align:left;">${g.data.q}</div>`;
            time = 15;
        }
        if(g.id === 'bomb') {
            main.innerText = "üí£";
            time = 15 + Math.random()*15; // „É©„É≥„ÉÄ„É†ÊôÇÈñì
        }
        
        const maxTime = time;
        Host.loop = setInterval(() => {
            time -= 0.1;
            document.getElementById('timer-fill').style.width = (time/maxTime*100) + "%";

            // „É™„Ç¢„É´„Çø„Ç§„É†Êõ¥Êñ∞Á≥ª
            if(g.id === 'mash') {
                const top = Object.values(Host.players).sort((a,b)=>b.score-a.score)[0];
                if(top) sub.innerText = `${top.name}: ${top.score}`;
            }

            if(time <= 0) {
                clearInterval(Host.loop);
                Host.finish();
            }
        }, 100);
    },

    gameInput: (pid, d) => {
        const p = Host.players[pid];
        const g = Host.game;

        if(g.id === 'mash' && d.act === 'tap') {
            p.score++;
            // „Éê„Ç§„Éñ„É¨„Éº„Ç∑„Éß„É≥„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ
            if(p.score % 10 === 0) Host.conns[pid].send({act:'vib', p:[50]});
        }
        if(g.id === 'shake' && d.act === 'shake') p.score++;
        if(g.id === 'quiz' && d.act === 'ans') {
            if(d.val === Host.quizAns) {
                p.score = 100 + timeBonus(); // Êó©„ÅÑ„Åª„ÅÜ„ÅåÁÇπÈ´ò„ÅÑ
                AudioSys.play('win');
                main.innerText = `${p.name} Ê≠£Ëß£ÔºÅ`;
                clearInterval(Host.loop);
                setTimeout(Host.finish, 2000);
            } else {
                p.score = -10;
                Host.conns[pid].send({act:'vib', p:[200, 100, 200]}); // „Éñ„Éñ„ÉºÔºÅÊåØÂãï
            }
        }
        if(g.id === 'bomb' && d.act === 'shake') {
            // ÁàÜÂºæ„Çí‰ªñ„ÅÆ‰∫∫„Å´Áßª„Åô„É≠„Ç∏„ÉÉ„ÇØÔºàÁ∞°ÊòìÁöÑÔºâ
            Host.broadcast({act:'vib', p:[50]}); // ÂÖ®Âì°„Å´ÊåØÂãïÈÄöÁü•
        }
    },

    finish: () => {
        clearInterval(Host.loop);
        AudioSys.play('win');
        
        const g = Host.game;
        let winner = "NO ONE";
        const sorted = Object.values(Host.players).sort((a,b)=>b.score-a.score);
        
        if(g.id === 'bomb') {
            AudioSys.play('bomb');
            Host.broadcast({act:'vib', p:[1000]}); // Èï∑„ÅÑÊåØÂãï
            winner = "EXPLODED!";
        } else if(sorted.length > 0) {
            winner = sorted[0].name;
        }

        document.getElementById('res-winner').innerText = winner;
        Host.show('h-result');
        Host.broadcast({act:'end'});
    },

    broadcast: (d) => Object.values(Host.conns).forEach(c => c.send(d)),
    show: (id) => {
        document.querySelectorAll('.screen').forEach(e => e.classList.add('hidden'));
        document.querySelectorAll('.modal').forEach(e => e.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
    }
};

function timeBonus() { return Math.floor(parseFloat(document.getElementById('timer-fill').style.width)); }

/* ==================== 5. CLIENT LOGIC ==================== */
const Client = {
    peer: null, conn: null, 
    init: () => {
        const h = new URLSearchParams(location.search).get('host');
        if(h) {
            document.getElementById('client-view').classList.remove('hidden');
            Client.peer = new Peer();
            Client.peer.on('open', id => {
                Client.conn = Client.peer.connect(h);
                Client.conn.on('data', Client.handle);
            });
        } else {
            Host.init();
        }
    },

    join: () => {
        const n = document.getElementById('username').value || "Guest";
        Client.conn.send({act:'join', name:n});
        Client.show('c-wait');
        Client.initSensors();
    },

    handle: (d) => {
        if(d.act === 'init') Client.buildCtrl(d);
        if(d.act === 'reset' || d.act === 'end') Client.show('c-wait');
        if(d.act === 'vib') {
            // ‚òÖ„Éê„Ç§„Éñ„É¨„Éº„Ç∑„Éß„É≥ÂÆüË°å‚òÖ
            if(navigator.vibrate) navigator.vibrate(d.p);
        }
    },

    buildCtrl: (d) => {
        Client.show('c-ctrl');
        const area = document.getElementById('c-ctrl');
        area.innerHTML = '';

        if(d.type === 'tap') {
            area.innerHTML = `<button class="ctrl-btn c-red" onpointerdown="Client.send('tap')">ÈÄ£Êâì!!</button>`;
        }
        else if(d.type === 'shake' || d.type === 'pass') {
            area.innerHTML = `<div class="ctrl-btn c-blue" style="display:flex;align-items:center;justify-content:center">SHAKE!</div>`;
        }
        else if(d.type === 'quiz') {
            const colors = ['c-red', 'c-blue', 'c-green', 'c-yellow'];
            let html = `<div style="display:grid; grid-template-columns:1fr 1fr; height:100%">`;
            d.choices.forEach((c, i) => {
                html += `<button class="ctrl-btn ${colors[i]}" onclick="Client.send('ans', '${c}')">${c}</button>`;
            });
            html += `</div>`;
            area.innerHTML = html;
        }
        else if(d.type === 'swipe') {
            area.innerHTML = `<div class="ctrl-btn" style="background:#333;display:flex;align-items:center;justify-content:center">SWIPE!</div>`;
            // Á∞°Êòì„Éï„É™„ÉÉ„ÇØÊ§úÁü•ÂÆüË£Ö
        }
    },

    send: (act, val) => {
        Client.conn.send({act:act, val:val});
        if(act === 'tap') navigator.vibrate(30); // „Çø„ÉÉ„ÉóÊôÇ„ÅÆËß¶Ë¶ö„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ
    },

    initSensors: () => {
        // „Ç∑„Çß„Ç§„ÇØÊ§úÁü•
        let lx=0, ly=0, lz=0;
        window.addEventListener('devicemotion', e => {
            const a = e.accelerationIncludingGravity;
            if(!a) return;
            const d = Math.abs(a.x+a.y+a.z - lx-ly-lz);
            if(d > 20) {
                Client.send('shake');
                navigator.vibrate(50);
            }
            lx=a.x; ly=a.y; lz=a.z;
        });
    },

    show: (id) => {
        document.querySelectorAll('#client-view .screen').forEach(e => e.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
    }
};

const Utils = { id: () => Math.random().toString(36).substr(2, 5).toUpperCase() };
window.onload = Client.init;
</script>
</body>
</html>
