<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>大縄跳び大会 V5 - 役割分担編</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@700&family=Zen+Maru+Gothic:wght@700;900&display=swap');

        :root {
            --primary: #00f2ff;
            --secondary: #ff0055;
            --accent: #ffee00;
            --dark: #050505;
        }

        body { 
            font-family: 'Zen Maru Gothic', sans-serif; 
            margin: 0; background: var(--dark); color: white; 
            overflow: hidden; touch-action: none;
        }

        .full-screen { position: absolute; top:0; left:0; width: 100vw; height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .hidden { display: none !important; }

        /* --- 背景・ホスト画面 --- */
        .bg-vfx { position: fixed; top:0; left:0; width:100%; height:100%; z-index:-1; background: radial-gradient(circle at 50% 50%, #111 0%, #000 100%); }
        
        #top-ui {
            position: absolute; top: 0; width: 100%; height: 80px;
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 50px; box-sizing: border-box; background: rgba(0,0,0,0.9); border-bottom: 3px solid var(--primary);
        }

        #arena {
            display: flex; align-items: flex-end; justify-content: center;
            height: 50vh; width: 95%; gap: 15px; border-bottom: 5px solid #222;
            position: relative; margin-top: 50px;
        }

        .player-unit { display: flex; flex-direction: column; align-items: center; width: 100px; position: relative; }
        .role-tag { font-size: 10px; padding: 2px 5px; border-radius: 3px; margin-bottom: 5px; font-weight: bold; }
        .tag-turner { background: var(--secondary); color: white; }
        .tag-jumper { background: var(--primary); color: black; }

        .bar { width: 35px; background: linear-gradient(to top, var(--primary), #fff); transition: 0.1s; border-radius: 5px 5px 0 0; }
        .char-icon { width: 40px; height: 50px; background: #fff; border-radius: 5px; position: relative; transition: 0.1s; }
        .turn-icon { width: 40px; height: 40px; border: 4px dashed var(--accent); border-radius: 50%; animation: spin 1s infinite linear; }

        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        /* --- 大縄ビジュアル --- */
        #long-rope {
            position: absolute; width: 100%; height: 150%;
            border: 10px solid var(--accent); border-radius: 50%;
            top: -75%; left: 0; transform-origin: center;
            display: none; pointer-events: none; opacity: 0.3;
        }
        .rope-active { display: block !important; animation: rope-anim 1s infinite linear; }
        @keyframes rope-anim { from { transform: rotateX(0deg); } to { transform: rotateX(360deg); } }

        .panel { background: rgba(255,255,255,0.05); padding: 25px; border-radius: 15px; text-align: center; backdrop-filter: blur(10px); }
        .btn-main { background: var(--secondary); border: none; color: white; padding: 15px 45px; font-size: 26px; cursor: pointer; border-radius: 50px; font-weight: 900; box-shadow: 0 0 20px var(--secondary); }
        .btn-main:disabled { opacity: 0.3; }

        /* --- コントローラー --- */
        #action-box {
            width: 280px; height: 280px; border-radius: 20px; border: 5px solid var(--primary);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: rgba(255,255,255,0.05);
        }
        .count-num { font-family: 'Rajdhani'; font-size: 100px; font-weight: 700; line-height: 1; margin: 10px 0; }
        .instr { font-size: 18px; color: var(--accent); font-weight: bold; padding: 10px; }

        #news-bar { position: absolute; bottom: 0; width: 100%; background: var(--secondary); color: white; padding: 10px 0; overflow: hidden; font-weight: bold; }
        .news-txt { display: inline-block; white-space: nowrap; animation: scroll 15s linear infinite; }
        @keyframes scroll { from { transform: translateX(100%); } to { transform: translateX(-100%); } }
    </style>
</head>
<body>
    <div class="bg-vfx"></div>

    <!-- ホスト画面 -->
    <div id="host-view" class="full-screen hidden">
        <div id="top-ui">
            <div style="font-size: 20px; color: var(--accent);">最高点: <span id="wr-val">0</span></div>
            <div id="main-timer" style="font-family: 'Rajdhani'; font-size: 60px;">00:00</div>
            <div id="mode-label" style="color: var(--primary);">種目：大縄跳び</div>
        </div>

        <div id="lobby-ui" class="panel">
            <h1 style="margin:0 0 10px 0;">大縄跳び大会 V5</h1>
            <p>ジャンパーはスマホをポケットに、<br>まわし手はスマホを手に持って回そう！</p>
            <div id="qrcode" style="background:white; padding:10px; display:inline-block; margin:20px; border-radius:10px;"></div>
            <div>
                <button id="start-btn" class="btn-main" onclick="hostStart()" disabled>試合開始</button>
            </div>
            <p id="player-count" style="margin-top:20px; color:var(--primary); font-weight:bold;">参加者を待機中...</p>
        </div>

        <div id="arena" class="hidden">
            <div id="long-rope"></div>
        </div>

        <div id="news-bar"><div class="news-txt">役割は開始時にランダムで決まるぞ！ジャンパーはジャンプ、まわし手は大きく円を描け！</div></div>
        <div id="overlay" style="position:absolute; font-size:12vw; font-weight:900; opacity:0; transition:0.2s; z-index:100; text-shadow: 0 0 30px #000;"></div>
    </div>

    <!-- コントローラー画面 -->
    <div id="ctrl-view" class="full-screen hidden">
        <div id="ctrl-login" class="panel" style="width:85%;">
            <h2>選手エントリー</h2>
            <input type="text" id="p-name" placeholder="名前" maxlength="8" style="padding:15px; width:80%; font-size:20px; text-align:center; border-radius:10px; border:none; margin:20px 0;">
            <button class="btn-main" onclick="ctrlJoin()">エントリー</button>
        </div>

        <div id="ctrl-game" class="hidden" style="text-align:center;">
            <div id="instr-box" class="instr">準備中...</div>
            <div id="action-box">
                <div style="color:#aaa;">カウント</div>
                <div id="my-count" class="count-num">0</div>
                <div id="role-display" style="font-size:14px; border:1px solid #555; padding:5px 10px; border-radius:50px;">待機中</div>
            </div>
            <p id="ctrl-status" style="margin-top:20px; font-weight:bold;">開始まで動かないでね</p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
        import { getDatabase, ref, set, onValue, update, onDisconnect, runTransaction } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDbZzTMvUkG2LXIGY4ux0KBTmnAdqP236s",
            authDomain: "game-4f2d9.firebaseapp.com",
            databaseURL: "https://game-4f2d9-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "game-4f2d9",
            storageBucket: "game-4f2d9.firebasestorage.app",
            messagingSenderId: "574316347824",
            appId: "1:574316347824:web:cf686040628e25ad615675"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const audio = new (window.AudioContext || window.webkitAudioContext)();
        function sfx(f, t, d) {
            const o = audio.createOscillator(); const g = audio.createGain();
            o.type = t; o.frequency.value = f; g.gain.setValueAtTime(0.1, audio.currentTime);
            g.gain.exponentialRampToValueAtTime(0.01, audio.currentTime+d);
            o.connect(g); g.connect(audio.destination); o.start(); o.stop(audio.currentTime+d);
        }

        const params = new URLSearchParams(window.location.search);
        const role = params.get('role') || 'host';
        const roomId = params.get('room');
        const myId = Math.random().toString(36).substr(2, 6).toUpperCase();

        if (role === 'host') {
            if (!roomId) window.location.replace(`?role=host&room=${Math.random().toString(36).substr(2,4).toUpperCase()}`);
            document.getElementById('host-view').classList.remove('hidden');
            new QRCode(document.getElementById("qrcode"), { text: `${window.location.origin}${window.location.pathname}?role=ctrl&room=${roomId}`, width: 140, height: 140 });

            const stateRef = ref(db, `v5/${roomId}/state`);
            const playersRef = ref(db, `v5/${roomId}/players`);

            onValue(playersRef, snap => {
                const players = snap.val() || {};
                document.getElementById('player-count').innerText = `現在 ${Object.keys(players).length} 名が参加中`;
                document.getElementById('start-btn').disabled = Object.keys(players).length === 0;
                renderArena(players);
            });

            function renderArena(players) {
                const arena = document.getElementById('arena');
                const isRunning = arena.getAttribute('data-run') === 'true';
                
                Object.keys(players).forEach(id => {
                    let el = document.getElementById(`p-${id}`);
                    if (!el) {
                        el = document.createElement('div'); el.id = `p-${id}`; el.className = 'player-unit';
                        el.innerHTML = `<div class="p-score" style="font-weight:bold;">0</div>
                                       <div class="role-tag">---</div>
                                       <div class="icon-area"></div>
                                       <div style="font-size:12px; color:#aaa;">${players[id].name}</div>`;
                        arena.appendChild(el);
                    }
                    const p = players[id];
                    const scoreText = el.querySelector('.p-score');
                    const roleTag = el.querySelector('.role-tag');
                    const iconArea = el.querySelector('.icon-area');

                    if (p.count > (parseInt(scoreText.innerText) || 0)) sfx(500, 'sine', 0.05);
                    scoreText.innerText = isRunning ? "???" : (p.count || 0);
                    
                    if (p.role === 'turner') {
                        roleTag.innerText = "まわし手"; roleTag.className = "role-tag tag-turner";
                        iconArea.innerHTML = '<div class="turn-icon"></div>';
                    } else if (p.role === 'jumper') {
                        roleTag.innerText = "ジャンパー"; roleTag.className = "role-tag tag-jumper";
                        iconArea.innerHTML = '<div class="char-icon"></div>';
                        const char = iconArea.querySelector('.char-icon');
                        if (p.count > (parseInt(scoreText.innerText) || 0)) {
                            char.style.transform = 'translateY(-30px)';
                            setTimeout(() => char.style.transform = 'translateY(0)', 150);
                        }
                    }
                });
            }

            window.hostStart = () => {
                document.getElementById('lobby-ui').classList.add('hidden');
                document.getElementById('arena').classList.remove('hidden');
                
                // 役割をランダムに割り振ってスコアリセット
                onValue(playersRef, snap => {
                    const players = snap.val() || {};
                    const ids = Object.keys(players);
                    // シャッフル
                    for (let i = ids.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [ids[i], ids[j]] = [ids[j], ids[i]];
                    }
                    
                    const updates = {};
                    ids.forEach((id, index) => {
                        // 最初の2人（人数が少なければ1人）をまわし手に、残りをジャンパーに
                        const assignedRole = (index < Math.min(2, ids.length)) ? 'turner' : 'jumper';
                        updates[id + '/role'] = assignedRole;
                        updates[id + '/count'] = 0;
                    });
                    update(playersRef, updates);
                }, {onlyOnce: true});

                let count = 3;
                const ov = document.getElementById('overlay'); ov.style.opacity = 1;
                const cd = setInterval(() => {
                    if (count > 0) { sfx(800, 'sine', 0.1); ov.innerText = count; }
                    else {
                        clearInterval(cd); sfx(400, 'square', 0.4); ov.innerText = "スタート！";
                        setTimeout(() => ov.style.opacity = 0, 1000);
                        startMatch();
                    }
                    count--;
                }, 1000);
            };

            function startMatch() {
                document.getElementById('arena').setAttribute('data-run', 'true');
                document.getElementById('long-rope').classList.add('rope-active');
                update(stateRef, { status: 'running' });
                let time = 15;
                const timer = setInterval(() => {
                    time--;
                    document.getElementById('main-timer').innerText = `00:${time < 10 ? '0'+time : time}`;
                    if (time <= 0) { clearInterval(timer); finishMatch(); }
                }, 1000);
            }

            function finishMatch() {
                update(stateRef, { status: 'finished' });
                document.getElementById('long-rope').classList.remove('rope-active');
                document.getElementById('arena').setAttribute('data-run', 'false');
                document.getElementById('overlay').innerText = "終了！";
                document.getElementById('overlay').style.opacity = 1;
                setTimeout(() => location.reload(), 10000);
            }
        } 
        
        // --- コントローラー ---
        else {
            document.getElementById('ctrl-view').classList.remove('hidden');
            let status = 'lobby', count = 0, myRole = '';

            window.ctrlJoin = () => {
                const n = document.getElementById('p-name').value;
                if(!n) return alert("名前を入力してください");
                if(typeof DeviceMotionEvent.requestPermission === 'function') {
                    DeviceMotionEvent.requestPermission().then(r => { if(r==='granted') init(n); });
                } else init(n);
            };

            function init(name) {
                document.getElementById('ctrl-login').classList.add('hidden');
                document.getElementById('ctrl-game').classList.remove('hidden');
                const pRef = ref(db, `v5/${roomId}/players/${myId}`);
                set(pRef, { name: name, count: 0, role: 'waiting' });
                onDisconnect(pRef).remove();

                onValue(ref(db, `v5/${roomId}/state`), s => { status = (s.val() || {}).status; });
                onValue(pRef, snap => {
                    const data = snap.val(); if(!data) return;
                    myRole = data.role;
                    const instr = document.getElementById('instr-box');
                    const roleDisp = document.getElementById('role-display');
                    
                    if (myRole === 'turner') {
                        instr.innerText = "【まわし手】\nスマホを手に持って回せ！";
                        roleDisp.innerText = "役割：まわし手";
                        roleDisp.style.background = "var(--secondary)";
                    } else if (myRole === 'jumper') {
                        instr.innerText = "【ジャンパー】\nポケットに入れて跳べ！";
                        roleDisp.innerText = "役割：ジャンパー";
                        roleDisp.style.background = "var(--primary)"; roleDisp.style.color = "black";
                    }
                    if(status === 'running') {
                        document.getElementById('ctrl-status').innerText = "競技中！！";
                    } else {
                        count = 0; document.getElementById('my-count').innerText = 0;
                    }
                });

                let lastX=0, lastY=0, lastZ=0, lastTime=0;
                window.addEventListener('devicemotion', e => {
                    if (status !== 'running') return;
                    const acc = e.accelerationIncludingGravity;
                    const now = Date.now();

                    if (myRole === 'turner') {
                        const d = Math.abs(acc.x - lastX) + Math.abs(acc.y - lastY);
                        if (d > 18 && now - lastTime > 150) trigger();
                    } else if (myRole === 'jumper') {
                        // ポケットの中での上下（Y軸）の動きを検知
                        // 15 以上の加速度変化で1ジャンプとする
                        if (Math.abs(acc.y - lastY) > 15 && now - lastTime > 350) trigger();
                    }
                    lastX=acc.x; lastY=acc.y; lastZ=acc.z;
                });

                function trigger() {
                    count++; lastTime = Date.now();
                    document.getElementById('my-count').innerText = count;
                    update(pRef, { count: count });
                }
            }
        }
    </script>
</body>
</html>
