<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <!-- 1. Metaã‚¿ã‚°ã«ã‚ˆã‚‹ã‚ºãƒ¼ãƒ ç¦æ­¢ (user-scalable=no) -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no">
    <title>SHAKE PARTY 2.0 (No Zoom)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Bangers&family=M+PLUS+Rounded+1c:wght@800&display=swap');

        /* 2. CSSã«ã‚ˆã‚‹ã‚¿ãƒƒãƒæ“ä½œã®åˆ¶é™ */
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden; /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç¦æ­¢ */
            background: #1a1a1a;
            font-family: 'M PLUS Rounded 1c', sans-serif;
            color: white;
            
            /* é‡è¦: ãƒ–ãƒ©ã‚¦ã‚¶ã®æ¨™æº–ã‚¿ãƒƒãƒå‹•ä½œï¼ˆã‚ºãƒ¼ãƒ ã€ãƒ‘ãƒ³ï¼‰ã‚’ç„¡åŠ¹åŒ– */
            touch-action: none; 
            
            /* ãƒ†ã‚­ã‚¹ãƒˆé¸æŠç¦æ­¢ï¼ˆé€£æ‰“æ™‚ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆé˜²æ­¢ï¼‰ */
            user-select: none;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
        }

        .hidden { display: none !important; }
        .full-screen { width: 100vw; height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; position: absolute; top: 0; left: 0; }
        
        /* --- HOST DESIGN --- */
        #host-view { background: radial-gradient(circle at center, #2c3e50, #000); }
        h1 { font-family: 'Bangers', cursive; font-size: 50px; color: #f1c40f; text-shadow: 4px 4px 0 #e67e22; margin: 10px 0; pointer-events: none; }
        
        /* Menu */
        #menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 10px; }
        .menu-card { width: 180px; padding: 15px; background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.2); border-radius: 15px; cursor: pointer; text-align: center; transition: 0.2s; }
        .menu-card:hover { transform: scale(1.05); background: rgba(255,255,255,0.25); border-color: #f1c40f; }
        .card-icon { font-size: 40px; display: block; margin-bottom: 5px; }
        .card-title { font-size: 18px; font-weight: bold; color: #f1c40f; }
        .card-desc { font-size: 12px; color: #ccc; }

        /* Player List */
        #player-list { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-top: 20px; max-width: 90%; }
        .player-tag { background: #34495e; padding: 5px 15px; border-radius: 20px; font-size: 14px; border: 1px solid #7f8c8d; animation: popIn 0.3s; }
        @keyframes popIn { from { transform: scale(0); } to { transform: scale(1); } }

        /* Game Areas */
        #game-area { width: 90%; height: 60%; position: relative; background: rgba(0,0,0,0.5); border-radius: 20px; margin-top: 20px; overflow: hidden; border: 2px solid #555; display: none; }
        #back-btn { position: absolute; top: 10px; right: 10px; z-index: 100; padding: 5px 10px; background: #555; color: white; border: none; cursor: pointer; border-radius: 5px; }

        /* 1. Race */
        #race-track { width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: space-evenly; position: relative; }
        .racer { position: absolute; left: 10px; transition: left 0.1s linear; display: flex; align-items: center; }
        .racer-icon { font-size: 30px; margin-right: 5px; }
        .racer-name { font-size: 12px; position: absolute; top: -15px; left: 0; white-space: nowrap; }

        /* 2. Tug */
        #tug-field { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; position: relative; }
        .team-bg { position: absolute; width: 50%; height: 100%; top: 0; opacity: 0.2; font-size: 100px; display: flex; align-items: center; justify-content: center; font-family: 'Bangers'; }
        #team-red-bg { left: 0; background: red; color: #ffadad; }
        #team-blue-bg { right: 0; background: blue; color: #adadff; }
        #tug-rope { width: 80%; height: 10px; background: white; position: relative; border-radius: 5px; }
        #tug-marker { width: 40px; height: 40px; background: #f1c40f; border-radius: 50%; position: absolute; top: -15px; left: 50%; transform: translateX(-50%); transition: left 0.1s; box-shadow: 0 0 15px yellow; }

        /* 3. Boss */
        #boss-field { width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        #boss-char { font-size: 120px; animation: float 2s infinite ease-in-out; filter: drop-shadow(0 0 20px purple); }
        #boss-hp-bar { width: 60%; height: 30px; background: #333; border-radius: 15px; overflow: hidden; border: 2px solid white; margin-top: 20px; }
        #boss-hp-fill { width: 100%; height: 100%; background: #e74c3c; transition: width 0.2s; }
        @keyframes float { 0%,100%{transform:translateY(0);} 50%{transform:translateY(-20px);} }

        /* 4. Soda */
        #soda-field { width: 100%; height: 100%; display: flex; align-items: flex-end; justify-content: space-around; padding-bottom: 20px; box-sizing: border-box; }
        .bottle-col { display: flex; flex-direction: column; align-items: center; position: relative; height: 100%; justify-content: flex-end; width: 60px; }
        .cork { font-size: 20px; transition: bottom 0.2s; position: absolute; bottom: 60px; }
        .bottle-body { width: 40px; height: 60px; background: #fff; border-radius: 5px 5px 0 0; position: relative; overflow: hidden; }
        .bottle-liquid { position: absolute; bottom: 0; width: 100%; background: #e67e22; height: 0%; transition: height 0.1s; }

        /* --- CONTROLLER DESIGN --- */
        #ctrl-view { background: linear-gradient(135deg, #2b5876 0%, #4e4376 100%); text-align: center; }
        
        #name-input-ui { background: rgba(0,0,0,0.6); padding: 30px; border-radius: 20px; width: 80%; max-width: 300px; }
        input { width: 90%; padding: 10px; font-size: 18px; margin-bottom: 20px; border-radius: 5px; border: none; text-align: center; }
        .btn-go { width: 100%; padding: 15px; background: #2ecc71; border: none; color: white; font-weight: bold; font-size: 20px; border-radius: 10px; }
        .btn-go:active { background: #27ae60; transform: scale(0.98); }

        #game-ui { display: none; width: 100%; height: 100%; flex-direction: column; align-items: center; justify-content: center; }
        #shake-btn { width: 220px; height: 220px; border-radius: 50%; background: #e74c3c; display: flex; align-items: center; justify-content: center; font-size: 40px; font-family: 'Bangers'; border: 8px solid rgba(255,255,255,0.3); box-shadow: 0 10px 0 #c0392b; margin-bottom: 20px; }
        .shaking { animation: shrink 0.1s; }
        @keyframes shrink { 0%{transform:scale(1);} 50%{transform:scale(0.95);} 100%{transform:scale(1);} }
        
        #team-badge { font-size: 20px; padding: 5px 15px; border-radius: 5px; margin-bottom: 20px; display: inline-block; font-weight: bold; }
        #info-text { font-size: 18px; color: #bdc3c7; padding: 0 20px; pointer-events: none; }
    </style>
</head>
<body>

    <!-- HOST UI -->
    <div id="host-view" class="full-screen hidden">
        <h1>SHAKE PARTY 2.0</h1>
        
        <div id="lobby-menu">
            <div id="qrcode" style="background: white; padding: 10px; border-radius: 10px; display: inline-block;"></div>
            <p style="margin: 5px 0;">ã‚¹ãƒãƒ›ã§å‚åŠ ã—ã¦åå‰ã‚’å…¥åŠ›ï¼</p>
            
            <div id="menu-grid">
                <div class="menu-card" onclick="setMode('race')">
                    <span class="card-icon">ğŸš€</span>
                    <div class="card-title">SPACE RACE</div>
                    <div class="card-desc">å€‹äººæˆ¦ï¼šæœ€é€Ÿã‚’ç›®æŒ‡ã›</div>
                </div>
                <div class="menu-card" onclick="setMode('tug')">
                    <span class="card-icon">âš”ï¸</span>
                    <div class="card-title">TUG OF WAR</div>
                    <div class="card-desc">ãƒãƒ¼ãƒ æˆ¦ï¼šç¶±å¼•ã</div>
                </div>
                <div class="menu-card" onclick="setMode('boss')">
                    <span class="card-icon">ğŸ‘¹</span>
                    <div class="card-title">BOSS RAID</div>
                    <div class="card-desc">å”åŠ›æˆ¦ï¼šé­”ç‹è¨ä¼</div>
                </div>
                <div class="menu-card" onclick="setMode('soda')">
                    <span class="card-icon">ğŸ¾</span>
                    <div class="card-title">SODA POP</div>
                    <div class="card-desc">ãƒãƒ©ã‚¨ãƒ†ã‚£ï¼šç‚­é…¸å™´å°„</div>
                </div>
            </div>
        </div>

        <div id="game-area">
            <button id="back-btn" onclick="resetToLobby()">MENU</button>
            
            <!-- 1. Race -->
            <div id="race-track" class="hidden"></div>
            
            <!-- 2. Tug -->
            <div id="tug-field" class="hidden">
                <div id="team-red-bg" class="team-bg">RED</div>
                <div id="team-blue-bg" class="team-bg">BLUE</div>
                <div id="tug-rope"><div id="tug-marker"></div></div>
            </div>

            <!-- 3. Boss -->
            <div id="boss-field" class="hidden">
                <div id="boss-char">ğŸ‘¿</div>
                <div id="boss-hp-bar"><div id="boss-hp-fill"></div></div>
                <h2 id="boss-msg" style="margin-top: 20px;">ATTACK!!</h2>
            </div>

            <!-- 4. Soda -->
            <div id="soda-field" class="hidden"></div>
        </div>

        <div id="player-list"></div>
    </div>

    <!-- CONTROLLER UI -->
    <div id="ctrl-view" class="full-screen hidden">
        <!-- Name Input -->
        <div id="name-input-ui">
            <h2>ENTER NAME</h2>
            <input type="text" id="p-name" placeholder="åå‰ã‚’å…¥åŠ› (ä¾‹: TARO)" maxlength="6">
            <button class="btn-go" id="join-btn">å‚åŠ ã™ã‚‹ï¼</button>
        </div>

        <!-- Game Interface -->
        <div id="game-ui">
            <div id="team-badge" class="hidden">TEAM RED</div>
            <div id="shake-btn">SHAKE!</div>
            <p id="info-text">æº–å‚™å®Œäº†ï¼<br>ãƒ›ã‚¹ãƒˆãŒã‚²ãƒ¼ãƒ ã‚’é¸ã¶ã®ã‚’å¾…ã£ã¦ã­</p>
        </div>
    </div>

    <!-- 3. JavaScriptã«ã‚ˆã‚‹ã‚ºãƒ¼ãƒ ç¦æ­¢ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
    <script>
        // iOS 10ä»¥é™ãªã©ã®Safariã§ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—æ‹¡å¤§ã‚’é˜²ã
        document.addEventListener('gesturestart', function (e) {
            e.preventDefault();
        });

        // ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—æ“ä½œè‡ªä½“ã‚’ç„¡åŠ¹åŒ–ï¼ˆç›´è¿‘ã®ã‚¿ãƒƒãƒ—ã‹ã‚‰300msä»¥å†…ãªã‚‰ç„¡åŠ¹ï¼‰
        let lastTouchEnd = 0;
        document.addEventListener('touchend', function (event) {
            const now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, false);

        // PCï¼šCtrlã‚­ãƒ¼ï¼‹ãƒ›ã‚¤ãƒ¼ãƒ«ã§ã®æ‹¡å¤§ç¦æ­¢
        document.addEventListener('wheel', function(e) {
            if (e.ctrlKey) {
                e.preventDefault();
            }
        }, { passive: false });

        // PCï¼šã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã§ã®æ‹¡å¤§ç¦æ­¢ (Ctrl + +, -, 0)
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && (e.key === '+' || e.key === '-' || e.key === '0')) {
                e.preventDefault();
            }
        });
    </script>

    <!-- Firebase Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
        import { getDatabase, ref, set, onValue, update, onDisconnect, remove } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDbZzTMvUkG2LXIGY4ux0KBTmnAdqP236s",
            authDomain: "game-4f2d9.firebaseapp.com",
            databaseURL: "https://game-4f2d9-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "game-4f2d9",
            storageBucket: "game-4f2d9.firebasestorage.app",
            messagingSenderId: "574316347824",
            appId: "1:574316347824:web:cf686040628e25ad615675",
            measurementId: "G-T0ZKQCC9L3"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        
        // URL Params
        const params = new URLSearchParams(window.location.search);
        let role = params.get('role') || 'host';
        let roomId = params.get('room');
        const myId = Math.random().toString(36).substr(2, 6);

        // ============================================
        // HOST LOGIC
        // ============================================
        if (role === 'host') {
            if (!roomId) {
                roomId = Math.random().toString(36).substring(2, 6).toUpperCase();
                window.location.href = `?role=host&room=${roomId}`;
            }

            document.getElementById('host-view').classList.remove('hidden');
            
            // QR Generate
            new QRCode(document.getElementById("qrcode"), {
                text: `${window.location.origin}${window.location.pathname}?role=ctrl&room=${roomId}`,
                width: 120, height: 120
            });

            // State
            let players = {};
            let mode = 'lobby';

            const roomRef = ref(db, `rooms/${roomId}`);
            
            // Initial reset
            update(roomRef, { mode: 'lobby', bossHp: 1000, tugPos: 50 });

            // Player Listener
            onValue(ref(db, `rooms/${roomId}/players`), (snap) => {
                players = snap.val() || {};
                renderPlayerList();
                if(mode !== 'lobby') updateGameView();
            });

            // Render Lobby List
            function renderPlayerList() {
                const list = document.getElementById('player-list');
                list.innerHTML = Object.values(players).map(p => 
                    `<div class="player-tag" style="border-color:${p.color}">${p.name}</div>`
                ).join('');
            }

            // Mode Switching
            window.setMode = (m) => {
                mode = m;
                document.getElementById('lobby-menu').style.display = 'none';
                document.getElementById('player-list').style.display = 'none';
                document.getElementById('game-area').style.display = 'block';
                
                // Reset Scores & Teams
                const updates = { mode: m };
                let idx = 0;
                Object.keys(players).forEach(id => {
                    updates[`players/${id}/score`] = 0;
                    updates[`players/${id}/team`] = (idx % 2 === 0) ? 'red' : 'blue';
                    idx++;
                });
                
                if(m === 'boss') updates.bossHp = 1000;
                if(m === 'tug') updates.tugPos = 50;
                
                update(roomRef, updates);
                
                // Show Correct UI
                document.querySelectorAll('#game-area > div').forEach(el => {
                    if(el.id !== 'back-btn') el.classList.add('hidden');
                });
                
                if(m === 'race') {
                    document.getElementById('race-track').classList.remove('hidden');
                    renderRaceTrack();
                } else if(m === 'tug') {
                    document.getElementById('tug-field').classList.remove('hidden');
                } else if(m === 'boss') {
                    document.getElementById('boss-field').classList.remove('hidden');
                } else if(m === 'soda') {
                    document.getElementById('soda-field').classList.remove('hidden');
                    renderSodaField();
                }
            };

            // Back to Lobby
            window.resetToLobby = () => {
                mode = 'lobby';
                update(roomRef, { mode: 'lobby' });
                document.getElementById('lobby-menu').style.display = 'block';
                document.getElementById('player-list').style.display = 'flex';
                document.getElementById('game-area').style.display = 'none';
            };

            // Game Loop / Updates
            function updateGameView() {
                // 1. Race
                if(mode === 'race') {
                    Object.keys(players).forEach(id => {
                        const p = players[id];
                        const el = document.getElementById(`racer-${id}`);
                        if(el) {
                            let left = Math.min((p.score || 0) * 0.8, 90);
                            el.style.left = left + '%';
                        }
                    });
                }
                
                // 2. Tug
                else if(mode === 'tug') {
                    let red = 0, blue = 0;
                    Object.values(players).forEach(p => {
                        if(p.team === 'red') red += (p.score || 0);
                        else blue += (p.score || 0);
                    });
                    
                    let diff = blue - red; 
                    let pos = 50 + (diff * 0.5);
                    pos = Math.max(0, Math.min(100, pos));
                    
                    document.getElementById('tug-marker').style.left = pos + '%';
                }

                // 3. Boss
                else if(mode === 'boss') {
                    let totalDmg = 0;
                    Object.values(players).forEach(p => totalDmg += (p.score || 0));
                    let currentHp = 1000 - totalDmg;
                    if(currentHp < 0) currentHp = 0;
                    
                    document.getElementById('boss-hp-fill').style.width = (currentHp / 10) + '%';
                    if(currentHp === 0) document.getElementById('boss-msg').innerText = "VICTORY!!";
                    else document.getElementById('boss-msg').innerText = `HP: ${currentHp}`;
                }

                // 4. Soda
                else if(mode === 'soda') {
                    Object.keys(players).forEach(id => {
                        const p = players[id];
                        const liq = document.getElementById(`soda-liq-${id}`);
                        const cork = document.getElementById(`soda-cork-${id}`);
                        if(liq && cork) {
                            let h = Math.min(p.score || 0, 100);
                            liq.style.height = h + '%';
                            if(h >= 100) cork.style.bottom = '400px'; 
                        }
                    });
                }
            }

            // Init Helpers
            function renderRaceTrack() {
                const c = document.getElementById('race-track');
                c.innerHTML = Object.keys(players).map(id => `
                    <div id="racer-${id}" class="racer" style="top:${Math.random()*80}%">
                        <span class="racer-icon">ğŸš€</span>
                        <span class="racer-name">${players[id].name}</span>
                    </div>
                `).join('');
            }
            
            function renderSodaField() {
                const c = document.getElementById('soda-field');
                c.innerHTML = Object.keys(players).map(id => `
                    <div class="bottle-col">
                        <div id="soda-cork-${id}" class="cork">ğŸ“¦</div>
                        <div class="bottle-body">
                            <div id="soda-liq-${id}" class="bottle-liquid" style="background:${players[id].color}"></div>
                        </div>
                        <span style="font-size:12px; margin-top:5px; white-space:nowrap;">${players[id].name}</span>
                    </div>
                `).join('');
            }
        }

        // ============================================
        // CONTROLLER LOGIC
        // ============================================
        else {
            document.getElementById('ctrl-view').classList.remove('hidden');
            const playerRef = ref(db, `rooms/${roomId}/players/${myId}`);
            
            // Join
            document.getElementById('join-btn').addEventListener('click', () => {
                const name = document.getElementById('p-name').value || "NO NAME";
                const color = `hsl(${Math.random()*360}, 70%, 50%)`;
                
                set(playerRef, {
                    name: name,
                    color: color,
                    score: 0
                }).then(() => {
                    document.getElementById('name-input-ui').style.display = 'none';
                    document.getElementById('game-ui').style.display = 'flex';
                    requestPermission();
                });
                
                onDisconnect(playerRef).remove();
            });

            // Permission
            async function requestPermission() {
                if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
                    await DeviceMotionEvent.requestPermission();
                }
                startGameLoop();
            }

            // Sensor Logic
            let myScore = 0;
            let currentMode = 'lobby';
            let myTeam = '';

            // Listen to Mode & Team
            onValue(ref(db, `rooms/${roomId}`), (snap) => {
                const data = snap.val();
                if(!data) return;
                
                // Reset score on mode change
                if(data.mode !== currentMode) {
                    currentMode = data.mode;
                    myScore = 0;
                    updateInfoText(data.mode);
                    
                    if(data.mode === 'tug') {
                        // Wait a bit for team assignment to propagate
                        setTimeout(() => {
                            onValue(playerRef, (pSnap) => {
                                const p = pSnap.val();
                                if(p && p.team) {
                                    myTeam = p.team;
                                    const badge = document.getElementById('team-badge');
                                    badge.classList.remove('hidden');
                                    badge.innerText = `TEAM ${myTeam.toUpperCase()}`;
                                    badge.style.background = myTeam;
                                    badge.style.color = 'white';
                                }
                            }, {onlyOnce: true});
                        }, 500);
                    } else {
                        document.getElementById('team-badge').classList.add('hidden');
                    }
                }
            });

            function updateInfoText(m) {
                const t = document.getElementById('info-text');
                if(m === 'lobby') t.innerText = "ãƒ›ã‚¹ãƒˆãŒã‚²ãƒ¼ãƒ ã‚’é¸ã‚“ã§ã„ã¾ã™...";
                else if(m === 'race') t.innerText = "æŒ¯ã£ã¦åŠ é€Ÿã—ã‚ï¼";
                else if(m === 'tug') t.innerText = "ãƒãƒ¼ãƒ ã®ãŸã‚ã«æŒ¯ã‚Œï¼";
                else if(m === 'boss') t.innerText = "å…¨å“¡ã§æ”»æ’ƒã ï¼";
                else if(m === 'soda') t.innerText = "æŒ¯ã£ã¦é£›ã°ã›ï¼";
            }

            // Shake Detection
            function startGameLoop() {
                let lastX=0, lastY=0, lastZ=0;
                let lastUpdate = 0;
                const THRESHOLD = 15;

                window.addEventListener('devicemotion', (e) => {
                    if(currentMode === 'lobby') return;

                    const acc = e.accelerationIncludingGravity || e.acceleration;
                    if(!acc) return;
                    
                    const delta = Math.abs(acc.x - lastX) + Math.abs(acc.y - lastY) + Math.abs(acc.z - lastZ);
                    
                    if(delta > THRESHOLD) {
                        myScore++;
                        
                        // Visual Feedback
                        const btn = document.getElementById('shake-btn');
                        btn.classList.remove('shaking');
                        void btn.offsetWidth; // trigger reflow
                        btn.classList.add('shaking');
                        
                        // Throttle Updates (100ms)
                        const now = Date.now();
                        if(now - lastUpdate > 100) {
                            update(playerRef, { score: myScore });
                            lastUpdate = now;
                        }
                    }
                    
                    lastX = acc.x; lastY = acc.y; lastZ = acc.z;
                });
            }
        }
    </script>
</body>
</html>
