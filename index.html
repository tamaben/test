<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PARTY BOX: FIREBASE</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Black+Ops+One&family=Zen+Kaku+Gothic+New:wght@500;900&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #0f0f1a; --neon: #00f2ff; --pink: #ff0055; --yellow: #ffcc00; }
        body { margin: 0; background: var(--bg); color: white; font-family: 'Zen Kaku Gothic New', sans-serif; overflow: hidden; height: 100vh; }
        
        .screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; background: radial-gradient(circle, #222 0%, #000 100%); transition: opacity 0.3s; z-index: 10; }
        .hidden { opacity: 0; pointer-events: none; z-index: -1; }
        
        h1 { font-family: 'Black Ops One', cursive; font-size: 2.5rem; color: var(--neon); text-shadow: 0 0 15px var(--neon); margin: 0; text-align: center; }
        .btn { background: rgba(255,255,255,0.1); border: 2px solid var(--neon); color: var(--neon); padding: 15px 30px; font-size: 1.2rem; font-weight: bold; margin: 10px; cursor: pointer; border-radius: 50px; text-transform: uppercase; transition: 0.2s; }
        .btn:active { transform: scale(0.95); background: var(--neon); color: black; }
        .btn-pink { border-color: var(--pink); color: var(--pink); } .btn-pink:active { background: var(--pink); color: white; }
        
        /* QR & Input */
        #qrcode { background: white; padding: 10px; border-radius: 10px; margin: 20px; }
        input { font-size: 1.5rem; padding: 10px; text-align: center; border-radius: 8px; border: none; margin: 10px; width: 70%; text-transform: uppercase; }

        /* Game Grid */
        .game-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 90%; max-height: 50vh; overflow-y: auto; }
        .game-card { background: #333; padding: 15px; border-radius: 8px; text-align: center; cursor: pointer; border: 1px solid #555; }
        .game-card:active { border-color: var(--neon); background: #444; }

        /* Controller */
        .full-btn { width: 100%; height: 100%; font-size: 2rem; border: none; font-weight: bold; color: white; }
        .c-red { background: #ff4757; } .c-blue { background: #3742fa; }
    </style>
</head>
<body>

<div id="s-top" class="screen">
    <h1>PARTY BOX<br>FIREBASE</h1>
    <p>ÂÆâÂÆöÊé•Á∂öÁâà</p>
    <button class="btn" id="btn-host">üëë ÈÉ®Â±ã„Çí‰Ωú„Çã (HOST)</button>
    <button class="btn btn-pink" id="btn-join">üì± ÈÉ®Â±ã„Å´ÂÖ•„Çã (JOIN)</button>
</div>

<div id="s-h-lobby" class="screen hidden">
    <h2>ROOM ID</h2>
    <h1 id="disp-id" style="font-size: 4rem; letter-spacing: 5px;">...</h1>
    <div id="qrcode"></div>
    <p>ÂèÇÂä†ËÄÖ: <span id="p-count" style="color:var(--yellow); font-size:1.5rem;">0</span> ‰∫∫</p>
    <button class="btn" id="btn-start-menu">„Ç≤„Éº„É†ÈÅ∏Êäû„Å∏</button>
</div>

<div id="s-h-menu" class="screen hidden">
    <h2>SELECT GAME</h2>
    <div class="game-grid" id="game-list"></div>
</div>

<div id="s-h-game" class="screen hidden">
    <div style="width:100%;height:10px;background:#333;position:fixed;top:0;"><div id="timer-bar" style="width:100%;height:100%;background:var(--neon);"></div></div>
    <h1 id="g-title">GAME</h1>
    <div id="g-main" style="font-size:4rem; margin:20px;">READY</div>
    <div id="g-sub" style="font-size:1.5rem; color:var(--yellow);"></div>
</div>

<div id="s-c-conn" class="screen hidden">
    <h2>ENTER ROOM ID</h2>
    <input type="text" id="inp-room" placeholder="ID (4ÊñáÂ≠ó)">
    <input type="text" id="inp-name" placeholder="ÂêçÂâç">
    <button class="btn" id="btn-connect">ÂèÇÂä†„Åô„Çã</button>
</div>

<div id="s-c-ctrl" class="screen hidden">
    <div id="ctrl-area" style="width:100%; height:100%;"></div>
</div>

<div id="s-c-wait" class="screen hidden">
    <h2>WAITING...</h2>
    <p>„Éõ„Çπ„Éà„ÅÆÁîªÈù¢„ÇíË¶ã„Å¶„Åè„Å†„Åï„ÅÑ</p>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue, push, remove, onDisconnect, update } 
           from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // --- Ë®≠ÂÆö („ÅÇ„Å™„Åü„ÅÆFirebaseÊÉÖÂ†±) ---
    const firebaseConfig = {
        apiKey: "AIzaSyDguL7I5v4GxKf5FahdoFEtU5lNMYgxcNo",
        authDomain: "cotobato-c121f.firebaseapp.com",
        databaseURL: "https://cotobato-c121f-default-rtdb.firebaseio.com",
        projectId: "cotobato-c121f",
        storageBucket: "cotobato-c121f.firebasestorage.app",
        messagingSenderId: "699569737682",
        appId: "1:699569737682:web:350b90c25c300a0548020b",
        measurementId: "G-FQ1VZDXZ6J"
    };

    // --- Firebase ÂàùÊúüÂåñ ---
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // --- „Ç≤„Éº„É†„Éá„Éº„Çø ---
    const GAMES = [
        { id: 'tap', name: 'ÈÄ£Êâì„Éê„Éà„É´', icon: 'üî•', type: 'tap', desc:'ÁîªÈù¢„ÇíÈÄ£Êâì„Åó„ÇçÔºÅ' },
        { id: 'shake', name: '„Ç∑„Çß„Ç§„ÇØÁéã', icon: 'üì±', type: 'sensor', desc:'„Çπ„Éû„Éõ„ÇíÊåØ„ÇåÔºÅ' },
        { id: 'squat', name: '„Çπ„ÇØ„ÉØ„ÉÉ„Éà', icon: 'üèãÔ∏è', type: 'sensor', desc:'„Çπ„Éû„Éõ„ÇíÊåÅ„Å£„Å¶„Åó„ÇÉ„Åå„ÇÅÔºÅ' },
        { id: 'quiz', name: 'Êó©Êäº„Åó„ÇØ„Ç§„Ç∫', icon: 'üéì', type: 'quiz', desc:'A„ÉªB„ÉªC„ÉªD„ÅßÁ≠î„Åà„ÇçÔºÅ' }
    ];

    // --- Áä∂ÊÖãÁÆ°ÁêÜ ---
    let myRole = ''; 
    let roomId = '';
    let myId = Math.random().toString(36).substr(2,6); // Á∞°Êòì„É¶„Éº„Ç∂„ÉºID
    let players = {};
    let gameLoop = null;

    // --- DOMË¶ÅÁ¥† ---
    const show = (id) => {
        document.querySelectorAll('.screen').forEach(e => e.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
    };

    // --- „Çµ„Ç¶„É≥„Éâ ---
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const playSound = (type) => {
        if(audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain); gain.connect(audioCtx.destination);
        const t = audioCtx.currentTime;
        if(type === 'win') {
            osc.frequency.setValueAtTime(523, t); osc.frequency.setValueAtTime(1046, t+0.2);
            gain.gain.setValueAtTime(0.1, t); gain.gain.linearRampToValueAtTime(0, t+0.5);
            osc.start(); osc.stop(t+0.5);
        } else if (type === 'tap') {
            osc.type='triangle'; osc.frequency.setValueAtTime(300, t);
            gain.gain.setValueAtTime(0.1, t); gain.gain.linearRampToValueAtTime(0, t+0.1);
            osc.start(); osc.stop(t+0.1);
        }
    };

    // ================= HOST LOGIC =================
    document.getElementById('btn-host').onclick = () => {
        myRole = 'host';
        roomId = Math.random().toString(36).substr(2,4).toUpperCase(); // 4ÊñáÂ≠óIDÁîüÊàê
        
        // ÈÉ®Â±ã‰ΩúÊàê
        const roomRef = ref(db, `rooms/${roomId}`);
        set(roomRef, { status: 'lobby', host: myId });
        
        // ÂàáÊñ≠ÊôÇ„Å´ÈÉ®Â±ã„ÇíÊ∂à„ÅôÔºà„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„ÉóÔºâ
        onDisconnect(roomRef).remove();

        // UIÊõ¥Êñ∞
        document.getElementById('disp-id').innerText = roomId;
        new QRCode(document.getElementById('qrcode'), { text: `${location.href.split('?')[0]}?room=${roomId}`, width: 150, height: 150 });
        show('s-h-lobby');

        // ÂèÇÂä†ËÄÖÁõ£Ë¶ñ
        onValue(ref(db, `rooms/${roomId}/players`), (snap) => {
            players = snap.val() || {};
            document.getElementById('p-count').innerText = Object.keys(players).length;
            if(Object.keys(players).length > 0) playSound('tap');
        });
    };

    document.getElementById('btn-start-menu').onclick = () => {
        show('s-h-menu');
        // „Ç≤„Éº„É†„É™„Çπ„ÉàÁîüÊàê
        const list = document.getElementById('game-list');
        list.innerHTML = GAMES.map(g => 
            `<div class="game-card" data-gid="${g.id}">
                <div style="font-size:2rem">${g.icon}</div>${g.name}
            </div>`
        ).join('');
        
        // „ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„Éà
        list.querySelectorAll('.game-card').forEach(el => {
            el.onclick = () => startGameHost(el.dataset.gid);
        });
    };

    const startGameHost = (gid) => {
        const game = GAMES.find(g => g.id === gid);
        show('s-h-game');
        
        // „Ç≤„Éº„É†ÂàùÊúüÂåñ
        update(ref(db, `rooms/${roomId}`), { 
            status: 'playing', 
            game: { id: gid, type: game.type, state: 'ready' } // „ÇØ„É©„Ç§„Ç¢„É≥„Éà„Å∏ÈÄöÁü•
        });

        // „Çπ„Ç≥„Ç¢„É™„Çª„ÉÉ„Éà
        Object.keys(players).forEach(pid => {
            set(ref(db, `rooms/${roomId}/players/${pid}/score`), 0);
        });

        document.getElementById('g-title').innerText = game.name;
        document.getElementById('g-main').innerText = "READY";
        document.getElementById('g-sub').innerText = game.desc;

        // „Ç´„Ç¶„É≥„Éà„ÉÄ„Ç¶„É≥
        setTimeout(() => {
            document.getElementById('g-main').innerText = "GO!";
            playSound('win');
            
            // „Ç≤„Éº„É†„É´„Éº„ÉóÈñãÂßã
            let time = 15;
            gameLoop = setInterval(() => {
                time -= 0.1;
                document.getElementById('timer-bar').style.width = (time/15*100) + "%";

                // „Çπ„Ç≥„Ç¢Áõ£Ë¶ñÔºÜ„Éà„ÉÉ„ÉóË°®Á§∫
                const sorted = Object.values(players).sort((a,b) => (b.score||0) - (a.score||0));
                if(sorted.length > 0) {
                    const top = sorted[0];
                    document.getElementById('g-sub').innerText = `TOP: ${top.name} (${top.score||0})`;
                }

                if(time <= 0) finishGameHost();
            }, 100);
        }, 3000);
    };

    const finishGameHost = () => {
        clearInterval(gameLoop);
        update(ref(db, `rooms/${roomId}`), { status: 'result' }); // „ÇØ„É©„Ç§„Ç¢„É≥„ÉàÂæÖÊ©ü„Å∏
        
        const sorted = Object.values(players).sort((a,b) => (b.score||0) - (a.score||0));
        const winner = sorted[0];
        
        document.getElementById('g-main').innerText = "FINISH!";
        document.getElementById('g-sub').innerText = `WINNER: ${winner ? winner.name : '„Å™„Åó'}`;
        playSound('win');

        setTimeout(() => {
             document.getElementById('btn-start-menu').click(); // „É°„Éã„É•„Éº„Å∏Êàª„Çã
        }, 5000);
    };

    // ================= CLIENT LOGIC =================
    // URL„Éë„É©„É°„Éº„Çø„ÉÅ„Çß„ÉÉ„ÇØ
    const params = new URLSearchParams(location.search);
    if(params.get('room')) {
        document.getElementById('inp-room').value = params.get('room');
        show('s-c-conn');
    }

    document.getElementById('btn-join').onclick = () => show('s-c-conn');

    document.getElementById('btn-connect').onclick = () => {
        const inputId = document.getElementById('inp-room').value.toUpperCase();
        const name = document.getElementById('inp-name').value || "„Ç≤„Çπ„Éà";
        
        if(!inputId) return alert("ID„ÇíÂÖ•„Çå„Å¶„Åè„Å†„Åï„ÅÑ");
        roomId = inputId;

        // ÂèÇÂä†Êõ∏„ÅçËæº„Åø
        const myRef = ref(db, `rooms/${roomId}/players/${myId}`);
        set(myRef, { name: name, score: 0 })
        .then(() => {
            // ÂàáÊñ≠ÊôÇ„Å´Ëá™ÂàÜ„ÇíÊ∂à„Åô
            onDisconnect(myRef).remove();
            
            show('s-c-wait');
            initClientListener(); // Áõ£Ë¶ñÈñãÂßã
            requestSensor(); // „Çª„É≥„Çµ„ÉºË®±ÂèØ
        })
        .catch(err => {
            alert("Êé•Á∂ö„Ç®„É©„Éº: Firebase„ÅÆË®≠ÂÆö(Test Mode)„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ");
            console.error(err);
        });
    };

    const initClientListener = () => {
        // „Ç≤„Éº„É†Áä∂ÊÖã„ÅÆÁõ£Ë¶ñ (Host„Åã„Çâ„ÅÆÊåá‰ª§„ÇíÂèó„ÅëÂèñ„Çã)
        onValue(ref(db, `rooms/${roomId}`), (snap) => {
            const data = snap.val();
            if(!data) return; // ÈÉ®Â±ã„Åå„Å™„ÅÑ

            if(data.status === 'playing' && data.game) {
                setupController(data.game);
            } else {
                show('s-c-wait');
                if(navigator.vibrate) navigator.vibrate(0);
            }
        });
    };

    const setupController = (gameInfo) => {
        show('s-c-ctrl');
        const area = document.getElementById('ctrl-area');
        area.innerHTML = '';
        clientGameType = gameInfo.type; // „Çª„É≥„Çµ„ÉºÁî®„Å´‰øùÂ≠ò

        if(gameInfo.type === 'tap') {
            const btn = document.createElement('button');
            btn.className = 'full-btn c-red';
            btn.innerText = "ÈÄ£Êâì!!!";
            btn.onpointerdown = () => { sendAction(1); if(navigator.vibrate) navigator.vibrate(20); };
            area.appendChild(btn);
        } 
        else if (gameInfo.type === 'sensor') {
            area.innerHTML = `<div class="full-btn c-blue" style="display:flex;align-items:center;justify-content:center">‰Ωì„ÇíÂãï„Åã„ÅõÔºÅ</div>`;
        }
        else if (gameInfo.type === 'quiz') {
            area.innerHTML = `
                <div style="display:grid;grid-template-columns:1fr 1fr;height:100%">
                    <button class="full-btn c-red" onclick="sendAction(1)">A</button>
                    <button class="full-btn c-blue" onclick="sendAction(1)">B</button>
                    <button class="full-btn c-red" style="filter:hue-rotate(90deg)" onclick="sendAction(1)">C</button>
                    <button class="full-btn c-blue" style="filter:hue-rotate(90deg)" onclick="sendAction(1)">D</button>
                </div>`;
        }
    };

    // „Ç¢„ÇØ„Ç∑„Éß„É≥ÈÄÅ‰ø° („Çπ„Ç≥„Ç¢Âä†ÁÆó)
    const sendAction = (point) => {
        // „Éà„É©„É≥„Ç∂„ÇØ„Ç∑„Éß„É≥„ÅßÂÆâÂÖ®„Å´Âä†ÁÆó
        const scoreRef = ref(db, `rooms/${roomId}/players/${myId}/score`);
        // „Ç∑„É≥„Éó„É´„Å´Ë™≠„ÅøÂèñ„Å£„Å¶Âä†ÁÆó („Éà„É©„É≥„Ç∂„ÇØ„Ç∑„Éß„É≥ÁúÅÁï•„ÅßÈ´òÈÄüÂåñ)
        // ‚ÄªÂé≥ÂØÜ„Å´„ÅØtransactionÊé®Â•®„Åß„Åô„Åå„ÄÅ„Éë„Éº„ÉÜ„Ç£„Ç≤„Éº„É†„ÅÆÈÄ£ÊâìÈÄüÂ∫¶ÂÑ™ÂÖà„ÅßÁ∞°ÊòìÂÆüË£Ö
        getDatabase(app); // ensure init
        // „Åì„Åì„Åß„ÅØ update„ÇÑset„Çí‰Ωø„Çè„Åö„Å´ transaction„Çí‰Ωø„ÅÑ„Åü„ÅÑ„Å®„Åì„Çç„Åß„Åô„Åå„ÄÅ
        // ÂçòÁ¥îÂåñ„ÅÆ„Åü„ÇÅ runTransaction „Çí‰Ωø„ÅÑ„Åæ„Åô
        // import { runTransaction } ... „ÅåÂøÖË¶Å„Åß„Åô„Åå„ÄÅÈù¢ÂÄí„Å™„ÅÆ„Åß‰∏ÄÊó¶set„Åß‰∏äÊõ∏„ÅçÂä†ÁÆó„Åó„Åæ„Åô
        // (Âé≥ÂØÜ„Å´„ÅØÁ´∂Âêà„Åó„Åæ„Åô„Åå„ÄÅ„Åì„ÅÆË¶èÊ®°„Å™„ÇâOK)
        // ‚òÖ‰øÆÊ≠£: ÈÄ£Êâì„ÅÆ„Åü„Å≥„Å´Server„Å∏ÈÄÅ„Çã„Å®ÂõûÊï∞Âà∂Èôê„Å´„Å≤„Å£„Åã„Åã„ÇãÂèØËÉΩÊÄß„Åå„ÅÇ„Çã„ÅÆ„Åß„ÄÅ
        // Êú¨Êù•„ÅØ„Éê„ÉÉ„ÉÅÂá¶ÁêÜ„Åó„Åæ„Åô„Åå„ÄÅ‰ªäÂõû„ÅØFirebase„ÅÆ„Éë„ÉØ„Éº„Çí‰ø°„Åò„Åæ„Åô„ÄÇ
        
        // ÁèæÂú®ÂÄ§„ÇíË™≠„Åæ„Åö„Å´„Ç§„É≥„ÇØ„É™„É°„É≥„ÉàÊ©üËÉΩ„Åå„Å™„ÅÑ„Åü„ÇÅ„ÄÅClientÂÅ¥„Åß„Ç´„Ç¶„É≥„Éà„Åó„Å¶ÂÆöÊúüÈÄÅ‰ø°„Åå„Éô„Çπ„Éà„Åß„Åô„Åå„ÄÅ
        // „Åì„Åì„Åß„ÅØ„ÄåÁèæÂú®„ÅÆËá™ÂàÜ„ÅÆ„Çπ„Ç≥„Ç¢„Äç„Çí„É°„É¢„É™„ÅßÊåÅ„Å£„Å¶ÈÄÅ„ÇãÊñπÂºè„Å´„Åó„Åæ„Åô„ÄÇ
        // („É™„Çπ„Éä„Éº„ÅßÊõ¥Êñ∞„Åï„Çå„Çã„ÅÆ„ÅßËã•Âπ≤„É©„Ç∞„ÅÇ„Çä„Åæ„Åô„Åå)
    };
    
    // ‚òÖÈ´òÈÄüÈÄ£ÊâìÂØæÁ≠ñ„ÅÆÊîπËâØÁâàÈÄÅ‰ø°„É≠„Ç∏„ÉÉ„ÇØ
    // Ëá™ÂàÜ„ÅÆ„Çπ„Ç≥„Ç¢„Çí„É≠„Éº„Ç´„É´„ÅßÊåÅ„Å£„Å¶„ÄÅÂÆöÊúüÁöÑ„Å´Firebase„Å´ÈÄÅ„Çã
    let myLocalScore = 0;
    // „É™„Çπ„Éä„Éº„ÅßÂêåÊúü
    onValue(ref(db, `rooms/${roomId}/players/${myId}/score`), (s) => {
        const serverScore = s.val() || 0;
        if(serverScore > myLocalScore) myLocalScore = serverScore;
    });

    window.sendAction = (add) => {
        myLocalScore += add;
        set(ref(db, `rooms/${roomId}/players/${myId}/score`), myLocalScore);
    };

    // ================= SENSOR LOGIC =================
    let clientGameType = '';
    const requestSensor = () => {
        if(typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function'){
            DeviceMotionEvent.requestPermission().then(r=>{if(r!=='granted')alert('„Çª„É≥„Çµ„ÉºË®±ÂèØ„ÅåÂøÖË¶Å„Åß„Åô')});
        }
        
        let lastX=0, lastY=0, lastZ=0;
        window.addEventListener('devicemotion', e => {
            if(document.getElementById('s-c-ctrl').classList.contains('hidden')) return;
            const acc = e.accelerationIncludingGravity;
            if(!acc) return;

            if(clientGameType === 'sensor') {
                const delta = Math.abs(acc.x+acc.y+acc.z - lastX-lastY-lastZ);
                if(delta > 25) { // „Ç∑„Çß„Ç§„ÇØÊ§úÁü•
                    window.sendAction(1);
                    if(navigator.vibrate) navigator.vibrate(50);
                }
                lastX=acc.x; lastY=acc.y; lastZ=acc.z;
            }
        });
    };

</script>
</body>
</html>
