<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PARTY BOX: 20 ACTIONS</title>
    <!-- ãƒ©ã‚¤ãƒ–ãƒ©ãƒªèª­ã¿è¾¼ã¿ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+1p:wght@800&family=Rowdies:wght@700&display=swap" rel="stylesheet">
    
    <style>
        :root { --bg: #111; --cyan: #0ff; --pink: #f0f; --yellow: #ff0; }
        body { margin: 0; background: var(--bg); color: white; font-family: 'M PLUS 1p', sans-serif; overflow: hidden; height: 100vh; user-select: none; text-align: center; touch-action: none; }

        /* ç”»é¢å…±é€š */
        .screen { position: fixed; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; background: radial-gradient(circle, #222 0%, #000 100%); transition: opacity 0.3s; z-index: 1; }
        .hidden { opacity: 0; pointer-events: none; z-index: -10; }

        /* ã‚¿ã‚¤ãƒã‚°ãƒ©ãƒ•ã‚£ */
        h1 { font-family: 'Rowdies', cursive; font-size: 3rem; color: var(--cyan); text-shadow: 3px 3px 0 var(--pink); margin: 0; }
        h2 { font-size: 2rem; margin: 10px; }
        p { color: #ccc; font-size: 1.2rem; }
        .big-text { font-size: 4rem; font-weight: 900; color: var(--yellow); }

        /* UIãƒ‘ãƒ¼ãƒ„ */
        .btn { background: linear-gradient(45deg, #f0f, #33f); border: none; color: white; padding: 15px 30px; font-size: 1.2rem; border-radius: 50px; cursor: pointer; margin: 10px; box-shadow: 0 0 10px var(--pink); font-family: inherit; }
        .btn:active { transform: scale(0.95); }
        .btn-cyan { background: linear-gradient(45deg, #0cf, #0fc); color: black; box-shadow: 0 0 10px var(--cyan); }

        /* HOST: ã‚²ãƒ¼ãƒ ç”»é¢ */
        #host-game-area { width: 100%; height: 60%; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .ranking-box { text-align: left; font-size: 1.5rem; background: rgba(255,255,255,0.1); padding: 20px; border-radius: 10px; min-width: 300px; }

        /* CLIENT: ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼å„ç¨® */
        .ctrl-layer { width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; box-sizing: border-box; }
        
        /* ãƒœã‚¿ãƒ³ç³» */
        .c-btn { width: 120px; height: 120px; border-radius: 50%; border: 4px solid white; font-size: 2rem; background: #333; color: white; font-weight: bold; margin: 10px; touch-action: manipulation; box-shadow: 0 5px 0 #000; transition: transform 0.05s; display: flex; align-items: center; justify-content: center; }
        .c-btn:active { transform: translateY(5px); box-shadow: none; background: #555; }
        .c-btn.red { background: #e74c3c; border-color: #c0392b; }
        .c-btn.blue { background: #3498db; border-color: #2980b9; }
        .c-btn.green { background: #2ecc71; border-color: #27ae60; }
        .c-btn.huge { width: 220px; height: 220px; font-size: 3rem; background: radial-gradient(#e74c3c, #c0392b); }

        /* ã‚¹ãƒ¯ã‚¤ãƒ—ãƒ»ã‚¨ãƒªã‚¢ç³» */
        .swipe-area { width: 300px; height: 300px; border: 4px dashed #777; border-radius: 20px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: #777; touch-action: none; }
        
        /* ã‚¯ã‚¤ã‚ºãƒ»é¸æŠè‚¢ç³» */
        .choice-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 100%; max-width: 400px; }
        .choice-btn { height: 100px; border-radius: 15px; font-size: 1.5rem; border: none; background: #444; color: white; box-shadow: 0 5px 0 #222; }
        .choice-btn:active { transform: translateY(5px); box-shadow: none; }

        /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes pulse { 0%{transform:scale(1);} 50%{transform:scale(1.05);} 100%{transform:scale(1);} }
        .anim-shake { animation: shake 0.3s infinite; }
        @keyframes shake { 0%{transform:translate(0,0);} 25%{transform:translate(2px,2px);} 50%{transform:translate(-2px,-2px);} 75%{transform:translate(2px,-2px);} }
    </style>
</head>
<body>

    <!-- ================= HOST SCREENS ================= -->
    <div id="s-top" class="screen">
        <h1>PARTY BOX<br>20 ACTIONS</h1>
        <p>20ç¨®é¡ã®æ“ä½œ Ã— å…¨å“¡å‚åŠ ãƒãƒˆãƒ«</p>
        <div>
            <button id="btn-host" class="btn">ğŸ’» ãƒ›ã‚¹ãƒˆã§ã¯ã˜ã‚ã‚‹</button>
            <button id="btn-client" class="btn btn-cyan">ğŸ“± ã‚¹ãƒãƒ›ã§å‚åŠ </button>
        </div>
    </div>

    <div id="s-lobby" class="screen hidden">
        <h2>ROOM ID</h2>
        <div id="disp-id" class="big-text">----</div>
        <div id="qrcode" style="background:white; padding:10px; border-radius:10px; margin:20px;"></div>
        <p>å‚åŠ äººæ•°: <span id="p-count" style="color:var(--pink); font-weight:bold;">0</span> äºº</p>
        <button onclick="startGame()" class="btn btn-cyan">ã‚²ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆï¼</button>
    </div>

    <div id="s-game" class="screen hidden">
        <h2 id="g-title" style="color:var(--cyan); margin-bottom:5px;">GAME TITLE</h2>
        <p id="g-desc">Description</p>
        <div id="host-game-area">
            <div id="g-timer" class="big-text" style="font-size:6rem;">10.0</div>
            <div id="g-status" style="font-size:2rem; margin-top:20px;"></div>
        </div>
    </div>

    <div id="s-result" class="screen hidden">
        <h1>RESULT</h1>
        <div id="ranking-list" class="ranking-box"></div>
        <button onclick="startGame()" class="btn">æ¬¡ã®ã‚²ãƒ¼ãƒ ã¸</button>
    </div>

    <!-- ================= CLIENT SCREENS ================= -->
    <div id="c-login" class="screen hidden">
        <h2>ROOM ID</h2>
        <input id="inp-id" style="font-size:2rem; width:200px; text-align:center; text-transform:uppercase;" maxlength="4" placeholder="ABCD">
        <br><br>
        <input id="inp-name" style="font-size:1.5rem; width:200px; text-align:center;" maxlength="8" placeholder="åå‰">
        <br><br>
        <button id="btn-join" class="btn btn-cyan">å‚åŠ ã™ã‚‹</button>
    </div>

    <div id="c-play" class="screen hidden">
        <div id="c-header" style="position:absolute; top:10px; width:100%; font-size:1.2rem; color:#aaa;">å¾…æ©Ÿä¸­...</div>
        <div id="c-container" class="ctrl-layer"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, set, get, onValue, update, remove, onDisconnect, runTransaction, child } 
               from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        // Firebaseè¨­å®š (æ›¸ãæ›ãˆã¦ãã ã•ã„)
        const firebaseConfig = {
            apiKey: "AIzaSyDbZzTMvUkG2LXIGY4ux0KBTmnAdqP236s",
            authDomain: "game-4f2d9.firebaseapp.com",
            databaseURL: "https://game-4f2d9-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "game-4f2d9",
            storageBucket: "game-4f2d9.firebasestorage.app",
            messagingSenderId: "574316347824",
            appId: "1:574316347824:web:cf686040628e25ad615675"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- 20ç¨®é¡ã®ã‚²ãƒ¼ãƒ å®šç¾© ---
        const GAMES = [
            { id:'mash', name:'é€£æ‰“ãƒãƒˆãƒ«', desc:'ã¨ã«ã‹ããƒœã‚¿ãƒ³ã‚’é€£æ‰“ã—ã‚ï¼', type:'tap' },
            { id:'shake', name:'ã‚·ã‚§ã‚¤ã‚¯ï¼', desc:'ã‚¹ãƒãƒ›ã‚’å…¨åŠ›ã§æŒ¯ã‚Œï¼', type:'sensor_shake' },
            { id:'stop', name:'5ç§’ã§æ­¢ã‚ã‚', desc:'5.00ç§’ãƒ”ãƒƒã‚¿ãƒªã‚’ç›®æŒ‡ã›ï¼', type:'time_stop' },
            { id:'reaction', name:'æ—©æŠ¼ã—ï¼', desc:'è‰²ãŒã€Œèµ¤ã€ã«ãªã£ãŸã‚‰æŠ¼ã›ï¼', type:'reaction' },
            { id:'hold', name:'ãƒ‘ãƒ¯ãƒ¼å……å¡«', desc:'ãƒœã‚¿ãƒ³ã‚’é•·æŠ¼ã—ã—ã¦ãƒ‘ãƒ¯ãƒ¼ã‚’æºœã‚ã‚ï¼', type:'hold' },
            { id:'swipe_u', name:'å£ã‚’ç™»ã‚Œ', desc:'ä¸Šã«ã‚¹ãƒ¯ã‚¤ãƒ—ã—ç¶šã‘ã‚ï¼', type:'swipe_up' },
            { id:'alternating', name:'å·¦å³é€£æ‰“', desc:'èµ¤ã¨é’ã‚’äº¤äº’ã«æŠ¼ã›ï¼', type:'alt_tap' },
            { id:'math', name:'ã‚¹ãƒ”ãƒ¼ãƒ‰è¨ˆç®—', desc:'è¶³ã—ç®—ã®ç­”ãˆã‚’é¸ã¹ï¼', type:'math' },
            { id:'rps', name:'å¾Œå‡ºã—ã‚¸ãƒ£ãƒ³ã‚±ãƒ³', desc:'ã€Œå‹ã¦ã‚‹æ‰‹ã€ã‚’å‡ºã›ï¼', type:'rps' },
            { id:'color', name:'è‰²å½©æ„Ÿè¦š', desc:'æ–‡å­—ã®ã€Œè‰²ã€ã¨åŒã˜ãƒœã‚¿ãƒ³ã‚’æŠ¼ã›ï¼', type:'color' },
            { id:'count', name:'10å›æŠ¼ã›', desc:'æ­£ç¢ºã«10å›ã ã‘ãƒœã‚¿ãƒ³ã‚’æŠ¼ã›ï¼', type:'count' },
            { id:'angle', name:'ãƒãƒ©ãƒ³ã‚¹', desc:'ã‚¹ãƒãƒ›ã‚’æ°´å¹³(0Â°)ã«ä¿ã¦ï¼', type:'balance' },
            { id:'sequence', name:'é †ç•ªè¨˜æ†¶', desc:'è¡¨ç¤ºã•ã‚ŒãŸæ•°å­—ã®é †ã«æŠ¼ã›ï¼', type:'seq' },
            { id:'highlow', name:'HIGH & LOW', desc:'æ¬¡ã®æ•°å­—ã¯å¤§ãã„ï¼Ÿå°ã•ã„ï¼Ÿ', type:'hl' },
            { id:'dont', name:'æŠ¼ã™ãªï¼', desc:'åˆå›³ãŒã‚ã‚‹ã¾ã§çµ¶å¯¾ã«æŠ¼ã™ãªï¼', type:'dont' },
            { id:'odd', name:'ä»²é–“å¤–ã‚Œ', desc:'ä¸€ã¤ã ã‘é•ã†æ–‡å­—ã‚’é¸ã¹ï¼', type:'odd' },
            { id:'slot', name:'ã‚¹ãƒ­ãƒƒãƒˆ', desc:'ã€Œ7ã€ã§æ­¢ã‚ã‚ï¼', type:'slot' },
            { id:'charge', name:'å¯¸æ­¢ã‚ãƒãƒ£ãƒ¼ã‚¸', desc:'æŠ¼ã—ã¦æºœã‚ã¦ã€æ å†…ã§é›¢ã›ï¼', type:'charge' },
            { id:'luck', name:'é‹å‘½ã®å®ç®±', desc:'å½“ãŸã‚Šã‚’å¼•ã‘ï¼(é‹ã‚²ãƒ¼)', type:'luck' },
            { id:'barrage', nam
