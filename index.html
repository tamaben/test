<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ã‚³ãƒˆãƒãƒˆåºƒå ´</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-body: #0d1117;
            --bg-sidebar: #161b22;
            --bg-card: #21262d;
            --bg-input: #30363d;
            --primary: #58a6ff;
            --primary-dim: rgba(88, 166, 255, 0.15);
            --success: #238636;
            --danger: #da3633;
            --warning: #d29922;
            --text-main: #c9d1d9;
            --text-sub: #8b949e;
            --border: #30363d;
            --radius: 12px;
            --nav-h-mobile: 60px;
            --sidebar-w: 240px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { background: var(--bg-body); color: var(--text-main); font-family: 'Inter', 'Noto Sans JP', sans-serif; margin: 0; padding: 0; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        
        .hidden { display: none !important; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .gap-2 { gap: 8px; }
        .gap-4 { gap: 16px; }
        .font-bold { font-weight: 700; }
        .text-sm { font-size: 0.85rem; }
        .text-xs { font-size: 0.75rem; }
        .mb-2 { margin-bottom: 8px; }
        .mb-4 { margin-bottom: 16px; }
        .w-full { width: 100%; }
        .text-sub { color: var(--text-sub); }

        .icon { width: 20px; height: 20px; fill: currentColor; flex-shrink: 0; }

        .screen { position: absolute; inset: 0; background: var(--bg-body); z-index: 10; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; display: flex; flex-direction: column; }
        .screen.active { opacity: 1; pointer-events: auto; z-index: 20; }

        .auth-container { flex: 1; display: flex; align-items: center; justify-content: center; background: radial-gradient(circle at center, #1f2937 0%, #0b0f19 100%); padding: 20px; }
        .auth-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 24px; padding: 40px 30px; width: 100%; max-width: 380px; text-align: center; box-shadow: 0 25px 50px rgba(0,0,0,0.5); }
        .brand-title { font-size: 2rem; font-weight: 900; background: linear-gradient(135deg, #58a6ff, #bc8cff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 2rem; letter-spacing: 1px; }

        /* ã‚¨ãƒ©ãƒ¼æ™‚ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .input.error { border-color: var(--danger); animation: shake 0.3s; }
        @keyframes shake { 0%,100%{transform:translateX(0)} 25%{transform:translateX(-5px)} 75%{transform:translateX(5px)} }
        .candidate-chip { display: inline-block; background: rgba(88, 166, 255, 0.1); border: 1px solid var(--primary); color: var(--primary); padding: 4px 10px; border-radius: 20px; font-size: 0.8rem; cursor: pointer; margin-right: 5px; margin-bottom: 5px; transition: 0.2s; }
        .candidate-chip:active { background: var(--primary); color: #fff; }

        .app-layout { display: flex; width: 100%; height: 100%; overflow: hidden; }
        .sidebar { width: var(--sidebar-w); background: var(--bg-sidebar); border-right: 1px solid var(--border); display: none; flex-direction: column; padding: 20px; flex-shrink: 0; }
        .sidebar-brand { font-size: 1.2rem; font-weight: 800; color: var(--text-main); margin-bottom: 30px; padding-left: 10px; cursor: pointer; }
        .nav-link { display: flex; align-items: center; gap: 12px; padding: 12px 16px; color: var(--text-sub); border-radius: 8px; cursor: pointer; margin-bottom: 4px; font-weight: 600; font-size: 0.95rem; }
        .nav-link.active { background: var(--primary-dim); color: var(--primary); }
        
        .main-content { flex: 1; display: flex; flex-direction: column; height: 100%; position: relative; overflow: hidden; background: var(--bg-body); }
        .header-mobile { height: 56px; background: var(--bg-sidebar); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: center; padding: 0 16px; flex-shrink: 0; font-weight: 700; font-size: 1.1rem; position: relative; }
        .header-user { position: absolute; right: 16px; font-size: 0.8rem; color: var(--text-sub); }
        .scroll-view { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 80px; -webkit-overflow-scrolling: touch; }

        .bottom-nav { height: var(--nav-h-mobile); background: var(--bg-sidebar); border-top: 1px solid var(--border); display: flex; align-items: center; justify-content: space-around; position: absolute; bottom: 0; left: 0; right: 0; z-index: 50; padding-bottom: env(safe-area-inset-bottom); transition: transform 0.3s; }
        .b-nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: var(--text-sub); font-size: 0.65rem; gap: 4px; cursor: pointer; }
        .b-nav-item.active { color: var(--primary); }

        body.chat-mode .bottom-nav { transform: translateY(100%); } 
        body.chat-mode .sidebar { display: none !important; }
        body.chat-mode .scroll-view { padding-bottom: 0 !important; }

        .card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; margin-bottom: 16px; position: relative; }
        
        .input { width: 100%; padding: 12px; background: var(--bg-input); border: 1px solid var(--border); border-radius: 8px; color: #fff; font-size: 1rem; transition: border-color 0.2s; }
        .input:focus { border-color: var(--primary); }
        
        .btn { width: 100%; padding: 12px; border-radius: 8px; border: none; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 0.95rem; color: white; transition: 0.2s; }
        .btn:active { opacity: 0.7; transform: scale(0.98); }
        .btn-primary { background: var(--success); }
        .btn-ghost { background: transparent; border: 1px solid var(--border); color: var(--text-sub); }
        .btn-danger { background: rgba(218, 54, 51, 0.15); color: var(--danger); border: 1px solid var(--danger); }
        .btn-sm { padding: 6px 12px; font-size: 0.8rem; width: auto; }

        .res-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px; }
        .res-box { background: var(--bg-input); padding: 10px; border-radius: 10px; text-align: center; border: 1px solid var(--border); }
        .res-label { font-size: 0.65rem; color: var(--text-sub); display: block; font-weight: 700; }
        .res-val { font-size: 1.1rem; font-weight: 800; }

        /* Chat */
        .chat-header { height: 50px; background: var(--bg-sidebar); display: flex; align-items: center; padding: 0 16px; border-bottom: 1px solid var(--border); font-weight: bold; justify-content: space-between; flex-shrink: 0; }
        .chat-list { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 16px; }
        .chat-input-wrapper { background: var(--bg-sidebar); border-top: 1px solid var(--border); padding-bottom: calc(10px + env(safe-area-inset-bottom)); flex-shrink: 0; }
        #chat-preview { display: none; padding: 10px 15px 0; align-items: center; gap: 10px; }
        .preview-thumb { height: 60px; border-radius: 8px; border: 1px solid var(--primary); }
        .chat-input-area { padding: 10px 15px; display: flex; gap: 10px; align-items: center; }
        
        .chat-switcher { display: flex; justify-content: center; gap: 10px; flex: 1; }
        .chat-sw-btn { padding: 6px 12px; border-radius: 20px; font-size: 0.8rem; color: var(--text-sub); cursor: pointer; transition: 0.2s; }
        .chat-sw-btn.active { background: var(--primary-dim); color: var(--primary); font-weight: bold; }

        .msg-row { display: flex; flex-direction: column; max-width: 85%; position: relative; }
        .msg-row.mine { align-self: flex-end; align-items: flex-end; }
        .msg-row.other { align-self: flex-start; align-items: flex-start; }
        .msg-name { font-size: 0.7rem; color: var(--text-sub); margin-bottom: 4px; padding: 0 4px; cursor: pointer; }
        .msg-bubble { padding: 10px 14px; border-radius: 16px; font-size: 0.95rem; line-height: 1.5; word-break: break-word; position: relative; }
        .msg-row.mine .msg-bubble { background: #1f6feb; color: white; border-bottom-right-radius: 4px; }
        .msg-row.other .msg-bubble { background: var(--bg-card); border: 1px solid var(--border); border-bottom-left-radius: 4px; }
        .chat-img { max-width: 100%; border-radius: 8px; margin-top: 6px; display: block; cursor: zoom-in; }
        .msg-del { position: absolute; top: -6px; right: -6px; width: 20px; height: 20px; background: var(--danger); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px; cursor: pointer; border: 2px solid var(--bg-body); z-index: 2; }

        .dm-item { display: flex; align-items: center; gap: 12px; padding: 15px; border-bottom: 1px solid var(--border); cursor: pointer; transition: background 0.2s; }
        .dm-item:hover { background: var(--bg-input); }
        .dm-icon { width: 40px; height: 40px; background: var(--primary-dim); color: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.2rem; }
        .dm-info { flex: 1; }
        .dm-name { font-weight: bold; font-size: 0.95rem; }
        .dm-last { font-size: 0.8rem; color: var(--text-sub); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        .news-item { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 12px; cursor: pointer; display: flex; gap: 12px; align-items: center; margin-bottom: 8px; position: relative; overflow: hidden; }
        .news-thumb { width: 60px; height: 60px; background: #000; border-radius: 8px; object-fit: cover; flex-shrink: 0; }
        .pin-mark { background: var(--warning); color: #000; font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; font-weight: bold; margin-right: 6px; }
        .adm-list-item { background: var(--bg-input); padding: 15px; border-radius: 8px; border: 1px solid var(--border); margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
        .adm-tag { font-size: 0.65rem; padding: 2px 6px; border-radius: 4px; background: var(--border); margin-right: 6px; display: inline-block; }
        .adm-tag.future { background: var(--warning); color: #000; }
        .adm-tag.pin { background: var(--primary); color: #fff; }
        .adm-tag.img { background: var(--success); color: #fff; }
        .adm-detail { font-size: 0.75rem; color: var(--text-sub); margin-top: 4px; line-height: 1.4; }

        .hist-item { padding: 10px; border-bottom: 1px solid var(--border); font-size: 0.85rem; display: flex; justify-content: space-between; align-items: center; }
        .hist-meta { font-size: 0.75rem; color: var(--text-sub); }

        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 1000; display: none; align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(4px); }
        .modal-box { background: var(--bg-card); width: 100%; max-width: 500px; border-radius: 16px; border: 1px solid var(--border); overflow: hidden; max-height: 80vh; display: flex; flex-direction: column; }
        .modal-head { padding: 15px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; font-weight: bold; }
        .modal-body { padding: 20px; overflow-y: auto; }
        
        .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: var(--primary); color: #fff; padding: 10px 24px; border-radius: 50px; font-weight: 700; z-index: 2000; opacity: 0; transition: 0.3s; pointer-events: none; }
        .toast.show { opacity: 1; }
        .img-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 3000; display: none; align-items: center; justify-content: center; padding: 10px; }
        .img-full { max-width: 100%; max-height: 100vh; object-fit: contain; }

        @media (min-width: 768px) {
            .sidebar { display: flex; } .bottom-nav { display: none; } .header-mobile { display: none; } .scroll-view { padding-bottom: 20px; }
        }
    </style>
</head>
<body>

    <div id="toast" class="toast">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</div>
    <div id="img-viewer" class="img-overlay" onclick="this.style.display='none'"><img id="img-full" class="img-full"></div>

    <div id="scr-login" class="screen active">
        <div class="auth-container">
            <div class="auth-card">
                <div class="brand-title" id="app-ttl">COTOBATO</div>
                <input type="text" id="inp-uid" class="input mb-4" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼ID (åŠè§’è‹±æ•°)">
                <input type="password" id="inp-pass" class="input mb-4" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
                <button class="btn btn-primary mb-4" onclick="app.login()">ãƒ­ã‚°ã‚¤ãƒ³</button>
                <button class="btn btn-ghost" onclick="app.go('scr-register')">æ–°è¦ç™»éŒ²</button>
                <div id="loading-msg" class="text-xs text-sub mt-4 hidden">æ¥ç¶šä¸­...</div>
            </div>
        </div>
    </div>

    <div id="scr-register" class="screen">
        <div class="auth-container">
            <div class="auth-card">
                <h2 class="mb-4">æ–°è¦ç™»éŒ²</h2>
                <input type="text" id="reg-uid" class="input mb-2" placeholder="å¸Œæœ›ID">
                <div id="reg-candidates" style="text-align:left; margin-bottom:12px;"></div>
                <input type="text" id="reg-name" class="input mb-4" placeholder="è¡¨ç¤ºå (ãƒãƒ£ãƒƒãƒˆã§ã®åå‰)">
                <input type="password" id="reg-pass" class="input mb-4" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
                <button class="btn btn-primary mb-4" onclick="app.register()">ç™»éŒ²ã—ã¦é–‹å§‹</button>
                <button class="btn btn-ghost" onclick="app.go('scr-login')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
        </div>
    </div>

    <div id="scr-main" class="screen">
        <div class="app-layout">
            <nav class="sidebar">
                <div class="sidebar-brand" onclick="location.reload()">COTOBATO</div>
                <div class="nav-link active" onclick="app.tab('home')" data-tab="home"><svg class="icon" viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>ãƒ›ãƒ¼ãƒ </div>
                <div class="nav-link" onclick="app.tab('chat')" data-tab="chat"><svg class="icon" viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/></svg>ãƒãƒ£ãƒƒãƒˆ</div>
                <div class="nav-link" onclick="app.tab('trade')" data-tab="trade"><svg class="icon" viewBox="0 0 24 24"><path d="M16 6l2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6z"/></svg>äº¤æ›æ‰€</div>
                <div class="nav-link" onclick="app.tab('settings')" data-tab="settings"><svg class="icon" viewBox="0 0 24 24"><path d="M12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>è¨­å®š</div>
                <div class="nav-link hidden" id="nav-adm-pc" style="color:var(--warning)" onclick="app.tab('admin')" data-tab="admin"><svg class="icon" viewBox="0 0 24 24"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z"/></svg>é‹å–¶ç®¡ç†</div>
            </nav>

            <div class="main-content">
                <header class="header-mobile"><span>Cotobato</span><span id="header-user-name" class="header-user">Guest</span></header>

                <div id="tab-home" class="scroll-view">
                    <div class="res-grid">
                        <div class="res-box"><span class="res-label">LEVEL</span><span class="res-val" id="v-level">1</span></div>
                        <div class="res-box"><span class="res-label">COINS</span><span class="res-val" id="v-coin" style="color:var(--warning)">0</span></div>
                        <div class="res-box"><span class="res-label">GEMS</span><span class="res-val" id="v-gem" style="color:var(--primary)">0</span></div>
                    </div>
                    <div class="card flex items-center justify-between" style="border-color:var(--warning)">
                        <div><div class="font-bold text-sm" style="color:var(--warning)">ãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆBOX</div><div class="text-xs text-sub">ãƒ­ã‚°ã‚¤ãƒ³ãƒœãƒ¼ãƒŠã‚¹ç­‰</div></div>
                        <button class="btn btn-sm btn-primary" style="background:var(--warning); color:#000; width:auto;" onclick="app.checkGifts()">ç¢ºèª</button>
                    </div>
                    <h3 class="font-bold mb-4 mt-4">ãŠçŸ¥ã‚‰ã›</h3>
                    <div id="news-list" class="flex-col flex">èª­ã¿è¾¼ã¿ä¸­...</div>
                </div>

                <div id="tab-chat" class="hidden" style="height:100%; flex-direction:column; background:var(--bg-body);">
                    <div class="chat-header">
                        <div onclick="app.tab('home')" style="cursor:pointer; display:flex; align-items:center; gap:4px; color:var(--primary);">
                            <svg class="icon" viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>ãƒ›ãƒ¼ãƒ 
                        </div>
                        <div class="chat-switcher">
                            <span class="chat-sw-btn active" id="sw-all" onclick="app.switchChatMode('all')">å…¨ä½“</span>
                            <span class="chat-sw-btn" id="sw-dm" onclick="app.switchChatMode('dm')">å€‹ãƒãƒ£</span>
                        </div>
                        <div style="width:50px;"></div>
                    </div>
                    
                    <div id="area-all-chat" style="display:flex; flex-direction:column; flex:1; overflow:hidden;">
                        <div id="chat-box" class="chat-list"></div>
                        <div class="chat-input-wrapper">
                            <div id="chat-preview">
                                <img id="chat-preview-img" class="preview-thumb">
                                <span class="text-xs text-sub">ç”»åƒã‚’é€ä¿¡ã—ã¾ã™</span>
                                <button class="btn btn-ghost btn-sm" style="width:auto; margin-left:auto;" onclick="app.clearChatImg()">å–æ¶ˆ</button>
                            </div>
                            <form class="chat-input-area" onsubmit="event.preventDefault(); app.sendChat();">
                                <label class="btn btn-ghost" style="width:44px; padding:0; cursor:pointer; border-radius:8px;">
                                    <svg class="icon" viewBox="0 0 24 24"><path d="M16.5 6v11.5c0 2.21-1.79 4-4 4s-4-1.79-4-4V5a2.5 2.5 0 0 1 5 0v10.5c0 .55-.45 1-1 1s-1-.45-1-1V6H10v9.5a2.5 2.5 0 0 0 5 0V5c0-2.21-1.79-4-4-4S7 2.79 7 5v12.5c0 3.04 2.46 5.5 5.5 5.5s5.5-2.46 5.5-5.5V6h-1.5z"/></svg>
                                    <input type="file" id="chat-file" accept="image/*" style="display:none" onchange="app.handleFileSelect(this, 'chat')">
                                </label>
                                <input type="text" id="chat-in" class="input" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸..." style="margin:0;">
                                <button type="submit" class="btn btn-primary" style="width:50px; padding:0;"><svg class="icon" viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg></button>
                            </form>
                        </div>
                    </div>

                    <div id="area-dm-list" style="display:none; flex-direction:column; flex:1; overflow-y:auto; padding:10px;">
                        <button class="btn btn-primary mb-4" onclick="app.searchAndStartDM()">ï¼‹ IDæ¤œç´¢ã—ã¦ãƒãƒ£ãƒƒãƒˆé–‹å§‹</button>
                        <div id="dm-list-box"></div>
                    </div>
                </div>

                <div id="scr-dm-talk" class="screen" style="background:var(--bg-body); z-index:30;">
                    <div class="chat-header">
                        <div onclick="app.closeDM()" style="cursor:pointer; display:flex; align-items:center; gap:4px; color:var(--primary);">
                            <svg class="icon" viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>æˆ»ã‚‹
                        </div>
                        <span id="dm-talk-name">ç›¸æ‰‹ã®åå‰</span>
                        <div style="width:50px;"></div>
                    </div>
                    <div id="dm-talk-box" class="chat-list"></div>
                    <div class="chat-input-wrapper">
                        <div id="dm-preview" style="display:none; padding:10px 15px 0; align-items:center; gap:10px;">
                            <img id="dm-preview-img" class="preview-thumb">
                            <span class="text-xs text-sub">ç”»åƒ</span>
                            <button class="btn btn-ghost btn-sm" style="width:auto; margin-left:auto;" onclick="app.clearDMImg()">å–æ¶ˆ</button>
                        </div>
                        <form class="chat-input-area" onsubmit="event.preventDefault(); app.sendDM();">
                            <label class="btn btn-ghost" style="width:44px; padding:0; cursor:pointer; border-radius:8px;">
                                <svg class="icon" viewBox="0 0 24 24"><path d="M16.5 6v11.5c0 2.21-1.79 4-4 4s-4-1.79-4-4V5a2.5 2.5 0 0 1 5 0v10.5c0 .55-.45 1-1 1s-1-.45-1-1V6H10v9.5a2.5 2.5 0 0 0 5 0V5c0-2.21-1.79-4-4-4S7 2.79 7 5v12.5c0 3.04 2.46 5.5 5.5 5.5s5.5-2.46 5.5-5.5V6h-1.5z"/></svg>
                                <input type="file" id="dm-file" accept="image/*" style="display:none" onchange="app.handleFileSelect(this, 'dm')">
                            </label>
                            <input type="text" id="dm-in" class="input" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸..." style="margin:0;">
                            <button type="submit" class="btn btn-primary" style="width:50px; padding:0;"><svg class="icon" viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg></button>
                        </form>
                    </div>
                </div>

                <div id="tab-trade" class="scroll-view hidden">
                    <div class="card">
                        <h3>å‡ºå“</h3>
                        <div class="flex gap-2 items-center mb-4">
                            <select id="tr-give-type" class="input" style="width:30%"><option value="coins">ã‚³ã‚¤ãƒ³</option><option value="diamonds">ãƒ€ã‚¤ãƒ¤</option></select>
                            <input type="number" id="tr-give-val" class="input" placeholder="æ”¯æ‰•ã†é‡">
                        </div>
                        <div class="text-center text-xs text-sub mb-2">â†“ å¸Œæœ›æ¡ä»¶ â†“</div>
                        <div class="flex gap-2 items-center mb-4">
                            <select id="tr-want-type" class="input" style="width:30%"><option value="coins">ã‚³ã‚¤ãƒ³</option><option value="diamonds">ãƒ€ã‚¤ãƒ¤</option></select>
                            <input type="number" id="tr-want-val" class="input" placeholder="æ¬²ã—ã„é‡">
                        </div>
                        <div class="mb-4">
                            <label class="text-xs text-sub">ã‚ã„ã“ã¨ã° (ä»»æ„)</label>
                            <input type="text" id="tr-pass" class="input" placeholder="ã‚³ãƒ¼ãƒ‰å–å¼•ã™ã‚‹å ´åˆã®ã¿å…¥åŠ›">
                        </div>
                        <div class="text-xs text-warning mb-2">â€»3æ—¥é–“(72æ™‚é–“)ã§è‡ªå‹•çš„ã«æœŸé™åˆ‡ã‚Œã«ãªã‚Šã¾ã™ã€‚</div>
                        <button class="btn btn-primary" onclick="app.createTrade()">å‡ºå“ã‚’å…¬é–‹</button>
                    </div>
                    <h3>å–å¼•ä¸€è¦§</h3>
                    <div id="trade-list" class="flex flex-col gap-2"></div>
                </div>

                <div id="tab-settings" class="scroll-view hidden">
                    <div class="card">
                        <h3>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</h3>
                        <div class="mb-4"><label class="text-xs text-sub">è¡¨ç¤ºå</label><input type="text" id="set-name" class="input"></div>
                        <button class="btn btn-primary" onclick="app.updateProfile()">ä¿å­˜</button>
                    </div>
                    <div class="card">
                        <h3>ãƒ‡ãƒ¼ã‚¿ç®¡ç†(ã‚¯ãƒ©ã‚¦ãƒ‰)</h3>
                        <div class="flex gap-2 mb-2"><button class="btn btn-ghost" onclick="app.manualBackup()">â˜ æ‰‹å‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</button><button class="btn btn-danger" onclick="app.restoreCloudList()">â†º ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å¾©å…ƒ</button></div>
                        <div class="text-xs text-sub text-center" id="last-backup-info">å±¥æ­´ãªã—</div>
                    </div>
                    <div class="card" style="border-color:var(--success)">
                        <h3 style="color:var(--success)">ãƒ–ãƒ©ã‚¦ã‚¶ã¨åŒæœŸ(ãƒ­ãƒ¼ã‚«ãƒ«)</h3>
                        <div class="flex gap-2 mb-2"><button class="btn btn-success" style="background:var(--success)" onclick="app.saveToLocal()">â†“ ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜</button><button class="btn btn-ghost" onclick="app.loadFromLocalList()">â†‘ ãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰èª­è¾¼</button></div>
                    </div>
                    <div class="card">
                        <h3>ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ</h3>
                        <div class="text-xs text-sub mb-4">ID: <span id="set-uid"></span></div>
                        <button class="btn btn-danger" onclick="app.logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
                    </div>
                    <div class="card">
                        <h3>é‹å–¶èªè¨¼</h3>
                        <input type="password" id="adm-code" class="input mb-4" placeholder="é‹å–¶ã‚³ãƒ¼ãƒ‰">
                        <button class="btn btn-ghost" onclick="app.authAdmin()">èªè¨¼</button>
                    </div>
                </div>

                <div id="tab-admin" class="scroll-view hidden">
                    <div class="card">
                        <h3>é‹å–¶ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´</h3>
                        <input type="password" id="adm-new-code" class="input mb-2" placeholder="æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
                        <button class="btn btn-warning" style="background:var(--warning); color:#000" onclick="app.changeAdmPass()">å¤‰æ›´ã‚’ä¿å­˜</button>
                    </div>
                    <div class="card" style="border-color:var(--warning)">
                        <h3 style="color:var(--warning)">ãŠçŸ¥ã‚‰ã›é…ä¿¡</h3>
                        <input type="hidden" id="adm-news-id">
                        <input type="text" id="adm-news-title" class="input mb-2" placeholder="ã‚¿ã‚¤ãƒˆãƒ«">
                        <textarea id="adm-news-body" class="input mb-2" style="min-height:80px" placeholder="æœ¬æ–‡"></textarea>
                        <div class="flex gap-2 items-center mb-2"><label class="btn btn-ghost btn-sm" style="width:auto">ç”»åƒ<input type="file" id="adm-news-file" accept="image/*" style="display:none" onchange="app.handleFileSelect(this, 'news')"></label><span id="adm-news-file-status" class="text-xs text-sub">æœªé¸æŠ</span></div>
                        <div class="flex gap-4 items-center mb-4">
                            <label class="flex items-center gap-2 text-sm"><input type="checkbox" id="adm-news-pin"> å›ºå®š</label>
                            <div class="flex flex-col"><label class="text-xs text-sub">å…¬é–‹äºˆç´„</label><input type="datetime-local" id="adm-news-date" class="input" style="width:auto; padding:6px;"></div>
                        </div>
                        <div class="flex gap-2"><button id="btn-news-post" class="btn btn-primary" onclick="app.postNews()">é…ä¿¡ç™»éŒ²</button><button id="btn-news-cancel" class="btn btn-ghost hidden" onclick="app.resetNewsForm()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button></div>
                    </div>
                    <div class="card">
                        <h3>ãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆé…å¸ƒ</h3>
                        <input type="hidden" id="adm-gift-id">
                        <div class="flex gap-2 mb-2"><select id="adm-gift-type" class="input"><option value="coins">ã‚³ã‚¤ãƒ³</option><option value="diamonds">ãƒ€ã‚¤ãƒ¤</option></select><input type="number" id="adm-gift-val" class="input" placeholder="é‡"></div>
                        <input type="text" id="adm-gift-msg" class="input mb-2" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸">
                        <div class="flex flex-col gap-2 mb-4">
                            <div class="flex flex-col"><label class="text-xs text-sub">é…å¸ƒé–‹å§‹æ—¥æ™‚</label><input type="datetime-local" id="adm-gift-start" class="input" style="padding:6px;"></div>
                            <div class="flex flex-col"><label class="text-xs text-sub">å—å–æœŸé™</label><input type="datetime-local" id="adm-gift-end" class="input" style="padding:6px;"></div>
                        </div>
                        <div class="flex gap-2"><button id="btn-gift-post" class="btn btn-danger" onclick="app.distributeGift()">å…¨å“¡ã«é…å¸ƒ</button><button id="btn-gift-cancel" class="btn btn-ghost hidden" onclick="app.resetGiftForm()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button></div>
                    </div>
                    <h3 class="mt-4 mb-2">é…ä¿¡ä¸­ã®ãŠçŸ¥ã‚‰ã›</h3><div id="adm-list-news"></div>
                    <h3 class="mt-4 mb-2">é…å¸ƒæ¸ˆã¿ã‚®ãƒ•ãƒˆ</h3><div id="adm-list-gifts"></div>
                </div>
            </div>

            <nav class="bottom-nav">
                <div class="b-nav-item active" onclick="app.tab('home')" data-tab="home"><svg class="icon" viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>ãƒ›ãƒ¼ãƒ </div>
                <div class="b-nav-item" onclick="app.tab('chat')" data-tab="chat"><svg class="icon" viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/></svg>ãƒãƒ£ãƒƒãƒˆ</div>
                <div class="b-nav-item" onclick="app.tab('trade')" data-tab="trade"><svg class="icon" viewBox="0 0 24 24"><path d="M16 6l2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6z"/></svg>äº¤æ›</div>
                <div class="b-nav-item" onclick="app.tab('settings')" data-tab="settings"><svg class="icon" viewBox="0 0 24 24"><path d="M12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>è¨­å®š</div>
            </nav>
        </div>
    </div>

    <div id="modal-base" class="modal-overlay" onclick="if(event.target===this)app.closeModal()">
        <div class="modal-box">
            <div class="modal-head"><span id="mdl-title"></span><button class="btn btn-ghost" style="width:30px;padding:0" onclick="app.closeModal()">âœ•</button></div>
            <div id="mdl-content" class="modal-body"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, addDoc, onSnapshot, serverTimestamp, query, orderBy, limit, where, deleteDoc, Timestamp, getDocs, increment, runTransaction, arrayUnion } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDguL7I5v4GxKf5FahdoFEtU5lNMYgxcNo",
            authDomain: "cotobato-c121f.firebaseapp.com",
            databaseURL: "https://cotobato-c121f-default-rtdb.firebaseio.com",
            projectId: "cotobato-c121f",
            storageBucket: "cotobato-c121f.firebasestorage.app",
            messagingSenderId: "699569737682",
            appId: "1:699569737682:web:350b90c25c300a0548020b"
        };

        const fApp = initializeApp(firebaseConfig);
        const db = getFirestore(fApp);
        const auth = getAuth(fApp);
        const SESS_KEY = "kb_user_id";
        const ADM_KEY = "kb_adm_exp";
        const LOC_KEY = "kb_game_data_history";

        let currentUser = null;
        let listeners = [];
        let chatImg = null; let dmImg = null;
        let newsImg = null; let newsImgOriginal = null;
        let currentRoomId = null; 
        let dmUnsub = null;
        let myDeviceId = localStorage.getItem("kb_device_id") || crypto.randomUUID();
        localStorage.setItem("kb_device_id", myDeviceId);

        // Helper to convert Firestore timestamp safely
        const toDate = (ts) => {
            if (!ts) return new Date();
            if (ts.toDate) return ts.toDate();
            if (ts instanceof Date) return ts;
            return new Date();
        };

        const app = {
            init: () => {
                signInAnonymously(auth).then(() => {
                    onAuthStateChanged(auth, u => { if(u) {
                        const uid = localStorage.getItem(SESS_KEY);
                        if(uid) app.loadUser(uid);
                    }});
                });
            },
            go: (id) => { document.querySelectorAll('.screen').forEach(e=>e.classList.remove('active')); document.getElementById(id).classList.add('active'); },
            tab: (id) => {
                ['home','chat','trade','settings','admin'].forEach(t=>{const e=document.getElementById('tab-'+t); if(e) e.classList.add('hidden')});
                const t = document.getElementById('tab-'+id);
                if(t){ t.classList.remove('hidden'); if(t.classList.contains('scroll-view')) t.classList.add('flex-col','flex'); }
                if(id==='chat') { 
                    t.style.display='flex'; document.body.classList.add('chat-mode');
                    app.switchChatMode('all'); 
                } else document.body.classList.remove('chat-mode');
                if(id==='admin') { if(!app.checkAdmSess()) { app.tab('settings'); app.toast("ã‚»ãƒƒã‚·ãƒ§ãƒ³åˆ‡ã‚Œ"); return; } }
                document.querySelectorAll('.nav-link, .b-nav-item').forEach(e=>e.classList.remove('active'));
                document.querySelectorAll(`[data-tab="${id}"]`).forEach(e=>e.classList.add('active'));
            },
            
            // AUTH
            login: async () => {
                const uid = document.getElementById('inp-uid').value.trim(), pass = document.getElementById('inp-pass').value.trim();
                if(!uid || !pass) return app.toast("å…¥åŠ›ã—ã¦ãã ã•ã„");
                document.getElementById('loading-msg').classList.remove('hidden');
                try {
                    const s = await getDoc(doc(db,"users",uid));
                    if(s.exists() && s.data().password === pass) { localStorage.setItem(SESS_KEY, uid); app.loadUser(uid); }
                    else { app.toast("é–“é•ã„"); document.getElementById('loading-msg').classList.add('hidden'); }
                } catch { app.toast("ã‚¨ãƒ©ãƒ¼"); document.getElementById('loading-msg').classList.add('hidden'); }
            },
            register: async () => {
                const uidInp = document.getElementById('reg-uid');
                const uid = uidInp.value.trim();
                const name = document.getElementById('reg-name').value.trim()||uid;
                const pass = document.getElementById('reg-pass').value.trim();
                
                if(!uid || !pass) return app.toast("å¿…é ˆ");
                uidInp.classList.remove('error');
                document.getElementById('reg-candidates').innerHTML = "";

                const s = await getDoc(doc(db,"users",uid));
                if(s.exists()) {
                    app.toast("æ—¢ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™");
                    uidInp.classList.add('error');
                    const base = uid.replace(/\d+$/, ''); 
                    const cands = [base + Math.floor(Math.random()*1000), base + "_" + new Date().getFullYear(), "user_" + base, base + "_jp"];
                    let html = "<div class='text-xs text-sub mb-1'>ãŠã™ã™ã‚:</div>";
                    cands.forEach(c => { html += `<span class="candidate-chip" onclick="document.getElementById('reg-uid').value='${c}'; document.getElementById('reg-uid').classList.remove('error'); this.parentElement.innerHTML='';">${c}</span>`; });
                    document.getElementById('reg-candidates').innerHTML = html;
                    return;
                }
                await setDoc(doc(db,"users",uid), { uid, username:uid, name, password:pass, coins:100, diamonds:0, level:1, isAdmin:false, createdAt:serverTimestamp(), history:[] });
                localStorage.setItem(SESS_KEY, uid); app.loadUser(uid);
            },
            loadUser: async (uid) => {
                listeners.push(onSnapshot(doc(db,"users",uid), s=>{
                    if(s.exists()){ 
                        currentUser=s.data(); app.renderHead(); 
                        if(currentUser.history && currentUser.history.length > 0) document.getElementById('last-backup-info').innerText = "æœ€çµ‚ä¿å­˜: " + currentUser.history[currentUser.history.length-1].d;
                        else document.getElementById('last-backup-info').innerText = "å±¥æ­´ãªã—";
                        app.go('scr-main'); app.tab('home'); 
                    }
                }));
                app.subNews(); app.subChat(); app.subTrade(); app.subDMList();
            },
            renderHead: () => {
                document.getElementById('header-user-name').innerText=currentUser.name; document.getElementById('set-name').value=currentUser.name; document.getElementById('set-uid').innerText=currentUser.username;
                document.getElementById('v-coin').innerText=(currentUser.coins||0).toLocaleString(); document.getElementById('v-gem').innerText=(currentUser.diamonds||0).toLocaleString(); document.getElementById('v-level').innerText=currentUser.level||1;
            },
            logout: () => { localStorage.removeItem(SESS_KEY); localStorage.removeItem(ADM_KEY); location.reload(); },

            // BACKUP
            updateUser: async (changes, msg) => {
                try {
                    await runTransaction(db, async (tr) => {
                        const ref = doc(db, "users", currentUser.username);
                        const s = await tr.get(ref);
                        if (!s.exists()) throw "User not found";
                        const d = s.data();
                        const newData = { ...d, ...changes };
                        let history = d.history || [];
                        const myHists = history.filter(h => h.dev === myDeviceId);
                        const otherHists = history.filter(h => h.dev !== myDeviceId);
                        myHists.push({ d: new Date().toLocaleString(), v: JSON.stringify({ coins: newData.coins, diamonds: newData.diamonds, level: newData.level||1 }), dev: myDeviceId });
                        if(myHists.length > 5) myHists.shift();
                        tr.update(ref, { ...changes, history: [...otherHists, ...myHists] });
                    });
                    if(msg) app.toast(msg);
                } catch(e) { console.error(e); app.toast("æ›´æ–°ã‚¨ãƒ©ãƒ¼"); }
            },
            manualBackup: () => app.updateUser({}, "ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä½œæˆã—ã¾ã—ãŸ"),
            restoreCloudList: () => {
                if(!currentUser.history || currentUser.history.length === 0) return app.toast("å±¥æ­´ãªã—");
                let h = `<div style='max-height:300px; overflow-y:auto;'>`;
                const list = [...currentUser.history].reverse();
                list.forEach((item) => {
                    const data = JSON.parse(item.v);
                    h += `<div class="hist-item"><div><b>${item.d}</b><br><span class="hist-meta">${item.dev===myDeviceId?'ã“ã®ç«¯æœ«':'åˆ¥ç«¯æœ«'} | ğŸª™${data.coins} ğŸ’${data.diamonds}</span></div><button class="btn btn-sm btn-primary" onclick='app.execRestore(${JSON.stringify(data)})'>å¾©å…ƒ</button></div>`;
                });
                h += `</div>`;
                app.mdl("ã‚¯ãƒ©ã‚¦ãƒ‰å±¥æ­´å¾©å…ƒ", h);
            },
            execRestore: async (data) => {
                if(!confirm("å¾©å…ƒã—ã¾ã™ã‹ï¼Ÿ")) return;
                await app.updateUser({ coins: data.coins, diamonds: data.diamonds, level: data.level }, "å¾©å…ƒã—ã¾ã—ãŸ");
                app.closeModal();
            },
            saveToLocal: () => {
                let hist = JSON.parse(localStorage.getItem(LOC_KEY) || "[]");
                hist.push({ d: new Date().toLocaleString(), coins: currentUser.coins, diamonds: currentUser.diamonds, level: currentUser.level || 1 });
                localStorage.setItem(LOC_KEY, JSON.stringify(hist));
                app.toast("ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã—ã¾ã—ãŸ");
            },
            loadFromLocalList: () => {
                let hist = JSON.parse(localStorage.getItem(LOC_KEY) || "[]");
                if(hist.length === 0) return app.toast("ãƒ‡ãƒ¼ã‚¿ãªã—");
                let h = `<div style='max-height:300px; overflow-y:auto;'>`;
                hist.reverse().forEach((item) => {
                    h += `<div class="hist-item"><div><b>${item.d}</b><br><span class="hist-meta">ğŸª™${item.coins} ğŸ’${item.diamonds}</span></div><button class="btn btn-sm btn-success" onclick='app.execRestore(${JSON.stringify(item)})'>å¾©å…ƒ</button></div>`;
                });
                h += `</div>`;
                app.mdl("ãƒ–ãƒ©ã‚¦ã‚¶å±¥æ­´å¾©å…ƒ", h);
            },

            // CHAT
            subChat: () => {
                listeners.push(onSnapshot(query(collection(db,"chat"), orderBy("createdAt","desc"), limit(30)), s=>{
                    const b = document.getElementById('chat-box'); b.innerHTML="";
                    const msgs=[]; s.forEach(d=>msgs.push({id:d.id, ...d.data()}));
                    msgs.reverse().forEach(m => b.innerHTML += app.buildMsgHTML(m));
                    app.scrollChat();
                }));
            },
            buildMsgHTML: (m) => {
                const isMe = m.username === currentUser.username;
                const name = m.sender || m.name || "Unknown";
                return `<div class="msg-row ${isMe?'mine':'other'}">${!isMe?`<span class="msg-name" onclick="app.showProfile('${m.username}','${name}')">${name}</span>`:''}<div class="msg-bubble">${(isMe||currentUser.isAdmin)?`<div class="msg-del" onclick="app.delChat('${m.id}')">âœ•</div>`:''}${m.text?`<div>${m.text}</div>`:''}${m.img?`<img src="${m.img}" class="chat-img" onload="app.scrollChat()" onclick="document.getElementById('img-full').src=this.src;document.getElementById('img-viewer').style.display='flex'">`:''}</div></div>`;
            },
            sendChat: async () => {
                const i=document.getElementById('chat-in'), t=i.value.trim(); if(!t && !chatImg) return;
                await addDoc(collection(db,"chat"), { text:t, img:chatImg, username:currentUser.username, sender:currentUser.name, createdAt:serverTimestamp() });
                i.value=""; app.clearChatImg();
            },
            delChat: async (id) => { if(confirm("å‰Šé™¤ï¼Ÿ")) await deleteDoc(doc(db,"chat",id)); },
            scrollChat: () => { const b=document.getElementById('tab-chat'); if(!b.classList.contains('hidden')) setTimeout(()=>document.getElementById('chat-box').scrollTop=99999, 100); },
            clearChatImg: () => { chatImg = null; document.getElementById('chat-file').value = ""; document.getElementById('chat-preview').style.display = 'none'; },
            switchChatMode: (mode) => {
                if(mode === 'all') {
                    document.getElementById('area-all-chat').style.display='flex'; document.getElementById('area-dm-list').style.display='none';
                    document.getElementById('sw-all').classList.add('active'); document.getElementById('sw-dm').classList.remove('active'); app.scrollChat();
                } else {
                    document.getElementById('area-all-chat').style.display='none'; document.getElementById('area-dm-list').style.display='flex';
                    document.getElementById('sw-all').classList.remove('active'); document.getElementById('sw-dm').classList.add('active');
                }
            },

            // DM
            subDMList: () => {
                const q = query(collection(db, "rooms"), where("members", "array-contains", currentUser.username), orderBy("updatedAt", "desc"));
                listeners.push(onSnapshot(q, s => {
                    const list = document.getElementById('dm-list-box'); list.innerHTML = "";
                    if(s.empty) { list.innerHTML = "<div class='text-center text-sub mt-4'>å€‹ãƒãƒ£ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“</div>"; return; }
                    s.forEach(d => {
                        const r = d.data(), otherId = r.members.find(id => id !== currentUser.username), otherName = r.names ? r.names[otherId] : otherId;
                        list.innerHTML += `<div class="dm-item" onclick="app.openDMRoom('${d.id}', '${otherName}')"><div class="dm-icon">${otherName.charAt(0)}</div><div class="dm-info"><div class="dm-name">${otherName}</div><div class="dm-last">${r.lastMsg || "ç”»åƒ"}</div></div></div>`;
                    });
                }));
            },
            searchAndStartDM: async () => {
                const targetId = prompt("ç›¸æ‰‹ã®IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
                if(!targetId || targetId === currentUser.username) return;
                try {
                    const snap = await getDoc(doc(db, "users", targetId));
                    if(!snap.exists()) return app.toast("ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
                    app.startDM(targetId, snap.data().name);
                } catch(e) { app.toast("ã‚¨ãƒ©ãƒ¼"); }
            },
            showProfile: (uid, name) => {
                if(uid === currentUser.username) return;
                app.mdl("ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«", `<div style="text-align:center"><div style="font-size:3rem; margin-bottom:10px;">ğŸ‘¤</div><h3>${name}</h3><p class="text-sub mb-4">ID: ${uid}</p><button class="btn btn-primary" onclick="app.startDM('${uid}', '${name}')">å€‹ãƒãƒ£ã™ã‚‹</button></div>`);
            },
            startDM: async (targetUid, targetName) => {
                app.closeModal(); const members = [currentUser.username, targetUid].sort(), roomId = members.join("_"), ref = doc(db, "rooms", roomId);
                const snap = await getDoc(ref);
                if(!snap.exists()){ await setDoc(ref, { members: members, names: { [currentUser.username]: currentUser.name, [targetUid]: targetName }, updatedAt: serverTimestamp(), lastMsg: "é–‹å§‹" }); }
                app.openDMRoom(roomId, targetName);
            },
            openDMRoom: (roomId, name) => {
                currentRoomId = roomId; document.getElementById('dm-talk-name').innerText = name; document.getElementById('scr-dm-talk').classList.add('active');
                if(dmUnsub) dmUnsub();
                const q = query(collection(db, "rooms", roomId, "messages"), orderBy("createdAt", "desc"), limit(30));
                dmUnsub = onSnapshot(q, s => {
                    const b = document.getElementById('dm-talk-box'); b.innerHTML = "";
                    const msgs = []; s.forEach(d => msgs.push({id:d.id, ...d.data()}));
                    msgs.reverse().forEach(m => b.innerHTML += app.buildMsgHTML(m));
                    setTimeout(()=>b.scrollTop = 99999, 100);
                });
            },
            closeDM: () => { document.getElementById('scr-dm-talk').classList.remove('active'); if(dmUnsub) dmUnsub(); currentRoomId = null; },
            sendDM: async () => {
                const i = document.getElementById('dm-in'), t = i.value.trim(); if((!t && !dmImg) || !currentRoomId) return;
                await addDoc(collection(db, "rooms", currentRoomId, "messages"), { text: t, img: dmImg, username: currentUser.username, sender: currentUser.name, createdAt: serverTimestamp() });
                await updateDoc(doc(db, "rooms", currentRoomId), { lastMsg: t || "ç”»åƒ", updatedAt: serverTimestamp() });
                i.value = ""; app.clearDMImg();
            },
            handleFileSelect: (i, type) => {
                if(i.files[0]){
                    const reader = new FileReader();
                    reader.onload = e => {
                        const img = new Image(); img.onload = () => {
                            const c = document.createElement('canvas'), MAX=800; let w=img.width, h=img.height;
                            if(w>MAX){h*=MAX/w;w=MAX} c.width=w; c.height=h; c.getContext('2d').drawImage(img,0,0,w,h);
                            const d = c.toDataURL('image/jpeg',0.7);
                            if(type==='chat') { chatImg=d; document.getElementById('chat-preview').style.display='flex'; document.getElementById('chat-preview-img').src=d; }
                            else if(type==='dm') { dmImg=d; document.getElementById('dm-preview').style.display='flex'; document.getElementById('dm-preview-img').src=d; }
                            else { newsImg=d; document.getElementById('adm-news-file-status').innerText="é¸æŠæ¸ˆ"; }
                        }; img.src = e.target.result;
                    }; reader.readAsDataURL(i.files[0]);
                }
            },
            clearDMImg: () => { dmImg=null; document.getElementById('dm-file').value=""; document.getElementById('dm-preview').style.display='none'; },

            // NEWS (User Side)
            subNews: () => {
                listeners.push(onSnapshot(query(collection(db,"announcements"), limit(30)), s=>{
                    const l = document.getElementById('news-list'); l.innerHTML="";
                    let items = []; s.forEach(d => items.push({id:d.id, ...d.data()}));
                    const now = new Date();
                    items = items.filter(n => (n.publishAt ? toDate(n.publishAt) : toDate(n.createdAt)) <= now);
                    items.sort((a,b) => {
                        if(a.pin !== b.pin) return b.pin ? 1 : -1;
                        const da = a.publishAt ? a.publishAt.seconds : a.createdAt.seconds;
                        const db = b.publishAt ? b.publishAt.seconds : b.createdAt.seconds;
                        return db - da;
                    });
                    items.forEach(n => {
                        const pub = n.publishAt ? toDate(n.publishAt) : toDate(n.createdAt);
                        l.innerHTML += `<div class="news-item" onclick="app.openNews('${n.id}')">${n.img?`<img src="${n.img}" class="news-thumb">`:''}<div style="flex:1"><div class="font-bold">${n.pin?'<span class="pin-mark">å›ºå®š</span>':''}${n.title}</div><div class="text-xs text-sub">${pub.toLocaleDateString()}</div></div><div class="hidden" id="nc-${n.id}">${n.body}</div><div class="hidden" id="ni-${n.id}">${n.img||''}</div></div>`;
                    });
                }));
            },
            openNews: (id) => {
                const ti = document.querySelector(`#nc-${id}`).parentElement.querySelector('.font-bold').innerText;
                const bo = document.getElementById(`nc-${id}`).innerHTML;
                const im = document.getElementById(`ni-${id}`).innerHTML;
                app.mdl(ti, `${im?`<img src="${im}" style="width:100%;border-radius:8px;margin-bottom:10px">`:''}<div style="white-space:pre-wrap;line-height:1.6">${bo}</div>`);
            },

            // ADMIN
            checkAdmSess: () => { const e=localStorage.getItem(ADM_KEY); if(e&&parseInt(e)>Date.now())return true; localStorage.removeItem(ADM_KEY); return false; },
            authAdmin: async () => {
                if(app.checkAdmSess()){ app.tab('admin'); return; }
                const c=document.getElementById('adm-code').value; let vc="cotobato-admin";
                try{const d=await getDoc(doc(db,"system","config"));if(d.exists())vc=d.data().code}catch{}
                if(c===vc){localStorage.setItem(ADM_KEY, Date.now()+1800000); document.getElementById('tab-admin').classList.remove('hidden'); document.getElementById('nav-adm-pc').classList.remove('hidden'); app.tab('admin'); app.toast("èªè¨¼æˆåŠŸ"); app.subAdmList(); document.getElementById('adm-code').value="";}else app.toast("é•ã„ã¾ã™");
            },
            changeAdmPass: async () => {
                const nc=document.getElementById('adm-new-code').value.trim(); if(nc.length<4) return app.toast("çŸ­ã™ãã¾ã™");
                await setDoc(doc(db,"system","config"),{code:nc}); app.toast("å¤‰æ›´ã—ã¾ã—ãŸ");
            },
            subAdmList: () => {
                onSnapshot(query(collection(db,"announcements"), limit(50)), s=>{
                    const l=document.getElementById('adm-list-news'); l.innerHTML="";
                    let items=[]; s.forEach(d=>items.push({id:d.id, ...d.data()}));
                    items.sort((a,b)=>(b.createdAt?.seconds||0)-(a.createdAt?.seconds||0));
                    items.forEach(n=>{
                        const pub=n.publishAt?toDate(n.publishAt):toDate(n.createdAt);
                        l.innerHTML+=`<div class="adm-list-item"><div style="flex:1"><div class="font-bold text-sm">${n.pin?'<span class="adm-tag pin">å›ºå®š</span>':''}${pub>new Date()?'<span class="adm-tag future">äºˆç´„</span>':''}${n.img?'<span class="adm-tag img">ç”»åƒ</span>':''}${n.title}</div><div class="adm-detail">å…¬é–‹: ${pub.toLocaleString()}</div></div><div class="flex gap-2"><button class="btn btn-sm btn-primary" onclick='app.editNews(${JSON.stringify(n)})'>ç·¨é›†</button><button class="btn btn-sm btn-danger" onclick="app.delDoc('announcements','${n.id}')">å‰Šé™¤</button></div></div>`;
                    });
                });
                onSnapshot(query(collection(db,"gifts"), orderBy("createdAt","desc"), limit(20)), s=>{
                    const l=document.getElementById('adm-list-gifts'); l.innerHTML="";
                    s.forEach(d=>{
                        const g=d.data(), st=g.publishAt?toDate(g.publishAt).toLocaleString():"å³æ™‚", ed=g.expireAt?toDate(g.expireAt).toLocaleString():"ç„¡æœŸé™";
                        l.innerHTML+=`<div class="adm-list-item"><div style="flex:1"><div class="font-bold text-sm">${g.val} ${g.type}</div><div class="adm-detail">${g.msg}</div><div class="adm-detail">æœŸé–“: ${st} ï½ ${ed}</div></div><div class="flex gap-2"><button class="btn btn-sm btn-primary" onclick='app.editGift(${JSON.stringify({id:d.id, ...g})})'>ç·¨é›†</button><button class="btn btn-sm btn-danger" onclick="app.delDoc('gifts','${d.id}')">å‰Šé™¤</button></div></div>`;
                    });
                });
            },
            editNews: (n) => {
                document.getElementById('adm-news-id').value=n.id; document.getElementById('adm-news-title').value=n.title;
                document.getElementById('adm-news-body').value=n.body; document.getElementById('adm-news-pin').checked=n.pin;
                if(n.publishAt){ const d=toDate(n.publishAt); d.setMinutes(d.getMinutes()-d.getTimezoneOffset()); document.getElementById('adm-news-date').value=d.toISOString().slice(0,16); } else document.getElementById('adm-news-date').value="";
                newsImgOriginal=n.img; newsImg=null; if(n.img)document.getElementById('adm-news-file-status').innerText="ç”»åƒã‚ã‚Š(ç¶­æŒ)";
                document.getElementById('btn-news-post').innerText="æ›´æ–°(æ–°è¦æŠ•ç¨¿)"; document.getElementById('btn-news-cancel').classList.remove('hidden'); document.querySelector('.scroll-view').scrollTop=0;
            },
            resetNewsForm: () => {
                document.getElementById('adm-news-id').value=""; document.getElementById('adm-news-title').value="";
                document.getElementById('adm-news-body').value=""; document.getElementById('adm-news-pin').checked=false;
                document.getElementById('adm-news-date').value=""; newsImg=null; newsImgOriginal=null;
                document.getElementById('adm-news-file-status').innerText="æœªé¸æŠ";
                document.getElementById('btn-news-post').innerText="é…ä¿¡ç™»éŒ²"; document.getElementById('btn-news-cancel').classList.add('hidden');
            },
            postNews: async () => {
                const id=document.getElementById('adm-news-id').value, ti=document.getElementById('adm-news-title').value, bo=document.getElementById('adm-news-body').value, pi=document.getElementById('adm-news-pin').checked, da=document.getElementById('adm-news-date').value;
                if(!ti) return;
                const d={title:ti, body:bo, pin:pi, createdAt:serverTimestamp()};
                if(newsImg) d.img=newsImg; else if(id && newsImgOriginal) d.img=newsImgOriginal;
                if(da) d.publishAt=Timestamp.fromDate(new Date(da)); else d.publishAt=serverTimestamp();
                if(id) await deleteDoc(doc(db,"announcements",id));
                await addDoc(collection(db,"announcements"), d); app.toast(id?"æ›´æ–°ã—ã¾ã—ãŸ":"é…ä¿¡ã—ã¾ã—ãŸ"); app.resetNewsForm();
            },
            editGift: (g) => {
                document.getElementById('adm-gift-id').value=g.id; document.getElementById('adm-gift-type').value=g.type;
                document.getElementById('adm-gift-val').value=g.val; document.getElementById('adm-gift-msg').value=g.msg;
                const fmt=(ts)=>{if(!ts)return""; const d=toDate(ts); d.setMinutes(d.getMinutes()-d.getTimezoneOffset()); return d.toISOString().slice(0,16);};
                document.getElementById('adm-gift-start').value=fmt(g.publishAt); document.getElementById('adm-gift-end').value=fmt(g.expireAt);
                document.getElementById('btn-gift-post').innerText="æ›´æ–°ã™ã‚‹"; document.getElementById('btn-gift-cancel').classList.remove('hidden');
                document.querySelector('.scroll-view').scrollTop=0;
            },
            resetGiftForm: () => {
                document.getElementById('adm-gift-id').value=""; document.getElementById('adm-gift-val').value=""; document.getElementById('adm-gift-msg').value="";
                document.getElementById('adm-gift-start').value=""; document.getElementById('adm-gift-end').value="";
                document.getElementById('btn-gift-post').innerText="å…¨å“¡ã«é…å¸ƒ"; document.getElementById('btn-gift-cancel').classList.add('hidden');
            },
            distributeGift: async () => {
                const id=document.getElementById('adm-gift-id').value, ty=document.getElementById('adm-gift-type').value, va=parseInt(document.getElementById('adm-gift-val').value), ms=document.getElementById('adm-gift-msg').value, st=document.getElementById('adm-gift-start').value, ed=document.getElementById('adm-gift-end').value;
                if(!va) return;
                const d={type:ty, val:va, msg:ms};
                if(st) d.publishAt=Timestamp.fromDate(new Date(st)); else if(!id) d.publishAt=serverTimestamp();
                if(ed) d.expireAt=Timestamp.fromDate(new Date(ed)); else d.expireAt=null;
                if(id) { await updateDoc(doc(db,"gifts",id), d); app.toast("æ›´æ–°ã—ã¾ã—ãŸ"); }
                else { if(!confirm("å…¨å“¡ã«é…å¸ƒï¼Ÿ")) return; d.to="all"; d.claimedBy=[]; d.createdAt=serverTimestamp(); await addDoc(collection(db,"gifts"), d); app.toast("é…å¸ƒã—ã¾ã—ãŸ"); }
                app.resetGiftForm();
            },
            delDoc: async (c,i) => { if(confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) await deleteDoc(doc(db,c,i)); },

            // OTHER
            handleFileSelect: (i, type) => {
                if(i.files[0]){
                    const reader = new FileReader();
                    reader.onload = e => {
                        const img = new Image(); img.onload = () => {
                            const c = document.createElement('canvas'), MAX=800; let w=img.width, h=img.height;
                            if(w>MAX){h*=MAX/w;w=MAX} c.width=w; c.height=h; c.getContext('2d').drawImage(img,0,0,w,h);
                            const d = c.toDataURL('image/jpeg',0.7);
                            if(type==='chat') { chatImg=d; document.getElementById('chat-preview').style.display='flex'; document.getElementById('chat-preview-img').src=d; }
                            else if(type==='dm') { dmImg=d; document.getElementById('dm-preview').style.display='flex'; document.getElementById('dm-preview-img').src=d; }
                            else { newsImg=d; document.getElementById('adm-news-file-status').innerText="é¸æŠæ¸ˆ"; }
                        }; img.src = e.target.result;
                    }; reader.readAsDataURL(i.files[0]);
                }
            },
            updateProfile: async () => { const n=document.getElementById('set-name').value; if(n){await updateDoc(doc(db,"users",currentUser.username),{name:n}); app.toast("ä¿å­˜ã—ã¾ã—ãŸ");} },
            
            // Check Gifts - Fixed to be error-safe
            checkGifts: async () => {
                try {
                    app.toast("ç¢ºèªä¸­...");
                    const s = await getDocs(query(collection(db,"gifts"), where("to","in",["all",currentUser.username])));
                    let c=0, h=""; const now = new Date();
                    s.forEach(d=>{ 
                        try {
                            const g=d.data(), cl=g.claimedBy||[];
                            const st = g.publishAt ? toDate(g.publishAt) : toDate(g.createdAt);
                            const ed = g.expireAt ? toDate(g.expireAt) : null;
                            if(!cl.includes(currentUser.username) && st <= now && (!ed || ed > now)){ 
                                c++; 
                                h+=`<div class="card flex justify-between items-center" style="padding:10px"><div><b>${g.val} ${g.type}</b><br><small>${g.msg}</small><br><small style="color:var(--text-sub)">æœŸé™: ${ed?ed.toLocaleDateString():'ç„¡æœŸé™'}</small></div><button class="btn btn-sm btn-primary" style="width:auto" onclick="app.claimGift('${d.id}')">å—å–</button></div>`; 
                            }
                        } catch(e) { console.error("Gift parse error", e); }
                    });
                    app.mdl("ãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆBOX", c>0?h:"<p class='text-center text-sub'>å—ã‘å–ã‚Œã‚‹ãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“</p>");
                } catch(e) { app.toast("ã‚¨ãƒ©ãƒ¼: " + e.message); }
            },
            claimGift: async (id) => {
                try {
                    await runTransaction(db, async tr=>{
                        const gd=await tr.get(doc(db,"gifts",id)); if(!gd.exists()) throw "Error";
                        const g=gd.data(), now=new Date();
                        const st = g.publishAt ? toDate(g.publishAt) : toDate(g.createdAt);
                        const ed = g.expireAt ? toDate(g.expireAt) : null;
                        if(st > now || (ed && ed < now)) throw "æœŸé–“å¤–";
                        const cl=g.claimedBy||[]; if(cl.includes(currentUser.username)) throw "æ¸ˆ";
                        cl.push(currentUser.username); tr.update(doc(db,"gifts",id),{claimedBy:cl});
                        tr.update(doc(db,"users",currentUser.username),{[g.type]:increment(g.val)});
                        await app.updateUser({[g.type]:(currentUser[g.type]||0)+g.val}, "å—å–å®Œäº†(ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ¸ˆ)");
                    });
                    app.toast("å—å–å®Œäº†"); app.closeModal();
                } catch(e){ app.toast("ã‚¨ãƒ©ãƒ¼: "+e); }
            },
            // TRADE
            subTrade: () => {
                listeners.push(onSnapshot(query(collection(db,"trades"), where("status","==","open"), orderBy("createdAt","desc"), limit(50)), s=>{
                    const l=document.getElementById('trade-list'); l.innerHTML=""; const now=new Date();
                    s.forEach(d=>{
                        const t=d.data(), me=t.makerUid===currentUser.username;
                        const exp=t.expireAt?toDate(t.expireAt):null; if(exp&&exp<now)return;
                        l.innerHTML+=`<div class="card flex justify-between items-center" style="margin-bottom:8px"><div><div class="text-xs text-sub mb-1">${t.makerName} ${t.passcode?'<span style="color:var(--warning)">ğŸ”’ã‚³ãƒ¼ãƒ‰</span>':''}</div><div class="font-bold">å‡º: ${t.giveVal} ${t.giveType}</div><div class="font-bold" style="color:var(--primary)">æ±‚: ${t.wantVal} ${t.wantType}</div><div class="text-xs text-sub">æœŸé™: ${exp?exp.toLocaleDateString():'ä¸æ˜'}</div></div><button class="btn btn-sm ${me?'btn-danger':'btn-primary'}" style="width:auto" onclick="${me?`app.cancelTrade('${d.id}',${t.giveVal},'${t.giveType}')`:`app.doTrade('${d.id}',${t.wantVal},'${t.wantType}',${t.giveVal},'${t.giveType}','${t.makerUid}','${t.passcode||''}')`}">${me?'å–æ¶ˆ':'äº¤æ›'}</button></div>`;
                    });
                }));
            },
            createTrade: async () => {
                const gt=document.getElementById('tr-give-type').value, gv=parseInt(document.getElementById('tr-give-val').value), wt=document.getElementById('tr-want-type').value, wv=parseInt(document.getElementById('tr-want-val').value), pass=document.getElementById('tr-pass').value.trim();
                if(!gv||!wv) return app.toast("æ•°å€¤ã‚’å…¥åŠ›"); if((currentUser[gt]||0)<gv) return app.toast("ä¸è¶³");
                const exp=new Date(); exp.setDate(exp.getDate()+3);
                await app.updateUser({[gt]:increment(-gv)});
                await addDoc(collection(db,"trades"),{makerUid:currentUser.username, makerName:currentUser.name, giveType:gt, giveVal:gv, wantType:wt, wantVal:wv, passcode:pass, expireAt:Timestamp.fromDate(exp), status:'open', createdAt:serverTimestamp()});
                app.toast("å‡ºå“å®Œäº†"); document.getElementById('tr-pass').value="";
            },
            cancelTrade: async (id,v,t) => { if(confirm("å–æ¶ˆï¼Ÿ")) { await deleteDoc(doc(db,"trades",id)); await app.updateUser({[t]:increment(v)}, "è¿”é‡‘æ¸ˆ"); }},
            doTrade: async (id,payV,payT,getV,getT,maker,pass) => {
                if((currentUser[payT]||0)<payV) return app.toast("ä¸è¶³");
                if(pass && prompt("ã‚ã„ã“ã¨ã°")!==pass) return app.toast("é•ã„ã¾ã™");
                if(!confirm(`äº¤æ›ã—ã¾ã™ã‹ï¼Ÿ\næ”¯æ‰•: ${payV} ${payT}`)) return;
                try {
                    await runTransaction(db, async tr=>{
                        const td=await tr.get(doc(db,"trades",id)); if(!td.exists()) throw "Error";
                        const ref = doc(db, "users", currentUser.username);
                        tr.update(ref,{[payT]:increment(-payV), [getT]:increment(getV)});
                        tr.update(doc(db,"users",maker),{[payT]:increment(payV)});
                        tr.delete(doc(db,"trades",id));
                    });
                    app.toast("æˆç«‹ï¼");
                } catch{ app.toast("å¤±æ•—"); }
            },

            mdl: (t,c) => { document.getElementById('mdl-title').innerText=t; document.getElementById('mdl-content').innerHTML=c; document.getElementById('modal-base').style.display='flex'; },
            closeModal: () => document.getElementById('modal-base').style.display='none',
            toast: (m) => { const e=document.getElementById('toast'); e.innerText=m; e.classList.add('show'); setTimeout(()=>e.classList.remove('show'),3000); }
        };
        window.app = app;
        
        let taps=0; document.getElementById('app-ttl').onclick=()=>{taps++;if(taps>6){taps=0;if(prompt("Code")==="Boss"){app.updateUser({coins:increment(1000)});alert("Bonus");}}};

        app.init();
    </script>
</body>
</html>


