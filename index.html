<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PEER PARTY 50</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Black+Ops+One&family=M+PLUS+Rounded+1c:wght@500;800&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #050510; --main: #00f2ff; --sub: #ff0055; --text: #fff; }
        * { box-sizing: border-box; touch-action: none; user-select: none; -webkit-user-select: none; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: 'M PLUS Rounded 1c', sans-serif; overflow: hidden; height: 100vh; width: 100vw; }

        .screen { position: fixed; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; background: var(--bg); transition: 0.3s; z-index: 10; }
        .hidden { opacity: 0; pointer-events: none; z-index: -1; transform: scale(0.95); }

        h1 { font-family: 'Black Ops One'; font-size: 3rem; color: var(--main); margin: 0; text-shadow: 0 0 15px var(--main); line-height: 1; text-align: center; }
        h2 { color: var(--sub); font-size: 1.2rem; margin: 10px; letter-spacing: 2px; }
        p { color: #aaa; font-size: 0.9rem; margin: 5px; }

        .btn {
            background: rgba(0, 242, 255, 0.1); border: 2px solid var(--main); color: var(--main);
            padding: 15px 40px; font-size: 1.2rem; font-weight: bold; border-radius: 50px;
            margin: 10px; cursor: pointer; width: 80%; max-width: 300px; transition: 0.2s;
        }
        .btn:active { background: var(--main); color: #000; transform: scale(0.96); }
        .btn-p { border-color: var(--sub); color: var(--sub); background: rgba(255, 0, 85, 0.1); }
        .btn-p:active { background: var(--sub); }

        /* HOST LOBBY */
        #room-display { font-size: 5rem; font-family: 'Black Ops One'; color: var(--main); margin: 10px; letter-spacing: 5px; }
        .status-badge { padding: 5px 10px; border-radius: 5px; font-size: 0.8rem; background: #333; margin-bottom: 10px; }
        .s-ok { background: #00b894; color: white; }
        .s-wait { background: #fdcb6e; color: black; }

        /* GAME LIST */
        #game-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; width: 95%; height: 60vh; overflow-y: auto; padding: 10px; }
        .g-card { background: #1a1a1a; border: 1px solid #333; padding: 10px; border-radius: 8px; text-align: center; cursor: pointer; }
        .g-card:active { background: var(--main); color: black; }

        /* GAME STAGE */
        .bar-bg { width: 100%; height: 10px; background: #222; position: fixed; top: 0; }
        .bar-fill { height: 100%; background: var(--sub); width: 100%; }
        .rank-row { display: flex; justify-content: space-between; width: 90%; background: #222; padding: 10px; margin: 5px 0; border-radius: 5px; }
        
        /* CLIENT CONTROLLER */
        .c-full { width: 100%; height: 100%; display: grid; place-items: center; }
        .c-btn { width: 90%; height: 80%; border: none; border-radius: 20px; font-size: 3rem; font-weight: bold; color: white; box-shadow: 0 10px 0 rgba(0,0,0,0.5); }
        .c-btn:active { transform: translateY(10px); box-shadow: none; }
        .bg-r { background: #ff4757; } .bg-b { background: #1e90ff; }
        
        input { font-size: 2rem; text-align: center; background: #222; border: 2px solid #444; color: white; padding: 10px; border-radius: 10px; width: 80%; margin: 10px; text-transform: uppercase; }
    </style>
</head>
<body>

<div id="s-title" class="screen">
    <h1>PEER<br>PARTY</h1>
    <p>PeerJS x Firebase Hybrid</p>
    <div style="margin: 20px; font-size: 0.8rem; color: #666;">50 GAMES INCLUDED</div>
    <button class="btn" onclick="App.initHost()">üëë HOST (ÈÉ®Â±ã‰ΩúÊàê)</button>
    <button class="btn btn-p" onclick="App.initClient()">üì± JOIN (ÂèÇÂä†)</button>
</div>

<div id="s-h-lobby" class="screen hidden">
    <div id="h-status" class="status-badge s-wait">Êé•Á∂öÊ∫ñÂÇô‰∏≠...</div>
    <h2>ROOM ID</h2>
    <div id="room-display">----</div>
    <div id="qrcode" style="background: white; padding: 10px; border-radius: 10px;"></div>
    <p>ÂèÇÂä†ËÄÖ: <span id="p-count" style="color:var(--main); font-size:1.5rem;">0</span> ‰∫∫</p>
    <button class="btn" onclick="Host.toMenu()">„Ç≤„Éº„É†ÈÅ∏Êäû„Å∏</button>
</div>

<div id="s-h-menu" class="screen hidden">
    <h2>SELECT GAME</h2>
    <div id="game-grid"></div>
</div>

<div id="s-h-game" class="screen hidden">
    <div class="bar-bg"><div id="timer-bar" class="bar-fill"></div></div>
    <h2 id="g-name" style="margin-top: 40px; color:white;">GAME</h2>
    <div id="g-main" style="font-size: 5rem; font-family: 'Black Ops One';">READY</div>
    <div id="leaderboard" style="width: 100%; display: flex; flex-direction: column; align-items: center; margin-top: 20px;"></div>
</div>

<div id="s-h-result" class="screen hidden">
    <h1 style="color: var(--sub)">WINNER</h1>
    <div id="res-name" style="font-size: 3rem; margin: 20px;">???</div>
    <div id="res-score" style="font-size: 2rem;">0 PTS</div>
    <button class="btn" onclick="Host.toMenu()">„É°„Éã„É•„Éº„Å∏</button>
</div>

<div id="s-c-login" class="screen hidden">
    <h2>ENTER ROOM ID</h2>
    <input type="text" id="inp-room" placeholder="ID (4ÊñáÂ≠ó)" maxlength="4">
    <input type="text" id="inp-name" placeholder="NAME" maxlength="8">
    <button class="btn btn-p" onclick="Client.join()">ÂèÇÂä†„Åô„Çã</button>
    <p id="c-status" style="height: 20px; color: var(--sub);"></p>
</div>

<div id="s-c-perm" class="screen hidden">
    <h2>„Çª„É≥„Çµ„ÉºË®±ÂèØ</h2>
    <p>iPhone„ÅÆÊñπ„ÅØË®±ÂèØ„ÅåÂøÖË¶Å„Åß„Åô</p>
    <div style="font-size: 3rem;">üì±üîì</div>
    <button class="btn" onclick="Client.grantPerm()">Ë®±ÂèØ„Åó„Å¶„Çπ„Çø„Éº„Éà</button>
</div>

<div id="s-c-wait" class="screen hidden">
    <h2>WAITING...</h2>
    <p>„Éõ„Çπ„Éà„ÅåÊ∫ñÂÇô‰∏≠„Åß„Åô</p>
    <div id="c-conn-stat" class="status-badge s-ok">HOST CONNECTED</div>
</div>

<div id="s-c-ctrl" class="screen hidden">
    <div id="ctrl-area" class="c-full"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getDatabase, ref, set, get, onValue, update, onDisconnect, remove } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

// --- CONFIG ---
const firebaseConfig = {
    apiKey: "AIzaSyDbZzTMvUkG2LXIGY4ux0KBTmnAdqP236s",
    authDomain: "game-4f2d9.firebaseapp.com",
    databaseURL: "https://game-4f2d9-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "game-4f2d9",
    storageBucket: "game-4f2d9.firebasestorage.app",
    messagingSenderId: "574316347824",
    appId: "1:574316347824:web:cf686040628e25ad615675",
    measurementId: "G-T0ZKQCC9L3"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// --- UTILS ---
const $ = id => document.getElementById(id);
const show = id => { document.querySelectorAll('.screen').forEach(e => e.classList.add('hidden')); $(id).classList.remove('hidden'); };
const genId = () => Math.random().toString(36).substr(2, 4).toUpperCase();
const myId = Math.random().toString(36).substr(2, 6);

// --- 50 GAMES DATA (ÂúßÁ∏ÆÁîüÊàê) ---
const GAMES = [];
// 1-10: Basic Tap
for(let i=1; i<=10; i++) GAMES.push({ id:i, type:'tap', name:`ÈÄ£Êâì Lv.${i}`, time:5+(i*2), desc:'„Å≤„Åü„Åô„ÇâÈÄ£ÊâìÔºÅ' });
// 11-20: Shake
for(let i=11; i<=20; i++) GAMES.push({ id:i, type:'shake', name:`„Ç∑„Çß„Ç§„ÇØ Lv.${i-10}`, time:5+(i%5)*3, desc:'„Çπ„Éû„Éõ„ÇíÊåØ„ÇåÔºÅ' });
// 21-30: Squat/Tilt
for(let i=21; i<=30; i++) GAMES.push({ id:i, type:'squat', name:`„Çπ„ÇØ„ÉØ„ÉÉ„Éà No.${i}`, time:15, desc:'„Åó„ÇÉ„Åå„Çì„ÅßÁ´ã„Å¶ÔºÅ' });
// 31-40: Math/Brain
for(let i=31; i<=40; i++) GAMES.push({ id:i, type:'math', name:`ÊöóÁÆó„Éê„Éà„É´ ${i}`, time:20, desc:'Á≠î„Åà„ÇíÈÅ∏„ÅπÔºÅ' });
// 41-50: Variety
GAMES.push({id:41, type:'luck', name:'ÈÅã„Ç≤„Éº', time:5, desc:'ÂΩì„Åü„Çä„ÇíÂºï„Åë'});
GAMES.push({id:42, type:'tap', name:'3ÁßíÈÄ£Êâì', time:3, desc:'Ë∂ÖÈ´òÈÄüÈÄ£ÊâìÔºÅ'});
GAMES.push({id:43, type:'shake', name:'ËÄê‰πÖ„Ç∑„Çß„Ç§„ÇØ', time:30, desc:'ÊåØ„ÇäÁ∂ö„Åë„ÇçÔºÅ'});
GAMES.push({id:44, type:'quiz', name:'4Êäû„ÇØ„Ç§„Ç∫', time:15, desc:'ÊåáÁ§∫„Å´Âæì„Åà'});
GAMES.push({id:45, type:'balance', name:'„Éê„É©„É≥„Çπ', time:15, desc:'Ê∞¥Âπ≥„Çí‰øù„Å¶'});
for(let i=46; i<=50; i++) GAMES.push({ id:i, type:'mix', name:`„Éï„Ç°„Ç§„Éä„É´ ${i}`, time:15, desc:'ÂÖ®Âäõ„ÅßÊåë„ÇÅ' });

// --- GLOBAL VARS ---
let roomId = null;
let peer = null; // PeerJS instance
let conn = null; // Client side connection to host
let connections = {}; // Host side: map of peerId -> dataConnection

// ==========================================
//               APP CONTROLLER
// ==========================================
window.App = {
    initHost: () => {
        Host.init();
    },
    initClient: () => {
        const p = new URLSearchParams(location.search);
        if(p.get('room')) $('inp-room').value = p.get('room');
        show('s-c-login');
    }
};

// ==========================================
//               HOST LOGIC
// ==========================================
window.Host = {
    players: {}, // { peerId: { name: "Bob", score: 0 } }
    
    init: () => {
        show('s-h-lobby');
        $('h-status').innerText = "PeerJS„Çµ„Éº„Éê„ÉºÊé•Á∂ö‰∏≠...";
        $('h-status').className = "status-badge s-wait";

        // 1. PeerJS Init
        peer = new Peer();

        peer.on('open', (id) => {
            // PeerIDÂèñÂæóÂæå„Å´FirebaseÈÉ®Â±ã‰ΩúÊàê
            roomId = genId();
            const r = ref(db, `rooms/${roomId}`);
            
            set(r, {
                hostPeerId: id, // „ÇØ„É©„Ç§„Ç¢„É≥„Éà„ÅØ„Åì„Çå„ÇíË¶ã„Å¶connect„Åô„Çã
                status: 'lobby',
                createdAt: Date.now()
            }).then(() => {
                // UI Update
                $('room-display').innerText = roomId;
                $('h-status').innerText = "Êé•Á∂öÂæÖÊ©ü‰∏≠ (OK)";
                $('h-status').className = "status-badge s-ok";
                new QRCode($('qrcode'), { text: `${location.href.split('?')[0]}?room=${roomId}`, width: 128, height: 128 });

                // ÂàáÊñ≠ÊôÇ„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó
                onDisconnect(r).remove();
            });
        });

        peer.on('error', (err) => {
            alert("PeerJS Error: " + err.type);
            $('h-status').innerText = "„Ç®„É©„ÉºÁô∫Áîü";
        });

        // 2. „ÇØ„É©„Ç§„Ç¢„É≥„Éà„Åã„Çâ„ÅÆÊé•Á∂öÂæÖ„Å°
        peer.on('connection', (c) => {
            c.on('open', () => {
                connections[c.peer] = c;
                
                // „Éá„Éº„ÇøÂèó‰ø° (Input from Client)
                c.on('data', (data) => {
                    Host.handleData(c.peer, data);
                });

                // ÂàáÊñ≠Ê§úÁü•
                c.on('close', () => {
                    delete connections[c.peer];
                    delete Host.players[c.peer];
                    Host.updateLobbyCount();
                });
            });
        });
    },

    handleData: (peerId, data) => {
        // data = { type: 'join', name: '...' } OR { type: 'action', val: 1 }
        if (data.type === 'join') {
            Host.players[peerId] = { name: data.name, score: 0 };
            Host.updateLobbyCount();
        } 
        else if (data.type === 'action') {
            if (Host.players[peerId]) {
                Host.players[peerId].score += data.val;
            }
        }
    },

    updateLobbyCount: () => {
        $('p-count').innerText = Object.keys(Host.players).length;
    },

    toMenu: () => {
        show('s-h-menu');
        const g = $('game-grid');
        g.innerHTML = GAMES.map(game => `
            <div class="g-card" onclick="Host.startGame(${game.id})">
                <div style="font-size:2rem;">${game.id}</div>
                <div>${game.name}</div>
                <div style="font-size:0.7rem; color:#888;">${game.desc}</div>
            </div>
        `).join('');
        
        // ÂÖ®„ÇØ„É©„Ç§„Ç¢„É≥„Éà„Å´„É°„Éã„É•„ÉºÁîªÈù¢„Å∏ÈÅ∑Áßª„Åô„Çã„Çà„ÅÜÈÄöÁü•ÔºàÂøÖË¶Å„Å™„ÇâÔºâ
        Host.broadcast({ type: 'state', status: 'menu' });
    },

    startGame: (gameId) => {
        const game = GAMES.find(g => g.id === gameId);
        show('s-h-game');
        $('g-name').innerText = game.name;
        $('g-main').innerText = "READY";
        $('leaderboard').innerHTML = "";

        // „Çπ„Ç≥„Ç¢„É™„Çª„ÉÉ„Éà
        Object.keys(Host.players).forEach(pid => Host.players[pid].score = 0);

        // „ÇØ„É©„Ç§„Ç¢„É≥„Éà„Å∏ÈñãÂßãÈÄöÁü• (PeerJS„ÅßÈÄÅ‰ø°)
        Host.broadcast({ 
            type: 'start', 
            game: game 
        });

        // „Ç´„Ç¶„É≥„Éà„ÉÄ„Ç¶„É≥
        let cd = 3;
        const cdt = setInterval(() => {
            if(cd > 0) $('g-main').innerText = cd--;
            else {
                clearInterval(cdt);
                $('g-main').innerText = "GO!";
                Host.gameLoop(game.time);
            }
        }, 1000);
    },

    gameLoop: (seconds) => {
        let left = seconds;
        const max = seconds;
        
        const loop = setInterval(() => {
            left -= 0.1;
            $('timer-bar').style.width = (left / max * 100) + "%";

            // „É™„Ç¢„É´„Çø„Ç§„É†„É©„É≥„Ç≠„É≥„Ç∞Êõ¥Êñ∞
            const sorted = Object.values(Host.players).sort((a,b) => b.score - a.score);
            $('leaderboard').innerHTML = sorted.slice(0, 3).map((p, i) => `
                <div class="rank-row">
                    <span>#${i+1} ${p.name}</span>
                    <span>${Math.floor(p.score)}</span>
                </div>
            `).join('');

            if(left <= 0) {
                clearInterval(loop);
                Host.finishGame(sorted[0]);
            }
        }, 100);
    },

    finishGame: (winner) => {
        Host.broadcast({ type: 'end' });
        show('s-h-result');
        $('res-name').innerText = winner ? winner.name : "NO WINNER";
        $('res-score').innerText = winner ? Math.floor(winner.score) + " PTS" : "";
    },

    broadcast: (msg) => {
        Object.values(connections).forEach(c => c.send(msg));
    }
};

// ==========================================
//               CLIENT LOGIC
// ==========================================
window.Client = {
    name: "Guest",
    score: 0,
    currGame: null,
    
    join: async () => {
        const rid = $('inp-room').value.toUpperCase();
        Client.name = $('inp-name').value || "Guest";
        
        if (rid.length !== 4) return alert("4ÊñáÂ≠ó„ÅÆID„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ");
        
        $('c-status').innerText = "ÈÉ®Â±ã„ÇíÊé¢„Åó„Å¶„ÅÑ„Åæ„Åô...";

        // 1. Firebase„Åã„ÇâÈÉ®Â±ãÊÉÖÂ†±„ÇíÂèñÂæó
        const snap = await get(ref(db, `rooms/${rid}`));
        
        if (!snap.exists()) {
            $('c-status').innerText = "ÈÉ®Â±ã„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì (IDÁ¢∫Ë™ç)";
            return;
        }

        const roomData = snap.val();
        if (!roomData.hostPeerId) {
            $('c-status').innerText = "„Éõ„Çπ„Éà„ÅÆÊ∫ñÂÇô„ÅåÂÆå‰∫Ü„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì";
            return;
        }

        // 2. PeerJSÂàùÊúüÂåñ & „Éõ„Çπ„Éà„Å∏Êé•Á∂ö
        $('c-status').innerText = "PeerJS„Çµ„Éº„Éê„Éº„Å∏Êé•Á∂ö‰∏≠...";
        peer = new Peer();

        peer.on('open', (id) => {
            $('c-status').innerText = "„Éõ„Çπ„Éà„Å∏Êé•Á∂ö‰∏≠...";
            conn = peer.connect(roomData.hostPeerId);

            conn.on('open', () => {
                // Êé•Á∂öÊàêÂäü -> ÂêçÂâçÈÄÅ‰ø°
                conn.send({ type: 'join', name: Client.name });
                
                // „Çª„É≥„Çµ„Éº„ÉÅ„Çß„ÉÉ„ÇØ
                if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
                    show('s-c-perm');
                } else {
                    Client.wait();
                }
            });

            conn.on('data', (data) => {
                Client.handleHostData(data);
            });
            
            conn.on('close', () => alert("„Éõ„Çπ„Éà„Å®„ÅÆÊé•Á∂ö„ÅåÂàá„Çå„Åæ„Åó„Åü"));
            conn.on('error', () => alert("Êé•Á∂ö„Ç®„É©„Éº"));
        });
        
        peer.on('error', (e) => $('c-status').innerText = "ÈÄö‰ø°„Ç®„É©„Éº: " + e.type);
    },

    grantPerm: () => {
        DeviceMotionEvent.requestPermission().then(r => {
            if (r==='granted') Client.wait();
            else alert("„Çª„É≥„Çµ„ÉºÊ®©Èôê„ÅåÂøÖË¶Å„Åß„Åô");
        }).catch(e => alert(e));
    },

    wait: () => {
        show('s-c-wait');
        Client.initSensors();
    },

    handleHostData: (data) => {
        if (data.type === 'start') {
            Client.setupController(data.game);
        } else if (data.type === 'end') {
            show('s-c-wait');
        }
    },

    setupController: (game) => {
        show('s-c-ctrl');
        const area = $('ctrl-area');
        area.innerHTML = "";
        Client.currGame = game;

        if (game.type === 'tap' || game.type === 'mix') {
            area.innerHTML = `<button class="c-btn bg-r" ontouchstart="Client.send(1)">PUSH!</button>`;
        } else if (game.type === 'math') {
            // Á∞°ÊòìË®àÁÆó
            const n1 = Math.floor(Math.random()*9)+1;
            const n2 = Math.floor(Math.random()*9)+1;
            area.innerHTML = `
                <div style="font-size:3rem; color:white; margin-bottom:20px;">${n1} + ${n2} = ?</div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; width:100%;">
                    <button class="c-btn bg-b" style="font-size:2rem" onclick="Client.ans(${n1+n2}, ${n1+n2})">${n1+n2}</button>
                    <button class="c-btn bg-r" style="font-size:2rem" onclick="Client.ans(${n1+n2+1}, ${n1+n2})">${n1+n2+1}</button>
                </div>`;
        } else {
            // „Çª„É≥„Çµ„ÉºÁ≥ª
            area.innerHTML = `<div style="font-size:2rem; color:white; text-align:center;">${game.desc}<br><br>MOVE!</div>`;
        }
    },

    ans: (val, correct) => {
        if(val === correct) Client.send(1);
        else Client.send(-1);
        // Ê¨°„ÅÆÂïèÈ°å„Å∏ÔºàÁ∞°Êòì„É™„É≠„Éº„ÉâÔºâ
        setTimeout(() => Client.setupController(Client.currGame), 200);
    },

    send: (val) => {
        if (conn && conn.open) {
            conn.send({ type: 'action', val: val });
            if(navigator.vibrate) navigator.vibrate(30);
        }
    },

    initSensors: () => {
        let lastX=0, lastY=0, lastZ=0;
        let squatState = 'up';
        
        window.addEventListener('devicemotion', e => {
            if(!Client.currGame) return;
            const t = Client.currGame.type;
            const acc = e.accelerationIncludingGravity;
            if(!acc) return;

            if (t === 'shake') {
                const d = Math.abs(acc.x+acc.y+acc.z - lastX-lastY-lastZ);
                if(d > 20) Client.send(1);
                lastX=acc.x; lastY=acc.y; lastZ=acc.z;
            } else if (t === 'squat') {
                if(squatState==='up' && acc.y < 4) squatState='down';
                if(squatState==='down' && acc.y > 8) { squatState='up'; Client.send(1); }
            }
        });
        
        window.addEventListener('deviceorientation', e => {
            if(!Client.currGame) return;
            if (Client.currGame.type === 'balance') {
                 if (Math.abs(e.beta) < 10 && Math.abs(e.gamma) < 10) {
                     if(Math.random()>0.9) Client.send(1);
                 } else {
                     if(Math.random()>0.9) Client.send(-1);
                 }
            }
        });
    }
};
</script>
</body>
</html>
