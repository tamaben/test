<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>AIäººç‹¼ V15 - ãƒœã‚¤ã‚¹å¯¾å¿œç‰ˆ</title>
    <style>
        /* --- åŸºæœ¬ãƒ‡ã‚¶ã‚¤ãƒ³ --- */
        body {
            background-color: #121212;
            color: #ffffff;
            font-family: sans-serif;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            text-align: center;
        }
        
        #app {
            width: 95%;
            max-width: 500px;
            background: #1e1e1e;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            min-height: 400px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        h1 { color: #ff4757; margin-top: 0; font-size: 24px; }
        .status-bar { color: #ffa502; font-weight: bold; margin-bottom: 10px; }

        /* ãƒœã‚¿ãƒ³ */
        button {
            background: #3742fa; color: white; border: none; padding: 15px;
            font-size: 18px; font-weight: bold; border-radius: 8px;
            width: 100%; margin-top: 15px; cursor: pointer;
        }
        button:active { opacity: 0.8; }
        button.action { background: #ff4757; }
        button.next { background: #2ed573; color: #000; }

        /* å…¥åŠ›ãƒ»ãƒªã‚¹ãƒˆ */
        input, select {
            width: 100%; padding: 12px; margin: 5px 0 15px 0; border-radius: 5px;
            border: 1px solid #555; background: #2f3542; color: white; font-size: 16px; box-sizing: border-box;
        }
        .player-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin: 15px 0; }
        .player-card { background: #2f3542; padding: 10px; border-radius: 5px; font-size: 14px; }
        .player-card.dead { opacity: 0.4; text-decoration: line-through; background: #000; }

        /* ãƒ­ã‚°ã‚¨ãƒªã‚¢ (ä¼šè©±è¡¨ç¤ºç”¨) */
        #log-box {
            background: #000; height: 150px; overflow-y: auto; text-align: left;
            padding: 10px; font-size: 13px; border: 1px solid #444; border-radius: 5px;
            margin-bottom: 10px; display: flex; flex-direction: column-reverse; /* æ–°ã—ã„ã‚‚ã®ã‚’ä¸‹ã« */
        }
        .log-ai { color: #ffa502; margin: 2px 0; }
        .log-human { color: #00a8ff; font-weight: bold; margin: 2px 0; border-left: 3px solid #00a8ff; padding-left: 5px; }
        .log-sys { color: #ccc; font-size: 11px; margin: 2px 0; }

        /* ãƒã‚¤ã‚¯ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ */
        .mic-status {
            color: #ff4757; font-weight: bold; animation: blink 1.5s infinite;
            display: none; margin-bottom: 5px;
        }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }
    </style>
</head>
<body>

    <div id="app"></div>

    <script>
        class WerewolfGame {
            constructor() {
                this.app = document.getElementById('app');
                
                // éŸ³å£°èªè­˜ã®æº–å‚™
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (SpeechRecognition) {
                    this.recognition = new SpeechRecognition();
                    this.recognition.lang = 'ja-JP';
                    this.recognition.continuous = true;
                    this.recognition.interimResults = false;

                    this.recognition.onresult = (event) => {
                        const transcript = event.results[event.results.length - 1][0].transcript;
                        this.addLog(`ã‚ãªãŸ: ${transcript}`, 'human');
                    };
                    this.recognition.onerror = (event) => {
                        console.log("ãƒã‚¤ã‚¯ã‚¨ãƒ©ãƒ¼:", event.error);
                    };
                    this.hasMic = true;
                } else {
                    this.hasMic = false;
                }

                this.reset();
            }

            reset() {
                this.players = [];
                this.day = 1;
                this.phase = 'SETUP';
                this.queue = [];
                this.queueIndex = 0;
                this.timer = null;
                this.logs = []; // ãƒ­ã‚°ãƒ‡ãƒ¼ã‚¿
                this.renderSetup();
            }

            /* --- ãƒ­ã‚°ç®¡ç† --- */
            addLog(text, type = 'sys') {
                // é…åˆ—ã®å…ˆé ­ã«è¿½åŠ ï¼ˆè¡¨ç¤ºã¯flex-direction: column-reverseã§åˆ¶å¾¡ï¼‰
                this.logs.unshift({ text, type });
                this.updateLogDisplay();
            }

            updateLogDisplay() {
                const box = document.getElementById('log-box');
                if (!box) return;
                box.innerHTML = this.logs.map(l => 
                    `<div class="log-${l.type}">${l.text}</div>`
                ).join('');
            }

            /* --- ç”»é¢æç”» --- */
            renderSetup() {
                this.app.innerHTML = `
                    <h1>AIäººç‹¼ V15 <span style="font-size:12px">Voice</span></h1>
                    <p>è¨­å®šã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
                    <label>ç·äººæ•° (5ã€œ10äºº)</label>
                    <input type="number" id="total" value="5" min="5" max="10">
                    <label>äººé–“ã®æ•°</label>
                    <input type="number" id="humans" value="1" min="1" max="10">
                    <button onclick="game.setupNames()">æ¬¡ã¸</button>
                `;
            }

            setupNames() {
                const total = parseInt(document.getElementById('total').value);
                const humans = parseInt(document.getElementById('humans').value);
                if (humans > total) return alert("äººé–“ã®æ•°ãŒå¤šã™ãã¾ã™");

                let html = `<h1>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å</h1>`;
                for (let i = 0; i < humans; i++) {
                    html += `<input type="text" id="name_${i}" value="ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${i+1}">`;
                }
                html += `<button onclick="game.startGame(${total}, ${humans})">ã‚²ãƒ¼ãƒ é–‹å§‹</button>`;
                this.app.innerHTML = html;
            }

            startGame(total, humans) {
                const humanNames = [];
                for (let i = 0; i < humans; i++) {
                    humanNames.push(document.getElementById(`name_${i}`).value || `P${i+1}`);
                }
                const aiNames = ["ã‚¿ãƒŠã‚«", "ã‚µãƒˆã‚¦", "ã‚¹ã‚ºã‚­", "ã‚¤ãƒˆã‚¦", "ãƒ¯ã‚¿ãƒŠãƒ™", "ãƒ¤ãƒãƒ¢ãƒˆ"];
                
                this.players = [];
                humanNames.forEach(name => this.players.push({ name: name, isAI: false, alive: true, role: '', target: -1, votes: 0 }));
                while (this.players.length < total) {
                    const name = aiNames[(this.players.length - humans) % aiNames.length];
                    this.players.push({ name: name + "(AI)", isAI: true, alive: true, role: '', target: -1, votes: 0 });
                }

                const roles = ['äººç‹¼', 'å ã„å¸«'];
                if (total >= 8) roles.push('äººç‹¼');
                while (roles.length < total) roles.push('æ‘äºº');
                
                for (let i = roles.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [roles[i], roles[j]] = [roles[j], roles[i]];
                }
                this.players.forEach((p, i) => p.role = roles[i]);

                this.addLog("--- ã‚²ãƒ¼ãƒ é–‹å§‹ ---");
                this.startNight();
            }

            /* --- å¤œãƒ•ã‚§ãƒ¼ã‚º --- */
            startNight() {
                this.phase = 'NIGHT';
                this.queue = this.players.map((p, i) => ({ ...p, idx: i })).filter(p => !p.isAI && p.alive).map(p => p.idx);
                this.queueIndex = 0;
                this.players.forEach(p => p.target = -1);
                this.processNightQueue();
            }

            processNightQueue() {
                if (this.queueIndex >= this.queue.length) {
                    this.runAINightAction();
                    this.startMorning();
                    return;
                }
                const p = this.players[this.queue[this.queueIndex]];
                this.app.innerHTML = `
                    <h1>${this.day}æ—¥ç›®ï¼šå¤œ</h1>
                    <h2 style="color:#00a8ff;">${p.name} ã•ã‚“ã®ç•ª</h2>
                    <p>ã“ã®ç”»é¢ã‚’ ${p.name} ã•ã‚“ã«æ¸¡ã—ã¦ãã ã•ã„</p>
                    <button class="next" onclick="game.showNightAction(${this.queue[this.queueIndex]})">ç¢ºèªã™ã‚‹</button>
                `;
            }

            showNightAction(idx) {
                const p = this.players[idx];
                const targets = this.players.map((tp, i) => ({ ...tp, idx: i })).filter(tp => tp.alive && tp.idx !== idx);
                let options = targets.map(t => `<option value="${t.idx}">${t.name}</option>`).join('');
                let html = `<h2>ã‚ãªãŸã®å½¹è·ï¼š${p.role}</h2>`;

                if (p.role === 'äººç‹¼') html += `<p>è¥²æ’ƒå…ˆã‚’é¸ã‚“ã§ãã ã•ã„</p><select id="target">${options}</select>`;
                else if (p.role === 'å ã„å¸«') html += `<p>å ã†ç›¸æ‰‹ã‚’é¸ã‚“ã§ãã ã•ã„</p><select id="target">${options}</select>`;
                else html += `<p>æ‘äººã¯è¡Œå‹•ãŒã‚ã‚Šã¾ã›ã‚“ã€‚<br>é©å½“ãªæ™‚é–“å¾…ã£ã¦ã‹ã‚‰æ¬¡ã¸é€²ã‚“ã§ãã ã•ã„ã€‚</p>`;

                this.app.innerHTML = `<h1>å¤œã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</h1>${html}<button class="action" onclick="game.submitNightAction(${idx}, '${p.role}')">æ±ºå®š</button>`;
            }

            submitNightAction(idx, role) {
                if (role === 'äººç‹¼' || role === 'å ã„å¸«') {
                    const tid = parseInt(document.getElementById('target').value);
                    this.players[idx].target = tid;
                    if (role === 'å ã„å¸«') {
                        const res = (this.players[tid].role === 'äººç‹¼') ? 'äººç‹¼' : 'äººé–“';
                        alert(`å ã„çµæœï¼š${this.players[tid].name} ã¯ ã€${res}ã€‘ ã§ã—ãŸ`);
                    }
                }
                this.queueIndex++;
                this.processNightQueue();
            }

            runAINightAction() {
                this.players.forEach(p => {
                    if (p.isAI && p.alive && p.role === 'äººç‹¼') {
                        const t = this.players.map((tp, i) => ({...tp, idx:i})).filter(tp => tp.alive && tp.role !== 'äººç‹¼');
                        if (t.length) p.target = t[Math.floor(Math.random() * t.length)].idx;
                    }
                });
            }

            /* --- æœãƒ»è­°è«–ãƒ•ã‚§ãƒ¼ã‚º --- */
            startMorning() {
                const votes = {};
                this.players.forEach(p => {
                    if (p.alive && p.role === 'äººç‹¼' && p.target !== -1) votes[p.target] = (votes[p.target] || 0) + 1;
                });
                
                let victim = -1, max = 0;
                for (const [id, cnt] of Object.entries(votes)) {
                    if (cnt > max) { max = cnt; victim = parseInt(id); }
                }

                let msg = "æ˜¨å¤œã¯èª°ã‚‚æ­»ã«ã¾ã›ã‚“ã§ã—ãŸã€‚";
                if (victim !== -1) {
                    this.players[victim].alive = false;
                    msg = `æ˜¨å¤œã®çŠ ç‰²è€…ã¯ ${this.players[victim].name} ã§ã—ãŸã€‚`;
                }
                this.addLog(msg);
                this.speak(msg);

                if (this.checkGameOver()) return;

                this.app.innerHTML = `
                    <h1>${this.day}æ—¥ç›®ï¼šæœ</h1>
                    <p>${msg}</p>
                    ${this.getPlayerGrid()}
                    <button class="next" onclick="game.startDiscuss()">è­°è«–ã¸é€²ã‚€</button>
                `;
            }

            startDiscuss() {
                let timeLeft = 60;
                
                // ãƒã‚¤ã‚¯é–‹å§‹
                if (this.hasMic) this.recognition.start();

                const renderDiscuss = () => {
                    this.app.innerHTML = `
                        <h1>è­°è«–ä¸­</h1>
                        <h2 id="timer" style="font-size:50px;">${timeLeft}</h2>
                        <div class="mic-status" ${this.hasMic ? 'style="display:block"' : ''}>ğŸ¤ ä¼šè©±ã‚’èãå–ã£ã¦ã„ã¾ã™...</div>
                        <div id="log-box"></div>
                        <p style="font-size:12px;">è©±ã—åˆã£ã¦ãã ã•ã„ã€‚ã‚ãªãŸã®å£°ã‚‚è¨˜éŒ²ã•ã‚Œã¾ã™ã€‚</p>
                        <button class="action" onclick="game.endDiscuss()">æŠ•ç¥¨ã¸é€²ã‚€</button>
                    `;
                    this.updateLogDisplay();
                };
                renderDiscuss();

                this.timer = setInterval(() => {
                    timeLeft--;
                    const tEl = document.getElementById('timer');
                    if (tEl) tEl.innerText = timeLeft;

                    // AIç™ºè¨€
                    if (timeLeft % 15 === 0 && timeLeft > 0) {
                        const ai = this.players.filter(p => p.isAI && p.alive);
                        if (ai.length) {
                            const spk = ai[Math.floor(Math.random() * ai.length)];
                            const txt = ["æ€ªã—ã„äººã¯èª°ã§ã™ã‹ï¼Ÿ", "ç§ã¯æ‘äººã§ã™ã€‚", "å ã„å¸«ã•ã‚“ã¯ï¼Ÿ", "æŠ•ç¥¨æ‚©ã¿ã¾ã™ã­..."][Math.floor(Math.random()*4)];
                            this.speak(txt);
                            this.addLog(`${spk.name}: ${txt}`, 'ai');
                        }
                    }

                    if (timeLeft <= 0) this.endDiscuss();
                }, 1000);
            }

            endDiscuss() {
                clearInterval(this.timer);
                if (this.hasMic) this.recognition.stop();
                this.speak("è­°è«–çµ‚äº†ã§ã™ã€‚");
                this.startVoteSetup();
            }

            /* --- æŠ•ç¥¨ãƒ•ã‚§ãƒ¼ã‚º --- */
            startVoteSetup() {
                this.queue = this.players.map((p, i) => ({ ...p, idx: i })).filter(p => !p.isAI && p.alive).map(p => p.idx);
                this.queueIndex = 0;
                this.players.forEach(p => p.target = -1);
                this.processVoteQueue();
            }

            processVoteQueue() {
                if (this.queueIndex >= this.queue.length) {
                    this.calcVote();
                    return;
                }
                const p = this.players[this.queue[this.queueIndex]];
                this.app.innerHTML = `
                    <h1>æŠ•ç¥¨</h1>
                    <h2 style="color:#00a8ff;">${p.name} ã•ã‚“ã®ç•ª</h2>
                    <p>ä»–ã®äººã¯è¦‹ãªã„ã§ãã ã•ã„</p>
                    <button class="next" onclick="game.showVoteAction(${this.queue[this.queueIndex]})">æŠ•ç¥¨ã™ã‚‹</button>
                `;
            }

            showVoteAction(idx) {
                const targets = this.players.map((tp, i) => ({ ...tp, idx: i })).filter(tp => tp.alive && tp.idx !== idx);
                let options = targets.map(t => `<option value="${t.idx}">${t.name}</option>`).join('');
                this.app.innerHTML = `
                    <h1>æŠ•ç¥¨</h1>
                    <p>è¿½æ”¾ã—ãŸã„äººã‚’é¸ã‚“ã§ãã ã•ã„</p>
                    <select id="vt">${options}</select>
                    <button class="action" onclick="game.submitVote(${idx})">æ±ºå®š</button>
                `;
            }

            submitVote(idx) {
                this.players[idx].target = parseInt(document.getElementById('vt').value);
                this.queueIndex++;
                this.processVoteQueue();
            }

            calcVote() {
                const alive = this.players.map((p, i) => ({...p, idx:i})).filter(p => p.alive);
                // AIæŠ•ç¥¨
                this.players.forEach(p => {
                    p.votes = 0;
                    if(p.isAI && p.alive) {
                        const t = alive.filter(v => v.idx !== this.players.indexOf(p));
                        p.target = t[Math.floor(Math.random()*t.length)].idx;
                    }
                });
                // é›†è¨ˆ
                this.players.forEach(p => {
                    if(p.alive && p.target !== -1) this.players[p.target].votes++;
                });
                // çµæœ
                let max = -1, candidates = [];
                this.players.forEach((p, i) => {
                    if(p.alive) {
                        if(p.votes > max) { max = p.votes; candidates = [i]; }
                        else if(p.votes === max) candidates.push(i);
                    }
                });
                
                const executedIdx = candidates[Math.floor(Math.random()*candidates.length)];
                this.players[executedIdx].alive = false;
                const msg = `${this.players[executedIdx].name} ãŒè¿½æ”¾ã•ã‚Œã¾ã—ãŸã€‚`;
                this.addLog(msg);
                this.speak(msg);

                if (this.checkGameOver()) return;

                this.app.innerHTML = `
                    <h1>æŠ•ç¥¨çµæœ</h1>
                    <p style="font-size:18px; font-weight:bold;">${msg}</p>
                    ${this.getPlayerGrid()}
                    <button class="next" onclick="game.nextDay()">æ¬¡ã®å¤œã¸</button>
                `;
            }

            nextDay() {
                this.day++;
                this.startNight();
            }

            checkGameOver() {
                const w = this.players.filter(p => p.alive && p.role === 'äººç‹¼').length;
                const v = this.players.filter(p => p.alive && p.role !== 'äººç‹¼').length;
                let res = "";
                if (w === 0) res = "æ‘äººé™£å–¶ã®å‹åˆ©ï¼";
                else if (w >= v) res = "äººç‹¼é™£å–¶ã®å‹åˆ©ï¼";
                
                if (res) {
                    this.app.innerHTML = `<h1>ã‚²ãƒ¼ãƒ çµ‚äº†</h1><h2>${res}</h2>${this.getPlayerGrid(true)}<button onclick="location.reload()">TOPã¸</button>`;
                    return true;
                }
                return false;
            }

            getPlayerGrid(showRole = false) {
                let html = '<div class="player-grid">';
                this.players.forEach(p => {
                    const st = p.alive ? (p.isAI ? '' : 'border:2px solid #00a8ff') : 'opacity:0.4; text-decoration:line-through; background:#000;';
                    const role = (showRole || !p.alive) ? `<br>[${p.role}]` : '';
                    html += `<div class="player-card" style="${st}">${p.name}${role}</div>`;
                });
                return html + '</div>';
            }

            speak(text) {
                if ('speechSynthesis' in window) {
                    window.speechSynthesis.cancel();
                    const uttr = new SpeechSynthesisUtterance(text);
                    uttr.lang = "ja-JP";
                    window.speechSynthesis.speak(uttr);
                }
            }
        }

        const game = new WerewolfGame();
    </script>
</body>
</html>
