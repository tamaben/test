<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HYPER PARTY 100</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Anton&family=M+PLUS+Rounded+1c:wght@800&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #121212; --primary: #00ff9d; --accent: #ff0055; --text: #ffffff; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: 'M PLUS Rounded 1c', sans-serif; overflow: hidden; height: 100vh; touch-action: manipulation; user-select: none; -webkit-user-select: none; }
        
        /* ç”»é¢ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
        .screen { position: fixed; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.3s; background: radial-gradient(circle at center, #2a2a2a 0%, #000 100%); z-index: 1; }
        .hidden { opacity: 0; pointer-events: none; z-index: -1; }
        
        /* ã‚¿ã‚¤ãƒã‚°ãƒ©ãƒ•ã‚£ */
        h1 { font-family: 'Anton', sans-serif; font-size: 4rem; margin: 0; line-height: 1; text-transform: uppercase; letter-spacing: 2px; text-shadow: 4px 4px 0px var(--accent); }
        h2 { color: var(--primary); margin: 10px 0; font-size: 1.5rem; }
        .big-text { font-size: 3rem; font-weight: bold; margin: 20px 0; text-align: center; }
        
        /* UIãƒ‘ãƒ¼ãƒ„ */
        .btn { background: transparent; color: var(--primary); border: 2px solid var(--primary); padding: 15px 40px; font-size: 1.2rem; font-weight: bold; border-radius: 50px; cursor: pointer; margin: 10px; transition: 0.2s; text-transform: uppercase; box-shadow: 0 0 10px rgba(0, 255, 157, 0.2); }
        .btn:active { background: var(--primary); color: #000; transform: scale(0.95); }
        .btn-start { background: var(--accent); color: white; border: none; font-size: 1.5rem; padding: 20px 60px; box-shadow: 0 5px 0 #900; }
        .btn-start:active { transform: translateY(5px); box-shadow: none; }

        input { background: #333; border: 2px solid #555; color: white; padding: 15px; font-size: 1.5rem; text-align: center; border-radius: 10px; width: 200px; text-transform: uppercase; margin-bottom: 10px; }

        /* ã‚²ãƒ¼ãƒ ç”»é¢ */
        #timer-bar { position: fixed; top: 0; left: 0; height: 15px; background: var(--accent); width: 100%; transition: width 0.1s linear; }
        .rank-list { text-align: left; width: 80%; max-width: 400px; background: rgba(255,255,255,0.1); padding: 20px; border-radius: 10px; margin-top: 20px; }
        .rank-item { display: flex; justify-content: space-between; border-bottom: 1px solid #555; padding: 5px 0; font-size: 1.2rem; }

        /* ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ */
        .ctrl-btn { width: 280px; height: 280px; border-radius: 50%; border: none; font-size: 2.5rem; font-weight: 900; color: white; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 0 rgba(0,0,0,0.5); transition: transform 0.05s; }
        .bg-red { background: #ff4757; box-shadow: 0 10px 0 #c41e3a; }
        .bg-blue { background: #3742fa; box-shadow: 0 10px 0 #2f3542; }
        .bg-green { background: #2ed573; box-shadow: 0 10px 0 #27ae60; }
        .ctrl-btn:active { transform: translateY(10px); box-shadow: none; }
        
        .instruction { font-size: 4rem; font-weight: bold; color: var(--primary); animation: blink 0.5s infinite alternate; }
        @keyframes blink { from { opacity: 1; } to { opacity: 0.5; } }
    </style>
</head>
<body>

    <div id="s-top" class="screen">
        <h1>100 GAMES<br>RUSH</h1>
        <p>PCã¨ã‚¹ãƒãƒ›ã§éŠã¶ãƒ‘ãƒ¼ãƒ†ã‚£ã‚²ãƒ¼ãƒ </p>
        <div style="margin-top:30px;">
            <button id="btn-host" class="btn">ğŸ’» ãƒ›ã‚¹ãƒˆ (PC)</button>
            <button id="btn-client" class="btn">ğŸ“± å‚åŠ ã™ã‚‹ (ã‚¹ãƒãƒ›)</button>
        </div>
    </div>

    <div id="s-h-lobby" class="screen hidden">
        <h2>ROOM ID</h2>
        <div id="disp-room-id" style="font-size:5rem; font-weight:900; color:var(--primary);">----</div>
        <div id="qrcode" style="background:white; padding:10px; border-radius:10px; margin:20px;"></div>
        <p>å‚åŠ äººæ•°: <span id="disp-p-count" style="font-size:2rem; font-weight:bold;">0</span> äºº</p>
        <button id="btn-start-game" class="btn btn-start">ã‚¹ã‚¿ãƒ¼ãƒˆï¼</button>
        <p style="font-size:0.8rem; color:#888;">å…¨100ç¨®é¡ã®ãƒŸãƒ‹ã‚²ãƒ¼ãƒ ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã«å‡ºé¡Œã•ã‚Œã¾ã™</p>
    </div>

    <div id="s-h-game" class="screen hidden">
        <div id="timer-bar"></div>
        <div style="margin-top:50px; font-size:1.5rem; color:#888;">GAME <span id="game-index">1</span>/100</div>
        <h1 id="game-title" style="font-size:3.5rem; color:var(--primary); margin:20px 0;">TITLE</h1>
        <div id="game-desc" style="font-size:2rem;">ãƒ«ãƒ¼ãƒ«èª¬æ˜</div>
        
        <div id="ranking-area" class="rank-list"></div>
    </div>

    <div id="s-c-login" class="screen hidden">
        <h2>ENTER ROOM</h2>
        <input type="text" id="inp-room" placeholder="ID (ä¾‹:ABCD)">
        <input type="text" id="inp-name" placeholder="åå‰">
        <button id="btn-join" class="btn btn-start">å‚åŠ ï¼</button>
    </div>

    <div id="s-c-wait" class="screen hidden">
        <h2>WAITING...</h2>
        <p>ç”»é¢ã‚’è¦‹ã¦å¾…æ©Ÿã—ã¦ãã ã•ã„</p>
        <div id="my-score-disp" style="font-size:2rem; color:var(--primary); margin-top:20px;">0 pts</div>
    </div>

    <div id="s-c-play" class="screen hidden">
        <div id="ctrl-container" style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%;">
            </div>
    </div>

    <script type="module">
        // â–¼ Firebaseè¨­å®š (game-4f2d9)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, set, onValue, update, remove, onDisconnect, runTransaction } 
               from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDbZzTMvUkG2LXIGY4ux0KBTmnAdqP236s",
            authDomain: "game-4f2d9.firebaseapp.com",
            databaseURL: "https://game-4f2d9-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "game-4f2d9",
            storageBucket: "game-4f2d9.firebasestorage.app",
            messagingSenderId: "574316347824",
            appId: "1:574316347824:web:cf686040628e25ad615675"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- 100ç¨®é¡ã®ã‚²ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ ---
        // åŸºæœ¬ã‚¢ã‚¯ã‚·ãƒ§ãƒ³: tap(é€£æ‰“), shake(æŒ¯ã‚‹), hold(é•·æŠ¼ã—)
        const GAME_TEMPLATES = [
            { t: "tap",  txt: "èµ°ã‚Œï¼",   icon: "ğŸƒ" },
            { t: "tap",  txt: "å£Šã›ï¼",   icon: "ğŸ”¨" },
            { t: "tap",  txt: "é£Ÿãˆï¼",   icon: "ğŸ–" },
            { t: "shake",txt: "æŒ¯ã‚Œï¼",   icon: "ğŸ¥¤" },
            { t: "shake",txt: "è¸Šã‚Œï¼",   icon: "ğŸ’ƒ" },
            { t: "shake",txt: "é€ƒã’ã‚ï¼", icon: "ğŸ‘»" },
            { t: "hold", txt: "è€ãˆã‚ï¼", icon: "ğŸ›¡ï¸" },
            { t: "hold", txt: "æºœã‚ã‚ï¼", icon: "âš¡" }
        ];
        
        // 100å€‹ã®ã‚²ãƒ¼ãƒ ãƒªã‚¹ãƒˆã‚’è‡ªå‹•ç”Ÿæˆ
        const GAME_LIST = [];
        for(let i=0; i<100; i++) {
            const tmpl = GAME_TEMPLATES[i % GAME_TEMPLATES.length];
            GAME_LIST.push({
                id: `g_${i}`,
                no: i+1,
                type: tmpl.t,
                title: `${tmpl.icon} ROUND ${i+1}`,
                desc: `${tmpl.txt} (${tmpl.t.toUpperCase()})`
            });
        }

        // --- å¤‰æ•° ---
        let myId = "P" + Math.floor(Math.random()*10000);
        let roomId = "";
        let isHost = false;
        let gameTimer = null;
        let sensorActive = false;
        let currentScore = 0; // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã®ä¸€æ™‚ã‚¹ã‚³ã‚¢

        // --- DOM ---
        const $ = id => document.getElementById(id);
        const show = id => {
            document.querySelectorAll('.screen').forEach(e => e.classList.add('hidden'));
            $(id).classList.remove('hidden');
        };

        // ==========================================
        //  HOST LOGIC
        // ==========================================
        $('btn-host').addEventListener('click', () => {
            isHost = true;
            roomId = Math.random().toString(36).substr(2,4).toUpperCase();
            
            // éƒ¨å±‹ä½œæˆ
            const rRef = ref(db, `rooms/${roomId}`);
            set(rRef, { status: 'lobby', host: myId });
            onDisconnect(rRef).remove();

            // è¡¨ç¤º
            $('disp-room-id').innerText = roomId;
            $('qrcode').innerHTML = "";
            new QRCode($('qrcode'), { text: `${location.origin}${location.pathname}?room=${roomId}`, width: 128, height: 128 });
            show('s-h-lobby');

            // å‚åŠ è€…ç›£è¦–
            onValue(ref(db, `rooms/${roomId}/players`), snap => {
                $('disp-p-count').innerText = snap.size;
            });
        });

        $('btn-start-game').addEventListener('click', () => nextGameHost());

        function nextGameHost() {
            // ãƒ©ãƒ³ãƒ€ãƒ ã«ã‚²ãƒ¼ãƒ é¸æŠ
            const game = GAME_LIST[Math.floor(Math.random() * GAME_LIST.length)];
            
            // DBæ›´æ–°ï¼šå…¨ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¹ã‚³ã‚¢ãƒªã‚»ãƒƒãƒˆ & ã‚²ãƒ¼ãƒ çŠ¶æ…‹æ›´æ–°
            const updates = {};
            updates[`rooms/${roomId}/status`] = 'playing';
            updates[`rooms/${roomId}/game`] = game;
            
            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚¹ã‚³ã‚¢ã‚’0ã« (ä¸€åº¦å–å¾—ã—ã¦ã‹ã‚‰æ›´æ–°)
            onValue(ref(db, `rooms/${roomId}/players`), snap => {
                snap.forEach(p => {
                    updates[`rooms/${roomId}/players/${p.key}/score`] = 0;
                });
                update(ref(db), updates);
            }, { onlyOnce: true });

            // ç”»é¢æ›´æ–°
            show('s-h-game');
            $('game-index').innerText = game.no;
            $('game-title').innerText = game.title;
            $('game-desc').innerText = "READY...";
            $('ranking-area').innerHTML = "";
            $('timer-bar').style.width = "100%";

            // ã‚²ãƒ¼ãƒ é€²è¡Œ
            setTimeout(() => {
                $('game-desc').innerText = game.desc;
                update(ref(db, `rooms/${roomId}/state`), 'go'); // åˆå›³
                
                let timeLeft = 5.0; // 1ã‚²ãƒ¼ãƒ 5ç§’
                gameTimer = setInterval(() => {
                    timeLeft -= 0.1;
                    $('timer-bar').style.width = (timeLeft/5*100) + "%";
                    
                    if(timeLeft <= 0) {
                        clearInterval(gameTimer);
                        finishGameHost();
                    }
                }, 100);

                // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°
                onValue(ref(db, `rooms/${roomId}/players`), snap => {
                    if($('s-h-game').classList.contains('hidden')) return;
                    
                    const list = [];
                    snap.forEach(c => list.push({name: c.val().name, score: c.val().score || 0}));
                    list.sort((a,b) => b.score - a.score);

                    $('ranking-area').innerHTML = list.slice(0,5).map((p,i) => `
                        <div class="rank-item">
                            <span>#${i+1} ${p.name}</span>
                            <span style="font-weight:bold; color:var(--primary)">${p.score}</span>
                        </div>
                    `).join('');
                });

            }, 2000); // 2ç§’å¾…æ©Ÿã—ã¦ã‚¹ã‚¿ãƒ¼ãƒˆ
        }

        function finishGameHost() {
            update(ref(db, `rooms/${roomId}/state`), 'end');
            $('game-desc').innerText = "FINISH!";
            setTimeout(() => {
                // è‡ªå‹•ã§æ¬¡ã®ã‚²ãƒ¼ãƒ ã¸ï¼ˆç„¡é™ãƒ«ãƒ¼ãƒ—ï¼‰
                nextGameHost();
            }, 4000);
        }

        // ==========================================
        //  CLIENT LOGIC
        // ==========================================
        // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å¯¾å¿œ
        const params = new URLSearchParams(location.search);
        if(params.get('room')) {
            $('inp-room').value = params.get('room');
            show('s-c-login');
        }

        $('btn-client').addEventListener('click', () => show('s-c-login'));

        $('btn-join').addEventListener('click', () => {
            const rid = $('inp-room').value.toUpperCase();
            const name = $('inp-name').value || "NO NAME";
            if(!rid) return alert("IDã‚’å…¥ã‚Œã¦ãã ã•ã„");
            
            roomId = rid;
            const pRef = ref(db, `rooms/${roomId}/players/${myId}`);
            set(pRef, { name: name, score: 0 }).then(() => {
                onDisconnect(pRef).remove();
                show('s-c-wait');
                initClientListener();
                
                // iOSç”¨ã‚»ãƒ³ã‚µãƒ¼è¨±å¯ãƒãƒƒã‚¯
                if(typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function'){
                    DeviceMotionEvent.requestPermission().catch(e=>console.log(e));
                }
            }).catch(() => alert("éƒ¨å±‹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"));
        });

        function initClientListener() {
            onValue(ref(db, `rooms/${roomId}`), snap => {
                const data = snap.val();
                if(!data) { location.reload(); return; } // è§£æ•£æ™‚

                // è‡ªåˆ†ã®ã‚¹ã‚³ã‚¢æ›´æ–°
                const myData = data.players && data.players[myId];
                if(myData) $('my-score-disp').innerText = (myData.score||0) + " pts";

                // ã‚²ãƒ¼ãƒ çŠ¶æ…‹é·ç§»
                if(data.status === 'playing' && data.game) {
                    const state = data.state; // ready, go, end
                    
                    if(state === 'go') {
                        setupController(data.game.type);
                    } else if (state === 'end') {
                        show('s-c-wait');
                        $('my-score-disp').innerText = "çµæœç™ºè¡¨...";
                        stopSensor();
                    } else {
                        show('s-c-wait');
                        $('my-score-disp').innerText = data.game.title;
                        stopSensor();
                    }
                }
            });
        }

        function setupController(type) {
            show('s-c-play');
            const box = $('ctrl-container');
            box.innerHTML = ""; // reset
            currentScore = 0;

            if(type === 'tap') {
                // é€£æ‰“ãƒœã‚¿ãƒ³
                const btn = document.createElement('button');
                btn.className = "ctrl-btn bg-red";
                btn.innerText = "PUSH!";
                // ãƒã‚¤ãƒ³ã‚¿ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆã§é«˜é€ŸåŒ–
                btn.addEventListener('pointerdown', (e) => {
                    e.preventDefault();
                    btn.style.transform = "scale(0.9)";
                    addScore(1);
                    if(navigator.vibrate) navigator.vibrate(10);
                });
                btn.addEventListener('pointerup', () => btn.style.transform = "scale(1)");
                box.appendChild(btn);

            } else if (type === 'shake') {
                // ã‚·ã‚§ã‚¤ã‚¯
                box.innerHTML = `<div class="instruction">SHAKE!!</div>`;
                startSensor();

            } else if (type === 'hold') {
                // é•·æŠ¼ã—
                const btn = document.createElement('button');
                btn.className = "ctrl-btn bg-blue";
                btn.innerText = "HOLD!";
                let holdTimer = null;
                
                btn.addEventListener('pointerdown', (e) => {
                    e.preventDefault();
                    btn.style.transform = "scale(0.9)";
                    // é•·æŠ¼ã—ä¸­ãšã£ã¨åŠ ç®—
                    holdTimer = setInterval(() => {
                        addScore(1);
                        if(navigator.vibrate) navigator.vibrate(5);
                    }, 100);
                });
                const stopHold = () => {
                    if(holdTimer) clearInterval(holdTimer);
                    btn.style.transform = "scale(1)";
                };
                btn.addEventListener('pointerup', stopHold);
                btn.addEventListener('pointerleave', stopHold);
                box.appendChild(btn);
            }
        }

        // --- ã‚¹ã‚³ã‚¢é€ä¿¡ ---
        // é€£æ‰“ç³»ã¯é€šä¿¡å›æ•°ãŒå¤šã„ã®ã§ã€ãƒ­ãƒ¼ã‚«ãƒ«ã§åŠ ç®—ã—ã¤ã¤Transactionã§é€ã‚‹
        function addScore(amount) {
            const sRef = ref(db, `rooms/${roomId}/players/${myId}/score`);
            runTransaction(sRef, (score) => {
                return (score || 0) + amount;
            });
        }

        // --- ã‚»ãƒ³ã‚µãƒ¼å‡¦ç† ---
        function startSensor() {
            if(sensorActive) return;
            sensorActive = true;
            let lastX=0, lastY=0, lastZ=0;
            const threshold = 20;

            window.addEventListener('devicemotion', function onShake(e) {
                if(!sensorActive) {
                    window.removeEventListener('devicemotion', onShake);
                    return;
                }
                const acc = e.accelerationIncludingGravity;
                if(!acc) return;
                
                const delta = Math.abs(acc.x+acc.y+acc.z - lastX-lastY-lastZ);
                if(delta > threshold) {
                    addScore(1);
                    if(navigator.vibrate) navigator.vibrate(20);
                }
                lastX=acc.x; lastY=acc.y; lastZ=acc.z;
            });
        }

        function stopSensor() {
            sensorActive = false;
        }

    </script>
</body>
</html>
