<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PARTY BOX 100: EVOLUTION</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+1p:wght@800&family=Rowdies:wght@700&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #111; --neon-cyan: #0ff; --neon-pink: #f0f; --neon-yellow: #ff0; }
        body { margin: 0; background: var(--bg); color: white; font-family: 'M PLUS 1p', sans-serif; overflow: hidden; height: 100vh; user-select: none; text-align: center; touch-action: none; }

        /* å…±é€šã‚¹ã‚¯ãƒªãƒ¼ãƒ³ */
        .screen { position: fixed; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; background: radial-gradient(circle, #222 0%, #000 100%); transition: opacity 0.3s; z-index: 1; }
        .hidden { opacity: 0; pointer-events: none; z-index: -10; }

        /* ãƒ‡ã‚¶ã‚¤ãƒ³ãƒ‘ãƒ¼ãƒ„ */
        h1 { font-family: 'Rowdies', cursive; font-size: 4rem; color: var(--neon-cyan); text-shadow: 4px 4px 0 var(--neon-pink); margin: 10px; }
        h2 { font-size: 2rem; margin: 10px; }
        .btn { background: linear-gradient(45deg, #ff00cc, #3333ff); border: none; color: white; padding: 15px 40px; font-size: 1.5rem; border-radius: 50px; cursor: pointer; margin: 10px; box-shadow: 0 0 15px var(--neon-pink); font-family: inherit; }
        .btn:active { transform: scale(0.95); }
        .btn-cyan { background: linear-gradient(45deg, #00ccff, #00ffcc); box-shadow: 0 0 15px var(--neon-cyan); color: black; }

        /* ãƒ›ã‚¹ãƒˆç”»é¢ç³» */
        .wheel-container { position: relative; width: 350px; height: 350px; margin: 20px; }
        .wheel { width: 100%; height: 100%; border-radius: 50%; border: 10px solid white; background: conic-gradient(#f0f 0deg 90deg, #0ff 90deg 180deg, #ff0 180deg 270deg, #0f0 270deg 360deg); }
        .arrow { position: absolute; top: -20px; left: 50%; transform: translateX(-50%); border-left: 20px solid transparent; border-right: 20px solid transparent; border-top: 40px solid white; z-index: 10; }
        
        #scene-battle { background: #300; }
        .boss-img { font-size: 10rem; animation: float 2s infinite ease-in-out; }
        .hp-bar { width: 80%; height: 30px; background: #333; border: 2px solid white; border-radius: 15px; overflow: hidden; }
        .hp-fill { width: 100%; height: 100%; background: linear-gradient(90deg, #f00, #ff0); transition: width 0.2s; }
        #scene-race { background: #002; justify-content: flex-start; padding-top: 50px; overflow-y: hidden; }
        .track-lane { width: 100%; height: 50px; border-bottom: 1px dashed #555; position: relative; display: flex; align-items: center; }
        .racer { position: absolute; left: 0; font-size: 2.5rem; transition: left 0.5s linear; }

        /* ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆæ“ä½œã‚¨ãƒªã‚¢ */
        .ctrl-area { width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #222; }
        
        /* 1. Normal Button */
        .c-btn { width: 220px; height: 220px; border-radius: 50%; border: none; font-size: 2rem; color: white; font-weight: bold; box-shadow: 0 10px 0 rgba(0,0,0,0.5); display: flex; flex-direction: column; align-items: center; justify-content: center; user-select: none; -webkit-user-select: none; }
        .c-btn:active { transform: translateY(10px); box-shadow: none; }
        .bg-red { background: #ff4757; box-shadow: 0 10px 0 #c0392b; }
        .bg-blue { background: #3742fa; box-shadow: 0 10px 0 #2f3542; }
        .bg-stop { background: var(--neon-yellow); color: black; box-shadow: 0 10px 0 #d4a017; }

        /* 2. Swipe Area */
        .swipe-zone { width: 90%; height: 70%; border: 4px dashed var(--neon-cyan); border-radius: 20px; display: flex; align-items: center; justify-content: center; font-size: 5rem; color: #555; background: rgba(0,255,255,0.05); }
        .swipe-anim { animation: flyUp 0.5s ease-out; color: var(--neon-cyan); }
        
        /* 3. Charge Button */
        .charge-btn { background: #e67e22; box-shadow: 0 10px 0 #d35400; transition: transform 0.1s; }
        .charging { animation: vibrate 0.1s infinite; background: #fff !important; color: #e67e22 !important; box-shadow: 0 0 30px #e67e22 !important; }

        /* 4. Mash Buttons */
        .mash-container { display: flex; gap: 20px; }
        .mash-btn { width: 140px; height: 140px; font-size: 3rem; border-radius: 20px; border: none; box-shadow: 0 8px 0 rgba(0,0,0,0.5); }
        .mash-l { background: #2ecc71; box-shadow: 0 8px 0 #27ae60; }
        .mash-r { background: #9b59b6; box-shadow: 0 8px 0 #8e44ad; }
        .mash-btn:active { transform: translateY(8px); box-shadow: none; }

        /* Animations */
        @keyframes float { 0%,100%{transform:translateY(0);} 50%{transform:translateY(-20px);} }
        @keyframes flyUp { 0%{transform:translateY(0); opacity:1;} 100%{transform:translateY(-200px); opacity:0;} }
        @keyframes vibrate { 0%{transform:translate(1px, 1px);} 100%{transform:translate(-1px, -1px);} }
        .shake { animation: shake 0.3s; }
        @keyframes shake { 0% { transform: translate(1px, 1px) rotate(0deg); } 100% { transform: translate(-1px, -2px) rotate(-1deg); } }
    </style>
</head>
<body>

    <div id="s-top" class="screen">
        <h1>PARTY BOX<br>EVO</h1>
        <p>100ç¨®é¡ã®ã‚²ãƒ¼ãƒ  Ã— 6ã¤ã®æ“ä½œ</p>
        <div style="margin-top:20px;">
            <button id="btn-host" class="btn">ğŸ’» ãƒ›ã‚¹ãƒˆ</button>
            <button id="btn-client" class="btn btn-cyan">ğŸ“± ã‚¹ãƒãƒ›å‚åŠ </button>
        </div>
    </div>

    <div id="s-lobby" class="screen hidden">
        <h2>ROOM ID</h2>
        <div id="disp-id" style="font-size:5rem; color:var(--neon-yellow); font-family:'Rowdies';">----</div>
        <div id="qrcode" style="background:white; padding:15px; border-radius:10px;"></div>
        <p>å‚åŠ äººæ•°: <span id="p-count" style="font-size:2rem; font-weight:bold; color:var(--neon-pink)">0</span> äºº</p>
        <button onclick="startRoulette()" class="btn">é‹å‘½ã®ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆ</button>
        <button onclick="showGameList()" class="btn btn-cyan">ãƒªã‚¹ãƒˆã‹ã‚‰é¸ã¶</button>
    </div>

    <div id="s-roulette" class="screen hidden">
        <h1>NEXT GAME</h1>
        <div class="wheel-container"><div class="arrow"></div><div id="wheel" class="wheel"></div></div>
        <h2 id="stopper-msg" style="color:var(--neon-yellow);">STOPãƒœã‚¿ãƒ³å¾…ã¡...</h2>
    </div>

    <div id="scene-battle" class="screen hidden">
        <h2 id="battle-title">BOSS</h2>
        <div id="boss-display" class="boss-img">ğŸ‘¾</div>
        <div class="hp-bar"><div id="boss-hp" class="hp-fill"></div></div>
        <div id="battle-timer" style="font-size:3rem; margin-top:20px;">15.0</div>
    </div>

    <div id="scene-race" class="screen hidden">
        <h2 id="race-title">RACE</h2>
        <div id="race-track-area" style="width:90%;"></div>
    </div>

    <div id="scene-generic" class="screen hidden">
        <h2 id="gen-title">GAME</h2>
        <div id="gen-instruction" style="font-size:3rem; font-weight:bold; color:var(--neon-yellow); margin:20px;">READY?</div>
        <div id="gen-timer" style="font-size:3rem;"></div>
        <div id="gen-ranking" style="font-size:1.5rem; text-align:left; margin-top:30px; color:#aaa;"></div>
    </div>

    <div id="s-list" class="screen hidden" style="justify-content:flex-start; overflow-y:auto; padding:50px;">
        <h2>GAME LIST</h2>
        <button onclick="show('s-lobby')" class="btn">æˆ»ã‚‹</button>
        <div id="game-list-container" style="display:flex; flex-wrap:wrap; justify-content:center; gap:10px;"></div>
    </div>

    <div id="s-result" class="screen hidden">
        <h1>WINNER</h1>
        <div id="winner-name" style="font-size:4rem; color:var(--neon-yellow); font-weight:bold;">???</div>
        <button onclick="location.reload()" class="btn">ã‚¿ã‚¤ãƒˆãƒ«ã¸</button>
    </div>

    <div id="s-c-login" class="screen hidden">
        <h2>IDå…¥åŠ›</h2>
        <input id="inp-id" style="font-size:1.5rem; padding:10px; width:200px; text-align:center; text-transform:uppercase;" placeholder="ABCD">
        <br><br>
        <input id="inp-name" style="font-size:1.2rem; padding:10px; width:200px; text-align:center;" placeholder="åå‰">
        <br><br>
        <button id="btn-join" class="btn btn-cyan">å‚åŠ </button>
    </div>

    <div id="s-c-play" class="screen hidden">
        <div id="c-msg" style="font-size:1.5rem; margin-bottom:20px; color:#ccc;">å¾…æ©Ÿä¸­...</div>
        <div id="c-area" class="ctrl-area"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, set, get, onValue, update, remove, onDisconnect, runTransaction, child } 
               from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDbZzTMvUkG2LXIGY4ux0KBTmnAdqP236s",
            authDomain: "game-4f2d9.firebaseapp.com",
            databaseURL: "https://game-4f2d9-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "game-4f2d9",
            storageBucket: "game-4f2d9.firebasestorage.app",
            messagingSenderId: "574316347824",
            appId: "1:574316347824:web:cf686040628e25ad615675"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- ã‚²ãƒ¼ãƒ å®šç¾©: 6ã¤ã®å‹•ä½œã‚¿ã‚¤ãƒ— ---
        // tap(é€£æ‰“), shake(æŒ¯ã‚‹), stop(ã‚¿ã‚¤ãƒŸãƒ³ã‚°), swipe(ã‚¹ãƒ¯ã‚¤ãƒ—), charge(é•·æŠ¼ã—), mash(å·¦å³äº¤äº’)
        const ACTIONS = [
            {t:'tap', n:'ãƒ‰ãƒ©ã‚´ãƒ³è¨ä¼', d:'ã²ãŸã™ã‚‰é€£æ‰“ï¼', i:'ğŸ‰'},
            {t:'tap', n:'éš•çŸ³ç ´å£Š', d:'æ’ƒã¡è½ã¨ã›ï¼', i:'â˜„ï¸'},
            {t:'shake', n:'ãƒ—ãƒ­ãƒ†ã‚¤ãƒ³', d:'ã‚¹ãƒãƒ›ã‚’æŒ¯ã‚Œï¼', i:'ğŸ¥¤'},
            {t:'shake', n:'ç‚­é…¸ãƒ•ã‚¡ã‚¤ãƒˆ', d:'é™ç•Œã¾ã§æŒ¯ã‚Œï¼', i:'ğŸ¾'},
            {t:'stop', n:'æ™‚é™çˆ†å¼¾', d:'5.00ç§’ã§æ­¢ã‚ã‚', i:'ğŸ’£'},
            {t:'stop', n:'ãƒ€ãƒ«ãƒã•ã‚“', d:'åˆå›³ã§æ­¢ã¾ã‚Œï¼', i:'ğŸ—¿'},
            // NEW ACTIONS
            {t:'swipe', n:'æ‰‹è£å‰£é“å ´', d:'ä¸Šã«ã‚¹ãƒ¯ã‚¤ãƒ—ã—ã¦æŠ•ã’ã‚ï¼', i:'ğŸ¥·'},
            {t:'swipe', n:'ã‚´ãƒŸç®±ã‚·ãƒ¥ãƒ¼ãƒˆ', d:'ã‚´ãƒŸã‚’æŠ•ã’å…¥ã‚Œã‚ï¼', i:'ğŸ—‘ï¸'},
            {t:'swipe', n:'å±…åˆæ–¬ã‚Š', d:'ä¸€ç¬ã§ä¸Šã«åˆ‡ã‚Šä¸Šã’ã‚ï¼', i:'âš”ï¸'},
            {t:'charge', n:'æ³¢å‹•ç ²', d:'é•·æŠ¼ã—ã§æºœã‚ã¦æ”¾ã¦ï¼', i:'âš¡'},
            {t:'charge', n:'é¢¨èˆ¹å‰²ã‚Š', d:'é•·æŠ¼ã—ã§è†¨ã‚‰ã¾ã›ã‚ï¼', i:'ğŸˆ'},
            {t:'charge', n:'ã‚·ãƒ£ãƒ³ãƒ‘ãƒ³', d:'æºœã‚ã¦ã‚³ãƒ«ã‚¯ã‚’é£›ã°ã›ï¼', i:'ğŸ¾'},
            {t:'mash', n:'100mèµ°', d:'å·¦å³äº¤äº’ã«é€£æ‰“ã—ã‚ï¼', i:'ğŸƒ'},
            {t:'mash', n:'å´–ç™»ã‚Š', d:'å·¦å³ã®æ‰‹ã§ç™»ã‚Œï¼', i:'ğŸ§—'},
            {t:'mash', n:'ã‚¯ãƒ­ãƒ¼ãƒ«', d:'æ°´ã‚’ã‹ã‘ã‚ã‘ã‚ï¼', i:'ğŸŠ'}
        ];

        const GAME_DB = [];
        for(let i=0; i<100; i++) {
            const base = ACTIONS[i % ACTIONS.length];
            GAME_DB.push({ id: i, type: base.t, title: base.n, desc: base.d, icon: base.i });
        }

        // --- å¤‰æ•° ---
        let myId = "P" + Math.random().toString(36).substr(2, 5);
        let roomId = "";
        let players = {};
        let sensorActive = false;

        const $ = id => document.getElementById(id);
        const show = id => {
            document.querySelectorAll('.screen').forEach(e => e.classList.add('hidden'));
            $(id).classList.remove('hidden');
        };

        // --- HOST ---
        $('btn-host').addEventListener('click', () => {
            roomId = Math.random().toString(36).substr(2, 4).toUpperCase();
            const rRef = ref(db, `rooms/${roomId}`);
            set(rRef, { status: 'lobby', host: myId });
            onDisconnect(rRef).remove();

            $('disp-id').innerText = roomId;
            $('qrcode').innerHTML = "";
            new QRCode($('qrcode'), { text: `${location.origin}${location.pathname}?room=${roomId}`, width: 128, height: 128 });
            show('s-lobby');

            onValue(ref(db, `rooms/${roomId}/players`), snap => {
                players = snap.val() || {};
                $('p-count').innerText = Object.keys(players).length;
            });
        });

        window.showGameList = () => {
            show('s-list');
            const cont = $('game-list-container');
            cont.innerHTML = "";
            GAME_DB.forEach(g => {
                const b = document.createElement('button');
                b.className = "btn";
                b.style.fontSize = "0.8rem"; b.style.width = "150px";
                b.innerHTML = `${g.icon}<br>${g.title}`;
                b.onclick = () => initGame(g);
                cont.appendChild(b);
            });
        };

        window.startRoulette = () => {
            const pIds = Object.keys(players);
            if(pIds.length === 0) return alert("å‚åŠ è€…ãŒã„ã¾ã›ã‚“");
            show('s-roulette');
            const stopperId = pIds[Math.floor(Math.random() * pIds.length)];
            update(ref(db, `rooms/${roomId}`), { status: 'roulette', stopper: stopperId, stopperName: players[stopperId].name, spin: true });

            const wheel = $('wheel');
            let deg = 0;
            const anim = setInterval(() => { deg = (deg + 20) % 360; wheel.style.transform = `rotate(${deg}deg)`; }, 20);
            
            const unsub = onValue(ref(db, `rooms/${roomId}/spin`), snap => {
                if(snap.val() === false) {
                    clearInterval(anim); unsub();
                    wheel.style.transition = "transform 3s ease-out";
                    wheel.style.transform = `rotate(${deg + 720 + Math.floor(Math.random()*360)}deg)`;
                    setTimeout(() => initGame(GAME_DB[Math.floor(Math.random()*GAME_DB.length)]), 4000);
                }
            });
        };

        function initGame(game) {
            update(ref(db, `rooms/${roomId}`), { status: 'game', gameData: game, gameVal: 100, state: 'play' });
            
            // å…¨å“¡ã®ã‚¹ã‚³ã‚¢0
            const u = {}; Object.keys(players).forEach(p => u[`rooms/${roomId}/players/${p}/score`] = 0);
            update(ref(db), u);

            if(game.type === 'tap') { // BATTLE MODE
                show('scene-battle');
                $('battle-title').innerText = game.title;
                $('boss-display').innerText = game.icon;
                startTimer(20, () => endGame('TIME UP'));
                onValue(ref(db, `rooms/${roomId}/gameVal`), s => {
                    const hp = s.val();
                    $('boss-hp').style.width = hp + "%";
                    if(hp <= 0) endGame('VICTORY!');
                    else if(hp < 100) { $('boss-display').classList.add('shake'); setTimeout(()=>$('boss-display').classList.remove('shake'),100); }
                });
            } 
            else if (game.type === 'mash') { // RACE MODE
                show('scene-race');
                $('race-title').innerText = game.title;
                const area = $('race-track-area'); area.innerHTML = "";
                Object.keys(players).forEach(pid => {
                    area.innerHTML += `<div class='track-lane'><span>${players[pid].name}</span><div id='car-${pid}' class='racer'>${game.icon}</div></div>`;
                });
                startTimer(20, ()=>endGame('FINISH'));
                onValue(ref(db, `rooms/${roomId}/players`), s => {
                    let win = null;
                    s.forEach(p => {
                        const sc = p.val().score || 0;
                        const el = document.getElementById(`car-${p.key}`);
                        if(el) { el.style.left = Math.min(90, sc*2) + "%"; if(sc >= 45) win = p.val().name; }
                    });
                    if(win) endGame(`${win} WINS!`);
                });
            }
            else { // GENERIC (Swipe, Shake, Stop, Charge)
                show('scene-generic');
                $('gen-title').innerText = game.title;
                $('gen-instruction').innerText = game.desc;
                startTimer(15, ()=>endGame('FINISH!'));
                onValue(ref(db, `rooms/${roomId}/players`), s => {
                    const l = []; s.forEach(p => l.push({n:p.val().name, s:p.val().score||0}));
                    l.sort((a,b)=>b.s-a.s);
                    $('gen-ranking').innerHTML = l.slice(0,3).map((p,i)=>`#${i+1} ${p.n}: ${p.s}`).join('<br>');
                });
            }
        }

        let timerInt;
        function startTimer(sec, cb) {
            clearInterval(timerInt);
            let t = sec;
            const el = $('scene-battle').classList.contains('hidden') ? ($('scene-race').classList.contains('hidden') ? $('gen-timer') : null) : $('battle-timer');
            if(el) el.innerText = t.toFixed(1);
            
            timerInt = setInterval(() => {
                t -= 0.1;
                if(el) el.innerText = t.toFixed(1);
                if(t <= 0) { clearInterval(timerInt); cb(); }
            }, 100);
        }
        function endGame(msg) {
            clearInterval(timerInt);
            update(ref(db, `rooms/${roomId}`), { status: 'result' });
            show('s-result');
            $('winner-name').innerText = msg;
            confetti();
        }

        // --- CLIENT ---
        const params = new URLSearchParams(location.search);
        if(params.get('room')) { $('inp-id').value = params.get('room'); show('s-c-login'); }
        $('btn-client').addEventListener('click', () => show('s-c-login'));

        $('btn-join').addEventListener('click', async () => {
            const rid = $('inp-id').value.toUpperCase().trim();
            const name = $('inp-name').value || "Guest";
            if(!rid) return;
            try {
                const snap = await get(child(ref(db), `rooms/${rid}`));
                if(!snap.exists()) return alert("éƒ¨å±‹ãŒã‚ã‚Šã¾ã›ã‚“");
                roomId = rid;
                const pRef = ref(db, `rooms/${roomId}/players/${myId}`);
                set(pRef, { name: name, score: 0 });
                onDisconnect(pRef).remove();
                show('s-c-play');
                initController();
                requestSensor();
            } catch(e) { alert("Error"); }
        });

        function initController() {
            onValue(ref(db, `rooms/${roomId}`), snap => {
                const data = snap.val();
                if(!data) return;
                const area = $('c-area'); area.innerHTML = ""; $('c-msg').innerText = "";
                
                if(data.status === 'roulette') {
                    if(data.stopper === myId && data.spin) {
                        const b = document.createElement('button'); b.className = "c-btn bg-stop"; b.innerText = "STOP!";
                        b.onclick = () => update(ref(db, `rooms/${roomId}`), { spin: false });
                        area.appendChild(b);
                        navigator.vibrate(200);
                    } else $('c-msg').innerText = "ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆä¸­...";
                }
                else if(data.status === 'game' && data.state === 'play') {
                    const g = data.gameData;
                    $('c-msg').innerText = g.desc;

                    // 1. TAP (é€£æ‰“)
                    if(g.type === 'tap') {
                        const b = document.createElement('button'); b.className = "c-btn bg-red"; b.innerText = "ATTACK!";
                        b.onpointerdown = (e) => { e.preventDefault(); b.style.transform = "scale(0.9)"; navigator.vibrate(20); runTransaction(ref(db, `rooms/${roomId}/gameVal`), h=>(h||0)-1); };
                        b.onpointerup = () => b.style.transform = "scale(1)";
                        area.appendChild(b);
                    }
                    // 2. SWIPE (ã‚¹ãƒ¯ã‚¤ãƒ—)
                    else if(g.type === 'swipe') {
                        const z = document.createElement('div'); z.className = "swipe-zone"; z.innerText = "â¬†ï¸";
                        let sy = 0;
                        z.ontouchstart = (e) => sy = e.touches[0].clientY;
                        z.ontouchend = (e) => {
                            if(sy - e.changedTouches[0].clientY > 50) { // Up Swipe
                                z.innerHTML = g.icon; z.classList.add('swipe-anim'); navigator.vibrate(50);
                                runTransaction(ref(db, `rooms/${roomId}/players/${myId}/score`), s=>(s||0)+1);
                                setTimeout(()=>{ z.classList.remove('swipe-anim'); z.innerText="â¬†ï¸"; }, 500);
                            }
                        };
                        area.appendChild(z);
                    }
                    // 3. CHARGE (é•·æŠ¼ã—)
                    else if(g.type === 'charge') {
                        const b = document.createElement('button'); b.className = "c-btn charge-btn"; b.innerText = "HOLD";
                        let st = 0;
                        b.onpointerdown = (e) => { e.preventDefault(); st = Date.now(); b.classList.add('charging'); navigator.vibrate(50); };
                        b.onpointerup = (e) => {
                            e.preventDefault(); b.classList.remove('charging');
                            const dur = Date.now() - st;
                            const pt = Math.min(Math.floor(dur/100), 20); // Max 20pt
                            if(pt>1) runTransaction(ref(db, `rooms/${roomId}/players/${myId}/score`), s=>(s||0)+pt);
                        };
                        area.appendChild(b);
                    }
                    // 4. MASH (å·¦å³äº¤äº’)
                    else if(g.type === 'mash') {
                        const box = document.createElement('div'); box.className = "mash-container";
                        const l = document.createElement('button'); l.className = "mash-btn mash-l"; l.innerText = "L";
                        const r = document.createElement('button'); r.className = "mash-btn mash-r"; r.innerText = "R";
                        const hit = () => { navigator.vibrate(20); runTransaction(ref(db, `rooms/${roomId}/players/${myId}/score`), s=>(s||0)+1); };
                        l.onpointerdown = (e) => { e.preventDefault(); hit(); };
                        r.onpointerdown = (e) => { e.preventDefault(); hit(); };
                        box.appendChild(l); box.appendChild(r);
                        area.appendChild(box);
                    }
                    // 5. SHAKE (æŒ¯ã‚‹)
                    else if(g.type === 'shake') {
                        area.innerHTML = `<div style="font-size:5rem; animation:shake 0.5s infinite">ğŸ‘‹</div>`;
                        startSensor();
                    }
                    // 6. STOP (ã‚¿ã‚¤ãƒŸãƒ³ã‚°)
                    else if(g.type === 'stop') {
                        const b = document.createElement('button'); b.className = "c-btn bg-stop"; b.innerText = "STOP";
                        b.onclick = () => { b.disabled = true; runTransaction(ref(db, `rooms/${roomId}/players/${myId}/score`), s=>(s||0)+10); };
                        area.appendChild(b);
                    }
                }
            });
        }

        function requestSensor() {
            if(typeof DeviceMotionEvent!=='undefined' && typeof DeviceMotionEvent.requestPermission==='function'){
                document.body.addEventListener('click', ()=>DeviceMotionEvent.requestPermission(), {once:true});
            }
        }
        function startSensor() {
            if(sensorActive) return;
            sensorActive = true;
            let last = {x:0,y:0,z:0};
            window.addEventListener('devicemotion', e => {
                if(!sensorActive) return;
                const acc = e.accelerationIncludingGravity;
                if(!acc) return;
                const d = Math.abs(acc.x+acc.y+acc.z - last.x-last.y-last.z);
                if(d > 20) { runTransaction(ref(db, `rooms/${roomId}/players/${myId}/score`), s=>(s||0)+1); navigator.vibrate(30); }
                last = {x:acc.x, y:acc.y, z:acc.z};
            });
        }
    </script>
</body>
</html>
