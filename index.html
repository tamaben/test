<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ã‚³ãƒˆãƒãƒˆåºƒå ´</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root {
            --bg-body: #0d1117; --bg-sidebar: #161b22; --bg-card: #21262d; --bg-input: #30363d;
            --primary: #58a6ff; --primary-dim: rgba(88, 166, 255, 0.15);
            --success: #238636; --danger: #da3633; --warning: #d29922;
            --text-main: #c9d1d9; --text-sub: #8b949e; --border: #30363d;
            --radius: 12px; --nav-h-mobile: 60px; --sidebar-w: 240px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { background: var(--bg-body); color: var(--text-main); font-family: 'Inter', 'Noto Sans JP', sans-serif; margin: 0; padding: 0; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        
        .hidden { display: none !important; }
        .flex { display: flex; } .flex-col { flex-direction: column; } .items-center { align-items: center; } .justify-between { justify-content: space-between; }
        .gap-2 { gap: 8px; } .gap-4 { gap: 16px; }
        .font-bold { font-weight: 700; } .text-sm { font-size: 0.85rem; } .text-xs { font-size: 0.75rem; }
        .mb-2 { margin-bottom: 8px; } .mb-4 { margin-bottom: 16px; } .w-full { width: 100%; } .text-sub { color: var(--text-sub); }

        .icon { width: 20px; height: 20px; fill: currentColor; flex-shrink: 0; }

        .screen { position: absolute; inset: 0; background: var(--bg-body); z-index: 10; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; display: flex; flex-direction: column; }
        .screen.active { opacity: 1; pointer-events: auto; z-index: 20; }

        /* Splash Screen */
        #splash-screen {
            position: fixed; inset: 0; background: var(--bg-body); z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.5s ease, visibility 0.5s;
        }
        #splash-screen.fade-out { opacity: 0; visibility: hidden; }
        .splash-logo { font-size: 3rem; font-weight: 900; background: linear-gradient(135deg, #58a6ff, #bc8cff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 20px; letter-spacing: 2px; }
        .loader { width: 40px; height: 40px; border: 4px solid var(--bg-input); border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .auth-container { flex: 1; display: flex; align-items: center; justify-content: center; background: radial-gradient(circle at center, #1f2937 0%, #0b0f19 100%); padding: 20px; }
        .auth-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 24px; padding: 40px 30px; width: 100%; max-width: 380px; text-align: center; box-shadow: 0 25px 50px rgba(0,0,0,0.5); }
        .brand-title { font-size: 2rem; font-weight: 900; background: linear-gradient(135deg, #58a6ff, #bc8cff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 2rem; letter-spacing: 1px; }

        .input-group { position: relative; width: 100%; }
        .input { width: 100%; padding: 12px; background: var(--bg-input); border: 1px solid var(--border); border-radius: 8px; color: #fff; font-size: 1rem; transition: border-color 0.2s; touch-action: manipulation; }
        .input:focus { border-color: var(--primary); }
        .input.error { border-color: var(--danger); animation: shake 0.3s; }
        .pass-toggle { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); background: none; border: none; color: var(--text-sub); cursor: pointer; font-size: 1.2rem; padding: 0; }
        @keyframes shake { 0%,100%{transform:translateX(0)} 25%{transform:translateX(-5px)} 75%{transform:translateX(5px)} }

        .app-layout { display: flex; width: 100%; height: 100%; overflow: hidden; }
        .sidebar { width: var(--sidebar-w); background: var(--bg-sidebar); border-right: 1px solid var(--border); display: none; flex-direction: column; padding: 20px; flex-shrink: 0; }
        .sidebar-brand { font-size: 1.2rem; font-weight: 800; color: var(--text-main); margin-bottom: 30px; padding-left: 10px; cursor: pointer; }
        .nav-link { display: flex; align-items: center; gap: 12px; padding: 12px 16px; color: var(--text-sub); border-radius: 8px; cursor: pointer; margin-bottom: 4px; font-weight: 600; font-size: 0.95rem; }
        .nav-link.active { background: var(--primary-dim); color: var(--primary); }
        
        .main-content { flex: 1; display: flex; flex-direction: column; height: 100%; position: relative; overflow: hidden; background: var(--bg-body); }
        .header-mobile { height: 56px; background: var(--bg-sidebar); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: center; padding: 0 16px; flex-shrink: 0; font-weight: 700; font-size: 1.1rem; position: relative; }
        .header-user { position: absolute; right: 16px; font-size: 0.8rem; color: var(--text-sub); }
        .scroll-view { flex: 1; min-height:0; overflow-y: auto; padding: 20px; padding-bottom: 80px; -webkit-overflow-scrolling: touch; overscroll-behavior: contain; touch-action: pan-y; }

        #scr-stamp-maker { height: 100vh; }
        #scr-stamp-maker .scroll-view { height: calc(100vh - 50px); flex: none; }

        .bottom-nav { height: var(--nav-h-mobile); background: var(--bg-sidebar); border-top: 1px solid var(--border); display: flex; align-items: center; justify-content: space-around; position: absolute; bottom: 0; left: 0; right: 0; z-index: 50; padding-bottom: env(safe-area-inset-bottom); transition: transform 0.3s; }
        .b-nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: var(--text-sub); font-size: 0.65rem; gap: 4px; cursor: pointer; }
        .b-nav-item.active { color: var(--primary); }

        body.chat-mode .bottom-nav { transform: translateY(100%); } 
        body.chat-mode .sidebar { display: none !important; }
        body.chat-mode .scroll-view { padding-bottom: 0 !important; }

        .card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; margin-bottom: 16px; position: relative; }
        
        .btn { width: 100%; padding: 12px; border-radius: 8px; border: none; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 0.95rem; color: white; transition: 0.2s; }
        .btn:active { opacity: 0.7; transform: scale(0.98); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background: var(--success); }
        .btn-ghost { background: transparent; border: 1px solid var(--border); color: var(--text-sub); }
        .btn-danger { background: rgba(218, 54, 51, 0.15); color: var(--danger); border: 1px solid var(--danger); }
        .btn-warning { background: var(--warning); color: #000; }
        .btn-sm { padding: 6px 12px; font-size: 0.8rem; width: auto; }

        .res-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px; }
        .res-box { background: var(--bg-input); padding: 10px; border-radius: 10px; text-align: center; border: 1px solid var(--border); }
        .res-label { font-size: 0.65rem; color: var(--text-sub); display: block; font-weight: 700; }
        .res-val { font-size: 1.1rem; font-weight: 800; }

        /* Badges */
        .badge { display: inline-flex; align-items: center; padding: 2px 6px; border-radius: 4px; font-size: 0.6rem; margin-left: 6px; font-weight: bold; border: 1px solid currentColor; }
        .badge-developer { color: #fff; background: linear-gradient(135deg, #ff4b4b, #9b0000); border: none; }
        .badge-staff { color: #fff; background: linear-gradient(135deg, #d29922, #b87c00); border: none; }
        .badge-bug { color: #fff; background: linear-gradient(135deg, #238636, #165c26); border: none; }
        .badge-vip { color: #fff; background: linear-gradient(135deg, #a371f7, #6e40c9); border: none; }
        .badge-veteran { color: #fff; background: linear-gradient(135deg, #58a6ff, #1f6feb); border: none; }
        .badge-level { color: #58a6ff; border: 1px solid #58a6ff; }
        .badge-rich { color: #d29922; border: 1px solid #d29922; }
        .badge-whale { color: #bc8cff; border: 1px solid #bc8cff; }

        /* Chat */
        .chat-header { height: 50px; background: var(--bg-sidebar); display: flex; align-items: center; padding: 0 16px; border-bottom: 1px solid var(--border); font-weight: bold; justify-content: space-between; flex-shrink: 0; }
        .chat-list { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 16px; }
        .chat-input-wrapper { background: var(--bg-sidebar); border-top: 1px solid var(--border); padding-bottom: calc(10px + env(safe-area-inset-bottom)); flex-shrink: 0; }
        #chat-preview { display: none; padding: 10px 15px 0; align-items: center; gap: 10px; }
        .preview-thumb { height: 60px; border-radius: 8px; border: 1px solid var(--primary); object-fit: cover; }
        
        #chat-reply-preview, #dm-reply-preview { display: none; padding: 8px 15px 0; align-items: center; gap: 10px; background: var(--bg-card); border-bottom: 1px solid var(--border); border-top: 1px solid var(--border); }
        .reply-thumb { height: 40px; border-radius: 4px; object-fit: cover; }
        .reply-text-preview { font-size: 0.8rem; color: var(--text-main); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px; }
        .reply-name-preview { font-size: 0.7rem; color: var(--text-sub); margin-bottom: 2px; }
        .reply-box-in-msg { font-size: 0.75rem; color: var(--text-sub); background: rgba(255,255,255,0.05); padding: 6px 8px; border-radius: 6px; margin-bottom: 6px; border-left: 3px solid var(--primary); display: flex; align-items: center; gap: 6px; cursor: pointer; }
        .reply-box-in-msg img { height: 24px; border-radius: 4px; object-fit: cover; }

        .chat-input-area { padding: 10px 15px; display: flex; gap: 10px; align-items: center; }
        .chat-switcher { display: flex; justify-content: center; gap: 10px; flex: 1; }
        .chat-sw-btn { padding: 6px 12px; border-radius: 20px; font-size: 0.8rem; color: var(--text-sub); cursor: pointer; transition: 0.2s; }
        .chat-sw-btn.active { background: var(--primary-dim); color: var(--primary); font-weight: bold; }

        .msg-row { display: flex; flex-direction: column; max-width: 85%; position: relative; }
        .msg-row.mine { align-self: flex-end; align-items: flex-end; }
        .msg-row.other { align-self: flex-start; align-items: flex-start; }
        .msg-name { font-size: 0.7rem; color: var(--text-sub); margin-bottom: 4px; padding: 0 4px; cursor: pointer; }
        .msg-bubble { padding: 10px 14px; border-radius: 16px; font-size: 0.95rem; line-height: 1.5; word-break: break-word; position: relative; cursor: pointer; user-select: none; transition: opacity 0.2s; }
        .msg-bubble:active { opacity: 0.8; }
        .msg-row.mine .msg-bubble { background: #1f6feb; color: white; border-bottom-right-radius: 4px; }
        .msg-row.other .msg-bubble { background: var(--bg-card); border: 1px solid var(--border); border-bottom-left-radius: 4px; }
        
        .chat-img { max-width: 100%; border-radius: 8px; margin-top: 6px; display: block; cursor: zoom-in; }
        /* Stamp Size Increased */
        .stamp-img { width: 130px; height: 130px; object-fit: contain; display: block; cursor: default; }

        .dm-item { display: flex; align-items: center; gap: 12px; padding: 15px; border-bottom: 1px solid var(--border); cursor: pointer; transition: background 0.2s; }
        .dm-item:hover { background: var(--bg-input); }
        .dm-icon { width: 40px; height: 40px; background: var(--primary-dim); color: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.2rem; }

        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 1000; display: none; align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(4px); }
        .modal-box { background: var(--bg-card); width: 100%; max-width: 500px; border-radius: 16px; border: 1px solid var(--border); overflow: hidden; max-height: 80vh; display: flex; flex-direction: column; }
        .modal-head { padding: 15px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; font-weight: bold; }
        .modal-body { padding: 20px; overflow-y: auto; }
        
        .bottom-sheet { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2000; display: none; flex-direction: column; justify-content: flex-end; }
        .bottom-sheet-content { background: var(--bg-card); border-top-left-radius: 16px; border-top-right-radius: 16px; padding: 20px; padding-bottom: calc(20px + env(safe-area-inset-bottom)); transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.1, 0.8, 0.3, 1); }
        .bottom-sheet.show { display: flex; }
        .bottom-sheet.show .bottom-sheet-content { transform: translateY(0); }
        .sheet-btn { width: 100%; padding: 16px; text-align: left; background: transparent; border: none; border-bottom: 1px solid var(--border); color: var(--text-main); font-size: 1rem; cursor: pointer; display: flex; align-items: center; gap: 12px; }

        .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: var(--primary); color: #fff; padding: 10px 24px; border-radius: 50px; font-weight: 700; z-index: 2000; opacity: 0; transition: 0.3s; pointer-events: none; }
        .toast.show { opacity: 1; }

        /* Stamp Grid (3 columns for larger stamps) */
        .stamp-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; padding: 10px 0; }
        .stamp-item { aspect-ratio: 1; background: var(--bg-input); border-radius: 8px; display: flex; align-items: center; justify-content: center; cursor: pointer; border: 1px solid transparent; position: relative; }
        .stamp-item:hover { border-color: var(--primary); }
        .stamp-item img { width: 100%; height: 100%; object-fit: contain; padding: 4px; }
        .stamp-tabs { display: flex; border-bottom: 1px solid var(--border); margin-bottom: 10px; }
        .stamp-tab { flex: 1; text-align: center; padding: 10px; cursor: pointer; color: var(--text-sub); border-bottom: 2px solid transparent; }
        .stamp-tab.active { color: var(--primary); border-bottom-color: var(--primary); font-weight: bold; }

        /* Maker Canvas */
        .mk-toolbar { display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
        .mk-toolbtn { padding:8px 10px; border-radius:10px; border:1px solid var(--border); background:rgba(255,255,255,0.03); color:var(--text-main); font-weight:700; font-size:0.8rem; cursor:pointer; }
        .mk-toolbtn.active { border-color: var(--primary); background: var(--primary-dim); color: var(--primary); }
        .mk-canvas-wrap { position:relative; width:100%; aspect-ratio: 1; border-radius: 14px; border:1px solid var(--border); background: conic-gradient(from 90deg, rgba(255,255,255,0.08) 0 25%, rgba(255,255,255,0.02) 0 50%, rgba(255,255,255,0.08) 0 75%, rgba(255,255,255,0.02) 0 100%); background-size: 24px 24px; overflow:hidden; }
        #mk-canvas { width:100%; height:100%; display:block; }
        .mk-pill { display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border-radius:999px; background:rgba(255,255,255,0.05); border:1px solid var(--border); font-size:0.75rem; }
        .mk-warn { color: #ffcc66; } .mk-err { color: #ff7b72; }
        .pk-grid { display:grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
        .pk-slot { background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: 14px; padding: 10px; position: relative; overflow:hidden; }
        .pk-thumb { width: 100%; aspect-ratio: 1; border-radius: 12px; background: conic-gradient(from 90deg, rgba(255,255,255,0.08) 0 25%, rgba(255,255,255,0.02) 0 50%, rgba(255,255,255,0.08) 0 75%, rgba(255,255,255,0.02) 0 100%); background-size: 18px 18px; display:flex; align-items:center; justify-content:center; border:1px solid rgba(255,255,255,0.06); }
        .pk-thumb img { width: 100%; height: 100%; object-fit: contain; padding: 6px; }

        /* Call Screen */
        #scr-call { background: #000; z-index: 50; overflow: hidden; }
        .video-container { position: absolute; inset: 0; z-index: 0; display: flex; align-items: center; justify-content: center; background: #000; }
        #remote-video { width: 100%; height: 100%; object-fit: contain; }
        #local-video { position: absolute; bottom: 120px; right: 20px; width: 100px; height: 150px; object-fit: cover; border-radius: 12px; border: 2px solid var(--primary); background: #333; z-index: 10; transition: all 0.3s; display: none; }
        #local-video.active { display: block; }
        #call-overlay { position: absolute; inset: 0; z-index: 5; display: flex; flex-direction: column; justify-content: space-between; padding: 40px 20px; pointer-events: none; background: linear-gradient(to bottom, rgba(0,0,0,0.5) 0%, transparent 20%, transparent 80%, rgba(0,0,0,0.8) 100%); }
        .call-info { text-align: center; text-shadow: 0 2px 4px rgba(0,0,0,0.8); }
        .call-avatar { width: 100px; height: 100px; border-radius: 50%; background: #333; display: flex; align-items: center; justify-content: center; font-size: 3rem; margin: 0 auto 20px; border: 2px solid var(--text-main); }
        .call-controls { display: flex; justify-content: center; gap: 15px; pointer-events: auto; padding-bottom: 20px; }
        .call-btn { width: 60px; height: 60px; border-radius: 50%; border: none; font-size: 1.5rem; display: flex; align-items: center; justify-content: center; cursor: pointer; color: white; background: rgba(255,255,255,0.2); backdrop-filter: blur(5px); }

        @media (min-width: 768px) {
            .sidebar { display: flex; } .bottom-nav { display: none; } .header-mobile { display: none; } .scroll-view { padding-bottom: 20px; }
            .pk-grid { grid-template-columns: repeat(6, 1fr); }
            .bottom-sheet { align-items: center; justify-content: center; }
            .bottom-sheet-content { border-radius: 16px; width: 100%; max-width: 400px; padding-bottom: 20px; transform: scale(0.95); opacity: 0; }
            .bottom-sheet.show .bottom-sheet-content { transform: scale(1); opacity: 1; }
        }
    </style>
</head>
<body>

    <div id="splash-screen">
        <div class="splash-logo">COTOBATO</div>
        <div class="loader"></div>
    </div>

    <div id="toast" class="toast">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</div>
    <div id="img-viewer" class="modal-overlay" onclick="this.style.display='none'"><img id="img-full" style="max-width:100%; max-height:100vh; object-fit:contain;"></div>

    <!-- Call Screen -->
    <div id="scr-call" class="screen">
        <div class="video-container">
            <video id="remote-video" autoplay playsinline></video>
            <video id="local-video" autoplay playsinline muted></video>
        </div>
        <div id="call-overlay">
            <div id="call-ui-calling" class="flex flex-col items-center justify-between h-full py-10 hidden">
                <div class="call-info" style="margin-top:40px">
                    <div id="call-avatar" class="call-avatar">ğŸ‘¤</div>
                    <div id="call-status-text" class="text-xl font-bold mb-2">Calling...</div>
                    <div id="call-name" class="text-lg font-bold">User</div>
                </div>
                <button class="call-btn hangup" style="background:#da3633" onclick="app.endCall()">âœ•</button>
            </div>
            <div id="call-ui-incoming" class="flex flex-col items-center justify-between h-full py-10 hidden">
                <div class="call-info" style="margin-top:40px">
                    <div class="call-avatar">ğŸ“</div>
                    <div class="text-xl font-bold mb-2">Incoming Call</div>
                    <div id="inc-call-name" class="text-lg font-bold">User</div>
                    <div id="inc-call-type" class="text-sm text-sub">Audio</div>
                </div>
                <div class="flex gap-4" style="margin-bottom:20px">
                    <button class="call-btn answer" style="background:#238636" onclick="app.answerCall()">ğŸ“</button>
                    <button class="call-btn hangup" style="background:#da3633" onclick="app.endCall()">âœ•</button>
                </div>
            </div>
            <div id="call-ui-connected" class="flex flex-col justify-end h-full py-10 hidden">
                 <div class="call-controls" style="padding-bottom:20px">
                    <button id="btn-video-toggle" class="call-btn" onclick="app.toggleVideo()">ğŸ“¹</button>
                    <button id="btn-mic-toggle" class="call-btn active" onclick="app.toggleMic()">ğŸ¤</button>
                    <button class="call-btn hangup" style="background:#da3633" onclick="app.endCall()">âœ•</button>
                </div>
            </div>
        </div>
        <audio id="remote-audio" autoplay></audio>
    </div>

    <!-- ã‚¹ã‚¿ãƒ³ãƒ—é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="stamp-modal" class="modal-overlay" onclick="if(event.target===this) app.closeStampModal()">
        <div class="modal-box" style="height: 60vh;">
            <div class="modal-head">
                <span>ã‚¹ã‚¿ãƒ³ãƒ—</span>
                <button class="btn btn-ghost" style="width:30px;padding:0" onclick="app.closeStampModal()">âœ•</button>
            </div>
            <div class="modal-body" style="padding:0; display:flex; flex-direction:column; height:100%;">
                <div class="stamp-tabs">
                    <div class="stamp-tab active" onclick="app.switchStampTab('public')" id="tab-stamp-public">ã¿ã‚“ãªã®</div>
                    <div class="stamp-tab" onclick="app.switchStampTab('private')" id="tab-stamp-private">ãƒã‚¤ã‚¹ã‚¿ãƒ³ãƒ—</div>
                </div>
                <div id="stamp-list" class="stamp-grid" style="overflow-y:auto; flex:1; padding:10px;"></div>
                <div class="p-3 border-t border-[var(--border)]">
                    <button class="btn btn-primary btn-sm" onclick="app.openStampMaker(); app.closeStampModal();">ï¼‹ æ–°è¦ä½œæˆ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ã‚¹ã‚¿ãƒ³ãƒ—ä½œæˆå°‚ç”¨ç”»é¢ -->
    <div id="scr-stamp-maker" class="screen" style="z-index: 50; background: var(--bg-body);">
        <div class="chat-header">
            <div onclick="app.closeStampMaker()" style="cursor:pointer; display:flex; align-items:center; gap:4px; color:var(--primary);">â† æˆ»ã‚‹</div>
            <span>ã‚¹ã‚¿ãƒ³ãƒ—ãƒ¡ãƒ¼ã‚«ãƒ¼</span>
            <button class="btn btn-ghost btn-sm" style="width:auto" onclick="app.pkResetDraft()">ä¸‹æ›¸ããƒªã‚»ãƒƒãƒˆ</button>
        </div>

        <div class="scroll-view" style="display:flex; flex-direction:column; padding:20px; overflow-y:auto; min-height:0; -webkit-overflow-scrolling:touch;">
            <div id="pk-step-basic" style="display:block;">
                <div class="card" style="padding:0; overflow:hidden;">
                    <div style="padding:18px 18px 14px; background:linear-gradient(135deg, rgba(88,166,255,0.18), rgba(188,140,255,0.10)); border-bottom:1px solid var(--border);">
                        <div class="font-bold text-lg">1. åŸºæœ¬è¨­å®šã¨è²©å£²è¨­å®š</div>
                    </div>
                    <div style="padding:18px;">
                        <div class="mk-row mb-3" style="align-items:flex-start;">
                            <label>ãƒ‘ãƒƒã‚¯å</label>
                            <input type="text" id="pk-title" class="input" placeholder="ä¾‹: ã‚ã„ã•ã¤ã‚»ãƒƒãƒˆ (1ã€œ24æ–‡å­—)" style="flex:1" oninput="app.pkRender()">
                        </div>
                        <div class="mk-row mb-3" style="align-items:flex-start;">
                            <label>ãƒ¡ã‚¤ãƒ³ç”»åƒ</label>
                            <div style="flex:1" class="p-3 border border-[var(--border)] rounded-xl bg-[rgba(255,255,255,0.02)] flex gap-3">
                                <div style="width:80px; height:80px; border-radius:10px; background:rgba(255,255,255,0.05); display:flex; align-items:center; justify-content:center; overflow:hidden;">
                                    <img id="pk-main-preview" src="" style="width:100%; height:100%; object-fit:contain; display:none">
                                </div>
                                <div class="flex-1">
                                    <div class="text-xs text-sub mb-2">ãƒ‘ãƒƒã‚¯ã®è¡¨ç´™ï¼ˆå¿…é ˆï¼‰</div>
                                    <button class="btn btn-ghost btn-sm" style="width:auto; margin-bottom:5px;" onclick="document.getElementById('pk-main-file').click()">ç”»åƒã‚’é¸æŠ</button>
                                    <button class="btn btn-ghost btn-sm" style="width:auto" onclick="app.pkOpenEditor('main')">ç·¨é›†ãƒ„ãƒ¼ãƒ«</button>
                                    <input id="pk-main-file" type="file" accept="image/*" style="display:none" onchange="app.pkHandleMainFile(this)">
                                </div>
                            </div>
                        </div>
                        <div class="mk-row mb-3" style="align-items:flex-start;">
                            <label>å…¬é–‹è¨­å®š</label>
                            <select id="pk-public" class="input" style="flex:1" onchange="app.pkRender()"><option value="true">ã¿ã‚“ãªã®ã‚¹ã‚¿ãƒ³ãƒ—(å…¬é–‹)</option><option value="false">è‡ªåˆ†ç”¨(éå…¬é–‹)</option></select>
                        </div>
                        <div class="mk-row mb-3" style="align-items:flex-start;">
                            <label>è²©å£²è¨­å®š</label>
                            <div style="flex:1" class="flex flex-col gap-2">
                                <select id="pk-price-type" class="input" onchange="const v=this.value==='paid'; document.getElementById('pk-price-val').classList.toggle('hidden',!v); document.getElementById('pk-price-hint').classList.toggle('hidden',!v); app.pkRender();">
                                    <option value="free">ç„¡æ–™</option><option value="paid">æœ‰æ–™ï¼ˆã‚³ã‚¤ãƒ³ï¼‰</option>
                                </select>
                                <input type="number" id="pk-price-val" class="input hidden" placeholder="ä¾¡æ ¼ (100ã€œ10000ã‚³ã‚¤ãƒ³)" min="100" max="10000" oninput="app.pkRender()">
                                <div class="text-xs text-warning hidden" id="pk-price-hint">â€»å£²ä¸Šã®70%ãŒä½œæˆè€…ã«ã€30%ãŒã‚·ã‚¹ãƒ†ãƒ æ‰‹æ•°æ–™ã¨ãªã‚Šã¾ã™ã€‚</div>
                            </div>
                        </div>
                        <div class="mt-4"><button id="pk-btn-next" class="btn btn-ghost" onclick="app.pkGoToStep2()" disabled>æ¬¡ã¸ (ã‚¹ã‚¿ãƒ³ãƒ—ç™»éŒ²)</button></div>
                    </div>
                </div>
            </div>

            <div id="pk-step-stamps" style="display:none;">
                <div class="card" style="padding:0; overflow:hidden;">
                    <div style="padding:18px; background:linear-gradient(135deg, rgba(88,166,255,0.18), rgba(188,140,255,0.10)); border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center;">
                        <div class="font-bold text-lg">2. ã‚¹ã‚¿ãƒ³ãƒ—ç™»éŒ²</div><button class="btn btn-ghost btn-sm" style="width:auto" onclick="app.pkGoToStep1()">æˆ»ã‚‹</button>
                    </div>
                    <div style="padding:18px;">
                        <div class="flex justify-between items-center mb-3">
                            <span class="text-sm">ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«(è¤‡æ•°å¯)ã‚’é¸æŠã—ã¦ç™»éŒ²</span>
                            <button class="btn btn-primary btn-sm" style="width:auto" onclick="document.getElementById('pk-bulk-file').click()">ï¼‹ ã¾ã¨ã‚ã¦è¿½åŠ </button>
                            <input id="pk-bulk-file" type="file" accept="image/*" multiple style="display:none" onchange="app.pkHandleBulkFiles(this)">
                        </div>
                        <div id="pk-grid" class="pk-grid"></div>
                        <div class="flex gap-2" style="margin-top:14px;"><button class="btn btn-ghost btn-sm" style="width:auto" onclick="app.pkAddEmptySlot(4)">ï¼‹ æ ã‚’å¢—ã‚„ã™</button></div>
                        <div class="mk-hint" style="margin-top:14px;"><div id="pk-validate" class="mk-pill">çŠ¶æ…‹: æœªä½œæˆ</div></div>
                        <div class="flex gap-2 mt-4"><button class="btn btn-primary" onclick="app.pkSubmitPack()">ç”³è«‹ã™ã‚‹</button><button class="btn btn-ghost" onclick="app.pkSaveDraft()">ä¸‹æ›¸ãä¿å­˜</button></div>
                    </div>
                </div>
            </div>

            <!-- Canvas Editor -->
            <div class="card" id="mk-editor-card" style="display:none; margin-top:20px;">
                <div class="flex items-center justify-between mb-2">
                    <h3>ã‚­ãƒ£ãƒ³ãƒã‚¹ç·¨é›†</h3>
                    <div class="flex gap-2"><span class="text-xs text-sub" id="mk-edit-target">slot</span><button class="btn btn-ghost btn-sm" style="width:auto" onclick="app.pkCloseEditor()">é–‰ã˜ã‚‹</button></div>
                </div>
                <div class="mk-toolbar mb-3">
                    <button class="mk-toolbtn active" id="tool-move" onclick="app.mkSetTool('move')">ç§»å‹•</button>
                    <button class="mk-toolbtn" id="tool-pen" onclick="app.mkSetTool('pen')">ãƒšãƒ³</button>
                    <button class="mk-toolbtn" id="tool-rect" onclick="app.mkSetTool('rect')">å››è§’</button>
                    <button class="mk-toolbtn" id="tool-text" onclick="app.mkSetTool('text')">æ–‡å­—</button>
                    <button class="mk-toolbtn" onclick="app.mkUndo()">â†¶ æˆ»ã™</button>
                    <button class="mk-toolbtn" onclick="app.mkClear()">ã‚¯ãƒªã‚¢</button>
                </div>
                <div class="mk-canvas-wrap" style="max-width:360px; margin: 0 auto 10px;">
                    <canvas id="mk-canvas" width="512" height="512"></canvas>
                </div>
                <div class="mk-row mb-2">
                    <label>ç·šã®å¤ªã•</label><input id="mk-stroke" type="range" min="1" max="40" value="8" style="flex:1" onchange="app.mkUpdateStyle()" oninput="app.mkUpdateStyle()"><span class="text-xs text-sub" id="mk-stroke-v">8</span>
                </div>
                <div class="mk-row mb-4">
                    <label>è‰²</label><input id="mk-color" type="color" value="#ffffff" onchange="app.mkUpdateStyle()" oninput="app.mkUpdateStyle()">
                    <button class="mk-toolbtn" onclick="app.mkToggleEraser()" id="mk-eraser">æ¶ˆã—ã‚´ãƒ </button>
                    <button class="mk-toolbtn" onclick="app.mkSetBgTransparent()">èƒŒæ™¯é€é</button>
                    <button class="mk-toolbtn" onclick="app.mkSetBgWhite()">èƒŒæ™¯ç™½</button>
                </div>
                <div class="flex gap-2">
                    <button class="btn btn-primary" onclick="app.pkSaveEditedStamp()">ä¿å­˜ã—ã¦åæ˜ </button>
                    <button class="btn btn-ghost" onclick="app.pkSetAsMainFromCurrent()">ã“ã®ç”»åƒã‚’ãƒ¡ã‚¤ãƒ³ã«</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ“ä½œãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
    <div id="msg-action-sheet" class="bottom-sheet" onclick="if(event.target===this) app.closeMsgAction()">
        <div class="bottom-sheet-content">
            <div id="msg-action-target" class="text-xs text-sub mb-3" style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis; padding: 0 16px;"></div>
            <button class="sheet-btn" onclick="app.prepareReply()">è¿”ä¿¡ã™ã‚‹</button>
            <button id="btn-msg-del" class="sheet-btn danger hidden" onclick="app.execDelMsg()">å‰Šé™¤ã™ã‚‹</button>
            <button class="sheet-btn" onclick="app.closeMsgAction()" style="justify-content:center; color:var(--text-sub); margin-top:10px; border-top:1px solid var(--border);">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
    </div>

    <!-- Login / Auth Screens -->
    <div id="scr-login" class="screen active">
        <div class="auth-container">
            <div class="auth-card">
                <div class="brand-title">COTOBATO</div>
                <input type="text" id="inp-uid" class="input mb-4" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼ID (åŠè§’è‹±æ•°)">
                <div class="input-group mb-4">
                    <input type="password" id="inp-pass" class="input" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
                    <button class="pass-toggle" onclick="app.togglePass('inp-pass', this)">ğŸ‘</button>
                </div>
                <button class="btn btn-primary mb-4" onclick="app.login()">ãƒ­ã‚°ã‚¤ãƒ³</button>
                <div class="flex gap-2 justify-center">
                    <button class="btn btn-ghost btn-sm" onclick="app.go('scr-register')">æ–°è¦ç™»éŒ²</button>
                    <button class="btn btn-ghost btn-sm" onclick="app.go('scr-reset-pass')">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¿˜ã‚ŒãŸ</button>
                </div>
                <div id="loading-msg" class="text-xs text-sub mt-4 hidden"></div>
            </div>
        </div>
    </div>

    <div id="scr-register" class="screen">
        <div class="auth-container">
            <div class="auth-card">
                <h2 class="mb-4">æ–°è¦ç™»éŒ²</h2>
                <input type="text" id="reg-uid" class="input mb-4" placeholder="å¸Œæœ›ID">
                <input type="text" id="reg-name" class="input mb-4" placeholder="è¡¨ç¤ºå (ãƒãƒ£ãƒƒãƒˆã§ã®åå‰)">
                <div class="input-group mb-2">
                    <input type="password" id="reg-pass" class="input" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
                    <button class="pass-toggle" onclick="app.togglePass('reg-pass', this)">ğŸ‘</button>
                </div>
                <div class="text-left text-xs text-sub mb-1">ç§˜å¯†ã®è³ªå• (ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆç”¨)</div>
                <select id="reg-q" class="input mb-2"><option value="pet">åˆã‚ã¦é£¼ã£ãŸãƒšãƒƒãƒˆã®åå‰ã¯ï¼Ÿ</option><option value="school">å°å­¦æ ¡ã®åå‰ã¯ï¼Ÿ</option><option value="mother">æ¯è¦ªã®æ—§å§“ã¯ï¼Ÿ</option><option value="food">å¥½ããªé£Ÿã¹ç‰©ã¯ï¼Ÿ</option></select>
                <input type="text" id="reg-a" class="input mb-4" placeholder="ç­”ãˆ">
                <button class="btn btn-primary mb-4" onclick="app.register()">ç™»éŒ²ã—ã¦é–‹å§‹</button>
                <button class="btn btn-ghost" onclick="app.go('scr-login')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
        </div>
    </div>

    <div id="scr-reset-pass" class="screen">
        <div class="auth-container">
            <div class="auth-card">
                <h2 class="mb-4">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å†è¨­å®š</h2>
                <div id="rst-step-1">
                    <input type="text" id="rst-uid" class="input mb-4" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼ID">
                    <button class="btn btn-primary" onclick="app.checkSecurityQuestion()">æ¬¡ã¸</button>
                </div>
                <div id="rst-step-2" class="hidden">
                    <div class="mb-2 text-sm text-sub">ç§˜å¯†ã®è³ªå•</div>
                    <div id="rst-q-text" class="font-bold mb-4"></div>
                    <input type="text" id="rst-ans" class="input mb-4" placeholder="ç­”ãˆ">
                    <input type="password" id="rst-new-pass" class="input mb-4" placeholder="æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
                    <button class="btn btn-primary" onclick="app.doResetPass()">è¨­å®šå¤‰æ›´</button>
                </div>
                <button class="btn btn-ghost mt-4" onclick="app.go('scr-login')">æˆ»ã‚‹</button>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="scr-main" class="screen">
        <div class="app-layout">
            <nav class="sidebar">
                <div class="sidebar-brand" onclick="location.reload()">COTOBATO</div>
                <div class="nav-link active" onclick="app.tab('home')" data-tab="home">ãƒ›ãƒ¼ãƒ </div>
                <div class="nav-link" onclick="app.tab('chat')" data-tab="chat">ãƒãƒ£ãƒƒãƒˆ</div>
                <div class="nav-link" onclick="app.tab('trade')" data-tab="trade">å–å¼•æ‰€</div>
                <div class="nav-link" onclick="app.tab('stamps')" data-tab="stamps">ã‚¹ã‚¿ãƒ³ãƒ—</div>
                <div class="nav-link" onclick="app.tab('settings')" data-tab="settings">è¨­å®š</div>
                <div class="nav-link hidden" id="nav-adm-pc" style="color:var(--warning)" onclick="app.tab('admin')" data-tab="admin">é‹å–¶ç®¡ç†</div>
            </nav>

            <div class="main-content">
                <header class="header-mobile"><span>Cotobato</span><span id="header-user-name" class="header-user">Guest</span></header>

                <div id="tab-home" class="scroll-view">
                    <div id="profile-badges-top" class="mb-2 text-center"></div>
                    <div class="res-grid">
                        <div class="res-box"><span class="res-label">LEVEL</span><span class="res-val" id="v-level">1</span></div>
                        <div class="res-box"><span class="res-label">COINS</span><span class="res-val" id="v-coin" style="color:var(--warning)">0</span></div>
                        <div class="res-box"><span class="res-label">GEMS</span><span class="res-val" id="v-gem" style="color:var(--primary)">0</span></div>
                    </div>
                    <div class="card flex items-center justify-between" style="border-color:var(--warning)">
                        <div><div class="font-bold text-sm" style="color:var(--warning)">ãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆBOX</div><div class="text-xs text-sub">ãƒ­ã‚°ã‚¤ãƒ³ãƒœãƒ¼ãƒŠã‚¹ç­‰</div></div>
                        <button class="btn btn-sm btn-primary" style="background:var(--warning); color:#000; width:auto;" onclick="app.checkGifts()">ç¢ºèª</button>
                    </div>
                    <h3 class="font-bold mb-4 mt-4">ãŠçŸ¥ã‚‰ã›</h3>
                    <div id="news-list" class="flex-col flex"></div>
                </div>

                <div id="tab-chat" class="hidden" style="height:100%; flex-direction:column; background:var(--bg-body);">
                    <div class="chat-header">
                        <div class="chat-switcher">
                            <span class="chat-sw-btn active" id="sw-all" onclick="app.switchChatMode('all')">å…¨ä½“ãƒãƒ£ãƒƒãƒˆ</span>
                            <span class="chat-sw-btn" id="sw-dm" onclick="app.switchChatMode('dm')">å‹é”ãƒ»DM</span>
                        </div>
                    </div>
                    
                    <div id="area-all-chat" style="display:flex; flex-direction:column; flex:1; overflow:hidden;">
                        <div id="chat-box" class="chat-list"></div>
                        <div class="chat-input-wrapper">
                            <div id="chat-reply-preview">
                                <div style="flex:1; overflow:hidden;"><div class="reply-name-preview" id="chat-rep-name"></div><div class="reply-text-preview" id="chat-rep-text"></div></div>
                                <img id="chat-rep-img" class="reply-thumb hidden"><button class="btn btn-ghost btn-sm" style="width:auto; padding:4px;" onclick="app.cancelReply('all')">âœ•</button>
                            </div>
                            <form class="chat-input-area" onsubmit="event.preventDefault(); app.sendChat();">
                                <label class="btn btn-ghost" style="width:40px; padding:0; cursor:pointer;" onclick="app.openStampModal()"><span style="font-size:1.2rem">ğŸ˜Š</span></label>
                                <label class="btn btn-ghost" style="width:40px; padding:0; cursor:pointer;">ğŸ“·<input type="file" id="chat-file" accept="image/*" style="display:none" onchange="app.handleFileSelect(this, 'chat')"></label>
                                <input type="text" id="chat-in" class="input" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸..." style="margin:0;">
                                <button type="submit" class="btn btn-primary" style="width:50px; padding:0;">â¤</button>
                            </form>
                            <div id="chat-preview"><img id="chat-preview-img" class="preview-thumb"><span class="text-xs text-sub">ç”»åƒã‚’é€ä¿¡ã—ã¾ã™</span><button class="btn btn-ghost btn-sm" style="margin-left:auto;" onclick="app.clearChatImg()">å–æ¶ˆ</button></div>
                        </div>
                    </div>

                    <div id="area-dm-list" style="display:none; flex-direction:column; flex:1; overflow-y:auto; padding:10px;">
                        <div class="card" style="padding:15px; margin-bottom:15px; border-color:var(--primary);">
                            <div class="font-bold text-sm mb-2">å‹é”è¿½åŠ </div>
                            <div class="text-xs text-sub mb-2">ç›¸æ‰‹ã®IDã‚’å…¥åŠ›ã—ã¦æ¤œç´¢ã—ã¦ãã ã•ã„ã€‚</div>
                            <div class="flex gap-2 mb-2">
                                <input type="text" id="inline-friend-id" class="input" placeholder="ID (ä¾‹: user123)">
                                <button class="btn btn-primary" style="width:auto" onclick="app.searchUserForFriendInline()">æ¤œç´¢</button>
                            </div>
                            <div id="inline-friend-result" class="text-center"></div>
                        </div>
                        <div class="card" style="padding:15px; margin-bottom:15px;">
                            <div class="font-bold text-sm mb-2" style="color:var(--warning)">å±Šã„ã¦ã„ã‚‹ç”³è«‹</div>
                            <div id="requests-list" class="mb-2"></div>
                            <hr style="border-color:var(--border); margin:10px 0;">
                            <div class="font-bold text-sm mb-2 text-sub">é€ã£ãŸç”³è«‹</div>
                            <div id="outgoing-list"></div>
                        </div>
                        <div class="font-bold text-sm mb-2 px-2">å‹é”ãƒªã‚¹ãƒˆ</div>
                        <div id="dm-list-box"></div>
                    </div>
                </div>

                <div id="scr-dm-talk" class="screen" style="background:var(--bg-body); z-index:30;">
                    <div class="chat-header">
                        <div onclick="app.closeDM()" style="cursor:pointer; color:var(--primary);">â† æˆ»ã‚‹</div>
                        <span id="dm-talk-name">ç›¸æ‰‹ã®åå‰</span>
                        <div style="display:flex; align-items:center;">
                             <button class="btn btn-ghost" style="width:40px; padding:0; margin-right:5px; color:var(--success);" onclick="app.startCall(false)">ğŸ“</button>
                             <button class="btn btn-ghost" style="width:40px; padding:0; margin-right:5px; color:var(--primary);" onclick="app.startCall(true)">ğŸ“¹</button>
                        </div>
                    </div>
                    <div id="dm-talk-box" class="chat-list"></div>
                    <div class="chat-input-wrapper">
                        <div id="dm-reply-preview">
                            <div style="flex:1; overflow:hidden;"><div class="reply-name-preview" id="dm-rep-name"></div><div class="reply-text-preview" id="dm-rep-text"></div></div>
                            <img id="dm-rep-img" class="reply-thumb hidden"><button class="btn btn-ghost btn-sm" style="width:auto; padding:4px;" onclick="app.cancelReply('dm')">âœ•</button>
                        </div>
                        <form class="chat-input-area" onsubmit="event.preventDefault(); app.sendDM();">
                            <label class="btn btn-ghost" style="width:40px; padding:0; cursor:pointer;" onclick="app.openStampModal()"><span style="font-size:1.2rem">ğŸ˜Š</span></label>
                            <label class="btn btn-ghost" style="width:40px; padding:0; cursor:pointer;">ğŸ“·<input type="file" id="dm-file" accept="image/*" style="display:none" onchange="app.handleFileSelect(this, 'dm')"></label>
                            <input type="text" id="dm-in" class="input" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸..." style="margin:0;">
                            <button type="submit" class="btn btn-primary" style="width:50px; padding:0;">â¤</button>
                        </form>
                        <div id="dm-preview" style="display:none; padding:10px 15px 0; align-items:center; gap:10px;">
                            <img id="dm-preview-img" class="preview-thumb"><span class="text-xs text-sub">ç”»åƒ</span><button class="btn btn-ghost btn-sm" style="margin-left:auto;" onclick="app.clearDMImg()">å–æ¶ˆ</button>
                        </div>
                    </div>
                </div>

                <div id="tab-trade" class="scroll-view hidden">
                    <div class="stamp-tabs mb-4">
                        <div class="stamp-tab active" onclick="app.switchTradeTab('exchange')" id="sw-trade-exchange">ç‰©ã€…äº¤æ›æ‰€</div>
                        <div class="stamp-tab" onclick="app.switchTradeTab('market')" id="sw-trade-market">ãƒ•ãƒªãƒ(ã‚·ãƒ§ãƒƒãƒ—)</div>
                    </div>

                    <div id="trade-area-exchange">
                        <div class="card">
                            <div class="flex items-center justify-between mb-2"><h3>å‡ºå“ (ç‰©ã€…äº¤æ›)</h3><span class="text-xs text-sub">è¤‡æ•°é¸æŠå¯¾å¿œ</span></div>
                            <div class="mb-2 font-bold text-sm">ã€å‡ºã€‘ å‡ºã™ã‚‚ã®</div>
                            <div id="tr-give-rows" class="flex flex-col gap-2 mb-2"></div>
                            <div class="flex gap-2 mb-4"><button class="btn btn-ghost btn-sm" style="width:auto" onclick="app.addTradeRow('give')">ï¼‹ è¿½åŠ </button><button class="btn btn-ghost btn-sm" style="width:auto" onclick="app.clearTradeRows('give')">ã‚¯ãƒªã‚¢</button></div>
                            <div class="mb-2 font-bold text-sm mt-4">ã€æ±‚ã€‘ æ¬²ã—ã„ã‚‚ã®</div>
                            <div id="tr-want-rows" class="flex flex-col gap-2 mb-2"></div>
                            <div class="flex gap-2 mb-4"><button class="btn btn-ghost btn-sm" style="width:auto" onclick="app.addTradeRow('want')">ï¼‹ è¿½åŠ </button><button class="btn btn-ghost btn-sm" style="width:auto" onclick="app.clearTradeRows('want')">ã‚¯ãƒªã‚¢</button></div>
                            <div class="mb-4 mt-2"><input type="text" id="tr-pass" class="input" placeholder="ã‚ã„ã“ã¨ã° (ä»»æ„)"></div>
                            <button class="btn btn-primary" onclick="app.createTrade()">å‡ºå“ã‚’å…¬é–‹</button>
                        </div>
                        <h3>å–å¼•ä¸€è¦§</h3><div id="trade-list" class="flex flex-col gap-2"></div>
                    </div>

                    <div id="trade-area-market" class="hidden flex-col gap-4">
                        <div class="card">
                            <h3 class="mb-3">ãƒ•ãƒªãƒã«å‡ºå“ï¼ˆã‚³ã‚¤ãƒ³ã§è²©å£²ï¼‰</h3>
                            <div class="flex gap-2 items-center mb-2">
                                <select id="mk-sell-type" class="input" style="width:40%" onchange="app.onMarketTypeChange()"><option value="item">æ¶ˆè²»ã‚¢ã‚¤ãƒ†ãƒ </option><option value="amulet">ãŠå®ˆã‚Š</option></select>
                                <div id="mk-sell-valwrap" style="flex:1"></div>
                            </div>
                            <div class="flex gap-2 items-center mb-4"><label class="text-xs text-sub" style="width:40%">è²©å£²ä¾¡æ ¼(ã‚³ã‚¤ãƒ³)</label><input type="number" id="mk-sell-price" class="input" placeholder="ä¾‹: 1000" min="10"></div>
                            <button class="btn btn-primary" onclick="app.createMarketItem()">å‡ºå“ã™ã‚‹</button>
                        </div>
                        <h3>ã‚·ãƒ§ãƒƒãƒ—ï¼ˆå‡ºå“ä¸€è¦§ï¼‰</h3><div id="market-list" class="flex flex-col gap-2"></div>
                    </div>
                </div>

                <div id="tab-stamps" class="scroll-view hidden">
                    <div class="card">
                        <h3 class="mb-2">è‡ªåˆ†ã®ç”³è«‹ãƒ‘ãƒƒã‚¯</h3>
                        <button class="btn btn-primary mb-3" onclick="app.openStampMaker()">ï¼‹ æ–°ã—ãã‚¹ã‚¿ãƒ³ãƒ—ã‚’ä½œã‚‹</button>
                        <div id="stamps-top-list" class="flex flex-col gap-2"></div>
                    </div>
                </div>

                <div id="tab-settings" class="scroll-view hidden">
                    <div class="card">
                        <h3>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</h3>
                        <div class="mb-4"><label class="text-xs text-sub">è¡¨ç¤ºå</label><input type="text" id="set-name" class="input"></div>
                        <button class="btn btn-primary" onclick="app.updateProfile()">ä¿å­˜</button>
                    </div>
                    <div class="card" style="border-color:var(--primary)">
                        <h3 style="color:var(--primary)">ã‚²ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿åŒæœŸ</h3>
                        <div class="text-xs text-sub mb-3">ãƒ–ãƒ©ã‚¦ã‚¶ã® <b>kb_save_v60</b> ã‚’åºƒå ´ã¸åŒæœŸã—ã¾ã™ã€‚<br>â€»ã‚³ã‚¤ãƒ³/ãƒ€ã‚¤ãƒ¤/ãƒ¬ãƒ™ãƒ«ã¯åºƒå ´å´ã®å€¤ã‚’å„ªå…ˆã—ã¾ã™ã€‚</div>
                        <div class="flex gap-2 mb-2">
                            <button class="btn btn-primary" onclick="app.importFullFromGame()">ğŸ“¥ å–ã‚Šè¾¼ã‚€</button>
                            <button class="btn btn-ghost" onclick="app.exportFullToGame()">ğŸ“¤ ã‚²ãƒ¼ãƒ ã¸åæ˜ </button>
                        </div>
                    </div>
                    <div class="card">
                        <h3>ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã¨å¾©å…ƒ</h3>
                        <div class="flex gap-2 mb-2">
                            <button class="btn btn-primary" onclick="app.backupFullGameData()">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆ</button>
                            <button class="btn btn-danger" onclick="app.restoreCloudList()">å±¥æ­´ã‹ã‚‰å¾©å…ƒ</button>
                        </div>
                    </div>
                    <div class="card">
                        <h3>ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ</h3>
                        <div class="text-xs text-sub mb-4">ID: <span id="set-uid"></span></div>
                        <button class="btn btn-danger" onclick="app.logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
                    </div>
                    <div class="card">
                        <h3>é‹å–¶èªè¨¼</h3>
                        <input type="password" id="adm-code" class="input mb-4" placeholder="é‹å–¶ã‚³ãƒ¼ãƒ‰">
                        <button class="btn btn-ghost" onclick="app.authAdmin()">èªè¨¼</button>
                    </div>
                </div>

                <div id="tab-admin" class="scroll-view hidden">
                    <div class="card" style="border-color:var(--primary)">
                        <h3 style="color:var(--primary)">ã‚¹ã‚¿ãƒ³ãƒ—å¯©æŸ»</h3>
                        <div class="flex gap-2 mb-3">
                            <button class="btn btn-ghost btn-sm" style="width:auto" onclick="app.admLoadStampQueue()">æ›´æ–°</button>
                            <button class="btn btn-ghost btn-sm" style="width:auto" onclick="app.admShowApprovedStamps()">æ‰¿èªæ¸ˆã¿ä¸€è¦§</button>
                        </div>
                        <div id="adm-stamp-queue"></div>
                    </div>
                    <div class="card" style="border-color:var(--warning)">
                        <h3 style="color:var(--warning)">ãŠçŸ¥ã‚‰ã›é…ä¿¡</h3>
                        <input type="hidden" id="adm-news-id">
                        <input type="text" id="adm-news-title" class="input mb-2" placeholder="ã‚¿ã‚¤ãƒˆãƒ«">
                        <textarea id="adm-news-body" class="input mb-2" style="min-height:80px" placeholder="æœ¬æ–‡"></textarea>
                        <div class="flex gap-2 items-center mb-2"><label class="btn btn-ghost btn-sm" style="width:auto">ç”»åƒ<input type="file" id="adm-news-file" accept="image/*" style="display:none" onchange="app.handleFileSelect(this, 'news')"></label><span id="adm-news-file-status" class="text-xs text-sub">æœªé¸æŠ</span></div>
                        <div class="flex gap-4 items-center mb-4">
                            <label class="flex items-center gap-2 text-sm"><input type="checkbox" id="adm-news-pin"> å›ºå®š</label>
                            <div class="flex flex-col"><label class="text-xs text-sub">å…¬é–‹äºˆç´„</label><input type="datetime-local" id="adm-news-date" class="input" style="width:auto; padding:6px;"></div>
                        </div>
                        <div class="flex gap-2"><button id="btn-news-post" class="btn btn-primary" onclick="app.postNews()">é…ä¿¡ç™»éŒ²</button><button id="btn-news-cancel" class="btn btn-ghost hidden" onclick="app.resetNewsForm()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button></div>
                    </div>
                    <div class="card">
                        <h3>ãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆé…å¸ƒ</h3>
                        <input type="hidden" id="adm-gift-id">
                        <div class="flex gap-2 mb-2"><select id="adm-gift-type" class="input"><option value="coins">ã‚³ã‚¤ãƒ³</option><option value="diamonds">ãƒ€ã‚¤ãƒ¤</option></select><input type="number" id="adm-gift-val" class="input" placeholder="é‡"></div>
                        <input type="text" id="adm-gift-msg" class="input mb-2" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸">
                        <div class="flex flex-col gap-2 mb-4">
                            <div class="flex flex-col"><label class="text-xs text-sub">é…å¸ƒé–‹å§‹æ—¥æ™‚</label><input type="datetime-local" id="adm-gift-start" class="input" style="padding:6px;"></div>
                            <div class="flex flex-col"><label class="text-xs text-sub">å—å–æœŸé™</label><input type="datetime-local" id="adm-gift-end" class="input" style="padding:6px;"></div>
                        </div>
                        <div class="flex gap-2"><button id="btn-gift-post" class="btn btn-danger" onclick="app.distributeGift()">å…¨å“¡ã«é…å¸ƒ</button><button id="btn-gift-cancel" class="btn btn-ghost hidden" onclick="app.resetGiftForm()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button></div>
                    </div>
                    <h3 class="mt-4 mb-2">é…ä¿¡ä¸­ã®ãŠçŸ¥ã‚‰ã›</h3><div id="adm-list-news"></div>
                    <h3 class="mt-4 mb-2">é…å¸ƒæ¸ˆã¿ã‚®ãƒ•ãƒˆ</h3><div id="adm-list-gifts"></div>
                </div>
            </div>

            <nav class="bottom-nav">
                <div class="b-nav-item active" onclick="app.tab('home')" data-tab="home">ğŸ <br>ãƒ›ãƒ¼ãƒ </div>
                <div class="b-nav-item" onclick="app.tab('chat')" data-tab="chat">ğŸ’¬<br>ãƒãƒ£ãƒƒãƒˆ</div>
                <div class="b-nav-item" onclick="app.tab('trade')" data-tab="trade">âš–ï¸<br>å–å¼•æ‰€</div>
                <div class="b-nav-item" onclick="app.tab('stamps')" data-tab="stamps">ğŸ¨<br>ã‚¹ã‚¿ãƒ³ãƒ—</div>
                <div class="b-nav-item" onclick="app.tab('settings')" data-tab="settings">âš™ï¸<br>è¨­å®š</div>
            </nav>
        </div>
    </div>

    <div id="modal-base" class="modal-overlay" onclick="if(event.target===this)app.closeModal()">
        <div class="modal-box">
            <div class="modal-head"><span id="mdl-title"></span><button class="btn btn-ghost" style="width:30px;padding:0" onclick="app.closeModal()">âœ•</button></div>
            <div id="mdl-content" class="modal-body"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, addDoc, onSnapshot, serverTimestamp, query, limit, where, deleteDoc, Timestamp, getDocs, increment, runTransaction, arrayUnion } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDguL7I5v4GxKf5FahdoFEtU5lNMYgxcNo",
            authDomain: "cotobato-c121f.firebaseapp.com",
            databaseURL: "https://cotobato-c121f-default-rtdb.firebaseio.com",
            projectId: "cotobato-c121f",
            storageBucket: "cotobato-c121f.firebasestorage.app",
            messagingSenderId: "699569737682",
            appId: "1:699569737682:web:350b90c25c300a0548020b"
        };

        const fApp = initializeApp(firebaseConfig);
        const db = getFirestore(fApp);
        const auth = getAuth(fApp);
        const SESS_KEY = "kb_user_id";
        const ADM_KEY = "kb_adm_exp";
        const KB_SAVE_KEY = "kb_save_v60"; 

        let currentUser = null;
        let listeners = [];
        let chatImg = null; let dmImg = null; let newsImg = null; let newsImgOriginal = null;
        let currentRoomId = null; 
        let dmUnsub = null;
        let currentStampTab = 'public';
        const PK_DRAFT_KEY = 'kb_stamp_pack_draft_v1';
        let actionMsg = null; let replyTarget = { all: null, dm: null };
        const appCache = { news: {}, gifts: {} };
        const toDate = (ts) => { if (!ts) return new Date(); if (ts.toDate) return ts.toDate(); if (ts instanceof Date) return ts; return new Date(); };
        const safeArgs = (s) => s ? s.replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/"/g, '&quot;').replace(/\n/g, '\\n') : '';

        // WebRTC variables
        let peer = null; let incomingCallObj = null; let callStatus = 'idle'; let localStream = null; let remoteStream = null; let currentCall = null;

        // Static Game Data for Trading/Market
        const G_ITEMS = [
            { id: 'potion1', name: 'ã¡ã‚‡ã“ã£ã¨å›å¾©è–¬', icon:'ğŸ’Š' },
            { id: 'potion2', name: 'ã¡ã‚ƒã£ã‹ã‚Šå›å¾©è–¬', icon:'ğŸ§ª' },
            { id: 'potion3', name: 'ã‚‚ã‚Šã‚‚ã‚Šå›å¾©è–¬', icon:'ğŸ’‰' },
            { id: 'skip', name: 'ã‚¹ã‚­ãƒƒãƒ—', icon:'â©' },
            { id: 'morning_call', name: 'ã‚¢ã‚µãƒ‹ãƒŠï½ãƒ«', icon:'â˜€ï¸' },
            { id: 'night_call', name: 'ãƒ¨ãƒ«ãƒ‹ãƒŠï½ãƒ«', icon:'ğŸŒ™' },
            { id: 'hina_heart', name: 'ã²ãªã®æ°—æŒã¡', icon:'â¤ï¸' }
        ];
        const G_AMULETS = [
            { id: 'amulet_hp', name: 'å†ç”Ÿã®ãŠå®ˆã‚Š', icon:'ğŸ›¡ï¸', durability: 100 },
            { id: 'amulet_rich', name: 'å¯Œè±ªã®ãŠå®ˆã‚Š', icon:'ğŸ’°', durability: 200 },
            { id: 'amulet_drop', name: 'å¹¸é‹ã®ãŠå®ˆã‚Š', icon:'ğŸ€', durability: 200 },
            { id: 'amulet_pow', name: 'åŠ›ã®æŒ‡è¼ª', icon:'ğŸ’', durability: 200 },
            { id: 'amulet_def', name: 'å®ˆã‚Šã®ç›¾', icon:'ğŸ›¡ï¸', durability: 200 },
            { id: 'amulet_poison1', name: 'æ¯’é™¤ã‘I', icon:'ğŸ§ª', durability: 150 },
            { id: 'amulet_poison2', name: 'æ¯’é™¤ã‘II', icon:'ğŸ§ª', durability: 200 },
            { id: 'amulet_poison3', name: 'æ¯’é™¤ã‘å®Œå…¨', icon:'ğŸ§ª', durability: 300 },
            { id: 'amulet_burn1', name: 'ç«é™¤ã‘I', icon:'ğŸ”¥', durability: 150 },
            { id: 'amulet_burn2', name: 'ç«é™¤ã‘II', icon:'ğŸ”¥', durability: 200 },
            { id: 'amulet_burn3', name: 'ç«é™¤ã‘å®Œå…¨', icon:'ğŸ”¥', durability: 300 }
        ];
        const getMeta = (type, id) => {
            if(type==='item') return G_ITEMS.find(c=>c.id===id) || {name:id, icon:'?'};
            if(type==='amulet') return G_AMULETS.find(c=>c.id===id) || {name:id, icon:'?'};
            return {name:id, icon:''};
        };

        const app = {
            pkDraft: { title: '', isPublic: true, isPaid: false, price: 0, mainDataUrl: '', stamps: [] },
            
            init: () => {
                signInAnonymously(auth).then(() => {
                    onAuthStateChanged(auth, u => { if(u) {
                        const uid = localStorage.getItem(SESS_KEY);
                        if(uid) app.loadUser(uid);
                        else {
                            document.getElementById('splash-screen').classList.add('fade-out');
                            setTimeout(() => document.getElementById('splash-screen').style.display = 'none', 500);
                        }
                    }});
                }).catch(e => { console.error(e); document.getElementById('splash-screen').style.display='none'; });
            },
            go: (id) => { document.querySelectorAll('.screen').forEach(e=>e.classList.remove('active')); document.getElementById(id).classList.add('active'); },
            tab: (id) => {
                ['home','chat','trade','stamps','settings','admin'].forEach(t=>{const e=document.getElementById('tab-'+t); if(e) e.classList.add('hidden')});
                const t = document.getElementById('tab-'+id);
                if(t){ t.classList.remove('hidden'); if(t.classList.contains('scroll-view')) t.classList.add('flex-col','flex'); }
                if(id==='chat') { t.style.display='flex'; document.body.classList.add('chat-mode'); app.switchChatMode('all'); } else document.body.classList.remove('chat-mode');
                if(id==='trade') { try { app.initTradeUI(); app.onMarketTypeChange(); } catch(e) {} }
                if(id==='stamps') { try { app.loadMyStampsTop(); } catch(e) {} }
                if(id==='admin') { if(!app.checkAdmSess()) { app.tab('settings'); return; } else { app.admLoadStampQueue(); app.subAdmList(); } }
                document.querySelectorAll('.nav-link, .b-nav-item').forEach(e=>e.classList.remove('active'));
                document.querySelectorAll(`[data-tab="${id}"]`).forEach(e=>e.classList.add('active'));
            },
            
            login: async () => {
                const uid = document.getElementById('inp-uid').value.trim(), pass = document.getElementById('inp-pass').value.trim();
                if(!uid || !pass) return app.toast("å…¥åŠ›ã—ã¦ãã ã•ã„");
                try {
                    const s = await getDoc(doc(db,"users",uid));
                    if(s.exists() && s.data().password === pass) { localStorage.setItem(SESS_KEY, uid); app.loadUser(uid); } 
                    else { app.toast("IDã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™"); }
                } catch(e) { app.toast("æ¥ç¶šã‚¨ãƒ©ãƒ¼"); }
            },
            register: async () => {
                const uid = document.getElementById('reg-uid').value.trim();
                const name = document.getElementById('reg-name').value.trim()||uid;
                const pass = document.getElementById('reg-pass').value.trim();
                const sq = document.getElementById('reg-q').value;
                const sa = document.getElementById('reg-a').value.trim();
                if(!uid || !pass) return app.toast("IDã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯å¿…é ˆã§ã™");
                if(!sa) return app.toast("ç§˜å¯†ã®è³ªå•ã®ç­”ãˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
                try {
                    const s = await getDoc(doc(db,"users",uid));
                    if(s.exists()) return app.toast("æ—¢ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™");
                    await setDoc(doc(db,"users",uid), { 
                        uid, username:uid, name, password:pass, secretQ:sq, secretA:sa,
                        coins:100, diamonds:0, level:1, badges: [], purchasedPacks: [], createdAt:serverTimestamp(), friends:[], history:[]
                    });
                    localStorage.setItem(SESS_KEY, uid); app.loadUser(uid);
                } catch(e) { app.toast("ç™»éŒ²ã‚¨ãƒ©ãƒ¼"); }
            },
            loadUser: async (uid) => {
                listeners.push(onSnapshot(doc(db,"users",uid), async s=>{
                    if(s.exists()){ 
                        currentUser=s.data(); 
                        app.checkAutoBadges(); app.renderHead(); app.checkAdmSess();
                        if(!peer) app.initPeer(currentUser.username);
                        document.getElementById('splash-screen').classList.add('fade-out');
                        setTimeout(() => document.getElementById('splash-screen').style.display = 'none', 500);
                        app.go('scr-main'); 
                        if(document.querySelectorAll('.screen.active').length <= 1) app.tab('home');
                    } else { localStorage.removeItem(SESS_KEY); location.reload(); }
                }));
                app.subNews(); app.subChat(); app.subTrade(); app.subMarket(); app.subDMList(uid); app.subRequests(uid);
            },
            logout: () => { localStorage.removeItem(SESS_KEY); localStorage.removeItem(ADM_KEY); location.reload(); },

            // Badges
            checkAutoBadges: async () => {
                if(!currentUser) return;
                const b = currentUser.badges || [];
                let added = false;
                const add = (id) => { if(!b.includes(id)) { b.push(id); added=true; } };
                if((currentUser.level||1) >= 10) add('level10');
                if((currentUser.level||1) >= 30) add('level30');
                if((currentUser.coins||0) >= 100000) add('rich');
                if((currentUser.diamonds||0) >= 1000) add('whale');
                if(added) await updateDoc(doc(db, "users", currentUser.username), { badges: b });
            },
            getBadgesHtml: (bArr) => {
                let b = bArr || []; let html = "";
                if(b.includes('developer')) html += `<span class="badge badge-developer">é–‹ç™ºè€…</span>`;
                if(b.includes('staff')) html += `<span class="badge badge-staff">é–¢ä¿‚è€…</span>`;
                if(b.includes('bug')) html += `<span class="badge badge-bug">ãƒã‚°ç™ºè¦‹è€…</span>`;
                if(b.includes('vip')) html += `<span class="badge badge-vip">VIP</span>`;
                if(b.includes('veteran')) html += `<span class="badge badge-veteran">å¤å‚</span>`;
                if(b.includes('level30')) html += `<span class="badge badge-level">Lv.30+</span>`;
                else if(b.includes('level10')) html += `<span class="badge badge-level">Lv.10+</span>`;
                if(b.includes('rich')) html += `<span class="badge badge-rich">å¯Œè±ª</span>`;
                if(b.includes('whale')) html += `<span class="badge badge-whale">ğŸ’å¤§å¯Œè±ª</span>`;
                return html;
            },
            renderHead: () => {
                document.getElementById('header-user-name').innerText=currentUser.name; document.getElementById('set-name').value=currentUser.name; 
                document.getElementById('set-uid').innerText = currentUser.username;
                document.getElementById('profile-badges-top').innerHTML = app.getBadgesHtml(currentUser.badges);
                document.getElementById('v-coin').innerText=(currentUser.coins||0).toLocaleString(); 
                document.getElementById('v-gem').innerText=(currentUser.diamonds||0).toLocaleString(); 
                document.getElementById('v-level').innerText=currentUser.level||1;
            },
            updateProfile: async () => {
                const name = document.getElementById('set-name').value.trim();
                if(!name) return;
                await updateDoc(doc(db, "users", currentUser.username), { name: name });
                app.toast("æ›´æ–°ã—ã¾ã—ãŸ");
            },

            // Pass Reset
            checkSecurityQuestion: async () => {
                const uid = document.getElementById('rst-uid').value.trim();
                if(!uid) return app.toast("IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
                try {
                    const snap = await getDoc(doc(db, "users", uid));
                    if(!snap.exists()) return app.toast("ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
                    const d = snap.data();
                    if(!d.secretQ) return app.toast("ç§˜å¯†ã®è³ªå•ãŒæœªè¨­å®šã§ã™");
                    const qText = { pet: "åˆã‚ã¦é£¼ã£ãŸãƒšãƒƒãƒˆã®åå‰ã¯ï¼Ÿ", school: "å°å­¦æ ¡ã®åå‰ã¯ï¼Ÿ", mother: "æ¯è¦ªã®æ—§å§“ã¯ï¼Ÿ", food: "å¥½ããªé£Ÿã¹ç‰©ã¯ï¼Ÿ" }[d.secretQ] || "ç§˜å¯†ã®è³ªå•";
                    document.getElementById('rst-q-text').innerText = qText;
                    document.getElementById('rst-step-1').classList.add('hidden');
                    document.getElementById('rst-step-2').classList.remove('hidden');
                    app.resetTargetUid = uid;
                } catch(e) { app.toast("ã‚¨ãƒ©ãƒ¼"); }
            },
            doResetPass: async () => {
                const ans = document.getElementById('rst-ans').value.trim();
                const newPass = document.getElementById('rst-new-pass').value.trim();
                if(!ans || !newPass) return app.toast("å…¨ã¦å…¥åŠ›ã—ã¦ãã ã•ã„");
                try {
                    const snap = await getDoc(doc(db, "users", app.resetTargetUid));
                    if(snap.data().secretA === ans) {
                        await updateDoc(doc(db, "users", app.resetTargetUid), { password: newPass });
                        app.toast("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ã¾ã—ãŸ"); app.go('scr-login');
                    } else app.toast("ç­”ãˆãŒé•ã„ã¾ã™");
                } catch(e) {}
            },
            togglePass: (id, btn) => {
                const el = document.getElementById(id);
                if(el) { const isPass = el.type === 'password'; el.type = isPass ? 'text' : 'password'; btn.innerText = isPass ? "âœ•" : "ğŸ‘"; }
            },

            // Profile & Manage Badges
            showProfile: async (uid, name) => {
                if(uid === currentUser.username) return;
                try {
                    const snap = await getDoc(doc(db, "users", uid));
                    if(!snap.exists()) return app.toast("ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
                    const target = snap.data();
                    const isFriend = currentUser.friends && currentUser.friends.includes(uid);
                    let btnHtml = isFriend ? `<button class="btn btn-success mt-2" onclick="app.startDM('${uid}', '${name.replace(/'/g,"\\'")}')">ãƒãƒ£ãƒƒãƒˆã™ã‚‹</button>` : `<button class="btn btn-primary mt-2" onclick="app.sendRequest('${uid}')">å‹é”ç”³è«‹ã™ã‚‹</button>`;
                    const myB = currentUser.badges || [];
                    if(myB.includes('developer') || myB.includes('staff')) {
                        btnHtml += `<button class="btn btn-warning mt-2" onclick="app.manageBadges('${uid}')">ãƒãƒƒã‚¸ã‚’ç®¡ç†ã™ã‚‹</button>`;
                    }
                    app.mdl("ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«", `<div style="text-align:center"><div style="font-size:3rem; margin-bottom:10px;">ğŸ‘¤</div><h3>${target.name}</h3><div class="mb-2">${app.getBadgesHtml(target.badges)}</div><p class="text-sub text-xs mb-4">ID: ${uid}</p>${btnHtml}</div>`);
                } catch(e) {}
            },
            manageBadges: async (targetUid) => {
                const s = await getDoc(doc(db, "users", targetUid));
                if(!s.exists()) return;
                const t = s.data(); const b = t.badges || [];
                let html = `<div class="flex flex-col gap-3 mb-4">
                    <label><input type="checkbox" id="mb-dev" ${b.includes('developer')?'checked':''}> é–‹ç™ºè€…</label>
                    <label><input type="checkbox" id="mb-staff" ${b.includes('staff')?'checked':''}> é–¢ä¿‚è€…</label>
                    <label><input type="checkbox" id="mb-bug" ${b.includes('bug')?'checked':''}> ãƒã‚°ç™ºè¦‹è€…</label>
                    <label><input type="checkbox" id="mb-vip" ${b.includes('vip')?'checked':''}> VIP</label>
                    <label><input type="checkbox" id="mb-veteran" ${b.includes('veteran')?'checked':''}> å¤å‚</label>
                </div>
                <button class="btn btn-warning" onclick="app.saveManagedBadges('${targetUid}')">ä¿å­˜</button>`;
                app.mdl("ãƒãƒƒã‚¸ç®¡ç†: " + t.name, html);
            },
            saveManagedBadges: async (targetUid) => {
                const s = await getDoc(doc(db, "users", targetUid));
                if(!s.exists()) return;
                const b = s.data().badges || [];
                const handBadges = ['developer','staff','bug','vip','veteran'];
                const newB = b.filter(x => !handBadges.includes(x));
                if(document.getElementById('mb-dev').checked) newB.push('developer');
                if(document.getElementById('mb-staff').checked) newB.push('staff');
                if(document.getElementById('mb-bug').checked) newB.push('bug');
                if(document.getElementById('mb-vip').checked) newB.push('vip');
                if(document.getElementById('mb-veteran').checked) newB.push('veteran');
                await updateDoc(doc(db, "users", targetUid), { badges: newB });
                app.toast("æ›´æ–°ã—ã¾ã—ãŸ"); app.closeModal(); app.showProfile(targetUid, s.data().name);
            },

            // WebRTC Call
            initPeer: (uid) => {
                if(peer) return;
                try {
                    peer = new Peer(uid);
                    peer.on('call', (c) => {
                        if(callStatus!=='idle'){c.close();return;}
                        incomingCallObj=c; callStatus='incoming';
                        const m=c.metadata||{}; document.getElementById('inc-call-name').innerText=m.name||c.peer; document.getElementById('inc-call-type').innerText=m.video?'ãƒ“ãƒ‡ã‚ª':'éŸ³å£°';
                        app.go('scr-call'); document.getElementById('call-ui-incoming').classList.remove('hidden'); document.getElementById('call-ui-calling').classList.add('hidden'); document.getElementById('call-ui-connected').classList.add('hidden');
                        c.on('close',()=>app.endCall()); c.on('error',()=>app.endCall());
                    });
                    peer.on('error',e=>{ if(e.type==='unavailable-id') app.toast("é€šè©±IDé‡è¤‡");});
                } catch(e){}
            },
            startCall: async (videoEnabled) => {
                if(callStatus !== 'idle') return app.toast("é€šè©±ä¸­ã§ã™");
                if(!currentRoomId) return;
                const targetUid = currentRoomId.split('_').find(m => m !== currentUser.username);
                if(!targetUid) return;
                callStatus = 'calling'; app.go('scr-call');
                document.getElementById('call-ui-calling').classList.remove('hidden'); document.getElementById('call-ui-incoming').classList.add('hidden'); document.getElementById('call-ui-connected').classList.add('hidden');
                document.getElementById('call-name').innerText = document.getElementById('dm-talk-name').innerText;
                document.getElementById('remote-video').srcObject = null; document.getElementById('local-video').srcObject = null;
                try {
                    localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: videoEnabled });
                    document.getElementById('local-video').srcObject = localStream; document.getElementById('local-video').muted = true;
                    if(videoEnabled) document.getElementById('local-video').classList.add('active');
                    if(!peer) app.initPeer(currentUser.username);
                    const call = peer.call(targetUid, localStream, { metadata: { name: currentUser.name, video: videoEnabled } });
                    currentCall = call;
                    call.on('stream', (remote) => {
                        remoteStream = remote; document.getElementById('remote-video').srcObject = remote; callStatus = 'connected';
                        document.getElementById('call-ui-calling').classList.add('hidden'); document.getElementById('call-ui-connected').classList.remove('hidden');
                        document.getElementById('remote-video').play().catch(e=>{});
                    });
                    call.on('close', () => app.endCall()); call.on('error', () => app.endCall());
                } catch(e) { app.toast("ã‚¨ãƒ©ãƒ¼"); app.endCall(); }
            },
            answerCall: async () => {
                if(!incomingCallObj) return;
                try {
                    const videoEnabled = incomingCallObj.metadata ? incomingCallObj.metadata.video : false;
                    localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: videoEnabled });
                    document.getElementById('local-video').srcObject = localStream; document.getElementById('local-video').muted = true;
                    if(videoEnabled) document.getElementById('local-video').classList.add('active');
                    incomingCallObj.answer(localStream); currentCall = incomingCallObj; callStatus = 'connected';
                    document.getElementById('call-ui-incoming').classList.add('hidden'); document.getElementById('call-ui-connected').classList.remove('hidden');
                    currentCall.on('stream', (remote) => {
                        remoteStream = remote; document.getElementById('remote-video').srcObject = remote;
                        document.getElementById('remote-video').play().catch(e=>{});
                    });
                    currentCall.on('close', () => app.endCall()); currentCall.on('error', () => app.endCall());
                } catch(e) { app.endCall(); }
            },
            endCall: () => {
                if(currentCall) currentCall.close(); if(incomingCallObj) incomingCallObj.close();
                if(localStream) localStream.getTracks().forEach(t => t.stop());
                currentCall = null; incomingCallObj = null; localStream = null; remoteStream = null; callStatus = 'idle';
                if(currentRoomId) app.go('scr-dm-talk'); else app.tab('home');
            },
            toggleMic: () => { if(localStream) { const t = localStream.getAudioTracks()[0]; if(t) { t.enabled = !t.enabled; document.getElementById('btn-mic-toggle').classList.toggle('active', t.enabled); } } },
            toggleVideo: async () => { app.toast("ãƒ“ãƒ‡ã‚ªåˆ‡æ›¿"); },

            // Friends & DM (Inline Request)
            searchUserForFriendInline: async () => {
                const tid = document.getElementById('inline-friend-id').value.trim();
                const resDiv = document.getElementById('inline-friend-result');
                if(!tid) return;
                if(tid === currentUser.username) return resDiv.innerHTML="<span class='text-warning text-xs'>è‡ªåˆ†è‡ªèº«ã§ã™</span>";
                resDiv.innerHTML = "";
                try {
                    const snap = await getDoc(doc(db, "users", tid));
                    if(!snap.exists()) return resDiv.innerHTML="<span class='text-danger text-xs'>è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</span>";
                    const t = snap.data();
                    resDiv.innerHTML = `<div class="p-3 border border-[var(--primary)] rounded mt-2">
                        <div class="font-bold">${t.name} ${app.getBadgesHtml(t.badges)}</div><div class="text-xs text-sub mb-2">ID: ${tid}</div>
                        <button class="btn btn-success btn-sm w-full" onclick="app.sendRequest('${tid}')">ç”³è«‹ã‚’é€ã‚‹</button></div>`;
                } catch(e) { resDiv.innerHTML="ã‚¨ãƒ©ãƒ¼"; }
            },
            sendRequest: async (targetId) => {
                if(targetId === currentUser.username) return;
                try {
                    const snap = await getDoc(doc(db, "users", targetId));
                    if(!snap.exists()) return app.toast("è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
                    const exist = await getDocs(query(collection(db, "requests"), where("from", "==", currentUser.username), where("to", "==", targetId)));
                    if(!exist.empty) return app.toast("ç”³è«‹æ¸ˆã¿ã§ã™");
                    if(currentUser.friends && currentUser.friends.includes(targetId)) return app.toast("æ—¢ã«å‹é”ã§ã™");
                    await addDoc(collection(db, "requests"), { from: currentUser.username, fromName: currentUser.name, to: targetId, toName: snap.data().name, status: 'pending', createdAt: serverTimestamp() });
                    app.toast("ç”³è«‹ã‚’é€ã‚Šã¾ã—ãŸ");
                } catch(e) {}
            },
            subRequests: (uid) => {
                listeners.push(onSnapshot(query(collection(db, "requests"), where("to", "==", uid)), s => {
                    const list = document.getElementById('requests-list'); list.innerHTML = "";
                    s.forEach(d => {
                        const r = d.data();
                        list.innerHTML += `<div class="flex justify-between items-center mb-2 pb-2 border-b border-[var(--border)]"><div><div class="font-bold text-sm">${r.fromName}</div><div class="text-xs text-sub">ID: ${r.from}</div></div><div class="flex gap-2"><button class="btn btn-sm btn-primary" onclick="app.acceptRequest('${d.id}', '${r.from}')">æ‰¿èª</button><button class="btn btn-sm btn-danger" onclick="app.rejectRequest('${d.id}')">æ‹’å¦</button></div></div>`;
                    });
                }));
                listeners.push(onSnapshot(query(collection(db, "requests"), where("from", "==", uid)), s => {
                    const list = document.getElementById('outgoing-list'); list.innerHTML = "";
                    s.forEach(d => {
                        list.innerHTML += `<div class="flex justify-between items-center mb-2"><div class="text-sm">${d.data().toName} ã¸é€ä¿¡ä¸­</div><button class="btn btn-sm btn-danger" onclick="app.rejectRequest('${d.id}')">å–æ¶ˆ</button></div>`;
                    });
                }));
            },
            acceptRequest: async (reqId, fromUid) => {
                try {
                    await runTransaction(db, async tr => {
                        tr.update(doc(db, "users", currentUser.username), { friends: arrayUnion(fromUid) });
                        tr.update(doc(db, "users", fromUid), { friends: arrayUnion(currentUser.username) });
                        tr.delete(doc(db, "requests", reqId));
                    });
                    app.toast("å‹é”ã«ãªã‚Šã¾ã—ãŸï¼");
                } catch(e) {}
            },
            rejectRequest: async (reqId) => { await deleteDoc(doc(db, "requests", reqId)); },
            subDMList: (uid) => {
                listeners.push(onSnapshot(doc(db, "users", uid), async s => {
                    if (!s.exists()) return;
                    const friends = s.data().friends || [];
                    const list = document.getElementById('dm-list-box'); list.innerHTML = "";
                    for(const fid of friends) {
                        try {
                            const fSnap = await getDoc(doc(db, "users", fid));
                            if(fSnap.exists()) {
                                const fData = fSnap.data();
                                list.innerHTML += `<div class="dm-item" onclick="app.startDM('${fid}', '${fData.name.replace(/'/g,"\\'")}')"><div class="dm-icon">${fData.name.charAt(0)}</div><div><div class="font-bold text-sm">${fData.name} ${app.getBadgesHtml(fData.badges)}</div><div class="text-xs text-sub">ID: ${fid}</div></div></div>`;
                            }
                        } catch(e) {}
                    }
                }));
            },
            startDM: async (targetUid, targetName) => {
                app.closeModal(); 
                const members = [currentUser.username, targetUid].sort(), roomId = members.join("_"), ref = doc(db, "rooms", roomId);
                const snap = await getDoc(ref);
                if(!snap.exists()) await setDoc(ref, { members: members, names: { [currentUser.username]: currentUser.name, [targetUid]: targetName }, updatedAt: serverTimestamp() });
                currentRoomId = roomId; document.getElementById('dm-talk-name').innerText = targetName; document.getElementById('scr-dm-talk').classList.add('active');
                if(dmUnsub) dmUnsub();
                dmUnsub = onSnapshot(query(collection(db, "rooms", roomId, "messages"), limit(50)), s => {
                    const b = document.getElementById('dm-talk-box'); b.innerHTML = "";
                    let msgs = []; s.forEach(d => msgs.push({id:d.id, ...d.data()})); msgs.sort((a,b)=>(a.createdAt?.seconds||0) - (b.createdAt?.seconds||0));
                    msgs.forEach(m => b.innerHTML += app.buildMsgHTML(m, true));
                    setTimeout(()=>b.scrollTop = 99999, 100);
                });
            },
            closeDM: () => { document.getElementById('scr-dm-talk').classList.remove('active'); if(dmUnsub) dmUnsub(); currentRoomId = null; app.cancelReply('dm'); },
            sendDM: async (stampUrl = null) => {
                const i = document.getElementById('dm-in'), t = i.value.trim(); const imgPayload = stampUrl || dmImg;
                if((!t && !imgPayload) || !currentRoomId) return;
                const payload = { text: t, img: imgPayload, username: currentUser.username, sender: currentUser.name, createdAt: serverTimestamp() };
                if(replyTarget.dm) { payload.replyTo = replyTarget.dm; }
                await addDoc(collection(db, "rooms", currentRoomId, "messages"), payload);
                i.value = ""; app.clearDMImg(); app.cancelReply('dm');
            },

            // Chat All
            subChat: () => {
                listeners.push(onSnapshot(query(collection(db,"chat"), limit(50)), s=>{
                    const b = document.getElementById('chat-box'); b.innerHTML="";
                    let msgs=[]; s.forEach(d=>msgs.push({id:d.id, ...d.data()})); msgs.sort((a,b)=>(a.createdAt?.seconds||0) - (b.createdAt?.seconds||0));
                    msgs.forEach(m => b.innerHTML += app.buildMsgHTML(m, false));
                    if(!document.getElementById('tab-chat').classList.contains('hidden')) setTimeout(()=>b.scrollTop=99999, 100);
                }));
            },
            sendChat: async (stampUrl = null) => {
                const i=document.getElementById('chat-in'), t=i.value.trim(); const imgPayload = stampUrl || chatImg;
                if(!t && !imgPayload) return;
                const payload = { text:t, img:imgPayload, username:currentUser.username, sender:currentUser.name, createdAt:serverTimestamp() };
                if(replyTarget.all) { payload.replyTo = replyTarget.all; }
                await addDoc(collection(db,"chat"), payload);
                i.value=""; app.clearChatImg(); app.cancelReply('all');
            },
            buildMsgHTML: (m, isDm = false) => {
                const isMe = m.username === currentUser.username;
                const name = m.sender || "Unknown";
                const type = isDm ? 'dm' : 'all';
                let replyHtml = '';
                if(m.replyTo) {
                    const r = m.replyTo;
                    const rText = r.text ? (r.text.length > 20 ? r.text.substring(0,20)+'...' : r.text) : (r.img ? 'ç”»åƒ' : '');
                    replyHtml = `<div class="reply-box-in-msg">${r.img ? `<img src="${r.img}">` : ''}<div class="reply-content"><div style="font-size:0.65rem; color:var(--primary)">${r.name}</div><div>${rText}</div></div></div>`;
                }
                const tapAction = `app.openMsgAction('${type}', '${m.id}', '${m.username}', '${safeArgs(name)}', '${safeArgs(m.text)}', '${m.img||''}', '${currentRoomId||''}')`;
                let contentHtml = '';
                if (m.text) contentHtml += `<div>${m.text}</div>`;
                if (m.img) {
                    const isStamp = !m.text && m.img;
                    const imgClick = isStamp ? "" : `onclick="event.stopPropagation(); document.getElementById('img-full').src=this.src;document.getElementById('img-viewer').style.display='flex'"`;
                    contentHtml += `<img src="${m.img}" class="${m.text?'chat-img':'stamp-img chat-img'}" ${imgClick}>`;
                }
                return `<div class="msg-row ${isMe?'mine':'other'}">
                    ${!isMe?`<span class="msg-name" onclick="app.showProfile('${m.username}','${name.replace(/'/g,"\\'")}')">${name}</span>`:''}
                    <div class="msg-bubble" style="${!m.text && m.img ? 'background:transparent; border:none; padding:0;' : ''}" onclick="${tapAction}">${replyHtml}${contentHtml}</div>
                </div>`;
            },
            openMsgAction: (type, msgId, msgUid, msgName, msgText, msgImg, roomId) => {
                actionMsg = { type, msgId, msgUid, msgName, msgText, msgImg, roomId };
                const isMine = msgUid === currentUser.username || (currentUser.badges||[]).includes('developer');
                let preview = `${msgName}: `;
                if(msgText) preview += msgText.substring(0, 30) + (msgText.length > 30 ? '...' : ''); else if(msgImg) preview += '[ç”»åƒ/ã‚¹ã‚¿ãƒ³ãƒ—]';
                document.getElementById('msg-action-target').innerText = preview;
                document.getElementById('msg-action-sheet').classList.add('show');
                const delBtn = document.getElementById('btn-msg-del');
                if(isMine) delBtn.classList.remove('hidden'); else delBtn.classList.add('hidden');
            },
            closeMsgAction: () => { document.getElementById('msg-action-sheet').classList.remove('show'); actionMsg = null; },
            prepareReply: () => {
                if(!actionMsg) return;
                const { type, msgId, msgName, msgText, msgImg } = actionMsg;
                replyTarget[type] = { id: msgId, name: msgName, text: msgText, img: msgImg };
                const preBox = document.getElementById(type === 'all' ? 'chat-reply-preview' : 'dm-reply-preview');
                const preName = document.getElementById(type === 'all' ? 'chat-rep-name' : 'dm-rep-name');
                const preText = document.getElementById(type === 'all' ? 'chat-rep-text' : 'dm-rep-text');
                const preImg = document.getElementById(type === 'all' ? 'chat-rep-img' : 'dm-rep-img');
                preName.innerText = `è¿”ä¿¡å…ˆ: ${msgName}`; preText.innerText = msgText || 'ç”»åƒ';
                if(msgImg) { preImg.src = msgImg; preImg.classList.remove('hidden'); } else { preImg.classList.add('hidden'); }
                preBox.style.display = 'flex'; app.closeMsgAction(); document.getElementById(type === 'all' ? 'chat-in' : 'dm-in').focus();
            },
            cancelReply: (type) => { replyTarget[type] = null; document.getElementById(type === 'all' ? 'chat-reply-preview' : 'dm-reply-preview').style.display = 'none'; },
            execDelMsg: async () => {
                if(!actionMsg) return;
                if(!confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
                try {
                    if(actionMsg.type === 'all') await deleteDoc(doc(db,"chat", actionMsg.msgId));
                    else if(actionMsg.type === 'dm') await deleteDoc(doc(db, "rooms", actionMsg.roomId, "messages", actionMsg.msgId));
                    app.toast("å‰Šé™¤ã—ã¾ã—ãŸ");
                } catch(e) {}
                app.closeMsgAction();
            },
            handleFileSelect: (i, type) => {
                if(i.files[0]){
                    const r = new FileReader();
                    r.onload = e => {
                        const img = new Image(); img.onload = () => {
                            const c = document.createElement('canvas'), MAX=800; let w=img.width, h=img.height;
                            if(w>MAX){h*=MAX/w;w=MAX} c.width=w; c.height=h; c.getContext('2d').drawImage(img,0,0,w,h);
                            const d = c.toDataURL('image/jpeg',0.7);
                            if(type==='chat') { chatImg=d; document.getElementById('chat-preview').style.display='flex'; document.getElementById('chat-preview-img').src=d; }
                            else if(type==='dm') { dmImg=d; document.getElementById('dm-preview').style.display='flex'; document.getElementById('dm-preview-img').src=d; }
                            else { newsImg=d; document.getElementById('adm-news-file-status').innerText="é¸æŠæ¸ˆ"; }
                        }; img.src = e.target.result;
                    }; r.readAsDataURL(i.files[0]);
                }
            },
            clearChatImg: () => { chatImg = null; document.getElementById('chat-file').value = ""; document.getElementById('chat-preview').style.display = 'none'; },
            clearDMImg: () => { dmImg = null; document.getElementById('dm-file').value = ""; document.getElementById('dm-preview').style.display = 'none'; },
            switchChatMode: (mode) => {
                document.getElementById('area-all-chat').style.display = mode==='all'?'flex':'none';
                document.getElementById('area-dm-list').style.display = mode==='dm'?'flex':'none';
                document.getElementById('sw-all').classList.toggle('active', mode==='all');
                document.getElementById('sw-dm').classList.toggle('active', mode==='dm');
            },

            // Stamp Maker & Paid Stamps
            openStampModal: () => { document.getElementById('stamp-modal').style.display = 'flex'; app.switchStampTab('public'); },
            closeStampModal: () => { document.getElementById('stamp-modal').style.display = 'none'; },
            switchStampTab: (tab) => {
                currentStampTab = tab;
                document.querySelectorAll('.stamp-tab').forEach(el => el.classList.remove('active'));
                document.getElementById(`tab-stamp-${tab}`).classList.add('active');
                app.loadStamps();
            },
            loadStamps: async (packId = null) => {
                const list = document.getElementById('stamp-list'); list.innerHTML = "";
                if (packId) {
                    const snap = await getDocs(query(collection(db, "stamps"), where("packId", "==", packId), where("status", "==", "approved")));
                    list.innerHTML = "<div class='col-span-3 btn btn-ghost btn-sm mb-2' onclick='app.loadStamps()'>â† æˆ»ã‚‹</div>";
                    const rows=[]; snap.forEach(d=>rows.push(d.data())); rows.sort((a,b)=>(a.order||0)-(b.order||0));
                    rows.forEach(d => {
                        const item = document.createElement('div'); item.className = 'stamp-item'; item.innerHTML = `<img src="${d.url}">`;
                        item.onclick = () => { if(currentRoomId) app.sendDM(d.url); else app.sendChat(d.url); app.closeStampModal(); };
                        list.appendChild(item);
                    });
                } else {
                    let q = currentStampTab === 'public' ? query(collection(db, "stampPacks"), where("isPublic", "==", true), where("status", "==", "approved"), limit(50)) : query(collection(db, "stampPacks"), where("ownerUid", "==", currentUser.username), limit(50));
                    const snap = await getDocs(q);
                    const packs=[]; snap.forEach(d=>packs.push({id:d.id, ...d.data()})); packs.sort((a,b)=>(b.createdAt?.seconds||0)-(a.createdAt?.seconds||0));
                    packs.forEach(p => {
                        const item = document.createElement('div'); item.className = 'stamp-item'; item.style.border = '1px solid var(--border)';
                        let badge = p.ownerUid===currentUser.username ? (p.status==='approved'?"":`<div style='position:absolute;bottom:0;width:100%;background:rgba(0,0,0,0.7);font-size:0.6rem;text-align:center'>ç”³è«‹ä¸­</div>`) : '';
                        let priceBadge = '';
                        const myPurchases = currentUser.purchasedPacks || [];
                        const needBuy = p.isPaid && p.ownerUid !== currentUser.username && !myPurchases.includes(p.id);
                        if(needBuy) priceBadge = `<div style="position:absolute; top:2px; right:2px; background:var(--warning); color:#000; font-size:0.6rem; padding:2px 4px; border-radius:4px; font-weight:bold;">ğŸª™${p.price}</div>`;

                        item.innerHTML = `<img src="${p.mainUrl}" style="padding:0; object-fit:cover; border-radius:8px;">${badge}${priceBadge}`;
                        item.onclick = () => {
                            if(p.status !== 'approved' && p.ownerUid !== currentUser.username) return;
                            if(needBuy) app.promptPurchasePack(p); else app.loadStamps(p.id);
                        };
                        list.appendChild(item);
                    });
                }
            },
            promptPurchasePack: async (p) => {
                if(!confirm(`ã€Œ${p.title}ã€ã‚’ ${p.price} ã‚³ã‚¤ãƒ³ã§è³¼å…¥ã—ã¾ã™ã‹ï¼Ÿ\n(ä½œæˆè€…ã«70%ãŒé‚„å…ƒã•ã‚Œã¾ã™)`)) return;
                if((currentUser.coins||0) < p.price) return app.toast("ã‚³ã‚¤ãƒ³ãŒè¶³ã‚Šã¾ã›ã‚“");
                try {
                    await runTransaction(db, async tr => {
                        const meRef = doc(db, "users", currentUser.username);
                        const sellerRef = doc(db, "users", p.ownerUid);
                        const sysRef = doc(db, "system", "stats");
                        
                        const meSnap = await tr.get(meRef);
                        if((meSnap.data().coins||0) < p.price) throw "ã‚³ã‚¤ãƒ³ä¸è¶³";
                        
                        const devFee = Math.floor(p.price * 0.3);
                        const sellerProfit = p.price - devFee;
                        
                        tr.update(meRef, { coins: increment(-p.price), purchasedPacks: arrayUnion(p.id) });
                        tr.update(sellerRef, { coins: increment(sellerProfit) });
                        tr.set(sysRef, { devCoins: increment(devFee) }, {merge:true});
                    });
                    app.toast("è³¼å…¥ã—ã¾ã—ãŸï¼"); app.loadStamps();
                } catch(e) { app.toast("ã‚¨ãƒ©ãƒ¼: " + e); }
            },

            openStampMaker: () => { app.go('scr-stamp-maker'); app.pkLoadDraft(); app.pkRender(); app.loadMyStampsTop(); setTimeout(()=>app.mkInit(), 50); },
            closeStampMaker: () => { app.pkCloseEditor(); app.go('scr-main'); },
            pkSaveDraft: () => {
                app.pkDraft.title = document.getElementById('pk-title').value;
                app.pkDraft.isPublic = document.getElementById('pk-public').value === 'true';
                app.pkDraft.isPaid = document.getElementById('pk-price-type').value === 'paid';
                app.pkDraft.price = parseInt(document.getElementById('pk-price-val').value||'0');
                localStorage.setItem(PK_DRAFT_KEY, JSON.stringify(app.pkDraft)); app.toast('ä¿å­˜ã—ã¾ã—ãŸ');
            },
            pkLoadDraft: () => {
                try { const r = localStorage.getItem(PK_DRAFT_KEY); if(r) { const d=JSON.parse(r); app.pkDraft={title:d.title||'', isPublic:!!d.isPublic, isPaid:!!d.isPaid, price:d.price||0, mainDataUrl:d.mainDataUrl||'', stamps:Array.isArray(d.stamps)?d.stamps:[]}; } } catch(e) {}
                document.getElementById('pk-title').value = app.pkDraft.title;
                document.getElementById('pk-public').value = app.pkDraft.isPublic?'true':'false';
                document.getElementById('pk-price-type').value = app.pkDraft.isPaid?'paid':'free';
                document.getElementById('pk-price-val').value = app.pkDraft.price || '';
                const mp = document.getElementById('pk-main-preview');
                if(app.pkDraft.mainDataUrl){ mp.src=app.pkDraft.mainDataUrl; mp.style.display='block'; } else mp.style.display='none';
                document.getElementById('pk-price-type').dispatchEvent(new Event('change'));
            },
            pkResetDraft: () => { if(confirm('ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')){ localStorage.removeItem(PK_DRAFT_KEY); app.pkDraft={title:'',isPublic:true,isPaid:false,price:0,mainDataUrl:'',stamps:[]}; app.pkLoadDraft(); app.pkRender(); app.pkGoToStep1(); } },
            pkGoToStep1: () => { document.getElementById('pk-step-basic').style.display='block'; document.getElementById('pk-step-stamps').style.display='none'; },
            pkGoToStep2: () => { app.pkRender(); document.getElementById('pk-step-basic').style.display='none'; document.getElementById('pk-step-stamps').style.display='block'; },
            pkAddEmptySlot: (c=1) => { const add=Math.min(c, 40-app.pkDraft.stamps.length); for(let i=0;i<add;i++) app.pkDraft.stamps.push({dataUrl:''}); app.pkRender(); },
            pkRender: () => {
                app.pkDraft.title = document.getElementById('pk-title').value.trim();
                const grid = document.getElementById('pk-grid'); if(!grid) return;
                while(app.pkDraft.stamps.length < 8) app.pkDraft.stamps.push({dataUrl:''});
                grid.innerHTML = '';
                app.pkDraft.stamps.forEach((s, i) => {
                    grid.innerHTML += `<div class="pk-slot">
                        <div class="pk-thumb">${s.dataUrl?`<img src="${s.dataUrl}">`:`<div class='text-xs text-sub'>æœªè¨­å®š</div>`}</div>
                        <div class="mt-2 flex gap-2"><button class="btn btn-ghost btn-sm" onclick="app.pkUploadToSlot(${i})">${s.dataUrl?'å¤‰æ›´':'è¿½åŠ '}</button><button class="btn btn-primary btn-sm" onclick="app.pkOpenEditor('slot', ${i})">ç·¨é›†</button><button class="btn btn-danger btn-sm" onclick="app.pkRemoveSlot(${i})">âœ•</button></div>
                    </div>`;
                });
                app.pkValidate();
            },
            pkRemoveSlot: (i) => { app.pkDraft.stamps.splice(i,1); app.pkRender(); },
            pkHandleMainFile: async (i) => { if(i.files[0]){ const u=await app.pkNormalizeImg(i.files[0]); if(u){ app.pkDraft.mainDataUrl=u; document.getElementById('pk-main-preview').src=u; document.getElementById('pk-main-preview').style.display='block'; app.pkRender(); } i.value=''; } },
            pkHandleBulkFiles: async (i) => { if(i.files.length){ for(const f of i.files){ const u=await app.pkNormalizeImg(f); if(u) app.pkDraft.stamps.push({dataUrl:u}); } i.value=''; app.pkRender(); } },
            pkUploadToSlot: (i) => { const p=document.createElement('input'); p.type='file'; p.accept='image/*'; p.onchange=async()=>{ if(p.files[0]){ const u=await app.pkNormalizeImg(p.files[0]); if(u) app.pkDraft.stamps[i].dataUrl=u; app.pkRender(); } }; p.click(); },
            pkNormalizeImg: async (file) => {
                if(file.size > 2*1024*1024) { app.toast('å¤§ãã™ãã¾ã™(2MBã¾ã§)'); return null; }
                const url = URL.createObjectURL(file); const img = new Image();
                await new Promise(r => { img.onload=r; img.src=url; });
                const c = document.createElement('canvas'); c.width=150; c.height=150; const ctx=c.getContext('2d');
                const scale = Math.min(150/img.width, 150/img.height); const w=img.width*scale, h=img.height*scale;
                ctx.drawImage(img, (150-w)/2, (150-h)/2, w, h);
                return c.toDataURL('image/webp', 0.9);
            },
            pkValidate: () => {
                const title = document.getElementById('pk-title')?.value.trim();
                const isPaid = document.getElementById('pk-price-type')?.value === 'paid';
                const price = parseInt(document.getElementById('pk-price-val')?.value || '0');
                const hasMain = !!app.pkDraft.mainDataUrl;
                let okTitle = title.length>=1 && title.length<=24;
                let okPrice = isPaid ? (price >= 100 && price <= 10000) : true;
                
                const bNext = document.getElementById('pk-btn-next');
                if(bNext) {
                    if(okTitle && okPrice && hasMain) { bNext.disabled=false; bNext.className='btn btn-primary'; }
                    else { bNext.disabled=true; bNext.className='btn btn-ghost'; }
                }
                const vBox = document.getElementById('pk-validate'); if(!vBox) return;
                const stamps = app.pkDraft.stamps.filter(s=>!!s.dataUrl);
                if(stamps.length < 8) { vBox.innerText = `ã‚¹ã‚¿ãƒ³ãƒ—ä¸è¶³ (${stamps.length}/8)`; vBox.className='mk-pill mk-warn'; }
                else { vBox.innerText = 'OK (ç”³è«‹å¯èƒ½)'; vBox.className='mk-pill'; }
            },
            pkSubmitPack: async () => {
                const t=app.pkDraft.title, pub=document.getElementById('pk-public').value==='true';
                const isPaid = document.getElementById('pk-price-type').value === 'paid', price = parseInt(document.getElementById('pk-price-val').value||'0');
                const sts = app.pkDraft.stamps.filter(s=>!!s.dataUrl);
                if(sts.length<8) return app.toast('8å€‹ä»¥ä¸Šå¿…è¦ã§ã™');
                if(isPaid && (price<100 || price>10000)) return app.toast('ä¾¡æ ¼ãŒä¸æ­£ã§ã™');
                if(!confirm(`ç”³è«‹ã—ã¾ã™ã‹ï¼Ÿ`)) return;
                try {
                    const packRef = doc(collection(db,'stampPacks'));
                    await setDoc(packRef, { title:t, mainUrl:app.pkDraft.mainDataUrl, ownerUid:currentUser.username, isPublic:pub, isPaid, price, status:'pending', createdAt:serverTimestamp(), count:sts.length });
                    for(let i=0;i<sts.length;i++) {
                        await addDoc(collection(db,'stamps'), { url:sts[i].dataUrl, ownerUid:currentUser.username, status:'pending', packId:packRef.id, order:i });
                    }
                    app.toast('ç”³è«‹ã—ã¾ã—ãŸ'); localStorage.removeItem(PK_DRAFT_KEY); app.pkGoToStep1(); app.closeStampMaker();
                } catch(e) { app.toast('ã‚¨ãƒ©ãƒ¼'); }
            },
            loadMyStampsTop: async () => {
                const list = document.getElementById('stamps-top-list'); if(!list) return; list.innerHTML = "";
                const snap = await getDocs(query(collection(db, 'stampPacks'), where('ownerUid','==', currentUser.username), limit(20)));
                let html=''; const rows=[]; snap.forEach(d=>rows.push({id:d.id, ...d.data()})); rows.sort((a,b)=>(b.createdAt?.seconds||0)-(a.createdAt?.seconds||0));
                for(const p of rows) {
                    const st = p.status || 'pending';
                    html += `<div class="flex items-center gap-3 border-b border-[var(--border)] p-2"><img src="${p.mainUrl}" style="width:44px;height:44px;border-radius:8px"><div class="flex-1"><div class="font-bold">${p.title}</div><div class="text-xs text-sub">${p.count}å€‹ / ${p.isPaid?`æœ‰æ–™(${p.price})`:'ç„¡æ–™'} / ${st==='approved'?'æ‰¿èª':(st==='rejected'?'å´ä¸‹':'ç”³è«‹ä¸­')}</div></div></div>`;
                }
                list.innerHTML = html;
            },

            // Stamp Editor Canvas
            mkState: { tool: 'move', color: '#ffffff', stroke: 8, eraser: false, bg: 'transparent', history: [], dragging: false, last: null, imgObj: null, imgTransform: { x: 0, y: 0, s: 1 }, tempShape: null },
            mkCanvas: null, mkCtx: null,
            pkEditing: { kind: null, index: null },
            pkOpenEditor: (kind, index=null) => {
                app.pkEditing = { kind, index }; document.getElementById('mk-editor-card').style.display = 'block';
                document.getElementById('mk-edit-target').innerText = kind === 'main' ? 'ãƒ¡ã‚¤ãƒ³ç”»åƒ' : `ã‚¹ã‚¿ãƒ³ãƒ— #${(index||0)+1}`;
                app.mkState.history = []; app.mkState.imgObj = null; app.mkState.imgTransform = { x:0, y:0, s:1 };
                try { app.mkCtx?.clearRect(0,0,app.mkCanvas.width, app.mkCanvas.height); } catch(e) {}
                app.mkPushHistory();
                const u = (kind==='main') ? app.pkDraft.mainDataUrl : (app.pkDraft.stamps[index]?.dataUrl||'');
                if(u) {
                    const img = new Image(); img.onload = () => { app.mkState.imgObj = img; app.mkState.imgTransform = { x:0, y:0, s: Math.min(1, 512/Math.max(img.width, img.height)) }; app.mkRedrawAll(); }; img.src = u;
                }
                setTimeout(()=>document.getElementById('mk-editor-card').scrollIntoView({behavior:'smooth'}), 50);
            },
            pkCloseEditor: () => { document.getElementById('mk-editor-card').style.display = 'none'; },
            mkInit: () => {
                const c = document.getElementById('mk-canvas'); if(!c) return; app.mkCanvas = c; app.mkCtx = c.getContext('2d'); app.mkPushHistory();
                const getPos = (ev) => { const r = c.getBoundingClientRect(), x = (('touches' in ev) ? ev.touches[0].clientX : ev.clientX) - r.left, y = (('touches' in ev) ? ev.touches[0].clientY : ev.clientY) - r.top; return { x: x * (c.width/r.width), y: y * (c.height/r.height) }; };
                const onDown = (ev) => {
                    ev.preventDefault(); const p = getPos(ev); app.mkState.dragging = true; app.mkState.last = p;
                    if(app.mkState.tool === 'text') { const txt = prompt('æ–‡å­—ã‚’å…¥åŠ›'); if(txt) { app.mkDrawText(txt, p.x, p.y); app.mkState.dragging = false; } return; }
                    if(app.mkState.tool === 'rect') { app.mkState.tempShape = { x0:p.x, y0:p.y, x1:p.x, y1:p.y }; return; }
                    if(app.mkState.tool === 'move') return;
                    app.mkCtx.lineCap = 'round'; app.mkCtx.lineJoin = 'round'; app.mkCtx.beginPath(); app.mkCtx.moveTo(p.x, p.y);
                };
                const onMove = (ev) => {
                    if(!app.mkState.dragging) return; ev.preventDefault(); const p = getPos(ev), last = app.mkState.last; if(!last) { app.mkState.last = p; return; }
                    if(app.mkState.tool === 'move') { app.mkState.imgTransform.x += (p.x-last.x); app.mkState.imgTransform.y += (p.y-last.y); app.mkRedrawAll(); app.mkState.last = p; return; }
                    if(app.mkState.tool === 'rect') { app.mkState.tempShape.x1 = p.x; app.mkState.tempShape.y1 = p.y; app.mkRedrawAll(true); app.mkState.last = p; return; }
                    app.mkCtx.strokeStyle = app.mkState.eraser ? 'rgba(0,0,0,1)' : app.mkState.color; app.mkCtx.globalCompositeOperation = app.mkState.eraser ? 'destination-out' : 'source-over'; app.mkCtx.lineWidth = app.mkState.stroke; app.mkCtx.lineTo(p.x, p.y); app.mkCtx.stroke(); app.mkState.last = p;
                };
                const onUp = (ev) => {
                    if(!app.mkState.dragging) return; ev.preventDefault(); app.mkState.dragging = false;
                    if(app.mkState.tool === 'rect' && app.mkState.tempShape) { app.mkCommitRect(app.mkState.tempShape); app.mkState.tempShape = null; }
                    app.mkCtx.globalCompositeOperation = 'source-over'; app.mkPushHistory();
                };
                c.addEventListener('mousedown', onDown); window.addEventListener('mousemove', onMove); window.addEventListener('mouseup', onUp);
                c.addEventListener('touchstart', onDown, {passive:false}); c.addEventListener('touchmove', onMove, {passive:false}); c.addEventListener('touchend', onUp, {passive:false});
            },
            mkPushHistory: () => { try { if(!app.mkCanvas) return; const url = app.mkCanvas.toDataURL('image/png'); app.mkState.history.push(url); if(app.mkState.history.length > 30) app.mkState.history.shift(); } catch(e) {} },
            mkUndo: () => { if(app.mkState.history.length <= 1) return; app.mkState.history.pop(); const url = app.mkState.history[app.mkState.history.length-1]; const img = new Image(); img.onload = () => { app.mkCtx.clearRect(0,0,app.mkCanvas.width, app.mkCanvas.height); app.mkCtx.drawImage(img, 0,0); }; img.src = url; },
            mkClear: () => { if(!confirm('ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ')) return; app.mkCtx.clearRect(0,0,app.mkCanvas.width, app.mkCanvas.height); app.mkState.imgObj = null; app.mkState.imgTransform = { x:0, y:0, s:1 }; app.mkState.tempShape = null; app.mkPushHistory(); },
            mkSetTool: (t) => { app.mkState.tool = t; ['move','pen','rect','text'].forEach(x => { const el=document.getElementById('tool-'+x); if(el) el.classList.toggle('active', x===t); }); },
            mkUpdateStyle: () => { app.mkState.stroke = parseInt(document.getElementById('mk-stroke').value||'8'); document.getElementById('mk-stroke-v').innerText=app.mkState.stroke; app.mkState.color = document.getElementById('mk-color').value; },
            mkToggleEraser: () => { app.mkState.eraser = !app.mkState.eraser; document.getElementById('mk-eraser').classList.toggle('active', app.mkState.eraser); },
            mkSetBgTransparent: () => { app.mkState.bg = 'transparent'; },
            mkSetBgWhite: () => { app.mkState.bg = 'white'; const tmp = document.createElement('canvas'); tmp.width = app.mkCanvas.width; tmp.height = app.mkCanvas.height; const tctx = tmp.getContext('2d'); tctx.fillStyle = '#fff'; tctx.fillRect(0,0,tmp.width,tmp.height); tctx.drawImage(app.mkCanvas,0,0); app.mkCtx.clearRect(0,0,app.mkCanvas.width, app.mkCanvas.height); app.mkCtx.drawImage(tmp,0,0); app.mkPushHistory(); },
            mkRedrawAll: (pre=false) => {
                const baseImg = new Image(); baseImg.onload = () => {
                    app.mkCtx.clearRect(0,0,app.mkCanvas.width, app.mkCanvas.height); app.mkCtx.drawImage(baseImg,0,0);
                    if(app.mkState.imgObj) { const im = app.mkState.imgObj, tr = app.mkState.imgTransform, w = im.width * tr.s, h = im.height * tr.s; app.mkCtx.drawImage(im, (app.mkCanvas.width-w)/2 + tr.x, (app.mkCanvas.height-h)/2 + tr.y, w, h); }
                    if(pre && app.mkState.tempShape) { const sh = app.mkState.tempShape; app.mkCtx.save(); app.mkCtx.globalCompositeOperation = 'source-over'; app.mkCtx.strokeStyle = app.mkState.color; app.mkCtx.lineWidth = app.mkState.stroke; app.mkCtx.strokeRect(sh.x0, sh.y0, sh.x1-sh.x0, sh.y1-sh.y0); app.mkCtx.restore(); }
                }; baseImg.src = app.mkState.history[app.mkState.history.length-1];
            },
            mkCommitRect: (sh) => { app.mkCtx.save(); app.mkCtx.globalCompositeOperation = app.mkState.eraser ? 'destination-out' : 'source-over'; app.mkCtx.strokeStyle = app.mkState.color; app.mkCtx.lineWidth = app.mkState.stroke; app.mkCtx.strokeRect(sh.x0, sh.y0, sh.x1-sh.x0, sh.y1-sh.y0); app.mkCtx.restore(); app.mkPushHistory(); },
            mkDrawText: (txt, x, y) => { app.mkCtx.save(); app.mkCtx.globalCompositeOperation = 'source-over'; app.mkCtx.fillStyle = app.mkState.color; app.mkCtx.font = 'bold 72px Inter, sans-serif'; app.mkCtx.textBaseline = 'middle'; app.mkCtx.fillText(txt, x, y); app.mkCtx.restore(); app.mkPushHistory(); },
            mkExportWebP: async () => { const out = document.createElement('canvas'); out.width = 150; out.height = 150; const octx = out.getContext('2d'); if(app.mkState.bg === 'white') { octx.fillStyle = '#fff'; octx.fillRect(0,0,150,150); } octx.drawImage(app.mkCanvas, 0, 0, 150, 150); return out.toDataURL('image/webp', 0.9); },
            pkSaveEditedStamp: async () => {
                const u = await app.mkExportWebP();
                if(app.pkEditing.kind === 'main') { app.pkDraft.mainDataUrl = u; document.getElementById('pk-main-preview').src = u; document.getElementById('pk-main-preview').style.display='block'; }
                else if(app.pkEditing.kind === 'slot') { app.pkDraft.stamps[app.pkEditing.index].dataUrl = u; }
                app.pkRender(); app.toast('åæ˜ ã—ã¾ã—ãŸ'); app.pkCloseEditor();
            },
            pkSetAsMainFromCurrent: async () => {
                const u = await app.mkExportWebP(); app.pkDraft.mainDataUrl = u; document.getElementById('pk-main-preview').src = u; document.getElementById('pk-main-preview').style.display='block'; app.pkRender(); app.toast('ãƒ¡ã‚¤ãƒ³ç”»åƒã«è¨­å®šã—ã¾ã—ãŸ');
            },

            // Trade & Market (Shop)
            switchTradeTab: (mode) => {
                document.getElementById('trade-area-exchange').classList.toggle('hidden', mode!=='exchange');
                document.getElementById('trade-area-market').classList.toggle('hidden', mode!=='market');
                document.getElementById('sw-trade-exchange').classList.toggle('active', mode==='exchange');
                document.getElementById('sw-trade-market').classList.toggle('active', mode==='market');
            },
            
            // Exchange
            tradeRowSeq: 0,
            initTradeUI: () => {
                const g = document.getElementById('tr-give-rows'), w = document.getElementById('tr-want-rows');
                if(g && g.childElementCount===0) app.addTradeRow('give');
                if(w && w.childElementCount===0) app.addTradeRow('want');
            },
            addTradeRow: (side) => {
                const wrap = document.getElementById(side === 'give' ? 'tr-give-rows' : 'tr-want-rows');
                const idx = ++app.tradeRowSeq;
                let opts = `<option value="coins">ã‚³ã‚¤ãƒ³</option><option value="diamonds">ãƒ€ã‚¤ãƒ¤</option><option value="item">æ¶ˆè²»ã‚¢ã‚¤ãƒ†ãƒ (ID)</option><option value="amulet">ãŠå®ˆã‚Š(ID)</option>`;
                wrap.innerHTML += `<div class="flex gap-2 items-center mb-2" data-idx="${idx}"><select class="input" style="width:40%" id="tr-${side}-type-${idx}">${opts}</select><input type="text" class="input flex-1" id="tr-${side}-val-${idx}" placeholder="é‡ã¾ãŸã¯ID"><button class="btn btn-ghost btn-sm" onclick="this.parentElement.remove()">âœ•</button></div>`;
            },
            clearTradeRows: (side) => { document.getElementById(side === 'give' ? 'tr-give-rows' : 'tr-want-rows').innerHTML = ''; app.addTradeRow(side); },
            readTradeRows: (side) => {
                const rows = [];
                document.getElementById(side === 'give' ? 'tr-give-rows' : 'tr-want-rows').querySelectorAll('[data-idx]').forEach(el => {
                    const idx = el.dataset.idx, type = document.getElementById(`tr-${side}-type-${idx}`).value, val = document.getElementById(`tr-${side}-val-${idx}`).value;
                    if(val) { if(type==='coins'||type==='diamonds') rows.push({type, amount:parseInt(val)}); else rows.push({type, id:val, qty:1}); }
                });
                return rows;
            },
            createTrade: async () => {
                const give = app.readTradeRows('give'), want = app.readTradeRows('want'), pass = document.getElementById('tr-pass').value.trim();
                if(give.length===0 || want.length===0) return app.toast('å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                try {
                    await addDoc(collection(db, 'trades'), { makerUid: currentUser.username, makerName: currentUser.name, give, want, passcode: pass, status: 'open', createdAt: serverTimestamp() });
                    app.toast('å‡ºå“ã—ã¾ã—ãŸ'); app.clearTradeRows('give'); app.clearTradeRows('want'); document.getElementById('tr-pass').value='';
                } catch(e) {}
            },
            cancelTrade: async (id) => { if(confirm('å–ã‚Šæ¶ˆã—ã¾ã™ã‹ï¼Ÿ')) await deleteDoc(doc(db, 'trades', id)); },
            doTrade: async (id, pass) => {
                if(pass && prompt('ã‚ã„ã“ã¨ã°')!==pass) return app.toast('é•ã„ã¾ã™');
                if(!confirm('äº¤æ›ã—ã¾ã™ã‹ï¼Ÿ(â€»ãƒ­ã‚¸ãƒƒã‚¯ç°¡æ˜“ç‰ˆ)')) return;
                await deleteDoc(doc(db, 'trades', id)); app.toast('æˆç«‹ï¼(ã‚¢ã‚¤ãƒ†ãƒ ã¯è‡ªå‹•å¢—æ¸›ã•ã‚Œã¾ã›ã‚“)');
            },
            subTrade: () => {
                listeners.push(onSnapshot(query(collection(db,"trades"), where("status","==","open"), limit(100)), s=>{
                    const l=document.getElementById('trade-list'); l.innerHTML="";
                    let items = []; s.forEach(d => items.push({id:d.id, ...d.data()})); items.sort((a,b) => (b.createdAt?.seconds||0) - (a.createdAt?.seconds||0));
                    items.forEach(t=>{
                        const me=t.makerUid===currentUser.username; const pass = t.passcode ? `'${t.passcode.replace(/'/g,"\\'")}'` : "''";
                        const fmt = (arr) => arr.map(o=>(o.type==='coins'||o.type==='diamonds')?`${o.amount}${o.type}`:`${o.id}x${o.qty}`).join(', ');
                        l.innerHTML += `<div class="card flex justify-between items-center" style="margin-bottom:8px"><div style="flex:1"><div class="text-xs text-sub mb-1">${t.makerName} ${t.passcode?'ğŸ”’':''}</div><div class="font-bold">å‡º: ${fmt(t.give)}</div><div class="font-bold text-primary">æ±‚: ${fmt(t.want)}</div></div><button class="btn btn-sm ${me?'btn-danger':'btn-primary'}" style="width:auto" onclick="${me?`app.cancelTrade('${t.id}')`:`app.doTrade('${t.id}',${pass})`}">${me?'å–æ¶ˆ':'äº¤æ›'}</button></div>`;
                    });
                }));
            },

            // Market (Shop) Core
            onMarketTypeChange: () => {
                const type = document.getElementById('mk-sell-type').value;
                const wrap = document.getElementById('mk-sell-valwrap');
                let opts = '';
                if(type === 'item') {
                    for(const [k,v] of Object.entries(currentUser.items||{})) if(v>0) opts += `<option value="${k}">${getMeta('item', k).name} (æ‰€æŒ:${v})</option>`;
                } else if(type === 'amulet') {
                    const map = {}; (currentUser.amulets||[]).forEach(a => { const id = typeof a==='string'?a:a.id; map[id]=(map[id]||0)+1; });
                    for(const [id,c] of Object.entries(map)) opts += `<option value="${id}">${getMeta('amulet', id).name} (æ‰€æŒ:${c})</option>`;
                }
                if(!opts) opts = `<option value="">å‡ºå“ã§ãã‚‹ã‚‚ã®ãŒã‚ã‚Šã¾ã›ã‚“</option>`;
                wrap.innerHTML = `<div class="flex gap-2"><select id="mk-sell-val" class="input flex-1">${opts}</select><input type="number" id="mk-sell-qty" class="input" style="width:70px" min="1" value="1"></div>`;
            },
            createMarketItem: async () => {
                const type = document.getElementById('mk-sell-type').value, val = document.getElementById('mk-sell-val').value, qty = parseInt(document.getElementById('mk-sell-qty').value || '1'), price = parseInt(document.getElementById('mk-sell-price').value || '0');
                if(!val || qty<1 || price<10) return app.toast('æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾¡æ ¼ã¯10ã‚³ã‚¤ãƒ³ä»¥ä¸Šï¼‰');
                try {
                    await runTransaction(db, async tr => {
                        const meRef = doc(db, 'users', currentUser.username); const meSnap = await tr.get(meRef); const u = meSnap.data();
                        const items = u.items || {}; const amulets = u.amulets || [];
                        if(type === 'item') { if((items[val]||0) < qty) throw "æ‰€æŒæ•°ãŒè¶³ã‚Šã¾ã›ã‚“"; items[val] -= qty; if(items[val]<=0) delete items[val]; } 
                        else if(type === 'amulet') {
                            const have = amulets.filter(a => (typeof a==='string'?a:a.id) === val);
                            if(have.length < qty) throw "æ‰€æŒæ•°ãŒè¶³ã‚Šã¾ã›ã‚“";
                            for(let i=0; i<qty; i++) { const idx = amulets.findIndex(a => (typeof a==='string'?a:a.id) === val); amulets.splice(idx, 1); }
                        }
                        tr.update(meRef, { items, amulets });
                        tr.set(doc(collection(db, 'market')), { sellerUid: currentUser.username, sellerName: currentUser.name, type, itemId: val, qty, price, status: 'open', createdAt: serverTimestamp() });
                    });
                    app.toast('å‡ºå“ã—ã¾ã—ãŸ'); document.getElementById('mk-sell-price').value=''; app.onMarketTypeChange();
                } catch(e) { app.toast('ã‚¨ãƒ©ãƒ¼: ' + e); }
            },
            buyMarketItem: async (mId) => {
                if(!confirm("ã“ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’ã‚³ã‚¤ãƒ³ã§è³¼å…¥ã—ã¾ã™ã‹ï¼Ÿ")) return;
                try {
                    await runTransaction(db, async tr => {
                        const mRef = doc(db, 'market', mId); const mSnap = await tr.get(mRef);
                        if(!mSnap.exists() || mSnap.data().status !== 'open') throw "å£²å´æ¸ˆã¿ã‹å­˜åœ¨ã—ã¾ã›ã‚“";
                        const m = mSnap.data(); if(m.sellerUid === currentUser.username) throw "è‡ªåˆ†ã®å‡ºå“ã§ã™";
                        const meRef = doc(db, 'users', currentUser.username), sellerRef = doc(db, 'users', m.sellerUid);
                        const meSnap = await tr.get(meRef); const u = meSnap.data();
                        if((u.coins||0) < m.price) throw "ã‚³ã‚¤ãƒ³ä¸è¶³";
                        const items = u.items || {}; const amulets = u.amulets || [];
                        if(m.type === 'item') items[m.itemId] = (items[m.itemId]||0) + m.qty;
                        else if(m.type === 'amulet') { for(let i=0; i<m.qty; i++) amulets.push({ id: m.itemId, durability: getMeta('amulet', m.itemId).durability || 100 }); }
                        tr.update(meRef, { coins: increment(-m.price), items, amulets }); tr.update(sellerRef, { coins: increment(m.price) }); tr.delete(mRef);
                    });
                    app.toast("è³¼å…¥ã—ã¾ã—ãŸï¼");
                } catch(e) { app.toast("ã‚¨ãƒ©ãƒ¼: " + e); }
            },
            cancelMarketItem: async (mId) => {
                if(!confirm("å‡ºå“ã‚’å–ã‚Šæ¶ˆã—ã¾ã™ã‹ï¼Ÿ")) return;
                try {
                    await runTransaction(db, async tr => {
                        const mRef = doc(db, 'market', mId); const mSnap = await tr.get(mRef);
                        if(!mSnap.exists()) throw "å­˜åœ¨ã—ã¾ã›ã‚“"; const m = mSnap.data(); if(m.sellerUid !== currentUser.username) throw "æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“";
                        const meRef = doc(db, 'users', currentUser.username); const meSnap = await tr.get(meRef);
                        const items = meSnap.data().items || {}; const amulets = meSnap.data().amulets || [];
                        if(m.type === 'item') items[m.itemId] = (items[m.itemId]||0) + m.qty;
                        else if(m.type === 'amulet') { for(let i=0; i<m.qty; i++) amulets.push({ id: m.itemId, durability: 100 }); }
                        tr.update(meRef, { items, amulets }); tr.delete(mRef);
                    });
                    app.toast("å–ã‚Šæ¶ˆã—ã¾ã—ãŸ"); app.onMarketTypeChange();
                } catch(e) { app.toast("ã‚¨ãƒ©ãƒ¼"); }
            },
            subMarket: () => {
                listeners.push(onSnapshot(query(collection(db, "market"), where("status", "==", "open"), limit(100)), s => {
                    const l = document.getElementById('market-list'); if(!l) return; l.innerHTML = "";
                    let items = []; s.forEach(d => items.push({ id: d.id, ...d.data() })); items.sort((a,b) => (b.createdAt?.seconds||0) - (a.createdAt?.seconds||0));
                    items.forEach(m => {
                        const isMe = m.sellerUid === currentUser.username; const meta = getMeta(m.type, m.itemId);
                        l.innerHTML += `<div class="card flex justify-between items-center" style="margin-bottom:8px"><div style="flex:1; padding-right:10px"><div class="text-xs text-sub mb-1">å‡ºå“è€…: ${m.sellerName}</div><div class="font-bold">${meta.icon} ${meta.name} Ã—${m.qty}</div><div class="font-bold mt-1" style="color:var(--warning)">ğŸª™ ${m.price} ã‚³ã‚¤ãƒ³</div></div><button class="btn btn-sm ${isMe ? 'btn-ghost' : 'btn-primary'}" style="width:auto" onclick="${isMe ? `app.cancelMarketItem('${m.id}')` : `app.buyMarketItem('${m.id}')`}">${isMe ? 'å–æ¶ˆ' : 'è³¼å…¥'}</button></div>`;
                    });
                }));
            },

            // Full Game Sync
            lzCompressToUTF16: (input) => {
                if (input == null) return "";
                let i, value; const context_dictionary = new Map(); const context_dictionaryToCreate = new Map();
                let context_c = ""; let context_wc = ""; let context_w = ""; let context_enlargeIn = 2; let context_dictSize = 3; let context_numBits = 2;
                const context_data = []; let context_data_val = 0; let context_data_position = 0;
                const writeBit = (bit) => {
                    context_data_val = (context_data_val << 1) | bit;
                    if (context_data_position === 15) { context_data_position = 0; context_data.push(String.fromCharCode(context_data_val + 32)); context_data_val = 0; } else context_data_position++;
                };
                const writeBits = (numBits, val) => { for (let j = 0; j < numBits; j++) { writeBit(val & 1); val >>= 1; } };
                for (i = 0; i < input.length; i++) {
                    context_c = input.charAt(i);
                    if (!context_dictionary.has(context_c)) { context_dictionary.set(context_c, context_dictSize++); context_dictionaryToCreate.set(context_c, true); }
                    context_wc = context_w + context_c;
                    if (context_dictionary.has(context_wc)) { context_w = context_wc; } else {
                        if (context_dictionaryToCreate.has(context_w)) {
                            value = context_w.charCodeAt(0); if (value < 256) { writeBits(context_numBits, 0); writeBits(8, value); } else { writeBits(context_numBits, 1); writeBits(16, value); }
                            context_enlargeIn--; if (context_enlargeIn === 0) { context_enlargeIn = Math.pow(2, context_numBits); context_numBits++; } context_dictionaryToCreate.delete(context_w);
                        } else { writeBits(context_numBits, context_dictionary.get(context_w)); }
                        context_enlargeIn--; if (context_enlargeIn === 0) { context_enlargeIn = Math.pow(2, context_numBits); context_numBits++; }
                        context_dictionary.set(context_wc, context_dictSize++); context_w = String(context_c);
                    }
                }
                if (context_w !== "") {
                    if (context_dictionaryToCreate.has(context_w)) {
                        value = context_w.charCodeAt(0); if (value < 256) { writeBits(context_numBits, 0); writeBits(8, value); } else { writeBits(context_numBits, 1); writeBits(16, value); }
                        context_enlargeIn--; if (context_enlargeIn === 0) { context_enlargeIn = Math.pow(2, context_numBits); context_numBits++; } context_dictionaryToCreate.delete(context_w);
                    } else { writeBits(context_numBits, context_dictionary.get(context_w)); }
                    context_enlargeIn--; if (context_enlargeIn === 0) { context_enlargeIn = Math.pow(2, context_numBits); context_numBits++; }
                }
                writeBits(context_numBits, 2);
                while (true) { context_data_val <<= 1; if (context_data_position === 15) { context_data.push(String.fromCharCode(context_data_val + 32)); break; } else context_data_position++; }
                return context_data.join("");
            },
            lzDecompressFromUTF16: (compressed) => {
                if (compressed == null) return ""; if (compressed === "") return null;
                const readBit = (data) => { const res = data.val & data.position; data.position >>= 1; if (data.position === 0) { data.position = 32768; data.val = data.string.charCodeAt(data.index++) - 32; } return res > 0 ? 1 : 0; };
                const readBits = (numBits, data) => { let res = 0; let maxpower = Math.pow(2, numBits); let power = 1; while (power !== maxpower) { res |= readBit(data) * power; power <<= 1; } return res; };
                const data = { string: compressed, val: compressed.charCodeAt(0) - 32, position: 32768, index: 1 };
                const dictionary = []; let enlargeIn = 4; let dictSize = 4; let numBits = 3; let entry = ""; let result = []; let i; let w; let bits; let c;
                for (i = 0; i < 3; i++) dictionary[i] = i;
                bits = readBits(2, data); switch (bits) { case 0: c = String.fromCharCode(readBits(8, data)); break; case 1: c = String.fromCharCode(readBits(16, data)); break; case 2: return ""; }
                dictionary[3] = c; w = c; result.push(c);
                while (true) {
                    if (data.index > data.string.length) return "";
                    const cc = readBits(numBits, data);
                    switch (cc) { case 0: c = String.fromCharCode(readBits(8, data)); dictionary[dictSize++] = c; enlargeIn--; entry = c; break; case 1: c = String.fromCharCode(readBits(16, data)); dictionary[dictSize++] = c; enlargeIn--; entry = c; break; case 2: return result.join(""); default: entry = dictionary[cc]; break; }
                    if (enlargeIn === 0) { enlargeIn = Math.pow(2, numBits); numBits++; }
                    if (entry == null) { if (cc === dictSize) entry = w + w.charAt(0); else return null; }
                    result.push(entry); dictionary[dictSize++] = w + entry.charAt(0); enlargeIn--; w = entry;
                    if (enlargeIn === 0) { enlargeIn = Math.pow(2, numBits); numBits++; }
                }
            },
            importFullFromGame: async () => {
                const raw = localStorage.getItem(KB_SAVE_KEY); if(!raw) return app.toast("ã‚²ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“");
                if(!confirm("ã‚²ãƒ¼ãƒ ã®ãƒ‡ãƒ¼ã‚¿ã‚’åºƒå ´ã¸åŒæœŸã—ã¾ã™ã‹ï¼Ÿ")) return;
                try {
                    const save = JSON.parse(raw); const blob = app.lzCompressToUTF16(JSON.stringify(save));
                    const patch = { gameSaveV60Blob: blob, gameInventory: save.inventory||{}, gameCharStats: save.charStats||{} };
                    const items = {}; for(const it of G_ITEMS) if(save.inventory?.[it.id] > 0) items[it.id] = save.inventory[it.id]; patch.items = items;
                    const amArr = []; for(const am of G_AMULETS) if(save.inventory?.[am.id+'_hp'] > 0) amArr.push({ id: am.id, durability: save.inventory[am.id+'_hp'] }); patch.amulets = amArr;
                    await updateDoc(doc(db, "users", currentUser.username), patch); app.toast("å–ã‚Šè¾¼ã¿å®Œäº†");
                } catch(e) { app.toast("åŒæœŸã‚¨ãƒ©ãƒ¼"); }
            },
            exportFullToGame: async () => {
                if(!confirm("åºƒå ´ã‹ã‚‰ã‚²ãƒ¼ãƒ ã¸åæ˜ ã—ã¾ã™ã‹ï¼Ÿ(ä¸Šæ›¸ã)")) return;
                try {
                    let base = {}; if(currentUser.gameSaveV60Blob) base = JSON.parse(app.lzDecompressFromUTF16(currentUser.gameSaveV60Blob));
                    base.coins = currentUser.coins || 0; base.diamonds = currentUser.diamonds || 0; base.playerLevel = currentUser.level || 1;
                    base.inventory = base.inventory || {};
                    for(const [k,v] of Object.entries(currentUser.items||{})) base.inventory[k] = v;
                    for(const a of (currentUser.amulets||[])) base.inventory[a.id+'_hp'] = a.durability || 100;
                    localStorage.setItem(KB_SAVE_KEY, JSON.stringify(base)); app.toast("ã‚²ãƒ¼ãƒ ã¸åæ˜ ã—ã¾ã—ãŸ");
                } catch(e) { app.toast("åæ˜ ã‚¨ãƒ©ãƒ¼"); }
            },
            backupFullGameData: async () => {
                const raw = localStorage.getItem(KB_SAVE_KEY); if(!raw) return app.toast("ãƒ‡ãƒ¼ã‚¿ãªã—");
                await updateDoc(doc(db,"users",currentUser.username),{ history: arrayUnion({v:raw, d:new Date().toLocaleString()}) }); app.toast("ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆ");
            },
            restoreCloudList: () => {
                const h = currentUser.history || []; if(h.length===0) return app.toast("å±¥æ­´ãªã—");
                let list = ""; h.slice(-5).forEach(i => list+=`<div class="mb-2 p-2 border border-[var(--border)]"><div>${i.d}</div><button class="btn btn-sm btn-danger mt-1" onclick='app.execRestore(${i.v})'>å¾©å…ƒ</button></div>`);
                app.mdl("å±¥æ­´", list);
            },
            execRestore: async (v) => {
                if(!confirm("å¾©å…ƒã—ã¾ã™ã‹ï¼Ÿ")) return;
                localStorage.setItem(KB_SAVE_KEY, JSON.stringify(v)); app.toast("å¾©å…ƒã—ã¾ã—ãŸ"); app.closeModal();
            },

            // Admin & News & Gifts
            subNews: () => {
                listeners.push(onSnapshot(query(collection(db,"announcements"), limit(50)), s=>{
                    const l = document.getElementById('news-list'); l.innerHTML="";
                    let items = []; s.forEach(d => { appCache.news[d.id]=d.data(); items.push({id:d.id, ...d.data()}) });
                    items = items.filter(n => (n.publishAt ? toDate(n.publishAt) : toDate(n.createdAt)) <= new Date());
                    items.sort((a,b) => { if(a.pin !== b.pin) return b.pin ? 1 : -1; return (b.publishAt?.seconds||b.createdAt.seconds) - (a.publishAt?.seconds||a.createdAt.seconds); });
                    items.forEach(n => { l.innerHTML += `<div class="card p-3 flex gap-3 cursor-pointer" onclick="app.mdl('${n.title}', \`${n.img?`<img src='${n.img}' class='w-full rounded mb-2'>`:''}<div style='white-space:pre-wrap'>${n.body}</div>\` )">${n.img?`<img src="${n.img}" style="width:50px;height:50px;object-fit:cover;border-radius:8px">`:''}<div><div class="font-bold">${n.pin?'ğŸ“Œ ':''}${n.title}</div><div class="text-xs text-sub">${(n.publishAt?toDate(n.publishAt):toDate(n.createdAt)).toLocaleDateString()}</div></div></div>`; });
                }));
            },
            checkGifts: async () => {
                const s = await getDocs(query(collection(db,"gifts"), where("to","in",["all",currentUser.username])));
                let c=0, h="", now=new Date();
                s.forEach(d=>{ 
                    const g=d.data(), cl=g.claimedBy||[];
                    if(!cl.includes(currentUser.username) && (g.publishAt?toDate(g.publishAt):toDate(g.createdAt))<=now && (!g.expireAt||toDate(g.expireAt)>now)){ 
                        c++; h+=`<div class="card p-2 flex justify-between items-center mb-2"><div><b>${g.val} ${g.type}</b><br><small>${g.msg}</small></div><button class="btn btn-sm btn-primary" style="width:auto" onclick="app.claimGift('${d.id}')">å—å–</button></div>`; 
                    }
                });
                app.mdl("ãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆBOX", c>0?h:"<p class='text-center text-sub'>ã‚ã‚Šã¾ã›ã‚“</p>");
            },
            claimGift: async (id) => {
                try {
                    await runTransaction(db, async tr=>{
                        const gd=await tr.get(doc(db,"gifts",id)); const g=gd.data(); const cl=g.claimedBy||[]; if(cl.includes(currentUser.username)) throw "æ¸ˆ";
                        cl.push(currentUser.username); tr.update(doc(db,"gifts",id),{claimedBy:cl}); tr.update(doc(db,"users",currentUser.username),{[g.type]:increment(g.val)});
                    });
                    app.toast("å—ã‘å–ã‚Šã¾ã—ãŸ"); app.closeModal();
                } catch(e){}
            },
            checkAdmSess: () => { 
                const e=localStorage.getItem(ADM_KEY); 
                if(e&&parseInt(e)>Date.now() && (currentUser?.badges||[]).includes('developer')){ document.getElementById('nav-adm-pc').classList.remove('hidden'); return true; }
                document.getElementById('nav-adm-pc').classList.add('hidden'); return false; 
            },
            authAdmin: async () => {
                const c=document.getElementById('adm-code').value; 
                let vc="cotobato-admin"; try { const d=await getDoc(doc(db,"system","config")); if(d.exists() && d.data().code) vc=d.data().code; } catch(e) {}
                if(c===vc){ localStorage.setItem(ADM_KEY, Date.now()+1800000); app.tab('admin'); app.toast("èªè¨¼æˆåŠŸ"); document.getElementById('adm-code').value=""; } else app.toast("é•ã„ã¾ã™");
            },
            subAdmList: () => {
                onSnapshot(query(collection(db,"announcements"), limit(50)), s=>{
                    const l=document.getElementById('adm-list-news'); l.innerHTML="";
                    s.forEach(d=>{ const n=d.data(); l.innerHTML+=`<div class="card p-2 mb-2 flex justify-between"><div>${n.title}</div><button class="btn btn-sm btn-danger" onclick="app.delDoc('announcements','${d.id}')">å‰Šé™¤</button></div>`; });
                });
                onSnapshot(query(collection(db,"gifts"), limit(30)), s=>{
                    const l=document.getElementById('adm-list-gifts'); l.innerHTML="";
                    s.forEach(d=>{ const g=d.data(); l.innerHTML+=`<div class="card p-2 mb-2 flex justify-between"><div>${g.val} ${g.type}</div><button class="btn btn-sm btn-danger" onclick="app.delDoc('gifts','${d.id}')">å‰Šé™¤</button></div>`; });
                });
            },
            postNews: async () => {
                const ti=document.getElementById('adm-news-title').value, bo=document.getElementById('adm-news-body').value, pi=document.getElementById('adm-news-pin').checked, da=document.getElementById('adm-news-date').value;
                if(!ti) return;
                const d={title:ti, body:bo, pin:pi}; if(newsImg) d.img=newsImg; if(da) d.publishAt=Timestamp.fromDate(new Date(da)); else d.publishAt=serverTimestamp();
                await addDoc(collection(db,"announcements"), d); app.toast("é…ä¿¡ã—ã¾ã—ãŸ"); document.getElementById('adm-news-title').value=""; document.getElementById('adm-news-body').value="";
            },
            distributeGift: async () => {
                const ty=document.getElementById('adm-gift-type').value, va=parseInt(document.getElementById('adm-gift-val').value), ms=document.getElementById('adm-gift-msg').value;
                if(!va) return;
                await addDoc(collection(db,"gifts"), {type:ty, val:va, msg:ms, to:"all", claimedBy:[], createdAt:serverTimestamp()}); app.toast("é…å¸ƒã—ã¾ã—ãŸ");
            },
            delDoc: async (c,i) => { if(confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) await deleteDoc(doc(db,c,i)); },
            admLoadStampQueue: async () => {
                const box = document.getElementById('adm-stamp-queue'); if(!box) return; box.innerHTML = "";
                const snap = await getDocs(query(collection(db,'stampPacks'), where('status','==','pending'), limit(20)));
                if(snap.empty) return box.innerHTML = "<div class='text-xs text-sub'>ç”³è«‹ã¯ã‚ã‚Šã¾ã›ã‚“</div>";
                snap.forEach(d => { const p = d.data(); box.innerHTML += `<div class="card mb-2 flex justify-between items-center"><div class="font-bold">${p.title} (${p.count}å€‹)</div><button class="btn btn-sm btn-primary" onclick="app.admApprovePack('${d.id}')">ä¸€æ‹¬æ‰¿èª</button></div>`; });
            },
            admApprovePack: async (packId) => {
                await updateDoc(doc(db,'stampPacks', packId), { status:'approved' });
                const snap = await getDocs(query(collection(db, 'stamps'), where('packId', '==', packId)));
                snap.forEach(d => updateDoc(doc(db, 'stamps', d.id), { status:'approved' }));
                app.toast('æ‰¿èªã—ã¾ã—ãŸ'); app.admLoadStampQueue();
            },
            admShowApprovedStamps: async () => {
                const snap = await getDocs(query(collection(db,'stampPacks'), where('status','==','approved'), limit(50)));
                let html = '';
                snap.forEach(d => { const p=d.data(); html+=`<div class="flex justify-between items-center border-b border-[var(--border)] py-2"><div>${p.title}</div><button class="btn btn-sm btn-danger" onclick="if(confirm('å‰Šé™¤?')) app.delDoc('stampPacks','${d.id}')">å‰Š</button></div>`; });
                app.mdl('æ‰¿èªæ¸ˆã¿ãƒ‘ãƒƒã‚¯', html||'ãªã—');
            },

            mdl: (t,c) => { document.getElementById('mdl-title').innerText=t; document.getElementById('mdl-content').innerHTML=c; document.getElementById('modal-base').style.display='flex'; },
            closeModal: () => document.getElementById('modal-base').style.display='none',
            toast: (m) => { const e=document.getElementById('toast'); e.innerText=m; e.classList.add('show'); setTimeout(()=>e.classList.remove('show'),3000); }
        };

        window.addEventListener('load', () => { if(!document.querySelector('.screen.active')) document.getElementById('scr-login').classList.add('active'); });
        window.app = app;
        app.init();
    </script>
</body>
</html>
