<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HYPER PARTY ULTIMATE</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Bangers&family=M+PLUS+Rounded+1c:wght@900&display=swap" rel="stylesheet">
    
    <style>
        :root { --bg: #0d0015; --neon-pink: #ff00ff; --neon-blue: #00ffff; --neon-green: #00ff00; --yellow: #ffcc00; }
        body { margin: 0; background: var(--bg); color: white; font-family: 'M PLUS Rounded 1c', sans-serif; overflow: hidden; height: 100vh; touch-action: manipulation; user-select: none; text-align: center; }

        /* èƒŒæ™¯ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .bg-anim { position: fixed; inset: 0; z-index: -1; background: radial-gradient(circle at center, #2a003b 0%, #000 100%); }
        .grid { position: absolute; inset: 0; background-image: linear-gradient(rgba(255, 0, 255, 0.1) 1px, transparent 1px), linear-gradient(90deg, rgba(255, 0, 255, 0.1) 1px, transparent 1px); background-size: 50px 50px; perspective: 1000px; transform: rotateX(20deg) scale(1.5); animation: moveGrid 10s linear infinite; }
        @keyframes moveGrid { 0% { background-position: 0 0; } 100% { background-position: 0 50px; } }

        /* ç”»é¢å…±é€š */
        .screen { position: fixed; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.3s, transform 0.3s; }
        .hidden { opacity: 0; pointer-events: none; z-index: -10; transform: scale(0.9); }
        h1 { font-family: 'Bangers', cursive; font-size: 4rem; color: var(--neon-blue); text-shadow: 4px 4px 0 var(--neon-pink); letter-spacing: 2px; margin: 0; }
        
        /* UIãƒ‘ãƒ¼ãƒ„ */
        .btn { background: linear-gradient(45deg, var(--neon-pink), #9900ff); border: 2px solid white; color: white; padding: 15px 50px; font-size: 1.5rem; border-radius: 50px; cursor: pointer; margin: 15px; box-shadow: 0 0 20px var(--neon-pink); transition: 0.1s; font-family: 'Bangers', cursive; letter-spacing: 2px; }
        .btn:active { transform: scale(0.95); filter: brightness(1.2); }
        .input-box { font-size: 1.5rem; padding: 10px; border-radius: 10px; border: 2px solid var(--neon-blue); background: rgba(0,0,0,0.5); color: white; text-align: center; width: 60%; margin-bottom: 10px; }

        /* ãƒ›ã‚¹ãƒˆ: ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆ */
        .roulette-container { position: relative; width: 350px; height: 350px; margin: 20px; }
        .roulette-wheel { width: 100%; height: 100%; border-radius: 50%; border: 10px solid white; box-shadow: 0 0 30px var(--neon-blue); transition: transform 3s cubic-bezier(0.1, 0.9, 0.2, 1); background: conic-gradient(
            var(--neon-pink) 0deg 60deg, 
            var(--neon-blue) 60deg 120deg, 
            var(--neon-green) 120deg 180deg, 
            var(--yellow) 180deg 240deg, 
            #ff4757 240deg 300deg, 
            #9900ff 300deg 360deg
        ); position: relative; }
        .roulette-arrow { position: absolute; top: -20px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 20px solid transparent; border-right: 20px solid transparent; border-top: 40px solid white; z-index: 10; filter: drop-shadow(0 0 10px white); }
        .stopper-info { font-size: 2rem; color: var(--yellow); font-weight: bold; margin-top: 20px; animation: blink 0.5s infinite; }

        /* ãƒ›ã‚¹ãƒˆ: ã‚²ãƒ¼ãƒ ç”»é¢ (ãƒœã‚¹æˆ¦) */
        .boss-container { position: relative; width: 300px; height: 300px; }
        .boss-img { font-size: 10rem; animation: float 2s infinite ease-in-out; filter: drop-shadow(0 0 20px red); }
        .boss-hp-bar { width: 80%; height: 30px; background: #333; border-radius: 15px; overflow: hidden; border: 2px solid white; margin-top: 10px; }
        .boss-hp-fill { height: 100%; background: linear-gradient(90deg, #ff0000, #ff8800); width: 100%; transition: width 0.2s; }
        .damage-text { position: absolute; color: white; font-weight: bold; font-size: 2rem; animation: popUp 0.5s forwards; pointer-events: none; }
        
        /* ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ: ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ */
        .ctrl-btn { width: 250px; height: 250px; border-radius: 50%; border: none; font-size: 3rem; font-weight: 900; color: white; box-shadow: 0 15px 0 rgba(0,0,0,0.5); transition: 0.05s; display: flex; align-items: center; justify-content: center; flex-direction: column; }
        .c-mash { background: #ff4757; box-shadow: 0 15px 0 #c41e3a; }
        .c-mash:active { transform: translateY(15px); box-shadow: none; }
        .c-stop { background: var(--yellow); color: black; box-shadow: 0 15px 0 #d4a017; animation: pulse 0.5s infinite; }
        .c-stop:active { transform: translateY(15px); box-shadow: none; }

        /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®šç¾© */
        @keyframes blink { 50% { opacity: 0; } }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-20px); } }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        @keyframes popUp { 0% { opacity: 1; transform: translateY(0) scale(1); } 100% { opacity: 0; transform: translateY(-50px) scale(1.5); } }
        .shake { animation: shake 0.5s; }
        @keyframes shake { 0% { transform: translate(1px, 1px) rotate(0deg); } 10% { transform: translate(-1px, -2px) rotate(-1deg); } 20% { transform: translate(-3px, 0px) rotate(1deg); } 30% { transform: translate(3px, 2px) rotate(0deg); } 40% { transform: translate(1px, -1px) rotate(1deg); } 50% { transform: translate(-1px, 2px) rotate(-1deg); } 60% { transform: translate(-3px, 1px) rotate(0deg); } 70% { transform: translate(3px, 1px) rotate(-1deg); } 80% { transform: translate(-1px, -1px) rotate(1deg); } 90% { transform: translate(1px, 2px) rotate(0deg); } 100% { transform: translate(1px, -2px) rotate(-1deg); } }

    </style>
</head>
<body>
    <div class="bg-anim"><div class="grid"></div></div>

    <div id="s-top" class="screen">
        <h1>HYPER PARTY<br>ULTIMATE</h1>
        <p style="font-size:1.2rem; color:var(--neon-green);">ã‚¹ãƒãƒ›é€£å‹•ãƒ»æœ€å¼·ãƒ‘ãƒ¼ãƒ†ã‚£ã‚²ãƒ¼ãƒ </p>
        <button id="btn-host" class="btn">ğŸ’» ãƒ›ã‚¹ãƒˆã§ã¯ã˜ã‚ã‚‹</button>
        <button id="btn-client" class="btn" style="background:var(--neon-blue); color:black;">ğŸ“± å‚åŠ ã™ã‚‹</button>
    </div>

    <div id="s-h-lobby" class="screen hidden">
        <h2>ROOM ID</h2>
        <div id="disp-id" style="font-size:5rem; font-family:'Bangers'; color:var(--yellow);">----</div>
        <div id="qrcode" style="background:white; padding:10px; border-radius:10px;"></div>
        <p>å‚åŠ è€…: <span id="p-count" style="color:var(--neon-pink); font-size:2rem; font-weight:bold;">0</span> äºº</p>
        <button id="btn-start-roulette" class="btn">ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆé–‹å§‹ï¼</button>
    </div>

    <div id="s-h-roulette" class="screen hidden">
        <h1 style="font-size:3rem;">NEXT GAME?</h1>
        <div class="roulette-container">
            <div class="roulette-arrow"></div>
            <div id="wheel" class="roulette-wheel"></div>
        </div>
        <div id="stopper-name" class="stopper-info">èª°ã‹ãŒæ­¢ã‚ã‚‹ã®ã‚’å¾…ã£ã¦ã„ã¾ã™...</div>
    </div>

    <div id="s-h-game" class="screen hidden">
        <h2 id="g-title" style="color:var(--neon-green);">BOSS BATTLE</h2>
        <div id="boss-area" class="boss-container">
            <div id="boss-icon" class="boss-img">ğŸ‘¾</div>
            <div class="damage-text" id="dmg-fx" style="display:none;">-10</div>
        </div>
        <div id="hp-container" style="width:100%; max-width:500px;">
            <div class="boss-hp-bar"><div id="hp-bar" class="boss-hp-fill"></div></div>
            <p id="hp-text" style="font-weight:bold;">HP: 1000/1000</p>
        </div>
        
        <h1 id="timer-disp" style="font-size:4rem; margin:10px;">10.0</h1>
        <div id="ranking" style="font-size:1.2rem; color:#aaa;"></div>
    </div>

    <div id="s-h-result" class="screen hidden">
        <h1>WINNER</h1>
        <div id="winner-name" style="font-size:4rem; color:var(--yellow); font-weight:bold;">NAME</div>
        <button onclick="location.reload()" class="btn">ã‚‚ã†ä¸€åº¦éŠã¶</button>
    </div>

    <div id="s-c-login" class="screen hidden">
        <h2>ROOM ID</h2>
        <input id="inp-id" class="input-box" placeholder="ABCD">
        <input id="inp-name" class="input-box" placeholder="ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ">
        <button id="btn-join" class="btn">å‚åŠ ï¼</button>
    </div>

    <div id="s-c-play" class="screen hidden">
        <div id="c-msg" style="font-size:1.5rem; margin-bottom:20px; font-weight:bold;">å¾…æ©Ÿä¸­...</div>
        <div id="c-area"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, set, get, onValue, update, remove, onDisconnect, increment, child, runTransaction } 
               from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        // â–¼ Firebaseè¨­å®š (ã”è‡ªèº«ã®config)
        const firebaseConfig = {
            apiKey: "AIzaSyDbZzTMvUkG2LXIGY4ux0KBTmnAdqP236s",
            authDomain: "game-4f2d9.firebaseapp.com",
            databaseURL: "https://game-4f2d9-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "game-4f2d9",
            storageBucket: "game-4f2d9.firebasestorage.app",
            messagingSenderId: "574316347824",
            appId: "1:574316347824:web:cf686040628e25ad615675"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- å¤‰æ•° ---
        let myId = "P" + Math.random().toString(36).substr(2, 5);
        let roomId = "";
        let players = {};
        let gameState = {};
        
        // åŠ¹æœéŸ³
        const playSound = (type) => {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.connect(gain); gain.connect(ctx.destination);
            
            if(type==='win') {
                osc.type = 'square'; osc.frequency.setValueAtTime(400, ctx.currentTime);
                osc.frequency.linearRampToValueAtTime(800, ctx.currentTime+0.1);
                gain.gain.linearRampToValueAtTime(0, ctx.currentTime+0.5);
                osc.start(); osc.stop(ctx.currentTime+0.5);
            } else if (type==='hit') {
                osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, ctx.currentTime);
                gain.gain.linearRampToValueAtTime(0, ctx.currentTime+0.1);
                osc.start(); osc.stop(ctx.currentTime+0.1);
            }
        };

        // DOM
        const $ = id => document.getElementById(id);
        const show = id => {
            document.querySelectorAll('.screen').forEach(e => e.classList.add('hidden'));
            $(id).classList.remove('hidden');
        };

        // ================= HOST =================
        $('btn-host').addEventListener('click', () => {
            roomId = Math.random().toString(36).substr(2, 4).toUpperCase();
            const rRef = ref(db, `rooms/${roomId}`);
            set(rRef, { status: 'lobby', host: myId });
            onDisconnect(rRef).remove();

            $('disp-id').innerText = roomId;
            $('qrcode').innerHTML = "";
            new QRCode($('qrcode'), { text: `${location.origin}${location.pathname}?room=${roomId}`, width: 128, height: 128 });
            show('s-h-lobby');

            onValue(ref(db, `rooms/${roomId}/players`), snap => {
                players = snap.val() || {};
                $('p-count').innerText = Object.keys(players).length;
            });
        });

        // ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆé–‹å§‹ãƒœã‚¿ãƒ³
        $('btn-start-roulette').addEventListener('click', () => {
            const pIds = Object.keys(players);
            if(pIds.length === 0) return alert("å‚åŠ è€…ãŒã„ã¾ã›ã‚“");
            
            // ã‚¹ãƒˆãƒƒãƒ‘ãƒ¼ã‚’ãƒ©ãƒ³ãƒ€ãƒ é¸å‡º
            const stopperId = pIds[Math.floor(Math.random() * pIds.length)];
            const stopperName = players[stopperId].name;

            update(ref(db, `rooms/${roomId}`), {
                status: 'roulette',
                stopper: stopperId,
                stopperName: stopperName,
                spin: true // å›è»¢ä¸­ãƒ•ãƒ©ã‚°
            });
            
            show('s-h-roulette');
            startRouletteAnim(stopperName);
        });

        let rouletteAnim;
        function startRouletteAnim(stopperName) {
            const wheel = $('wheel');
            let deg = 0;
            $('stopper-name').innerText = `ã‚¹ãƒˆãƒƒãƒ‘ãƒ¼: ${stopperName} ã•ã‚“ï¼`;
            $('stopper-name').style.color = "var(--yellow)";
            
            // é«˜é€Ÿå›è»¢
            rouletteAnim = setInterval(() => {
                deg = (deg + 20) % 360;
                wheel.style.transform = `rotate(${deg}deg)`;
            }, 16); // 60fps

            // DBç›£è¦–: spinãŒfalseã«ãªã£ãŸã‚‰æ­¢ã¾ã‚‹
            const unsub = onValue(ref(db, `rooms/${roomId}/spin`), snap => {
                if(snap.val() === false) {
                    clearInterval(rouletteAnim);
                    unsub();
                    stopRouletteAndStartGame(deg);
                }
            });
        }

        function stopRouletteAndStartGame(currentDeg) {
            playSound('win');
            // æ¼”å‡ºç”¨ã«å°‘ã—æ»‘ã‚‰ã›ã‚‹
            const finalDeg = currentDeg + 360 + Math.floor(Math.random()*100);
            $('wheel').style.transition = "transform 2s cubic-bezier(0.1, 0.9, 0.2, 1)";
            $('wheel').style.transform = `rotate(${finalDeg}deg)`;
            $('stopper-name').innerText = "æ±ºå®šï¼ï¼";
            confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });

            setTimeout(() => {
                startGame();
            }, 3000);
        }

        function startGame() {
            // ãƒœã‚¹æˆ¦ (é€£æ‰“ã‚²ãƒ¼) ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
            const maxHp = Object.keys(players).length * 50; // 1äºº50ç™º
            update(ref(db, `rooms/${roomId}`), {
                status: 'game',
                gameType: 'boss',
                bossHp: maxHp,
                maxHp: maxHp,
                state: 'play'
            });

            // å…¨å“¡ã®ã‚¹ã‚³ã‚¢ãƒªã‚»ãƒƒãƒˆ
            const updates = {};
            Object.keys(players).forEach(pid => updates[`rooms/${roomId}/players/${pid}/score`] = 0);
            update(ref(db), updates);

            show('s-h-game');
            $('hp-bar').style.width = "100%";
            $('hp-text').innerText = `${maxHp}/${maxHp}`;
            
            // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ HPç›£è¦–
            onValue(ref(db, `rooms/${roomId}/bossHp`), snap => {
                const current = snap.val();
                if(current == null) return;
                
                const max = Number($('hp-text').innerText.split('/')[1]);
                const pct = Math.max(0, (current / max) * 100);
                $('hp-bar').style.width = pct + "%";
                $('hp-text').innerText = `${current}/${max}`;

                // ãƒ€ãƒ¡ãƒ¼ã‚¸æ¼”å‡º
                $('boss-icon').classList.add('shake');
                setTimeout(()=>$('boss-icon').classList.remove('shake'), 200);

                if(current <= 0) finishGame();
            });

            // ã‚¿ã‚¤ãƒãƒ¼
            let time = 20.0;
            const timer = setInterval(() => {
                time -= 0.1;
                $('timer-disp').innerText = time.toFixed(1);
                if(time <= 0) {
                    clearInterval(timer);
                    finishGame(); // å€’ã—ãã‚Œãªãã¦ã‚‚çµ‚äº†
                }
            }, 100);
            // HP0ã§çµ‚äº†ç”¨ã®ç›£è¦–
            const hpUnsub = onValue(ref(db, `rooms/${roomId}/bossHp`), s=>{
                if((s.val()||0) <= 0) clearInterval(timer);
            });
        }

        function finishGame() {
            // MVPåˆ¤å®š
            get(ref(db, `rooms/${roomId}/players`)).then(snap => {
                let maxS = -1, mvp = "NOBODY";
                snap.forEach(p => {
                    if(p.val().score > maxS) { maxS = p.val().score; mvp = p.val().name; }
                });
                show('s-h-result');
                $('winner-name').innerText = mvp;
                confetti({ particleCount: 200, spread: 100 });
                playSound('win');
            });
        }


        // ================= CLIENT =================
        const params = new URLSearchParams(location.search);
        if(params.get('room')) { $('inp-id').value = params.get('room'); show('s-c-login'); }
        $('btn-client').addEventListener('click', () => show('s-c-login'));

        $('btn-join').addEventListener('click', async () => {
            const rid = $('inp-id').value.toUpperCase().trim();
            const name = $('inp-name').value || "NO NAME";
            if(!rid) return;

            // éƒ¨å±‹ãƒã‚§ãƒƒã‚¯
            const snap = await get(child(ref(db), `rooms/${rid}`));
            if(!snap.exists()) return alert("éƒ¨å±‹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");

            roomId = rid;
            const pRef = ref(db, `rooms/${roomId}/players/${myId}`);
            set(pRef, { name: name, score: 0 }).then(() => {
                onDisconnect(pRef).remove();
                show('s-c-play');
                initClient();
            });
        });

        function initClient() {
            onValue(ref(db, `rooms/${roomId}`), snap => {
                const data = snap.val();
                if(!data) return location.reload();

                const area = $('c-area');
                $('c-msg').innerText = "";

                // --- ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆå¾…æ©Ÿ / ã‚¹ãƒˆãƒƒãƒ‘ãƒ¼ ---
                if(data.status === 'roulette') {
                    if(data.stopper === myId && data.spin === true) {
                        // ã‚ãªãŸãŒã‚¹ãƒˆãƒƒãƒ‘ãƒ¼ã§ã™ï¼
                        area.innerHTML = "";
                        const btn = document.createElement('button');
                        btn.className = "ctrl-btn c-stop";
                        btn.innerText = "STOP!!";
                        btn.onclick = () => {
                            // å›è»¢ã‚’æ­¢ã‚ã‚‹
                            update(ref(db, `rooms/${roomId}`), { spin: false });
                            navigator.vibrate([100,50,100]);
                        };
                        area.appendChild(btn);
                        $('c-msg').innerText = "ä»Šã ï¼æŠ¼ã—ã¦ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆã‚’æ­¢ã‚ã‚ï¼";
                    } else {
                        // ä»–ã®äººãŒã‚¹ãƒˆãƒƒãƒ‘ãƒ¼
                        area.innerHTML = `<div style="font-size:3rem">ğŸ™</div>`;
                        $('c-msg').innerText = `${data.stopperName}ã•ã‚“ãŒãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆä¸­...ç¥ˆã‚Œï¼`;
                    }
                }
                // --- ã‚²ãƒ¼ãƒ æœ¬ç·¨ (ãƒœã‚¹æˆ¦) ---
                else if (data.status === 'game' && data.state === 'play') {
                    area.innerHTML = "";
                    const btn = document.createElement('button');
                    btn.className = "ctrl-btn c-mash";
                    btn.innerHTML = "ATTACK<br>ğŸ‘Š";
                    
                    // é€£æ‰“ãƒ­ã‚¸ãƒƒã‚¯
                    btn.addEventListener('pointerdown', (e) => {
                        e.preventDefault();
                        btn.style.transform = "scale(0.9) translateY(10px)";
                        navigator.vibrate(10);
                        
                        // Transactionã§HPæ¸›ç®— & ã‚¹ã‚³ã‚¢åŠ ç®—
                        const hpRef = ref(db, `rooms/${roomId}/bossHp`);
                        runTransaction(hpRef, (hp) => (hp || 0) - 1);
                        
                        const scRef = ref(db, `rooms/${roomId}/players/${myId}/score`);
                        runTransaction(scRef, (s) => (s || 0) + 1);
                    });
                    btn.addEventListener('pointerup', () => btn.style.transform = "scale(1)");
                    
                    area.appendChild(btn);
                    $('c-msg').innerText = "é€£æ‰“ã—ã¦ãƒœã‚¹ã‚’å€’ã›ï¼";
                }
                // --- çµæœ ---
                else if (data.status === 'result') {
                    area.innerHTML = "FINISH";
                }
            });
        }

    </script>
</body>
</html>
