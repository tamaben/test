<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI人狼コネクト - オンライン＆ソロ対応</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@700;900&display=swap');

        :root {
            --bg: #121212;
            --panel: #1e1e1e;
            --accent: #ff4d4d;
            --seer: #cc33ff;
            --wolf: #ff4d4d;
            --village: #4d94ff;
        }

        body { font-family: 'Zen Maru Gothic', sans-serif; background: var(--bg); color: white; margin: 0; }
        .hidden { display: none !important; }
        .full-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; padding: 20px; box-sizing: border-box; }

        /* --- ホスト画面デザイン --- */
        #host-view { background: radial-gradient(circle, #222, #000); }
        .log-box { width: 100%; max-width: 800px; height: 300px; background: #000; overflow-y: auto; border-radius: 10px; padding: 15px; border: 1px solid #333; margin: 20px 0; font-size: 16px; }
        .player-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; width: 100%; max-width: 800px; }
        .p-card { background: var(--panel); padding: 15px; border-radius: 10px; text-align: center; border: 2px solid #333; position: relative; }
        .p-card.dead { opacity: 0.4; filter: grayscale(1); }
        .p-card.ai { border-style: dashed; }
        .role-tag { font-size: 12px; padding: 2px 8px; border-radius: 5px; background: #444; margin-top: 5px; display: inline-block; }

        /* --- スマホ画面デザイン --- */
        #player-view { background: #1a1a1a; text-align: center; }
        .action-btn { background: var(--accent); border: none; color: white; padding: 15px 30px; font-size: 20px; border-radius: 50px; cursor: pointer; margin: 10px; font-weight: bold; width: 80%; }
        .action-btn:disabled { background: #444; }
        select { width: 80%; padding: 15px; font-size: 18px; border-radius: 10px; background: #333; color: white; margin-bottom: 10px; }

        /* --- 共通パーツ --- */
        h1 { color: var(--accent); text-shadow: 0 0 10px rgba(255,0,0,0.5); margin: 0; }
        .btn { background: #444; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; }
        .qr-area { background: white; padding: 10px; border-radius: 10px; margin: 20px 0; }
        .msg-box { background: var(--panel); padding: 20px; border-radius: 15px; margin: 15px 0; width: 100%; max-width: 400px; border-left: 5px solid var(--accent); }
    </style>
</head>
<body>

    <!-- ホスト表示 (PC用) -->
    <div id="host-view" class="full-screen hidden">
        <h1 id="host-room-id">ROOM: ----</h1>
        <div id="lobby-ui">
            <div class="qr-area" id="qrcode"></div>
            <p>スマホでQRをスキャンして参加！</p>
            <div style="margin: 20px;">
                総人数：<input type="number" id="total-target" value="5" min="3" max="10" style="width: 50px; padding: 5px;">
                <button class="action-btn" style="width:auto;" onclick="hostStart()">AIを補充して開始</button>
            </div>
        </div>

        <div id="game-ui" class="hidden">
            <h2 id="phase-title">議論中...</h2>
            <div class="player-grid" id="host-player-list"></div>
            <div class="log-box" id="host-log"></div>
        </div>
    </div>

    <!-- プレイヤー表示 (スマホ用) -->
    <div id="player-view" class="full-screen hidden">
        <h1 id="my-name-display">---</h1>
        <div id="player-wait" class="msg-box">
            ホストがゲームを開始するのを待っています...
        </div>

        <div id="player-action" class="hidden">
            <div id="role-announce" class="msg-box" style="border-color: var(--village);">
                あなたの役職：<span id="my-role">---</span>
            </div>
            <div id="action-content">
                <p id="action-msg">対象を選んでください</p>
                <select id="target-select"></select>
                <button class="action-btn" id="confirm-btn" onclick="submitAction()">決定</button>
            </div>
            <div id="secret-log" style="font-size: 14px; color: #aaa; margin-top: 10px;"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
        import { getDatabase, ref, set, onValue, update, push, onDisconnect } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

        // Firebase設定 (前述の物を使用)
        const firebaseConfig = {
            apiKey: "AIzaSyDbZzTMvUkG2LXIGY4ux0KBTmnAdqP236s",
            authDomain: "game-4f2d9.firebaseapp.com",
            databaseURL: "https://game-4f2d9-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "game-4f2d9",
            storageBucket: "game-4f2d9.firebasestorage.app",
            messagingSenderId: "574316347824",
            appId: "1:574316347824:web:cf686040628e25ad615675"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const params = new URLSearchParams(window.location.search);
        let role = params.get('role') || 'host';
        let roomId = params.get('room');
        const myId = Math.random().toString(36).substr(2, 6);

        // --- ホスト側ロジック ---
        if (role === 'host') {
            if (!roomId) {
                roomId = Math.random().toString(36).substring(2, 6).toUpperCase();
                window.location.replace(`?role=host&room=${roomId}`);
            }
            document.getElementById('host-view').classList.remove('hidden');
            document.getElementById('host-room-id').innerText = `ROOM: ${roomId}`;
            
            new QRCode(document.getElementById("qrcode"), {
                text: `${window.location.origin}${window.location.pathname}?role=player&room=${roomId}`,
                width: 160, height: 160
            });

            const roomRef = ref(db, `jinro/${roomId}`);
            
            // プレイヤー参加監視
            onValue(ref(db, `jinro/${roomId}/players`), (snap) => {
                const players = snap.val() || {};
                const list = document.getElementById('host-player-list');
                list.innerHTML = '';
                Object.entries(players).forEach(([id, p]) => {
                    list.innerHTML += `<div class="p-card ${p.alive ? '' : 'dead'} ${p.isAI ? 'ai' : ''}">${p.name}</div>`;
                });
            });

            // ホスト：ゲーム開始処理
            window.hostStart = async () => {
                const snap = await onValue(ref(db, `jinro/${roomId}/players`), s => {}, {onlyOnce: true});
                let players = snap.val() || {};
                const targetTotal = parseInt(document.getElementById('total-target').value);
                
                // AI補充
                const aiNames = ["タナカ", "スズキ", "サトウ", "イトウ", "カトウ", "ヤマダ"];
                let currentCount = Object.keys(players).length;
                while (currentCount < targetTotal) {
                    const aiId = "ai_" + Math.random().toString(36).substr(2, 4);
                    players[aiId] = { name: aiNames[currentCount % aiNames.length], isAI: true, alive: true, role: "" };
                    currentCount++;
                }

                // 役職配布
                const ids = Object.keys(players);
                const roles = [ "人狼", "占い師" ];
                while (roles.length < ids.length) roles.push("村人");
                roles.sort(() => Math.random() - 0.5);
                
                ids.forEach((id, idx) => players[id].role = roles[idx]);

                await set(roomRef, {
                    players: players,
                    state: { phase: 'NIGHT', day: 1, logs: ["--- 1日目の夜が来ました ---"] },
                    actions: {}
                });
                
                document.getElementById('lobby-ui').classList.add('hidden');
                document.getElementById('game-ui').classList.remove('hidden');
                startGameLoo
