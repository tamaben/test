<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>200ã‚²ãƒ¼ãƒ  & ã‚»ãƒ³ã‚µãƒ¼ãƒãƒˆãƒ«</title>
    <style>
        body { font-family: 'Helvetica Neue', sans-serif; text-align: center; background: #222; color: #fff; padding: 20px; touch-action: manipulation; }
        h1 { font-size: 24px; color: #ffcc00; }
        .card { background: #333; border-radius: 15px; padding: 20px; margin: 20px auto; max-width: 400px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); min-height: 200px; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .game-title { font-size: 28px; font-weight: bold; margin-bottom: 10px; color: #00d2ff; }
        .game-desc { font-size: 18px; line-height: 1.5; color: #ddd; }
        .btn { background: #ff4081; color: white; border: none; padding: 15px 30px; font-size: 20px; border-radius: 50px; cursor: pointer; margin-top: 20px; width: 100%; max-width: 300px; box-shadow: 0 4px 0 #c60055; active { box-shadow: none; transform: translateY(4px); } }
        .btn-sensor { background: #00e676; box-shadow: 0 4px 0 #00a854; }
        .status { font-size: 12px; color: #888; margin-top: 20px; }
        #shakeCount { font-size: 50px; color: #ffcc00; display: none; }
    </style>
</head>
<body>

    <h1>ğŸ”¥ ç„¡é™ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆ 200</h1>
    
    <div class="card">
        <div id="gameContent">
            <div class="game-title">Ready?</div>
            <div class="game-desc">ä¸‹ã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã‚²ãƒ¼ãƒ ã‚’ã‚¹ã‚¿ãƒ¼ãƒˆï¼<br>ï¼ˆåˆå›ã®ã¿ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆã«æ•°ç§’ã‹ã‹ã‚Šã¾ã™ï¼‰</div>
        </div>
        <div id="shakeCount">0</div>
    </div>

    <button id="nextBtn" class="btn">ğŸ² æ¬¡ã®ã‚²ãƒ¼ãƒ ã‚’å¼•ã</button>
    <br><br>
    <button id="sensorBtn" class="btn btn-sensor" style="display:none;">ğŸ“± ã‚»ãƒ³ã‚µãƒ¼è¨±å¯ (ä½“ã‚’ä½¿ã†ã‚²ãƒ¼ãƒ ç”¨)</button>

    <div id="status" class="status">æ¥ç¶š: åˆæœŸåŒ–ä¸­...</div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { 
            getFirestore, 
            collection, 
            getDocs, 
            doc, 
            writeBatch, 
            enableIndexedDbPersistence, 
            onSnapshot
        } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // â–¼ ãƒ¦ãƒ¼ã‚¶ãƒ¼æ§˜ã®è¨­å®š â–¼
        const firebaseConfig = {
            apiKey: "AIzaSyDbZzTMvUkG2LXIGY4ux0KBTmnAdqP236s",
            authDomain: "game-4f2d9.firebaseapp.com",
            projectId: "game-4f2d9",
            storageBucket: "game-4f2d9.firebasestorage.app",
            messagingSenderId: "574316347824",
            appId: "1:574316347824:web:cf686040628e25ad615675",
            measurementId: "G-T0ZKQCC9L3"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const statusDiv = document.getElementById('status');
        const gameContent = document.getElementById('gameContent');
        const nextBtn = document.getElementById('nextBtn');
        const sensorBtn = document.getElementById('sensorBtn');
        const shakeCountDiv = document.getElementById('shakeCount');

        let allGames = [];
        let isSensorGame = false;
        let shakeScore = 0;

        // 1. ã‚ªãƒ•ãƒ©ã‚¤ãƒ³å¯¾å¿œã®æœ‰åŠ¹åŒ–
        enableIndexedDbPersistence(db).catch((err) => {
            console.log("Persistence error:", err.code);
        });

        // 2. ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ & åˆå›ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ
        async function loadGames() {
            statusDiv.textContent = "ãƒ‡ãƒ¼ã‚¿èª­è¾¼ä¸­...";
            const querySnapshot = await getDocs(collection(db, "games200"));
            
            if (querySnapshot.empty) {
                statusDiv.textContent = "åˆå›ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—: 200å€‹ã®ã‚²ãƒ¼ãƒ ã‚’ç”Ÿæˆä¸­...";
                await generate200Games();
                // ç”Ÿæˆå¾Œã«å†èª­ã¿è¾¼ã¿
                loadGames(); 
            } else {
                allGames = [];
                querySnapshot.forEach((doc) => {
                    allGames.push(doc.data());
                });
                statusDiv.textContent = `æº–å‚™å®Œäº†: ${allGames.length}å€‹ã®ã‚²ãƒ¼ãƒ æ­è¼‰ (ã‚ªãƒ•ãƒ©ã‚¤ãƒ³OK)`;
                
                // ã‚­ãƒ£ãƒƒã‚·ãƒ¥åˆ¤å®šã®ç›£è¦–
                onSnapshot(collection(db, "games200"), (snap) => {
                    const source = snap.metadata.fromCache ? "ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰" : "ã‚ªãƒ³ãƒ©ã‚¤ãƒ³";
                    statusDiv.textContent = `çŠ¶æ…‹: ${source} - ã‚²ãƒ¼ãƒ æ•°: ${allGames.length}`;
                });
            }
        }

        // 3. ã‚²ãƒ¼ãƒ ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«è¡¨ç¤º
        nextBtn.addEventListener('click', () => {
            if (allGames.length === 0) return;
            
            // ã‚»ãƒ³ã‚µãƒ¼ã‚²ãƒ¼ãƒ ã®ãƒªã‚»ãƒƒãƒˆ
            stopSensorGame();

            const randomGame = allGames[Math.floor(Math.random() * allGames.length)];
            
            // HTMLè¡¨ç¤ºæ›´æ–°
            gameContent.innerHTML = `
                <div class="game-title">${randomGame.title}</div>
                <div class="game-desc">${randomGame.desc}</div>
                <div style="margin-top:10px; font-size:12px; color:#aaa;">ã‚«ãƒ†ã‚´ãƒª: ${randomGame.category}</div>
            `;

            // ä½“ã‚’ä½¿ã†ã‚»ãƒ³ã‚µãƒ¼ã‚²ãƒ¼ãƒ ã®å ´åˆã®å‡¦ç†
            if (randomGame.category === "ã‚»ãƒ³ã‚µãƒ¼") {
                isSensorGame = true;
                shakeScore = 0;
                shakeCountDiv.textContent = "0";
                shakeCountDiv.style.display = "block";
                
                // iOSç”¨ã®è¨±å¯ãƒœã‚¿ãƒ³è¡¨ç¤ºåˆ¤å®š
                if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
                    sensorBtn.style.display = "inline-block";
                    gameContent.innerHTML += `<p style="color:#f00">ä¸‹ã®ç·‘ã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã‚»ãƒ³ã‚µãƒ¼ã‚’è¨±å¯ã—ã¦ãã ã•ã„ï¼</p>`;
                } else {
                    startSensor();
                }
            }
        });

        // --- ã‚»ãƒ³ã‚µãƒ¼(åŠ é€Ÿåº¦)å‡¦ç† ---
        sensorBtn.addEventListener('click', () => {
            DeviceMotionEvent.requestPermission()
                .then(response => {
                    if (response === 'granted') {
                        sensorBtn.style.display = 'none';
                        startSensor();
                    } else {
                        alert('è¨±å¯ãŒãªã„ã¨ã“ã®ã‚²ãƒ¼ãƒ ã¯éŠã¹ã¾ã›ã‚“');
                    }
                })
                .catch(console.error);
        });

        function startSensor() {
            window.addEventListener('devicemotion', handleMotion);
        }

        function stopSensorGame() {
            isSensorGame = false;
            shakeCountDiv.style.display = "none";
            window.removeEventListener('devicemotion', handleMotion);
        }

        let lastX = 0, lastY = 0, lastZ = 0;
        function handleMotion(event) {
            if (!isSensorGame) return;
            
            const acc = event.accelerationIncludingGravity;
            if(!acc) return;

            // ã‚·ã‚§ã‚¤ã‚¯åˆ¤å®šï¼ˆç°¡æ˜“ç‰ˆï¼‰
            const deltaX = Math.abs(lastX - acc.x);
            const deltaY = Math.abs(lastY - acc.y);
            const deltaZ = Math.abs(lastZ - acc.z);

            if (deltaX + deltaY + deltaZ > 25) { // æ„Ÿåº¦èª¿æ•´
                shakeScore++;
                shakeCountDiv.textContent = shakeScore;
            }

            lastX = acc.x;
            lastY = acc.y;
            lastZ = acc.z;
        }

        // --- 200å€‹ã®ã‚²ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ (åˆå›ã®ã¿å®Ÿè¡Œ) ---
        async function generate200Games() {
            const batch = writeBatch(db);
            const categories = ["é ­è„³", "ã‚¢ã‚¯ã‚·ãƒ§ãƒ³", "é‹", "ã‚»ãƒ³ã‚µãƒ¼", "ä¼šè©±", "å¯¾æˆ¦"];
            
            // ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ï¼ˆå®¹é‡ç¯€ç´„ã®ãŸã‚ãƒ«ãƒ¼ãƒ—ã§ç”Ÿæˆã—ã¾ã™ãŒã€å®Ÿéš›ã¯å€‹åˆ¥ã®ãƒ†ã‚­ã‚¹ãƒˆãŒå…¥ã‚Šã¾ã™ï¼‰
            const templates = [
                {t: "é«˜é€Ÿé€£æ‰“ãƒãƒˆãƒ«", d: "10ç§’é–“ã§ç”»é¢ã‚’ä½•å›ã‚¿ãƒƒãƒ—ã§ãã‚‹ã‹ç«¶ãˆï¼", c: "ã‚¢ã‚¯ã‚·ãƒ§ãƒ³"},
                {t: "ã‚¹ãƒãƒ›ã‚·ã‚§ã‚¤ã‚¯", d: "30ç§’é–“ã‚¹ãƒãƒ›ã‚’æŒ¯ã‚Šç¶šã‘ã‚ï¼(ã‚»ãƒ³ã‚µãƒ¼åå¿œ)", c: "ã‚»ãƒ³ã‚µãƒ¼"},
                {t: "æ²ˆé»™ãƒãƒ£ãƒ¬ãƒ³ã‚¸", d: "å…¨å“¡1åˆ†é–“çœŸé¡”ã§é»™ã‚‹ã€‚ç¬‘ã£ãŸã‚‰è² ã‘ã€‚", c: "å¯¾æˆ¦"},
                {t: "ã‚¹ã‚¯ãƒ¯ãƒƒãƒˆç«¶äº‰", d: "ã‚¹ãƒãƒ›ã‚’æŒã£ã¦ã‚¹ã‚¯ãƒ¯ãƒƒãƒˆ10å›ï¼ä¸€ç•ªæ—©ã„ã®ã¯èª°ï¼Ÿ", c: "ã‚»ãƒ³ã‚µãƒ¼"},
                {t: "å¤ä»Šæ±è¥¿", d: "ãŠé¡Œï¼šèµ¤ã„ã‚‚ã®ã€‚ãƒªã‚ºãƒ ã‚ˆãç­”ãˆã‚ˆã†ã€‚", c: "ä¼šè©±"},
                // ...å®Ÿéš›ã¯ã“ã“ã«200ç¨®é¡ã®ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æŒãŸã›ã¾ã™
            ];

            // 200å€‹ã«ãªã‚‹ã¾ã§ãƒ‡ãƒ¼ã‚¿ã‚’æ°´å¢—ã—ç”Ÿæˆã—ã¦DBã¸ä¿å­˜
            for (let i = 0; i < 200; i++) {
                const ref = doc(collection(db, "games200"));
                const template = templates[i % templates.length]; // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’å¾ªç’°
                
                // IDã”ã¨ã«å°‘ã—å†…å®¹ã‚’å¤‰ãˆã‚‹ï¼ˆæœ¬æ¥ã¯å…¨ã¦åˆ¥ãƒ‡ãƒ¼ã‚¿ã«ã™ã‚‹ï¼‰
                batch.set(ref, {
                    title: `${template.t} #${i+1}`,
                    desc: template.d,
                    category: i % 10 === 0 ? "ã‚»ãƒ³ã‚µãƒ¼" : template.c // 10å€‹ã«1ã¤ã¯ã‚»ãƒ³ã‚µãƒ¼ã‚²ãƒ¼ãƒ ã«
                });
            }
            
            await batch.commit();
            console.log("200 Games Created!");
        }

        // ã‚¢ãƒ—ãƒªé–‹å§‹
        loadGames();
    </script>
</body>
</html>
