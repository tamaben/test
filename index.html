<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NEON SHAKE BATTLE</title>
    <!-- QR„Ç≥„Éº„ÉâÁîüÊàê„É©„Ç§„Éñ„É©„É™ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <!-- „Éï„Ç©„É≥„Éà -->
    <link href="https://fonts.googleapis.com/css2?family=Black+Ops+One&family=M+PLUS+Rounded+1c:wght@700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #00ffcc;
            --secondary: #ff00ff;
            --bg: #050505;
        }

        body {
            font-family: 'M PLUS Rounded 1c', sans-serif;
            margin: 0;
            background: var(--bg);
            color: white;
            overflow: hidden;
            touch-action: none;
            user-select: none;
        }

        .hidden { display: none !important; }
        .full-screen {
            position: absolute; top: 0; left: 0;
            width: 100vw; height: 100vh;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
        }

        .btn {
            background: linear-gradient(45deg, var(--secondary), #ff4444);
            border: none; color: white;
            padding: 15px 40px; font-size: 1.5rem;
            border-radius: 50px; cursor: pointer;
            font-family: 'Black Ops One', cursive;
            text-transform: uppercase;
            box-shadow: 0 0 15px var(--secondary);
            margin-top: 20px;
        }
        .btn:active { transform: scale(0.95); }

        /* HOST DESIGN */
        #host-view { background: radial-gradient(circle at center, #1a1a1a, #000); }
        h1 {
            font-family: 'Black Ops One'; font-size: 4rem; margin: 0;
            background: linear-gradient(to right, var(--primary), var(--secondary));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            text-shadow: 0 0 20px rgba(0,255,204,0.5);
            text-align: center;
        }
        #timer { font-size: 6rem; font-family: 'Black Ops One'; color: #fff; margin: 10px 0; }
        
        #arena {
            display: flex; align-items: flex-end; justify-content: center;
            width: 95%; height: 50vh; gap: 15px;
            border-bottom: 4px solid #333; padding-bottom: 10px;
        }
        .player-col {
            width: 80px; height: 100%; position: relative;
            display: flex; flex-direction: column; align-items: center; justify-content: flex-end;
        }
        .bar-fill {
            width: 100%; background: var(--primary);
            border-radius: 5px 5px 0 0; transition: height 0.1s linear;
            box-shadow: 0 0 15px var(--primary);
        }
        .p-score { font-family: 'Black Ops One'; font-size: 1.5rem; position: absolute; top: -30px; width: 100%; text-align: center; }
        .p-name { margin-top: 10px; font-size: 0.8rem; text-align: center; overflow: hidden; white-space: nowrap; width: 100%; }

        /* CLIENT DESIGN */
        #client-view { background: linear-gradient(135deg, #111 0%, #222 100%); }
        input[type="text"] {
            background: transparent; border: none; border-bottom: 2px solid var(--primary);
            color: white; font-size: 2rem; text-align: center; width: 80%; padding: 10px; outline: none;
        }
        #shake-circle {
            width: 250px; height: 250px; border-radius: 50%;
            background: radial-gradient(circle, #ff4444, #990000);
            border: 8px solid rgba(255,255,255,0.2);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            box-shadow: 0 0 30px #ff0000;
        }
        .shake-active { transform: scale(0.95); filter: brightness(1.2); }
        #my-score { font-size: 4rem; font-family: 'Black Ops One'; margin: 0; }
    </style>
</head>
<body>

    <!-- HOST (PC) -->
    <div id="host-view" class="full-screen hidden">
        <div style="position:absolute; top:20px; width:100%; text-align:center;">
            <h1>NEON SHAKE</h1>
            <div id="timer">10</div>
        </div>

        <div id="arena">
            <div id="waiting-msg" style="color: #666; font-size: 1.5rem; align-self: center;">
                ÂèÇÂä†ËÄÖ„ÇíÂæÖ„Å£„Å¶„ÅÑ„Åæ„Åô...
            </div>
        </div>

        <div id="lobby-ui" style="position:absolute; bottom:30px; text-align:center; background:rgba(0,0,0,0.8); padding:20px; border-radius:20px;">
            <div id="qrcode" style="background:white; padding:10px; border-radius:10px; display:inline-block;"></div>
            <p id="room-display" style="color:#aaa; margin:10px 0;">Room: ---</p>
            <button class="btn" onclick="window.hostStartGame()">BATTLE START</button>
        </div>
    </div>

    <!-- CLIENT (Smartphone) -->
    <div id="client-view" class="full-screen hidden">
        <!-- ÂêçÂâçÂÖ•Âäõ -->
        <div id="step-name" class="full-screen">
            <h2>ENTER NAME</h2>
            <input type="text" id="username" placeholder="ÂêçÂâç„ÇíÂÖ•Âäõ" maxlength="6">
            <button class="btn" onclick="window.submitName()">JOIN</button>
        </div>

        <!-- „Çª„É≥„Çµ„ÉºË®±ÂèØ (iOSÁî®) -->
        <div id="step-perm" class="full-screen hidden" style="background:rgba(0,0,0,0.9); z-index:999;">
            <p>„Çª„É≥„Çµ„ÉºË®±ÂèØ„ÅåÂøÖË¶Å„Åß„Åô</p>
            <button class="btn" onclick="window.requestSensor()">OK</button>
        </div>

        <!-- „Ç≤„Éº„É†ÁîªÈù¢ -->
        <div id="step-game" class="full-screen hidden">
            <div id="status-text" style="font-size:1.5rem; margin-bottom:20px; color:#aaa;">ÂæÖÊ©ü‰∏≠...</div>
            <div id="shake-circle">
                <div id="my-score">0</div>
                <div style="font-weight:bold;">SHAKE!</div>
            </div>
        </div>
    </div>

    <script type="module">
        // ---------------------------------------------------------
        // ÈáçË¶Å: ‰ª•‰∏ã„ÅÆË®≠ÂÆö„Çí„ÅîËá™Ë∫´„ÅÆFirebase„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅÆ„ÇÇ„ÅÆ„Å´Êõ∏„ÅçÊèõ„Åà„Å¶„Åè„Å†„Åï„ÅÑ
        // ---------------------------------------------------------
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
        import { getDatabase, ref, set, onValue, update, remove, onDisconnect } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT.firebaseapp.com",
            databaseURL: "https://YOUR_PROJECT-default-rtdb.asia-southeast1.firebasedatabase.app", // URL„ÇíÊ≠£Á¢∫„Å´
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abcdef"
        };

        // „Ç¢„Éó„É™ÂàùÊúüÂåñÔºà„Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞‰ªò„ÅçÔºâ
        let app, db;
        try {
            app = initializeApp(firebaseConfig);
            db = getDatabase(app);
            console.log("Firebase initialized");
        } catch (e) {
            alert("FirebaseË®≠ÂÆö„Ç®„É©„Éº: Config„ÇíÊ≠£„Åó„ÅèË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ");
            console.error(e);
        }

        // URL„Éë„É©„É°„Éº„ÇøÂèñÂæó
        const params = new URLSearchParams(window.location.search);
        let role = params.get('role');
        let roomId = params.get('room');
        const myId = Math.random().toString(36).substring(2, 8);

        // ÈÖçËâ≤
        const COLORS = ['#FF0055', '#00FFCC', '#CCFF00', '#0099FF', '#FFAA00', '#AA00FF'];

        // =========================================
        // ÂàùÊúüÂàÜÂ≤ê„É≠„Ç∏„ÉÉ„ÇØ
        // =========================================
        if (!role) {
            // „Éë„É©„É°„Éº„Çø„Å™„Åó ‚Üí „Éõ„Çπ„Éà„Å®„Åó„Å¶ÈÉ®Â±ã‰ΩúÊàê
            roomId = Math.random().toString(36).substring(2, 6).toUpperCase();
            window.location.replace(`?role=host&room=${roomId}`);
        } 
        else if (role === 'host') {
            initHost();
        } 
        else if (role === 'player') {
            initPlayer();
        }

        // =========================================
        // HOST (PC) LOGIC
        // =========================================
        function initHost() {
            document.getElementById('host-view').classList.remove('hidden');
            document.getElementById('room-display').innerText = `Room ID: ${roomId}`;

            // QRÁîüÊàê
            const url = `${window.location.origin}${window.location.pathname}?role=player&room=${roomId}`;
            new QRCode(document.getElementById("qrcode"), { text: url, width: 128, height: 128 });

            const roomRef = ref(db, `shake/${roomId}`);

            // Áõ£Ë¶ñ
            onValue(roomRef, (snap) => {
                const data = snap.val() || {};
                renderArena(data.players || {});
            });

            // ÁîªÈù¢ÊèèÁîª
            function renderArena(players) {
                const arena = document.getElementById('arena');
                const pIds = Object.keys(players);
                
                // ÂæÖÊ©ü„É°„ÉÉ„Çª„Éº„Ç∏Âà∂Âæ°
                const msg = document.getElementById('waiting-msg');
                if (pIds.length > 0) { if(msg) msg.remove(); }
                else if (!msg) {
                    arena.innerHTML = '<div id="waiting-msg" style="color: #666; font-size: 1.5rem; align-self: center;">ÂèÇÂä†ËÄÖ„ÇíÂæÖ„Å£„Å¶„ÅÑ„Åæ„Åô...</div>';
                    return;
                }

                // ÂâäÈô§Âá¶ÁêÜ
                Array.from(arena.children).forEach(el => {
                    if (el.id !== 'waiting-msg' && !pIds.includes(el.id.replace('p-', ''))) el.remove();
                });

                // Êõ¥Êñ∞Âá¶ÁêÜ
                let idx = 0;
                pIds.forEach(id => {
                    const p = players[id];
                    let el = document.getElementById(`p-${id}`);
                    const color = COLORS[idx % COLORS.length];

                    if (!el) {
                        el = document.createElement('div');
                        el.id = `p-${id}`;
                        el.className = 'player-col';
                        el.innerHTML = `
                            <div class="p-score" style="color:${color}">0</div>
                            <div class="bar-fill" style="height:0%; background:${color}; box-shadow:0 0 15px ${color}"></div>
                            <div class="p-name" style="color:${color}">${p.name}</div>
                        `;
                        arena.appendChild(el);
                    }

                    // ÂÄ§ÂèçÊò†
                    const score = p.count || 0;
                    const h = Math.min(score * 1.5, 100); // 100%Ë™øÊï¥
                    el.querySelector('.p-score').innerText = score;
                    el.querySelector('.bar-fill').style.height = `${h}%`;
                    
                    // ÂãùËÄÖ„Ç®„Éï„Çß„ÇØ„Éà
                    if (p.isWinner) {
                        el.querySelector('.p-score').innerText = "üëë " + score;
                    }
                    idx++;
                });
            }

            // „Ç∞„É≠„Éº„Éê„É´Èñ¢Êï∞„Å®„Åó„Å¶ÁôªÈå≤ÔºàHTML„Åã„ÇâÂëº„Å∂„Åü„ÇÅÔºâ
            window.hostStartGame = () => {
                if (Object.keys(document.querySelectorAll('.player-col')).length === 0) {
                    return alert("„Éó„É¨„Ç§„É§„Éº„Åå„ÅÑ„Åæ„Åõ„Çì");
                }
                
                document.getElementById('lobby-ui').classList.add('hidden');
                
                // „É™„Çª„ÉÉ„Éà
                update(roomRef, { 'state/status': 'ready' });
                // „Éó„É¨„Ç§„É§„Éº„Çπ„Ç≥„Ç¢„É™„Çª„ÉÉ„Éà„ÅØÂÄãÂà•„Å´Ë°å„ÅÜ„ÅÆ„ÅåÁ¢∫ÂÆü
                getDatabase(app); 
                onValue(ref(db, `shake/${roomId}/players`), (snap) => {
                    const ps = snap.val();
                    if(ps) {
                        const updates = {};
                        Object.keys(ps).forEach(pid => {
                            updates[`players/${pid}/count`] = 0;
                            updates[`players/${pid}/isWinner`] = false;
                        });
                        update(roomRef, updates);
                    }
                }, { onlyOnce: true });

                // „Ç´„Ç¶„É≥„Éà„ÉÄ„Ç¶„É≥
                let count = 3;
                const tm = document.getElementById('timer');
                tm.innerText = "READY";
                
                const cdInt = setInterval(() => {
                    tm.innerText = count;
                    if (count <= 0) {
                        clearInterval(cdInt);
                        tm.innerText = "GO!!";
                        runGame();
                    }
                    count--;
                }, 1000);
            };

            function runGame() {
                update(roomRef, { 'state/status': 'running' });
                let timeLeft = 10;
                const tm = document.getElementById('timer');

                const gInt = setInterval(() => {
                    timeLeft--;
                    tm.innerText = timeLeft;
                    if (timeLeft <= 0) {
                        clearInterval(gInt);
                        finishGame();
                    }
                }, 1000);
            }

            function finishGame() {
                update(roomRef, { 'state/status': 'finished' });
                document.getElementById('timer').innerText = "FINISH";
                
                // ÁµêÊûúÂà§ÂÆö
                onValue(ref(db, `shake/${roomId}/players`), (snap) => {
                    const ps = snap.val();
                    if(!ps) return;
                    
                    let max = -1;
                    let winner = null;
                    Object.keys(ps).forEach(pid => {
                        if (ps[pid].count > max) { max = ps[pid].count; winner = pid; }
                    });
                    
                    if (winner) update(ref(db, `shake/${roomId}/players/${winner}`), { isWinner: true });

                    setTimeout(() => {
                        document.getElementById('lobby-ui').classList.remove('hidden');
                    }, 5000);
                }, { onlyOnce: true });
            }
        }

        // =========================================
        // PLAYER (Mobile) LOGIC
        // =========================================
        function initPlayer() {
            document.getElementById('client-view').classList.remove('hidden');
            let myName = "";
            let count = 0;
            let canShake = false;

            const pRef = ref(db, `shake/${roomId}/players/${myId}`);
            const sRef = ref(db, `shake/${roomId}/state`);

            // „Ç∞„É≠„Éº„Éê„É´Èñ¢Êï∞ÂÆöÁæ©
            window.submitName = () => {
                const name = document.getElementById('username').value;
                if (!name) return alert("ÂêçÂâç„ÇíÂÖ•„Çå„Å¶„Åè„Å†„Åï„ÅÑ");
                myName = name;
                document.getElementById('step-name').classList.add('hidden');
                
                // iOS„Å™„ÇâË®±ÂèØÁîªÈù¢„Å∏„ÄÅ„Åù„ÅÆ‰ªñ„Å™„ÇâÂèÇÂä†
                if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
                    document.getElementById('step-perm').classList.remove('hidden');
                } else {
                    joinGame();
                }
            };

            window.requestSensor = async () => {
                try {
                    const res = await DeviceMotionEvent.requestPermission();
                    if (res === 'granted') {
                        document.getElementById('step-perm').classList.add('hidden');
                        joinGame();
                    } else {
                        alert("Ë®±ÂèØ„Åï„Çå„Åæ„Åõ„Çì„Åß„Åó„Åü");
                    }
                } catch(e) {
                    // PC„Éá„Éê„ÉÉ„Ç∞Á≠â„ÅÆ„Åü„ÇÅ
                    document.getElementById('step-perm').classList.add('hidden');
                    joinGame();
                }
            };

            function joinGame() {
                document.getElementById('step-game').classList.remove('hidden');
                
                set(pRef, { name: myName, count: 0 });
                onDisconnect(pRef).remove();

                onValue(sRef, (snap) => {
                    const state = snap.val() || {};
                    const stTxt = document.getElementById('status-text');
                    const scEl = document.getElementById('my-score');

                    if (state.status === 'ready') {
                        stTxt.innerText = "„Åæ„ÇÇ„Å™„ÅèÈñãÂßãÔºÅ";
                        stTxt.style.color = "#ffeb3b";
                        count = 0; scEl.innerText = 0;
                        canShake = false;
                    } 
                    else if (state.status === 'running') {
                        stTxt.innerText = "ÊåØ„Çå„Åá„Åá„ÅáÔºÅÔºÅÔºÅ";
                        stTxt.style.color = "#ff4444";
                        canShake = true;
                        if(navigator.vibrate) navigator.vibrate(200);
                    } 
                    else if (state.status === 'finished') {
                        stTxt.innerText = "ÁµÇ‰∫ÜÔºÅÁîªÈù¢„ÇíË¶ã„Çç";
                        stTxt.style.color = "#fff";
                        canShake = false;
                    } 
                    else {
                        stTxt.innerText = "„Éõ„Çπ„Éà„ÅÆÈñãÂßãÂæÖ„Å°...";
                        stTxt.style.color = "#aaa";
                    }
                });

                startMotion();
            }

            function startMotion() {
                let lastX=0, lastY=0, lastZ=0;
                let lastSend = 0;
                
                window.addEventListener('devicemotion', (e) => {
                    if (!canShake) return;
                    
                    const acc = e.accelerationIncludingGravity || e.acceleration;
                    if(!acc) return;

                    const delta = Math.abs(acc.x - lastX) + Math.abs(acc.y - lastY) + Math.abs(acc.z - lastZ);
                    
                    if (delta > 15) { // ÊÑüÂ∫¶
                        count++;
                        document.getElementById('my-score').innerText = count;
                        
                        // „Ç®„Éï„Çß„ÇØ„Éà
                        const c = document.getElementById('shake-circle');
                        c.classList.add('shake-active');
                        setTimeout(()=>c.classList.remove('shake-active'), 50);

                        // ÈÄö‰ø°ÈñìÂºï„Åç (100ms„Åî„Å®)
                        const now = Date.now();
                        if (now - lastSend > 100) {
                            update(pRef, { count: count });
                            lastSend = now;
                        }
                    }
                    lastX = acc.x; lastY = acc.y; lastZ = acc.z;
                });
            }
        }
    </script>
</body>
</html>
