<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ë∂Ö„Éï„É™„Éï„É™Â§ß‰ºö - NEON SHAKE BATTLE</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Black+Ops+One&family=Noto+Sans+JP:wght@900&display=swap');

        :root {
            --primary: #00ffcc;
            --secondary: #ff00ff;
            --accent: #ffff00;
            --bg: #050505;
        }

        body { font-family: 'Noto Sans JP', sans-serif; margin: 0; background: var(--bg); color: white; overflow: hidden; touch-action: none; }
        .hidden { display: none !important; }
        .full-screen { position: absolute; top:0; left:0; width: 100vw; height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        
        /* --- HOST DESIGN --- */
        #host-view { background: radial-gradient(circle at center, #1a1a1a, #000); }
        h1 { font-family: 'Black Ops One', cursive; font-size: 60px; color: var(--primary); text-shadow: 0 0 20px var(--primary); margin: 0; }
        .high-score-banner { background: rgba(255, 255, 0, 0.1); border: 2px solid var(--accent); padding: 5px 20px; border-radius: 10px; color: var(--accent); font-size: 20px; margin-bottom: 20px; }

        #meter-container { display: flex; align-items: flex-end; justify-content: center; width: 95%; height: 45vh; margin-top: 40px; gap: 20px; border-bottom: 4px solid #333; padding-bottom: 10px; }
        .player-column { display: flex; flex-direction: column; align-items: center; justify-content: flex-end; width: 110px; height: 100%; transition: all 0.3s; position: relative; }
        .bar { width: 100%; border-radius: 10px 10px 0 0; transition: height 0.3s ease-out; position: relative; box-shadow: 0 0 20px rgba(0, 255, 204, 0.4); }
        .p-name { margin-top: 15px; font-weight: 900; font-size: 18px; text-align: center; color: #fff; width: 100%; }
        .p-score { font-family: 'Black Ops One'; font-size: 32px; position: absolute; top: -45px; color: var(--primary); }
        
        /* ‰ºè„ÅõÂ≠ó„Çπ„Çø„Ç§„É´ */
        .score-hidden { color: #444 !important; text-shadow: none !important; }

        #timer { font-size: 120px; font-family: 'Black Ops One'; position: absolute; top: 20px; right: 50px; color: #fff; text-shadow: 0 0 30px var(--secondary); }
        #game-msg { font-size: 80px; font-family: 'Black Ops One'; position: absolute; top: 40%; width: 100%; text-align: center; pointer-events: none; z-index: 10; color: var(--secondary); text-shadow: 0 0 30px #000; }

        .config-panel { background: rgba(255,255,255,0.05); padding: 20px; border-radius: 20px; margin-bottom: 20px; border: 1px solid #333; }
        .btn { padding: 15px 50px; font-size: 28px; background: var(--secondary); border: none; color: white; cursor: pointer; border-radius: 50px; font-weight: bold; font-family: 'Black Ops One'; box-shadow: 0 0 25px var(--secondary); transition: 0.2s; }
        .btn:hover { transform: scale(1.05); filter: brightness(1.2); }
        .btn:disabled { background: #444; box-shadow: none; opacity: 0.5; cursor: not-allowed; }

        input[type="number"] { background: #000; border: 2px solid var(--primary); color: var(--primary); font-size: 24px; padding: 10px; width: 80px; text-align: center; border-radius: 10px; font-family: 'Black Ops One'; }

        /* --- CONTROLLER DESIGN --- */
        #ctrl-view { background: #0a0a0a; }
        #shake-circle { width: 280px; height: 280px; border-radius: 50%; background: radial-gradient(circle, #ff00ff, #550055); border: 15px solid rgba(255,255,255,0.1); display: flex; flex-direction: column; align-items: center; justify-content: center; box-shadow: 0 0 60px var(--secondary); margin-bottom: 30px; transition: transform 0.05s; }
        .shaking-animation { animation: shake-anim 0.1s infinite; }
        @keyframes shake-anim { 0% { transform: translate(0,0); } 50% { transform: translate(5px, 5px); } 100% { transform: translate(0,0); } }
        #ctrl-score { font-size: 90px; font-family: 'Black Ops One'; }
        
        input[type="text"] { background: #222; border: 2px solid var(--primary); color: white; padding: 20px; font-size: 24px; border-radius: 15px; text-align: center; margin-bottom: 20px; width: 80%; outline: none; }
    </style>
</head>
<body>

    <!-- „Éõ„Çπ„ÉàË°®Á§∫ -->
    <div id="host-view" class="full-screen hidden">
        <div class="high-score-banner">
            üèÜ WORLD RECORD: <span id="world-record-val">0</span> (<span id="world-record-holder">---</span>)
        </div>
        <h1>SUPER SHAKE BATTLE</h1>
        <div id="timer">--</div>
        <div id="game-msg"></div>

        <div id="meter-container">
            <div id="waiting-msg" style="color: #666; font-size: 30px;">WAITING FOR CHALLENGERS...</div>
        </div>

        <div id="lobby-ui" style="text-align: center; margin-top:30px;">
            <div class="config-panel">
                <span style="font-size: 20px; margin-right: 15px;">TIME:</span>
                <input type="number" id="game-duration" value="15" min="5" max="60">
                <span style="font-size: 20px; margin-left: 10px;">SEC</span>
            </div>
            <div id="qrcode" style="background: white; padding: 15px; display: inline-block; border-radius: 10px; margin-bottom: 20px;"></div>
            <br>
            <button id="start-btn" class="btn" onclick="window.hostStartGame()" disabled>START TOURNAMENT</button>
        </div>
    </div>

    <!-- „Ç≥„É≥„Éà„É≠„Éº„É©„ÉºË°®Á§∫ -->
    <div id="ctrl-view" class="full-screen hidden">
        <div id="name-step" class="full-screen">
            <h2 style="color: var(--primary); font-size: 32px;">ENTER YOUR NAME</h2>
            <input type="text" id="user-name" placeholder="PLAYER NAME" maxlength="10">
            <button class="btn" onclick="window.submitName()">ENTRY</button>
        </div>

        <div id="perm-step" class="full-screen hidden">
            <h2 style="color: var(--secondary)">SENSOR PERMISSION</h2>
            <p style="text-align:center; padding:30px; font-size: 18px;">„Çπ„Éû„Éõ„ÇíÊåØ„ÇãÂãï„Åç„ÇíÊ§úÁü•„Åô„Çã„Åü„ÇÅ„Å´<br>„Çª„É≥„Çµ„Éº„ÅÆ‰ΩøÁî®„ÇíË®±ÂèØ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>
            <button class="btn" onclick="window.requestPermission()">ALLOW</button>
        </div>

        <div id="game-step" class="full-screen hidden">
            <div id="ctrl-msg" style="margin-bottom:20px; font-size: 24px; color: var(--primary); font-weight: bold;">WAITING...</div>
            <div id="shake-circle">
                <div id="ctrl-score">0</div>
                <div style="font-weight:bold; letter-spacing: 2px;">SHAKES</div>
            </div>
            <div id="ctrl-status-sub" style="color: #666;">Á´∂ÊäÄ„ÅåÂßã„Åæ„Çã„Å®„Ç´„Ç¶„É≥„Éà„Åï„Çå„Åæ„Åô</div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
        import { getDatabase, ref, set, onValue, update, onDisconnect, runTransaction } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

        // FirebaseË®≠ÂÆö
        const firebaseConfig = {
            apiKey: "AIzaSyDbZzTMvUkG2LXIGY4ux0KBTmnAdqP236s",
            authDomain: "game-4f2d9.firebaseapp.com",
            databaseURL: "https://game-4f2d9-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "game-4f2d9",
            storageBucket: "game-4f2d9.firebasestorage.app",
            messagingSenderId: "574316347824",
            appId: "1:574316347824:web:cf686040628e25ad615675"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const params = new URLSearchParams(window.location.search);
        let role = params.get('role') || 'host';
        let roomId = params.get('room');
        const myId = Math.random().toString(36).substr(2, 5).toUpperCase();
        const COLORS = ['#00ffcc', '#ff00ff', '#ffff00', '#0077ff', '#ff3300', '#00ff00', '#ff9900'];

        // ============================================
        // HOST LOGIC
        // ============================================
        if (role === 'host') {
            if (!roomId) {
                roomId = Math.random().toString(36).substring(2, 6).toUpperCase();
                window.location.replace(`?role=host&room=${roomId}`);
            }

            document.getElementById('host-view').classList.remove('hidden');
            
            // QR„Ç≥„Éº„ÉâÁîüÊàê
            new QRCode(document.getElementById("qrcode"), {
                text: `${window.location.origin}${window.location.pathname}?role=ctrl&room=${roomId}`,
                width: 160, height: 160
            });

            // Ê≠¥‰ª£ÊúÄÈ´òË®òÈå≤„ÅÆÂèñÂæó
            onValue(ref(db, `shake_global/best`), (snap) => {
                const best = snap.val() || { score: 0, name: "None" };
                document.getElementById('world-record-val').innerText = best.score;
                document.getElementById('world-record-holder').innerText = best.name;
            });

            // „Éó„É¨„Ç§„É§„ÉºÂèÇÂä†Áõ£Ë¶ñ
            onValue(ref(db, `shake/${roomId}/players`), (snap) => {
                const players = snap.val() || {};
                const stateSnap = ref(db, `shake/${roomId}/state`);
                
                onValue(stateSnap, (s) => {
                    const status = (s.val() && s.val().status) || 'lobby';
                    renderArena(players, status);
                }, { onlyOnce: true });

                document.getElementById('start-btn').disabled = (Object.keys(players).length === 0);
            });

            function renderArena(players, status) {
                const container = document.getElementById('meter-container');
                const pIds = Object.keys(players);

                if (pIds.length === 0) {
                    container.innerHTML = '<div id="waiting-msg" style="color: #666; font-size: 30px;">WAITING FOR CHALLENGERS...</div>';
                    return;
                } else {
                    const msg = document.getElementById('waiting-msg');
                    if (msg) msg.remove();
                }

                pIds.forEach((id, index) => {
                    let el = document.getElementById(`p-${id}`);
                    const p = players[id];
                    const color = COLORS[index % COLORS.length];

                    if (!el) {
                        el = document.createElement('div');
                        el.id = `p-${id}`;
                        el.className = 'player-column';
                        el.innerHTML = `
                            <div class="p-score">0</div>
                            <div class="bar"></div>
                            <div class="p-name">${p.name}</div>
                        `;
                        container.appendChild(el);
                    }

                    const scoreEl = el.querySelector('.p-score');
                    const barEl = el.querySelector('.bar');
                    
                    // Á´∂ÊäÄ‰∏≠„ÅØ„ÄåÔºüÔºüÔºü„Äç„Å´„Åô„Çã
                    if (status === 'running') {
                        scoreEl.innerText = "???";
                        scoreEl.classList.add('score-hidden');
                        barEl.style.height = `20%`; // Âãï„ÅÑ„Å¶„ÅÑ„ÇãÊÑü„Å†„ÅëÂá∫„Åô
                    } else {
                        scoreEl.innerText = p.count || 0;
                        scoreEl.classList.remove('score-hidden');
                        barEl.style.height = `${Math.min((p.count || 0) * 0.8, 100)}%`;
                    }
                    
                    barEl.style.backgroundColor = color;
                    el.querySelector('.p-name').style.color = color;
                });
            }

            window.hostStartGame = () => {
                const duration = parseInt(document.getElementById('game-duration').value) || 15;
                const roomRef = ref(db, `shake/${roomId}`);
                
                // „Çπ„Ç≥„Ç¢„É™„Çª„ÉÉ„Éà
                onValue(ref(db, `shake/${roomId}/players`), (snap) => {
                    const players = snap.val();
                    const updates = {};
                    Object.keys(players).forEach(id => updates[`players/${id}/count`] = 0);
                    update(roomRef, updates);
                }, { onlyOnce: true });

                update(roomRef, { 'state/status': 'ready', 'state/duration': duration });
                document.getElementById('lobby-ui').classList.add('hidden');

                let count = 3;
                const msgEl = document.getElementById('game-msg');
                const cd = setInterval(() => {
                    msgEl.innerText = count > 0 ? count : "SHAKE!!";
                    if (count === 0) {
                        clearInterval(cd);
                        setTimeout(() => msgEl.innerText = "", 1000);
                        runTimer(duration);
                    }
                    count--;
                }, 1000);
            };

            function runTimer(sec) {
                update(ref(db, `shake/${roomId}/state`), { status: 'running' });
                let timeLeft = sec;
                const timerEl = document.getElementById('timer');
                timerEl.innerText = timeLeft;

                const timer = setInterval(() => {
                    timeLeft--;
                    timerEl.innerText = timeLeft;
                    if (timeLeft <= 0) {
                        clearInterval(timer);
                        finishGame();
                    }
                }, 1000);
            }

            function finishGame() {
                update(ref(db, `shake/${roomId}/state`), { status: 'finished' });
                document.getElementById('game-msg').innerText = "TIME UP!!";
                
                // ÁµêÊûúÈõÜË®à„Å®Ê≠¥‰ª£Ë®òÈå≤Êõ¥Êñ∞
                onValue(ref(db, `shake/${roomId}/players`), (snap) => {
                    const players = snap.val();
                    let topScore = -1;
                    let winnerName = "";

                    Object.keys(players).forEach(id => {
                        if (players[id].count > topScore) {
                            topScore = players[id].count;
                            winnerName = players[id].name;
                        }
                    });

                    // „Ç∞„É≠„Éº„Éê„É´„Éè„Ç§„Çπ„Ç≥„Ç¢„ÅÆÊõ¥Êñ∞
                    if (topScore > 0) {
                        const globalBestRef = ref(db, `shake_global/best`);
                        runTransaction(globalBestRef, (current) => {
                            if (current === null || topScore > current.score) {
                                return { score: topScore, name: winnerName };
                            }
                            return; // Êõ¥Êñ∞„Å™„Åó
                        });
                    }

                    setTimeout(() => {
                        document.getElementById('lobby-ui').classList.remove('hidden');
                        document.getElementById('game-msg').innerText = "";
                        document.getElementById('timer').innerText = "--";
                    }, 8000);
                }, { onlyOnce: true });
            }
        }

        // ============================================
        // CONTROLLER LOGIC
        // ============================================
        else {
            document.getElementById('ctrl-view').classList.remove('hidden');
            let myName = "";
            let myCount = 0;
            let currentStatus = 'lobby';

            window.submitName = () => {
                const input = document.getElementById('user-name');
                if (!input.value) return alert("ÂêçÂâç„ÇíÂÖ•„Çå„Å¶„Å≠ÔºÅ");
                myName = input.value;
                document.getElementById('name-step').classList.add('hidden');
                
                if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
                    document.getElementById('perm-step').classList.remove('hidden');
                } else {
                    joinGame();
                }
            };

            window.requestPermission = async () => {
                try {
                    const res = await DeviceMotionEvent.requestPermission();
                    if (res === 'granted') {
                        document.getElementById('perm-step').classList.add('hidden');
                        joinGame();
                    }
                } catch (e) { alert("„Çª„É≥„Çµ„Éº„ÇíË®±ÂèØ„Åó„Å¶„Åè„Å†„Åï„ÅÑ"); }
            };

            function joinGame() {
                document.getElementById('game-step').classList.remove('hidden');
                const pRef = ref(db, `shake/${roomId}/players/${myId}`);
                set(pRef, { name: myName, count: 0 });
                onDisconnect(pRef).remove();

                onValue(ref(db, `shake/${roomId}/state`), (snap) => {
                    const s = snap.val() || {};
                    currentStatus = s.status;
                    const msgEl = document.getElementById('ctrl-msg');
                    const circle = document.getElementById('shake-circle');

                    if (currentStatus === 'ready') {
                        myCount = 0;
                        document.getElementById('ctrl-score').innerText = "0";
                        msgEl.innerText = "READY...";
                        circle.classList.remove('shaking-animation');
                    } else if (currentStatus === 'running') {
                        msgEl.innerText = "SHAKE IT NOW!!";
                        circle.classList.add('shaking-animation');
                    } else if (currentStatus === 'finished') {
                        msgEl.innerText = "FINISH!!";
                        circle.classList.remove('shaking-animation');
                    } else {
                        msgEl.innerText = "ÂæÖÊ©ü‰∏≠...";
                    }
                });

                startSensor();
            }

            function startSensor() {
                let lastX=0, lastY=0, lastZ=0;
                let lastSend = 0;

                window.addEventListener('devicemotion', (e) => {
                    if (currentStatus !== 'running') return;

                    const acc = e.accelerationIncludingGravity || e.acceleration;
                    if (!acc) return;

                    // ÊåØ„Çä„ÅÆÂº∑„ÅïÂà§ÂÆö
                    const delta = Math.abs(acc.x - lastX) + Math.abs(acc.y - lastY) + Math.abs(acc.z - lastZ);
                    
                    if (delta > 25) { // ÊÑüÂ∫¶Ë™øÊï¥Ôºà25„ÅØÁµêÊßãÊøÄ„Åó„ÇÅÔºâ
                        myCount++;
                        document.getElementById('ctrl-score').innerText = myCount;

                        const now = Date.now();
                        // 0.1Áßí„Å´1Âõû„Å†„ÅëÈÄö‰ø°ÔºàË≤†Ëç∑ËªΩÊ∏õÔºâ
                        if (now - lastSend > 100) {
                            update(ref(db, `shake/${roomId}/players/${myId}`), { count: myCount });
                            lastSend = now;
                        }
                    }
                    lastX = acc.x; lastY = acc.y; lastZ = acc.z;
                });
            }
        }
    </script>
</body>
</html>
