<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ã¿ã‚“ãªã§ã‚¯ã‚¤ã‚ºRPG</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        /* å…±é€šã‚¹ã‚¿ã‚¤ãƒ« */
        :root {
            --primary: #6c5ce7;
            --secondary: #00cec9;
            --accent: #fd79a8;
            --bg: #2d3436;
            --text: #dfe6e9;
        }
        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 0;
            text-align: center;
            overflow: hidden; /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é˜²æ­¢ */
        }
        h1, h2 { margin: 10px 0; }
        .hidden { display: none !important; }
        
        /* ãƒœã‚¿ãƒ³ */
        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.2rem;
            border-radius: 10px;
            cursor: pointer;
            margin: 10px;
            transition: transform 0.1s;
        }
        .btn:active { transform: scale(0.95); }
        .btn-red { background: #d63031; }
        .btn-green { background: #00b894; }

        /* --- ãƒ›ã‚¹ãƒˆï¼ˆPCï¼‰ç”»é¢ã‚¹ã‚¿ã‚¤ãƒ« --- */
        #host-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
        }
        #lobby-info {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }
        #qrcode { margin: 20px auto; background: white; padding: 10px; }
        .player-list {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }
        .player-chip {
            background: var(--secondary);
            color: #2d3436;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        /* ã‚¯ã‚¤ã‚ºãƒ»ãƒœã‚¹ç”»é¢ */
        #game-stage { width: 80%; max-width: 800px; }
        .boss-container { position: relative; height: 200px; margin: 20px 0; }
        .boss-hp-bar {
            width: 100%; height: 30px; background: #555; border-radius: 15px; overflow: hidden;
            border: 2px solid white;
        }
        .boss-hp-fill {
            width: 100%; height: 100%; background: #d63031; transition: width 0.3s;
        }
        .boss-avatar { font-size: 5rem; animation: float 2s infinite ease-in-out; }
        .question-box {
            font-size: 1.5rem; background: white; color: #333; padding: 20px; border-radius: 10px;
            margin-bottom: 20px; font-weight: bold;
        }
        .timer-bar { width: 100%; height: 10px; background: var(--accent); margin-top: 10px; transition: width 1s linear; }

        /* --- ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼ˆã‚¹ãƒãƒ›ï¼‰ç”»é¢ã‚¹ã‚¿ã‚¤ãƒ« --- */
        #client-screen { height: 100vh; display: flex; flex-direction: column; }
        .controller-area {
            flex: 1; display: grid; grid-template-columns: 1fr 1fr; grid-gap: 10px; padding: 10px;
        }
        .choice-btn {
            background: #444; color: white; border: none; border-radius: 10px;
            font-size: 2rem; font-weight: bold;
        }
        .choice-btn:active { background: #666; }
        .choice-A { background-color: #ff7675; }
        .choice-B { background-color: #74b9ff; }
        .choice-C { background-color: #55efc4; color: #333; }
        .choice-D { background-color: #ffeaa7; color: #333; }
        
        .mash-btn {
            grid-column: span 2; background: #e17055; font-size: 3rem;
            animation: pulse 0.5s infinite;
        }

        /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes popIn { from { transform: scale(0); } to { transform: scale(1); } }
        @keyframes float { 0%,100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        @keyframes shake { 0% { transform: translate(1px, 1px) rotate(0deg); } 100% { transform: translate(-1px, -2px) rotate(-1deg); } }
        .shake { animation: shake 0.5s; animation-iteration-count: infinite; }
    </style>
</head>
<body>

    <div id="start-screen">
        <h1>ğŸ® ã‚¯ã‚¤ã‚ºï¼†ãƒãƒˆãƒ« RPG</h1>
        <p>PCã¯ã€Œè¦ªæ©Ÿã€ã€ã‚¹ãƒãƒ›ã¯ã€Œå­æ©Ÿã€ã‚’é¸ã‚“ã§ãã ã•ã„</p>
        <button class="btn" onclick="initHost()">ğŸ’» è¦ªæ©Ÿã¨ã—ã¦ã‚¹ã‚¿ãƒ¼ãƒˆ (Host)</button>
        <div style="margin-top: 20px; font-size: 0.9rem; color: #aaa;">
            â€»ã‚¹ãƒãƒ›ã¯PCã®ç”»é¢ã®QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã‚‹ã¨è‡ªå‹•æ¥ç¶šã—ã¾ã™
        </div>
    </div>

    <div id="host-screen" class="hidden">
        <div id="host-lobby">
            <h2>å‚åŠ è€…ã‚’å¾…ã£ã¦ã„ã¾ã™...</h2>
            <div id="qrcode"></div>
            <p>ã‚¹ãƒãƒ›ã§èª­ã¿å–ã£ã¦ãã ã•ã„</p>
            <div id="player-list" class="player-list"></div>
            <br>
            <h3>ã‚²ãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰é¸æŠ</h3>
            <button class="btn btn-green" onclick="startGame('coop')">ğŸ¤ å”åŠ›ãƒœã‚¹è¨ä¼</button>
            <button class="btn btn-red" onclick="startGame('battle')">âš”ï¸ æ—©æŠ¼ã—ãƒãƒˆãƒ«</button>
        </div>

        <div id="game-stage" class="hidden">
            <div id="boss-area" class="boss-container">
                <div class="boss-hp-bar"><div id="boss-hp" class="boss-hp-fill"></div></div>
                <div id="boss-avatar" class="boss-avatar">ğŸ‘¾</div>
                <div id="damage-display"></div>
            </div>

            <div id="quiz-area">
                <div class="question-box" id="question-text">ã“ã“ã«å•é¡ŒãŒè¡¨ç¤ºã•ã‚Œã¾ã™</div>
                <div id="timer-display" style="font-size: 2rem;">10</div>
            </div>

            <div id="result-message" style="font-size: 2rem; margin-top: 20px;"></div>
        </div>
    </div>

    <div id="client-screen" class="hidden">
        <div id="client-login" style="padding: 20px;">
            <h2>åå‰ã‚’å…¥åŠ›</h2>
            <input type="text" id="username" placeholder="ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ " style="font-size: 1.5rem; padding: 10px; width:80%; margin-bottom: 20px;">
            <br>
            <button class="btn" onclick="joinGame()">å‚åŠ ã™ã‚‹ï¼</button>
        </div>

        <div id="client-waiting" class="hidden" style="padding: 20px;">
            <h2>æº–å‚™å®Œäº†ï¼</h2>
            <p>è¦ªæ©Ÿã®ç”»é¢ã‚’è¦‹ã¦ãŠå¾…ã¡ãã ã•ã„</p>
        </div>

        <div id="client-controller" class="hidden controller-area">
            <button class="choice-btn choice-A" onclick="sendAnswer(0)">A</button>
            <button class="choice-btn choice-B" onclick="sendAnswer(1)">B</button>
            <button class="choice-btn choice-C" onclick="sendAnswer(2)">C</button>
            <button class="choice-btn choice-D" onclick="sendAnswer(3)">D</button>
        </div>

        <div id="client-mash" class="hidden controller-area" style="display: flex;">
            <button class="choice-btn mash-btn" onclick="sendMash()">é€£æ‰“!!</button>
        </div>
    </div>

    <script>
    // --- ã‚²ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ï¼ˆã‚¯ã‚¤ã‚ºå•é¡Œï¼‰ç·¨é›†å¯èƒ½ ---
    const QUIZ_DATA = [
        { q: "ã€Œæ—¥æœ¬ä¸€é«˜ã„å±±ã€ã¯ï¼Ÿ", options: ["å¯Œå£«å±±", "åŒ—å²³", "é˜¿è˜‡å±±", "é«˜å°¾å±±"], ans: 0 },
        { q: "å…ƒç´ è¨˜å·ã€ŒOã€ã¯ä½•ã‚’è¡¨ã™ï¼Ÿ", options: ["é‡‘", "éŠ€", "é…¸ç´ ", "é‰„"], ans: 2 },
        { q: "1000å††æœ­ã®è‚–åƒç”»ã¯èª°ï¼Ÿ", options: ["é‡å£è‹±ä¸–", "ç¦æ²¢è«­å‰", "åŒ—é‡ŒæŸ´ä¸‰éƒ", "å¤ç›®æ¼±çŸ³"], ans: 2 }, // 2024å¹´æ–°ç´™å¹£å¯¾å¿œ
        { q: "PCã®ã€Œãƒã‚¦ã‚¹ã€ã‚’å‹•ã‹ã™ã¨å‹•ãç”»é¢ä¸Šã®çŸ¢å°ã¯ï¼Ÿ", options: ["ã‚¢ã‚¤ã‚³ãƒ³", "ã‚«ãƒ¼ã‚½ãƒ«", "ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦", "ãƒªãƒ³ã‚¯"], ans: 1 },
        { q: "æ¬¡ã®ä¸­ã§ã€Œé‡èœã€ã«åˆ†é¡ã•ã‚Œã‚‹ã®ã¯ï¼Ÿ", options: ["ã‚¤ãƒã‚´", "ãƒªãƒ³ã‚´", "ãƒãƒŠãƒŠ", "ãƒ¢ãƒ¢"], ans: 0 }, // è¾²æ°´çœåˆ†é¡
    ];

    // --- ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° ---
    let peer;
    let conn;
    let myId;
    let connections = {}; // ãƒ›ã‚¹ãƒˆç”¨: { peerId: conn }
    let players = {};     // ãƒ›ã‚¹ãƒˆç”¨: { peerId: { name, score, isCorrect } }
    let gameMode = 'coop';
    let currentQuestionIndex = 0;
    let bossHp = 100;
    let isAcceptingAnswers = false;

    // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å–å¾—
    const urlParams = new URLSearchParams(window.location.search);
    const hostIdParam = urlParams.get('host');

    // èµ·å‹•æ™‚ã®åˆ†å²
    window.onload = () => {
        if (hostIdParam) {
            // QRã‚³ãƒ¼ãƒ‰ã‹ã‚‰æ¥ãŸå ´åˆã€è‡ªå‹•çš„ã«ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆç”»é¢ã¸
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('client-screen').classList.remove('hidden');
        }
    };

    // --- AudioContext (åŠ¹æœéŸ³) ---
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playTone(freq, type, duration) {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = type;
        osc.frequency.value = freq;
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.start();
        gain.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + duration);
        osc.stop(audioCtx.currentTime + duration);
    }
    const sounds = {
        join: () => playTone(600, 'sine', 0.2),
        correct: () => { playTone(800, 'sine', 0.1); setTimeout(()=>playTone(1200, 'sine', 0.2), 100); },
        wrong: () => playTone(150, 'sawtooth', 0.4),
        attack: () => playTone(100 + Math.random()*200, 'square', 0.1)
    };

    // ==========================================
    // ãƒ›ã‚¹ãƒˆï¼ˆè¦ªæ©Ÿï¼‰ã®ãƒ­ã‚¸ãƒƒã‚¯
    // ==========================================
    function initHost() {
        document.getElementById('start-screen').classList.add('hidden');
        document.getElementById('host-screen').classList.remove('hidden');

        // PeerJSåˆæœŸåŒ–
        peer = new Peer({ debug: 2 });

        peer.on('open', (id) => {
            myId = id;
            console.log('Host ID:', id);
            
            // ç¾åœ¨ã®URLã«?host=IDã‚’ã¤ã‘ãŸURLã‚’QRã‚³ãƒ¼ãƒ‰åŒ–
            const joinUrl = `${window.location.protocol}//${window.location.host}${window.location.pathname}?host=${id}`;
            new QRCode(document.getElementById("qrcode"), {
                text: joinUrl,
                width: 180,
                height: 180
            });
        });

        peer.on('connection', (c) => {
            c.on('open', () => {
                console.log('Client connected:', c.peer);
                connections[c.peer] = c;
                
                // ãƒ‡ãƒ¼ã‚¿å—ä¿¡è¨­å®š
                c.on('data', (data) => handleDataFromClient(c.peer, data));
            });
            
            c.on('close', () => {
                delete connections[c.peer];
                delete players[c.peer];
                updatePlayerList();
            });
        });
    }

    function handleDataFromClient(peerId, data) {
        if (data.type === 'join') {
            players[peerId] = { name: data.name, score: 0, isCorrect: false };
            updatePlayerList();
            sounds.join();
        } 
        else if (data.type === 'answer') {
            if (!isAcceptingAnswers) return;
            // å›ç­”å‡¦ç†
            const correct = QUIZ_DATA[currentQuestionIndex].ans;
            const isCorrect = (data.val === correct);
            players[peerId].isCorrect = isCorrect;
            
            // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¸ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯é€ä¿¡
            connections[peerId].send({ type: 'feedback', result: isCorrect });
        }
        else if (data.type === 'mash') {
            // é€£æ‰“ï¼ˆæ”»æ’ƒï¼‰å—ä¿¡
            if (gameMode === 'coop') {
                damageBoss(1); // 1ã‚¿ãƒƒãƒ—1ãƒ€ãƒ¡ãƒ¼ã‚¸
                sounds.attack();
            }
        }
    }

    function updatePlayerList() {
        const listEl = document.getElementById('player-list');
        listEl.innerHTML = '';
        Object.values(players).forEach(p => {
            const chip = document.createElement('div');
            chip.className = 'player-chip';
            chip.innerText = p.name;
            listEl.appendChild(chip);
        });
    }

    function startGame(mode) {
        gameMode = mode;
        document.getElementById('host-lobby').classList.add('hidden');
        document.getElementById('game-stage').classList.remove('hidden');
        
        currentQuestionIndex = -1;
        bossHp = 100 * Object.keys(players).length; // äººæ•°ã«å¿œã˜ã¦HPå¢—åŠ 
        updateBossHp();

        nextTurn();
    }

    function nextTurn() {
        currentQuestionIndex++;
        if (currentQuestionIndex >= QUIZ_DATA.length) {
            endGame();
            return;
        }

        const q = QUIZ_DATA[currentQuestionIndex];
        
        // ç”»é¢ãƒªã‚»ãƒƒãƒˆ
        document.getElementById('question-text').innerText = `Q${currentQuestionIndex+1}. ${q.q}`;
        document.getElementById('result-message').innerText = "";
        
        // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«å•é¡Œé€ä¿¡ï¼ˆé¸æŠè‚¢è¡¨ç¤ºï¼‰
        broadcast({ type: 'phase_quiz', options: q.options });

        // ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹
        let timeLeft = 10;
        isAcceptingAnswers = true;
        const timerDisplay = document.getElementById('timer-display');
        
        const timer = setInterval(() => {
            timeLeft--;
            timerDisplay.innerText = timeLeft;
            if (timeLeft <= 0) {
                clearInterval(timer);
                isAcceptingAnswers = false;
                showResults();
            }
        }, 1000);
    }

    function showResults() {
        // æ­£è§£è€…ãƒã‚§ãƒƒã‚¯
        const correctCount = Object.values(players).filter(p => p.isCorrect).length;
        
        if (gameMode === 'coop') {
            if (correctCount > 0) {
                document.getElementById('result-message').innerText = `${correctCount}äººæ­£è§£ï¼ æ”»æ’ƒãƒãƒ£ãƒ³ã‚¹ï¼é€£æ‰“ã—ã‚ï¼`;
                // é€£æ‰“ãƒ•ã‚§ãƒ¼ã‚ºé–‹å§‹
                broadcast({ type: 'phase_mash' });
                
                // 5ç§’é–“é€£æ‰“ã‚¿ã‚¤ãƒ 
                setTimeout(() => {
                    broadcast({ type: 'phase_wait' }); // é€£æ‰“çµ‚äº†
                    // æ¬¡ã®å•é¡Œã¸
                    setTimeout(nextTurn, 2000);
                }, 5000);
            } else {
                document.getElementById('result-message').innerText = "å…¨å“¡ä¸æ­£è§£... ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’ä¸ãˆã‚‰ã‚Œãªã„ï¼";
                document.getElementById('boss-avatar').innerText = "ğŸ˜ˆ"; // æŒ‘ç™º
                setTimeout(nextTurn, 3000);
            }
        } else {
            // å¯¾æˆ¦ãƒ¢ãƒ¼ãƒ‰ã®å®Ÿè£…ï¼ˆç°¡æ˜“ï¼‰
            // ã“ã“ã§ã¯ã‚·ãƒ³ãƒ—ãƒ«ã«ã™ã‚‹ãŸã‚ã€æ¬¡ã®å•é¡Œã¸
            setTimeout(nextTurn, 2000);
        }

        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®çŠ¶æ…‹ãƒªã‚»ãƒƒãƒˆ
        Object.values(players).forEach(p => p.isCorrect = false);
    }

    function damageBoss(amt) {
        bossHp -= amt;
        if (bossHp < 0) bossHp = 0;
        updateBossHp();
        
        // ãƒœã‚¹è¢«å¼¾ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
        const boss = document.getElementById('boss-avatar');
        boss.innerText = "ğŸ˜–";
        boss.classList.add('shake');
        setTimeout(() => {
            boss.classList.remove('shake');
            boss.innerText = "ğŸ‘¾";
        }, 200);

        if (bossHp <= 0) {
            document.getElementById('result-message').innerText = "BOSS DEFEATED!!";
            broadcast({ type: 'game_over', msg: 'YOU WIN!' });
        }
    }

    function updateBossHp() {
        const maxHp = 100 * Object.keys(players).length;
        const pct = (bossHp / maxHp) * 100;
        document.getElementById('boss-hp').style.width = pct + "%";
    }

    function broadcast(data) {
        Object.values(connections).forEach(c => c.send(data));
    }

    function endGame() {
        document.getElementById('question-text').innerText = "ã‚²ãƒ¼ãƒ çµ‚äº†ï¼";
    }


    // ==========================================
    // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼ˆå­æ©Ÿï¼‰ã®ãƒ­ã‚¸ãƒƒã‚¯
    // ==========================================
    function joinGame() {
        const name = document.getElementById('username').value;
        if (!name) return alert("åå‰ã‚’å…¥ã‚Œã¦ã­");
        if (!hostIdParam) return alert("QRã‚³ãƒ¼ãƒ‰ã‹ã‚‰èª­ã¿å–ã£ã¦ã„ãªã„ã‹ã€URLãŒä¸æ­£ã§ã™");

        peer = new Peer(); // IDã¯è‡ªå‹•ç”Ÿæˆ

        peer.on('open', (id) => {
            conn = peer.connect(hostIdParam);

            conn.on('open', () => {
                // æ¥ç¶šæˆåŠŸã—ãŸã‚‰åå‰ã‚’é€ä¿¡
                conn.send({ type: 'join', name: name });
                
                document.getElementById('client-login').classList.add('hidden');
                document.getElementById('client-waiting').classList.remove('hidden');
            });

            conn.on('data', (data) => handleHostData(data));
            
            conn.on('error', (err) => alert("æ¥ç¶šã‚¨ãƒ©ãƒ¼: " + err));
        });
    }

    function handleHostData(data) {
        // ãƒ•ã‚§ãƒ¼ã‚ºåˆ‡æ›¿
        if (data.type === 'phase_quiz') {
            showController('quiz', data.options);
        } else if (data.type === 'phase_mash') {
            showController('mash');
            navigator.vibrate(200); // æŒ¯å‹•åˆå›³
        } else if (data.type === 'phase_wait') {
            showController('wait');
        } else if (data.type === 'feedback') {
            // æ­£èª¤åˆ¤å®šå—ä¿¡
            if (data.result) {
                document.body.style.backgroundColor = "#00b894"; // ç·‘
                sounds.correct();
            } else {
                document.body.style.backgroundColor = "#d63031"; // èµ¤
                sounds.wrong();
            }
            setTimeout(() => document.body.style.backgroundColor = "#2d3436", 1000);
        }
    }

    function showController(mode, options = []) {
        document.getElementById('client-waiting').classList.add('hidden');
        document.getElementById('client-controller').classList.add('hidden');
        document.getElementById('client-mash').classList.add('hidden');

        if (mode === 'quiz') {
            const ctrl = document.getElementById('client-controller');
            ctrl.classList.remove('hidden');
            // é¸æŠè‚¢ãƒœã‚¿ãƒ³ã«æ–‡å­—ã‚’å…¥ã‚Œã‚‹ãªã‚‰ã“ã“ã§è¨­å®šï¼ˆä»Šå›ã¯A/B/C/Då›ºå®šï¼‰
        } else if (mode === 'mash') {
            document.getElementById('client-mash').classList.remove('hidden');
        } else {
            document.getElementById('client-waiting').classList.remove('hidden');
        }
    }

    function sendAnswer(val) {
        conn.send({ type: 'answer', val: val });
        // æŠ¼ã—ãŸã‚‰å¾…æ©Ÿç”»é¢ã¸ï¼ˆé€£æ‰“é˜²æ­¢ï¼‰
        showController('wait');
    }

    function sendMash() {
        conn.send({ type: 'mash' });
        navigator.vibrate(50); // ã‚¿ãƒƒãƒ—ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
    }

</script>
</body>
</html>
