<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CHAMPIONSHIP V2 - NEXT GEN</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700&family=Teko:wght@300;600&display=swap');

        :root {
            --primary: #00f2ff;
            --secondary: #ff0055;
            --accent: #ffee00;
            --dark-bg: #0b0c10;
        }

        body { 
            font-family: 'Rajdhani', sans-serif; 
            margin: 0; background-color: var(--dark-bg); color: white; 
            overflow: hidden; touch-action: none;
        }

        /* --- ËÉåÊôØ„Éª„Ç∞„É™„ÉÉ„ÉâÊºîÂá∫ --- */
        .bg-grid {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-image: linear-gradient(rgba(0, 242, 255, 0.05) 1px, transparent 1px), linear-gradient(90deg, rgba(0, 242, 255, 0.05) 1px, transparent 1px);
            background-size: 40px 40px; z-index: -1;
        }

        .full-screen { position: absolute; top:0; left:0; width: 100vw; height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .hidden { display: none !important; }

        /* --- „Éõ„Çπ„Éà: Á´∂ÊäÄÁîªÈù¢ÊºîÂá∫ --- */
        #top-bar {
            position: absolute; top: 0; left: 0; width: 100%; height: 70px;
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 40px; box-sizing: border-box; background: rgba(0,0,0,0.8); border-bottom: 2px solid var(--primary);
        }

        .hype-container {
            position: absolute; bottom: 80px; left: 50%; transform: translateX(-50%);
            width: 80%; height: 10px; background: #222; border-radius: 5px; overflow: hidden;
        }
        #hype-bar { width: 0%; height: 100%; background: linear-gradient(90deg, var(--primary), var(--secondary)); transition: 0.3s; box-shadow: 0 0 20px var(--primary); }

        #ticker {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 50px;
            background: var(--secondary); color: white; display: flex; align-items: center;
            font-weight: bold; font-size: 20px; overflow: hidden; white-space: nowrap;
        }
        .ticker-text { display: inline-block; padding-left: 100%; animation: ticker 20s linear infinite; }
        @keyframes ticker { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }

        /* --- Á∏ÑË∑≥„Å≥„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ --- */
        .rope-container {
            width: 100px; height: 150px; border: 3px solid rgba(255,255,255,0.2); position: relative; margin-bottom: 10px;
        }
        .jumper {
            width: 40px; height: 60px; background: var(--primary); position: absolute; bottom: 10px; left: 30px;
            transition: transform 0.1s;
        }
        .rope {
            width: 80px; height: 120px; border: 2px solid var(--accent); border-radius: 50%;
            position: absolute; top: 10px; left: 10px; transform-origin: center;
        }
        .rope-spin { animation: spin 0.2s linear infinite; }
        @keyframes spin { from { transform: rotateX(0deg); } to { transform: rotateX(360deg); } }

        /* --- „Éú„Çø„É≥„ÉªÂÖ•Âäõ --- */
        .btn {
            background: transparent; border: 2px solid var(--primary); color: var(--primary);
            padding: 12px 30px; font-family: 'Rajdhani'; font-weight: 700; cursor: pointer; transition: 0.3s;
        }
        .btn:hover { background: var(--primary); color: #000; }
        .mode-select { display: flex; gap: 10px; margin: 20px 0; }
        .mode-btn { border: 1px solid #555; padding: 10px; cursor: pointer; opacity: 0.5; }
        .mode-btn.active { border-color: var(--accent); opacity: 1; color: var(--accent); }

        /* --- „Çπ„Éû„ÉõÊìç‰ΩúÁîªÈù¢ --- */
        #ctrl-pad { text-align: center; }
        #action-circle {
            width: 250px; height: 250px; border-radius: 50%; border: 10px solid var(--primary);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            margin: 30px; box-shadow: 0 0 30px var(--primary);
        }
        .impact { animation: impact-anim 0.2s ease-out; }
        @keyframes impact-anim { 0% { transform: scale(1); } 50% { transform: scale(1.1); border-color: #fff; } 100% { transform: scale(1); } }

    </style>
</head>
<body>

    <div class="bg-grid"></div>

    <!-- ================= HOST VIEW ================= -->
    <div id="host-view" class="full-screen hidden">
        <div id="top-bar">
            <div style="color: var(--accent); font-size: 20px;">üèÜ WR: <span id="wr-val">0</span> <small id="wr-name"></small></div>
            <div id="mode-display" style="font-family: Teko; font-size: 30px; letter-spacing: 2px;">MODE: SHAKE</div>
            <div id="main-timer" style="font-family: Teko; font-size: 50px; color: var(--secondary);">00:00</div>
        </div>

        <!-- LOBBY -->
        <div id="lobby-panel" style="text-align: center; background: rgba(0,0,0,0.8); padding: 40px; border: 1px solid var(--primary);">
            <h1 style="font-family: Teko; font-size: 60px; margin: 0;">CHAMPIONSHIP V2</h1>
            
            <div class="mode-select">
                <div id="mode-shake" class="mode-btn active" onclick="window.setMode('SHAKE')">SHAKE MODE<br><small>ËÖï„ÇíÊåØ„ÇåÔºÅ</small></div>
                <div id="mode-jump" class="mode-btn" onclick="window.setMode('JUMP')">JUMP ROPE<br><small>„Ç∏„É£„É≥„Éó„Åó„ÇçÔºÅ</small></div>
            </div>

            <div id="qrcode" style="background: white; padding: 10px; display: inline-block; margin: 20px;"></div>
            
            <div>
                TIME: <input type="number" id="game-duration" value="15" style="width: 50px; background: none; border: 1px solid var(--primary); color: white; padding: 5px;">
                <button class="btn" id="start-btn" disabled onclick="window.hostStart()" style="margin-left: 20px;">START MATCH</button>
            </div>
            <div id="player-count" style="margin-top: 20px; color: var(--primary);">CONNECTED: 0</div>
        </div>

        <!-- ARENA -->
        <div id="arena" class="hidden" style="display: flex; align-items: flex-end; justify-content: center; height: 50vh; gap: 20px; width: 100%;">
            <!-- Bars generated here -->
        </div>

        <!-- HYPE METER -->
        <div class="hype-container"><div id="hype-bar"></div></div>

        <!-- TICKER -->
        <div id="ticker"><div class="ticker-text" id="ticker-content">WELCOME TO THE OFFICIAL CHAMPIONSHIP... PREPARE FOR BATTLE...</div></div>

        <!-- OVERLAY -->
        <div id="overlay-msg" style="position: absolute; font-family: Teko; font-size: 15vw; pointer-events: none; opacity: 0; transition: 0.3s; z-index: 100;"></div>
    </div>

    <!-- ================= CONTROLLER VIEW ================= -->
    <div id="ctrl-view" class="full-screen hidden">
        <div id="ctrl-login" style="text-align: center;">
            <h2 style="font-family: Teko; font-size: 40px;">ATHLETE ENTRY</h2>
            <input type="text" id="p-name" placeholder="NAME" style="padding: 15px; width: 200px; text-align: center;"><br><br>
            <button class="btn" onclick="window.ctrlJoin()">JOIN ARENA</button>
        </div>

        <div id="ctrl-pad" class="hidden">
            <h2 id="ctrl-mode-text">SHAKE!</h2>
            <div id="action-circle">
                <div style="font-size: 20px;">COUNT</div>
                <div id="my-score" style="font-family: Teko; font-size: 80px;">0</div>
            </div>
            <div id="ctrl-status">WAITING FOR HOST...</div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
        import { getDatabase, ref, set, onValue, update, onDisconnect, runTransaction } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDbZzTMvUkG2LXIGY4ux0KBTmnAdqP236s",
            authDomain: "game-4f2d9.firebaseapp.com",
            databaseURL: "https://game-4f2d9-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "game-4f2d9",
            storageBucket: "game-4f2d9.firebasestorage.app",
            messagingSenderId: "574316347824",
            appId: "1:574316347824:web:cf686040628e25ad615675"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- SOUND SYSTEM ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(freq, type, dur) {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + dur);
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.start(); osc.stop(audioCtx.currentTime + dur);
        }

        const sounds = {
            beep: () => playSound(880, 'sine', 0.1),
            go: () => playSound(440, 'square', 0.4),
            hit: () => playSound(150, 'sine', 0.05),
            whistle: () => { playSound(1000, 'triangle', 0.2); setTimeout(()=>playSound(1000,'triangle',0.5), 200); }
        };

        // --- GLOBAL ---
        const params = new URLSearchParams(window.location.search);
        let role = params.get('role') || 'host';
        let roomId = params.get('room');
        const myId = Math.random().toString(36).substr(2, 6).toUpperCase();
        let gameMode = 'SHAKE';

        if (role === 'host') {
            if (!roomId) {
                roomId = Math.random().toString(36).substring(2, 6).toUpperCase();
                window.location.replace(`?role=host&room=${roomId}`);
            }
            document.getElementById('host-view').classList.remove('hidden');
            new QRCode(document.getElementById("qrcode"), { text: `${window.location.origin}${window.location.pathname}?role=ctrl&room=${roomId}`, width: 120, height: 120 });

            const playersRef = ref(db, `v2/${roomId}/players`);
            const stateRef = ref(db, `v2/${roomId}/state`);

            window.setMode = (m) => {
                gameMode = m;
                document.getElementById('mode-shake').className = m === 'SHAKE' ? 'mode-btn active' : 'mode-btn';
                document.getElementById('mode-jump').className = m === 'JUMP' ? 'mode-btn active' : 'mode-btn';
                document.getElementById('mode-display').innerText = `MODE: ${m}`;
                update(stateRef, { mode: m });
            };

            onValue(ref(db, `v2_global/best`), snap => {
                const d = snap.val() || {score:0, name:'---'};
                document.getElementById('wr-val').innerText = d.score;
                document.getElementById('wr-name').innerText = `by ${d.name}`;
            });

            onValue(playersRef, snap => {
                const players = snap.val() || {};
                document.getElementById('player-count').innerText = `CONNECTED: ${Object.keys(players).length}`;
                document.getElementById('start-btn').disabled = Object.keys(players).length === 0;
                renderArena(players);
            });

            let totalActions = 0;
            function renderArena(players) {
                const arena = document.getElementById('arena');
                const isRunning = arena.getAttribute('data-running') === 'true';
                let currentTotal = 0;

                Object.keys(players).forEach(pid => {
                    let col = document.getElementById(`p-${pid}`);
                    if (!col) {
                        col = document.createElement('div');
                        col.id = `p-${pid}`;
                        col.style.textAlign = 'center';
                        col.innerHTML = `
                            <div class="p-val" style="font-family:Teko; font-size:30px;">0</div>
                            <div class="rope-container hidden"><div class="jumper"></div><div class="rope"></div></div>
                            <div class="bar" style="width:50px; background:var(--primary); transition:0.1s;"></div>
                            <div style="font-size:12px;">${players[pid].name}</div>
                        `;
                        arena.appendChild(col);
                    }
                    const p = players[pid];
                    currentTotal += (p.count || 0);
                    
                    const bar = col.querySelector('.bar');
                    const valText = col.querySelector('.p-val');
                    const ropeCont = col.querySelector('.rope-container');
                    const jumper = col.querySelector('.jumper');
                    const rope = col.querySelector('.rope');

                    if (gameMode === 'JUMP') {
                        bar.classList.add('hidden');
                        ropeCont.classList.remove('hidden');
                        if (p.count > (parseInt(valText.innerText) || 0)) {
                            sounds.hit();
                            jumper.style.transform = 'translateY(-30px)';
                            rope.classList.add('rope-spin');
                            setTimeout(() => { jumper.style.transform = 'translateY(0)'; rope.classList.remove('rope-spin'); }, 200);
                        }
                    } else {
                        bar.classList.remove('hidden');
                        ropeCont.classList.add('hidden');
                        bar.style.height = `${Math.min(p.count * 2, 300)}px`;
                        if (p.count > (parseInt(valText.innerText) || 0)) sounds.hit();
                    }

                    valText.innerText = isRunning ? '???' : (p.count || 0);
                });

                // Hype Bar & Ticker
                const hype = Math.min((currentTotal / 500) * 100, 100);
                document.getElementById('hype-bar').style.width = hype + '%';
                if (currentTotal > totalActions + 50) {
                    totalActions = currentTotal;
                    document.getElementById('ticker-content').innerText = `AMAZING! TOTAL ACTIONS EXCEEDED ${currentTotal}! KEEP GOING!`;
                }
            }

            window.hostStart = () => {
                const dur = parseInt(document.getElementById('game-duration').value);
                document.getElementById('lobby-panel').classList.add('hidden');
                document.getElementById('arena').classList.remove('hidden');
                document.getElementById('arena').setAttribute('data-running', 'true');
                
                // Reset
                onValue(playersRef, snap => {
                    const updates = {};
                    Object.keys(snap.val() || {}).forEach(k => updates[k+'/count'] = 0);
                    update(playersRef, updates);
                }, {onlyOnce:true});

                // Countdown
                let cd = 3;
                const ov = document.getElementById('overlay-msg');
                ov.style.opacity = 1;
                const timer = setInterval(() => {
                    if (cd > 0) { sounds.beep(); ov.innerText = cd; }
                    else if (cd === 0) { 
                        sounds.go(); ov.innerText = "GO!"; 
                        setTimeout(() => ov.style.opacity = 0, 1000);
                        startBattle(dur);
                        clearInterval(timer);
                    }
                    cd--;
                }, 1000);
            };

            function startBattle(dur) {
                update(stateRef, { status: 'running' });
                let left = dur;
                const tEl = document.getElementById('main-timer');
                const timer = setInterval(() => {
                    left--;
                    tEl.innerText = `00:${left < 10 ? '0'+left : left}`;
                    if (left <= 0) {
                        clearInterval(timer);
                        finishBattle();
                    }
                }, 1000);
            }

            function finishBattle() {
                sounds.whistle();
                update(stateRef, { status: 'finished' });
                document.getElementById('arena').setAttribute('data-running', 'false');
                document.getElementById('overlay-msg').innerText = "FINISH!";
                document.getElementById('overlay-msg').style.opacity = 1;

                onValue(playersRef, snap => {
                    const players = snap.val();
                    let max = -1, winName = "";
                    Object.keys(players).forEach(k => {
                        if (players[k].count > max) { max = players[k].count; winName = players[k].name; }
                    });
                    
                    setTimeout(() => {
                        document.getElementById('overlay-msg').innerHTML = `WINNER<br><span style="color:var(--primary)">${winName}</span>`;
                        if (max > 0) {
                            runTransaction(ref(db, `v2_global/best`), curr => {
                                if (!curr || max > curr.score) return { score: max, name: winName };
                                return;
                            });
                        }
                    }, 2000);

                    setTimeout(() => location.reload(), 10000);
                }, {onlyOnce:true});
            }
        } 
        
        // --- CONTROLLER LOGIC ---
        else {
            document.getElementById('ctrl-view').classList.remove('hidden');
            let status = 'lobby', count = 0, mode = 'SHAKE';

            window.ctrlJoin = () => {
                const name = document.getElementById('p-name').value;
                if (!name) return;
                if (typeof DeviceMotionEvent.requestPermission === 'function') {
                    DeviceMotionEvent.requestPermission().then(res => { if(res==='granted') setup(name); });
                } else { setup(name); }
            };

            function setup(name) {
                document.getElementById('ctrl-login').classList.add('hidden');
                document.getElementById('ctrl-pad').classList.remove('hidden');
                const pRef = ref(db, `v2/${roomId}/players/${myId}`);
                set(pRef, { name: name, count: 0 });
                onDisconnect(pRef).remove();

                onValue(ref(db, `v2/${roomId}/state`), snap => {
                    const s = snap.val() || {};
                    status = s.status;
                    mode = s.mode || 'SHAKE';
                    document.getElementById('ctrl-mode-text').innerText = mode + "!";
                    if (status === 'ready') { count = 0; document.getElementById('my-score').innerText = 0; }
                });

                let lastY = 0, lastTime = 0;
                window.addEventListener('devicemotion', e => {
                    if (status !== 'running') return;
                    const acc = e.accelerationIncludingGravity;
                    
                    if (mode === 'SHAKE') {
                        const delta = Math.abs(acc.x) + Math.abs(acc.y) + Math.abs(acc.z);
                        if (delta > 30) trigger();
                    } else {
                        // JUMP: Vertical acceleration peak
                        if (acc.y > 15 && lastY <= 15) trigger();
                        lastY = acc.y;
                    }
                });

                function trigger() {
                    const now = Date.now();
                    if (now - lastTime < 150) return;
                    lastTime = now;
                    count++;
                    document.getElementById('my-score').innerText = count;
                    document.getElementById('action-circle').classList.add('impact');
                    setTimeout(() => document.getElementById('action-circle').classList.remove('impact'), 200);
                    update(pRef, { count: count });
                }
            }
        }
    </script>
</body>
</html>
