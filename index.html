<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PARTY BOX: ULTIMATE 5</title>
    <!-- å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <!-- ãƒ•ã‚©ãƒ³ãƒˆ -->
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@800&family=Rubik:wght@700&display=swap" rel="stylesheet">
    
    <style>
        :root { --bg: #1a1a1a; --cyan: #00f2ff; --pink: #ff00ff; --yellow: #ffea00; --green: #00ff66; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background: var(--bg); color: white; font-family: 'M PLUS Rounded 1c', sans-serif; overflow: hidden; height: 100vh; user-select: none; text-align: center; touch-action: manipulation; }

        /* ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ç®¡ç† */
        .screen { position: fixed; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; background: radial-gradient(circle at center, #333 0%, #000 120%); transition: opacity 0.3s, transform 0.3s; z-index: 1; padding: 20px; }
        .hidden { opacity: 0; pointer-events: none; transform: scale(0.95); z-index: -10; }

        /* ãƒ†ã‚­ã‚¹ãƒˆ */
        h1 { font-family: 'Rubik', sans-serif; font-size: 3.5rem; color: var(--cyan); text-shadow: 4px 4px 0 var(--pink); margin: 0; letter-spacing: 2px; }
        h2 { font-size: 2rem; margin: 10px; color: white; }
        .round-info { font-size: 1.5rem; color: var(--yellow); font-family: 'Rubik'; margin-bottom: 10px; }
        .big-timer { font-size: 6rem; font-family: 'Rubik'; font-weight: bold; color: white; text-shadow: 0 0 20px var(--cyan); }

        /* ãƒœã‚¿ãƒ³ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .btn { background: linear-gradient(135deg, #ff00cc, #3333ff); border: none; color: white; padding: 18px 40px; font-size: 1.5rem; border-radius: 50px; cursor: pointer; margin: 15px; box-shadow: 0 10px 20px rgba(255, 0, 204, 0.4); font-family: inherit; transition: transform 0.1s, filter 0.1s; position: relative; overflow: hidden; }
        .btn:active { transform: scale(0.95); filter: brightness(1.2); }
        .btn-cyan { background: linear-gradient(135deg, #00ccff, #00ffcc); color: #000; box-shadow: 0 10px 20px rgba(0, 255, 255, 0.4); }

        /* ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆç”¨UI */
        .c-layer { width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .c-header { position: absolute; top: 10px; width: 100%; text-align: center; font-size: 1.2rem; color: #888; pointer-events: none; }
        
        /* ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ï¼ˆå…±é€šï¼‰ */
        .act-btn { width: 140px; height: 140px; border-radius: 50%; border: none; font-size: 2rem; font-weight: 900; color: white; box-shadow: 0 8px 0 rgba(0,0,0,0.5), 0 0 20px rgba(255,255,255,0.2); transition: transform 0.05s; display: flex; flex-direction: column; align-items: center; justify-content: center; margin: 10px; cursor: pointer; }
        .act-btn:active { transform: translateY(8px); box-shadow: none; }
        .bg-red { background: #ff4757; text-shadow: 0 2px 0 #a00; }
        .bg-blue { background: #2ed573; text-shadow: 0 2px 0 #080; }
        .bg-huge { width: 240px; height: 240px; font-size: 3.5rem; background: radial-gradient(#ff6b81, #c0392b); }

        /* ã‚°ãƒªãƒƒãƒ‰ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼ˆã‚¯ã‚¤ã‚ºãªã©ï¼‰ */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 100%; max-width: 400px; }
        .grid-btn { height: 100px; border-radius: 15px; border: none; background: #444; color: white; font-size: 1.8rem; font-weight: bold; box-shadow: 0 6px 0 #222; transition: transform 0.1s; }
        .grid-btn:active { transform: translateY(6px); box-shadow: none; }

        /* ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒªã‚¹ãƒˆ */
        .rank-list { width: 90%; max-width: 500px; background: rgba(255,255,255,0.1); border-radius: 15px; padding: 20px; text-align: left; overflow-y: auto; max-height: 60vh; }
        .rank-item { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.2); font-size: 1.2rem; }
        .rank-top { color: var(--yellow); font-weight: bold; font-size: 1.5rem; }

        /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .pulse { animation: pulse 0.5s infinite alternate; }
        @keyframes pulse { from { transform: scale(1); } to { transform: scale(1.05); } }
    </style>
</head>
<body>

    <!-- ================== HOST SCREENS ================== -->
    
    <!-- ãƒˆãƒƒãƒ—ç”»é¢ -->
    <div id="s-top" class="screen">
        <h1>PARTY BOX<br>ULTIMATE</h1>
        <p>5ãƒ©ã‚¦ãƒ³ãƒ‰å‹è²  Ã— å…¨å“¡å‚åŠ ãƒãƒˆãƒ«</p>
        <div style="margin-top: 30px;">
            <button id="btn-host" class="btn">ğŸ’» ãƒ›ã‚¹ãƒˆã§ã¯ã˜ã‚ã‚‹</button>
            <button id="btn-client" class="btn btn-cyan">ğŸ“± ã‚¹ãƒãƒ›ã§å‚åŠ </button>
        </div>
    </div>

    <!-- ãƒ­ãƒ“ãƒ¼ç”»é¢ -->
    <div id="s-lobby" class="screen hidden">
        <h2>ROOM ID</h2>
        <div id="disp-id" style="font-size: 5rem; font-family:'Rubik'; color:var(--cyan);">----</div>
        <div id="qrcode" style="background:white; padding:15px; border-radius:15px; margin: 20px;"></div>
        <p>ã‚¨ãƒ³ãƒˆãƒªãƒ¼äººæ•°: <span id="p-count" style="font-size:2rem; font-weight:bold; color:var(--pink)">0</span> äºº</p>
        <button onclick="startTotalGame()" class="btn btn-cyan">ãƒãƒˆãƒ«ã‚¹ã‚¿ãƒ¼ãƒˆï¼</button>
    </div>

    <!-- ã‚²ãƒ¼ãƒ ãƒ—ãƒ¬ã‚¤ç”»é¢ -->
    <div id="s-game" class="screen hidden">
        <div class="round-info" id="g-round">ROUND 1/5</div>
        <h2 id="g-title" style="font-size: 3rem; margin: 5px 0; color:var(--cyan);">GAME TITLE</h2>
        <p id="g-desc" style="font-size:1.5rem;">èª¬æ˜æ–‡</p>
        
        <div style="flex-grow: 1; display: flex; align-items: center; justify-content: center; flex-direction: column;">
            <div id="g-timer" class="big-timer">READY</div>
            <div id="g-leader" style="font-size: 1.8rem; margin-top: 20px; color: #aaa;"></div>
        </div>
    </div>

    <!-- ãƒ©ã‚¦ãƒ³ãƒ‰çµæœç”»é¢ -->
    <div id="s-round-result" class="screen hidden">
        <h2>ROUND RESULT</h2>
        <div id="round-ranking" class="rank-list"></div>
        <div style="margin-top: 20px;">
            <button onclick="nextRound()" class="btn btn-cyan">æ¬¡ã®ãƒ©ã‚¦ãƒ³ãƒ‰ã¸</button>
        </div>
    </div>

    <!-- æœ€çµ‚çµæœç”»é¢ -->
    <div id="s-final" class="screen hidden">
        <h1 style="color:var(--yellow);">CHAMPION</h1>
        <div id="winner-name" style="font-size: 4rem; font-weight: bold; margin: 20px;">???</div>
        <div id="final-ranking" class="rank-list" style="height: 200px;"></div>
        <button onclick="location.reload()" class="btn">ã‚¿ã‚¤ãƒˆãƒ«ã«æˆ»ã‚‹</button>
    </div>


    <!-- ================== CLIENT SCREENS ================== -->
    
    <!-- ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ -->
    <div id="c-login" class="screen hidden">
        <h2>ROOM ID</h2>
        <input id="inp-id" style="font-size:2rem; padding:10px; width:200px; text-align:center; border-radius:10px; border:none; text-transform:uppercase;" placeholder="ABCD">
        <br><br>
        <input id="inp-name" style="font-size:1.5rem; padding:10px; width:200px; text-align:center; border-radius:10px; border:none;" placeholder="åå‰">
        <br><br>
        <button id="btn-join" class="btn btn-cyan">å‚åŠ ã™ã‚‹</button>
        <p style="font-size:0.8rem; margin-top:20px; color:#888;">â€»PC/ã‚¹ãƒãƒ›å¯¾å¿œ</p>
    </div>

    <!-- ãƒ—ãƒ¬ã‚¤ãƒ«ãƒ¼ãƒ  -->
    <div id="c-play" class="screen hidden">
        <div id="c-header" class="c-header">å¾…æ©Ÿä¸­...</div>
        <div id="c-area" class="c-layer"></div>
    </div>


    <!-- ================== SCRIPT ================== -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, set, get, onValue, update, remove, onDisconnect, runTransaction, child } 
               from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        // â˜…é‡è¦: ã“ã“ã«ã”è‡ªèº«ã®Firebase Configã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„â˜…
        // è¨­å®šãŒãªã„ã¨é€šä¿¡å¯¾æˆ¦ã¯å‹•ãã¾ã›ã‚“ã€‚
        const firebaseConfig = {
            apiKey: "AIzaSyDbZzTMvUkG2LXIGY4ux0KBTmnAdqP236s",
            authDomain: "game-4f2d9.firebaseapp.com",
            databaseURL: "https://game-4f2d9-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "game-4f2d9",
            storageBucket: "game-4f2d9.firebasestorage.app",
            messagingSenderId: "574316347824",
            appId: "1:574316347824:web:cf686040628e25ad615675"
        };

        let app, db;
        try {
            app = initializeApp(firebaseConfig);
            db = getDatabase(app);
        } catch(e) {
            console.error("Firebase init error", e);
            alert("Firebaseã®è¨­å®šãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚ã‚³ãƒ¼ãƒ‰å†…ã®firebaseConfigã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
        }

        // --- ã‚²ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿å®šç¾© (20ç¨®é¡) ---
        const GAMES = [
            { id:'mash', name:'é€£æ‰“ãƒãƒˆãƒ«', desc:'ã¨ã«ã‹ããƒœã‚¿ãƒ³ã‚’é€£æ‰“ã—ã‚ï¼', type:'tap' },
            { id:'shake', name:'ã‚·ã‚§ã‚¤ã‚¯ï¼', desc:'ã‚¹ãƒãƒ›ã‚’å…¨åŠ›ã§æŒ¯ã‚Œï¼', type:'shake' },
            { id:'stop', name:'5ç§’ã§æ­¢ã‚ã‚', desc:'5.00ç§’ãƒ”ãƒƒã‚¿ãƒªã‚’ç›®æŒ‡ã›ï¼', type:'stop' },
            { id:'red', name:'æ—©æŠ¼ã—ï¼', desc:'è‰²ãŒã€Œèµ¤ã€ã«ãªã£ãŸã‚‰æŠ¼ã›ï¼', type:'reaction' },
            { id:'charge', name:'ãƒ‘ãƒ¯ãƒ¼å……å¡«', desc:'é•·æŠ¼ã—ã—ã¦100%ã‚’ç›®æŒ‡ã›ï¼', type:'charge' },
            { id:'math', name:'è¨ˆç®—ãƒãƒˆãƒ«', desc:'æ­£ã—ã„ç­”ãˆã‚’é¸ã¹ï¼', type:'quiz_math' },
            { id:'color', name:'è‰²å½©æ„Ÿè¦š', desc:'æ–‡å­—ã®ã€Œæ„å‘³ã€ã®è‰²ã‚’é¸ã¹ï¼', type:'quiz_color' },
            { id:'rps', name:'å¾Œå‡ºã—å‹åˆ©', desc:'å‹ã¦ã‚‹æ‰‹ã‚’é¸ã¹ï¼', type:'quiz_rps' },
            { id:'hl', name:'HIGH & LOW', desc:'æ¬¡ã®æ•°å­—ã¯å¤§ãã„ï¼Ÿå°ã•ã„ï¼Ÿ', type:'quiz_hl' },
            { id:'count', name:'10å›æŠ¼ã›', desc:'æ­£ç¢ºã«10å›ã ã‘æŠ¼ã—ã¦æ±ºå®šï¼', type:'count' },
            { id:'dont', name:'æŠ¼ã™ãªï¼', desc:'çµ¶å¯¾ã«ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ãªï¼', type:'dont' },
            { id:'odd', name:'ä»²é–“å¤–ã‚Œ', desc:'é•ã†æ–‡å­—ã‚’æ¢ã›ï¼', type:'odd' },
            { id:'leftright', name:'å·¦å³é€£æ‰“', desc:'Lã¨Rã‚’äº¤äº’ã«æŠ¼ã›ï¼', type:'lr' },
            { id:'slot', name:'ã‚¹ãƒ­ãƒƒãƒˆ', desc:'ã€Œ7ã€ã§æ­¢ã‚ã‚ï¼', type:'slot' },
            { id:'bomb', name:'è§£é™¤ã‚³ãƒ¼ãƒ‰', desc:'è¡¨ç¤ºã•ã‚ŒãŸé †ã«ãƒœã‚¿ãƒ³ã‚’æŠ¼ã›ï¼', type:'seq' },
            { id:'swipe', name:'ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«', desc:'ä¸Šã«ã‚¹ãƒ¯ã‚¤ãƒ—ã—ç¶šã‘ã‚ï¼', type:'swipe' },
            { id:'balance', name:'ãƒãƒ©ãƒ³ã‚¹', desc:'æ°´å¹³(0Â°)ã‚’ã‚­ãƒ¼ãƒ—ã—ã‚ï¼', type:'balance' },
            { id:'luck', name:'é‹è©¦ã—', desc:'å½“ãŸã‚Šã‚’é¸ã¹ï¼', type:'luck' },
            { id:'barrage', name:'å¼¾å¹•å›é¿', desc:'å·¦å³ã«å‹•ã„ã¦é¿ã‘ã‚ï¼(é€£æ‰“)', type:'tap_move' },
            { id:'reading', name:'ç©ºæ°—ã‚’èª­ã‚', desc:'èª°ã‚‚æŠ¼ã•ãªã„ãªã‚‰æŠ¼ã›ï¼', type:'reading' }
        ];

        // --- å¤‰æ•° ---
        let myId = "P" + Math.random().toString(36).substr(2, 5);
        let roomId = "";
        let currentRound = 1;
        const TOTAL_ROUNDS = 5;
        
        // --- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ---
        const $ = id => document.getElementById(id);
        const show = id => {
            document.querySelectorAll('.screen').forEach(e => e.classList.add('hidden'));
            $(id).classList.remove('hidden');
        };

        // ================= HOST =================
        $('btn-host').addEventListener('click', () => {
            roomId = Math.random().toString(36).substr(2, 4).toUpperCase();
            const rRef = ref(db, `rooms/${roomId}`);
            set(rRef, { status: 'lobby', round: 1 });
            onDisconnect(rRef).remove();

            $('disp-id').innerText = roomId;
            $('qrcode').innerHTML = "";
            new QRCode($('qrcode'), { text: `${location.origin}${location.pathname}?room=${roomId}`, width: 128, height: 128 });
            show('s-lobby');

            onValue(ref(db, `rooms/${roomId}/players`), snap => {
                $('p-count').innerText = snap.exists() ? Object.keys(snap.val()).length : 0;
            });
        });

        // ãƒ›ã‚¹ãƒˆç”¨ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°
        window.startTotalGame = () => {
            // ã‚¹ã‚³ã‚¢åˆæœŸåŒ–
            get(ref(db, `rooms/${roomId}/players`)).then(snap => {
                if(!snap.exists()) return alert("å‚åŠ è€…ãŒã„ã¾ã›ã‚“");
                const updates = {};
                snap.forEach(p => updates[`rooms/${roomId}/players/${p.key}/totalScore`] = 0);
                update(ref(db), updates).then(() => {
                    currentRound = 1;
                    startRound();
                });
            });
        };

        window.nextRound = () => {
            currentRound++;
            if(currentRound > TOTAL_ROUNDS) {
                showFinalResult();
            } else {
                startRound();
            }
        };

        function startRound() {
            // ã‚²ãƒ¼ãƒ æŠ½é¸
            const game = GAMES[Math.floor(Math.random() * GAMES.length)];
            const roundDuration = 15; // 15ç§’ã«å»¶é•·

            // DBæ›´æ–°
            update(ref(db, `rooms/${roomId}`), {
                status: 'game',
                game: game,
                round: currentRound,
                endTime: Date.now() + 3000 + (roundDuration * 1000)
            });

            // ãƒ©ã‚¦ãƒ³ãƒ‰ã‚¹ã‚³ã‚¢ãƒªã‚»ãƒƒãƒˆ
            get(ref(db, `rooms/${roomId}/players`)).then(snap => {
                const updates = {};
                snap.forEach(p => updates[`rooms/${roomId}/players/${p.key}/roundScore`] = 0);
                update(ref(db), updates);
            });

            // ç”»é¢è¡¨ç¤º
            show('s-game');
            $('g-round').innerText = `ROUND ${currentRound} / ${TOTAL_ROUNDS}`;
            $('g-title').innerText = game.name;
            $('g-desc').innerText = game.desc;
            $('g-timer').innerText = "READY";
            $('g-leader').innerText = "";

            // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³
            setTimeout(() => {
                $('g-timer').innerText = "GO!";
                runGameTimer(roundDuration);
            }, 3000);
        }

        function runGameTimer(seconds) {
            let left = seconds;
            const timer = setInterval(() => {
                left -= 0.1;
                $('g-timer').innerText = left.toFixed(1);

                // é€”ä¸­çµŒéï¼ˆãƒˆãƒƒãƒ—ãƒ©ãƒ³ãƒŠãƒ¼è¡¨ç¤ºï¼‰
                if(Math.floor(left*10)%5 === 0) { // 0.5ç§’ãŠã
                    get(ref(db, `rooms/${roomId}/players`)).then(snap => {
                        let top = {name:'-', score:-999};
                        snap.forEach(p => {
                            const s = p.val().roundScore || 0;
                            if(s > top.score) top = {name:p.val().name, score:s};
                        });
                        $('g-leader').innerText = `TOP: ${top.name} (${top.score})`;
                    });
                }

                if(left <= 0) {
                    clearInterval(timer);
                    endRound();
                }
            }, 100);
        }

        function endRound() {
            // é›†è¨ˆã¨ãƒˆãƒ¼ã‚¿ãƒ«ã‚¹ã‚³ã‚¢åŠ ç®—
            get(ref(db, `rooms/${roomId}/players`)).then(snap => {
                const players = [];
                const updates = {};
                snap.forEach(p => {
                    const d = p.val();
                    const rs = d.roundScore || 0;
                    const newTotal = (d.totalScore || 0) + rs;
                    updates[`rooms/${roomId}/players/${p.key}/totalScore`] = newTotal;
                    players.push({ name: d.name, round: rs, total: newTotal });
                });
                
                // DBæ›´æ–°
                update(ref(db), updates);
                update(ref(db, `rooms/${roomId}`), { status: 'result' });

                // ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤º
                players.sort((a,b) => b.round - a.round);
                show('s-round-result');
                $('round-ranking').innerHTML = players.map((p,i) => `
                    <div class="rank-item">
                        <span class="${i===0?'rank-top':''}">${i+1}. ${p.name}</span>
                        <span>+${p.round} (è¨ˆ:${p.total})</span>
                    </div>
                `).join('');
                
                confetti({ particleCount: 150, spread: 70 });
            });
        }

        function showFinalResult() {
            get(ref(db, `rooms/${roomId}/players`)).then(snap => {
                const players = [];
                snap.forEach(p => players.push(p.val()));
                players.sort((a,b) => b.totalScore - a.totalScore);
                
                show('s-final');
                $('winner-name').innerText = players[0].name;
                $('final-ranking').innerHTML = players.map((p,i) => `
                    <div class="rank-item">
                        <span class="${i===0?'rank-top':''}">${i+1}. ${p.name}</span>
                        <span>${p.totalScore} pt</span>
                    </div>
                `).join('');
                
                // æ´¾æ‰‹ãªæ¼”å‡º
                const endConfetti = setInterval(() => {
                    confetti({ particleCount: 50, spread: 60, origin: { x: Math.random(), y: 0.6 } });
                }, 500);
                setTimeout(() => clearInterval(endConfetti), 3000);
            });
        }


        // ================= CLIENT =================
        const params = new URLSearchParams(location.search);
        if(params.get('room')) { $('inp-id').value = params.get('room'); show('c-login'); }
        $('btn-client').addEventListener('click', () => show('c-login'));

        $('btn-join').addEventListener('click', async () => {
            const rid = $('inp-id').value.toUpperCase().trim();
            const name = $('inp-name').value || "åç„¡ã—";
            if(!rid) return;
            
            try {
                const snap = await get(child(ref(db), `rooms/${rid}`));
                if(!snap.exists()) return alert("éƒ¨å±‹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
                
                roomId = rid;
                const pRef = ref(db, `rooms/${roomId}/players/${myId}`);
                set(pRef, { name: name, totalScore: 0, roundScore: 0 });
                onDisconnect(pRef).remove();
                
                show('c-play');
                initClientListener();
                
                // ã‚»ãƒ³ã‚µãƒ¼è¨±å¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼ˆiOSç”¨ï¼‰
                if(typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
                    DeviceMotionEvent.requestPermission().catch(e=>console.log(e));
                }
            } catch(e) { console.error(e); alert("æ¥ç¶šã‚¨ãƒ©ãƒ¼"); }
        });

        function initClientListener() {
            onValue(ref(db, `rooms/${roomId}`), snap => {
                const data = snap.val();
                if(!data) return location.reload();

                const area = $('c-area');
                const head = $('c-header');

                if(data.status === 'lobby') {
                    head.innerText = "ãƒ›ã‚¹ãƒˆã®é–‹å§‹å¾…ã¡...";
                    area.innerHTML = `<div class="pulse" style="font-size:3rem;">â³</div>`;
                }
                else if (data.status === 'game') {
                    head.innerText = `R${data.round}: ${data.game.name}`;
                    // ã‚²ãƒ¼ãƒ é–‹å§‹æ™‚åˆ»ã¾ã§å¾…æ©Ÿ (ã‚µãƒ¼ãƒãƒ¼æ™‚åˆ»åŒæœŸã¯ç°¡æ˜“çš„ã«å®Ÿè£…)
                    const wait = data.endTime - (15000) - Date.now() - 3000; 
                    // â€»ç°¡æ˜“ãƒ­ã‚¸ãƒƒã‚¯: endTimeã‹ã‚‰é€†ç®—ã›ãšã€å˜ç´”ã«çŠ¶æ…‹å¤‰åŒ–ã§UIæç”»
                    renderClientGame(data.game, area);
                }
                else if (data.status === 'result') {
                    head.innerText = "çµæœç™ºè¡¨";
                    area.innerHTML = `<div style="font-size:3rem;">ğŸ†</div>`;
                }
            });
        }

        // --- ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã‚²ãƒ¼ãƒ UIæ§‹ç¯‰ ---
        function renderClientGame(game, container) {
            container.innerHTML = "";
            let score = 0;
            
            // ã‚¹ã‚³ã‚¢åŠ ç®—é–¢æ•°
            const add = (pt=1) => {
                score += pt;
                // ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã§å®‰å…¨ã«åŠ ç®—
                runTransaction(ref(db, `rooms/${roomId}/players/${myId}/roundScore`), (current) => (current||0) + pt);
                if(navigator.vibrate) navigator.vibrate(20); // æŒ¯å‹•ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
            };
            
            // UIãƒ˜ãƒ«ãƒ‘ãƒ¼: ãƒœã‚¿ãƒ³ä½œæˆ
            const mkBtn = (cls, txt, onClick) => {
                const b = document.createElement('button');
                b.className = cls;
                b.innerHTML = txt;
                // PC(mousedown)ã¨ã‚¹ãƒãƒ›(touchstart)ã®ä¸¡å¯¾å¿œã¨ã—ã¦ pointerdown ã‚’ä½¿ã†
                b.addEventListener('pointerdown', (e) => {
                    e.preventDefault(); // æ‹¡å¤§ãªã©ã®ãƒ–ãƒ©ã‚¦ã‚¶å‹•ä½œé˜²æ­¢
                    onClick(b);
                });
                return b;
            };

            // ã‚²ãƒ¼ãƒ åˆ†å²
            switch(game.type) {
                case 'tap': // é€£æ‰“
                case 'tap_move':
                    container.appendChild(mkBtn("act-btn bg-huge", "PUSH!", () => {
                        add(1);
                        const b = container.querySelector('button');
                        b.style.transform = "scale(0.9)";
                        setTimeout(()=>b.style.transform="scale(1)", 50);
                    }));
                    break;

                case 'shake': // ã‚·ã‚§ã‚¤ã‚¯
                    container.innerHTML = `<div style="font-size:5rem;" class="pulse">ğŸ“²</div><p>æŒ¯ã‚Œï¼</p>`;
                    let last = {x:0,y:0,z:0};
                    const hdl = (e) => {
                        const acc = e.accelerationIncludingGravity;
                        if(acc) {
                            const d = Math.abs(acc.x+acc.y+acc.z - last.x-last.y-last.z);
                            if(d > 20) add(1);
                            last = {x:acc.x, y:acc.y, z:acc.z};
                        }
                    };
                    window.addEventListener('devicemotion', hdl);
                    // 15ç§’å¾Œã«ãƒªã‚¹ãƒŠãƒ¼å‰Šé™¤ï¼ˆç°¡æ˜“ï¼‰
                    setTimeout(()=>window.removeEventListener('devicemotion', hdl), 16000);
                    break;

                case 'stop': // 5ç§’æ­¢ã‚
                    const startT = Date.now();
                    container.appendChild(mkBtn("act-btn bg-blue", "STOP", (btn) => {
                        const diff = Math.abs(5000 - (Date.now() - startT));
                        const pt = Math.max(0, 1000 - diff);
                        add(Math.floor(pt));
                        btn.disabled = true;
                        btn.innerHTML = (diff/1000).toFixed(2) + "ç§’å·®";
                    }));
                    break;

                case 'reaction': // æ—©æŠ¼ã—
                    const rBtn = mkBtn("act-btn bg-huge", "å¾…ã¦...", (btn) => {
                        if(btn.style.backgroundColor === 'red') {
                            const ms = Date.now() - btn.dataset.t;
                            const pts = Math.max(0, 1000 - ms);
                            add(pts);
                            btn.innerText = pts + "pt";
                            btn.disabled = true;
                        } else {
                            add(-200); // ãŠæ‰‹ä»˜ã
                            btn.innerText = "æ—©ã™ã!";
                            setTimeout(()=>btn.innerText="å¾…ã¦...", 500);
                        }
                    });
                    rBtn.style.background = "#333";
                    container.appendChild(rBtn);
                    
                    const wait = 2000 + Math.random() * 5000;
                    setTimeout(() => {
                        if(!rBtn.disabled) {
                            rBtn.style.background = "red";
                            rBtn.innerText = "æŠ¼ã›ï¼";
                            rBtn.dataset.t = Date.now();
                        }
                    }, wait);
                    break;

                case 'charge': // é•·æŠ¼ã—
                    const cBar = document.createElement('div');
                    cBar.style.cssText = "width:200px; height:30px; border:2px solid white; margin-bottom:20px; position:relative;";
                    const cFill = document.createElement('div');
                    cFill.style.cssText = "width:0%; height:100%; background:cyan;";
                    cBar.appendChild(cFill);
                    container.appendChild(cBar);

                    let pow = 0;
                    let intv;
                    const cBtn = mkBtn("act-btn bg-huge", "HOLD", () => {}); // pointerdownã¯å€‹åˆ¥è¨­å®š
                    
                    cBtn.addEventListener('pointerdown', (e) => {
                        e.preventDefault();
                        pow = 0;
                        intv = setInterval(() => {
                            pow += 3;
                            cFill.style.width = Math.min(100, pow) + "%";
                        }, 50);
                    });
                    cBtn.addEventListener('pointerup', () => {
                        clearInterval(intv);
                        if(pow >= 90 && pow <= 100) add(500);
                        else if(pow > 100) add(0);
                        else add(pow);
                        pow = 0; cFill.style.width = "0%";
                    });
                    container.appendChild(cBtn);
                    break;
                
                case 'quiz_math': // è¨ˆç®—
                case 'quiz_color': // è‰²
                case 'quiz_rps': // ã˜ã‚ƒã‚“ã‘ã‚“
                case 'quiz_hl': // HighLow
                case 'odd': // ä»²é–“ã¯ãšã‚Œ
                    // æ±ç”¨ã‚¯ã‚¤ã‚ºUI
                    renderQuiz(game.type, container, add);
                    break;

                case 'lr': // å·¦å³
                    const box = document.createElement('div');
                    box.style.display = 'flex';
                    let nextKey = 'L';
                    box.appendChild(mkBtn("act-btn bg-red", "L", () => { if(nextKey=='L'){add(1); nextKey='R';} }));
                    box.appendChild(mkBtn("act-btn bg-blue", "R", () => { if(nextKey=='R'){add(1); nextKey='L';} }));
                    container.appendChild(box);
                    break;

                case 'count': // 10å›æŠ¼ã—
                    let count = 0;
                    const cntBtn = mkBtn("act-btn bg-huge", "0", (b) => {
                        count++;
                        b.innerText = count;
                    });
                    const okBtn = mkBtn("btn btn-cyan", "æ±ºå®š", (b) => {
                        if(count === 10) add(500); else add(-100);
                        container.innerHTML = "<div>é€ä¿¡å®Œäº†</div>";
                    });
                    container.appendChild(cntBtn);
                    container.appendChild(okBtn);
                    break;

                case 'swipe': // ã‚¹ãƒ¯ã‚¤ãƒ—
                    const swArea = document.createElement('div');
                    swArea.style.cssText = "width:300px; height:300px; border:4px dashed #666; display:flex; align-items:center; justify-content:center; font-size:2rem;";
                    swArea.innerText = "â¬†ï¸ SWIPE";
                    let sy = 0;
                    swArea.addEventListener('pointerdown', e => sy = e.clientY);
                    swArea.addEventListener('pointermove', e => {
                        if(sy > 0 && sy - e.clientY > 50) {
                            add(1);
                            sy = e.clientY;
                        }
                    });
                    swArea.addEventListener('pointerup', () => sy = 0);
                    container.appendChild(swArea);
                    break;

                default:
                    container.innerHTML = `<p>ç”»é¢ã‚’è¦‹ã¦å¾…æ©Ÿã›ã‚ˆï¼</p>`;
                    break;
            }
        }

        // --- ã‚¯ã‚¤ã‚ºãƒ­ã‚¸ãƒƒã‚¯ ---
        function renderQuiz(type, container, addScore) {
            container.innerHTML = "";
            const grid = document.createElement('div');
            grid.className = "grid-2";
            
            // å•é¡Œç”Ÿæˆ
            let q = "", opts = [], ans = "";
            
            if(type === 'quiz_math') {
                const a = Math.floor(Math.random()*10);
                const b = Math.floor(Math.random()*10);
                q = `${a} + ${b} = ?`;
                ans = a+b;
                opts = [ans, ans + (Math.random()>0.5?1:-1)].sort(()=>Math.random()-0.5);
            }
            else if (type === 'quiz_color') {
                const colors = [{n:'èµ¤',c:'red'}, {n:'é’',c:'blue'}, {n:'ç·‘',c:'green'}];
                const t = colors[Math.floor(Math.random()*3)];
                q = `<span style="color:${colors[Math.floor(Math.random()*3)].c}; font-size:3rem;">${t.n}</span>`;
                ans = t.c;
                opts = colors.map(c=>c.c); // 3æŠ
                grid.style.gridTemplateColumns = "1fr 1fr 1fr";
            }
            else if (type === 'quiz_rps') {
                const h = ['ğŸ‘Š','âœŒï¸','âœ‹'];
                const e = h[Math.floor(Math.random()*3)];
                q = `<span style="font-size:4rem">${e}</span>`;
                const win = {'ğŸ‘Š':'âœ‹', 'âœŒï¸':'ğŸ‘Š', 'âœ‹':'âœŒï¸'};
                ans = win[e];
                opts = h;
                grid.style.gridTemplateColumns = "1fr 1fr 1fr";
            }
            else if (type === 'odd') {
                const c = ['A','B'];
                const major = Math.random()>0.5 ? 'A':'B';
                const minor = major==='A'?'B':'A';
                opts = [major, major, major, minor].sort(()=>Math.random()-0.5);
                q = "ä»²é–“å¤–ã‚Œã‚’é¸ã¹";
                ans = minor;
            }

            // è¡¨ç¤º
            const qDiv = document.createElement('div');
            qDiv.innerHTML = q;
            qDiv.style.cssText = "font-size:2rem; margin-bottom:20px; font-weight:bold;";
            container.appendChild(qDiv);
            container.appendChild(grid);

            opts.forEach(o => {
                const b = document.createElement('button');
                b.className = "grid-btn";
                b.style.backgroundColor = (type==='quiz_color') ? o : '#444';
                b.innerHTML = (type==='quiz_color') ? '' : o;
                b.addEventListener('pointerdown', (e) => {
                    e.preventDefault();
                    if(String(o) === String(ans)) {
                        addScore(50);
                        // æ¬¡ã®å•é¡Œã¸ãƒªãƒ­ãƒ¼ãƒ‰
                        setTimeout(() => renderQuiz(type, container, addScore), 200);
                    } else {
                        addScore(-20);
                        b.style.opacity = 0.5;
                    }
                });
                grid.appendChild(b);
            });
        }

    </script>
</body>
</html>
