<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PARTY BOX: SENSOR FIX</title>
    
    <!-- „É©„Ç§„Éñ„É©„É™ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <!-- „Éá„Ç∂„Ç§„É≥ -->
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@600&family=M+PLUS+Rounded+1c:wght@800&display=swap" rel="stylesheet">
    
    <style>
        :root { --bg: #121212; --primary: #00ff88; --accent: #ff0055; --ui: #ffffff; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            margin: 0; background: var(--bg); color: var(--ui);
            font-family: 'M PLUS Rounded 1c', sans-serif;
            overflow: hidden; height: 100vh; text-align: center;
            user-select: none; touch-action: manipulation;
        }

        /* ÁîªÈù¢Âàá„ÇäÊõø„Åà */
        .screen {
            position: fixed; inset: 0;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: radial-gradient(circle at center, #2a2a2a 0%, #000 100%);
            transition: opacity 0.3s; z-index: 1; padding: 20px;
        }
        .hidden { opacity: 0; pointer-events: none; z-index: -10; }

        /* UI„Éë„Éº„ÉÑ */
        h1 { font-family: 'Fredoka', sans-serif; font-size: 3.5rem; color: var(--primary); margin: 0; letter-spacing: 2px; text-shadow: 4px 4px 0 rgba(0,0,0,0.5); }
        h2 { margin: 10px; font-size: 1.8rem; }
        p { color: #aaa; font-size: 1rem; margin: 5px; }

        .btn {
            background: linear-gradient(135deg, var(--primary), #00ccff);
            border: none; color: #000; padding: 15px 40px;
            font-size: 1.4rem; border-radius: 50px; cursor: pointer;
            margin: 15px; font-weight: bold;
            box-shadow: 0 5px 15px rgba(0, 255, 136, 0.3);
            transition: transform 0.1s;
        }
        .btn:active { transform: scale(0.95); }
        .btn-red { background: linear-gradient(135deg, #ff0055, #ff5500); color: white; box-shadow: 0 5px 15px rgba(255, 0, 85, 0.3); }

        /* „Ç§„É≥„Éó„ÉÉ„Éà */
        input {
            font-size: 1.5rem; padding: 15px; width: 250px; text-align: center;
            border-radius: 15px; border: 2px solid #555; background: #222; color: white;
            margin-bottom: 15px; outline: none;
        }
        input:focus { border-color: var(--primary); }

        /* „Ç≤„Éº„É†ÁîªÈù¢Ôºà„Éõ„Çπ„ÉàÔºâ */
        .big-timer { font-size: 6rem; font-family: 'Fredoka'; color: var(--ui); margin: 20px; }
        .leaderboard { width: 100%; max-width: 500px; background: rgba(255,255,255,0.1); border-radius: 15px; padding: 10px; }
        .rank-row { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 1.2rem; }

        /* „Ç≤„Éº„É†ÁîªÈù¢Ôºà„ÇØ„É©„Ç§„Ç¢„É≥„ÉàÔºâ */
        .game-area { width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; }
        
        /* „Ç¢„ÇØ„Ç∑„Éß„É≥„Éú„Çø„É≥ */
        .act-btn {
            width: 160px; height: 160px; border-radius: 50%;
            border: 8px solid rgba(255,255,255,0.1);
            background: #333; color: white;
            font-size: 2rem; font-weight: 900;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            box-shadow: 0 10px 0 rgba(0,0,0,0.3);
            transition: transform 0.05s; cursor: pointer;
            -webkit-user-select: none;
        }
        .act-btn:active { transform: translateY(10px); box-shadow: none; }
        .act-btn.huge { width: 260px; height: 260px; font-size: 3rem; background: var(--accent); border-color: #ff88aa; }
        
        /* „Çª„É≥„Çµ„Éº„Éá„Éê„ÉÉ„Ç∞Áî® */
        #sensor-debug { position: absolute; bottom: 10px; left: 10px; font-size: 0.8rem; color: #555; text-align: left; pointer-events: none; }
    </style>
</head>
<body>

    <!-- ================= HOST SCREENS ================= -->
    <div id="h-top" class="screen">
        <h1>PARTY BOX</h1>
        <p>20 MINI GAMES BATTLE</p>
        <div style="margin-top:30px;">
            <button id="btn-start-host" class="btn">üíª „Éõ„Çπ„Éà„Åß„ÅØ„Åò„ÇÅ„Çã</button>
            <button id="btn-goto-client" class="btn btn-red">üì± „Çπ„Éû„Éõ„ÅßÂèÇÂä†</button>
        </div>
    </div>

    <div id="h-lobby" class="screen hidden">
        <h2>ROOM ID</h2>
        <div id="disp-id" style="font-size:5rem; font-family:'Fredoka'; color:var(--primary);">----</div>
        <div id="qrcode" style="background:white; padding:15px; border-radius:15px; margin:20px;"></div>
        <p>ÂèÇÂä†‰∫∫Êï∞: <span id="p-count" style="color:var(--primary); font-weight:bold; font-size:1.5rem;">0</span> ‰∫∫</p>
        <button id="btn-game-start" class="btn">„Ç≤„Éº„É†„Çπ„Çø„Éº„ÉàÔºÅ</button>
    </div>

    <div id="h-game" class="screen hidden">
        <h2 id="g-round" style="color:var(--primary);">ROUND 1</h2>
        <h1 id="g-title" style="font-size:3rem;">GAME TITLE</h1>
        <p id="g-desc">Description</p>
        <div id="g-timer" class="big-timer">READY</div>
        <div id="g-info" style="font-size:1.5rem; color:#aaa;"></div>
    </div>

    <div id="h-result" class="screen hidden">
        <h1>RESULT</h1>
        <div id="ranking-container" class="leaderboard"></div>
        <button id="btn-next-round" class="btn">Ê¨°„ÅÆ„É©„Ç¶„É≥„Éâ„Å∏</button>
    </div>

    <!-- ================= CLIENT SCREENS ================= -->
    <div id="c-login" class="screen hidden">
        <h2>ROOM ID</h2>
        <input id="inp-rid" type="text" maxlength="4" placeholder="ABCD" style="text-transform:uppercase;">
        <input id="inp-name" type="text" maxlength="8" placeholder="„Éã„ÉÉ„ÇØ„Éç„Éº„É†">
        <br>
        <p style="font-size:0.9rem; color:#f88;">‚ÄªÂèÇÂä†„Éú„Çø„É≥„ÇíÊäº„Åô„Å®<br>„Çª„É≥„Çµ„ÉºË®±ÂèØ„ÅÆÁ¢∫Ë™ç„ÅåÂá∫„Åæ„Åô</p>
        <button id="btn-join" class="btn btn-red">ÂèÇÂä†„Åô„Çã</button>
    </div>

    <div id="c-play" class="screen hidden">
        <div id="c-status" style="position:absolute; top:20px; font-size:1.2rem; color:#888;">ÂæÖÊ©ü‰∏≠...</div>
        <div id="c-area" class="game-area"></div>
        <div id="sensor-debug">Sensor: OFF</div>
    </div>

    <!-- ================= SCRIPT ================= -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, set, get, onValue, update, remove, onDisconnect, runTransaction, child } 
               from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        // FirebaseË®≠ÂÆö
        const firebaseConfig = {
            apiKey: "AIzaSyDbZzTMvUkG2LXIGY4ux0KBTmnAdqP236s",
            authDomain: "game-4f2d9.firebaseapp.com",
            databaseURL: "https://game-4f2d9-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "game-4f2d9",
            storageBucket: "game-4f2d9.firebasestorage.app",
            messagingSenderId: "574316347824",
            appId: "1:574316347824:web:cf686040628e25ad615675"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // UI„Éò„É´„Éë„Éº
        const $ = id => document.getElementById(id);
        const show = id => {
            document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
            $(id).classList.remove('hidden');
        };

        // Â§âÊï∞
        let myId = "P" + Math.random().toString(36).substr(2, 5);
        let roomId = "";
        let currentRound = 1;
        const TOTAL_ROUNDS = 5;
        let sensorActive = false;

        // „Ç≤„Éº„É†ÂÆöÁæ©
        const GAMES = [
            {id:'tap', n:'ÈÄ£Êâì„Éê„Éà„É´', d:'ÁîªÈù¢„ÇíÂ£ä„Çå„Çã„Åª„Å©ÈÄ£Êâì„Åó„ÇçÔºÅ', t:'tap'},
            {id:'shake', n:'„Ç∑„Çß„Ç§„ÇØÔºÅ', d:'„Çπ„Éû„Éõ„ÇíÂÖ®Âäõ„ÅßÊåØ„ÇåÔºÅ', t:'shake'},
            {id:'stop', n:'5ÁßíÊ≠¢„ÇÅ', d:'5.00Áßí„Éî„ÉÉ„Çø„É™„ÅßÊ≠¢„ÇÅ„ÇçÔºÅ', t:'stop'},
            {id:'charge', n:'„Éë„ÉØ„ÉºÂÖÖÂ°´', d:'Èï∑Êäº„Åó„Åó„Å¶100%„ÇíÁõÆÊåá„ÅõÔºÅ', t:'charge'},
            {id:'math', n:'Ë®àÁÆó„ÇØ„Ç§„Ç∫', d:'Ê≠£„Åó„ÅÑÁ≠î„Åà„ÇíÈÅ∏„ÅπÔºÅ', t:'quiz_math'},
            {id:'color', n:'Ëâ≤ÂΩ©ÊÑüË¶ö', d:'ÊñáÂ≠ó„ÅÆ„ÄåËâ≤„Äç„ÇíÈÅ∏„ÅπÔºÅ', t:'quiz_color'},
            {id:'count', n:'10ÂõûÊäº„Åõ', d:'Ê≠£Á¢∫„Å´10Âõû„Å†„ÅëÊäº„Åó„Å¶Ê±∫ÂÆöÔºÅ', t:'count'},
            {id:'dont', n:'Êäº„Åô„Å™ÔºÅ', d:'Áµ∂ÂØæ„Å´„Éú„Çø„É≥„ÇíÊäº„Åô„Å™ÔºÅ', t:'dont'},
            {id:'luck', n:'ÈÅãË©¶„Åó', d:'ÂΩì„Åü„Çä„ÇíÂºï„ÅëÔºÅ', t:'luck'}
        ];

        // ---------------- HOST LOGIC ----------------
        $('btn-start-host').addEventListener('click', () => {
            roomId = Math.random().toString(36).substr(2, 4).toUpperCase();
            const rRef = ref(db, `rooms/${roomId}`
